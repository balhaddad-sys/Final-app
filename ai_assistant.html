<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>AI Assistant | MedWard Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.css"/>
<script src="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.js.iife.js"></script>
<style>
:root {
  --primary: #005eb8;
  --primary-dark: #003087;
  --primary-light: #e6f0f9;
  --bg-app: #f8fafc;
  --bg-surface: #ffffff;
  --bg-elevated: #f1f5f9;
  --text-main: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --success: #059669;
  --danger: #dc2626;
  --warning: #d97706;
  --warning-light: #fef3c7;
  --radius: 16px;
  --radius-sm: 10px;
}

body.dark-theme {
  --primary: #60a5fa;
  --primary-dark: #93c5fd;
  --primary-light: #1e3a5f;
  --bg-app: #0f172a;
  --bg-surface: #1e293b;
  --bg-elevated: #334155;
  --text-main: #f8fafc;
  --text-secondary: #cbd5e1;
  --text-muted: #64748b;
  --border: #334155;
  --warning-light: #78350f;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-app);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.back-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  color: var(--text-main);
  cursor: pointer;
}

.back-btn:hover { border-color: var(--primary); color: var(--primary); }

.header-content { flex: 1; }
.header-title { font-weight: 700; font-size: 1.1rem; }
.header-subtitle { font-size: 0.75rem; color: var(--text-muted); }

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.1rem;
}

.icon-btn:hover { border-color: var(--primary); }

.main {
  flex: 1;
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

.disclaimer {
  background: var(--warning-light);
  border-left: 3px solid var(--warning);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  margin-bottom: 16px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  line-height: 1.4;
}

.chat-container {
  flex: 1;
  overflow-y: auto;
  padding-bottom: 20px;
}

.message {
  margin-bottom: 16px;
  display: flex;
  gap: 12px;
}

.message.user { flex-direction: row-reverse; }

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.message.assistant .message-avatar { background: var(--primary-light); color: var(--primary); }
.message.user .message-avatar { background: var(--bg-elevated); color: var(--text-secondary); }

.message-content {
  max-width: 85%;
  padding: 0;
  font-size: 0.88rem;
  line-height: 1.6;
}

.message.user .message-content {
  background: var(--primary);
  color: white;
  padding: 12px 16px;
  border-radius: var(--radius);
}

/* Structured Response Sections */
.response-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.response-section {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}

.response-section:last-child { border-bottom: none; }

.section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.section-icon {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
}

.section-icon.diagnosis { background: rgba(239,68,68,0.1); color: #ef4444; }
.section-icon.assessment { background: rgba(59,130,246,0.1); color: #3b82f6; }
.section-icon.treatment { background: rgba(16,185,129,0.1); color: #10b981; }
.section-icon.monitoring { background: rgba(139,92,246,0.1); color: #8b5cf6; }
.section-icon.alert { background: rgba(245,158,11,0.1); color: #f59e0b; }

.section-title {
  font-weight: 700;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-main);
}

.section-content {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

.section-content ul {
  margin: 0;
  padding-left: 18px;
}

.section-content li {
  margin-bottom: 4px;
}

.section-content strong {
  color: var(--text-main);
}

/* Quick Reference Pills */
.quick-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.quick-pill {
  padding: 4px 10px;
  background: var(--bg-elevated);
  border-radius: 100px;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.quick-pill.dose { background: rgba(16,185,129,0.1); color: #10b981; }
.quick-pill.frequency { background: rgba(59,130,246,0.1); color: #3b82f6; }
.quick-pill.warning { background: rgba(245,158,11,0.1); color: #f59e0b; }

/* Welcome State */
.welcome {
  text-align: center;
  padding: 30px 20px;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.welcome-icon {
  width: 70px;
  height: 70px;
  margin: 0 auto 16px;
  background: var(--primary-light);
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.welcome-icon svg { width: 35px; height: 35px; color: var(--primary); }

.welcome-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 6px; }
.welcome-text { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 20px; }

.quick-prompts {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
}

.quick-prompt {
  padding: 8px 14px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 100px;
  font-size: 0.78rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
}

.quick-prompt:hover {
  border-color: var(--primary);
  color: var(--primary);
}

/* Input Area */
.input-area {
  padding: 14px 20px;
  background: var(--bg-surface);
  border-top: 1px solid var(--border);
  position: sticky;
  bottom: 0;
}

.input-row {
  display: flex;
  gap: 10px;
  max-width: 800px;
  margin: 0 auto;
}

.input-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 4px 4px 4px 14px;
}

.input-wrapper:focus-within { border-color: var(--primary); }

.chat-input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 10px 0;
  font-size: 0.9rem;
  color: var(--text-main);
  font-family: inherit;
  outline: none;
  resize: none;
  min-height: 20px;
  max-height: 100px;
}

.chat-input::placeholder { color: var(--text-muted); }

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  border: none;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.send-btn:hover { opacity: 0.9; }
.send-btn:disabled { background: var(--border); cursor: not-allowed; }
.send-btn svg { width: 18px; height: 18px; }

/* Loading */
.typing { display: flex; gap: 4px; padding: 14px 16px; }

.typing-dot {
  width: 8px;
  height: 8px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-6px); opacity: 1; }
}
</style>
</head>
<body>

<div class="header">
  <a href="landing.html" class="back-btn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  </a>
  <div class="header-content">
    <div class="header-title">AI Clinical Assistant</div>
    <div class="header-subtitle">Quick On-Call Reference</div>
  </div>
  <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
</div>

<div class="main">
  <div class="disclaimer">‚ö†Ô∏è For educational purposes. Verify with guidelines and consider individual patient factors.</div>
  
  <div class="chat-container" id="chatContainer">
    <div class="welcome" id="welcomeState">
      <div class="welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
      </div>
      <div class="welcome-title">On-Call AI Assistant</div>
      <div class="welcome-text">Get organized clinical answers with diagnosis, treatment, and monitoring sections.</div>
      
      <div class="quick-prompts">
        <button class="quick-prompt" onclick="askQuestion('DKA management')">DKA</button>
        <button class="quick-prompt" onclick="askQuestion('Acute heart failure treatment')">Heart Failure</button>
        <button class="quick-prompt" onclick="askQuestion('Hyperkalemia management')">Hyperkalemia</button>
        <button class="quick-prompt" onclick="askQuestion('Sepsis hour-1 bundle')">Sepsis</button>
        <button class="quick-prompt" onclick="askQuestion('CURB-65 scoring')">CURB-65</button>
        <button class="quick-prompt" onclick="askQuestion('PE anticoagulation')">PE</button>
      </div>
    </div>
  </div>
</div>

<div class="input-area">
  <div class="input-row">
    <div class="input-wrapper">
      <textarea class="chat-input" id="chatInput" placeholder="Ask about diagnosis, treatment, doses..." rows="1" onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" onclick="sendMessage()" id="sendBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
// Authentication check - redirect to login if not authenticated
(function() {
  const user = sessionStorage.getItem('MW_USER') || localStorage.getItem('MW_USER');
  const pass = sessionStorage.getItem('MW_PASS') || localStorage.getItem('MW_PASS');
  if (!user || !pass) {
    window.location.href = 'login.html';
  }
})();

const API_URL = 'https://script.google.com/macros/s/AKfycbyewF_EjwJeundXYupFZcAjJF7jyMrd38FPDP7DB0zmjmHqAcXHig08Ycn07oW45l4w-A/exec';
let isLoading = false;

function initTheme() {
  if (localStorage.getItem('MEDWARD_THEME') === 'dark') document.body.classList.add('dark-theme');
  updateThemeIcon();
}

function toggleTheme() {
  document.body.classList.toggle('dark-theme');
  localStorage.setItem('MEDWARD_THEME', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
  updateThemeIcon();
}

function updateThemeIcon() {
  document.getElementById('themeBtn').textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
}

function askQuestion(q) {
  document.getElementById('chatInput').value = q;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || isLoading) return;
  
  document.getElementById('welcomeState')?.remove();
  addUserMessage(text);
  input.value = '';
  
  isLoading = true;
  const loadingId = addLoading();
  
  // Enhanced prompt for structured response
  const structuredPrompt = `You are an on-call clinical assistant. Respond to this query in a STRUCTURED format for quick reference.

Query: ${text}

RESPOND IN THIS EXACT FORMAT (use these exact section headers):
[DIAGNOSIS/CRITERIA]
- List diagnostic criteria or key features

[INITIAL ASSESSMENT]
- Immediate evaluation steps

[TREATMENT]
- First-line treatment with doses
- Alternative options if applicable

[MONITORING]
- Key parameters to monitor
- Red flags to watch for

[KEY POINTS]
- 2-3 critical takeaways

Keep each section concise (2-4 bullet points max). Include specific doses where relevant. This is for quick on-call reference.`;
  
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'askClinical', question: structuredPrompt })
    });
    const data = await res.json();
    removeLoading(loadingId);
    
    if (data.success && data.answer) {
      addStructuredResponse(data.answer);
    } else {
      addSimpleResponse('Unable to process request. Please try again.');
    }
  } catch (e) {
    removeLoading(loadingId);
    addSimpleResponse('Network error. Please check connection.');
  }
  isLoading = false;
}

function addUserMessage(text) {
  const container = document.getElementById('chatContainer');
  const msg = document.createElement('div');
  msg.className = 'message user';
  msg.innerHTML = `
    <div class="message-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
    <div class="message-content">${escapeHtml(text)}</div>
  `;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function addStructuredResponse(text) {
  const container = document.getElementById('chatContainer');
  const msg = document.createElement('div');
  msg.className = 'message assistant';
  
  // Parse sections from response
  const sections = parseStructuredResponse(text);
  
  let html = `
    <div class="message-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></div>
    <div class="message-content">
      <div class="response-card">
  `;
  
  sections.forEach(section => {
    const iconClass = getSectionIcon(section.title);
    html += `
      <div class="response-section">
        <div class="section-header">
          <div class="section-icon ${iconClass.class}">${iconClass.icon}</div>
          <div class="section-title">${section.title}</div>
        </div>
        <div class="section-content">${formatContent(section.content)}</div>
      </div>
    `;
  });
  
  html += `</div></div>`;
  msg.innerHTML = html;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function parseStructuredResponse(text) {
  const sections = [];
  const sectionPatterns = [
    { regex: /\[DIAGNOSIS\/CRITERIA\]|\*\*DIAGNOSIS\/CRITERIA\*\*|##?\s*DIAGNOSIS|##?\s*CRITERIA/i, title: 'Diagnosis/Criteria' },
    { regex: /\[INITIAL ASSESSMENT\]|\*\*INITIAL ASSESSMENT\*\*|##?\s*INITIAL ASSESSMENT|##?\s*ASSESSMENT/i, title: 'Initial Assessment' },
    { regex: /\[TREATMENT\]|\*\*TREATMENT\*\*|##?\s*TREATMENT|##?\s*MANAGEMENT/i, title: 'Treatment' },
    { regex: /\[MONITORING\]|\*\*MONITORING\*\*|##?\s*MONITORING/i, title: 'Monitoring' },
    { regex: /\[KEY POINTS\]|\*\*KEY POINTS\*\*|##?\s*KEY POINTS|##?\s*SUMMARY/i, title: 'Key Points' }
  ];
  
  // Find all section positions
  let positions = [];
  sectionPatterns.forEach(pattern => {
    const match = text.match(pattern.regex);
    if (match) {
      positions.push({
        title: pattern.title,
        start: match.index,
        headerEnd: match.index + match[0].length
      });
    }
  });
  
  // Sort by position
  positions.sort((a, b) => a.start - b.start);
  
  // Extract content for each section
  for (let i = 0; i < positions.length; i++) {
    const start = positions[i].headerEnd;
    const end = positions[i + 1]?.start || text.length;
    const content = text.substring(start, end).trim();
    
    if (content) {
      sections.push({
        title: positions[i].title,
        content: content
      });
    }
  }
  
  // If no sections found, create a single general section
  if (sections.length === 0) {
    sections.push({
      title: 'Response',
      content: text
    });
  }
  
  return sections;
}

function getSectionIcon(title) {
  const lower = title.toLowerCase();
  if (lower.includes('diagnosis') || lower.includes('criteria')) return { class: 'diagnosis', icon: 'üîç' };
  if (lower.includes('assessment')) return { class: 'assessment', icon: 'üìã' };
  if (lower.includes('treatment') || lower.includes('management')) return { class: 'treatment', icon: 'üíä' };
  if (lower.includes('monitoring')) return { class: 'monitoring', icon: 'üìä' };
  if (lower.includes('key') || lower.includes('summary')) return { class: 'alert', icon: '‚ö°' };
  return { class: 'assessment', icon: 'üìù' };
}

function formatContent(content) {
  // Convert markdown-style lists to HTML
  let html = content
    .replace(/^\s*[-‚Ä¢]\s*/gm, '‚Ä¢ ')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
  
  // Highlight doses
  html = html.replace(/(\d+\.?\d*\s*(?:mg|g|mcg|mL|units|U)(?:\/(?:kg|hr|day|dose))?)/gi, '<span class="quick-pill dose">$1</span>');
  
  return html;
}

function addSimpleResponse(text) {
  const container = document.getElementById('chatContainer');
  const msg = document.createElement('div');
  msg.className = 'message assistant';
  msg.innerHTML = `
    <div class="message-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/></svg></div>
    <div class="message-content"><div class="response-card"><div class="response-section"><div class="section-content">${escapeHtml(text)}</div></div></div></div>
  `;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function addLoading() {
  const container = document.getElementById('chatContainer');
  const id = 'loading-' + Date.now();
  const msg = document.createElement('div');
  msg.className = 'message assistant';
  msg.id = id;
  msg.innerHTML = `
    <div class="message-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/></svg></div>
    <div class="message-content"><div class="response-card"><div class="typing"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></div>
  `;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
  return id;
}

function removeLoading(id) { document.getElementById(id)?.remove(); }

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

initTheme();
document.getElementById('chatInput').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100) + 'px';
});
</script>
<script src="error-analyzer.js"></script>
<script src="medward-tour.js"></script>
</body>
</html>
