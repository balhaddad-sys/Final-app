<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <title>MedWard Enterprise | Clinical Intelligence Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg-deep:#060a13;--bg-primary:#0a0f1a;--bg-card:#0d1424;--bg-elevated:#111b2e;--bg-input:#0f172a;
      --text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;
      --gold:#d4a437;--gold-light:#fbbf24;--gold-glow:rgba(212,164,55,0.15);
      --teal:#14b8a6;--teal-light:#2dd4bf;
      --blue:#3b82f6;--purple:#8b5cf6;--rose:#f43f5e;--orange:#f97316;--emerald:#10b981;
      --border:rgba(148,163,184,0.1);--border-light:rgba(148,163,184,0.15);
      --shadow-lg:0 12px 40px rgba(0,0,0,0.5);
      --radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px;
    }
    html{font-size:16px;-webkit-font-smoothing:antialiased}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-deep);color:var(--text-primary);line-height:1.5;min-height:100vh}
    .ambient{position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(ellipse at 20% 20%,var(--gold-glow),transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(20,184,166,0.08),transparent 50%)}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-md);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:0.2s;touch-action:manipulation}
    .btn:active{transform:scale(0.98)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);box-shadow:0 4px 16px rgba(212,164,55,0.3)}
    .btn-primary:hover{box-shadow:0 6px 24px rgba(212,164,55,0.4);transform:translateY(-2px)}
    .btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary)}
    .btn-secondary:hover{border-color:var(--gold)}
    .btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}
    .btn-sm{padding:8px 14px;font-size:0.8rem}
    .btn-lg{padding:16px 28px;font-size:1rem}
    .btn-full{width:100%}
    .btn-icon{width:40px;height:40px;padding:0;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:grid;place-items:center;transition:0.2s}
    .btn-icon:hover{border-color:var(--gold);color:var(--gold)}
    .btn-icon svg{width:18px;height:18px}

    /* Forms */
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
    .form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:inherit;font-size:0.95rem;transition:0.2s}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-glow)}
    .form-textarea{min-height:100px;resize:vertical}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000;overflow-y:auto}
    .modal.active{display:flex}
    .modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);width:100%;max-width:440px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
    .modal-header{padding:24px;border-bottom:1px solid var(--border);text-align:center}
    .modal-icon{width:64px;height:64px;background:var(--bg-elevated);border-radius:16px;display:grid;place-items:center;font-size:2rem;margin:0 auto 16px}
    .modal-title{font-size:1.25rem;font-weight:700;margin-bottom:4px}
    .modal-subtitle{color:var(--text-muted);font-size:0.85rem}
    .modal-body{padding:24px}
    .modal-footer{padding:16px 24px 24px;display:flex;gap:12px}
    .modal-footer .btn{flex:1}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LANDING PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at top,var(--bg-primary),var(--bg-deep))}
    #landing.hidden{display:none}
    .landing-logo{width:88px;height:88px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:22px;display:grid;place-items:center;margin-bottom:28px;box-shadow:0 12px 40px rgba(212,164,55,0.3)}
    .landing-logo svg{width:48px;height:48px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}
    .landing-title{font-size:2.25rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .landing-subtitle{color:var(--text-secondary);margin-bottom:48px}
    .units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;width:100%;max-width:880px}
    .unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;cursor:pointer;transition:0.3s;position:relative;overflow:hidden}
    .unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--unit-color,var(--gold))}
    .unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,0.3)}
    .unit-card-icon{width:52px;height:52px;background:var(--bg-elevated);border-radius:14px;display:grid;place-items:center;font-size:1.6rem;margin-bottom:14px}
    .unit-card-name{font-size:1.15rem;font-weight:600;margin-bottom:4px}
    .unit-card-desc{color:var(--text-muted);font-size:0.8rem;margin-bottom:16px}
    .unit-card-lock{position:absolute;top:16px;right:16px;width:28px;height:28px;background:var(--bg-elevated);border-radius:8px;display:grid;place-items:center;color:var(--text-muted)}
    .unit-card-lock svg{width:14px;height:14px}
    .admin-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:0.3s;color:var(--text-muted)}
    .admin-fab:hover{border-color:var(--gold);color:var(--gold);transform:scale(1.1)}
    .admin-fab svg{width:22px;height:22px}

    /* Code Input */
    .code-inputs{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .code-digit{width:52px;height:60px;background:var(--bg-elevated);border:2px solid var(--border);border-radius:var(--radius-md);font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:600;text-align:center;color:var(--text-primary);transition:0.2s}
    .code-digit:focus{outline:none;border-color:var(--gold);background:var(--gold-glow)}
    .code-digit.error{border-color:var(--rose);animation:shake 0.4s}
    .code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
    .code-error{color:var(--rose);font-size:0.85rem;text-align:center;margin-top:12px;display:none}
    .code-error.show{display:block}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #dashboard{display:none;min-height:100vh;background:var(--bg-primary)}
    #dashboard.active{display:block}
    .dash-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .dash-logo{display:flex;align-items:center;gap:12px}
    .dash-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:10px;display:grid;place-items:center}
    .dash-logo-icon svg{width:22px;height:22px;stroke:var(--bg-deep);fill:none}
    .dash-unit-badge{padding:6px 14px;border-radius:100px;font-size:0.8rem;font-weight:600}
    .dash-user{display:flex;align-items:center;gap:12px}
    .dash-user-info{text-align:right}
    .dash-user-name{font-weight:600;font-size:0.9rem}
    .dash-user-role{font-size:0.7rem;color:var(--text-muted);text-transform:capitalize}
    .dash-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.85rem}
    .dash-content{max-width:1200px;margin:0 auto;padding:20px}
    .dash-welcome{margin-bottom:24px}
    .dash-welcome h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
    .dash-welcome p{color:var(--text-muted)}

    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:24px;overflow-x:auto}
    .tab{padding:14px 20px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:500;cursor:pointer;transition:0.2s;white-space:nowrap;display:flex;align-items:center;gap:8px}
    .tab:hover{color:var(--text-primary)}
    .tab.active{color:var(--gold);border-bottom-color:var(--gold);font-weight:600}
    .tab svg{width:18px;height:18px}
    .panel{display:none;animation:fadeIn 0.3s}
    .panel.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-bottom:24px}
    .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px;text-align:center}
    .stat-value{font-size:1.75rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}

    /* Patients */
    .patients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .patient-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;transition:0.2s;position:relative;overflow:hidden}
    .patient-card:hover{border-color:var(--gold);transform:translateY(-2px)}
    .patient-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--teal)}
    .patient-card.critical::before{background:var(--rose)}
    .patient-card.chronic::before{background:var(--purple)}
    .patient-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .patient-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:1rem;color:var(--bg-deep)}
    .patient-name{font-weight:600}
    .patient-meta{font-size:0.75rem;color:var(--text-muted)}
    .patient-status{margin-left:auto;padding:4px 10px;border-radius:100px;font-size:0.65rem;font-weight:600;text-transform:uppercase}
    .patient-status.active{background:rgba(20,184,166,0.15);color:var(--teal)}
    .patient-status.critical{background:rgba(244,63,94,0.15);color:var(--rose)}
    .patient-status.chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
    .patient-diagnosis{font-size:0.85rem;color:var(--text-secondary);padding:12px;background:var(--bg-card);border-radius:8px;margin-bottom:14px}
    .patient-actions{display:flex;gap:8px}
    .patient-actions .btn{flex:1;padding:10px;font-size:0.8rem}

    /* Card */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:20px}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card-title{font-size:0.95rem;font-weight:600;display:flex;align-items:center;gap:10px}
    .card-title svg{width:18px;height:18px;stroke:var(--gold)}
    .card-body{padding:20px}

    /* Upload */
    .upload-zone{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:40px 24px;text-align:center;cursor:pointer;transition:0.2s}
    .upload-zone:hover,.upload-zone.dragover{border-color:var(--gold);background:var(--gold-glow)}
    .upload-zone.has-file{border-style:solid;border-color:var(--teal);background:rgba(20,184,166,0.05)}
    .upload-icon{width:56px;height:56px;background:var(--bg-elevated);border-radius:14px;display:grid;place-items:center;margin:0 auto 16px}
    .upload-icon svg{width:28px;height:28px;stroke:var(--gold)}
    .upload-input{display:none}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px;margin-top:16px}
    .preview-thumb{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid var(--border)}
    .preview-thumb img{width:100%;height:100%;object-fit:cover}
    .preview-thumb:hover{border-color:var(--rose)}
    .preview-thumb::after{content:'âœ•';position:absolute;top:2px;right:2px;width:18px;height:18px;background:rgba(244,63,94,0.9);border-radius:50%;display:grid;place-items:center;font-size:10px;color:#fff;opacity:0;transition:0.2s}
    .preview-thumb:hover::after{opacity:1}

    /* Analysis Types */
    .analysis-types{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
    .analysis-type{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px 12px;text-align:center;cursor:pointer;transition:0.2s}
    .analysis-type:hover{border-color:var(--gold)}
    .analysis-type.active{border-color:var(--gold);background:var(--gold-glow)}
    .analysis-type-icon{font-size:1.5rem;margin-bottom:6px}
    .analysis-type-name{font-size:0.8rem;font-weight:600}

    /* Progress & Results */
    .analysis-progress{display:none;text-align:center;padding:40px}
    .analysis-progress.show{display:block}
    .progress-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .analysis-results{display:none}
    .analysis-results.show{display:block}
    .result-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .result-title{font-size:1.1rem;font-weight:600;display:flex;align-items:center;gap:10px;color:var(--emerald)}
    .result-badge{padding:6px 14px;background:var(--gold-glow);border:1px solid var(--gold);border-radius:100px;font-size:0.75rem;font-weight:600;color:var(--gold)}
    .result-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px;margin-bottom:14px}
    .result-section-title{font-size:0.85rem;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;color:var(--text-secondary)}
    .finding-card{background:var(--bg-elevated);border-radius:8px;padding:12px;margin-bottom:8px}
    .finding-card.critical{border-left:3px solid var(--rose)}

    /* Scores */
    .scores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .score-tile{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px 16px;text-align:center;cursor:pointer;transition:0.2s}
    .score-tile:hover{border-color:var(--gold)}
    .score-tile.active{border-color:var(--gold);background:var(--gold-glow)}
    .score-icon{font-size:1.75rem;margin-bottom:8px}
    .score-name{font-weight:600;font-size:0.9rem}
    .score-desc{font-size:0.7rem;color:var(--text-muted)}
    .calc-item{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;margin-bottom:12px}
    .calc-item-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .calc-item-num{width:28px;height:28px;background:var(--gold);border-radius:8px;display:grid;place-items:center;font-size:0.75rem;font-weight:700;color:var(--bg-deep)}
    .calc-item-name{font-weight:600;font-size:0.9rem}
    .calc-opts{display:flex;flex-wrap:wrap;gap:8px}
    .calc-opt{flex:1;min-width:60px;padding:12px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:0.15s}
    .calc-opt:hover{border-color:var(--gold)}
    .calc-opt.sel{background:var(--gold-glow);border-color:var(--gold)}
    .calc-opt input{display:none}
    .calc-opt-score{display:block;font-size:1.1rem;font-weight:700;color:var(--gold)}
    .calc-opt-label{font-size:0.65rem;color:var(--text-secondary)}
    .calc-result{background:var(--bg-elevated);border-radius:var(--radius-md);padding:24px;text-align:center;margin-top:16px}
    .calc-result-score{font-size:3rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .severity-pill{display:inline-block;padding:8px 20px;border-radius:100px;font-size:0.85rem;font-weight:600;margin-top:12px}

    /* Reference */
    .ref-filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
    .ref-filter{padding:8px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:100px;color:var(--text-secondary);font-size:0.75rem;font-weight:500;cursor:pointer;transition:0.2s}
    .ref-filter:hover{border-color:var(--gold)}
    .ref-filter.active{background:var(--gold-glow);border-color:var(--gold);color:var(--gold)}
    .ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .ref-card{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;border-left:3px solid var(--gold)}
    .ref-card h4{font-size:0.9rem;margin-bottom:10px}
    .ref-card p{font-size:0.78rem;color:var(--text-secondary);margin:5px 0}
    .ref-card b{color:var(--gold)}

    /* Admin Panel */
    #adminPanel{display:none;min-height:100vh;background:var(--bg-primary)}
    #adminPanel.active{display:block}
    .admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .admin-badge{background:var(--purple);padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:600;color:white;margin-left:12px}
    .admin-content{max-width:900px;margin:0 auto;padding:24px}
    .admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:24px;overflow:hidden}
    .admin-section-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .admin-section-title{font-size:1rem;font-weight:600;display:flex;align-items:center;gap:10px}
    .admin-section-body{padding:20px}
    .units-table{width:100%;border-collapse:collapse}
    .units-table th,.units-table td{padding:14px 16px;text-align:left;border-bottom:1px solid var(--border)}
    .units-table th{font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase}
    .units-table tr:last-child td{border-bottom:none}
    .color-options{display:flex;gap:8px;flex-wrap:wrap}
    .color-option{width:32px;height:32px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:0.2s}
    .color-option:hover,.color-option.selected{border-color:white;transform:scale(1.15)}

    /* Toast */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:14px 24px;border-radius:var(--radius-md);font-size:0.9rem;opacity:0;transition:0.3s;z-index:2000}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.error{border-color:var(--rose)}

    /* Neural Stats */
    .neural-stats{display:flex;gap:16px;justify-content:center;font-size:0.75rem;color:var(--text-muted);margin-top:12px}
    .neural-stat{display:flex;align-items:center;gap:4px}
    .neural-stat.cached{color:var(--emerald)}

    @media(max-width:640px){
      .landing-title{font-size:1.75rem}
      .units-grid{grid-template-columns:1fr}
      .code-digit{width:48px;height:54px;font-size:1.5rem}
      .dash-user-info{display:none}
      .tab span{display:none}
      .patients-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="ambient"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LANDING PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="landing">
  <div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
  <h1 class="landing-title">MedWard Enterprise</h1>
  <p class="landing-subtitle">Select your unit to continue</p>
  <div class="units-grid" id="unitsGrid"></div>
  <div class="admin-fab" id="adminFab" title="Admin Panel"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal" id="accessModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon" id="accessIcon">ğŸ¥</div>
      <h2 class="modal-title" id="accessTitle">Unit Name</h2>
      <p class="modal-subtitle">Enter 4-digit access code</p>
    </div>
    <div class="modal-body">
      <div class="code-inputs">
        <input type="tel" class="code-digit" maxlength="1" data-idx="0" inputmode="numeric" autocomplete="off">
        <input type="tel" class="code-digit" maxlength="1" data-idx="1" inputmode="numeric" autocomplete="off">
        <input type="tel" class="code-digit" maxlength="1" data-idx="2" inputmode="numeric" autocomplete="off">
        <input type="tel" class="code-digit" maxlength="1" data-idx="3" inputmode="numeric" autocomplete="off">
      </div>
      <p class="code-error" id="codeError">Invalid access code</p>
      <div id="userSection" style="display:none;margin-top:24px;padding-top:24px;border-top:1px solid var(--border)">
        <div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input" placeholder="Dr. John Smith"></div>
        <div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending Physician</option><option value="resident">Resident</option><option value="intern">Intern</option><option value="nurse">Nurse</option><option value="student">Medical Student</option></select></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
      <button class="btn btn-primary" id="enterUnitBtn" style="display:none">Enter Unit</button>
    </div>
  </div>
</div>

<div class="modal" id="adminLoginModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon">âš™ï¸</div>
      <h2 class="modal-title">Admin Access</h2>
      <p class="modal-subtitle">Enter administrator password</p>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPassword" class="form-input" placeholder="Enter password"></div>
      <p class="code-error" id="adminError">Invalid password</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('adminLoginModal')">Cancel</button>
      <button class="btn btn-primary" id="adminLoginBtn">Login</button>
    </div>
  </div>
</div>

<div class="modal" id="unitModal">
  <div class="modal-box" style="max-width:480px">
    <div class="modal-header" style="text-align:left">
      <h2 class="modal-title" id="unitModalTitle">Add Unit</h2>
      <p class="modal-subtitle">Configure unit settings</p>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Unit Name *</label><input type="text" id="unitName" class="form-input" placeholder="e.g., Neurology Ward"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group"><label class="form-label">Icon (Emoji)</label><input type="text" id="unitIcon" class="form-input" placeholder="ğŸ¥" style="font-size:1.5rem;text-align:center"></div>
        <div class="form-group"><label class="form-label">Access Code *</label><input type="text" id="unitCode" class="form-input" placeholder="1234" maxlength="4" style="text-align:center;letter-spacing:4px;font-family:monospace"></div>
      </div>
      <div class="form-group"><label class="form-label">Description</label><input type="text" id="unitDesc" class="form-input" placeholder="Brief description"></div>
      <div class="form-group"><label class="form-label">Google Sheet ID</label><input type="text" id="unitSheetId" class="form-input" placeholder="From spreadsheet URL"></div>
      <div class="form-group"><label class="form-label">Color Theme</label><div class="color-options" id="colorOptions"><div class="color-option selected" data-color="#d4a437" style="background:#d4a437"></div><div class="color-option" data-color="#14b8a6" style="background:#14b8a6"></div><div class="color-option" data-color="#3b82f6" style="background:#3b82f6"></div><div class="color-option" data-color="#a855f7" style="background:#a855f7"></div><div class="color-option" data-color="#ef4444" style="background:#ef4444"></div><div class="color-option" data-color="#f97316" style="background:#f97316"></div><div class="color-option" data-color="#10b981" style="background:#10b981"></div><div class="color-option" data-color="#ec4899" style="background:#ec4899"></div></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
      <button class="btn btn-primary" id="saveUnitBtn">Save Unit</button>
    </div>
  </div>
</div>

<div class="modal" id="patientModal">
  <div class="modal-box" style="max-width:480px">
    <div class="modal-header" style="text-align:left">
      <h2 class="modal-title">Add Patient</h2>
      <p class="modal-subtitle">Enter patient details</p>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Patient Name *</label><input type="text" id="patientName" class="form-input" placeholder="Full name"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group"><label class="form-label">Room/Bed</label><input type="text" id="patientRoom" class="form-input" placeholder="e.g., 21-A"></div>
        <div class="form-group"><label class="form-label">Status</label><select id="patientStatus" class="form-select"><option value="active">Active</option><option value="critical">Critical</option><option value="chronic">Chronic</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Diagnosis</label><textarea id="patientDiagnosis" class="form-textarea" placeholder="Primary diagnosis"></textarea></div>
      <div class="form-group"><label class="form-label">Assigned Doctor</label><input type="text" id="patientDoctor" class="form-input" placeholder="Dr. Name"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
      <button class="btn btn-primary" id="savePatientBtn">Save Patient</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="adminPanel">
  <header class="admin-header">
    <div class="dash-logo"><div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div><span style="font-weight:600">MedWard</span><span class="admin-badge">ADMIN</span></div>
    <button class="btn btn-secondary btn-sm" id="exitAdminBtn">Exit Admin</button>
  </header>
  <div class="admin-content">
    <div class="admin-section">
      <div class="admin-section-header"><h2 class="admin-section-title">ğŸ¥ Hospital Units</h2><button class="btn btn-primary btn-sm" id="addUnitBtn">+ Add Unit</button></div>
      <div class="admin-section-body" style="padding:0;overflow-x:auto"><table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Sheet ID</th><th>Actions</th></tr></thead><tbody id="unitsTableBody"></tbody></table></div>
    </div>
    <div class="admin-section">
      <div class="admin-section-header"><h2 class="admin-section-title">âš™ï¸ Settings</h2></div>
      <div class="admin-section-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px">
          <div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="New password"></div>
          <div class="form-group"><label class="form-label">Claude API URL</label><input type="text" id="claudeApiUrl" class="form-input" placeholder="Google Apps Script URL"></div>
        </div>
        <button class="btn btn-primary" id="saveSettingsBtn" style="margin-top:16px">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard">
  <header class="dash-header">
    <div class="dash-logo">
      <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
      <span class="dash-unit-badge" id="dashUnitBadge">Unit</span>
    </div>
    <div class="dash-user">
      <div class="dash-user-info"><div class="dash-user-name" id="dashUserName">Doctor</div><div class="dash-user-role" id="dashUserRole">Role</div></div>
      <div class="dash-avatar" id="dashAvatar">DR</div>
      <button class="btn-icon" id="logoutBtn" title="Exit Unit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
  </header>
  <div class="dash-content">
    <div class="dash-welcome"><h1 id="dashWelcome">Welcome back</h1><p id="dashDate"></p></div>
    <div class="tabs">
      <button class="tab active" data-tab="patients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Patients</span></button>
      <button class="tab" data-tab="analysis"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42"/></svg><span>AI Analysis</span></button>
      <button class="tab" data-tab="scores"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Scores</span></button>
      <button class="tab" data-tab="reference"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg><span>Reference</span></button>
    </div>

    <!-- PATIENTS PANEL -->
    <div class="panel active" id="panelPatients">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
        <div class="stat-card"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
        <div class="stat-card"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
        <div class="stat-card"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="font-size:1.1rem;font-weight:600">Unit Patients</h2>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" id="refreshPatientsBtn">â†» Refresh</button>
          <button class="btn btn-primary btn-sm" id="addPatientBtn">+ Add Patient</button>
        </div>
      </div>
      <div class="patients-grid" id="patientsGrid"></div>
    </div>

    <!-- AI ANALYSIS PANEL -->
    <div class="panel" id="panelAnalysis">
      <div class="card" id="uploadSection">
        <div class="card-header"><h3 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload Medical Images</h3></div>
        <div class="card-body">
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
            <div style="font-weight:600;margin-bottom:4px">Drop files or tap to upload</div>
            <div style="font-size:0.85rem;color:var(--text-muted)">Select multiple images at once</div>
            <input type="file" class="upload-input" id="uploadInput" accept="image/*" multiple>
          </div>
          <div class="preview-grid" id="previewGrid"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3 class="card-title">Analysis Type</h3></div>
        <div class="card-body">
          <div class="analysis-types" id="analysisTypes">
            <div class="analysis-type active" data-type="lab"><div class="analysis-type-icon">ğŸ§ª</div><div class="analysis-type-name">Lab Results</div></div>
            <div class="analysis-type" data-type="xray"><div class="analysis-type-icon">ğŸ©»</div><div class="analysis-type-name">X-Ray</div></div>
            <div class="analysis-type" data-type="ct"><div class="analysis-type-icon">ğŸ§ </div><div class="analysis-type-name">CT/MRI</div></div>
            <div class="analysis-type" data-type="ecg"><div class="analysis-type-icon">ğŸ’“</div><div class="analysis-type-name">ECG</div></div>
            <div class="analysis-type" data-type="auto"><div class="analysis-type-icon">ğŸ”</div><div class="analysis-type-name">Auto</div></div>
          </div>
          <div class="neural-stats" id="neuralStats"></div>
        </div>
      </div>
      <button class="btn btn-primary btn-lg btn-full" id="analyzeBtn" disabled>ğŸ¤– Analyze with Claude AI</button>
      <div class="analysis-progress" id="analysisProgress"><div class="progress-spinner"></div><div style="font-weight:600">Analyzing...</div><div style="color:var(--text-muted);font-size:0.85rem" id="progressStatus">Processing images...</div></div>
      <div class="analysis-results" id="analysisResults">
        <div class="result-header"><h3 class="result-title">âœ“ Analysis Complete</h3><span class="result-badge" id="resultBadge">Claude AI</span></div>
        <div id="resultsContent"></div>
        <button class="btn btn-secondary btn-full" id="newAnalysisBtn" style="margin-top:16px">New Analysis</button>
      </div>
    </div>

    <!-- SCORES PANEL -->
    <div class="panel" id="panelScores">
      <div class="card"><div class="card-header"><h3 class="card-title">Clinical Calculators</h3></div><div class="card-body"><div class="scores-grid" id="scoresGrid"></div></div></div>
      <div id="calcArea"></div>
    </div>

    <!-- REFERENCE PANEL -->
    <div class="panel" id="panelReference">
      <div class="card"><div class="card-header"><h3 class="card-title">Ward Quick Reference</h3></div><div class="card-body"><div class="ref-filters" id="refFilters"></div><div class="ref-grid" id="refGrid"></div></div></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  STORAGE_KEY: 'medward_enterprise_v3',
  DEFAULT_ADMIN_PWD: 'admin123',
  DEFAULT_API: 'https://script.google.com/macros/s/AKfycbxjp-KDUx_eYvavlEHDciE-fR1V8eFM39vJfAcA7btETL-QUmrwuYU-_92_Pl20gl75kg/exec'
};

const DEFAULT_UNITS = [
  { id:'neuro', name:'Neurology', icon:'ğŸ§ ', desc:'Stroke & Neurological Disorders', code:'1234', color:'#a855f7', sheetId:'' },
  { id:'cardio', name:'Cardiology', icon:'â¤ï¸', desc:'Cardiac Care Unit', code:'5678', color:'#ef4444', sheetId:'' },
  { id:'icu', name:'ICU', icon:'ğŸ¥', desc:'Intensive Care Unit', code:'9012', color:'#f97316', sheetId:'' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  units: [],
  settings: { adminPassword: CONFIG.DEFAULT_ADMIN_PWD, claudeApiUrl: CONFIG.DEFAULT_API },
  currentUnit: null,
  currentUser: null,
  patients: [],
  analysisType: 'lab',
  uploadedFiles: [],
  uploadedBase64s: [],
  activeScore: null,
  scores: {}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function initials(name) {
  if (!name) return '?';
  const p = name.trim().split(/\s+/);
  return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase();
}

function closeModal(id) { $(id).classList.remove('active'); }
function openModal(id) { $(id).classList.add('active'); }

function saveState() {
  try { localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({ units: state.units, settings: state.settings })); } catch(e) {}
}

function loadState() {
  try {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      state.units = (data.units && data.units.length > 0) ? data.units : DEFAULT_UNITS;
      state.settings = { ...state.settings, ...data.settings };
    } else {
      state.units = [...DEFAULT_UNITS];
    }
  } catch(e) { 
    state.units = [...DEFAULT_UNITS]; 
  }
  // Ensure we always have units
  if (!state.units || state.units.length === 0) {
    state.units = [...DEFAULT_UNITS];
  }
  console.log('[MedWard] Loaded', state.units.length, 'units');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANDING PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUnits() {
  const grid = $('unitsGrid');
  if (!grid) { console.error('[MedWard] unitsGrid not found'); return; }
  
  // Ensure units exist
  if (!state.units || state.units.length === 0) {
    state.units = [...DEFAULT_UNITS];
  }
  
  console.log('[MedWard] Rendering', state.units.length, 'units');
  
  grid.innerHTML = state.units.map(u => `
    <div class="unit-card" data-id="${u.id}" style="--unit-color:${u.color}">
      <div class="unit-card-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
      <div class="unit-card-icon">${u.icon}</div>
      <div class="unit-card-name">${u.name}</div>
      <div class="unit-card-desc">${u.desc || 'No description'}</div>
    </div>
  `).join('');
  
  $$('.unit-card').forEach(card => { card.onclick = () => openAccessModal(card.dataset.id); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCESS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedUnitId = null;

function openAccessModal(unitId) {
  const unit = state.units.find(u => u.id === unitId);
  if (!unit) return;
  selectedUnitId = unitId;
  $('accessIcon').textContent = unit.icon;
  $('accessTitle').textContent = unit.name;
  $('codeError').classList.remove('show');
  $('userSection').style.display = 'none';
  $('enterUnitBtn').style.display = 'none';
  $$('.code-digit').forEach(inp => { inp.value = ''; inp.disabled = false; inp.classList.remove('error', 'success'); });
  openModal('accessModal');
  document.querySelector('.code-digit[data-idx="0"]').focus();
}

function setupCodeInputs() {
  const inputs = $$('.code-digit');
  inputs.forEach((inp, idx) => {
    inp.oninput = e => {
      const val = e.target.value.replace(/\D/g, '');
      e.target.value = val;
      if (val && idx < 3) inputs[idx + 1].focus();
      const code = Array.from(inputs).map(i => i.value).join('');
      if (code.length === 4) validateCode(code);
    };
    inp.onkeydown = e => { if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus(); };
  });
}

function validateCode(code) {
  const unit = state.units.find(u => u.id === selectedUnitId);
  if (!unit) return;
  if (code === unit.code) {
    $$('.code-digit').forEach(i => { i.disabled = true; i.classList.add('success'); });
    $('userSection').style.display = 'block';
    $('enterUnitBtn').style.display = 'flex';
    $('userName').focus();
    $('codeError').classList.remove('show');
  } else {
    $('codeError').classList.add('show');
    $$('.code-digit').forEach(i => { i.classList.add('error'); setTimeout(() => i.classList.remove('error'), 400); });
  }
}

function enterUnit() {
  const name = $('userName').value.trim();
  const role = $('userRole').value;
  if (!name) { toast('Please enter your name', true); return; }
  state.currentUnit = state.units.find(u => u.id === selectedUnitId);
  state.currentUser = { name, role };
  closeModal('accessModal');
  showDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdminLogin() {
  $('adminPassword').value = '';
  $('adminError').classList.remove('show');
  openModal('adminLoginModal');
  $('adminPassword').focus();
}

function loginAdmin() {
  if ($('adminPassword').value === state.settings.adminPassword) {
    closeModal('adminLoginModal');
    showAdminPanel();
  } else {
    $('adminError').classList.add('show');
  }
}

function showAdminPanel() {
  $('landing').classList.add('hidden');
  $('adminPanel').classList.add('active');
  renderUnitsTable();
  $('claudeApiUrl').value = state.settings.claudeApiUrl || '';
}

function exitAdmin() {
  $('adminPanel').classList.remove('active');
  $('landing').classList.remove('hidden');
}

function renderUnitsTable() {
  const tbody = $('unitsTableBody');
  if (!state.units.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:40px">No units</td></tr>';
    return;
  }
  tbody.innerHTML = state.units.map(u => `
    <tr>
      <td><span style="margin-right:10px;font-size:1.25rem">${u.icon}</span><b>${u.name}</b></td>
      <td><code style="background:var(--bg-elevated);padding:4px 10px;border-radius:6px">${u.code}</code></td>
      <td style="color:var(--text-muted);font-size:0.85rem">${u.sheetId ? u.sheetId.substring(0,12)+'...' : 'â€”'}</td>
      <td><div style="display:flex;gap:8px"><button class="btn-icon" onclick="MW.editUnit('${u.id}')" title="Edit">âœï¸</button><button class="btn-icon" onclick="MW.deleteUnit('${u.id}')" title="Delete">ğŸ—‘ï¸</button></div></td>
    </tr>
  `).join('');
}

let editingUnitId = null;

function openUnitModal(unitId = null) {
  editingUnitId = unitId;
  if (unitId) {
    const u = state.units.find(x => x.id === unitId);
    $('unitModalTitle').textContent = 'Edit Unit';
    $('unitName').value = u.name;
    $('unitIcon').value = u.icon;
    $('unitCode').value = u.code;
    $('unitDesc').value = u.desc || '';
    $('unitSheetId').value = u.sheetId || '';
    $$('.color-option').forEach(o => o.classList.toggle('selected', o.dataset.color === u.color));
  } else {
    $('unitModalTitle').textContent = 'Add Unit';
    $('unitName').value = '';
    $('unitIcon').value = 'ğŸ¥';
    $('unitCode').value = '';
    $('unitDesc').value = '';
    $('unitSheetId').value = '';
    $$('.color-option').forEach((o, i) => o.classList.toggle('selected', i === 0));
  }
  openModal('unitModal');
}

function saveUnit() {
  const name = $('unitName').value.trim();
  const icon = $('unitIcon').value.trim() || 'ğŸ¥';
  const code = $('unitCode').value.trim();
  const desc = $('unitDesc').value.trim();
  const sheetId = $('unitSheetId').value.trim();
  const color = document.querySelector('.color-option.selected')?.dataset.color || '#d4a437';
  if (!name || !code) { toast('Name and code required', true); return; }
  if (!/^\d{4}$/.test(code)) { toast('Code must be 4 digits', true); return; }
  if (editingUnitId) {
    const idx = state.units.findIndex(u => u.id === editingUnitId);
    if (idx >= 0) state.units[idx] = { ...state.units[idx], name, icon, code, desc, sheetId, color };
  } else {
    const id = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
    state.units.push({ id, name, icon, code, desc, sheetId, color });
  }
  saveState(); renderUnitsTable(); renderUnits(); closeModal('unitModal');
  toast(editingUnitId ? 'Unit updated!' : 'Unit created!');
}

function deleteUnit(unitId) {
  if (!confirm('Delete this unit?')) return;
  state.units = state.units.filter(u => u.id !== unitId);
  saveState(); renderUnitsTable(); renderUnits();
  toast('Unit deleted');
}

function saveSettings() {
  const pwd = $('newAdminPwd').value.trim();
  const url = $('claudeApiUrl').value.trim();
  if (pwd) state.settings.adminPassword = pwd;
  if (url) state.settings.claudeApiUrl = url;
  saveState();
  toast('Settings saved!');
  $('newAdminPwd').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDashboard() {
  $('landing').classList.add('hidden');
  $('dashboard').classList.add('active');
  const u = state.currentUnit;
  $('dashUnitBadge').textContent = u.name;
  $('dashUnitBadge').style.cssText = `border:1px solid ${u.color};color:${u.color};background:${u.color}20`;
  $('dashUserName').textContent = state.currentUser.name;
  $('dashUserRole').textContent = state.currentUser.role;
  $('dashAvatar').textContent = initials(state.currentUser.name);
  $('dashWelcome').textContent = `Welcome, Dr. ${state.currentUser.name.split(' ')[0]}`;
  $('dashDate').textContent = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  setupTabs(); loadPatients(); renderScores(); renderRefs(); setupUpload(); updateNeuralStats();
  toast(`Entered ${u.name}`);
}

function logout() {
  state.currentUnit = null;
  state.currentUser = null;
  state.patients = [];
  $('dashboard').classList.remove('active');
  $('landing').classList.remove('hidden');
}

function setupTabs() {
  $$('.tab').forEach(tab => {
    tab.onclick = () => {
      $$('.tab').forEach(t => t.classList.remove('active'));
      $$('.panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      $('panel' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).classList.add('active');
    };
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadPatients() {
  // Demo data - in production fetch from Google Sheet via sheetId
  state.patients = [
    { id:1, name:'Ahmed Al-Rashid', room:'21-A', diagnosis:'Acute Ischemic Stroke - MCA territory', status:'critical', doctor:'Dr. Fathy' },
    { id:2, name:'Fatima Hassan', room:'21-B', diagnosis:'CHF Exacerbation, EF 25%', status:'active', doctor:'Dr. Fathy' },
    { id:3, name:'Mohammed Saeed', room:'22-A', diagnosis:'DKA, Type 1 DM', status:'active', doctor:'Dr. Ahmed' }
  ];
  renderPatients();
}

function renderPatients() {
  const grid = $('patientsGrid');
  if (!state.patients.length) {
    grid.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:60px;grid-column:1/-1"><p>No patients in this unit</p></div>';
  } else {
    grid.innerHTML = state.patients.map(p => `
      <div class="patient-card ${p.status}">
        <div class="patient-header">
          <div class="patient-avatar">${initials(p.name)}</div>
          <div><div class="patient-name">${p.name}</div><div class="patient-meta">Room ${p.room} â€¢ ${p.doctor}</div></div>
          <span class="patient-status ${p.status}">${p.status}</span>
        </div>
        <div class="patient-diagnosis">${p.diagnosis}</div>
        <div class="patient-actions">
          <button class="btn btn-secondary">View</button>
          <button class="btn btn-primary">Rounds</button>
        </div>
      </div>
    `).join('');
  }
  $('statTotal').textContent = state.patients.length;
  $('statActive').textContent = state.patients.filter(p => p.status === 'active').length;
  $('statCritical').textContent = state.patients.filter(p => p.status === 'critical').length;
  $('statChronic').textContent = state.patients.filter(p => p.status === 'chronic').length;
}

function openPatientModal() {
  $('patientName').value = '';
  $('patientRoom').value = '';
  $('patientDiagnosis').value = '';
  $('patientDoctor').value = state.currentUser?.name || '';
  $('patientStatus').value = 'active';
  openModal('patientModal');
}

function savePatient() {
  const name = $('patientName').value.trim();
  if (!name) { toast('Patient name required', true); return; }
  state.patients.push({
    id: Date.now(),
    name,
    room: $('patientRoom').value.trim() || 'â€”',
    diagnosis: $('patientDiagnosis').value.trim() || 'No diagnosis',
    status: $('patientStatus').value,
    doctor: $('patientDoctor').value.trim() || 'Unassigned'
  });
  renderPatients(); closeModal('patientModal');
  toast('Patient added!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ANALYSIS WITH NEURAL ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupUpload() {
  const zone = $('uploadZone'), input = $('uploadInput');
  zone.onclick = () => input.click();
  zone.ondragover = e => { e.preventDefault(); zone.classList.add('dragover'); };
  zone.ondragleave = () => zone.classList.remove('dragover');
  zone.ondrop = e => { e.preventDefault(); zone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
  input.onchange = () => { if (input.files.length) handleFiles(input.files); };
  $$('.analysis-type').forEach(t => {
    t.onclick = () => {
      $$('.analysis-type').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      state.analysisType = t.dataset.type;
    };
  });
}

function handleFiles(files) {
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    state.uploadedFiles.push(file);
    const reader = new FileReader();
    reader.onload = e => { state.uploadedBase64s.push(e.target.result); renderPreviews(); };
    reader.readAsDataURL(file);
  });
  $('uploadZone').classList.add('has-file');
  $('analyzeBtn').disabled = false;
}

function renderPreviews() {
  $('previewGrid').innerHTML = state.uploadedBase64s.map((b, i) => `<div class="preview-thumb" onclick="MW.removeFile(${i})"><img src="${b}"></div>`).join('');
}

function removeFile(idx) {
  state.uploadedFiles.splice(idx, 1);
  state.uploadedBase64s.splice(idx, 1);
  renderPreviews();
  if (!state.uploadedFiles.length) {
    $('uploadZone').classList.remove('has-file');
    $('analyzeBtn').disabled = true;
  }
}

function updateNeuralStats() {
  if (typeof NeuralEngine !== 'undefined') {
    const stats = NeuralEngine.getStats();
    $('neuralStats').innerHTML = `
      <span class="neural-stat">ğŸ§  ${stats.patterns} patterns</span>
      <span class="neural-stat cached">âœ“ ${stats.hitRate} cache hit</span>
    `;
  }
}

async function runAnalysis() {
  if (!state.uploadedBase64s.length) { toast('Upload images first', true); return; }
  const startTime = performance.now();
  $('uploadSection').style.display = 'none';
  $('analysisProgress').classList.add('show');
  $('analysisResults').classList.remove('show');

  const total = state.uploadedBase64s.length;
  let processed = 0;
  let allText = [];
  let fromCache = false;

  // Check Neural Engine cache first
  if (typeof NeuralEngine !== 'undefined' && state.uploadedBase64s.length === 1) {
    const cacheResult = NeuralEngine.query(state.uploadedBase64s[0], state.analysisType);
    if (cacheResult.match) {
      fromCache = true;
      $('analysisProgress').classList.remove('show');
      showResults(cacheResult.result, { totalTime: cacheResult.queryTime, imageCount: 1, cached: true });
      updateNeuralStats();
      toast('âš¡ Retrieved from Neural Cache!');
      return;
    }
  }

  // Call API for each image
  const promises = state.uploadedBase64s.map(base64 => {
    return fetch(state.settings.claudeApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'interpret', documentType: state.analysisType, image: base64, provider: 'claude' })
    })
    .then(r => r.json())
    .then(d => {
      processed++;
      $('progressStatus').textContent = `Processed ${processed}/${total} images...`;
      if (d.success && d.extractedText) allText.push(d.extractedText);
      return d;
    })
    .catch(() => ({ success: false }));
  });

  const results = await Promise.all(promises);
  $('analysisProgress').classList.remove('show');

  const analysis = { summary: '', findings: [], abnormalities: [], normalFindings: [], recommendations: [], insights: [] };
  
  results.forEach(d => {
    if (d.success && d.interpretation) {
      if (d.interpretation.summary) analysis.summary += d.interpretation.summary + ' ';
      if (d.interpretation.keyFindings) analysis.findings.push(...d.interpretation.keyFindings);
      if (d.interpretation.abnormalities) analysis.abnormalities.push(...d.interpretation.abnormalities);
      if (d.interpretation.normalFindings) analysis.normalFindings.push(...d.interpretation.normalFindings);
    }
    if (d.clinicalPearls) analysis.insights.push(...d.clinicalPearls);
    if (d.presentation?.recommendations) analysis.recommendations.push(...d.presentation.recommendations);
  });

  // Enhance with Lab Engine
  if (typeof LabEngine !== 'undefined' && allText.length) {
    const labResult = LabEngine.analyze(allText.join('\n'));
    if (labResult.summary) analysis.summary = labResult.summary;
    if (labResult.insights) analysis.insights = [...labResult.insights, ...analysis.insights];
    if (labResult.recommendations) analysis.recommendations = [...labResult.recommendations, ...analysis.recommendations];
    labResult.findings?.forEach(f => {
      analysis.abnormalities.push({ name: f.name, value: f.value + ' ' + (f.unit || ''), flag: f.flag, severity: f.severity, reference: f.reference, interpretation: f.interpretation });
    });
    if (labResult.normalFindings) analysis.normalFindings = labResult.normalFindings;
  }

  // Learn to Neural Engine
  if (typeof NeuralEngine !== 'undefined' && state.uploadedBase64s.length === 1) {
    NeuralEngine.learn(state.uploadedBase64s[0], state.analysisType, analysis);
    updateNeuralStats();
  }

  showResults(analysis, { totalTime: performance.now() - startTime, imageCount: total, cached: false });
  toast('Analysis complete!');
}
id:'malig',name:'Malignancy',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
  ], interp: s => s <= 1 ? ['Low','var(--emerald)'] : s <= 4 ? ['Moderate','var(--gold)'] : ['High','var(--rose)']},
  curb65: { name:'CURB-65', icon:'ğŸ¦ ', desc:'Pneumonia', max:5, items:[
    {id:'c',name:'Confusion',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
    {id:'u',name:'BUN >19',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
    {id:'r',name:'RR â‰¥30',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
    {id:'b',name:'BP <90/60',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
    {id:'65',name:'Age â‰¥65',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
  ], interp: s => s <= 1 ? ['Outpatient','var(--emerald)'] : s === 2 ? ['Admit','var(--gold)'] : ['ICU','var(--rose)']}
};

function renderScores() {
  $('scoresGrid').innerHTML = Object.entries(SCORES).map(([k, v]) => `
    <div class="score-tile ${state.activeScore === k ? 'active' : ''}" data-score="${k}">
      <div class="score-icon">${v.icon}</div>
      <div class="score-name">${v.name}</div>
      <div class="score-desc">${v.desc}</div>
    </div>
  `).join('');
  $$('.score-tile').forEach(tile => {
    tile.onclick = () => {
      state.activeScore = tile.dataset.score;
      state.scores[state.activeScore] = {};
      renderScores();
      renderCalc();
    };
  });
}

function renderCalc() {
  if (!state.activeScore) { $('calcArea').innerHTML = ''; return; }
  const sc = SCORES[state.activeScore];
  let h = `<div class="card"><div class="card-header"><h3 class="card-title">${sc.icon} ${sc.name} Calculator</h3></div><div class="card-body">`;
  sc.items.forEach((item, idx) => {
    h += `<div class="calc-item"><div class="calc-item-head"><div class="calc-item-num">${idx + 1}</div><div class="calc-item-name">${item.name}</div></div><div class="calc-opts">`;
    item.opts.forEach(opt => {
      const sel = state.scores[state.activeScore]?.[item.id] === opt.s ? 'sel' : '';
      h += `<label class="calc-opt ${sel}"><input type="radio" name="${item.id}" value="${opt.s}" ${sel ? 'checked' : ''} onchange="MW.setScore('${item.id}',${opt.s})"><span class="calc-opt-score">${opt.s}</span><span class="calc-opt-label">${opt.l}</span></label>`;
    });
    h += `</div></div>`;
  });
  const total = Object.values(state.scores[state.activeScore] || {}).reduce((a, b) => a + b, 0);
  const [label, color] = sc.interp(total);
  h += `<div class="calc-result"><div class="calc-result-score">${total}</div><div style="color:var(--text-muted)">/ ${sc.max}</div><div class="severity-pill" style="background:${color}20;color:${color}">${label}</div></div></div></div>`;
  $('calcArea').innerHTML = h;
}

function setScore(id, val) {
  if (!state.scores[state.activeScore]) state.scores[state.activeScore] = {};
  state.scores[state.activeScore][id] = val;
  renderCalc();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFERENCE CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REFS = [
  { cat:'critical', title:'ğŸš¨ Critical Lab Values', content:'<p><b>Kâº:</b> <2.5 or >6.5 mmol/L</p><p><b>Naâº:</b> <120 or >160 mmol/L</p><p><b>Glucose:</b> <40 or >500 mg/dL</p><p><b>Hgb:</b> <7 g/dL | <b>Plt:</b> <50k</p><p><b>pH:</b> <7.2 or >7.6</p>' },
  { cat:'critical', title:'âš¡ Hyperkalemia Protocol', content:'<p><b>Stabilize:</b> Ca gluconate 10mL IV</p><p><b>Shift:</b> Insulin 10U + D50 | Salbutamol neb</p><p><b>Remove:</b> Kayexalate | Furosemide | HD</p>' },
  { cat:'cardiac', title:'â¤ï¸ ACS Management', content:'<p><b>MONA:</b> Morphine, Oâ‚‚, Nitrates, Aspirin</p><p><b>STEMI:</b> PCI <90min | Lysis <30min</p><p><b>NSTEMI:</b> Anticoag + early cath</p>' },
  { cat:'cardiac', title:'ğŸ’“ Afib Rate Control', content:'<p><b>Stable:</b> Diltiazem 15-20mg IV or Metoprolol 5mg IV</p><p><b>Target HR:</b> <110 bpm</p><p><b>HFrEF:</b> Avoid diltiazem - use digoxin/amiodarone</p>' },
  { cat:'respiratory', title:'ğŸ« COPD Exacerbation', content:'<p><b>Bronchodilators:</b> Salbutamol + Ipratropium nebs</p><p><b>Steroids:</b> Prednisone 40mg x5 days</p><p><b>BiPAP:</b> If pH <7.35, pCOâ‚‚ >45</p>' },
  { cat:'respiratory', title:'ğŸ”µ Oxygen Targets', content:'<p><b>General:</b> SpOâ‚‚ 94-98%</p><p><b>COPD:</b> 88-92%</p><p><b>ARDS:</b> Accept 88-92%</p>' },
  { cat:'neuro', title:'ğŸ§  Stroke - tPA Criteria', content:'<p><b>Window:</b> â‰¤4.5h from last known well</p><p><b>Dose:</b> 0.9 mg/kg (max 90mg)</p><p><b>BP goal:</b> <185/110 pre-tPA</p><p><b>Post-tPA:</b> <180/105 x24h</p>' },
  { cat:'neuro', title:'ğŸ’Š Seizure Management', content:'<p><b>1st line:</b> Lorazepam 4mg IV</p><p><b>2nd line:</b> Levetiracetam 60mg/kg or Fosphenytoin 20mg/kg</p><p><b>Refractory:</b> Propofol/Midazolam gtt</p>' },
  { cat:'infection', title:'ğŸ¦  Sepsis Hour-1 Bundle', content:'<p><b>1.</b> Measure lactate</p><p><b>2.</b> Blood cultures before abx</p><p><b>3.</b> Broad-spectrum antibiotics</p><p><b>4.</b> 30 mL/kg crystalloid if hypotensive/lactate â‰¥4</p>' },
  { cat:'infection', title:'ğŸ’Š Empiric Antibiotics', content:'<p><b>CAP:</b> Ceftriaxone + Azithromycin</p><p><b>HAP/VAP:</b> Pip-Tazo + Vancomycin</p><p><b>UTI:</b> Ceftriaxone or Ciprofloxacin</p><p><b>Cellulitis:</b> Cefazolin Â± Vanc if MRSA</p>' },
  { cat:'renal', title:'ğŸ”¬ AKI Staging (KDIGO)', content:'<p><b>Stage 1:</b> Cr â†‘1.5-1.9x baseline or â†‘â‰¥0.3</p><p><b>Stage 2:</b> Cr â†‘2-2.9x baseline</p><p><b>Stage 3:</b> Cr â†‘3x or â‰¥4.0 or RRT</p>' },
  { cat:'renal', title:'ğŸ’§ IV Fluid Guide', content:'<p><b>Resuscitation:</b> NS or LR bolus 500-1000mL</p><p><b>Maintenance:</b> 25-30 mL/kg/day</p><p><b>Hyperkalemia:</b> Avoid LR (contains Kâº)</p>' },
  { cat:'gi', title:'ğŸ©¸ GI Bleed Management', content:'<p><b>Resuscitate:</b> 2 large bore IV, type & cross</p><p><b>Transfuse:</b> Hgb <7 (or <8 if CAD)</p><p><b>PPI:</b> Pantoprazole 80mg bolus then 8mg/hr</p><p><b>Variceal:</b> + Octreotide + Ceftriaxone</p>' },
  { cat:'gi', title:'ğŸº Alcohol Withdrawal', content:'<p><b>CIWA protocol:</b> Lorazepam PRN</p><p><b>Thiamine:</b> 500mg IV TID x3 days</p><p><b>DTs peak:</b> 48-72h post last drink</p>' },
  { cat:'anticoag', title:'ğŸ’‰ Anticoagulant Reversal', content:'<p><b>Warfarin:</b> Vitamin K + 4F-PCC</p><p><b>Heparin:</b> Protamine (1mg per 100U)</p><p><b>Dabigatran:</b> Idarucizumab</p><p><b>Xa inhibitors:</b> Andexanet alfa</p>' },
  { cat:'diabetes', title:'ğŸ“Š DKA Management', content:'<p><b>Fluids:</b> NS 1L/hr x2h, then 250-500mL/hr</p><p><b>Insulin:</b> 0.1 U/kg/hr (after Kâº >3.3)</p><p><b>Kâº:</b> Add 20-40 mEq/L when <5.3</p><p><b>Bicarb:</b> Only if pH <6.9</p>' }
];

const REF_CATS = [
  { id:'all', name:'All' },
  { id:'critical', name:'ğŸš¨ Critical' },
  { id:'cardiac', name:'â¤ï¸ Cardiac' },
  { id:'respiratory', name:'ğŸ« Respiratory' },
  { id:'neuro', name:'ğŸ§  Neuro' },
  { id:'infection', name:'ğŸ¦  Infection' },
  { id:'renal', name:'ğŸ’§ Renal' },
  { id:'gi', name:'ğŸ©º GI' },
  { id:'anticoag', name:'ğŸ’‰ Anticoag' },
  { id:'diabetes', name:'ğŸ“Š Diabetes' }
];

let activeRefCat = 'all';

function renderRefs() {
  $('refFilters').innerHTML = REF_CATS.map(c => `<button class="ref-filter ${activeRefCat === c.id ? 'active' : ''}" data-cat="${c.id}">${c.name}</button>`).join('');
  const filtered = activeRefCat === 'all' ? REFS : REFS.filter(r => r.cat === activeRefCat);
  $('refGrid').innerHTML = filtered.map(r => `<div class="ref-card"><h4>${r.title}</h4>${r.content}</div>`).join('');
  $$('.ref-filter').forEach(btn => { btn.onclick = () => { activeRefCat = btn.dataset.cat; renderRefs(); }; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  loadState();
  renderUnits();
  setupCodeInputs();
  
  // Initialize Neural Engine
  if (typeof NeuralEngine !== 'undefined') {
    NeuralEngine.init();
    console.log('[MedWard] Neural Engine initialized');
  }

  // Event listeners
  $('adminFab').onclick = openAdminLogin;
  $('adminLoginBtn').onclick = loginAdmin;
  $('adminPassword').onkeydown = e => { if (e.key === 'Enter') loginAdmin(); };
  $('exitAdminBtn').onclick = exitAdmin;
  $('addUnitBtn').onclick = () => openUnitModal();
  $('saveUnitBtn').onclick = saveUnit;
  $('saveSettingsBtn').onclick = saveSettings;
  $('enterUnitBtn').onclick = enterUnit;
  $('userName').onkeydown = e => { if (e.key === 'Enter') enterUnit(); };
  $('logoutBtn').onclick = logout;
  $('addPatientBtn').onclick = openPatientModal;
  $('savePatientBtn').onclick = savePatient;
  $('refreshPatientsBtn').onclick = loadPatients;
  $('analyzeBtn').onclick = runAnalysis;
  $('newAnalysisBtn').onclick = resetAnalysis;

  // Color picker
  $$('.color-option').forEach(o => {
    o.onclick = () => { $$('.color-option').forEach(x => x.classList.remove('selected')); o.classList.add('selected'); };
  });

  // Modal backdrop close
  $$('.modal').forEach(m => { m.onclick = e => { if (e.target === m) m.classList.remove('active'); }; });
}

// Global access for inline handlers
window.MW = { editUnit: openUnitModal, deleteUnit, removeFile, setScore };
window.closeModal = closeModal;

document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', init) : init();

})();
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NEURAL ENGINE - Intelligent Pattern Caching System
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
var NeuralEngine = (function() {
  'use strict';
  var CONFIG = {
    STORAGE_KEY: 'medward_neural_v3',
    MAX_PATTERNS: 500,
    SIMILARITY_THRESHOLD: 0.85,
    LSH_BANDS: 20,
    LSH_ROWS: 5,
    PATTERN_EXPIRY_DAYS: 30,
    LEARNING_RATE: 0.15
  };
  var patterns = [];
  var hashIndex = new Map();
  var stats = { hits: 0, misses: 0, learned: 0 };

  function init() {
    try {
      var saved = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (saved) {
        var data = JSON.parse(saved);
        patterns = data.patterns || [];
        stats = data.stats || stats;
        rebuildIndex();
        pruneExpired();
      }
    } catch (e) { console.warn('[Neural] Init error:', e); }
    console.log('[Neural] Initialized with ' + patterns.length + ' patterns');
  }

  function save() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({ patterns: patterns.slice(0, CONFIG.MAX_PATTERNS), stats: stats }));
    } catch (e) {}
  }

  function rebuildIndex() {
    hashIndex.clear();
    patterns.forEach(function(pattern, idx) {
      if (pattern.buckets) {
        pattern.buckets.forEach(function(bucket) {
          if (!hashIndex.has(bucket)) hashIndex.set(bucket, []);
          hashIndex.get(bucket).push(idx);
        });
      }
    });
  }

  function extractFeatures(text) {
    if (!text || text.length < 20) return null;
    var features = {};
    var words = text.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/).filter(function(w) { return w.length > 2; });
    var bigrams = [];
    for (var i = 0; i < words.length - 1; i++) bigrams.push(words[i] + '_' + words[i + 1]);
    words.concat(bigrams).forEach(function(term) { features[term] = (features[term] || 0) + 1; });
    var nums = text.match(/\d+\.?\d*/g) || [];
    features['_num_count'] = nums.length;
    features['_char_count'] = Math.floor(text.length / 100);
    return features;
  }

  function getLSHBuckets(features) {
    var keys = Object.keys(features).sort();
    var buckets = [];
    for (var band = 0; band < CONFIG.LSH_BANDS; band++) {
      var sig = '';
      for (var row = 0; row < CONFIG.LSH_ROWS; row++) {
        var idx = (band * CONFIG.LSH_ROWS + row) % keys.length;
        sig += keys[idx] + ':' + (features[keys[idx]] || 0) + '|';
      }
      buckets.push('b' + band + '_' + simpleHash(sig));
    }
    return buckets;
  }

  function findCandidates(buckets) {
    var candidateSet = new Set();
    buckets.forEach(function(bucket) {
      var indices = hashIndex.get(bucket);
      if (indices) indices.forEach(function(idx) { candidateSet.add(idx); });
    });
    return Array.from(candidateSet);
  }

  function calculateSimilarity(f1, f2) {
    var keys1 = Object.keys(f1), keys2 = Object.keys(f2);
    var allKeys = new Set(keys1.concat(keys2));
    var dotProduct = 0, mag1 = 0, mag2 = 0;
    allKeys.forEach(function(key) {
      var v1 = f1[key] || 0, v2 = f2[key] || 0;
      dotProduct += v1 * v2;
      mag1 += v1 * v1;
      mag2 += v2 * v2;
    });
    return mag1 && mag2 ? dotProduct / (Math.sqrt(mag1) * Math.sqrt(mag2)) : 0;
  }

  function query(text, docType) {
    var startTime = performance.now();
    var features = extractFeatures(text);
    if (!features) return { match: false, reason: 'insufficient_features' };
    var buckets = getLSHBuckets(features);
    var candidates = findCandidates(buckets);
    if (candidates.length === 0) { stats.misses++; return { match: false, reason: 'no_candidates' }; }
    var bestMatch = null, bestScore = 0;
    for (var i = 0; i < candidates.length; i++) {
      var pattern = patterns[candidates[i]];
      if (pattern.docType && pattern.docType !== docType) continue;
      var similarity = calculateSimilarity(features, pattern.features);
      var adjustedScore = similarity * (0.8 + 0.2 * Math.min(pattern.strength || 1, 5));
      if (adjustedScore > bestScore) { bestScore = adjustedScore; bestMatch = pattern; }
    }
    var queryTime = performance.now() - startTime;
    if (bestMatch && bestScore >= CONFIG.SIMILARITY_THRESHOLD) {
      stats.hits++;
      bestMatch.strength = (bestMatch.strength || 1) + CONFIG.LEARNING_RATE;
      bestMatch.lastUsed = Date.now();
      bestMatch.useCount = (bestMatch.useCount || 0) + 1;
      return { match: true, result: bestMatch.result, confidence: bestScore, queryTime: queryTime, source: 'neural_cache' };
    }
    stats.misses++;
    return { match: false, reason: 'below_threshold', bestScore: bestScore, queryTime: queryTime };
  }

  function learn(text, docType, result) {
    var features = extractFeatures(text);
    if (!features) return false;
    var buckets = getLSHBuckets(features);
    var candidates = findCandidates(buckets);
    for (var i = 0; i < candidates.length; i++) {
      var existing = patterns[candidates[i]];
      var similarity = calculateSimilarity(features, existing.features);
      if (similarity > 0.95) {
        existing.strength = (existing.strength || 1) + CONFIG.LEARNING_RATE * 2;
        existing.lastUsed = Date.now();
        save();
        return false;
      }
    }
    var pattern = {
      features: features,
      buckets: buckets,
      docType: docType,
      result: compressResult(result),
      strength: 1,
      created: Date.now(),
      lastUsed: Date.now(),
      useCount: 0
    };
    patterns.unshift(pattern);
    stats.learned++;
    buckets.forEach(function(bucket) {
      if (!hashIndex.has(bucket)) hashIndex.set(bucket, []);
      hashIndex.get(bucket).unshift(0);
    });
    if (patterns.length > CONFIG.MAX_PATTERNS) pruneWeakest();
    save();
    return true;
  }

  function compressResult(result) {
    return {
      summary: result.summary,
      findings: result.findings ? result.findings.slice(0, 5) : [],
      abnormalities: result.abnormalities ? result.abnormalities.slice(0, 5) : [],
      normalFindings: result.normalFindings ? result.normalFindings.slice(0, 5) : [],
      clinicalPearls: result.clinicalPearls ? result.clinicalPearls.slice(0, 3) : [],
      recommendations: result.recommendations ? result.recommendations.slice(0, 5) : []
    };
  }

  function pruneExpired() {
    var cutoff = Date.now() - (CONFIG.PATTERN_EXPIRY_DAYS * 24 * 60 * 60 * 1000);
    var before = patterns.length;
    patterns = patterns.filter(function(p) { return p.created > cutoff || p.useCount > 5; });
    if (patterns.length < before) rebuildIndex();
  }

  function pruneWeakest() {
    patterns.sort(function(a, b) {
      var scoreA = (a.strength || 1) * (1 / (Date.now() - a.lastUsed + 1));
      var scoreB = (b.strength || 1) * (1 / (Date.now() - b.lastUsed + 1));
      return scoreB - scoreA;
    });
    patterns = patterns.slice(0, CONFIG.MAX_PATTERNS);
    rebuildIndex();
  }

  function simpleHash(str) {
    var hash = 0;
    for (var i = 0; i < str.length; i++) hash = ((hash << 5) - hash + str.charCodeAt(i)) & 0xFFFFFFFF;
    return hash;
  }

  function getStats() {
    var hitRate = stats.hits + stats.misses > 0 ? (stats.hits / (stats.hits + stats.misses) * 100).toFixed(1) : 0;
    return { patterns: patterns.length, hits: stats.hits, misses: stats.misses, hitRate: hitRate + '%', learned: stats.learned };
  }

  function clear() {
    patterns = [];
    hashIndex.clear();
    stats = { hits: 0, misses: 0, learned: 0 };
    localStorage.removeItem(CONFIG.STORAGE_KEY);
  }

  return { init: init, query: query, learn: learn, getStats: getStats, clear: clear, extractFeatures: extractFeatures };
})();

if (typeof window !== 'undefined') window.NeuralEngine = NeuralEngine;
</script>

<!-- Lab Engine (external file) -->
<script src="lab-engine.js"></script>
</body>
</html>
