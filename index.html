<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <title>MedWard | Clinical Intelligence Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg-deep:#060a13;--bg-primary:#0a0f1a;--bg-card:#0d1424;--bg-elevated:#111b2e;--bg-input:#0f172a;
      --text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;
      --gold:#d4a437;--gold-light:#fbbf24;--gold-glow:rgba(212,164,55,0.15);
      --teal:#14b8a6;--teal-light:#2dd4bf;
      --blue:#3b82f6;--purple:#8b5cf6;--rose:#f43f5e;--orange:#f97316;--emerald:#10b981;
      --border:rgba(148,163,184,0.1);--border-light:rgba(148,163,184,0.15);
      --shadow-sm:0 1px 2px rgba(0,0,0,0.4);--shadow-md:0 4px 12px rgba(0,0,0,0.4);--shadow-lg:0 12px 40px rgba(0,0,0,0.5);
      --radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px;
    }
    html{font-size:16px;-webkit-font-smoothing:antialiased}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-deep);color:var(--text-primary);line-height:1.5;min-height:100vh;overflow-x:hidden}
    
    /* Ambient */
    .ambient{position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(ellipse 80% 50% at 20% 20%,var(--gold-glow),transparent),radial-gradient(ellipse 60% 40% at 80% 80%,rgba(20,184,166,0.08),transparent)}

    /* Header */
    .header{position:fixed;top:0;left:0;right:0;height:64px;background:rgba(10,15,26,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-mark{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:12px;display:grid;place-items:center;box-shadow:0 4px 20px rgba(212,164,55,0.25)}
    .logo-mark svg{width:22px;height:22px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}
    .logo-text{font-size:1.25rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .user-btn{display:none;align-items:center;gap:10px;padding:6px 14px 6px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:100px;cursor:pointer;transition:0.2s}
    .user-btn:hover{border-color:var(--gold)}
    .user-btn.show{display:flex}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:0.8rem;color:var(--bg-deep)}
    .user-name{font-size:0.85rem;font-weight:500}

    /* Screens */
    .screen{display:none;min-height:100vh;padding:80px 16px 32px}
    .screen.active{display:block}
    #login.active{display:flex;align-items:center;justify-content:center;padding:20px}

    /* Login */
    .login-card{width:100%;max-width:420px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:40px 32px;box-shadow:var(--shadow-lg);position:relative;overflow:hidden}
    .login-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--gold),var(--teal))}
    .login-header{text-align:center;margin-bottom:32px}
    .login-logo{width:64px;height:64px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:16px;display:grid;place-items:center;margin:0 auto 16px;box-shadow:0 8px 32px rgba(212,164,55,0.3)}
    .login-logo svg{width:36px;height:36px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}
    .login-title{font-size:1.5rem;font-weight:700;margin-bottom:4px}
    .login-sub{color:var(--text-muted);font-size:0.9rem}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
    .form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:inherit;font-size:0.95rem;transition:0.2s;-webkit-appearance:none}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-glow)}
    .form-input::placeholder{color:var(--text-muted)}
    .form-textarea{min-height:100px;resize:vertical}
    .form-select{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-md);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;touch-action:manipulation}
    .btn:active{transform:scale(0.98)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);box-shadow:0 4px 16px rgba(212,164,55,0.3)}
    .btn-primary:hover{box-shadow:0 6px 24px rgba(212,164,55,0.4)}
    .btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary)}
    .btn-secondary:hover{border-color:var(--gold);background:rgba(212,164,55,0.1)}
    .btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}
    .btn-sm{padding:8px 14px;font-size:0.8rem}
    .btn-icon{width:36px;height:36px;padding:0;border-radius:var(--radius-sm)}
    .btn-full{width:100%}

    /* Container */
    .container{max-width:1200px;margin:0 auto}
    .page-header{margin-bottom:24px}
    .page-title{font-size:1.4rem;font-weight:700;margin-bottom:2px}
    .page-sub{color:var(--text-muted);font-size:0.9rem}

    /* Tabs */
    .tabs{display:flex;gap:4px;background:var(--bg-card);border:1px solid var(--border);padding:4px;border-radius:var(--radius-md);margin-bottom:24px;overflow-x:auto}
    .tab{flex:1;min-width:80px;padding:10px 16px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-secondary);font-family:inherit;font-size:0.85rem;font-weight:500;cursor:pointer;transition:0.2s;white-space:nowrap}
    .tab:hover{color:var(--text-primary)}
    .tab.active{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);font-weight:600}
    .panel{display:none}
    .panel.active{display:block;animation:fadeUp 0.3s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Stats */
    .stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
    .stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;text-align:center}
    .stat-value{font-size:1.75rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-top:2px}

    /* Card */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:20px}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .card-title{display:flex;align-items:center;gap:10px;font-size:0.95rem;font-weight:600}
    .card-title svg{width:18px;height:18px;stroke:var(--gold)}
    .card-actions{display:flex;gap:8px}
    .card-body{padding:20px}

    /* Patient Grid */
    .patients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
    .patient-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;transition:all 0.2s;cursor:pointer;position:relative;overflow:hidden}
    .patient-card:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .patient-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--status-color,var(--teal))}
    .patient-card.critical::before{--status-color:var(--rose)}
    .patient-card.chronic::before{--status-color:var(--purple)}
    .patient-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
    .patient-main{display:flex;align-items:center;gap:14px}
    .patient-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:1rem;color:var(--bg-deep);flex-shrink:0}
    .patient-info h3{font-size:1rem;font-weight:600;margin-bottom:2px}
    .patient-info p{font-size:0.8rem;color:var(--text-muted)}
    .patient-badge{padding:4px 10px;border-radius:100px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
    .badge-active{background:rgba(20,184,166,0.15);color:var(--teal)}
    .badge-critical{background:rgba(244,63,94,0.15);color:var(--rose)}
    .badge-chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
    .badge-stable{background:rgba(59,130,246,0.15);color:var(--blue)}
    .patient-details{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .patient-detail{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px 12px}
    .patient-detail-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:2px}
    .patient-detail-value{font-size:0.85rem;font-weight:500}
    .patient-diagnosis{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:16px}
    .patient-diagnosis-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px}
    .patient-diagnosis-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.5}
    .patient-actions{display:flex;gap:8px}
    .patient-actions .btn{flex:1}

    /* Empty & Loading */
    .empty-state{text-align:center;padding:60px 20px}
    .empty-icon{width:64px;height:64px;background:var(--bg-elevated);border-radius:50%;display:grid;place-items:center;margin:0 auto 16px}
    .empty-icon svg{width:32px;height:32px;stroke:var(--text-muted)}
    .empty-title{font-size:1.1rem;font-weight:600;margin-bottom:4px}
    .empty-text{color:var(--text-muted);font-size:0.9rem}
    .loading{display:flex;flex-direction:column;align-items:center;gap:12px;padding:60px 20px;color:var(--text-muted)}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Scores Grid */
    .scores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .score-tile{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px 16px;text-align:center;cursor:pointer;transition:0.2s}
    .score-tile:hover{border-color:var(--gold);transform:translateY(-2px)}
    .score-tile.active{border-color:var(--gold);background:var(--gold-glow)}
    .score-icon{font-size:1.75rem;margin-bottom:8px}
    .score-name{font-weight:600;font-size:0.9rem;margin-bottom:2px}
    .score-desc{font-size:0.7rem;color:var(--text-muted)}

    /* Calculator */
    .calc-card{margin-top:20px}
    .calc-item{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;margin-bottom:12px}
    .calc-item-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .calc-item-num{width:28px;height:28px;background:var(--gold);border-radius:8px;display:grid;place-items:center;font-size:0.75rem;font-weight:700;color:var(--bg-deep)}
    .calc-item-name{font-weight:600;font-size:0.9rem}
    .calc-opts{display:flex;flex-wrap:wrap;gap:8px}
    .calc-opt{flex:1;min-width:70px;padding:12px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:0.15s}
    .calc-opt:hover{border-color:var(--gold)}
    .calc-opt.sel{background:var(--gold-glow);border-color:var(--gold)}
    .calc-opt input{display:none}
    .calc-opt-score{display:block;font-size:1.1rem;font-weight:700;color:var(--gold)}
    .calc-opt-label{font-size:0.7rem;color:var(--text-secondary)}
    .calc-result{background:var(--bg-elevated);border-radius:var(--radius-md);padding:24px;text-align:center;margin-top:16px}
    .calc-result-score{font-size:3rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .calc-result-max{font-size:1rem;color:var(--text-muted)}
    .severity-pill{display:inline-block;padding:8px 20px;border-radius:100px;font-size:0.85rem;font-weight:600;margin-top:12px}

    /* Reference */
    .ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .ref-card{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;border-left:3px solid var(--gold)}
    .ref-card h4{font-size:0.9rem;color:var(--gold);margin-bottom:10px}
    .ref-card p{font-size:0.8rem;color:var(--text-secondary);margin:4px 0;line-height:1.5}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;padding:16px;z-index:200;overflow-y:auto}
    .modal.active{display:flex}
    .modal-box{width:100%;max-width:500px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow-lg);animation:modalIn 0.3s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
    .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal-title{font-size:1.1rem;font-weight:600}
    .modal-close{width:36px;height:36px;background:var(--bg-elevated);border:none;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:grid;place-items:center;font-size:1.25rem}
    .modal-close:hover{color:var(--text-primary)}
    .modal-body{padding:20px;max-height:70vh;overflow-y:auto}
    .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}

    /* Toast */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 24px;background:var(--bg-elevated);border:1px solid var(--teal);border-radius:var(--radius-md);font-size:0.9rem;font-weight:500;opacity:0;transition:0.3s;z-index:300;box-shadow:var(--shadow-lg)}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.error{border-color:var(--rose)}

    /* Neural Badge */
    .neural-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(20,184,166,0.1);border:1px solid rgba(20,184,166,0.3);border-radius:100px;font-size:0.75rem;font-weight:600;color:var(--teal)}
    .neural-dot{width:6px;height:6px;background:var(--teal);border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

    /* Upload */
    .upload-area{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:40px 20px;text-align:center;cursor:pointer;transition:0.2s}
    .upload-area:hover,.upload-area.dragover{border-color:var(--gold);background:var(--gold-glow)}
    .upload-icon{width:56px;height:56px;background:var(--bg-elevated);border-radius:50%;display:grid;place-items:center;margin:0 auto 16px}
    .upload-icon svg{width:28px;height:28px;stroke:var(--gold)}
    .upload-title{font-weight:600;margin-bottom:4px}
    .upload-sub{font-size:0.85rem;color:var(--text-muted)}
    .upload-input{display:none}
    .doc-pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:20px;justify-content:center}
    .doc-pill{padding:8px 16px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:100px;font-size:0.8rem;font-weight:500;cursor:pointer;transition:0.2s}
    .doc-pill:hover{border-color:var(--gold)}
    .doc-pill.active{background:var(--gold-glow);border-color:var(--gold);color:var(--gold)}

    /* Analysis Results */
    .analysis-block{margin-bottom:20px}
    .analysis-block h4{font-size:0.9rem;color:var(--gold);margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .analysis-content{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;font-size:0.9rem;line-height:1.7}
    .analysis-content ul{margin:8px 0;padding-left:20px}
    .analysis-content li{margin:6px 0}

    /* Responsive */
    @media(max-width:640px){
      .stats-bar{grid-template-columns:repeat(2,1fr)}
      .patients-grid{grid-template-columns:1fr}
      .patient-details{grid-template-columns:1fr}
      .scores-grid{grid-template-columns:repeat(2,1fr)}
      .calc-opts{flex-direction:column}
      .calc-opt{min-width:100%}
      .modal-box{max-height:95vh}
    }
  </style>
</head>
<body>
  <div class="ambient"></div>
  
  <header class="header">
    <div class="logo">
      <div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
      <span class="logo-text">MedWard</span>
    </div>
    <div class="user-btn" id="userBtn">
      <div class="user-avatar" id="userAvatar">B</div>
      <span class="user-name" id="userName">User</span>
    </div>
  </header>

  <!-- Login -->
  <main class="screen active" id="loginScreen">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
        <h1 class="login-title">MedWard</h1>
        <p class="login-sub">Clinical Intelligence Platform</p>
      </div>
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input type="text" id="loginName" class="form-input" placeholder="Enter your name" autocomplete="off">
      </div>
      <button class="btn btn-primary btn-full" id="loginBtn">Continue to Dashboard</button>
    </div>
  </main>

  <!-- Dashboard -->
  <main class="screen" id="dashboardScreen">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Clinical Dashboard</h1>
        <p class="page-sub">Welcome back, <span id="greeting">Doctor</span></p>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="patients">Patients</button>
        <button class="tab" data-tab="analysis">Analysis</button>
        <button class="tab" data-tab="scores">Scores</button>
        <button class="tab" data-tab="reference">Reference</button>
      </div>

      <!-- Patients Panel -->
      <div class="panel active" id="panelPatients">
        <div class="stats-bar">
          <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
          <div class="stat"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
          <div class="stat"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
          <div class="stat"><div class="stat-value" id="statWards">0</div><div class="stat-label">Wards</div></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Ward Patients</h2>
            <div class="card-actions">
              <button class="btn btn-secondary btn-sm" id="refreshBtn">Refresh</button>
              <button class="btn btn-primary btn-sm" id="addPatientBtn">+ Add</button>
            </div>
          </div>
          <div class="card-body" id="patientsContainer">
            <div class="loading"><div class="spinner"></div>Loading patients...</div>
          </div>
        </div>
      </div>

      <!-- Analysis Panel -->
      <div class="panel" id="panelAnalysis">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Document Analysis</h2>
            <div class="neural-badge"><span class="neural-dot"></span>Neural Engine</div>
          </div>
          <div class="card-body">
            <div class="upload-area" id="uploadArea">
              <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
              <div class="upload-title">Drop file or tap to upload</div>
              <div class="upload-sub">PDF, images, or text files</div>
              <input type="file" class="upload-input" id="uploadInput" accept=".pdf,.png,.jpg,.jpeg,.txt">
            </div>
            <div class="doc-pills">
              <span class="doc-pill active" data-type="lab">Lab Results</span>
              <span class="doc-pill" data-type="imaging">Imaging</span>
              <span class="doc-pill" data-type="history">History</span>
              <span class="doc-pill" data-type="discharge">Discharge</span>
            </div>
          </div>
        </div>
        <div class="stats-bar">
          <div class="stat"><div class="stat-value" id="neuralPatterns">0</div><div class="stat-label">Patterns</div></div>
          <div class="stat"><div class="stat-value" id="neuralHits">0%</div><div class="stat-label">Cache</div></div>
          <div class="stat"><div class="stat-value" id="analysisCount">0</div><div class="stat-label">Analyses</div></div>
          <div class="stat"><div class="stat-value" id="avgTime">0s</div><div class="stat-label">Avg</div></div>
        </div>
      </div>

      <!-- Scores Panel -->
      <div class="panel" id="panelScores">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Clinical Scores</h2>
          </div>
          <div class="card-body">
            <div class="scores-grid" id="scoresGrid"></div>
          </div>
        </div>
        <div id="calcArea"></div>
      </div>

      <!-- Reference Panel -->
      <div class="panel" id="panelReference">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Quick Reference</h2>
          </div>
          <div class="card-body">
            <div class="ref-grid" id="refGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Patient Modal -->
  <div class="modal" id="patientModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2 class="modal-title" id="patientModalTitle">Add Patient</h2>
        <button class="modal-close" id="closePatientModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="patientForm">
          <div class="form-group">
            <label class="form-label">Patient Name *</label>
            <input type="text" id="patientName" class="form-input" required>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="form-group">
              <label class="form-label">Ward *</label>
              <input type="text" id="patientWard" class="form-input" placeholder="e.g. Ward 21" required>
            </div>
            <div class="form-group">
              <label class="form-label">Room/Bed</label>
              <input type="text" id="patientRoom" class="form-input" placeholder="e.g. 5">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Diagnosis</label>
            <textarea id="patientDiagnosis" class="form-textarea" placeholder="Primary diagnosis..."></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="form-group">
              <label class="form-label">Assigned Doctor</label>
              <input type="text" id="patientDoctor" class="form-input" placeholder="Dr. Name">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="patientStatus" class="form-select">
                <option value="active">Active</option>
                <option value="chronic">Chronic</option>
                <option value="critical">Critical</option>
              </select>
            </div>
          </div>
          <input type="hidden" id="patientRowIndex">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelPatient">Cancel</button>
        <button class="btn btn-primary" id="savePatient">Save Patient</button>
      </div>
    </div>
  </div>

  <!-- Analysis Modal -->
  <div class="modal" id="analysisModal">
    <div class="modal-box" style="max-width:600px">
      <div class="modal-header">
        <h2 class="modal-title">Analysis Results</h2>
        <button class="modal-close" id="closeAnalysisModal">&times;</button>
      </div>
      <div class="modal-body" id="analysisResults"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  var API = {
    PATIENT: 'https://script.google.com/macros/s/AKfycbx-l2xdsAHTZu7bcueN83Yz8xbCwtKbHfUSJuhIgtWVR5XyeJYh9TrfMgzznTYX4Z0kww/exec',
    CLAUDE: 'https://script.google.com/macros/s/AKfycby-3iNSD4CquZiyg0inXQ_sGs3IxNrSx1WzRREIv2ABKnyPP5GjvSYZdzClkZqWZ9M7Og/exec'
  };

  var state = {user:null,patients:[],patientsByWard:{},editing:null,docType:'lab',analyses:0,totalTime:0,activeScore:null,scores:{}};
  var $=function(id){return document.getElementById(id)};

  // ========== SCORES ==========
  var SCORES={
    nihss:{name:'NIHSS',icon:'üß†',desc:'Stroke Severity',max:42,items:[
      {id:'1a',name:'LOC',opts:[{s:0,l:'Alert'},{s:1,l:'Drowsy'},{s:2,l:'Stupor'},{s:3,l:'Coma'}]},
      {id:'1b',name:'LOC Questions',opts:[{s:0,l:'Both'},{s:1,l:'One'},{s:2,l:'Neither'}]},
      {id:'1c',name:'LOC Commands',opts:[{s:0,l:'Both'},{s:1,l:'One'},{s:2,l:'Neither'}]},
      {id:'2',name:'Gaze',opts:[{s:0,l:'Normal'},{s:1,l:'Partial'},{s:2,l:'Forced'}]},
      {id:'3',name:'Visual',opts:[{s:0,l:'Normal'},{s:1,l:'Partial'},{s:2,l:'Complete'},{s:3,l:'Bilateral'}]},
      {id:'4',name:'Facial',opts:[{s:0,l:'Normal'},{s:1,l:'Minor'},{s:2,l:'Partial'},{s:3,l:'Complete'}]},
      {id:'5a',name:'Arm L',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'5b',name:'Arm R',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'6a',name:'Leg L',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'6b',name:'Leg R',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'7',name:'Ataxia',opts:[{s:0,l:'Absent'},{s:1,l:'One'},{s:2,l:'Two'}]},
      {id:'8',name:'Sensory',opts:[{s:0,l:'Normal'},{s:1,l:'Mild'},{s:2,l:'Severe'}]},
      {id:'9',name:'Language',opts:[{s:0,l:'Normal'},{s:1,l:'Mild'},{s:2,l:'Severe'},{s:3,l:'Mute'}]},
      {id:'10',name:'Dysarthria',opts:[{s:0,l:'Normal'},{s:1,l:'Mild'},{s:2,l:'Severe'}]},
      {id:'11',name:'Extinction',opts:[{s:0,l:'Normal'},{s:1,l:'One'},{s:2,l:'Profound'}]}
    ],interpret:function(s){if(s===0)return{t:'No Symptoms',c:'#10b981'};if(s<=4)return{t:'Minor',c:'#6ee7b7'};if(s<=15)return{t:'Moderate',c:'#fbbf24'};if(s<=20)return{t:'Mod-Severe',c:'#f97316'};return{t:'Severe',c:'#ef4444'}}},
    gcs:{name:'GCS',icon:'üëÅ',desc:'Consciousness',max:15,items:[
      {id:'e',name:'Eye',opts:[{s:4,l:'Spontaneous'},{s:3,l:'Voice'},{s:2,l:'Pain'},{s:1,l:'None'}]},
      {id:'v',name:'Verbal',opts:[{s:5,l:'Oriented'},{s:4,l:'Confused'},{s:3,l:'Words'},{s:2,l:'Sounds'},{s:1,l:'None'}]},
      {id:'m',name:'Motor',opts:[{s:6,l:'Obeys'},{s:5,l:'Localizes'},{s:4,l:'Withdraws'},{s:3,l:'Flexion'},{s:2,l:'Extension'},{s:1,l:'None'}]}
    ],interpret:function(s){if(s>=13)return{t:'Mild (13-15)',c:'#10b981'};if(s>=9)return{t:'Moderate (9-12)',c:'#fbbf24'};return{t:'Severe (3-8)',c:'#ef4444'}}},
    sedan:{name:'SEDAN',icon:'ü©∏',desc:'tPA Bleed Risk',max:6,items:[
      {id:'s',name:'Glucose',opts:[{s:0,l:'<145'},{s:1,l:'145-216'},{s:2,l:'>216'}]},
      {id:'e',name:'Early CT',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
      {id:'d',name:'Dense Artery',opts:[{s:0,l:'No'},{s:2,l:'Yes'}]},
      {id:'a',name:'Age ‚â•75',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
      {id:'n',name:'NIHSS ‚â•10',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){var r=['1.4%','2.9%','5.0%','8.5%','12.2%','16.9%','21.5%'],c=['#10b981','#6ee7b7','#84cc16','#fbbf24','#f97316','#ef4444','#dc2626'];return{t:r[Math.min(s,6)]+' sICH',c:c[Math.min(s,6)]}}},
    chads:{name:'CHA‚ÇÇDS‚ÇÇ-VASc',icon:'‚ù§Ô∏è',desc:'AF Stroke Risk',max:9,items:[
      {id:'c',name:'CHF',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'h',name:'HTN',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'a2',name:'Age‚â•75',opts:[{s:0,l:'No'},{s:2,l:'Yes'}]},{id:'d',name:'DM',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'s2',name:'Stroke',opts:[{s:0,l:'No'},{s:2,l:'Yes'}]},{id:'v',name:'Vascular',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'a',name:'Age 65-74',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'sc',name:'Female',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s===0)return{t:'Low 0.2%/yr',c:'#10b981'};if(s===1)return{t:'Low-Mod 0.6%/yr',c:'#6ee7b7'};return{t:'High Risk - Anticoag',c:'#ef4444'}}},
    wells_pe:{name:'Wells PE',icon:'ü´Å',desc:'PE Probability',max:12.5,items:[
      {id:'dv',name:'DVT Signs',opts:[{s:0,l:'No'},{s:3,l:'Yes'}]},{id:'al',name:'PE Likely',opts:[{s:0,l:'No'},{s:3,l:'Yes'}]},{id:'hr',name:'HR>100',opts:[{s:0,l:'No'},{s:1.5,l:'Yes'}]},{id:'im',name:'Immobile',opts:[{s:0,l:'No'},{s:1.5,l:'Yes'}]},{id:'pr',name:'Prior VTE',opts:[{s:0,l:'No'},{s:1.5,l:'Yes'}]},{id:'he',name:'Hemoptysis',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'ca',name:'Cancer',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s<=4)return{t:'PE Unlikely',c:'#10b981'};return{t:'PE Likely - Image',c:'#ef4444'}}},
    curb65:{name:'CURB-65',icon:'ü¶†',desc:'Pneumonia',max:5,items:[
      {id:'c',name:'Confusion',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'u',name:'BUN>19',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'r',name:'RR‚â•30',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'b',name:'BP<90/60',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'65',name:'Age‚â•65',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s<=1)return{t:'Outpatient',c:'#10b981'};if(s===2)return{t:'Admit',c:'#fbbf24'};return{t:'ICU',c:'#ef4444'}}},
    qsofa:{name:'qSOFA',icon:'‚ö°',desc:'Sepsis Screen',max:3,items:[
      {id:'r',name:'RR‚â•22',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'m',name:'Altered',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'s',name:'SBP‚â§100',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s<2)return{t:'Low Risk',c:'#10b981'};return{t:'High Risk - Sepsis Eval',c:'#ef4444'}}}
  };

  var REFS=[
    {title:'tPA Window',content:'<p><b>IV tPA:</b> ‚â§4.5 hours</p><p><b>Thrombectomy:</b> ‚â§24h (DAWN/DEFUSE-3)</p>'},
    {title:'tPA Dosing',content:'<p><b>Dose:</b> 0.9 mg/kg (max 90mg)</p><p><b>Admin:</b> 10% bolus, 90% over 60min</p>'},
    {title:'BP Targets',content:'<p><b>Pre-tPA:</b> <185/110</p><p><b>Post-tPA:</b> <180/105 √ó 24h</p>'},
    {title:'Anticoag Reversal',content:'<p><b>Warfarin:</b> Vit K + 4F-PCC</p><p><b>Dabigatran:</b> Idarucizumab</p><p><b>Xa inhibitors:</b> Andexanet</p>'},
    {title:'GCS Guide',content:'<p>13-15: Mild | 9-12: Moderate | ‚â§8: Severe (intubate)</p>'},
    {title:'Sepsis Bundle',content:'<p><b>Hour-1:</b> Lactate, cultures, abx, fluids 30ml/kg if hypotensive</p>'}
  ];

  // ========== UTILS ==========
  function toast(m,err){var t=$('toast');t.textContent=m;t.className='toast show'+(err?' error':'');setTimeout(function(){t.className='toast'},3000)}
  function initials(n){if(!n)return'?';var p=n.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():n.substring(0,2).toUpperCase()}

  // ========== AUTH ==========
  function login(){
    var n=$('loginName').value.trim();
    if(!n){alert('Enter your name');return}
    state.user={name:n,init:n[0].toUpperCase()};
    try{localStorage.setItem('mw_user',JSON.stringify(state.user))}catch(e){}
    showDashboard();
  }
  function showDashboard(){
    $('userName').textContent=state.user.name;
    $('userAvatar').textContent=state.user.init;
    $('userBtn').classList.add('show');
    $('greeting').textContent='Dr. '+state.user.name;
    $('loginScreen').classList.remove('active');
    $('dashboardScreen').classList.add('active');
    toast('Welcome, Dr. '+state.user.name+'!');
    loadPatients();
  }
  function checkAuth(){
    try{var u=localStorage.getItem('mw_user');if(u){state.user=JSON.parse(u);showDashboard()}}catch(e){}
  }

  // ========== PATIENTS ==========
  function loadPatients(){
    $('patientsContainer').innerHTML='<div class="loading"><div class="spinner"></div>Loading patients...</div>';
    fetch(API.PATIENT,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'getAllData'})})
      .then(function(r){return r.json()})
      .then(function(d){
        console.log('API:',d);
        if(d.success){
          state.patients=d.patients||[];
          state.patientsByWard=d.patientsByWard||{};
          renderPatients();
          updateStats(d);
        }else{$('patientsContainer').innerHTML='<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg></div><div class="empty-title">Error</div><div class="empty-text">'+(d.error||'Unknown')+'</div></div>'}
      })
      .catch(function(e){console.error(e);$('patientsContainer').innerHTML='<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div><div class="empty-title">Connection Failed</div><div class="empty-text">Check your internet</div></div>'});
  }

  function renderPatients(){
    var c=$('patientsContainer');
    if(!state.patients.length){c.innerHTML='<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div class="empty-title">No Patients</div><div class="empty-text">Add your first patient</div></div>';return}
    var h='<div class="patients-grid">';
    state.patients.forEach(function(p){
      var name=p.patientName||p.name||'Unknown';
      var ward=p.ward||'-';
      var room=p.roomBed||'';
      var dx=p.diagnosis||'No diagnosis recorded';
      var doc=p.assignedDoctor||'Unassigned';
      var status=p.section||'active';
      var sc=status==='critical'?'critical':status==='chronic'?'chronic':'';
      var badge=status==='critical'?'badge-critical':status==='chronic'?'badge-chronic':'badge-active';
      var statusLabel=status.charAt(0).toUpperCase()+status.slice(1);
      h+='<div class="patient-card '+sc+'" data-row="'+p.rowIndex+'">';
      h+='<div class="patient-top"><div class="patient-main"><div class="patient-avatar">'+initials(name)+'</div><div class="patient-info"><h3>'+name+'</h3><p>Dr. '+doc+'</p></div></div><span class="patient-badge '+badge+'">'+statusLabel+'</span></div>';
      h+='<div class="patient-details"><div class="patient-detail"><div class="patient-detail-label">Ward</div><div class="patient-detail-value">'+ward+'</div></div><div class="patient-detail"><div class="patient-detail-label">Room/Bed</div><div class="patient-detail-value">'+(room||'-')+'</div></div></div>';
      h+='<div class="patient-diagnosis"><div class="patient-diagnosis-label">Diagnosis</div><div class="patient-diagnosis-text">'+(dx.length>100?dx.substring(0,100)+'...':dx)+'</div></div>';
      h+='<div class="patient-actions"><button class="btn btn-secondary btn-sm" onclick="MedWard.editPatient('+p.rowIndex+')">Edit</button><button class="btn btn-danger btn-sm" onclick="MedWard.discharge('+p.rowIndex+')">Discharge</button></div>';
      h+='</div>';
    });
    h+='</div>';
    c.innerHTML=h;
  }

  function updateStats(d){
    $('statTotal').textContent=d.totalCount||state.patients.length;
    $('statActive').textContent=d.activeCount||0;
    $('statChronic').textContent=d.chronicCount||0;
    $('statWards').textContent=d.wards?d.wards.length:Object.keys(state.patientsByWard).length;
  }

  function openPatientModal(patient){
    state.editing=patient||null;
    $('patientModalTitle').textContent=patient?'Edit Patient':'Add Patient';
    $('patientName').value=patient?patient.patientName||'':'';
    $('patientWard').value=patient?patient.ward||'':'';
    $('patientRoom').value=patient?patient.roomBed||'':'';
    $('patientDiagnosis').value=patient?patient.diagnosis||'':'';
    $('patientDoctor').value=patient?patient.assignedDoctor||'':'';
    $('patientStatus').value=patient?patient.section||'active':'active';
    $('patientRowIndex').value=patient?patient.rowIndex:'';
    $('patientModal').classList.add('active');
  }

  function savePatient(){
    var data={
      patientName:$('patientName').value.trim(),
      ward:$('patientWard').value.trim(),
      roomBed:$('patientRoom').value.trim(),
      diagnosis:$('patientDiagnosis').value.trim(),
      assignedDoctor:$('patientDoctor').value.trim(),
      section:$('patientStatus').value
    };
    if(!data.patientName||!data.ward){toast('Name and Ward required',true);return}
    
    var action=state.editing?'updatePatient':'addPatient';
    var body={action:action,...data};
    if(state.editing){
      body.rowIndex=state.editing.rowIndex;
      body.oldWard=state.editing.ward;
      body.newWard=data.ward;
    }
    
    toast('Saving...');
    fetch(API.PATIENT,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)})
      .then(function(r){return r.json()})
      .then(function(d){
        if(d.success){
          toast(state.editing?'Patient updated':'Patient added');
          $('patientModal').classList.remove('active');
          loadPatients();
        }else{toast('Error: '+(d.error||'Unknown'),true)}
      })
      .catch(function(e){toast('Save failed',true)});
  }

  function editPatient(rowIndex){
    var p=state.patients.find(function(x){return x.rowIndex===rowIndex});
    if(p)openPatientModal(p);
  }

  function discharge(rowIndex){
    var p=state.patients.find(function(x){return x.rowIndex===rowIndex});
    if(!p)return;
    if(!confirm('Discharge '+p.patientName+' from '+p.ward+'?'))return;
    toast('Discharging...');
    fetch(API.PATIENT,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'dischargePatient',rowIndex:rowIndex})})
      .then(function(r){return r.json()})
      .then(function(d){
        if(d.success){toast(p.patientName+' discharged');loadPatients()}
        else{toast('Error: '+(d.error||'Unknown'),true)}
      })
      .catch(function(){toast('Discharge failed',true)});
  }

  // ========== TABS ==========
  function setupTabs(){
    document.querySelectorAll('.tab').forEach(function(t){
      t.addEventListener('click',function(){
        var id=this.dataset.tab;
        document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active')});
        this.classList.add('active');
        document.querySelectorAll('.panel').forEach(function(x){x.classList.remove('active')});
        $('panel'+id.charAt(0).toUpperCase()+id.slice(1)).classList.add('active');
      });
    });
  }

  // ========== SCORES ==========
  function renderScores(){
    var h='';
    for(var k in SCORES){var s=SCORES[k];h+='<div class="score-tile" data-score="'+k+'"><div class="score-icon">'+s.icon+'</div><div class="score-name">'+s.name+'</div><div class="score-desc">'+s.desc+'</div></div>'}
    $('scoresGrid').innerHTML=h;
    $('scoresGrid').querySelectorAll('.score-tile').forEach(function(t){
      t.addEventListener('click',function(){
        $('scoresGrid').querySelectorAll('.score-tile').forEach(function(x){x.classList.remove('active')});
        this.classList.add('active');
        openCalc(this.dataset.score);
      });
    });
  }

  function openCalc(key){
    var s=SCORES[key];state.activeScore=key;state.scores[key]={};
    var h='<div class="card calc-card"><div class="card-header"><h2 class="card-title">'+s.icon+' '+s.name+'</h2><button class="btn btn-secondary btn-sm" onclick="MedWard.resetCalc()">Reset</button></div><div class="card-body">';
    s.items.forEach(function(item){
      h+='<div class="calc-item"><div class="calc-item-head"><span class="calc-item-num">'+item.id.toUpperCase()+'</span><span class="calc-item-name">'+item.name+'</span></div><div class="calc-opts">';
      item.opts.forEach(function(o){h+='<label class="calc-opt" data-item="'+item.id+'" data-score="'+o.s+'"><input type="radio" name="c_'+item.id+'"><span class="calc-opt-score">'+(o.s>=0?'+':'')+o.s+'</span><span class="calc-opt-label">'+o.l+'</span></label>'});
      h+='</div></div>';
    });
    h+='<div class="calc-result"><div class="calc-result-score" id="calcTotal">0</div><div class="calc-result-max">/ '+s.max+'</div><div id="calcInterp"></div></div></div></div>';
    $('calcArea').innerHTML=h;
    $('calcArea').querySelectorAll('.calc-opt').forEach(function(o){
      o.addEventListener('click',function(){
        var id=this.dataset.item,sc=parseFloat(this.dataset.score);
        this.parentElement.querySelectorAll('.calc-opt').forEach(function(x){x.classList.remove('sel')});
        this.classList.add('sel');this.querySelector('input').checked=true;
        state.scores[state.activeScore][id]=sc;
        updateCalc();
      });
    });
  }

  function updateCalc(){
    var k=state.activeScore,s=SCORES[k],t=0;
    for(var x in state.scores[k])t+=state.scores[k][x];
    $('calcTotal').textContent=t;
    var i=s.interpret(t);
    $('calcInterp').innerHTML='<span class="severity-pill" style="background:'+i.c+'20;color:'+i.c+'">'+i.t+'</span>';
  }

  function resetCalc(){if(state.activeScore){state.scores[state.activeScore]={};openCalc(state.activeScore)}}

  // ========== REFERENCE ==========
  function renderRefs(){
    $('refGrid').innerHTML=REFS.map(function(r){return'<div class="ref-card"><h4>'+r.title+'</h4>'+r.content+'</div>'}).join('');
  }

  // ========== UPLOAD ==========
  function setupUpload(){
    var area=$('uploadArea'),inp=$('uploadInput');
    area.addEventListener('click',function(){inp.click()});
    area.addEventListener('dragover',function(e){e.preventDefault();area.classList.add('dragover')});
    area.addEventListener('dragleave',function(){area.classList.remove('dragover')});
    area.addEventListener('drop',function(e){e.preventDefault();area.classList.remove('dragover');if(e.dataTransfer.files.length)handleFile(e.dataTransfer.files[0])});
    inp.addEventListener('change',function(){if(this.files.length)handleFile(this.files[0])});
    document.querySelectorAll('.doc-pill').forEach(function(p){
      p.addEventListener('click',function(){
        document.querySelectorAll('.doc-pill').forEach(function(x){x.classList.remove('active')});
        this.classList.add('active');
        state.docType=this.dataset.type;
      });
    });
  }

  function handleFile(f){
    if(f.type.startsWith('text/')||f.name.endsWith('.txt')){
      var r=new FileReader();
      r.onload=function(e){analyzeDoc(e.target.result)};
      r.readAsText(f);
    }else{toast('Text files only for now',true)}
  }

  function analyzeDoc(text){
    toast('Analyzing...');
    fetch(API.CLAUDE,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'analyze',documentType:state.docType,content:text.substring(0,15000)})})
      .then(function(r){return r.json()})
      .then(function(d){
        if(d.success&&d.analysis){
          showAnalysis(d.analysis);
          toast('Analysis complete');
        }else{toast('Analysis failed',true)}
      })
      .catch(function(){toast('Analysis error',true)});
  }

  function showAnalysis(a){
    var h='';
    if(a.interpretation)h+='<div class="analysis-block"><h4>üìã Interpretation</h4><div class="analysis-content">'+a.interpretation.replace(/\n/g,'<br>')+'</div></div>';
    if(a.findings&&a.findings.length)h+='<div class="analysis-block"><h4>üîç Findings</h4><div class="analysis-content"><ul>'+a.findings.map(function(f){return'<li>'+f+'</li>'}).join('')+'</ul></div></div>';
    if(a.recommendations&&a.recommendations.length)h+='<div class="analysis-block"><h4>üí° Recommendations</h4><div class="analysis-content"><ul>'+a.recommendations.map(function(r){return'<li>'+r+'</li>'}).join('')+'</ul></div></div>';
    $('analysisResults').innerHTML=h||'<p>No analysis data</p>';
    $('analysisModal').classList.add('active');
  }

  // ========== INIT ==========
  function init(){
    $('loginBtn').addEventListener('click',login);
    $('loginBtn').addEventListener('touchend',function(e){e.preventDefault();login()});
    $('loginName').addEventListener('keydown',function(e){if(e.key==='Enter')login()});
    $('refreshBtn').addEventListener('click',loadPatients);
    $('addPatientBtn').addEventListener('click',function(){openPatientModal()});
    $('closePatientModal').addEventListener('click',function(){$('patientModal').classList.remove('active')});
    $('cancelPatient').addEventListener('click',function(){$('patientModal').classList.remove('active')});
    $('savePatient').addEventListener('click',savePatient);
    $('patientModal').addEventListener('click',function(e){if(e.target===this)this.classList.remove('active')});
    $('closeAnalysisModal').addEventListener('click',function(){$('analysisModal').classList.remove('active')});
    $('analysisModal').addEventListener('click',function(e){if(e.target===this)this.classList.remove('active')});
    setupTabs();renderScores();renderRefs();setupUpload();checkAuth();
  }

  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
  window.MedWard={editPatient:editPatient,discharge:discharge,resetCalc:resetCalc};
})();
</script>
</body>
</html>
