<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#030712">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>MedWard Pro v13</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#030712;--bg-card:#0a0f1a;--bg-elevated:#111827;--bg-hover:#1f2937;--text:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--gold:#f59e0b;--gold-light:#fbbf24;--teal:#14b8a6;--purple:#8b5cf6;--rose:#f43f5e;--emerald:#10b981;--blue:#3b82f6;--orange:#f97316;--border:rgba(255,255,255,0.08);--border-light:rgba(255,255,255,0.12);--glass:rgba(10,15,26,0.9);--radius:16px;--radius-sm:10px}
*{margin:0;padding:0;box-sizing:border-box;touch-action:pan-y;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow-x:hidden}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
/* Clickable elements */
button,.btn,.card,.unit-card,.patient-card,.med-card,[onclick]{cursor:pointer;-webkit-user-select:none;user-select:none}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
.mono{font-family:'JetBrains Mono',monospace}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;position:relative;z-index:1}
.btn:active{transform:scale(0.95);opacity:0.9}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:#000}
.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border-light);color:var(--text)}
.btn-secondary:hover{border-color:var(--gold)}
.btn-ghost{background:transparent;color:var(--text-secondary);padding:10px}
.btn-ghost:hover{color:var(--gold)}
.btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}
.btn-success{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--emerald)}
.btn-success:hover{background:rgba(16,185,129,0.25);border-color:var(--emerald)}
.btn-info{background:rgba(56,139,253,0.15);border:1px solid rgba(56,139,253,0.3);color:#58a6ff}
.btn-info:hover{background:rgba(56,139,253,0.25);border-color:#58a6ff}
/* Ward Input Autocomplete */
.ward-input-wrapper{position:relative}
.ward-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--bg-elevated);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);max-height:200px;overflow-y:auto;z-index:10;display:none}
.ward-suggestions.show{display:block}
.ward-suggestion{padding:12px 16px;cursor:pointer;font-size:0.9rem;transition:background 0.2s}
.ward-suggestion:hover{background:var(--bg-hover);color:var(--gold)}
/* Patient Card Discharge */
.patient-card{position:relative;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.patient-card:active{transform:scale(0.98);opacity:0.95}
.patient-card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px}
.patient-discharge-btn{padding:6px 12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:6px;color:var(--emerald);font-size:0.7rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.patient-discharge-btn:hover{background:rgba(16,185,129,0.2);border-color:var(--emerald)}
.patient-discharge-btn.discharged{background:rgba(107,114,128,0.1);border-color:rgba(107,114,128,0.3);color:var(--text-muted);cursor:default}
.patient-card.discharged{border-left-color:var(--text-muted);opacity:0.7}
.patient-card.discharged .patient-avatar{background:linear-gradient(135deg,var(--text-muted),#4b5563)}
/* Lab Override */
.lab-value-card{cursor:pointer;transition:all 0.2s}
.lab-value-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.lab-override-indicator{font-size:0.6rem;color:var(--gold);margin-left:4px}
/* Med Card Drug Info Button */
.med-card-action{touch-action:manipulation;position:relative;z-index:10}
.med-card-action:active{transform:scale(0.9)}
.med-card-action.info{background:rgba(56,139,253,0.1);border-color:rgba(56,139,253,0.3)}
.med-card-action.info:hover,.med-card-action.info:active{background:rgba(56,139,253,0.2);border-color:#58a6ff}
/* Med Card Alerts */
.med-card.has-alerts{border-left:3px solid var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.med-alerts{margin-bottom:12px}
.med-alert{display:flex;align-items:flex-start;gap:8px;padding:10px 12px;border-radius:8px;margin-bottom:6px;font-size:0.8rem}
.med-alert.critical{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3)}
.med-alert.warning{background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3)}
.med-alert-icon{font-size:1rem;flex-shrink:0}
.med-alert-content{display:flex;flex-direction:column;gap:2px}
.med-alert-lab{font-weight:700;color:var(--text)}
.med-alert-message{color:var(--text-secondary);font-size:0.75rem;line-height:1.4}
.med-card-class{font-size:0.7rem;color:var(--teal);font-weight:600;margin-top:2px}
.med-drug-icon{margin-right:4px}
.med-monitor-labs{font-size:0.7rem;color:var(--text-muted);margin-top:8px;padding:6px 10px;background:var(--bg);border-radius:6px}
.med-learn-more{position:relative;overflow:hidden;margin-top:10px;width:100%;text-decoration:none;display:block;text-align:center;z-index:10}
.med-learn-more:active{transform:scale(0.98);opacity:0.9}
.med-learn-more::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transform:translateX(-100%);transition:transform 0.3s}
.med-learn-more:hover::after{transform:translateX(100%)}
/* Medication Search Filter */
.meds-search-bar{display:flex;gap:8px;margin-bottom:12px}
.meds-search-input{flex:1;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem}
.meds-search-input:focus{outline:none;border-color:var(--gold)}
.meds-search-input::placeholder{color:var(--text-muted)}
/* Medication Alert Banner */
.meds-alert-banner{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(135deg,rgba(244,63,94,0.15),rgba(249,115,22,0.1));border:1px solid rgba(244,63,94,0.3);border-radius:var(--radius-sm);margin-bottom:16px;animation:alertPulse 2s ease-in-out infinite}
@keyframes alertPulse{0%,100%{opacity:1}50%{opacity:0.85}}
.meds-alert-icon{font-size:1.5rem}
.meds-alert-text{display:flex;flex-direction:column;gap:2px}
.meds-alert-text strong{color:var(--rose);font-size:0.9rem}
.meds-alert-text span{color:var(--text-secondary);font-size:0.75rem}
.btn-sm{padding:10px 16px;font-size:0.8rem}
.btn-xs{padding:6px 12px;font-size:0.75rem}
.btn-full{width:100%}
.btn-icon{width:44px;height:44px;padding:0;border-radius:var(--radius-sm)}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.9rem;transition:all 0.2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold)}
.form-textarea{min-height:100px;resize:vertical}
.form-input-sm{padding:10px 14px;font-size:0.85rem}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;font-size:0.65rem;font-weight:700;text-transform:uppercase}
.badge-gold{background:rgba(245,158,11,0.15);color:var(--gold)}
.badge-teal{background:rgba(20,184,166,0.15);color:var(--teal)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--purple)}
.badge-rose{background:rgba(244,63,94,0.15);color:var(--rose)}
.badge-emerald{background:rgba(16,185,129,0.15);color:var(--emerald)}
.badge-blue{background:rgba(59,130,246,0.15);color:var(--blue)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:480px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-box.wide{max-width:700px}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:1.1rem;font-weight:700}
.modal-body{padding:24px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px}
.modal-footer .btn{flex:1;touch-action:manipulation;-webkit-user-select:none;user-select:none;position:relative;z-index:10;min-height:50px}
.page{display:none;min-height:100vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.page.active{display:flex;flex-direction:column}
#landing{align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at top,#111827 0%,var(--bg) 50%);touch-action:pan-y}
.landing-logo{width:88px;height:88px;background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:24px;display:grid;place-items:center;margin-bottom:28px;box-shadow:0 20px 40px rgba(245,158,11,0.3)}
.landing-logo svg{width:48px;height:48px;stroke:#000;stroke-width:2.5;fill:none}
.landing-title{font-size:2rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.landing-subtitle{color:var(--text-muted);margin-bottom:8px}
.landing-version{color:var(--teal);font-size:0.75rem;font-weight:600;margin-bottom:48px}
.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;width:100%;max-width:800px;touch-action:pan-y}
.unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--gold));transform:scaleX(0);transition:transform 0.3s}
.unit-card:hover::before{transform:scaleX(1)}
.unit-card:active{transform:scale(0.98);background:var(--bg-hover)}
.unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-4px)}
.unit-card-icon{font-size:2.5rem;margin-bottom:16px}
.unit-card-name{font-size:1.1rem;font-weight:700;margin-bottom:4px}
.unit-card-desc{color:var(--text-muted);font-size:0.85rem}
.unit-card-code-hint{font-size:0.7rem;color:var(--gold);margin-top:8px;opacity:0.8}
.units-prompt{grid-column:1/-1;text-align:center;padding:12px;color:var(--gold);font-size:0.9rem;font-weight:600;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
.fab{position:fixed;width:56px;height:56px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50;transition:all 0.3s}
.fab svg{width:24px;height:24px}
.fab:hover{border-color:var(--gold);color:var(--gold)}
.admin-fab{bottom:24px;right:24px}
.sync-fab{bottom:24px;left:24px}
.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}
@keyframes rotate{to{transform:rotate(360deg)}}
/* Sync Status Indicator */
.sync-status{position:fixed;top:12px;right:12px;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:100px;font-size:0.75rem;font-weight:600;z-index:1000;transition:all 0.3s;opacity:0;transform:translateY(-10px);pointer-events:none}
.sync-status.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-status.syncing{border-color:var(--gold);color:var(--gold)}
.sync-status.synced{border-color:var(--emerald);color:var(--emerald)}
.sync-status.error{border-color:var(--rose);color:var(--rose)}
.sync-status.pending{border-color:var(--orange);color:var(--orange)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.sync-status.syncing .sync-dot{animation:pulse 1s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
/* Lab Extraction Confidence */
.extraction-confidence{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px;font-size:0.8rem}
.confidence-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.confidence-fill{height:100%;border-radius:3px;transition:width 0.5s ease}
.confidence-fill.high{background:var(--emerald)}
.confidence-fill.medium{background:var(--gold)}
.confidence-fill.low{background:var(--rose)}
.confidence-label{font-weight:600;min-width:40px;text-align:right}
/* Lab Extraction Preview */
.extraction-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin:16px 0}
.extraction-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.extraction-preview-title{font-weight:600;font-size:0.9rem}
.extraction-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.extraction-item:last-child{border-bottom:none}
.extraction-name{color:var(--text-secondary)}
.extraction-value{font-family:'JetBrains Mono',monospace;font-weight:600}
.extraction-value.critical{color:var(--rose)}
.extraction-value.high{color:var(--orange)}
.extraction-value.low{color:var(--blue)}
.extraction-value.normal{color:var(--emerald)}
.code-inputs{display:flex;gap:14px;justify-content:center;margin-bottom:20px}
.code-digit{width:56px;height:68px;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:700;text-align:center;color:var(--text);transition:all 0.2s}
.code-digit:focus{outline:none;border-color:var(--gold)}
.code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}
.code-digit.error{border-color:var(--rose);animation:shake 0.3s}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.code-error{color:var(--rose);font-size:0.85rem;text-align:center;display:none;margin-top:12px}
.code-error.show{display:block}
#dashboard{background:var(--bg)}
.dash-header{background:var(--glass);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.dash-logo{display:flex;align-items:center;gap:14px}
.dash-logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:12px;display:grid;place-items:center}
.dash-logo-icon svg{width:24px;height:24px;stroke:#000;fill:none}
.dash-badge{padding:8px 16px;border-radius:100px;font-size:0.8rem;font-weight:600;border:1px solid var(--border)}
.dash-user{display:flex;align-items:center;gap:12px}
.dash-avatar{width:42px;height:42px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:0.9rem}
.dash-content{flex:1;max-width:1000px;margin:0 auto;padding:20px;width:100%}
.date-banner{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;padding:16px 20px;border-radius:var(--radius);margin-bottom:20px;font-weight:700;display:flex;align-items:center;gap:12px}
.tabs-container{background:var(--bg-card);border-radius:var(--radius);padding:6px;margin-bottom:20px;display:flex;gap:4px}
.tab{flex:1;padding:14px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.tab:hover{color:var(--text)}
.tab.active{background:var(--bg-elevated);color:var(--gold)}
.panel{display:none}
.panel.active{display:block}
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 12px;text-align:center;cursor:pointer;transition:all 0.2s}
.stat-card:hover,.stat-card.active{border-color:var(--gold);background:rgba(245,158,11,0.08)}
.stat-value{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px}
.action-buttons .btn-full{grid-column:span 2}
.ward-section{margin-bottom:24px}
.ward-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(135deg,var(--bg-elevated),var(--bg-card));border-radius:var(--radius-sm);margin-bottom:14px;border-left:4px solid var(--gold)}
.ward-title{font-weight:700;font-size:0.95rem;color:var(--gold)}
.ward-count{background:var(--gold);color:#000;padding:4px 14px;border-radius:100px;font-size:0.75rem;font-weight:700}
.patient-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;cursor:pointer;transition:all 0.2s;border-left:4px solid var(--teal)}
.patient-card:hover{border-color:var(--gold);transform:translateX(4px)}
.patient-card.critical{border-left-color:var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.patient-card.chronic{border-left-color:var(--purple)}
.patient-card.new{border-left-color:var(--emerald);background:linear-gradient(135deg,rgba(16,185,129,0.05),transparent)}
.patient-header{display:flex;align-items:center;gap:16px}
.patient-avatar{width:52px;height:52px;border-radius:14px;display:grid;place-items:center;font-weight:700;font-size:0.9rem;color:#000;flex-shrink:0;background:linear-gradient(135deg,var(--gold),var(--orange))}
.patient-card.new .patient-avatar{background:linear-gradient(135deg,var(--emerald),var(--teal))}
.patient-card.chronic .patient-avatar{background:linear-gradient(135deg,var(--purple),#a855f7)}
.patient-card.critical .patient-avatar{background:linear-gradient(135deg,var(--rose),var(--orange))}
.patient-info{flex:1;min-width:0}
.patient-name{font-weight:700;font-size:1rem;margin-bottom:4px}
.patient-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:0.8rem;color:var(--text-secondary)}
.patient-diagnosis{font-size:0.85rem;color:var(--text-secondary);margin-top:12px;padding:12px 14px;background:var(--bg);border-radius:var(--radius-sm)}
#patientProfile{background:var(--bg)}
.profile-header{background:linear-gradient(180deg,var(--bg-elevated) 0%,var(--bg) 100%);padding:20px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.profile-nav{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.back-btn{width:44px;height:44px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);transition:all 0.2s}
.back-btn:hover{border-color:var(--gold);color:var(--gold)}
.profile-title{font-size:1.25rem;font-weight:700;flex:1}
.profile-actions{display:flex;gap:8px}
.profile-patient{display:flex;align-items:center;gap:20px}
.profile-avatar{width:72px;height:72px;border-radius:20px;display:grid;place-items:center;font-size:1.5rem;font-weight:800;color:#000}
.profile-details h2{font-size:1.4rem;font-weight:800;margin-bottom:6px}
.profile-details .meta{display:flex;flex-wrap:wrap;gap:16px;color:var(--text-secondary);font-size:0.85rem}
.profile-tabs{display:flex;gap:6px;padding:12px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;background:linear-gradient(180deg,#0d1117 0%,#0a0f1a 100%);border-bottom:1px solid rgba(255,255,255,0.08);position:sticky;top:0;z-index:10}
.profile-tabs::-webkit-scrollbar{display:none}
.profile-tab{padding:10px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#9ca3af;font-family:inherit;font-size:0.8rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.profile-tab:hover{color:#e6edf3;background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.12)}
.profile-tab.active{color:#fff;background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(249,115,22,0.15));border-color:var(--gold)}
.profile-content{flex:1;padding:20px;overflow-y:auto}
.profile-panel{display:none}
.profile-panel.active{display:block}
.section-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px;overflow:hidden}
.section-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.section-title{font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px}
.section-body{padding:20px}
/* Lab Upload Area */
.lab-upload-area{background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(20,184,166,0.08));border:2px dashed var(--border-light);border-radius:var(--radius);padding:32px 24px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:24px}
.lab-upload-area:hover{border-color:var(--gold);background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(20,184,166,0.12))}
.lab-upload-area.analyzing{pointer-events:none;opacity:0.7}
.lab-upload-icon{font-size:2.5rem;margin-bottom:12px}
.lab-upload-title{font-weight:700;font-size:1rem;margin-bottom:4px}
.lab-upload-subtitle{color:var(--text-muted);font-size:0.85rem}
@keyframes spin{to{transform:rotate(360deg)}}
/* AI Interpretation Card with Feedback */
.ai-interpretation{background:linear-gradient(135deg,rgba(20,184,166,0.08),rgba(59,130,246,0.08));border:1px solid rgba(20,184,166,0.2);border-radius:var(--radius);padding:20px;margin-bottom:24px}
.ai-interpretation-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ai-interpretation-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--teal)}
.ai-badge{background:linear-gradient(135deg,var(--purple),var(--blue));color:#fff;font-size:0.6rem;padding:4px 8px;border-radius:4px;font-weight:700}
.ai-interpretation-text{color:var(--text-secondary);font-size:0.9rem;line-height:1.7;margin-bottom:16px}
.ai-details{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px}
.ai-details-title{font-size:0.75rem;font-weight:600;color:var(--gold);text-transform:uppercase;margin-bottom:12px}
.ai-details-list{list-style:none;padding:0;margin:0}
.ai-details-list li{font-size:0.85rem;color:var(--text-secondary);padding:6px 0;border-bottom:1px solid var(--border)}
.ai-details-list li:last-child{border-bottom:none}
/* Feedback Buttons */
.feedback-section{display:flex;align-items:center;justify-content:space-between;padding-top:16px;border-top:1px solid var(--border)}
.feedback-label{font-size:0.75rem;color:var(--text-muted)}
.feedback-buttons{display:flex;gap:8px}
.feedback-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--bg);cursor:pointer;display:grid;place-items:center;font-size:1.1rem;transition:all 0.2s}
.feedback-btn:hover{transform:scale(1.1)}
.feedback-btn.positive:hover,.feedback-btn.positive.active{background:rgba(16,185,129,0.2);border-color:var(--emerald)}
.feedback-btn.negative:hover,.feedback-btn.negative.active{background:rgba(244,63,94,0.2);border-color:var(--rose)}
.feedback-btn.active{transform:scale(1.1)}
.feedback-sent{font-size:0.75rem;color:var(--emerald);display:none}
.feedback-sent.show{display:block}
/* Critical Alert */
.critical-alert{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;display:flex;align-items:flex-start;gap:12px}
.critical-alert-icon{font-size:1.25rem}
.critical-alert-content{flex:1}
.critical-alert-title{font-weight:700;color:var(--rose);margin-bottom:4px}
.critical-alert-values{font-size:0.85rem;color:var(--text-secondary)}
/* Lab Categories */
.lab-category{background:var(--bg);border-radius:var(--radius-sm);margin-bottom:16px;overflow:hidden}
.lab-category-header{padding:12px 16px;background:rgba(245,158,11,0.08);font-weight:600;font-size:0.8rem;color:var(--gold);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px}
.lab-category-body{padding:16px}
.lab-values-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.lab-value-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;transition:all 0.2s}
.lab-value-card.high{border-left:3px solid var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.lab-value-card.low{border-left:3px solid var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.05),transparent)}
.lab-value-card.critical{border-left:3px solid var(--rose);background:rgba(244,63,94,0.1)}
.lab-value-card.normal{border-left:3px solid var(--emerald)}
.lab-value-name{font-size:0.75rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.lab-value-status{font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:4px}
.lab-value-status.high,.lab-value-status.critical{background:var(--rose);color:#fff}
.lab-value-status.low{background:var(--blue);color:#fff}
.lab-value-number{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:600;margin-bottom:4px}
.lab-value-card.high .lab-value-number{color:var(--rose)}
.lab-value-card.low .lab-value-number{color:var(--blue)}
.lab-value-card.normal .lab-value-number{color:var(--emerald)}
.lab-value-unit{font-size:0.7rem;color:var(--text-muted)}
.lab-value-range{font-size:0.65rem;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
/* Trend Section */
.lab-trend-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
.lab-trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.lab-trend-select{padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.85rem;min-width:180px}
.lab-trend-chart{background:var(--bg);border-radius:var(--radius-sm);padding:20px;height:220px}
/* Other sections */
.vitals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px}
.vital-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.vital-icon{font-size:1.5rem;margin-bottom:8px}
.vital-value{font-size:1.25rem;font-weight:700}
.vital-label{font-size:0.7rem;color:var(--text-muted);margin-top:4px}
.fluid-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.fluid-stat{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.fluid-stat-value{font-size:1.5rem;font-weight:800}
.fluid-stat-value.intake{color:var(--blue)}
.fluid-stat-value.output{color:var(--orange)}
.fluid-stat-value.balance{color:var(--emerald)}
.fluid-stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.fluid-chart-container{height:200px;margin-top:20px}
.plan-item{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;border-left:3px solid var(--gold)}
.plan-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.plan-item-date{font-size:0.7rem;color:var(--text-muted)}
.plan-item-content{font-size:0.9rem;white-space:pre-wrap}
.imaging-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px}
.imaging-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.imaging-type{font-weight:600;display:flex;align-items:center;gap:8px}
.imaging-date{font-size:0.75rem;color:var(--text-muted)}
.imaging-summary{font-size:0.85rem;color:var(--text-secondary)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:16px 28px;border-radius:var(--radius);font-size:0.9rem;opacity:0;transition:all 0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
.empty-state{text-align:center;padding:60px 24px;color:var(--text-muted)}
.empty-state-icon{font-size:3.5rem;margin-bottom:16px;opacity:0.4}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 24px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover{border-color:var(--gold);background:rgba(245,158,11,0.05)}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ref-card{background:var(--bg);border-radius:var(--radius-sm);padding:18px;border-left:3px solid var(--gold)}
.ref-card h4{font-size:0.9rem;margin-bottom:10px}
.ref-card p{font-size:0.8rem;color:var(--text-secondary)}
.import-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--teal)}
.import-ward-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--gold);border-radius:8px;color:var(--gold);font-size:0.75rem;font-weight:600}
#adminPanel{background:var(--bg)}
.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.admin-content{max-width:700px;margin:0 auto;padding:24px}
.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;overflow:hidden}
.units-table{width:100%;border-collapse:collapse}
.units-table th,.units-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border)}
.units-table th{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase}
@media(max-width:640px){
.stats-grid{grid-template-columns:repeat(3,1fr)}
.action-buttons{grid-template-columns:1fr}
.action-buttons .btn-full{grid-column:span 1}
.profile-patient{flex-direction:column;text-align:center}
.profile-details .meta{justify-content:center}
.lab-values-grid{grid-template-columns:repeat(2,1fr)}
}
/* Unit Request Styles */
.request-unit-btn{margin-top:32px;padding:16px 32px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius);color:var(--text-muted);font-size:0.9rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:10px}
.request-unit-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(245,158,11,0.05)}
.request-form{display:flex;flex-direction:column;gap:20px}
.request-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:500px){.request-form-row{grid-template-columns:1fr}}
.request-form .form-input,.request-form .form-textarea,.request-form .form-select{background:var(--bg);border:1px solid var(--border)}
.request-form .form-input:focus,.request-form .form-textarea:focus,.request-form .form-select:focus{border-color:var(--gold)}
.request-icon-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.request-icon-option{width:100%;aspect-ratio:1;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:grid;place-items:center}
.request-icon-option:hover{border-color:var(--text-muted)}
.request-icon-option.selected{border-color:var(--gold);background:rgba(245,158,11,0.1)}
.request-success{text-align:center;padding:40px 20px}
.request-success-icon{font-size:4rem;margin-bottom:20px}
.request-success-title{font-size:1.25rem;font-weight:700;margin-bottom:8px}
.request-success-text{color:var(--text-muted);font-size:0.9rem;margin-bottom:24px}
.request-success-id{background:var(--bg);padding:12px 20px;border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:0.9rem;display:inline-block}
/* Admin Requests */
.requests-list{display:flex;flex-direction:column;gap:12px}
.request-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;border-left:4px solid var(--gold)}
.request-card.approved{border-left-color:var(--emerald);opacity:0.7}
.request-card.rejected{border-left-color:var(--rose);opacity:0.7}
.request-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.request-card-title{font-weight:700;font-size:1rem}
.request-card-status{padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:700;text-transform:uppercase}
.request-card-status.pending{background:rgba(245,158,11,0.15);color:var(--gold)}
.request-card-status.approved{background:rgba(16,185,129,0.15);color:var(--emerald)}
.request-card-status.rejected{background:rgba(244,63,94,0.15);color:var(--rose)}
.request-card-details{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}
.request-card-detail{display:flex;align-items:center;gap:6px}
.request-card-message{background:var(--bg-card);padding:12px;border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}
.request-card-actions{display:flex;gap:8px}
.request-card-time{font-size:0.75rem;color:var(--text-muted);position:absolute;top:16px;right:16px}
.admin-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg);padding:4px;border-radius:var(--radius-sm)}
.admin-tab{flex:1;padding:12px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.admin-tab:hover{color:var(--text)}
.admin-tab.active{background:var(--bg-elevated);color:var(--gold)}
.admin-tab-panel{display:none}
.admin-tab-panel.active{display:block}
.badge-count{background:var(--rose);color:#fff;padding:2px 8px;border-radius:100px;font-size:0.7rem;margin-left:8px}
.approve-form{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-top:12px;display:none}
.approve-form.show{display:block}
.approve-form-row{display:flex;gap:12px;margin-bottom:12px}
.approve-form-row .form-input{flex:1}

/* ═══════════════════════════════════════════════════════════════════
   CLINICAL SCORING SYSTEM - PROFESSIONAL MEDICAL UI
   ═══════════════════════════════════════════════════════════════════ */

/* Modal - Full screen mobile, centered desktop */
#scoreCalcModal{padding:0;align-items:stretch}
#scoreCalcModal .modal-box{
  max-width:100%;width:100%;height:100%;max-height:100%;
  border-radius:0;margin:0;background:#0a0e17;
  display:flex;flex-direction:column;border:none
}
@media(min-width:600px){
  #scoreCalcModal{padding:20px;align-items:center}
  #scoreCalcModal .modal-box{
    max-width:420px;width:100%;height:auto;max-height:85vh;
    border-radius:12px;border:1px solid rgba(255,255,255,0.06)
  }
}

/* Calculator Layout */
.score-calculator{
  display:flex;flex-direction:column;height:100%;
  background:#0a0e17;overflow:hidden
}

/* Header */
.score-calc-header{
  padding:16px;background:#0d1117;
  border-bottom:1px solid rgba(255,255,255,0.05);flex-shrink:0
}
.score-calc-header-top{
  display:flex;justify-content:space-between;align-items:flex-start;gap:12px
}
.score-calc-close{
  width:28px;height:28px;border-radius:6px;border:none;
  background:rgba(255,255,255,0.05);color:#8b949e;
  font-size:14px;cursor:pointer;display:grid;place-items:center;flex-shrink:0
}
.score-calc-close:active{background:rgba(255,255,255,0.1)}
.score-calc-title{font-size:1.1rem;font-weight:600;color:#e6edf3;margin-bottom:2px}
.score-calc-purpose{font-size:0.8rem;color:#8b949e}
.score-calc-category{
  display:inline-block;margin-top:10px;padding:4px 8px;
  background:rgba(56,139,253,0.1);color:#58a6ff;
  font-size:0.65rem;font-weight:600;border-radius:4px;
  text-transform:uppercase;letter-spacing:0.5px
}

/* Body */
.score-calc-body{
  flex:1;overflow-y:auto;padding:12px;
  -webkit-overflow-scrolling:touch
}
.score-calc-fields{display:flex;flex-direction:column;gap:8px}

/* Auto-calc Banner */
.score-auto-calc{
  background:linear-gradient(135deg,rgba(46,160,67,0.08),rgba(46,160,67,0.02));
  border:1px solid rgba(46,160,67,0.2);border-radius:8px;
  padding:12px;margin-bottom:12px
}
.score-auto-calc-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:8px
}
.score-auto-calc-title{
  font-size:0.7rem;font-weight:600;color:#3fb950;
  text-transform:uppercase;letter-spacing:0.5px;
  display:flex;align-items:center;gap:6px
}
.score-auto-calc-badge{
  background:#238636;color:#fff;font-size:0.6rem;
  padding:2px 5px;border-radius:3px;font-weight:600
}
.score-auto-calc-value{
  font-family:'JetBrains Mono',monospace;font-size:1.8rem;
  font-weight:700;color:#e6edf3;text-align:center;padding:4px 0
}
.score-auto-calc-source{font-size:0.72rem;color:#8b949e;text-align:center}
.score-manual-toggle{
  font-size:0.7rem;color:#8b949e;background:none;border:none;
  text-decoration:underline;cursor:pointer
}

/* Checkbox Field */
.score-field{
  display:flex;align-items:center;gap:10px;padding:10px 12px;
  background:#161b22;border:1px solid rgba(255,255,255,0.04);
  border-radius:8px;cursor:pointer;min-height:44px
}
.score-field:active{background:#1c2128}
.score-field.checked{
  background:rgba(46,160,67,0.08);
  border-color:rgba(46,160,67,0.3)
}
.score-field-checkbox{
  width:18px;height:18px;min-width:18px;border-radius:4px;
  border:1.5px solid #30363d;display:grid;place-items:center;
  background:transparent;transition:all 0.15s
}
.score-field.checked .score-field-checkbox{
  background:#238636;border-color:#238636
}
.score-field.checked .score-field-checkbox::after{
  content:'✓';color:#fff;font-size:11px;font-weight:700
}
.score-field-label{flex:1;font-size:0.82rem;color:#c9d1d9;line-height:1.3}
.score-field-points{
  font-family:'JetBrains Mono',monospace;font-size:0.7rem;
  color:#8b949e;padding:2px 6px;background:rgba(255,255,255,0.04);
  border-radius:4px
}
.score-field.checked .score-field-points{color:#3fb950;background:rgba(46,160,67,0.1)}

/* Select Field */
.score-field-select{width:100%}
.score-field-select label{
  display:block;font-size:0.72rem;font-weight:500;
  color:#8b949e;margin-bottom:6px
}
.score-field-select select{
  width:100%;padding:10px 32px 10px 10px;
  background:#161b22;border:1px solid #30363d;
  border-radius:6px;color:#c9d1d9;font-size:0.82rem;
  appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center
}
.score-field-select select:focus{outline:none;border-color:#388bfd}

/* Number Field */
.score-field-number{display:flex;align-items:center;gap:10px;width:100%}
.score-field-number label{flex:1;font-size:0.82rem;color:#c9d1d9}
.score-field-number input{
  width:80px;padding:8px 10px;background:#161b22;
  border:1px solid #30363d;border-radius:6px;color:#c9d1d9;
  font-size:0.85rem;font-family:'JetBrains Mono',monospace;text-align:center
}
.score-field-number input:focus{outline:none;border-color:#388bfd}

/* Result */
.score-calc-result{
  padding:14px 16px;background:#0d1117;
  border-top:1px solid rgba(255,255,255,0.05);flex-shrink:0
}
.score-result-display{
  display:flex;align-items:baseline;justify-content:center;gap:6px;margin-bottom:10px
}
.score-result-value{
  font-family:'JetBrains Mono',monospace;font-size:2.5rem;
  font-weight:700;color:#e6edf3
}
.score-result-max{font-size:0.8rem;color:#484f58}
.score-result-interpretation{padding:10px 12px;border-radius:6px}
.score-result-risk{font-size:0.9rem;font-weight:600;margin-bottom:2px}
.score-result-action{font-size:0.78rem;color:rgba(255,255,255,0.8);line-height:1.35}
.score-result-stats{
  display:flex;justify-content:center;gap:16px;
  margin-top:10px;padding-top:10px;
  border-top:1px solid rgba(255,255,255,0.08)
}
.score-result-stat{text-align:center}
.score-result-stat-value{font-family:'JetBrains Mono',monospace;font-size:0.9rem;font-weight:600}
.score-result-stat-label{font-size:0.6rem;color:#8b949e;text-transform:uppercase;margin-top:1px}

/* Footer */
#scoreCalcModal .modal-footer{
  background:#0d1117;border-top:1px solid rgba(255,255,255,0.05);
  padding:12px 16px;flex-shrink:0;display:flex;gap:8px
}
#scoreCalcModal .modal-footer .btn{flex:1;padding:10px}

/* ═══ DASHBOARD SCORES TAB ═══ */
.scores-search-wrapper{position:relative;margin-bottom:14px}
.scores-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#484f58}
.scores-search-input{
  width:100%;padding:10px 14px 10px 38px;
  background:#161b22;border:1px solid #30363d;
  border-radius:6px;color:#c9d1d9;font-size:0.85rem
}
.scores-search-input:focus{outline:none;border-color:#388bfd}
.scores-search-input::placeholder{color:#484f58}

/* Quick Scores */
.quick-score-ref{
  background:#161b22;border:1px solid rgba(255,255,255,0.04);
  border-radius:8px;padding:12px;margin-bottom:14px
}
.quick-score-ref-title{
  font-size:0.65rem;font-weight:600;color:#8b949e;
  margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px
}
.quick-score-ref-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.quick-score-ref-item{
  padding:10px 6px;background:#0d1117;border:1px solid rgba(255,255,255,0.04);
  border-radius:6px;text-align:center;cursor:pointer
}
.quick-score-ref-item:active{background:#1c2128}
.quick-score-ref-item-name{font-size:0.8rem;font-weight:600;color:#e6edf3}
.quick-score-ref-item-hint{font-size:0.65rem;color:#8b949e;margin-top:2px}

/* Score Groups */
.emergency-scores-grid{display:flex;flex-direction:column;gap:10px}
.emergency-score-group{
  background:#161b22;border:1px solid rgba(255,255,255,0.04);
  border-radius:8px;overflow:hidden
}
.emergency-score-group-header{
  padding:10px 12px;background:#0d1117;
  border-bottom:1px solid rgba(255,255,255,0.04);
  display:flex;align-items:center;gap:8px
}
.emergency-score-group-icon{font-size:1rem}
.emergency-score-group-title{font-size:0.85rem;font-weight:600;color:#e6edf3}
.emergency-score-group-body{padding:4px}
.emergency-score-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px;border-radius:6px;cursor:pointer;gap:8px
}
.emergency-score-item:active{background:rgba(255,255,255,0.03)}
.emergency-score-item-info{flex:1;min-width:0}
.emergency-score-item-name{font-size:0.82rem;font-weight:500;color:#c9d1d9}
.emergency-score-item-purpose{font-size:0.7rem;color:#8b949e;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.emergency-score-item-btn{
  padding:6px 10px;background:#21262d;border:1px solid #30363d;
  border-radius:5px;color:#c9d1d9;font-size:0.7rem;font-weight:500;cursor:pointer
}
.emergency-score-item-btn:active{background:#388bfd;color:#fff;border-color:transparent}

/* ═══ PATIENT PROFILE SCORES ═══ */
.patient-scores-section{margin-bottom:16px}
.patient-scores-header{margin-bottom:8px}
.patient-scores-title{font-size:0.68rem;font-weight:600;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px}
.patient-scores-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.patient-score-chip{
  padding:12px 10px;background:#161b22;
  border:1px solid rgba(255,255,255,0.04);border-radius:8px;
  cursor:pointer;text-align:center
}
.patient-score-chip:active{background:#1c2128}
.patient-score-chip.has-value{
  border-color:rgba(46,160,67,0.3);background:rgba(46,160,67,0.06)
}
.patient-score-chip .score-chip-icon{font-size:1.2rem;display:block;margin-bottom:4px}
.patient-score-chip .score-chip-name{font-size:0.75rem;font-weight:500;color:#c9d1d9}
.patient-score-chip .score-chip-value{
  display:none;font-family:'JetBrains Mono',monospace;
  font-size:0.95rem;font-weight:700;margin-top:4px
}
.patient-score-chip.has-value .score-chip-value{display:block}
.patient-score-chip .score-chip-value.low{color:#3fb950}
.patient-score-chip .score-chip-value.moderate{color:#d29922}
.patient-score-chip .score-chip-value.high{color:#f85149}

/* ═══ CLINICAL HISTORY & NOTES ═══ */
.history-upload-area{
  padding:20px;background:#161b22;border:2px dashed #30363d;
  border-radius:10px;text-align:center;cursor:pointer;
  margin-bottom:16px;transition:all 0.15s
}
.history-upload-area:active{background:#1c2128;border-color:#388bfd}
.clinical-notes-list{display:flex;flex-direction:column;gap:12px}
.clinical-note-card{
  background:#161b22;border:1px solid rgba(255,255,255,0.06);
  border-radius:10px;overflow:hidden
}
.clinical-note-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;background:#0d1117;
  border-bottom:1px solid rgba(255,255,255,0.04)
}
.clinical-note-type{font-size:0.8rem;font-weight:600;color:#e6edf3}
.clinical-note-date{font-size:0.7rem;color:#8b949e}
.clinical-note-image{
  width:100%;max-height:200px;object-fit:cover;cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,0.04)
}
.clinical-note-ai{
  padding:10px 12px;background:rgba(46,160,67,0.06);
  border-bottom:1px solid rgba(255,255,255,0.04)
}
.clinical-note-ai-badge{
  font-size:0.65rem;font-weight:600;color:#3fb950;
  margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px
}
.clinical-note-ai-text{font-size:0.82rem;color:#c9d1d9;line-height:1.4}
.clinical-note-text{padding:12px;font-size:0.85rem;color:#c9d1d9;line-height:1.5;white-space:pre-wrap}
.clinical-note-author{padding:0 12px 10px;font-size:0.72rem;color:#8b949e;font-style:italic}
.btn-icon-sm{
  background:transparent;border:none;padding:4px;
  font-size:0.85rem;cursor:pointer;opacity:0.6;transition:opacity 0.15s
}
.btn-icon-sm:hover{opacity:1}
.btn-danger{background:#da3633!important;border-color:#da3633!important;color:#fff!important}
.btn-danger:hover{background:#f85149!important}

/* ═══════════════════════════════════════════════════════════════════
   MEDICATIONS - PRISTINE PHARMACEUTICAL DESIGN
   ═══════════════════════════════════════════════════════════════════ */

.meds-container{padding:0}

/* Upload Card */
.meds-upload-card{
  background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;margin-bottom:16px;overflow:hidden
}
.meds-upload-header{
  padding:16px;background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(59,130,246,0.08));
  border-bottom:1px solid rgba(255,255,255,0.04)
}
.meds-upload-title{
  font-size:0.9rem;font-weight:600;color:#e6edf3;
  display:flex;align-items:center;gap:8px
}
.meds-upload-subtitle{font-size:0.75rem;color:#8b949e;margin-top:4px}
.meds-upload-body{padding:16px}
.meds-upload-zone{
  border:2px dashed rgba(139,92,246,0.3);border-radius:10px;
  padding:28px 20px;text-align:center;cursor:pointer;
  transition:all 0.2s;background:rgba(139,92,246,0.02)
}
.meds-upload-zone:active{
  background:rgba(139,92,246,0.08);border-color:rgba(139,92,246,0.5)
}
.meds-upload-zone.analyzing{
  border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.05);
  pointer-events:none
}
.meds-upload-icon{font-size:2rem;margin-bottom:8px}
.meds-upload-text{font-size:0.85rem;font-weight:500;color:#c9d1d9}
.meds-upload-hint{font-size:0.72rem;color:#8b949e;margin-top:4px}

/* Medications List Header */
.meds-list-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:12px;padding:0 4px
}
.meds-list-title{
  font-size:0.7rem;font-weight:600;color:#8b949e;
  text-transform:uppercase;letter-spacing:0.5px
}
.meds-count{
  font-size:0.7rem;font-weight:600;color:#8b5cf6;
  background:rgba(139,92,246,0.1);padding:3px 8px;border-radius:10px
}

/* Medication Card - Premium Design */
.med-card{
  background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;margin-bottom:10px;overflow:hidden;
  transition:all 0.15s
}
.med-card:active{border-color:rgba(139,92,246,0.3)}
.med-card-header{
  display:flex;align-items:flex-start;justify-content:space-between;
  padding:14px 16px;gap:12px
}
.med-card-main{flex:1;min-width:0}
.med-card-name{
  font-size:0.95rem;font-weight:600;color:#e6edf3;
  margin-bottom:2px;display:flex;align-items:center;gap:6px
}
.med-card-generic{font-size:0.75rem;color:#8b949e;font-style:italic}
.med-card-actions{display:flex;gap:4px}
.med-card-action{
  width:28px;height:28px;border-radius:6px;border:none;
  background:rgba(255,255,255,0.04);color:#8b949e;
  font-size:0.8rem;cursor:pointer;display:grid;place-items:center
}
.med-card-action:active{background:rgba(255,255,255,0.1)}
.med-card-action.delete:active{background:rgba(248,81,73,0.2);color:#f85149}

/* Dose & Schedule */
.med-card-dose{
  display:flex;flex-wrap:wrap;gap:8px;padding:0 16px 12px;
  border-bottom:1px solid rgba(255,255,255,0.04)
}
.med-dose-pill{
  display:inline-flex;align-items:center;gap:5px;
  padding:5px 10px;background:rgba(139,92,246,0.1);
  border-radius:6px;font-size:0.78rem;color:#a78bfa
}
.med-dose-pill.route{background:rgba(59,130,246,0.1);color:#60a5fa}
.med-dose-pill.frequency{background:rgba(16,185,129,0.1);color:#34d399}

/* Indication */
.med-card-indication{
  padding:12px 16px;background:rgba(255,255,255,0.01)
}
.med-indication-label{
  font-size:0.65rem;font-weight:600;color:#8b949e;
  text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px
}
.med-indication-text{font-size:0.82rem;color:#c9d1d9;line-height:1.4}

/* Status Badge */
.med-status{
  font-size:0.6rem;font-weight:700;padding:2px 6px;
  border-radius:4px;text-transform:uppercase;letter-spacing:0.3px
}
.med-status.active{background:rgba(46,160,67,0.15);color:#3fb950}
.med-status.prn{background:rgba(251,191,36,0.15);color:#f59e0b}
.med-status.discontinued{background:rgba(248,81,73,0.15);color:#f85149}
.med-status.new{background:rgba(139,92,246,0.15);color:#a78bfa}

/* Add Medication Form */
.med-add-form{
  background:#161b22;border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:16px;margin-bottom:16px
}
.med-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.med-form-full{grid-column:1/-1}
.med-form-group{display:flex;flex-direction:column;gap:4px}
.med-form-label{font-size:0.7rem;font-weight:500;color:#8b949e}
.med-form-input{
  padding:10px 12px;background:#0d1117;border:1px solid #30363d;
  border-radius:6px;color:#e6edf3;font-size:0.85rem;font-family:inherit
}
.med-form-input:focus{outline:none;border-color:#8b5cf6}
.med-form-input::placeholder{color:#484f58}
.med-form-select{
  padding:10px 12px;background:#0d1117;border:1px solid #30363d;
  border-radius:6px;color:#e6edf3;font-size:0.85rem;
  appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center
}
.med-form-actions{
  display:flex;gap:8px;margin-top:12px;padding-top:12px;
  border-top:1px solid rgba(255,255,255,0.04)
}

/* Empty State */
.meds-empty{
  text-align:center;padding:40px 20px;color:#8b949e
}
.meds-empty-icon{font-size:2.5rem;margin-bottom:12px;opacity:0.5}
.meds-empty-title{font-size:0.95rem;font-weight:500;color:#c9d1d9;margin-bottom:4px}
.meds-empty-hint{font-size:0.8rem}

/* Quick Actions */
.meds-quick-actions{
  display:flex;gap:8px;margin-bottom:16px
}
.meds-quick-btn{
  flex:1;padding:10px;background:#161b22;
  border:1px solid rgba(255,255,255,0.06);border-radius:8px;
  color:#c9d1d9;font-size:0.8rem;font-weight:500;
  cursor:pointer;text-align:center;transition:all 0.15s
}
.meds-quick-btn:active{background:#1c2128;border-color:rgba(139,92,246,0.3)}
</style>
</head>
<body>
<!-- LANDING PAGE -->
<div class="page active" id="landing">

<!-- Sync Status Indicator -->
<div class="sync-status" id="syncStatus">
  <div class="sync-dot"></div>
  <span id="syncStatusText">Synced</span>
</div>
<div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
<h1 class="landing-title">MedWard Pro</h1>
<p class="landing-subtitle">Neural Clinical Management System</p>
<p class="landing-version">🧠 AI-Powered • Drug Reference • Lab Override • Discharge • v13.0</p>
<div class="units-grid" id="unitsGrid"></div>
<button class="request-unit-btn" onclick="openRequestUnit()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 5v14M5 12h14"/></svg>
Request New Unit Access
</button>
<div class="fab sync-fab" id="syncFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4-3-9s1.34-9 3-9"/></svg></div>
<div class="fab admin-fab" id="adminFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
</div>

<!-- DASHBOARD -->
<div class="page" id="dashboard">
<header class="dash-header">
<div class="dash-logo">
<div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
<span class="dash-badge" id="unitBadge">Unit</span>
</div>
<div class="dash-user">
<div class="dash-avatar" id="dashAvatar">DR</div>
<button class="btn btn-ghost btn-icon" onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
</div>
</header>
<div class="dash-content">
<div class="date-banner">📅 <span id="currentDate"></span></div>
<div class="tabs-container" id="mainTabs">
<button class="tab active" data-tab="patients">👥 Patients</button>
<button class="tab" data-tab="scores">📊 Scores</button>
<button class="tab" data-tab="reference">📚 Reference</button>
</div>
<div class="panel active" id="panelPatients">
<div class="stats-grid" id="statsBar">
<div class="stat-card active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
<div class="stat-card" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div>
<div class="stat-card" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
<div class="stat-card" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
<div class="stat-card" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
</div>
<div class="action-buttons">
<button class="btn btn-primary btn-sm" onclick="openAddPatient()">➕ Add Patient</button>
<button class="btn btn-secondary btn-sm" onclick="openImport()">📥 Import List</button>
<button class="btn btn-secondary btn-sm btn-full" onclick="exportPDF()">📄 Export PDF</button>
</div>
<div id="patientsList"></div>
</div>
<div class="panel" id="panelScores">
<div class="section-card">
<div class="section-header"><div class="section-title">📊 Clinical Scoring Calculators</div></div>
<div class="section-body">
<div class="scores-search-wrapper">
  <svg class="scores-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
  <input type="text" class="scores-search-input" id="scoresSearchInput" placeholder="Search scores (e.g., CURB-65, Wells, HEART)..." oninput="filterScores(this.value)">
</div>
<div class="quick-score-ref">
  <div class="quick-score-ref-title">🚨 Common Emergency Scores</div>
  <div class="quick-score-ref-grid">
    <div class="quick-score-ref-item" onclick="openScoreCalculator('qSOFA')">
      <span class="quick-score-ref-item-name">qSOFA</span>
      <span class="quick-score-ref-item-hint">Sepsis screening</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('Glasgow-Coma')">
      <span class="quick-score-ref-item-name">GCS</span>
      <span class="quick-score-ref-item-hint">Consciousness</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('HEART')">
      <span class="quick-score-ref-item-name">HEART</span>
      <span class="quick-score-ref-item-hint">Chest pain</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('Wells-PE')">
      <span class="quick-score-ref-item-name">Wells PE</span>
      <span class="quick-score-ref-item-hint">PE probability</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('CURB-65')">
      <span class="quick-score-ref-item-name">CURB-65</span>
      <span class="quick-score-ref-item-hint">Pneumonia</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('NEWS2')">
      <span class="quick-score-ref-item-name">NEWS2</span>
      <span class="quick-score-ref-item-hint">Early warning</span>
    </div>
  </div>
</div>
<div id="scoresGrid" class="emergency-scores-grid"></div>
</div>
</div>
</div>
<div class="panel" id="panelReference">
<div class="section-card">
<div class="section-header"><div class="section-title">📚 Clinical Reference</div></div>
<div class="section-body"><div class="ref-grid" id="refGrid"></div></div>
</div>
</div>
</div>
</div>

<!-- PATIENT PROFILE -->
<div class="page" id="patientProfile">
<div class="profile-header">
<div class="profile-nav">
<div class="back-btn" onclick="closePatientProfile()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
<div class="profile-title">Patient Profile</div>
<div class="profile-actions">
<button class="btn btn-success btn-sm" onclick="openDischargeModal(state.currentPatient?.id)" id="profileDischargeBtn">🏠 Discharge</button>
<button class="btn btn-secondary btn-sm" onclick="editCurrentPatient()">✏️</button>
<button class="btn btn-danger btn-sm" onclick="deleteCurrentPatient()">🗑️</button>
</div>
</div>
<div class="profile-patient" id="profilePatientInfo"></div>
</div>
<div class="profile-tabs" id="profileTabs">
<button class="profile-tab active" data-ptab="overview">📋 Overview</button>
<button class="profile-tab" data-ptab="meds">💊 Meds</button>
<button class="profile-tab" data-ptab="history">📜 History</button>
<button class="profile-tab" data-ptab="scores">📊 Scores</button>
<button class="profile-tab" data-ptab="labs">🧪 Labs</button>
<button class="profile-tab" data-ptab="imaging">🩻 Imaging</button>
<button class="profile-tab" data-ptab="fluids">💧 Fluids</button>
<button class="profile-tab" data-ptab="plans">📝 Plans</button>
</div>
<div class="profile-content">
<div class="profile-panel active" id="profileOverview"></div>
<div class="profile-panel" id="profileMeds"></div>
<div class="profile-panel" id="profileHistory"></div>
<div class="profile-panel" id="profileScores"></div>
<div class="profile-panel" id="profileLabs"></div>
<div class="profile-panel" id="profileImaging"></div>
<div class="profile-panel" id="profileFluids"></div>
<div class="profile-panel" id="profilePlans"></div>
</div>
</div>

<!-- ADMIN -->
<div class="page" id="adminPanel">
<header class="admin-header">
<div style="display:flex;align-items:center;gap:12px">
<div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
<span style="font-weight:700">Admin Dashboard</span>
</div>
<button class="btn btn-secondary btn-sm" onclick="exitAdmin()">← Exit</button>
</header>
<div class="admin-content">
<div class="admin-tabs" id="adminTabs">
<button class="admin-tab active" data-atab="units">🏥 Units</button>
<button class="admin-tab" data-atab="requests">📩 Requests <span class="badge-count" id="requestsCount" style="display:none">0</span></button>
<button class="admin-tab" data-atab="settings">⚙️ Settings</button>
</div>

<div class="admin-tab-panel active" id="adminUnits">
<div class="admin-section">
<div class="section-header"><div class="section-title">🏥 Manage Units</div><button class="btn btn-primary btn-sm" onclick="addUnit()">+ Add Unit</button></div>
<table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead><tbody id="unitsTable"></tbody></table>
</div>
</div>

<div class="admin-tab-panel" id="adminRequests">
<div class="admin-section">
<div class="section-header"><div class="section-title">📩 Unit Access Requests</div><button class="btn btn-secondary btn-sm" onclick="refreshRequests()">🔄 Refresh</button></div>
<div class="section-body">
<div class="requests-list" id="requestsList">
<div style="text-align:center;padding:40px;color:var(--text-muted)">
<div style="font-size:2rem;margin-bottom:12px">📭</div>
<div>No pending requests</div>
</div>
</div>
</div>
</div>
</div>

<div class="admin-tab-panel" id="adminSettings">
<div class="admin-section">
<div class="section-header"><div class="section-title">⚙️ System Settings</div></div>
<div class="section-body">
<div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="Enter new password"></div>
<div class="form-group">
<label class="form-label">API Endpoint <span style="color:var(--emerald);font-size:0.75rem">(Hardcoded ✓)</span></label>
<input type="text" id="apiUrl" class="form-input" readonly style="background:rgba(20,184,166,0.1);border-color:var(--emerald);color:var(--text-secondary)">
<p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">API URL is hardcoded in the app for all users</p>
</div>
<div class="form-group">
<label class="form-label">💊 Drug Reference URL</label>
<input type="text" id="drugRefUrl" class="form-input" placeholder="https://example.com/drug.html">
<p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">URL for the "Learn More" button on medications. Leave empty to disable.</p>
</div>
<button class="btn btn-primary" onclick="saveSettings()">💾 Save Settings</button>
</div>
</div>
</div>
</div>
</div>

<!-- MODALS -->
<div class="modal" id="accessModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div id="accessIcon" style="font-size:3rem;margin-bottom:12px">🏥</div>
<div class="modal-title" id="accessTitle">Unit Access</div>
<p style="color:var(--text-muted);font-size:0.85rem;margin-top:8px">Enter 4-digit code</p>
</div>
<div class="modal-body">
<div class="code-inputs" id="codeInputs"></div>
<p class="code-error" id="codeError">Invalid code</p>
<div id="userSection" style="display:none;margin-top:28px;padding-top:28px;border-top:1px solid var(--border)">
<div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input"></div>
<div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option></select></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
<button class="btn btn-primary" id="enterBtn" style="display:none" onclick="enterUnit()">Enter</button>
</div>
</div>
</div>

<div class="modal" id="adminModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div style="font-size:3rem;margin-bottom:12px">⚙️</div>
<div class="modal-title">Admin Access</div>
</div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPwd" class="form-input"></div>
<p class="code-error" id="adminError">Invalid</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('adminModal')">Cancel</button>
<button class="btn btn-primary" onclick="loginAdmin()">Login</button>
</div>
</div>
</div>

<div class="modal" id="patientModal">
<div class="modal-box" style="max-width:540px">
<div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div>
<div class="modal-body">
<input type="hidden" id="ptId">
<div class="form-group"><label class="form-label">Patient Name</label><input type="text" id="ptName" class="form-input"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group">
  <label class="form-label">Ward</label>
  <div class="ward-input-wrapper">
    <input type="text" id="ptWard" class="form-input" placeholder="Type ward (e.g., Ward 14, ICU)" autocomplete="off" oninput="showWardSuggestions(this.value)" onfocus="showWardSuggestions(this.value)">
    <div class="ward-suggestions" id="wardSuggestions"></div>
  </div>
</div>
<div class="form-group"><label class="form-label">Room</label><input type="text" id="ptRoom" class="form-input"></div>
</div>
<div class="form-group"><label class="form-label">Diagnosis</label><textarea id="ptDx" class="form-textarea"></textarea></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Doctor</label><input type="text" id="ptDoctor" class="form-input"></div>
<div class="form-group"><label class="form-label">Status</label><select id="ptStatus" class="form-select"><option value="new">🆕 New</option><option value="active">✅ Active</option><option value="critical">🚨 Critical</option><option value="chronic">💜 Chronic</option><option value="discharged">🏠 Discharged</option></select></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
<button class="btn btn-primary" onclick="savePatient()">Save</button>
</div>
</div>
</div>

<div class="modal" id="unitModal">
<div class="modal-box">
<div class="modal-header"><div class="modal-title" id="unitModalTitle">Add Unit</div></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name</label><input type="text" id="uName" class="form-input"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Icon</label><input type="text" id="uIcon" class="form-input" value="🏥" style="font-size:1.75rem;text-align:center"></div>
<div class="form-group"><label class="form-label">Code</label><input type="text" id="uCode" class="form-input" maxlength="4"></div>
</div>
<div class="form-group"><label class="form-label">Description</label><input type="text" id="uDesc" class="form-input"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveUnit()">Save</button>
</div>
</div>
</div>

<div class="modal" id="importModal">
<div class="modal-box" style="max-width:560px">
<div class="modal-header"><div class="modal-title">📥 Import Patients</div></div>
<div class="modal-body">
<div id="importUpload">
<div class="upload-zone" onclick="document.getElementById('importFile').click()">
<div style="font-size:2.5rem;margin-bottom:12px">📷</div>
<div style="font-weight:600">Upload Screenshot</div>
</div>
<input type="file" id="importFile" accept="image/*" style="display:none">
</div>
<div id="importPreview" style="display:none">
<img id="importImg" style="width:100%;max-height:160px;object-fit:contain;border-radius:12px;margin-bottom:16px">
<div style="display:flex;gap:12px">
<button class="btn btn-secondary btn-sm" style="flex:1" onclick="resetImport()">Change</button>
<button class="btn btn-primary btn-sm" style="flex:2" onclick="extractPatients()">🤖 Extract</button>
</div>
</div>
<div id="importLoading" style="display:none;text-align:center;padding:48px"><div class="spinner"></div></div>
<div id="importResults" style="display:none">
<div style="display:flex;justify-content:space-between;margin-bottom:16px"><span style="font-weight:600">Found</span><span id="importCount" class="badge badge-emerald">0</span></div>
<div id="importList" style="max-height:320px;overflow-y:auto"></div>
</div>
<div id="importError" style="display:none;text-align:center;padding:40px">
<div style="font-size:2.5rem;margin-bottom:16px">⚠️</div>
<div id="importErrorMsg" style="color:var(--rose)">Error</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px" onclick="resetImport()">Retry</button>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
<button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>Import</button>
</div>
</div>
</div>

<div class="modal" id="editTextModal">
<div class="modal-box wide">
<div class="modal-header"><div class="modal-title" id="editTextTitle">Edit</div></div>
<div class="modal-body">
<input type="hidden" id="editTextType">
<textarea id="editTextArea" class="form-textarea" style="min-height:200px"></textarea>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('editTextModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveEditText()">Save</button>
</div>
</div>
</div>

<div class="modal" id="addDataModal">
<div class="modal-box wide">
<div class="modal-header"><div class="modal-title" id="addDataTitle">Add</div></div>
<div class="modal-body" id="addDataBody"></div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('addDataModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveAddData()">Save</button>
</div>
</div>
</div>

<!-- MEDICATION MODAL -->
<div class="modal" id="medicationModal">
<div class="modal-box" style="max-width:480px">
<div class="modal-header">
<div style="display:flex;align-items:center;gap:12px">
<div style="width:44px;height:44px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:12px;display:grid;place-items:center;font-size:1.5rem">💊</div>
<div>
<div class="modal-title" id="medicationModalTitle">Add Medication</div>
<div style="font-size:0.75rem;color:var(--text-muted)">Enter medication details</div>
</div>
</div>
<button class="btn btn-ghost" onclick="closeModal('medicationModal')" style="margin-left:auto">✕</button>
</div>
<div class="modal-body" style="padding:20px">
<div class="form-group">
<label class="form-label">Drug Name *</label>
<input type="text" class="form-input" id="medName" placeholder="e.g., Metformin">
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group">
<label class="form-label">Dose *</label>
<input type="text" class="form-input" id="medDose" placeholder="e.g., 500mg">
</div>
<div class="form-group">
<label class="form-label">Route</label>
<select class="form-select" id="medRoute">
<option value="PO">PO (Oral)</option>
<option value="IV">IV</option>
<option value="IM">IM</option>
<option value="SC">SC</option>
<option value="INH">INH (Inhaled)</option>
<option value="TOP">Topical</option>
<option value="PR">PR</option>
<option value="SL">SL</option>
</select>
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group">
<label class="form-label">Frequency *</label>
<select class="form-select" id="medFreq">
<option value="OD">OD (Once daily)</option>
<option value="BD">BD (Twice daily)</option>
<option value="TDS">TDS (3x daily)</option>
<option value="QID">QID (4x daily)</option>
<option value="PRN">PRN (As needed)</option>
<option value="STAT">STAT</option>
<option value="Q4H">Q4H</option>
<option value="Q6H">Q6H</option>
<option value="Q8H">Q8H</option>
<option value="Q12H">Q12H</option>
<option value="Weekly">Weekly</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Status</label>
<select class="form-select" id="medStatus">
<option value="active">✅ Active</option>
<option value="new">🆕 New</option>
<option value="prn">⏰ PRN</option>
<option value="discontinued">🛑 Discontinued</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Indication</label>
<input type="text" class="form-input" id="medIndication" placeholder="e.g., Type 2 Diabetes Mellitus">
</div>
<div class="form-group">
<label class="form-label">Generic Name (Optional)</label>
<input type="text" class="form-input" id="medGeneric" placeholder="e.g., Metformin Hydrochloride">
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('medicationModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveMedication()">💾 Save Medication</button>
</div>
</div>
</div>

<!-- REQUEST UNIT MODAL -->
<div class="modal" id="requestUnitModal">
<div class="modal-box wide">
<div class="modal-header">
<div class="modal-title">📩 Request New Unit Access</div>
<button class="btn btn-ghost" onclick="closeModal('requestUnitModal')">✕</button>
</div>
<div class="modal-body" id="requestUnitBody">
<div id="requestFormSection">
<p style="color:var(--text-secondary);margin-bottom:24px;font-size:0.9rem">Fill out this form to request a new unit. Your request will be reviewed by an administrator who will create your unit and provide access credentials.</p>
<div class="request-form">
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Your Full Name *</label>
<input type="text" id="reqName" class="form-input" placeholder="Dr. John Smith">
</div>
<div class="form-group">
<label class="form-label">Email Address *</label>
<input type="email" id="reqEmail" class="form-input" placeholder="john.smith@hospital.com">
</div>
</div>
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Department *</label>
<input type="text" id="reqDepartment" class="form-input" placeholder="e.g., Internal Medicine, Cardiology">
</div>
<div class="form-group">
<label class="form-label">Position/Role *</label>
<select id="reqRole" class="form-input">
<option value="">Select role...</option>
<option value="attending">Attending Physician</option>
<option value="consultant">Consultant</option>
<option value="resident">Resident</option>
<option value="intern">Intern</option>
<option value="nurse_manager">Nurse Manager</option>
<option value="head_nurse">Head Nurse</option>
<option value="other">Other</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Requested Unit Name *</label>
<input type="text" id="reqUnitName" class="form-input" placeholder="e.g., Cardiology Unit A, ICU Team 2">
</div>
<div class="form-group">
<label class="form-label">Unit Icon</label>
<div class="request-icon-grid" id="iconGrid">
<div class="request-icon-option selected" data-icon="🏥">🏥</div>
<div class="request-icon-option" data-icon="❤️">❤️</div>
<div class="request-icon-option" data-icon="🫀">🫀</div>
<div class="request-icon-option" data-icon="🧠">🧠</div>
<div class="request-icon-option" data-icon="🫁">🫁</div>
<div class="request-icon-option" data-icon="🦴">🦴</div>
<div class="request-icon-option" data-icon="👶">👶</div>
<div class="request-icon-option" data-icon="🩺">🩺</div>
<div class="request-icon-option" data-icon="💉">💉</div>
<div class="request-icon-option" data-icon="🔬">🔬</div>
<div class="request-icon-option" data-icon="⚕️">⚕️</div>
<div class="request-icon-option" data-icon="🚑">🚑</div>
</div>
</div>
<div class="form-group">
<label class="form-label">Reason for Request / Additional Notes</label>
<textarea id="reqMessage" class="form-textarea" placeholder="Briefly describe why you need this unit and any specific requirements..."></textarea>
</div>
</div>
</div>
<div id="requestSuccessSection" style="display:none">
<div class="request-success">
<div class="request-success-icon">✅</div>
<div class="request-success-title">Request Submitted Successfully!</div>
<div class="request-success-text">Your request has been sent to the administrator for review. You will receive your unit access code once approved.</div>
<div class="request-success-id" id="requestIdDisplay">Request ID: REQ-XXXXXX</div>
</div>
</div>
</div>
<div class="modal-footer" id="requestFormFooter">
<button class="btn btn-secondary" onclick="closeModal('requestUnitModal')">Cancel</button>
<button class="btn btn-primary" onclick="submitUnitRequest()">📤 Submit Request</button>
</div>
<div class="modal-footer" id="requestSuccessFooter" style="display:none">
<button class="btn btn-primary btn-full" onclick="closeModal('requestUnitModal')">Done</button>
</div>
</div>
</div>

<!-- APPROVE REQUEST MODAL -->
<div class="modal" id="approveRequestModal">
<div class="modal-box wide">
<div class="modal-header">
<div class="modal-title">✅ Approve Unit Request</div>
<button class="btn btn-ghost" onclick="closeModal('approveRequestModal')">✕</button>
</div>
<div class="modal-body">
<div id="approveRequestDetails"></div>
<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)">
<h4 style="margin-bottom:16px;font-size:0.9rem">Create Unit Access</h4>
<div class="request-form">
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Unit Name</label>
<input type="text" id="approveUnitName" class="form-input">
</div>
<div class="form-group">
<label class="form-label">Unit Icon</label>
<input type="text" id="approveUnitIcon" class="form-input" style="font-size:1.5rem;text-align:center">
</div>
</div>
<div class="request-form-row">
<div class="form-group">
<label class="form-label">4-Digit Access Code *</label>
<input type="text" id="approveUnitCode" class="form-input mono" maxlength="4" placeholder="1234" style="font-size:1.5rem;text-align:center;letter-spacing:8px">
</div>
<div class="form-group">
<label class="form-label">Unit Color</label>
<select id="approveUnitColor" class="form-input">
<option value="#14b8a6">🟢 Teal</option>
<option value="#f59e0b">🟡 Gold</option>
<option value="#3b82f6">🔵 Blue</option>
<option value="#8b5cf6">🟣 Purple</option>
<option value="#f43f5e">🔴 Rose</option>
<option value="#10b981">🟢 Emerald</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Unit Description</label>
<input type="text" id="approveUnitDesc" class="form-input" placeholder="Brief description of the unit">
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('approveRequestModal')">Cancel</button>
<button class="btn btn-danger" onclick="rejectRequest()">❌ Reject</button>
<button class="btn btn-primary" onclick="approveRequest()">✅ Approve & Create Unit</button>
</div>
</div>
</div>

<!-- Lab Extraction Preview Modal -->
<div class="modal" id="labPreviewModal">
  <div class="modal-box wide">
    <div class="modal-header">
      <div class="modal-title">🧪 Lab Extraction Preview</div>
      <button class="btn btn-ghost" onclick="closeModal('labPreviewModal')">✕</button>
    </div>
    <div class="modal-body">
      <div id="labExtractionConfidence"></div>
      <div id="labExtractionPreview"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('labPreviewModal'); resetLabExtraction()">Cancel</button>
      <button class="btn btn-primary" id="confirmLabBtn" onclick="confirmLabExtraction()">✓ Confirm & Save</button>
    </div>
  </div>
</div>

<!-- Score Calculator Modal - Mobile-First Design -->
<div class="modal" id="scoreCalcModal" style="padding:0">
  <div class="modal-box wide" style="border:none;background:transparent">
    <div class="score-calculator">
      <div class="score-calc-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="score-calc-title" id="scoreCalcTitle">Score Name</div>
            <div class="score-calc-purpose" id="scoreCalcPurpose">Purpose description</div>
          </div>
          <button onclick="closeModal('scoreCalcModal')" style="background:rgba(148,163,184,0.1);border:none;width:32px;height:32px;border-radius:8px;color:#94a3b8;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button>
        </div>
        <div class="score-calc-category" id="scoreCalcCategory">Category</div>
      </div>
      <div class="score-calc-body">
        <div class="score-calc-fields" id="scoreCalcFields"></div>
      </div>
      <div class="score-calc-result" id="scoreCalcResult">
        <div class="score-result-display">
          <div class="score-result-value" id="scoreResultValue">0</div>
          <div class="score-result-max" id="scoreResultMax">of 10</div>
        </div>
        <div class="score-result-interpretation" id="scoreResultInterpretation">
          <div class="score-result-risk">Low Risk</div>
          <div class="score-result-action">Recommended action here</div>
        </div>
      </div>
      <div class="modal-footer" style="background:#080c14;border-top:1px solid rgba(148,163,184,0.06);padding:12px 16px;gap:10px">
        <button class="btn btn-secondary" onclick="closeModal('scoreCalcModal')" style="background:#1e293b;border:1px solid rgba(148,163,184,0.12);flex:1">Close</button>
        <button class="btn btn-primary" id="saveScoreBtn" onclick="savePatientScore()" style="display:none;flex:1">💾 Save</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="labFileInput" accept="image/*" style="display:none">

<!-- Lab Override Modal -->
<div class="modal" id="labOverrideModal">
<div class="modal-box">
<div class="modal-header"><div class="modal-title">✏️ Override Lab Value</div></div>
<div class="modal-body">
<div class="form-group">
  <label class="form-label" id="labOverrideName">Parameter</label>
  <input type="text" id="labOverrideValue" class="form-input mono" placeholder="Enter new value">
</div>
<input type="hidden" id="labOverrideParamIdx">
<input type="hidden" id="labOverrideValueIdx">
<p style="font-size:0.8rem;color:var(--text-muted);margin-top:12px">⚠️ This will override the extracted value. Manual changes are marked with ✏️</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('labOverrideModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveLabOverride()">Save Override</button>
</div>
</div>
</div>

<!-- Discharge Confirmation Modal -->
<div class="modal" id="dischargeModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div style="font-size:3rem;margin-bottom:12px">🏠</div>
<div class="modal-title">Discharge Patient</div>
</div>
<div class="modal-body">
<p style="text-align:center;color:var(--text-secondary);margin-bottom:20px">Are you sure you want to discharge <strong id="dischargePatientName"></strong>?</p>
<div class="form-group">
<label class="form-label">Discharge Summary (Optional)</label>
<textarea id="dischargeSummary" class="form-textarea" placeholder="Enter discharge notes, follow-up instructions..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('dischargeModal')">Cancel</button>
<button class="btn btn-success" onclick="confirmDischarge()">✓ Confirm Discharge</button>
</div>
</div>
</div>

<input type="file" id="labFileInputHidden" accept="image/*" style="display:none">
<input type="file" id="imagingFileInput" accept="image/*" style="display:none">
<script>
(function(){
'use strict';

const CONFIG = {
  STORAGE_KEY: 'medward_pro_v12',
  ADMIN_PASSWORD: 'admin123',
  // Hardcoded API URL - central Google Apps Script for all users
  API_URL: 'https://script.google.com/macros/s/AKfycbwnPMayEKM6rHJB2qZ-DDECoVB4Kte1EcoBiea0pmcasfyAeW7RGeADiH5DMXGRJOSJ/exec',
  MAX_IMAGE_SIZE: 1500000,
  IMAGE_QUALITY: 0.85,
  MAX_DIM: 2000,
  SYNC_DEBOUNCE_MS: 1500,
  VALID_WARDS: ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned'],
  
  // ═══════════════════════════════════════════════════════════════════
  // DRUG DATABASE - Local instant lookup with lab correlations
  // ═══════════════════════════════════════════════════════════════════
  DRUG_DATABASE: {
    // Antidiabetics
    'Metformin': { class: 'Biguanide', icon: '💊', monitorLabs: ['HbA1c', 'Glucose', 'Creatinine', 'eGFR', 'Lactate'], alerts: { 'eGFR': { operator: '<', value: 30, severity: 'critical', message: 'Contraindicated: eGFR <30 - risk of lactic acidosis' }, 'Lactate': { operator: '>', value: 2, severity: 'warning', message: 'Monitor for lactic acidosis' } }, reference: { HbA1c: { normal: '4.0-5.6%', target: '<7.0%' } } },
    'Glipizide': { class: 'Sulfonylurea', icon: '💊', monitorLabs: ['Glucose', 'HbA1c'], alerts: { 'Glucose': { operator: '<', value: 70, severity: 'critical', message: 'Hypoglycemia risk - hold or reduce dose' } } },
    'Insulin': { class: 'Hormone', icon: '💉', monitorLabs: ['Glucose', 'HbA1c', 'Potassium'], alerts: { 'Glucose': { operator: '<', value: 70, severity: 'critical', message: 'Hypoglycemia - reduce dose' }, 'Potassium': { operator: '<', value: 3.5, severity: 'warning', message: 'Insulin shifts K+ intracellularly' } } },
    'Empagliflozin': { class: 'SGLT2i', icon: '💊', monitorLabs: ['Glucose', 'Creatinine', 'eGFR', 'Potassium'], alerts: { 'eGFR': { operator: '<', value: 20, severity: 'warning', message: 'Reduced efficacy at low eGFR' } } },
    'Sitagliptin': { class: 'DPP-4 Inhibitor', icon: '💊', monitorLabs: ['HbA1c', 'Glucose', 'Creatinine'], alerts: {} },
    
    // Cardiovascular - ACE Inhibitors
    'Lisinopril': { class: 'ACE Inhibitor', icon: '❤️', monitorLabs: ['Potassium', 'Creatinine', 'eGFR'], alerts: { 'Potassium': { operator: '>', value: 5.5, severity: 'critical', message: 'Hyperkalemia risk - consider dose reduction or discontinuation' }, 'Creatinine': { operator: '>', value: 3.0, severity: 'warning', message: 'Monitor renal function closely' } }, reference: { Potassium: { normal: '3.5-5.0 mEq/L' }, Creatinine: { normal: '0.7-1.3 mg/dL' } } },
    'Enalapril': { class: 'ACE Inhibitor', icon: '❤️', monitorLabs: ['Potassium', 'Creatinine', 'eGFR'], alerts: { 'Potassium': { operator: '>', value: 5.5, severity: 'critical', message: 'Hyperkalemia risk' } } },
    'Ramipril': { class: 'ACE Inhibitor', icon: '❤️', monitorLabs: ['Potassium', 'Creatinine', 'eGFR'], alerts: { 'Potassium': { operator: '>', value: 5.5, severity: 'critical', message: 'Hyperkalemia risk' } } },
    
    // Cardiovascular - ARBs
    'Losartan': { class: 'ARB', icon: '❤️', monitorLabs: ['Potassium', 'Creatinine'], alerts: { 'Potassium': { operator: '>', value: 5.5, severity: 'critical', message: 'Hyperkalemia risk' } } },
    'Valsartan': { class: 'ARB', icon: '❤️', monitorLabs: ['Potassium', 'Creatinine'], alerts: { 'Potassium': { operator: '>', value: 5.5, severity: 'critical', message: 'Hyperkalemia risk' } } },
    
    // Cardiovascular - Beta Blockers
    'Metoprolol': { class: 'Beta Blocker', icon: '💓', monitorLabs: ['Glucose'], alerts: { 'Glucose': { operator: '<', value: 70, severity: 'warning', message: 'May mask hypoglycemia symptoms' } } },
    'Carvedilol': { class: 'Alpha/Beta Blocker', icon: '💓', monitorLabs: ['Glucose'], alerts: {} },
    'Bisoprolol': { class: 'Beta Blocker', icon: '💓', monitorLabs: [], alerts: {} },
    
    // Cardiovascular - Diuretics
    'Furosemide': { class: 'Loop Diuretic', icon: '💧', monitorLabs: ['Potassium', 'Sodium', 'Creatinine', 'Magnesium'], alerts: { 'Potassium': { operator: '<', value: 3.5, severity: 'critical', message: 'Hypokalemia - supplement K+' }, 'Sodium': { operator: '<', value: 130, severity: 'warning', message: 'Hyponatremia risk' }, 'Magnesium': { operator: '<', value: 1.5, severity: 'warning', message: 'Hypomagnesemia - supplement Mg' } } },
    'Spironolactone': { class: 'MRA', icon: '💧', monitorLabs: ['Potassium', 'Creatinine'], alerts: { 'Potassium': { operator: '>', value: 5.5, severity: 'critical', message: 'Hyperkalemia - reduce or hold dose' } } },
    'Hydrochlorothiazide': { class: 'Thiazide Diuretic', icon: '💧', monitorLabs: ['Potassium', 'Sodium', 'Glucose', 'Uric Acid'], alerts: { 'Potassium': { operator: '<', value: 3.5, severity: 'warning', message: 'Hypokalemia risk' }, 'Sodium': { operator: '<', value: 130, severity: 'warning', message: 'Hyponatremia risk' } } },
    
    // Cardiovascular - Other
    'Amlodipine': { class: 'CCB', icon: '❤️', monitorLabs: [], alerts: {} },
    'Digoxin': { class: 'Cardiac Glycoside', icon: '❤️', monitorLabs: ['Potassium', 'Creatinine', 'Digoxin Level'], alerts: { 'Potassium': { operator: '<', value: 3.5, severity: 'critical', message: 'Hypokalemia increases digoxin toxicity risk' } } },
    'Amiodarone': { class: 'Antiarrhythmic', icon: '❤️', monitorLabs: ['TSH', 'LFTs', 'Pulmonary Function'], alerts: {} },
    
    // Anticoagulants
    'Warfarin': { class: 'Vitamin K Antagonist', icon: '🩸', monitorLabs: ['INR', 'PT'], alerts: { 'INR': { operator: '>', value: 4, severity: 'critical', message: 'Supratherapeutic INR - bleeding risk, hold warfarin' }, 'INR': { operator: '<', value: 2, severity: 'warning', message: 'Subtherapeutic - stroke risk if AF' } }, reference: { INR: { normal: '0.8-1.2', target: '2.0-3.0 (AF), 2.5-3.5 (mechanical valve)' } } },
    'Heparin': { class: 'Anticoagulant', icon: '🩸', monitorLabs: ['aPTT', 'Platelets', 'Anti-Xa'], alerts: { 'Platelets': { operator: '<', value: 100, severity: 'critical', message: 'Consider HIT - check HIT antibody' } } },
    'Enoxaparin': { class: 'LMWH', icon: '🩸', monitorLabs: ['Anti-Xa', 'Platelets', 'Creatinine'], alerts: { 'Creatinine': { operator: '>', value: 2.5, severity: 'warning', message: 'Accumulation risk in renal impairment' } } },
    'Rivaroxaban': { class: 'Factor Xa Inhibitor', icon: '🩸', monitorLabs: ['Creatinine', 'eGFR', 'Hemoglobin'], alerts: { 'eGFR': { operator: '<', value: 15, severity: 'critical', message: 'Contraindicated in severe renal impairment' } } },
    'Apixaban': { class: 'Factor Xa Inhibitor', icon: '🩸', monitorLabs: ['Creatinine', 'eGFR'], alerts: { 'eGFR': { operator: '<', value: 25, severity: 'warning', message: 'Dose adjustment required' } } },
    
    // Statins
    'Atorvastatin': { class: 'Statin', icon: '🩸', monitorLabs: ['LDL', 'Total Cholesterol', 'LFTs', 'CK'], alerts: { 'CK': { operator: '>', value: 1000, severity: 'critical', message: 'Rhabdomyolysis risk - hold statin' } } },
    'Rosuvastatin': { class: 'Statin', icon: '🩸', monitorLabs: ['LDL', 'LFTs', 'CK'], alerts: {} },
    
    // GI
    'Omeprazole': { class: 'PPI', icon: '🫁', monitorLabs: ['Magnesium', 'B12'], alerts: { 'Magnesium': { operator: '<', value: 1.5, severity: 'warning', message: 'Long-term PPI can cause hypomagnesemia' } } },
    'Pantoprazole': { class: 'PPI', icon: '🫁', monitorLabs: ['Magnesium'], alerts: {} },
    
    // Antibiotics
    'Vancomycin': { class: 'Glycopeptide', icon: '🦠', monitorLabs: ['Vancomycin Trough', 'Creatinine', 'eGFR'], alerts: { 'Vancomycin Trough': { operator: '>', value: 20, severity: 'critical', message: 'Supratherapeutic - nephrotoxicity risk' }, 'Creatinine': { operator: '>', value: 2.0, severity: 'warning', message: 'Monitor for nephrotoxicity' } }, reference: { 'Vancomycin Trough': { target: '15-20 mcg/mL (serious infections)' } } },
    'Gentamicin': { class: 'Aminoglycoside', icon: '🦠', monitorLabs: ['Gentamicin Level', 'Creatinine'], alerts: { 'Creatinine': { operator: '>', value: 2.0, severity: 'warning', message: 'Nephrotoxicity - consider dose adjustment' } } },
    'Amoxicillin': { class: 'Penicillin', icon: '🦠', monitorLabs: [], alerts: {} },
    'Ciprofloxacin': { class: 'Fluoroquinolone', icon: '🦠', monitorLabs: ['QTc'], alerts: {} },
    'Meropenem': { class: 'Carbapenem', icon: '🦠', monitorLabs: ['Creatinine'], alerts: {} },
    
    // Thyroid
    'Levothyroxine': { class: 'Thyroid Hormone', icon: '🦋', monitorLabs: ['TSH', 'Free T4'], alerts: { 'TSH': { operator: '<', value: 0.1, severity: 'warning', message: 'Overreplacement - reduce dose' }, 'TSH': { operator: '>', value: 10, severity: 'warning', message: 'Underreplacement - increase dose' } }, reference: { TSH: { normal: '0.4-4.0 mIU/L' } } },
    
    // Neurological
    'Levetiracetam': { class: 'Antiepileptic', icon: '🧠', monitorLabs: ['Creatinine'], alerts: {} },
    'Phenytoin': { class: 'Antiepileptic', icon: '🧠', monitorLabs: ['Phenytoin Level', 'Albumin'], alerts: { 'Phenytoin Level': { operator: '>', value: 20, severity: 'critical', message: 'Toxic level - hold and recheck' } } },
    'Valproate': { class: 'Antiepileptic', icon: '🧠', monitorLabs: ['Valproic Acid Level', 'LFTs', 'Ammonia', 'Platelets'], alerts: { 'Ammonia': { operator: '>', value: 80, severity: 'warning', message: 'Hyperammonemia - consider lactulose or dose reduction' } } },
    
    // Pain
    'Morphine': { class: 'Opioid', icon: '💊', monitorLabs: ['Creatinine'], alerts: { 'Creatinine': { operator: '>', value: 2.0, severity: 'warning', message: 'Active metabolites accumulate in renal failure' } } },
    'Tramadol': { class: 'Opioid', icon: '💊', monitorLabs: ['Creatinine'], alerts: {} },
    
    // Psychiatric
    'Lithium': { class: 'Mood Stabilizer', icon: '🧠', monitorLabs: ['Lithium Level', 'Creatinine', 'TSH', 'Sodium'], alerts: { 'Lithium Level': { operator: '>', value: 1.5, severity: 'critical', message: 'Toxic level - hold lithium, hydrate' }, 'Sodium': { operator: '<', value: 130, severity: 'warning', message: 'Hyponatremia increases lithium toxicity' } }, reference: { 'Lithium Level': { target: '0.6-1.2 mEq/L' } } }
  },
  
  LAB_CATEGORIES: {
    'Cardiac Markers': { icon: '❤️', terms: ['Troponin', 'BNP', 'proBNP', 'NT-proBNP', 'CK-MB', 'Myoglobin'] },
    'Renal Function': { icon: '🫘', terms: ['Urea', 'Creatinine', 'Creat', 'eGFR', 'BUN'] },
    'Electrolytes': { icon: '⚡', terms: ['Na', 'Sodium', 'K', 'Potassium', 'Cl', 'Chloride', 'CO2', 'Bicarbonate', 'Mg', 'Magnesium', 'Ca', 'Calcium', 'Phosphate', 'Phos'] },
    'Glucose & Metabolic': { icon: '🍬', terms: ['Glucose', 'Gluc', 'FBG', 'RBG', 'HbA1c', 'Lactate'] },
    'Liver Function': { icon: '🫀', terms: ['ALT', 'AST', 'ALP', 'GGT', 'Bilirubin', 'Albumin', 'Total Protein'] },
    'Complete Blood Count': { icon: '🩸', terms: ['Hgb', 'Hemoglobin', 'WBC', 'Platelets', 'RBC', 'MCV', 'Hct'] },
    'Other': { icon: '🔬', terms: ['Urate', 'Uric Acid', 'Anion Gap', 'Osmolality', 'CRP', 'ESR', 'Procalcitonin'] }
  },
  
  // ═══════════════════════════════════════════════════════════════════
  // CLINICAL SCORING SYSTEMS
  // ═══════════════════════════════════════════════════════════════════
  
  // Patient-specific scores - appear in patient profile based on diagnosis
  PATIENT_SCORES: {
    // Cardiac
    'heart failure': ['NYHA', 'MAGGIC', 'H2FPEF', 'HFA-PEFF'],
    'hf': ['NYHA', 'MAGGIC', 'H2FPEF', 'HFA-PEFF'],
    'chf': ['NYHA', 'MAGGIC', 'H2FPEF', 'HFA-PEFF'],
    'atrial fibrillation': ['CHA2DS2-VASc', 'HAS-BLED', 'EHRA'],
    'af': ['CHA2DS2-VASc', 'HAS-BLED', 'EHRA'],
    'afib': ['CHA2DS2-VASc', 'HAS-BLED', 'EHRA'],
    'acs': ['TIMI', 'GRACE', 'HEART', 'Killip'],
    'stemi': ['TIMI', 'Killip', 'GRACE'],
    'nstemi': ['TIMI', 'GRACE', 'HEART'],
    'unstable angina': ['TIMI', 'HEART'],
    'chest pain': ['HEART', 'TIMI', 'Wells-PE'],
    'mi': ['TIMI', 'GRACE', 'Killip'],
    
    // Respiratory
    'pneumonia': ['CURB-65', 'PSI', 'A-DROP'],
    'cap': ['CURB-65', 'PSI'],
    'copd': ['GOLD', 'BODE', 'mMRC'],
    'copd exacerbation': ['GOLD', 'DECAF', 'BAP-65'],
    'asthma': ['GINA', 'Asthma-Control'],
    'pe': ['Wells-PE', 'Geneva', 'PESI', 'sPESI'],
    'pulmonary embolism': ['Wells-PE', 'Geneva', 'PESI', 'sPESI'],
    
    // Neurological
    'stroke': ['NIHSS', 'mRS', 'ABCD2', 'ICH'],
    'cva': ['NIHSS', 'mRS', 'ABCD2'],
    'tia': ['ABCD2', 'mRS'],
    'ich': ['ICH', 'FUNC'],
    'seizure': ['ILAE', 'Status-Epilepticus'],
    
    // GI/Hepatic
    'gi bleed': ['Glasgow-Blatchford', 'Rockall', 'AIMS65'],
    'gib': ['Glasgow-Blatchford', 'Rockall', 'AIMS65'],
    'upper gi bleed': ['Glasgow-Blatchford', 'Rockall', 'AIMS65'],
    'cirrhosis': ['Child-Pugh', 'MELD', 'MELD-Na'],
    'liver failure': ['Child-Pugh', 'MELD', 'MELD-Na', 'CLIF-SOFA'],
    'hepatic encephalopathy': ['West-Haven', 'Child-Pugh'],
    'pancreatitis': ['Ranson', 'BISAP', 'Atlanta'],
    'acute pancreatitis': ['Ranson', 'BISAP', 'APACHE-II'],
    
    // Renal
    'aki': ['KDIGO-AKI', 'RIFLE', 'AKIN'],
    'acute kidney injury': ['KDIGO-AKI', 'RIFLE', 'AKIN'],
    'ckd': ['KDIGO-CKD', 'eGFR-Stage'],
    
    // Infectious
    'sepsis': ['qSOFA', 'SOFA', 'NEWS2', 'SIRS'],
    'septic shock': ['SOFA', 'APACHE-II', 'NEWS2'],
    'meningitis': ['Glasgow-Coma', 'LAMP'],
    'endocarditis': ['Duke', 'HACEK'],
    
    // Critical Care
    'icu': ['APACHE-II', 'SOFA', 'SAPS-II', 'NEWS2'],
    'critical': ['APACHE-II', 'SOFA', 'NEWS2', 'Glasgow-Coma'],
    'intubated': ['RSBI', 'APACHE-II'],
    'ventilator': ['RSBI', 'P/F-Ratio'],
    
    // Surgical/Trauma
    'surgery': ['ASA', 'Caprini', 'RCRI'],
    'post-op': ['ASA', 'Caprini', 'Surgical-Apgar'],
    'trauma': ['ISS', 'RTS', 'GCS'],
    'fall': ['Morse-Fall', 'STRATIFY'],
    'fracture': ['FRAX', 'Caprini'],
    
    // VTE
    'dvt': ['Wells-DVT', 'Caprini', 'Padua'],
    'deep vein thrombosis': ['Wells-DVT', 'Caprini'],
    'vte': ['Caprini', 'Padua', 'Wells-DVT'],
    
    // Diabetes
    'dka': ['DKA-Severity', 'Anion-Gap'],
    'diabetic ketoacidosis': ['DKA-Severity', 'Anion-Gap'],
    'hhs': ['HHS-Severity', 'Osmolality'],
    'diabetes': ['HbA1c-Control', 'UKPDS']
  },
  
  // Complete scoring calculators with formulas
  SCORING_CALCULATORS: {
    // ═══ CARDIAC SCORES ═══
    'CHA2DS2-VASc': {
      name: 'CHA₂DS₂-VASc Score',
      category: 'Cardiac',
      purpose: 'Stroke risk in atrial fibrillation',
      fields: [
        { id: 'chf', label: 'CHF/LV dysfunction', points: 1, type: 'checkbox' },
        { id: 'htn', label: 'Hypertension', points: 1, type: 'checkbox' },
        { id: 'age75', label: 'Age ≥75', points: 2, type: 'checkbox' },
        { id: 'dm', label: 'Diabetes mellitus', points: 1, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke/TIA/thromboembolism', points: 2, type: 'checkbox' },
        { id: 'vascular', label: 'Vascular disease (MI, PAD, aortic plaque)', points: 1, type: 'checkbox' },
        { id: 'age65', label: 'Age 65-74', points: 1, type: 'checkbox' },
        { id: 'female', label: 'Sex category (female)', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Low', action: 'No anticoagulation (or ASA)', color: '#10b981', annual: '0%' },
        { min: 1, max: 1, risk: 'Low-Moderate', action: 'Consider anticoagulation', color: '#f59e0b', annual: '1.3%' },
        { min: 2, max: 9, risk: 'Moderate-High', action: 'Anticoagulation recommended', color: '#ef4444', annual: '≥2.2%' }
      ]
    },
    
    'HAS-BLED': {
      name: 'HAS-BLED Score',
      category: 'Cardiac',
      purpose: 'Bleeding risk on anticoagulation',
      fields: [
        { id: 'htn', label: 'Hypertension (SBP >160)', points: 1, type: 'checkbox' },
        { id: 'renal', label: 'Abnormal renal function', points: 1, type: 'checkbox' },
        { id: 'liver', label: 'Abnormal liver function', points: 1, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke history', points: 1, type: 'checkbox' },
        { id: 'bleeding', label: 'Bleeding history/predisposition', points: 1, type: 'checkbox' },
        { id: 'inr', label: 'Labile INR (if on warfarin)', points: 1, type: 'checkbox' },
        { id: 'elderly', label: 'Elderly (>65)', points: 1, type: 'checkbox' },
        { id: 'drugs', label: 'Drugs (antiplatelets, NSAIDs)', points: 1, type: 'checkbox' },
        { id: 'alcohol', label: 'Alcohol excess', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 2, risk: 'Low', action: 'Anticoagulation generally safe', color: '#10b981', annual: '1-2%' },
        { min: 3, max: 9, risk: 'High', action: 'Caution - address modifiable risks', color: '#ef4444', annual: '≥3.7%' }
      ]
    },
    
    'HEART': {
      name: 'HEART Score',
      category: 'Cardiac',
      purpose: 'Risk stratification for chest pain',
      fields: [
        { id: 'history', label: 'History', type: 'select', options: [
          { value: 0, label: 'Slightly suspicious' },
          { value: 1, label: 'Moderately suspicious' },
          { value: 2, label: 'Highly suspicious' }
        ]},
        { id: 'ecg', label: 'ECG', type: 'select', options: [
          { value: 0, label: 'Normal' },
          { value: 1, label: 'Non-specific repolarization' },
          { value: 2, label: 'Significant ST deviation' }
        ]},
        { id: 'age', label: 'Age', type: 'select', options: [
          { value: 0, label: '<45 years' },
          { value: 1, label: '45-64 years' },
          { value: 2, label: '≥65 years' }
        ]},
        { id: 'risk', label: 'Risk Factors', type: 'select', options: [
          { value: 0, label: 'No known risk factors' },
          { value: 1, label: '1-2 risk factors' },
          { value: 2, label: '≥3 risk factors or known CAD' }
        ]},
        { id: 'troponin', label: 'Initial Troponin', type: 'select', options: [
          { value: 0, label: '≤ normal limit' },
          { value: 1, label: '1-3x normal limit' },
          { value: 2, label: '>3x normal limit' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 3, risk: 'Low', action: 'Consider discharge with outpatient follow-up', color: '#10b981', mace: '0.9-1.7%' },
        { min: 4, max: 6, risk: 'Intermediate', action: 'Admit for observation and serial troponins', color: '#f59e0b', mace: '12-16.6%' },
        { min: 7, max: 10, risk: 'High', action: 'Early invasive strategy recommended', color: '#ef4444', mace: '50-65%' }
      ]
    },
    
    'TIMI': {
      name: 'TIMI Risk Score (NSTEMI)',
      category: 'Cardiac',
      purpose: 'Risk stratification for NSTEMI/UA',
      fields: [
        { id: 'age', label: 'Age ≥65', points: 1, type: 'checkbox' },
        { id: 'cad', label: '≥3 CAD risk factors', points: 1, type: 'checkbox' },
        { id: 'known_cad', label: 'Known CAD (stenosis ≥50%)', points: 1, type: 'checkbox' },
        { id: 'asa', label: 'ASA use in past 7 days', points: 1, type: 'checkbox' },
        { id: 'angina', label: '≥2 angina episodes in 24h', points: 1, type: 'checkbox' },
        { id: 'ecg', label: 'ST changes ≥0.5mm', points: 1, type: 'checkbox' },
        { id: 'biomarker', label: 'Elevated cardiac biomarkers', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 2, risk: 'Low', action: 'Conservative management may be appropriate', color: '#10b981', events: '4.7-8.3%' },
        { min: 3, max: 4, risk: 'Intermediate', action: 'Consider early invasive strategy', color: '#f59e0b', events: '13.2-19.9%' },
        { min: 5, max: 7, risk: 'High', action: 'Early invasive strategy strongly recommended', color: '#ef4444', events: '26.2-40.9%' }
      ]
    },
    
    'Killip': {
      name: 'Killip Classification',
      category: 'Cardiac',
      purpose: 'Heart failure severity in MI',
      fields: [
        { id: 'class', label: 'Clinical Findings', type: 'select', options: [
          { value: 1, label: 'Class I: No heart failure signs' },
          { value: 2, label: 'Class II: S3, rales <50% lung fields' },
          { value: 3, label: 'Class III: Pulmonary edema, rales >50%' },
          { value: 4, label: 'Class IV: Cardiogenic shock' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'Class I', action: 'Standard care', color: '#10b981', mortality: '6%' },
        { min: 2, max: 2, risk: 'Class II', action: 'Monitor closely, diuretics PRN', color: '#f59e0b', mortality: '17%' },
        { min: 3, max: 3, risk: 'Class III', action: 'ICU, aggressive treatment', color: '#ef4444', mortality: '38%' },
        { min: 4, max: 4, risk: 'Class IV', action: 'ICU, vasopressors, consider MCS', color: '#7f1d1d', mortality: '81%' }
      ]
    },
    
    'NYHA': {
      name: 'NYHA Functional Classification',
      category: 'Cardiac',
      purpose: 'Heart failure functional capacity',
      fields: [
        { id: 'class', label: 'Functional Limitation', type: 'select', options: [
          { value: 1, label: 'Class I: No limitation of physical activity' },
          { value: 2, label: 'Class II: Slight limitation; comfortable at rest' },
          { value: 3, label: 'Class III: Marked limitation; comfortable only at rest' },
          { value: 4, label: 'Class IV: Unable to carry on any activity without symptoms' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'Class I', action: 'Standard GDMT', color: '#10b981', mortality: '5-10%/yr' },
        { min: 2, max: 2, risk: 'Class II', action: 'GDMT optimization', color: '#22c55e', mortality: '10-15%/yr' },
        { min: 3, max: 3, risk: 'Class III', action: 'Consider device therapy', color: '#f59e0b', mortality: '15-25%/yr' },
        { min: 4, max: 4, risk: 'Class IV', action: 'Advanced therapies, transplant evaluation', color: '#ef4444', mortality: '50-75%/yr' }
      ]
    },
    
    // ═══ RESPIRATORY SCORES ═══
    'CURB-65': {
      name: 'CURB-65 Score',
      category: 'Respiratory',
      purpose: 'Pneumonia severity assessment',
      fields: [
        { id: 'confusion', label: 'Confusion (new onset)', points: 1, type: 'checkbox' },
        { id: 'urea', label: 'Urea >7 mmol/L (BUN >19)', points: 1, type: 'checkbox' },
        { id: 'rr', label: 'Respiratory rate ≥30/min', points: 1, type: 'checkbox' },
        { id: 'bp', label: 'BP: SBP <90 or DBP ≤60', points: 1, type: 'checkbox' },
        { id: 'age', label: 'Age ≥65 years', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'Consider outpatient treatment', color: '#10b981', mortality: '0.6-2.7%' },
        { min: 2, max: 2, risk: 'Moderate', action: 'Consider short hospitalization or close outpatient follow-up', color: '#f59e0b', mortality: '6.8%' },
        { min: 3, max: 5, risk: 'Severe', action: 'Hospitalize; consider ICU if score 4-5', color: '#ef4444', mortality: '14-27.8%' }
      ]
    },
    
    'Wells-PE': {
      name: 'Wells Score for PE',
      category: 'Respiratory',
      purpose: 'Pulmonary embolism probability',
      fields: [
        { id: 'dvt', label: 'Clinical signs/symptoms of DVT', points: 3, type: 'checkbox' },
        { id: 'alternative', label: 'PE is #1 diagnosis OR equally likely', points: 3, type: 'checkbox' },
        { id: 'hr', label: 'Heart rate >100', points: 1.5, type: 'checkbox' },
        { id: 'immobile', label: 'Immobilization ≥3 days or surgery in past 4 weeks', points: 1.5, type: 'checkbox' },
        { id: 'prior', label: 'Previous PE or DVT', points: 1.5, type: 'checkbox' },
        { id: 'hemoptysis', label: 'Hemoptysis', points: 1, type: 'checkbox' },
        { id: 'malignancy', label: 'Malignancy (treatment within 6 months)', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'D-dimer; if negative, PE excluded', color: '#10b981', probability: '1.3%' },
        { min: 2, max: 6, risk: 'Moderate', action: 'D-dimer; if positive, CTPA', color: '#f59e0b', probability: '16.2%' },
        { min: 7, max: 12.5, risk: 'High', action: 'CTPA recommended', color: '#ef4444', probability: '37.5%' }
      ]
    },
    
    'Wells-DVT': {
      name: 'Wells Score for DVT',
      category: 'Vascular',
      purpose: 'Deep vein thrombosis probability',
      fields: [
        { id: 'cancer', label: 'Active cancer', points: 1, type: 'checkbox' },
        { id: 'paralysis', label: 'Paralysis/paresis/recent cast', points: 1, type: 'checkbox' },
        { id: 'bedridden', label: 'Bedridden >3 days or major surgery <12 weeks', points: 1, type: 'checkbox' },
        { id: 'tenderness', label: 'Localized tenderness along deep veins', points: 1, type: 'checkbox' },
        { id: 'swelling', label: 'Entire leg swollen', points: 1, type: 'checkbox' },
        { id: 'calf', label: 'Calf swelling >3 cm vs other leg', points: 1, type: 'checkbox' },
        { id: 'edema', label: 'Pitting edema (symptomatic leg only)', points: 1, type: 'checkbox' },
        { id: 'collateral', label: 'Collateral superficial veins', points: 1, type: 'checkbox' },
        { id: 'prior', label: 'Previously documented DVT', points: 1, type: 'checkbox' },
        { id: 'alternative', label: 'Alternative diagnosis as likely as DVT', points: -2, type: 'checkbox' }
      ],
      interpretation: [
        { min: -2, max: 0, risk: 'Low', action: 'D-dimer; if negative, DVT excluded', color: '#10b981', probability: '5%' },
        { min: 1, max: 2, risk: 'Moderate', action: 'D-dimer; if positive, ultrasound', color: '#f59e0b', probability: '17%' },
        { min: 3, max: 9, risk: 'High', action: 'Ultrasound recommended', color: '#ef4444', probability: '53%' }
      ]
    },
    
    'PESI': {
      name: 'PESI Score (Simplified)',
      category: 'Respiratory',
      purpose: 'PE mortality risk stratification',
      fields: [
        { id: 'age', label: 'Age >80 years', points: 1, type: 'checkbox' },
        { id: 'cancer', label: 'History of cancer', points: 1, type: 'checkbox' },
        { id: 'chf', label: 'Chronic cardiopulmonary disease', points: 1, type: 'checkbox' },
        { id: 'hr', label: 'Heart rate ≥110', points: 1, type: 'checkbox' },
        { id: 'sbp', label: 'SBP <100 mmHg', points: 1, type: 'checkbox' },
        { id: 'sao2', label: 'O₂ saturation <90%', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Low', action: 'Consider outpatient treatment', color: '#10b981', mortality: '1.0%' },
        { min: 1, max: 6, risk: 'High', action: 'Hospitalization recommended', color: '#ef4444', mortality: '10.9%' }
      ]
    },
    
    // ═══ NEUROLOGICAL SCORES ═══
    'Glasgow-Coma': {
      name: 'Glasgow Coma Scale',
      category: 'Neurological',
      purpose: 'Level of consciousness assessment',
      fields: [
        { id: 'eye', label: 'Eye Opening', type: 'select', options: [
          { value: 1, label: '1 - No response' },
          { value: 2, label: '2 - To pain' },
          { value: 3, label: '3 - To voice' },
          { value: 4, label: '4 - Spontaneous' }
        ]},
        { id: 'verbal', label: 'Verbal Response', type: 'select', options: [
          { value: 1, label: '1 - No response' },
          { value: 2, label: '2 - Incomprehensible sounds' },
          { value: 3, label: '3 - Inappropriate words' },
          { value: 4, label: '4 - Confused' },
          { value: 5, label: '5 - Oriented' }
        ]},
        { id: 'motor', label: 'Motor Response', type: 'select', options: [
          { value: 1, label: '1 - No response' },
          { value: 2, label: '2 - Extension to pain' },
          { value: 3, label: '3 - Flexion to pain' },
          { value: 4, label: '4 - Withdrawal from pain' },
          { value: 5, label: '5 - Localizes pain' },
          { value: 6, label: '6 - Obeys commands' }
        ]}
      ],
      interpretation: [
        { min: 3, max: 8, risk: 'Severe', action: 'Intubation usually indicated', color: '#ef4444', note: 'Coma' },
        { min: 9, max: 12, risk: 'Moderate', action: 'Close monitoring required', color: '#f59e0b', note: 'Impaired' },
        { min: 13, max: 15, risk: 'Minor', action: 'Generally good prognosis', color: '#10b981', note: 'Minor injury' }
      ]
    },
    
    'NIHSS': {
      name: 'NIH Stroke Scale',
      category: 'Neurological',
      purpose: 'Stroke severity assessment',
      fields: [
        { id: 'loc', label: '1a. Level of Consciousness', type: 'select', options: [
          { value: 0, label: '0 - Alert' },
          { value: 1, label: '1 - Not alert, arousable' },
          { value: 2, label: '2 - Not alert, requires repeated stimulation' },
          { value: 3, label: '3 - Unresponsive' }
        ]},
        { id: 'loc_q', label: '1b. LOC Questions (month, age)', type: 'select', options: [
          { value: 0, label: '0 - Both correct' },
          { value: 1, label: '1 - One correct' },
          { value: 2, label: '2 - Neither correct' }
        ]},
        { id: 'loc_c', label: '1c. LOC Commands (open/close eyes, grip)', type: 'select', options: [
          { value: 0, label: '0 - Both correct' },
          { value: 1, label: '1 - One correct' },
          { value: 2, label: '2 - Neither correct' }
        ]},
        { id: 'gaze', label: '2. Best Gaze', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Partial gaze palsy' },
          { value: 2, label: '2 - Forced deviation' }
        ]},
        { id: 'visual', label: '3. Visual Fields', type: 'select', options: [
          { value: 0, label: '0 - No visual loss' },
          { value: 1, label: '1 - Partial hemianopia' },
          { value: 2, label: '2 - Complete hemianopia' },
          { value: 3, label: '3 - Bilateral hemianopia' }
        ]},
        { id: 'facial', label: '4. Facial Palsy', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Minor paralysis' },
          { value: 2, label: '2 - Partial paralysis' },
          { value: 3, label: '3 - Complete paralysis' }
        ]},
        { id: 'motor_arm', label: '5. Motor Arm (worse side)', type: 'select', options: [
          { value: 0, label: '0 - No drift' },
          { value: 1, label: '1 - Drift before 10 seconds' },
          { value: 2, label: '2 - Falls before 10 seconds' },
          { value: 3, label: '3 - No effort against gravity' },
          { value: 4, label: '4 - No movement' }
        ]},
        { id: 'motor_leg', label: '6. Motor Leg (worse side)', type: 'select', options: [
          { value: 0, label: '0 - No drift' },
          { value: 1, label: '1 - Drift before 5 seconds' },
          { value: 2, label: '2 - Falls before 5 seconds' },
          { value: 3, label: '3 - No effort against gravity' },
          { value: 4, label: '4 - No movement' }
        ]},
        { id: 'ataxia', label: '7. Limb Ataxia', type: 'select', options: [
          { value: 0, label: '0 - Absent' },
          { value: 1, label: '1 - Present in one limb' },
          { value: 2, label: '2 - Present in two limbs' }
        ]},
        { id: 'sensory', label: '8. Sensory', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Mild-moderate loss' },
          { value: 2, label: '2 - Severe or total loss' }
        ]},
        { id: 'language', label: '9. Best Language', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Mild-moderate aphasia' },
          { value: 2, label: '2 - Severe aphasia' },
          { value: 3, label: '3 - Mute/global aphasia' }
        ]},
        { id: 'dysarthria', label: '10. Dysarthria', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Mild-moderate' },
          { value: 2, label: '2 - Severe/unintelligible' }
        ]},
        { id: 'neglect', label: '11. Extinction/Neglect', type: 'select', options: [
          { value: 0, label: '0 - No abnormality' },
          { value: 1, label: '1 - Mild (one modality)' },
          { value: 2, label: '2 - Severe (more than one modality)' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 4, risk: 'Minor', action: 'May not benefit from thrombolysis', color: '#10b981', outcome: 'Good' },
        { min: 5, max: 15, risk: 'Moderate', action: 'Consider thrombolysis if eligible', color: '#f59e0b', outcome: 'Variable' },
        { min: 16, max: 20, risk: 'Moderate-Severe', action: 'Thrombolysis if eligible; higher hemorrhage risk', color: '#f97316', outcome: 'Guarded' },
        { min: 21, max: 42, risk: 'Severe', action: 'Poor prognosis; discuss goals of care', color: '#ef4444', outcome: 'Poor' }
      ]
    },
    
    'ABCD2': {
      name: 'ABCD² Score',
      category: 'Neurological',
      purpose: 'Stroke risk after TIA',
      fields: [
        { id: 'age', label: 'Age ≥60 years', points: 1, type: 'checkbox' },
        { id: 'bp', label: 'BP ≥140/90 mmHg', points: 1, type: 'checkbox' },
        { id: 'weakness', label: 'Unilateral weakness', points: 2, type: 'checkbox' },
        { id: 'speech', label: 'Speech impairment without weakness', points: 1, type: 'checkbox' },
        { id: 'duration60', label: 'Duration ≥60 min', points: 2, type: 'checkbox' },
        { id: 'duration10', label: 'Duration 10-59 min', points: 1, type: 'checkbox' },
        { id: 'dm', label: 'Diabetes', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 3, risk: 'Low', action: 'Outpatient workup may be appropriate', color: '#10b981', stroke_2d: '1.0%' },
        { min: 4, max: 5, risk: 'Moderate', action: 'Consider hospitalization', color: '#f59e0b', stroke_2d: '4.1%' },
        { min: 6, max: 7, risk: 'High', action: 'Hospitalization recommended', color: '#ef4444', stroke_2d: '8.1%' }
      ]
    },
    
    // ═══ GI/HEPATIC SCORES ═══
    'Glasgow-Blatchford': {
      name: 'Glasgow-Blatchford Score',
      category: 'GI',
      purpose: 'Upper GI bleed risk stratification',
      fields: [
        { id: 'bun', label: 'BUN (mmol/L)', type: 'select', options: [
          { value: 0, label: '<6.5' },
          { value: 2, label: '6.5-7.9' },
          { value: 3, label: '8.0-9.9' },
          { value: 4, label: '10.0-24.9' },
          { value: 6, label: '≥25' }
        ]},
        { id: 'hgb_male', label: 'Hemoglobin - Male (g/dL)', type: 'select', options: [
          { value: 0, label: '≥13' },
          { value: 1, label: '12.0-12.9' },
          { value: 3, label: '10.0-11.9' },
          { value: 6, label: '<10' }
        ]},
        { id: 'hgb_female', label: 'Hemoglobin - Female (g/dL)', type: 'select', options: [
          { value: 0, label: '≥12' },
          { value: 1, label: '10.0-11.9' },
          { value: 6, label: '<10' }
        ]},
        { id: 'sbp', label: 'Systolic BP', type: 'select', options: [
          { value: 0, label: '≥110' },
          { value: 1, label: '100-109' },
          { value: 2, label: '90-99' },
          { value: 3, label: '<90' }
        ]},
        { id: 'pulse', label: 'Pulse ≥100', points: 1, type: 'checkbox' },
        { id: 'melena', label: 'Melena', points: 1, type: 'checkbox' },
        { id: 'syncope', label: 'Syncope', points: 2, type: 'checkbox' },
        { id: 'liver', label: 'Hepatic disease', points: 2, type: 'checkbox' },
        { id: 'hf', label: 'Heart failure', points: 2, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Very Low', action: 'May be managed as outpatient', color: '#10b981', intervention: '0.5%' },
        { min: 1, max: 5, risk: 'Low', action: 'Consider admission, likely no intervention', color: '#22c55e', intervention: '5%' },
        { min: 6, max: 11, risk: 'Moderate', action: 'Admission, endoscopy within 24h', color: '#f59e0b', intervention: '25%' },
        { min: 12, max: 23, risk: 'High', action: 'ICU admission, urgent endoscopy', color: '#ef4444', intervention: '>50%' }
      ]
    },
    
    'Child-Pugh': {
      name: 'Child-Pugh Score',
      category: 'GI',
      purpose: 'Cirrhosis severity and prognosis',
      fields: [
        { id: 'encephalopathy', label: 'Encephalopathy', type: 'select', options: [
          { value: 1, label: 'None' },
          { value: 2, label: 'Grade 1-2 (controlled)' },
          { value: 3, label: 'Grade 3-4 (poorly controlled)' }
        ]},
        { id: 'ascites', label: 'Ascites', type: 'select', options: [
          { value: 1, label: 'None' },
          { value: 2, label: 'Mild/controlled with diuretics' },
          { value: 3, label: 'Moderate-severe/refractory' }
        ]},
        { id: 'bilirubin', label: 'Bilirubin (mg/dL)', type: 'select', options: [
          { value: 1, label: '<2' },
          { value: 2, label: '2-3' },
          { value: 3, label: '>3' }
        ]},
        { id: 'albumin', label: 'Albumin (g/dL)', type: 'select', options: [
          { value: 1, label: '>3.5' },
          { value: 2, label: '2.8-3.5' },
          { value: 3, label: '<2.8' }
        ]},
        { id: 'inr', label: 'INR', type: 'select', options: [
          { value: 1, label: '<1.7' },
          { value: 2, label: '1.7-2.3' },
          { value: 3, label: '>2.3' }
        ]}
      ],
      interpretation: [
        { min: 5, max: 6, risk: 'Class A', action: 'Well-compensated; standard care', color: '#10b981', survival_1y: '100%', survival_2y: '85%' },
        { min: 7, max: 9, risk: 'Class B', action: 'Significant functional compromise', color: '#f59e0b', survival_1y: '81%', survival_2y: '57%' },
        { min: 10, max: 15, risk: 'Class C', action: 'Decompensated; consider transplant evaluation', color: '#ef4444', survival_1y: '45%', survival_2y: '35%' }
      ]
    },
    
    'MELD': {
      name: 'MELD Score',
      category: 'GI',
      purpose: 'End-stage liver disease severity',
      fields: [
        { id: 'creatinine', label: 'Creatinine (mg/dL)', type: 'number', min: 0.1, max: 10, step: 0.1 },
        { id: 'bilirubin', label: 'Bilirubin (mg/dL)', type: 'number', min: 0.1, max: 50, step: 0.1 },
        { id: 'inr', label: 'INR', type: 'number', min: 0.5, max: 10, step: 0.1 },
        { id: 'dialysis', label: 'Dialysis (at least 2x/week)', points: 0, type: 'checkbox' }
      ],
      formula: 'MELD = 10 × (0.957 × ln(Cr) + 0.378 × ln(Bili) + 1.12 × ln(INR) + 0.643)',
      interpretation: [
        { min: 6, max: 9, risk: 'Low', action: 'Standard care', color: '#10b981', mortality_3m: '1.9%' },
        { min: 10, max: 19, risk: 'Moderate', action: 'Close monitoring', color: '#f59e0b', mortality_3m: '6.0%' },
        { min: 20, max: 29, risk: 'High', action: 'Consider transplant listing', color: '#f97316', mortality_3m: '19.6%' },
        { min: 30, max: 40, risk: 'Very High', action: 'High priority for transplant', color: '#ef4444', mortality_3m: '52.6%' }
      ]
    },
    
    // ═══ SEPSIS/CRITICAL CARE SCORES ═══
    'qSOFA': {
      name: 'qSOFA Score',
      category: 'Critical Care',
      purpose: 'Quick sepsis screening',
      fields: [
        { id: 'rr', label: 'Respiratory rate ≥22/min', points: 1, type: 'checkbox' },
        { id: 'mental', label: 'Altered mental status (GCS <15)', points: 1, type: 'checkbox' },
        { id: 'sbp', label: 'Systolic BP ≤100 mmHg', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'Low risk; monitor clinically', color: '#10b981', note: 'Not qSOFA positive' },
        { min: 2, max: 3, risk: 'High', action: 'High risk of poor outcome; consider ICU, calculate full SOFA', color: '#ef4444', note: 'qSOFA positive' }
      ]
    },
    
    'SOFA': {
      name: 'SOFA Score',
      category: 'Critical Care',
      purpose: 'Sequential Organ Failure Assessment',
      fields: [
        { id: 'pao2', label: 'PaO₂/FiO₂ (Respiration)', type: 'select', options: [
          { value: 0, label: '≥400' },
          { value: 1, label: '300-399' },
          { value: 2, label: '200-299' },
          { value: 3, label: '100-199 with respiratory support' },
          { value: 4, label: '<100 with respiratory support' }
        ]},
        { id: 'platelets', label: 'Platelets (×10³/μL)', type: 'select', options: [
          { value: 0, label: '≥150' },
          { value: 1, label: '100-149' },
          { value: 2, label: '50-99' },
          { value: 3, label: '20-49' },
          { value: 4, label: '<20' }
        ]},
        { id: 'bilirubin', label: 'Bilirubin (mg/dL)', type: 'select', options: [
          { value: 0, label: '<1.2' },
          { value: 1, label: '1.2-1.9' },
          { value: 2, label: '2.0-5.9' },
          { value: 3, label: '6.0-11.9' },
          { value: 4, label: '≥12' }
        ]},
        { id: 'map', label: 'Cardiovascular (MAP/Vasopressors)', type: 'select', options: [
          { value: 0, label: 'MAP ≥70, no vasopressors' },
          { value: 1, label: 'MAP <70, no vasopressors' },
          { value: 2, label: 'Dopamine ≤5 or dobutamine any dose' },
          { value: 3, label: 'Dopamine >5 or epi/norepi ≤0.1' },
          { value: 4, label: 'Dopamine >15 or epi/norepi >0.1' }
        ]},
        { id: 'gcs', label: 'Glasgow Coma Scale', type: 'select', options: [
          { value: 0, label: '15' },
          { value: 1, label: '13-14' },
          { value: 2, label: '10-12' },
          { value: 3, label: '6-9' },
          { value: 4, label: '<6' }
        ]},
        { id: 'creatinine', label: 'Creatinine (mg/dL) or Urine Output', type: 'select', options: [
          { value: 0, label: '<1.2' },
          { value: 1, label: '1.2-1.9' },
          { value: 2, label: '2.0-3.4' },
          { value: 3, label: '3.5-4.9 or UO <500 mL/day' },
          { value: 4, label: '≥5.0 or UO <200 mL/day' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 6, risk: 'Low', action: 'Mortality <10%', color: '#10b981', mortality: '<10%' },
        { min: 7, max: 9, risk: 'Moderate', action: 'Mortality 15-20%', color: '#f59e0b', mortality: '15-20%' },
        { min: 10, max: 12, risk: 'High', action: 'Mortality 40-50%', color: '#f97316', mortality: '40-50%' },
        { min: 13, max: 24, risk: 'Very High', action: 'Mortality >80%', color: '#ef4444', mortality: '>80%' }
      ]
    },
    
    'NEWS2': {
      name: 'NEWS2 Score',
      category: 'Critical Care',
      purpose: 'National Early Warning Score',
      fields: [
        { id: 'rr', label: 'Respiratory Rate', type: 'select', options: [
          { value: 3, label: '≤8' },
          { value: 1, label: '9-11' },
          { value: 0, label: '12-20' },
          { value: 2, label: '21-24' },
          { value: 3, label: '≥25' }
        ]},
        { id: 'spo2', label: 'SpO₂ Scale 1 (no COPD)', type: 'select', options: [
          { value: 3, label: '≤91%' },
          { value: 2, label: '92-93%' },
          { value: 1, label: '94-95%' },
          { value: 0, label: '≥96%' }
        ]},
        { id: 'air', label: 'Air or Oxygen', type: 'select', options: [
          { value: 0, label: 'Air' },
          { value: 2, label: 'Oxygen' }
        ]},
        { id: 'sbp', label: 'Systolic BP', type: 'select', options: [
          { value: 3, label: '≤90' },
          { value: 2, label: '91-100' },
          { value: 1, label: '101-110' },
          { value: 0, label: '111-219' },
          { value: 3, label: '≥220' }
        ]},
        { id: 'pulse', label: 'Pulse', type: 'select', options: [
          { value: 3, label: '≤40' },
          { value: 1, label: '41-50' },
          { value: 0, label: '51-90' },
          { value: 1, label: '91-110' },
          { value: 2, label: '111-130' },
          { value: 3, label: '≥131' }
        ]},
        { id: 'consciousness', label: 'Consciousness', type: 'select', options: [
          { value: 0, label: 'Alert' },
          { value: 3, label: 'CVPU (Confusion, Voice, Pain, Unresponsive)' }
        ]},
        { id: 'temp', label: 'Temperature', type: 'select', options: [
          { value: 3, label: '≤35.0°C' },
          { value: 1, label: '35.1-36.0°C' },
          { value: 0, label: '36.1-38.0°C' },
          { value: 1, label: '38.1-39.0°C' },
          { value: 2, label: '≥39.1°C' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 4, risk: 'Low', action: 'Standard ward care; reassess per protocol', color: '#10b981', frequency: 'Q12h' },
        { min: 5, max: 6, risk: 'Medium', action: 'Urgent ward-based response', color: '#f59e0b', frequency: 'Q1h' },
        { min: 7, max: 20, risk: 'High', action: 'Emergency response; consider ICU', color: '#ef4444', frequency: 'Continuous' }
      ]
    },
    
    // ═══ RENAL SCORES ═══
    'KDIGO-AKI': {
      name: 'KDIGO AKI Staging',
      category: 'Renal',
      purpose: 'Acute kidney injury classification',
      fields: [
        { id: 'stage', label: 'AKI Stage', type: 'select', options: [
          { value: 1, label: 'Stage 1: Cr ↑ ≥0.3 mg/dL or 1.5-1.9× baseline, UO <0.5 mL/kg/h for 6-12h' },
          { value: 2, label: 'Stage 2: Cr 2.0-2.9× baseline, UO <0.5 mL/kg/h for ≥12h' },
          { value: 3, label: 'Stage 3: Cr ≥3× baseline or ≥4 mg/dL, UO <0.3 mL/kg/h for ≥24h or anuria ≥12h, or RRT initiation' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'Stage 1', action: 'Optimize volume, avoid nephrotoxins, monitor', color: '#f59e0b', note: 'Mild AKI' },
        { min: 2, max: 2, risk: 'Stage 2', action: 'Consider nephrology consult', color: '#f97316', note: 'Moderate AKI' },
        { min: 3, max: 3, risk: 'Stage 3', action: 'Nephrology consult, consider RRT', color: '#ef4444', note: 'Severe AKI' }
      ]
    },
    
    // ═══ SURGICAL/PERIOPERATIVE SCORES ═══
    'Caprini': {
      name: 'Caprini VTE Risk Score',
      category: 'Surgical',
      purpose: 'VTE risk in surgical patients',
      fields: [
        { id: 'age41', label: 'Age 41-60', points: 1, type: 'checkbox' },
        { id: 'age61', label: 'Age 61-74', points: 2, type: 'checkbox' },
        { id: 'age75', label: 'Age ≥75', points: 3, type: 'checkbox' },
        { id: 'minor_surgery', label: 'Minor surgery planned', points: 1, type: 'checkbox' },
        { id: 'major_surgery', label: 'Major surgery (>45 min)', points: 2, type: 'checkbox' },
        { id: 'obesity', label: 'BMI >25', points: 1, type: 'checkbox' },
        { id: 'swelling', label: 'Leg swelling', points: 1, type: 'checkbox' },
        { id: 'varicose', label: 'Varicose veins', points: 1, type: 'checkbox' },
        { id: 'chf', label: 'Heart failure', points: 1, type: 'checkbox' },
        { id: 'sepsis', label: 'Sepsis (<1 month)', points: 1, type: 'checkbox' },
        { id: 'pneumonia', label: 'Serious lung disease', points: 1, type: 'checkbox' },
        { id: 'pregnant', label: 'Pregnancy/postpartum', points: 1, type: 'checkbox' },
        { id: 'bedrest', label: 'Bed rest', points: 1, type: 'checkbox' },
        { id: 'immobile', label: 'Immobilizing cast', points: 2, type: 'checkbox' },
        { id: 'central_line', label: 'Central venous access', points: 2, type: 'checkbox' },
        { id: 'malignancy', label: 'Malignancy (present/previous)', points: 2, type: 'checkbox' },
        { id: 'prior_vte', label: 'History of DVT/PE', points: 3, type: 'checkbox' },
        { id: 'family_vte', label: 'Family history of VTE', points: 3, type: 'checkbox' },
        { id: 'factor_v', label: 'Factor V Leiden or other thrombophilia', points: 3, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke (<1 month)', points: 5, type: 'checkbox' },
        { id: 'hip_knee', label: 'Hip/knee arthroplasty', points: 5, type: 'checkbox' },
        { id: 'fracture', label: 'Hip, pelvis, or leg fracture', points: 5, type: 'checkbox' },
        { id: 'sci', label: 'Acute spinal cord injury', points: 5, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Very Low', action: 'Early ambulation', color: '#10b981', vte_risk: '0.5%' },
        { min: 2, max: 2, risk: 'Low', action: 'Pneumatic compression devices', color: '#22c55e', vte_risk: '1.5%' },
        { min: 3, max: 4, risk: 'Moderate', action: 'Pharmacologic prophylaxis', color: '#f59e0b', vte_risk: '3%' },
        { min: 5, max: 100, risk: 'High', action: 'Pharmacologic prophylaxis + mechanical', color: '#ef4444', vte_risk: '6%' }
      ]
    },
    
    'ASA': {
      name: 'ASA Physical Status',
      category: 'Surgical',
      purpose: 'Preoperative risk classification',
      fields: [
        { id: 'class', label: 'ASA Class', type: 'select', options: [
          { value: 1, label: 'ASA I: Healthy patient' },
          { value: 2, label: 'ASA II: Mild systemic disease' },
          { value: 3, label: 'ASA III: Severe systemic disease' },
          { value: 4, label: 'ASA IV: Life-threatening disease' },
          { value: 5, label: 'ASA V: Moribund, not expected to survive' },
          { value: 6, label: 'ASA VI: Brain-dead organ donor' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'ASA I', action: 'Proceed with standard care', color: '#10b981', mortality: '0.06%' },
        { min: 2, max: 2, risk: 'ASA II', action: 'Proceed with standard care', color: '#22c55e', mortality: '0.5%' },
        { min: 3, max: 3, risk: 'ASA III', action: 'Close perioperative monitoring', color: '#f59e0b', mortality: '2.2%' },
        { min: 4, max: 4, risk: 'ASA IV', action: 'Consider risk vs benefit carefully', color: '#f97316', mortality: '7.8%' },
        { min: 5, max: 5, risk: 'ASA V', action: 'Surgery only if life-saving', color: '#ef4444', mortality: '51%' }
      ]
    }
  },
  
  REFS: [
    { title: '🚨 Critical Labs', content: '<b>K:</b> <2.5 or >6.5<br><b>Na:</b> <120 or >160<br><b>Glucose:</b> <40 or >500' },
    { title: '⚡ Hyperkalemia', content: '<b>Stabilize:</b> Ca gluconate 1g<br><b>Shift:</b> Insulin + D50<br><b>Remove:</b> Kayexalate' },
    { title: '❤️ ACS', content: '<b>MONA:</b> Morphine, O₂, Nitrates, ASA<br><b>STEMI:</b> PCI <90min' },
    { title: '🧠 Stroke tPA', content: '<b>Window:</b> ≤4.5h<br><b>Dose:</b> 0.9mg/kg max 90mg' },
    { title: '🦠 Sepsis', content: '<b>Hour-1:</b> Lactate, cultures, abx<br><b>Fluids:</b> 30mL/kg' },
    { title: '💊 Status Epilepticus', content: '<b>1st:</b> Lorazepam 4mg<br><b>2nd:</b> Levetiracetam 60mg/kg' }
  ]
};

const state = {
  units: [], settings: {}, patients: [], currentUnit: null, currentUser: null, currentPatient: null,
  selectedUnitId: null, editingUnitId: null, importImage: null, importPatients: [], currentFilter: 'all',
  fluidChart: null, trendChart: null, addDataType: null, isAnalyzingLab: false, isAnalyzingImaging: false,
  currentInteractionId: null, sessionId: null, unitRequests: [], selectedRequestId: null, selectedIcon: '🏥',
  pendingLabData: null, labExtractionConfidence: 0, isAnalyzingMeds: false, dischargePatientId: null,
  medSearchTerm: '', editingMedIdx: null
};

// Generate session ID
state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

// Sync state tracking for reactive auto-sync
let syncState = {
  status: 'synced',
  lastSyncTime: null,
  pendingChanges: false,
  syncTimeout: null,
  errorCount: 0
};

const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = t => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
const initials = n => { if (!n) return '?'; const p = n.trim().split(/\s+/); return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : n.substring(0, 2).toUpperCase(); };

// ═══════════════════════════════════════════════════════════════════
// TOUCH SUPPORT - Simplified: Just use CSS + standard onclick
// ═══════════════════════════════════════════════════════════════════

// Navigation lock to prevent double-firing
let isNavigating = false;

function safeNavigate(url) {
  if (isNavigating) return;
  isNavigating = true;
  
  setTimeout(() => {
    window.location.href = url;
  }, 100);
  
  // Reset after 2 seconds in case navigation fails
  setTimeout(() => { isNavigating = false; }, 2000);
}

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }
window.closeModal = closeModal;

function showPage(pageId) {
  $$('.page').forEach(p => p.classList.remove('active'));
  $(pageId).classList.add('active');
}

function formatDate(d) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  d = d || new Date();
  return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

function formatDateTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatShortDate(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function compress(file, max, cb) {
  const r = new FileReader();
  r.onload = e => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas'), ctx = c.getContext('2d');
      let w = img.width, h = img.height, q = CONFIG.IMAGE_QUALITY;
      if (w > CONFIG.MAX_DIM || h > CONFIG.MAX_DIM) {
        if (w > h) { h = Math.round(h * CONFIG.MAX_DIM / w); w = CONFIG.MAX_DIM; }
        else { w = Math.round(w * CONFIG.MAX_DIM / h); h = CONFIG.MAX_DIM; }
      }
      c.width = w; c.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      let url = c.toDataURL('image/jpeg', q);
      while (url.length > max && q > 0.3) { q -= 0.1; url = c.toDataURL('image/jpeg', q); }
      cb(url);
    };
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}

function smartWard(raw) {
  if (!raw) return 'Ward 14';
  const w = String(raw).toLowerCase();
  if (w.includes('14')) return 'Ward 14';
  if (w.includes('22')) return 'Ward 22';
  if (w.includes('27')) return 'Ward 27';
  if (w.includes('icu')) return 'ICU';
  if (w.includes('er') || w.includes('unassign')) return 'ER/Unassigned';
  return 'Ward 14';
}

function getLabCategory(name) {
  const n = (name || '').toLowerCase();
  for (const [cat, data] of Object.entries(CONFIG.LAB_CATEGORIES)) {
    if (data.terms.some(t => n.includes(t.toLowerCase()))) return cat;
  }
  return 'Other';
}

// ═══════════════════════════════════════════════════════════════════
// STORAGE
// ═══════════════════════════════════════════════════════════════════

let isSyncing = false;

function loadLocal() {
  try {
    const s = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (s) {
      const d = JSON.parse(s);
      if (d.units?.length) state.units = d.units;
      if (d.settings) state.settings = { ...state.settings, ...d.settings };
      if (d.patients) state.patients = d.patients;
      if (d.unitRequests) state.unitRequests = d.unitRequests;
    }
  } catch (e) {}
  if (!state.units.length) state.units = [{ id: 'med-e', name: 'Medicine Unit E', icon: '🏥', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }];
  state.settings.adminPassword = state.settings.adminPassword || CONFIG.ADMIN_PASSWORD;
  // Always use hardcoded API URL - this ensures all users have the correct endpoint
  state.settings.apiUrl = CONFIG.API_URL;
}

function saveLocal() {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
      units: state.units, settings: state.settings, patients: state.patients, unitRequests: state.unitRequests, lastUpdated: new Date().toISOString()
    }));
  } catch (e) {}
}

async function syncCloud() {
  // Redirect to new system
  await syncFromCloud();
}

// ═══════════════════════════════════════════════════════════════════
// REACTIVE AUTO-SYNC SYSTEM
// ═══════════════════════════════════════════════════════════════════

function updateSyncStatus(status, message) {
  syncState.status = status;
  const el = $('syncStatus');
  const textEl = $('syncStatusText');
  
  if (!el || !textEl) return;
  
  el.className = 'sync-status visible ' + status;
  textEl.textContent = message || {
    synced: 'Synced',
    pending: 'Saving...',
    syncing: 'Syncing...',
    error: 'Sync failed'
  }[status];
  
  if (status === 'synced') {
    setTimeout(() => {
      if (syncState.status === 'synced') {
        el.classList.remove('visible');
      }
    }, 2000);
  }
}

function markDirty() {
  syncState.pendingChanges = true;
  updateSyncStatus('pending', 'Saving...');
  
  if (syncState.syncTimeout) {
    clearTimeout(syncState.syncTimeout);
  }
  
  syncState.syncTimeout = setTimeout(() => {
    performSync();
  }, CONFIG.SYNC_DEBOUNCE_MS);
}

async function performSync() {
  if (!syncState.pendingChanges) return;
  
  // Always save locally first
  saveLocal();
  
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    syncState.pendingChanges = false;
    updateSyncStatus('synced', 'Saved locally');
    return;
  }
  
  updateSyncStatus('syncing', 'Syncing to cloud...');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'saveData',
        payload: { 
          units: state.units, 
          settings: { 
            adminPassword: state.settings.adminPassword,
            apiUrl: state.settings.apiUrl  // Include API URL so all users get it
          }, 
          patients: state.patients,
          unitRequests: state.unitRequests
        }
      })
    });
    
    if (!res.ok) throw new Error('HTTP ' + res.status);
    
    syncState.pendingChanges = false;
    syncState.lastSyncTime = Date.now();
    syncState.errorCount = 0;
    updateSyncStatus('synced', 'Synced');
    
  } catch (e) {
    console.error('Sync error:', e);
    syncState.errorCount++;
    
    if (syncState.errorCount >= 3) {
      updateSyncStatus('error', 'Sync failed - check connection');
    } else {
      setTimeout(() => performSync(), 5000);
      updateSyncStatus('pending', 'Retrying...');
    }
  }
}

async function saveCloud() {
  markDirty();
}

// Force immediate sync - bypasses debounce for critical operations like lab saves
async function forceSync() {
  // Clear any pending debounced sync
  if (syncState.syncTimeout) {
    clearTimeout(syncState.syncTimeout);
    syncState.syncTimeout = null;
  }
  
  // Save locally first
  saveLocal();
  
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    console.log('⚠️ No API URL configured - saved locally only');
    updateSyncStatus('synced', 'Saved locally');
    return true;
  }
  
  updateSyncStatus('syncing', 'Saving to cloud...');
  console.log('☁️ Force syncing to cloud...');
  console.log('📦 Patients to save:', state.patients.length);
  
  // Log lab data for debugging
  state.patients.forEach(p => {
    if (p.labData?.parameters?.length) {
      console.log(`   Patient ${p.name}: ${p.labData.parameters.length} lab parameters`);
    }
  });
  
  try {
    const payload = { 
      units: state.units, 
      settings: { 
        adminPassword: state.settings.adminPassword,
        apiUrl: state.settings.apiUrl  // Include API URL so all users get it
      }, 
      patients: state.patients,
      unitRequests: state.unitRequests
    };
    
    console.log('📤 Sending payload size:', JSON.stringify(payload).length, 'bytes');
    
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'saveData',
        payload: payload
      })
    });
    
    const responseText = await res.text();
    console.log('📥 Response:', responseText);
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error('Invalid response: ' + responseText.substring(0, 100));
    }
    
    if (!res.ok || !result.success) {
      throw new Error(result.error || 'Save failed');
    }
    
    syncState.pendingChanges = false;
    syncState.lastSyncTime = Date.now();
    syncState.errorCount = 0;
    updateSyncStatus('synced', 'Synced');
    console.log('✅ Sync successful at', result.timestamp);
    return true;
    
  } catch (e) {
    console.error('❌ Sync error:', e);
    syncState.errorCount++;
    updateSyncStatus('error', 'Sync failed: ' + e.message);
    toast('Failed to save to cloud: ' + e.message, true);
    return false;
  }
}

async function manualSync() {
  const syncFab = $('syncFab');
  syncFab.classList.add('syncing');
  updateSyncStatus('syncing', 'Syncing...');
  
  try {
    await syncFromCloud();
    syncState.pendingChanges = true;
    await performSync();
    toast('Synced successfully!');
  } catch (e) {
    toast('Sync failed', true);
  }
  
  syncFab.classList.remove('syncing');
}

async function syncFromCloud() {
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') return;
  
  console.log('🔄 Loading data from cloud...');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'loadData' })
    });
    
    const data = await res.json();
    console.log('📥 Cloud data received:', data.success ? 'success' : 'failed');
    
    if (data.success && data.data) {
      // Update units
      if (data.data.units?.length) {
        state.units = data.data.units;
        console.log('   Units loaded:', state.units.length);
      }
      
      // Update settings - IMPORTANT: preserve local apiUrl if cloud doesn't have it
      if (data.data.settings) {
        const cloudApiUrl = data.data.settings.apiUrl;
        state.settings = { ...state.settings, ...data.data.settings };
        // If cloud has apiUrl, use it; otherwise keep local
        if (cloudApiUrl && cloudApiUrl !== 'YOUR_API_URL_HERE') {
          state.settings.apiUrl = cloudApiUrl;
        }
        console.log('   Settings loaded, apiUrl:', state.settings.apiUrl ? 'configured' : 'not set');
      }
      
      // Update patients - THIS IS KEY FOR MULTI-USER SYNC
      if (data.data.patients) {
        state.patients = data.data.patients;
        console.log('   Patients loaded:', state.patients.length);
        
        // Log lab data for debugging
        state.patients.forEach(p => {
          if (p.labData?.parameters?.length) {
            console.log(`   → ${p.name}: ${p.labData.parameters.length} lab parameters`);
          }
        });
        
        // If we have a current patient open, refresh their reference
        if (state.currentPatient) {
          const refreshedPatient = state.patients.find(p => p.id === state.currentPatient.id);
          if (refreshedPatient) {
            state.currentPatient = refreshedPatient;
            console.log('   Current patient refreshed:', state.currentPatient.name);
          }
        }
      }
      
      // Update unit requests
      if (data.data.unitRequests) {
        state.unitRequests = data.data.unitRequests;
      }
      
      // Save to local storage
      saveLocal();
      
      // Re-render appropriate view
      if (state.currentPatient) {
        renderPatientProfile();
      } else if (state.currentUnit) {
        renderPatients();
      } else {
        renderUnits();
      }
      
      console.log('✅ Cloud sync complete, last updated:', data.data.lastUpdated || 'unknown');
    }
  } catch (e) {
    console.error('❌ Load from cloud failed:', e);
  }
}

function getUnit(id) { return state.units.find(u => u.id === id); }
function getPatient(id) { return state.patients.find(p => p.id === id); }

// ═══════════════════════════════════════════════════════════════════
// FEEDBACK SYSTEM (RLHF)
// ═══════════════════════════════════════════════════════════════════

async function sendFeedback(rating, interpretationType = 'lab') {
  if (!state.currentInteractionId || !state.currentPatient) return;
  
  const p = state.currentPatient;
  
  try {
    await fetch(state.settings.apiUrl, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'recordFeedback',
        interactionId: state.currentInteractionId,
        patientId: p.id,
        interpretationType,
        rating,
        interpretation: p.labData?.interpretation?.summary || '',
        labValues: p.labData?.parameters?.map(param => ({
          name: param.name,
          value: param.values?.[0]?.value,
          status: param.values?.[0]?.status
        })) || [],
        sessionId: state.sessionId
      })
    });
    
    // Update UI
    $$('.feedback-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.feedback-btn.${rating > 0 ? 'positive' : 'negative'}`)?.classList.add('active');
    document.querySelector('.feedback-sent')?.classList.add('show');
    
    toast(rating > 0 ? 'Thanks! This helps improve accuracy.' : 'Feedback noted. We\'ll improve.');
  } catch (e) {
    console.error('Feedback error:', e);
  }
}

window.sendFeedback = sendFeedback;

// ═══════════════════════════════════════════════════════════════════
// RENDER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════

function renderUnits() {
  // Ensure at least one default unit exists
  if (!state.units.length) {
    state.units = [{ id: 'med-e', name: 'Medicine Unit E', icon: '🏥', desc: 'Internal Medicine • Tap to enter', code: '1234', color: '#14b8a6' }];
  }
  
  $('unitsGrid').innerHTML = `
    <div class="units-prompt">👆 Tap a unit below to enter</div>
    ${state.units.map(u => `
    <div class="unit-card" style="--unit-color:${u.color || '#f59e0b'}" onclick="openUnitAccess('${u.id}')">
      <div class="unit-card-icon">${u.icon || '🏥'}</div>
      <div class="unit-card-name">${esc(u.name)}</div>
      <div class="unit-card-desc">${esc(u.desc || 'Tap to enter')}</div>
      <div class="unit-card-code-hint">🔐 Code: 1234</div>
    </div>
  `).join('')}`;
}

function renderUnitsTable() {
  $('unitsTable').innerHTML = state.units.map(u => `
    <tr>
      <td><span style="font-size:1.25rem;margin-right:10px">${u.icon}</span><b>${esc(u.name)}</b></td>
      <td><code style="background:var(--bg);padding:6px 14px;border-radius:8px">${u.code}</code></td>
      <td><button class="btn btn-ghost btn-xs" onclick="editUnit('${u.id}')">✏️</button><button class="btn btn-ghost btn-xs" onclick="deleteUnit('${u.id}')">🗑️</button></td>
    </tr>
  `).join('');
}

function renderPatients() {
  const container = $('patientsList');
  const f = state.currentFilter;
  let filtered = f === 'all' ? [...state.patients] : state.patients.filter(p => p.status === f);
  
  const wards = {};
  filtered.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); });
  
  if (!filtered.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👥</div><div>No patients</div></div>';
    updateStats();
    return;
  }
  
  const order = ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned', 'Unassigned'];
  let html = '';
  Object.keys(wards).sort((a, b) => (order.indexOf(a) === -1 ? 99 : order.indexOf(a)) - (order.indexOf(b) === -1 ? 99 : order.indexOf(b))).forEach(ward => {
    const ps = wards[ward];
    html += `<div class="ward-section"><div class="ward-header"><div class="ward-title">📍 ${esc(ward)}</div><div class="ward-count">${ps.length}</div></div>`;
    ps.forEach(p => {
      html += `<div class="patient-card ${p.status}" onclick="openPatientProfile(${p.id})" ontouchstart="">
        <div class="patient-header">
          <div class="patient-avatar">${initials(p.name)}</div>
          <div class="patient-info">
            <div class="patient-name">${esc(p.name)} ${p.status === 'new' ? '<span class="badge badge-emerald">NEW</span>' : ''} ${p.status === 'critical' ? '<span class="badge badge-rose">CRITICAL</span>' : ''}</div>
            <div class="patient-meta"><span>🛏️ ${esc(p.room || '—')}</span><span>👨‍⚕️ ${esc(p.doctor || '—')}</span></div>
          </div>
        </div>
        <div class="patient-diagnosis">${esc(p.diagnosis || 'Pending')}</div>
      </div>`;
    });
    html += '</div>';
  });
  
  container.innerHTML = html;
  updateStats();
}

function updateStats() {
  const a = state.patients;
  $('statTotal').textContent = a.length;
  $('statNew').textContent = a.filter(p => p.status === 'new').length;
  $('statActive').textContent = a.filter(p => p.status === 'active').length;
  $('statCritical').textContent = a.filter(p => p.status === 'critical').length;
  $('statChronic').textContent = a.filter(p => p.status === 'chronic').length;
  $$('.stat-card').forEach(s => s.classList.toggle('active', s.dataset.filter === state.currentFilter));
}

function renderRef() {
  $('refGrid').innerHTML = CONFIG.REFS.map(r => `<div class="ref-card"><h4>${r.title}</h4><p>${r.content}</p></div>`).join('');
}

// ═══════════════════════════════════════════════════════════════════
// CLINICAL SCORING SYSTEM
// ═══════════════════════════════════════════════════════════════════

let currentScoreId = null;
let currentScoreValues = {};

const SCORE_CATEGORY_ICONS = {
  'Cardiac': '❤️',
  'Respiratory': '🫁',
  'Neurological': '🧠',
  'GI': '🫃',
  'Critical Care': '🏥',
  'Renal': '🫘',
  'Vascular': '🩸',
  'Surgical': '🔪'
};

function renderScoresGrid() {
  const categories = {};
  Object.entries(CONFIG.SCORING_CALCULATORS).forEach(([id, score]) => {
    const cat = score.category || 'Other';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push({ id, ...score });
  });
  
  let html = '';
  Object.entries(categories).forEach(([category, scores]) => {
    const icon = SCORE_CATEGORY_ICONS[category] || '📊';
    html += `
      <div class="emergency-score-group">
        <div class="emergency-score-group-header">
          <span class="emergency-score-group-icon">${icon}</span>
          <span class="emergency-score-group-title">${category}</span>
        </div>
        <div class="emergency-score-group-body">
          ${scores.map(s => `
            <div class="emergency-score-item" onclick="openScoreCalculator('${s.id}')">
              <div class="emergency-score-item-info">
                <div class="emergency-score-item-name">${s.name}</div>
                <div class="emergency-score-item-purpose">${s.purpose}</div>
              </div>
              <button class="emergency-score-item-btn">Calculate</button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });
  
  $('scoresGrid').innerHTML = html;
}

window.filterScores = function(query) {
  const q = query.toLowerCase().trim();
  const groups = $$('.emergency-score-group');
  
  groups.forEach(group => {
    const items = group.querySelectorAll('.emergency-score-item');
    let visibleCount = 0;
    
    items.forEach(item => {
      const name = item.querySelector('.emergency-score-item-name').textContent.toLowerCase();
      const purpose = item.querySelector('.emergency-score-item-purpose').textContent.toLowerCase();
      const match = !q || name.includes(q) || purpose.includes(q);
      item.style.display = match ? 'flex' : 'none';
      if (match) visibleCount++;
    });
    
    group.style.display = visibleCount > 0 ? 'block' : 'none';
  });
};

window.openScoreCalculator = function(scoreId) {
  const score = CONFIG.SCORING_CALCULATORS[scoreId];
  if (!score) return;
  
  currentScoreId = scoreId;
  currentScoreValues = {};
  
  const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
  $('scoreCalcTitle').textContent = score.name;
  $('scoreCalcPurpose').textContent = score.purpose;
  $('scoreCalcCategory').innerHTML = `${icon} ${score.category}`;
  
  // Show save button only if patient is open
  $('saveScoreBtn').style.display = state.currentPatient ? 'block' : 'none';
  
  // Get patient lab data for auto-calculation
  const patientLabs = getPatientLabValues();
  const autoCalcData = getAutoCalcForScore(scoreId, patientLabs);
  
  // Render fields with improved design
  let fieldsHtml = '';
  
  // If we have auto-calculated result, show it first
  if (autoCalcData.hasAuto) {
    fieldsHtml += `
      <div class="score-auto-calc">
        <div class="score-auto-calc-header">
          <div class="score-auto-calc-title">
            <span>🤖 Auto-calculated from Labs</span>
            <span class="score-auto-calc-badge">SMART</span>
          </div>
          <button class="score-manual-toggle" onclick="toggleManualMode()">Enter manually</button>
        </div>
        <div class="score-auto-calc-value">${autoCalcData.display}</div>
        <div class="score-auto-calc-source">${autoCalcData.source}</div>
      </div>
      <div id="manualScoreFields" style="display:none">
    `;
    
    // Set the auto-calculated values
    Object.assign(currentScoreValues, autoCalcData.values);
  }
  
  let fieldIndex = 0;
  score.fields.forEach(field => {
    fieldIndex++;
    
    if (field.type === 'checkbox') {
      const pointsDisplay = field.points > 0 ? `+${field.points}` : field.points;
      fieldsHtml += `
        <div class="score-field" onclick="toggleScoreCheckbox('${field.id}', ${field.points || 1})">
          <div class="score-field-checkbox" id="check_${field.id}"></div>
          <div class="score-field-label">${field.label}</div>
          <div class="score-field-points">${pointsDisplay}</div>
        </div>
      `;
      currentScoreValues[field.id] = currentScoreValues[field.id] || 0;
    } else if (field.type === 'select') {
      const preselectedValue = currentScoreValues[field.id] || '';
      fieldsHtml += `
        <div class="score-field" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="score-field-select">
            <label>${fieldIndex}. ${field.label}</label>
            <select id="select_${field.id}" onchange="updateScoreSelect('${field.id}', this.value)">
              <option value="">Select an option...</option>
              ${field.options.map(o => `<option value="${o.value}" ${o.value == preselectedValue ? 'selected' : ''}>${o.label}</option>`).join('')}
            </select>
          </div>
        </div>
      `;
      currentScoreValues[field.id] = currentScoreValues[field.id] || 0;
    } else if (field.type === 'number') {
      const prefilledValue = currentScoreValues[field.id] || '';
      fieldsHtml += `
        <div class="score-field" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="score-field-number">
            <label>${field.label}</label>
            <input type="number" id="num_${field.id}" min="${field.min || 0}" max="${field.max || 100}" step="${field.step || 1}" value="${prefilledValue}" placeholder="0" onchange="updateScoreNumber('${field.id}', this.value)" oninput="updateScoreNumber('${field.id}', this.value)">
          </div>
        </div>
      `;
      if (currentScoreValues[field.id] === undefined) currentScoreValues[field.id] = null;
    }
  });
  
  if (autoCalcData.hasAuto) {
    fieldsHtml += '</div>';
  }
  
  $('scoreCalcFields').innerHTML = fieldsHtml;
  updateScoreResult();
  openModal('scoreCalcModal');
};

// Get patient's lab values in a normalized format
function getPatientLabValues() {
  if (!state.currentPatient?.labData?.parameters) return {};
  
  const labs = {};
  const params = state.currentPatient.labData.parameters;
  
  params.forEach(p => {
    const name = p.name.toLowerCase();
    const value = parseFloat(p.value);
    if (isNaN(value)) return;
    
    // Normalize common lab names
    if (name.includes('creatinine') || name.includes('creat')) labs.creatinine = value;
    if (name.includes('urea') || name === 'bun') labs.urea = value;
    if (name.includes('egfr')) labs.egfr = value;
    if (name.includes('bilirubin') && !name.includes('direct')) labs.bilirubin = value;
    if (name.includes('inr')) labs.inr = value;
    if (name.includes('albumin')) labs.albumin = value;
    if (name.includes('sodium') || name === 'na') labs.sodium = value;
    if (name.includes('potassium') || name === 'k') labs.potassium = value;
    if (name.includes('hemoglobin') || name === 'hgb' || name === 'hb') labs.hemoglobin = value;
    if (name.includes('platelet')) labs.platelets = value;
    if (name.includes('wbc') || name.includes('white')) labs.wbc = value;
    if (name.includes('lactate')) labs.lactate = value;
    if (name.includes('glucose') || name === 'gluc') labs.glucose = value;
  });
  
  return labs;
}

// Get auto-calculation data for specific scores
function getAutoCalcForScore(scoreId, labs) {
  const result = { hasAuto: false, display: '', source: '', values: {} };
  
  if (!state.currentPatient) return result;
  
  // KDIGO AKI - Auto-calculate from creatinine
  if (scoreId === 'KDIGO-AKI' && labs.creatinine) {
    const cr = labs.creatinine;
    const baseline = state.currentPatient.baselineCreatinine || 1.0; // Default baseline
    const ratio = cr / baseline;
    
    let stage = 1;
    if (cr >= 4.0 || ratio >= 3) stage = 3;
    else if (ratio >= 2) stage = 2;
    else if (cr >= baseline + 0.3 || ratio >= 1.5) stage = 1;
    else stage = 0;
    
    if (stage > 0) {
      result.hasAuto = true;
      result.display = `Stage ${stage}`;
      result.source = `Based on Cr: ${cr} mg/dL (baseline: ${baseline})`;
      result.values = { stage: stage };
    }
  }
  
  // MELD Score - Auto-calculate from labs
  if (scoreId === 'MELD' && labs.creatinine && labs.bilirubin && labs.inr) {
    result.hasAuto = true;
    result.values = {
      creatinine: labs.creatinine,
      bilirubin: labs.bilirubin,
      inr: labs.inr
    };
    
    const cr = Math.min(Math.max(labs.creatinine, 1), 4);
    const bili = Math.max(labs.bilirubin, 1);
    const inr = Math.max(labs.inr, 1);
    const meld = Math.round(10 * (0.957 * Math.log(cr) + 0.378 * Math.log(bili) + 1.12 * Math.log(inr) + 0.643));
    
    result.display = Math.min(Math.max(meld, 6), 40).toString();
    result.source = `Cr: ${labs.creatinine} | Bili: ${labs.bilirubin} | INR: ${labs.inr}`;
  }
  
  // Child-Pugh - Partial auto-fill
  if (scoreId === 'Child-Pugh') {
    if (labs.bilirubin || labs.albumin || labs.inr) {
      result.hasAuto = true;
      result.source = 'Partial data from labs';
      
      const parts = [];
      if (labs.bilirubin) {
        result.values.bilirubin = labs.bilirubin < 2 ? 1 : labs.bilirubin <= 3 ? 2 : 3;
        parts.push(`Bili: ${labs.bilirubin}`);
      }
      if (labs.albumin) {
        result.values.albumin = labs.albumin > 3.5 ? 1 : labs.albumin >= 2.8 ? 2 : 3;
        parts.push(`Alb: ${labs.albumin}`);
      }
      if (labs.inr) {
        result.values.inr = labs.inr < 1.7 ? 1 : labs.inr <= 2.3 ? 2 : 3;
        parts.push(`INR: ${labs.inr}`);
      }
      
      const total = (result.values.bilirubin || 0) + (result.values.albumin || 0) + (result.values.inr || 0);
      result.display = `${total}+ pts`;
      result.source = parts.join(' | ') + ' (complete manually)';
    }
  }
  
  // Glasgow-Blatchford - Auto-fill from labs
  if (scoreId === 'Glasgow-Blatchford') {
    if (labs.urea || labs.hemoglobin) {
      result.hasAuto = true;
      const parts = [];
      
      if (labs.urea) {
        // BUN scoring
        let bunScore = 0;
        if (labs.urea >= 25) bunScore = 6;
        else if (labs.urea >= 10) bunScore = 4;
        else if (labs.urea >= 8) bunScore = 3;
        else if (labs.urea >= 6.5) bunScore = 2;
        result.values.bun = bunScore;
        parts.push(`Urea: ${labs.urea}`);
      }
      
      if (labs.hemoglobin) {
        // Simplified - assuming male for now
        let hgbScore = 0;
        if (labs.hemoglobin < 10) hgbScore = 6;
        else if (labs.hemoglobin < 12) hgbScore = 3;
        else if (labs.hemoglobin < 13) hgbScore = 1;
        result.values.hgb_male = hgbScore;
        parts.push(`Hgb: ${labs.hemoglobin}`);
      }
      
      result.display = 'Partial';
      result.source = parts.join(' | ') + ' (add vitals)';
    }
  }
  
  return result;
}

window.toggleManualMode = function() {
  const manualFields = $('manualScoreFields');
  const autoCalc = document.querySelector('.score-auto-calc');
  
  if (manualFields.style.display === 'none') {
    manualFields.style.display = 'block';
    autoCalc.style.opacity = '0.5';
  } else {
    manualFields.style.display = 'none';
    autoCalc.style.opacity = '1';
  }
};

window.toggleScoreCheckbox = function(fieldId, points) {
  const checkbox = $('check_' + fieldId);
  const field = checkbox.closest('.score-field');
  
  if (checkbox.classList.contains('checked')) {
    checkbox.classList.remove('checked');
    field.classList.remove('checked');
    currentScoreValues[fieldId] = 0;
  } else {
    checkbox.classList.add('checked');
    field.classList.add('checked');
    currentScoreValues[fieldId] = points;
  }
  
  updateScoreResult();
};

window.updateScoreSelect = function(fieldId, value) {
  currentScoreValues[fieldId] = parseFloat(value) || 0;
  updateScoreResult();
};

window.updateScoreNumber = function(fieldId, value) {
  currentScoreValues[fieldId] = parseFloat(value) || null;
  updateScoreResult();
};

function updateScoreResult() {
  const score = CONFIG.SCORING_CALCULATORS[currentScoreId];
  if (!score) return;
  
  // Calculate total
  let total = 0;
  let maxScore = 0;
  
  score.fields.forEach(field => {
    const val = currentScoreValues[field.id];
    if (field.type === 'checkbox') {
      total += val || 0;
      maxScore += Math.abs(field.points) || 1;
    } else if (field.type === 'select' && field.options) {
      total += val || 0;
      maxScore += Math.max(...field.options.map(o => Math.abs(o.value)));
    }
  });
  
  // Special handling for MELD score calculation
  if (currentScoreId === 'MELD') {
    const cr = currentScoreValues.creatinine || 1;
    const bili = currentScoreValues.bilirubin || 1;
    const inr = currentScoreValues.inr || 1;
    const dialysis = currentScoreValues.dialysis || 0;
    
    const crVal = Math.min(Math.max(dialysis ? 4 : cr, 1), 4);
    const biliVal = Math.max(bili, 1);
    const inrVal = Math.max(inr, 1);
    
    total = Math.round(10 * (0.957 * Math.log(crVal) + 0.378 * Math.log(biliVal) + 1.12 * Math.log(inrVal) + 0.643));
    total = Math.min(Math.max(total, 6), 40);
    maxScore = 40;
  }
  
  $('scoreResultValue').textContent = total;
  $('scoreResultMax').textContent = maxScore > 0 ? `of ${maxScore}` : '';
  
  // Find interpretation
  const interp = score.interpretation.find(i => total >= i.min && total <= i.max) || score.interpretation[score.interpretation.length - 1];
  
  if (interp) {
    const interpEl = $('scoreResultInterpretation');
    
    // Create gradient based on risk color
    const baseColor = interp.color;
    interpEl.style.background = `linear-gradient(135deg, ${baseColor}22 0%, ${baseColor}11 100%)`;
    interpEl.style.border = `1px solid ${baseColor}40`;
    interpEl.style.color = '#f1f5f9';
    
    let statsHtml = '';
    Object.entries(interp).forEach(([key, val]) => {
      if (!['min', 'max', 'risk', 'action', 'color'].includes(key)) {
        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        statsHtml += `
          <div class="score-result-stat">
            <div class="score-result-stat-value" style="color:${baseColor}">${val}</div>
            <div class="score-result-stat-label">${label}</div>
          </div>
        `;
      }
    });
    
    interpEl.innerHTML = `
      <div class="score-result-risk" style="color:${baseColor}">${interp.risk}</div>
      <div class="score-result-action">${interp.action}</div>
      ${statsHtml ? `<div class="score-result-stats">${statsHtml}</div>` : ''}
    `;
  }
}

window.savePatientScore = function() {
  if (!state.currentPatient || !currentScoreId) return;
  
  const score = CONFIG.SCORING_CALCULATORS[currentScoreId];
  if (!score) return;
  
  // Calculate total
  let total = 0;
  score.fields.forEach(field => {
    const val = currentScoreValues[field.id];
    if (field.type === 'checkbox' || field.type === 'select') {
      total += val || 0;
    }
  });
  
  // Handle MELD special calculation
  if (currentScoreId === 'MELD') {
    const cr = currentScoreValues.creatinine || 1;
    const bili = currentScoreValues.bilirubin || 1;
    const inr = currentScoreValues.inr || 1;
    const dialysis = currentScoreValues.dialysis || 0;
    const crVal = Math.min(Math.max(dialysis ? 4 : cr, 1), 4);
    total = Math.round(10 * (0.957 * Math.log(crVal) + 0.378 * Math.log(Math.max(bili, 1)) + 1.12 * Math.log(Math.max(inr, 1)) + 0.643));
    total = Math.min(Math.max(total, 6), 40);
  }
  
  const interp = score.interpretation.find(i => total >= i.min && total <= i.max) || score.interpretation[score.interpretation.length - 1];
  
  // Initialize scores array if needed
  if (!state.currentPatient.scores) state.currentPatient.scores = [];
  
  // Add or update score
  const existingIdx = state.currentPatient.scores.findIndex(s => s.id === currentScoreId);
  const scoreEntry = {
    id: currentScoreId,
    name: score.name,
    value: total,
    risk: interp?.risk || 'Unknown',
    color: interp?.color || '#6b7280',
    date: new Date().toISOString(),
    values: { ...currentScoreValues }
  };
  
  if (existingIdx >= 0) {
    state.currentPatient.scores[existingIdx] = scoreEntry;
  } else {
    state.currentPatient.scores.push(scoreEntry);
  }
  
  saveCloud();
  closeModal('scoreCalcModal');
  toast(`${score.name}: ${total} saved!`);
  
  if ($('profileScores')) renderProfileScores();
};

function getRelevantScoresForPatient(patient) {
  if (!patient?.diagnosis) return [];
  
  const dx = patient.diagnosis.toLowerCase();
  const relevantScores = new Set();
  
  // Check each diagnosis keyword
  Object.entries(CONFIG.PATIENT_SCORES).forEach(([keyword, scores]) => {
    if (dx.includes(keyword.toLowerCase())) {
      scores.forEach(s => relevantScores.add(s));
    }
  });
  
  // Always include some universal scores
  if (patient.status === 'critical') {
    ['qSOFA', 'SOFA', 'NEWS2', 'Glasgow-Coma'].forEach(s => relevantScores.add(s));
  }
  
  return Array.from(relevantScores).filter(s => CONFIG.SCORING_CALCULATORS[s]);
}

function renderProfileScores() {
  const p = state.currentPatient;
  if (!p) return;
  
  const relevantScores = getRelevantScoresForPatient(p);
  const savedScores = p.scores || [];
  
  let html = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">📊 Clinical Scores</div>
      </div>
      <div class="section-body">
  `;
  
  // Relevant scores based on diagnosis
  if (relevantScores.length > 0) {
    html += `
      <div class="patient-scores-section">
        <div class="patient-scores-header">
          <div class="patient-scores-title">Recommended for this patient</div>
        </div>
        <div class="patient-scores-grid">
    `;
    
    relevantScores.forEach(scoreId => {
      const score = CONFIG.SCORING_CALCULATORS[scoreId];
      const saved = savedScores.find(s => s.id === scoreId);
      const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
      
      let valueClass = '';
      if (saved) {
        const interp = score.interpretation.find(i => saved.value >= i.min && saved.value <= i.max);
        if (interp) {
          if (interp.color === '#10b981' || interp.color === '#22c55e') valueClass = 'low';
          else if (interp.color === '#f59e0b') valueClass = 'moderate';
          else valueClass = 'high';
        }
      }
      
      html += `
        <div class="patient-score-chip ${saved ? 'has-value' : ''}" onclick="openScoreCalculator('${scoreId}')">
          <span class="score-chip-icon">${icon}</span>
          <span class="score-chip-name">${score.name.replace(' Score', '').replace(' Classification', '')}</span>
          ${saved ? `<span class="score-chip-value ${valueClass}">${saved.value}</span>` : ''}
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  // Saved scores history
  if (savedScores.length > 0) {
    html += `
      <div class="patient-scores-section" style="margin-top:24px">
        <div class="patient-scores-header">
          <div class="patient-scores-title">Calculated Scores</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
    `;
    
    savedScores.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(saved => {
      html += `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg);border-radius:var(--radius-sm);border-left:3px solid ${saved.color}">
          <div>
            <div style="font-weight:600;font-size:0.9rem">${saved.name}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">${formatDateTime(saved.date)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700;color:${saved.color}">${saved.value}</div>
            <div style="font-size:0.7rem;color:${saved.color}">${saved.risk}</div>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  // Quick access to all scores
  html += `
    <div class="patient-scores-section" style="margin-top:24px">
      <div class="patient-scores-header">
        <div class="patient-scores-title">All Available Scores</div>
      </div>
      <div class="patient-scores-grid">
  `;
  
  Object.entries(CONFIG.SCORING_CALCULATORS).slice(0, 12).forEach(([id, score]) => {
    const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
    const saved = savedScores.find(s => s.id === id);
    
    html += `
      <div class="patient-score-chip ${saved ? 'has-value' : ''}" onclick="openScoreCalculator('${id}')">
        <span class="score-chip-icon">${icon}</span>
        <span class="score-chip-name">${score.name.replace(' Score', '').replace(' Classification', '').substring(0, 15)}</span>
      </div>
    `;
  });
  
  html += `
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%" onclick="showTab('scores')">View All Scores →</button>
      </div>
    </div>
  </div>`;
  
  $('profileScores').innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════════
// PATIENT PROFILE
// ═══════════════════════════════════════════════════════════════════

window.openPatientProfile = function(id, defaultTab = 'overview') {
  const p = getPatient(id);
  if (!p) return;
  state.currentPatient = p;
  state.currentInteractionId = null;
  if (!p.labData) p.labData = { dates: [], parameters: [], interpretation: null };
  if (!p.imaging) p.imaging = [];
  if (!p.fluids) p.fluids = [];
  if (!p.plans) p.plans = [];
  if (!p.vitals) p.vitals = {};
  if (!p.history) p.history = '';
  if (!p.scores) p.scores = [];
  renderPatientProfile();
  showPage('patientProfile');
  
  // Switch to the specified tab
  setTimeout(() => showProfileTab(defaultTab), 50);
};

window.closePatientProfile = function() {
  state.currentPatient = null;
  state.currentInteractionId = null;
  if (state.trendChart) { state.trendChart.destroy(); state.trendChart = null; }
  if (state.fluidChart) { state.fluidChart.destroy(); state.fluidChart = null; }
  showPage('dashboard');
  renderPatients();
};

function renderPatientProfile() {
  const p = state.currentPatient;
  if (!p) return;
  
  const avatarBg = p.status === 'critical' ? 'var(--rose),var(--orange)' : 
                   p.status === 'chronic' ? 'var(--purple),#a855f7' :
                   p.status === 'discharged' ? 'var(--text-muted),#4b5563' :
                   p.status === 'new' ? 'var(--emerald),var(--teal)' : 'var(--gold),var(--orange)';
  
  // Update discharge button visibility
  const dischargeBtn = $('profileDischargeBtn');
  if (dischargeBtn) dischargeBtn.style.display = p.status === 'discharged' ? 'none' : '';
  
  $('profilePatientInfo').innerHTML = `
    <div class="profile-avatar" style="background:linear-gradient(135deg,${avatarBg})">${initials(p.name)}</div>
    <div class="profile-details">
      <h2>${esc(p.name)}</h2>
      <div class="meta">
        <span>🛏️ ${esc(p.ward)} • ${esc(p.room || '—')}</span>
        <span>👨‍⚕️ ${esc(p.doctor || 'Unassigned')}</span>
        <span class="badge badge-${p.status === 'critical' ? 'rose' : p.status === 'chronic' ? 'purple' : p.status === 'discharged' ? 'secondary' : p.status === 'new' ? 'emerald' : 'teal'}">${p.status}</span>
        ${p.dischargeDate ? `<span style="font-size:0.75rem;color:var(--text-muted)">📅 Discharged ${formatShortDate(p.dischargeDate)}</span>` : ''}
      </div>
    </div>
  `;
  
  renderProfileOverview();
  renderProfileMeds();
  renderProfileHistory();
  renderProfileScores();
  renderProfileLabs();
  renderProfileImaging();
  renderProfileFluids();
  renderProfilePlans();
}

// ═══════════════════════════════════════════════════════════════════
// MEDICATIONS MODULE - Pristine Pharmaceutical Design
// ═══════════════════════════════════════════════════════════════════

function renderProfileMeds() {
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];
  
  const searchTerm = state.medSearchTerm || '';
  const filteredMeds = p.medications.filter(m => {
    if (!searchTerm) return true;
    const term = searchTerm.toLowerCase();
    return (m.name || '').toLowerCase().includes(term) ||
           (m.indication || '').toLowerCase().includes(term) ||
           (m.generic || '').toLowerCase().includes(term);
  });
  
  const activeMeds = filteredMeds.filter(m => m.status !== 'discontinued');
  const discontinuedMeds = filteredMeds.filter(m => m.status === 'discontinued');
  
  // Check for any drug-lab alerts
  const totalAlerts = p.medications.reduce((count, med) => {
    const drugInfo = CONFIG.DRUG_DATABASE[(med.name || '').split(' ')[0]] || CONFIG.DRUG_DATABASE[med.name];
    if (drugInfo && drugInfo.alerts) {
      const patientLabs = p.labData?.parameters || [];
      Object.entries(drugInfo.alerts).forEach(([labName, alertConfig]) => {
        const labParam = patientLabs.find(lp => lp.name?.toLowerCase().includes(labName.toLowerCase()));
        if (labParam && labParam.values && labParam.values[0]) {
          const labValue = parseFloat(labParam.values[0].value);
          if (!isNaN(labValue)) {
            if ((alertConfig.operator === '>' && labValue > alertConfig.value) ||
                (alertConfig.operator === '<' && labValue < alertConfig.value)) {
              count++;
            }
          }
        }
      });
    }
    return count;
  }, 0);
  
  let html = `
    <div class="meds-container">
      <!-- Alert Summary Banner -->
      ${totalAlerts > 0 ? `
        <div class="meds-alert-banner">
          <div class="meds-alert-icon">🚨</div>
          <div class="meds-alert-text">
            <strong>${totalAlerts} Drug-Lab Alert${totalAlerts > 1 ? 's' : ''}</strong>
            <span>Review medications below for potential interactions</span>
          </div>
        </div>
      ` : ''}
      
      <!-- Upload Card -->
      <div class="meds-upload-card">
        <div class="meds-upload-header">
          <div class="meds-upload-title">
            <span>📷</span> Smart Medication Import
          </div>
          <div class="meds-upload-subtitle">AI-powered extraction from medication lists, prescriptions & MAR sheets</div>
        </div>
        <div class="meds-upload-body">
          <div class="meds-upload-zone ${state.isAnalyzingMeds ? 'analyzing' : ''}" onclick="triggerMedsUpload()">
            ${state.isAnalyzingMeds ? `
              <div class="meds-upload-icon">⏳</div>
              <div class="meds-upload-text">Analyzing medications...</div>
              <div class="meds-upload-hint">Extracting drug names, doses & indications</div>
            ` : `
              <div class="meds-upload-icon">💊</div>
              <div class="meds-upload-text">Tap to upload medication list</div>
              <div class="meds-upload-hint">Supports handwritten & printed formats</div>
            `}
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="meds-quick-actions">
        <button class="meds-quick-btn" onclick="showAddMedForm()">+ Add Manually</button>
        <button class="meds-quick-btn" onclick="reconcileMeds()">⚖️ Reconcile</button>
      </div>
      
      <!-- Search Filter -->
      ${p.medications.length > 3 ? `
        <div class="meds-search-bar">
          <input type="text" class="meds-search-input" placeholder="🔍 Search medications..." 
                 value="${esc(searchTerm)}" 
                 oninput="filterMedications(this.value)">
        </div>
      ` : ''}
  `;
  
  // Active Medications
  if (activeMeds.length > 0) {
    html += `
      <div class="meds-list-header">
        <div class="meds-list-title">Active Medications</div>
        <div class="meds-count">${activeMeds.length} active</div>
      </div>
    `;
    
    activeMeds.forEach((med, idx) => {
      const realIdx = p.medications.indexOf(med);
      html += renderMedCard(med, realIdx);
    });
  }
  
  // Discontinued
  if (discontinuedMeds.length > 0) {
    html += `
      <div class="meds-list-header" style="margin-top:20px">
        <div class="meds-list-title">Discontinued</div>
        <div class="meds-count" style="background:rgba(248,81,73,0.1);color:#f85149">${discontinuedMeds.length}</div>
      </div>
    `;
    
    discontinuedMeds.forEach((med, idx) => {
      const realIdx = p.medications.indexOf(med);
      html += renderMedCard(med, realIdx);
    });
  }
  
  // Empty State
  if (p.medications.length === 0) {
    html += `
      <div class="meds-empty">
        <div class="meds-empty-icon">💊</div>
        <div class="meds-empty-title">No medications recorded</div>
        <div class="meds-empty-hint">Upload a photo or add manually</div>
      </div>
    `;
  } else if (filteredMeds.length === 0 && searchTerm) {
    html += `
      <div class="meds-empty">
        <div class="meds-empty-icon">🔍</div>
        <div class="meds-empty-title">No matching medications</div>
        <div class="meds-empty-hint">Try a different search term</div>
      </div>
    `;
  }
  
  html += `
    </div>
  `;
  
  $('profileMeds').innerHTML = html;
}

// Medication search filter function
window.filterMedications = function(term) {
  state.medSearchTerm = term;
  renderProfileMeds();
};

function renderMedCard(med, idx) {
  const statusClass = med.status || 'active';
  const statusLabels = { active: 'Active', new: 'New', prn: 'PRN', discontinued: 'Stopped' };
  const drugBaseUrl = state.settings.drugRefUrl || '';
  const showDrugLink = drugBaseUrl && drugBaseUrl.trim() !== '';
  
  // Normalize drug name for lookup
  const drugNameNormalized = (med.name || '').split(' ')[0]; // Get first word (e.g., "Metformin" from "Metformin 500mg")
  const drugInfo = CONFIG.DRUG_DATABASE[drugNameNormalized] || CONFIG.DRUG_DATABASE[med.name] || null;
  
  // Get patient's current lab values for alert checking
  const patientLabs = state.currentPatient?.labData?.parameters || [];
  let alerts = [];
  
  if (drugInfo && drugInfo.alerts) {
    Object.entries(drugInfo.alerts).forEach(([labName, alertConfig]) => {
      // Find matching lab value
      const labParam = patientLabs.find(p => 
        p.name?.toLowerCase().includes(labName.toLowerCase()) ||
        labName.toLowerCase().includes(p.name?.toLowerCase())
      );
      
      if (labParam && labParam.values && labParam.values[0]) {
        const labValue = parseFloat(labParam.values[0].value);
        if (!isNaN(labValue)) {
          let triggered = false;
          if (alertConfig.operator === '>' && labValue > alertConfig.value) triggered = true;
          if (alertConfig.operator === '<' && labValue < alertConfig.value) triggered = true;
          if (alertConfig.operator === '>=' && labValue >= alertConfig.value) triggered = true;
          if (alertConfig.operator === '<=' && labValue <= alertConfig.value) triggered = true;
          
          if (triggered) {
            alerts.push({
              lab: labName,
              value: labValue,
              severity: alertConfig.severity,
              message: alertConfig.message
            });
          }
        }
      }
    });
  }
  
  // Build dynamic URL with drug name as query parameter
  const drugName = encodeURIComponent(med.name || '');
  const drugDose = encodeURIComponent(med.dose || '');
  const drugIndication = encodeURIComponent(med.indication || '');
  
  // Add relevant lab values to URL for context
  let labContext = '';
  if (drugInfo && drugInfo.monitorLabs) {
    const relevantLabs = drugInfo.monitorLabs.map(labName => {
      const labParam = patientLabs.find(p => p.name?.toLowerCase().includes(labName.toLowerCase()));
      if (labParam && labParam.values && labParam.values[0]) {
        return `${labName}:${labParam.values[0].value}`;
      }
      return null;
    }).filter(Boolean);
    if (relevantLabs.length) {
      labContext = '&labs=' + encodeURIComponent(relevantLabs.join(','));
    }
  }
  
  const drugUrl = showDrugLink ? `${drugBaseUrl}?drug=${drugName}&dose=${drugDose}&indication=${drugIndication}${labContext}` : '';
  
  // Build alerts HTML
  let alertsHtml = '';
  if (alerts.length > 0) {
    alertsHtml = `
      <div class="med-alerts">
        ${alerts.map(a => `
          <div class="med-alert ${a.severity}">
            <span class="med-alert-icon">${a.severity === 'critical' ? '🚨' : '⚠️'}</span>
            <div class="med-alert-content">
              <span class="med-alert-lab">${esc(a.lab)}: ${a.value}</span>
              <span class="med-alert-message">${esc(a.message)}</span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // Monitoring labs badge
  let monitorBadge = '';
  if (drugInfo && drugInfo.monitorLabs && drugInfo.monitorLabs.length > 0) {
    monitorBadge = `<div class="med-monitor-labs">📊 Monitor: ${drugInfo.monitorLabs.slice(0, 3).join(', ')}${drugInfo.monitorLabs.length > 3 ? '...' : ''}</div>`;
  }
  
  return `
    <div class="med-card ${alerts.length > 0 ? 'has-alerts' : ''}">
      ${alertsHtml}
      <div class="med-card-header">
        <div class="med-card-main">
          <div class="med-card-name">
            ${drugInfo ? `<span class="med-drug-icon">${drugInfo.icon}</span>` : ''}
            ${esc(med.name)}
            <span class="med-status ${statusClass}">${statusLabels[statusClass] || statusClass}</span>
          </div>
          ${med.generic ? `<div class="med-card-generic">${esc(med.generic)}</div>` : ''}
          ${drugInfo ? `<div class="med-card-class">${esc(drugInfo.class)}</div>` : ''}
        </div>
        <div class="med-card-actions">
          ${showDrugLink ? `<a href="${drugUrl}" target="_blank" class="med-card-action info" title="Drug Info" ontouchstart="">📚</a>` : ''}
          <button class="med-card-action" onclick="editMedication(${idx})" title="Edit" ontouchstart="">✏️</button>
          <button class="med-card-action delete" onclick="deleteMedication(${idx})" title="Delete" ontouchstart="">🗑️</button>
        </div>
      </div>
      <div class="med-card-dose">
        <span class="med-dose-pill">💊 ${esc(med.dose || '—')}</span>
        <span class="med-dose-pill route">📍 ${esc(med.route || 'PO')}</span>
        <span class="med-dose-pill frequency">🕐 ${esc(med.frequency || 'OD')}</span>
      </div>
      ${med.indication ? `
        <div class="med-card-indication">
          <div class="med-indication-label">Indication</div>
          <div class="med-indication-text">${esc(med.indication)}</div>
        </div>
      ` : ''}
      ${monitorBadge}
      ${showDrugLink ? `<a href="${drugUrl}" target="_blank" ontouchstart="" class="btn btn-info btn-xs med-learn-more">📖 Learn More (AI-Powered)</a>` : ''}
    </div>
  `;
}

window.triggerMedsUpload = function() {
  if (state.isAnalyzingMeds) return;
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => handleMedsUpload(e.target.files[0]);
  input.click();
};

async function handleMedsUpload(file) {
  if (!file) return;
  
  state.isAnalyzingMeds = true;
  renderProfileMeds();
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ 
          action: 'extractMedications',
          image: imageData,
          patientDiagnosis: state.currentPatient.diagnosis || ''
        })
      });
      const data = await res.json();
      
      state.isAnalyzingMeds = false;
      
      if (data.medications && Array.isArray(data.medications)) {
        const p = state.currentPatient;
        if (!p.medications) p.medications = [];
        
        // Add extracted medications
        data.medications.forEach(med => {
          p.medications.push({
            name: med.name || med.drug || 'Unknown',
            dose: med.dose || med.dosage || '',
            route: med.route || 'PO',
            frequency: med.frequency || med.schedule || 'OD',
            indication: med.indication || med.reason || '',
            generic: med.generic || '',
            status: 'new',
            addedDate: new Date().toISOString()
          });
        });
        
        saveCloud();
        renderProfileMeds();
        toast(`${data.medications.length} medication(s) imported`);
      } else {
        toast('No medications found in image', true);
        renderProfileMeds();
      }
    } catch (e) {
      state.isAnalyzingMeds = false;
      toast('Failed to analyze medications', true);
      renderProfileMeds();
    }
  });
}

window.showAddMedForm = function() {
  $('medicationModalTitle').textContent = 'Add Medication';
  $('medName').value = '';
  $('medDose').value = '';
  $('medRoute').value = 'PO';
  $('medFreq').value = 'OD';
  $('medIndication').value = '';
  $('medStatus').value = 'active';
  $('medGeneric').value = '';
  state.editingMedIdx = null;
  openModal('medicationModal');
};

window.hideAddMedForm = function() {
  closeModal('medicationModal');
};

window.saveMedication = function() {
  const name = $('medName').value.trim();
  const dose = $('medDose').value.trim();
  
  if (!name) {
    toast('Drug name is required', true);
    return;
  }
  
  const med = {
    name: name,
    dose: dose,
    route: $('medRoute').value,
    frequency: $('medFreq').value,
    indication: $('medIndication').value.trim(),
    status: $('medStatus').value,
    generic: $('medGeneric').value.trim(),
    addedDate: new Date().toISOString()
  };
  
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];
  
  if (state.editingMedIdx !== null && state.editingMedIdx !== undefined) {
    p.medications[state.editingMedIdx] = { ...p.medications[state.editingMedIdx], ...med };
    toast('Medication updated');
  } else {
    p.medications.push(med);
    toast('Medication added');
  }
  
  state.editingMedIdx = null;
  saveCloud();
  closeModal('medicationModal');
  renderProfileMeds();
};

window.editMedication = function(idx) {
  const med = state.currentPatient.medications[idx];
  if (!med) return;
  
  state.editingMedIdx = idx;
  $('medicationModalTitle').textContent = 'Edit Medication';
  $('medName').value = med.name || '';
  $('medDose').value = med.dose || '';
  $('medRoute').value = med.route || 'PO';
  $('medFreq').value = med.frequency || 'OD';
  $('medIndication').value = med.indication || '';
  $('medStatus').value = med.status || 'active';
  $('medGeneric').value = med.generic || '';
  
  openModal('medicationModal');
};

window.deleteMedication = function(idx) {
  if (!confirm('Delete this medication?')) return;
  state.currentPatient.medications.splice(idx, 1);
  saveCloud();
  renderProfileMeds();
  toast('Medication deleted');
};

window.reconcileMeds = function() {
  toast('Medication reconciliation - Coming soon');
};

function renderProfileHistory() {
  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];
  
  let html = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">📜 Clinical Notes & Documents</div>
        <button class="btn btn-primary btn-sm" onclick="addClinicalNote()">+ Add Note</button>
      </div>
      <div class="section-body">
        <div class="history-upload-area" onclick="triggerHistoryUpload()">
          <div style="font-size:1.5rem;margin-bottom:6px">📷</div>
          <div style="font-weight:600;font-size:0.85rem">Upload Document</div>
          <div style="font-size:0.75rem;color:#8b949e">Progress notes, referrals, consults, discharge summaries</div>
        </div>
  `;
  
  if (!p.clinicalNotes.length) {
    html += `<div style="text-align:center;padding:24px;color:#8b949e">
      <div style="font-size:1.5rem;margin-bottom:8px">📝</div>
      <div>No clinical notes yet</div>
      <div style="font-size:0.75rem;margin-top:4px">Add notes or upload documents</div>
    </div>`;
  } else {
    html += `<div class="clinical-notes-list">`;
    
    p.clinicalNotes.slice().reverse().forEach((note, idx) => {
      const realIdx = p.clinicalNotes.length - 1 - idx;
      const typeIcons = { progress: '📝', consult: '👨‍⚕️', referral: '📤', discharge: '🏥', imaging: '🩻', other: '📄' };
      const icon = typeIcons[note.type] || '📄';
      
      html += `
        <div class="clinical-note-card">
          <div class="clinical-note-header">
            <div class="clinical-note-type">${icon} ${(note.type || 'Note').charAt(0).toUpperCase() + (note.type || 'note').slice(1)}</div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="clinical-note-date">${formatDateTime(note.date)}</span>
              <button class="btn-icon-sm" onclick="deleteClinicalNote(${realIdx})" title="Delete">🗑️</button>
            </div>
          </div>
          ${note.image ? `<img src="${note.image}" class="clinical-note-image" onclick="viewNoteImage(${realIdx})">` : ''}
          ${note.aiSummary ? `
            <div class="clinical-note-ai">
              <div class="clinical-note-ai-badge">🤖 AI Summary</div>
              <div class="clinical-note-ai-text">${esc(note.aiSummary)}</div>
            </div>
          ` : ''}
          ${note.text ? `<div class="clinical-note-text">${esc(note.text)}</div>` : ''}
          ${note.author ? `<div class="clinical-note-author">— ${esc(note.author)}</div>` : ''}
        </div>
      `;
    });
    
    html += `</div>`;
  }
  
  html += `</div></div>`;
  $('profileHistory').innerHTML = html;
}

window.addClinicalNote = function() {
  const type = prompt('Note type:\\n• progress\\n• consult\\n• referral\\n• discharge\\n• other') || 'progress';
  const text = prompt('Enter note text:');
  if (!text) return;
  
  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];
  
  p.clinicalNotes.push({
    date: new Date().toISOString(),
    type: type,
    text: text,
    author: state.settings.userName || 'Unknown'
  });
  
  saveCloud();
  renderProfileHistory();
  toast('Note added');
};

window.triggerHistoryUpload = function() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => handleHistoryUpload(e.target.files[0]);
  input.click();
};

async function handleHistoryUpload(file) {
  if (!file) return;
  
  const type = prompt('Document type:\\n• progress\\n• consult\\n• referral\\n• discharge\\n• other') || 'other';
  
  toast('Analyzing document...');
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ 
          action: 'interpret', 
          documentType: 'clinical_note',
          noteType: type,
          image: imageData 
        })
      });
      const data = await res.json();
      
      const p = state.currentPatient;
      if (!p.clinicalNotes) p.clinicalNotes = [];
      
      p.clinicalNotes.push({
        date: new Date().toISOString(),
        type: type,
        image: imageData,
        aiSummary: data.interpretation?.summary || data.interpretation?.text || 'Document uploaded',
        author: state.settings.userName || 'Unknown'
      });
      
      saveCloud();
      renderProfileHistory();
      toast('Document analyzed and saved');
    } catch (e) {
      toast('Failed to analyze document', true);
    }
  });
}

window.deleteClinicalNote = function(idx) {
  if (!confirm('Delete this note?')) return;
  state.currentPatient.clinicalNotes.splice(idx, 1);
  saveCloud();
  renderProfileHistory();
  toast('Note deleted');
};

window.viewNoteImage = function(idx) {
  const note = state.currentPatient.clinicalNotes[idx];
  if (!note?.image) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'padding:10px;z-index:9999';
  modal.innerHTML = `
    <div class="modal-box" style="max-width:90%;max-height:90vh;padding:0;background:#000">
      <img src="${note.image}" style="max-width:100%;max-height:85vh;object-fit:contain">
      <button onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer">✕ Close</button>
    </div>
  `;
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
};

function renderProfileOverview() {
  const p = state.currentPatient;
  $('profileOverview').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">📋 Diagnosis</div></div>
      <div class="section-body"><div style="font-size:0.95rem;color:var(--text-secondary)">${esc(p.diagnosis) || 'No diagnosis recorded'}</div></div>
    </div>
    <div class="section-card">
      <div class="section-header"><div class="section-title">🩺 Vitals</div><button class="btn btn-secondary btn-xs" onclick="openAddVitals()">Update</button></div>
      <div class="section-body">
        <div class="vitals-grid">
          <div class="vital-card"><div class="vital-icon">❤️</div><div class="vital-value">${p.vitals?.hr || '—'}</div><div class="vital-label">HR</div></div>
          <div class="vital-card"><div class="vital-icon">🩸</div><div class="vital-value">${p.vitals?.bp || '—'}</div><div class="vital-label">BP</div></div>
          <div class="vital-card"><div class="vital-icon">🌡️</div><div class="vital-value">${p.vitals?.temp || '—'}</div><div class="vital-label">Temp</div></div>
          <div class="vital-card"><div class="vital-icon">💨</div><div class="vital-value">${p.vitals?.rr || '—'}</div><div class="vital-label">RR</div></div>
          <div class="vital-card"><div class="vital-icon">🫁</div><div class="vital-value">${p.vitals?.spo2 || '—'}</div><div class="vital-label">SpO₂</div></div>
        </div>
      </div>
    </div>
    <div class="section-card">
      <div class="section-header"><div class="section-title">📝 History & Examination</div><button class="btn btn-secondary btn-xs" onclick="openEditText('history', 'History')">Edit</button></div>
      <div class="section-body">
        <div style="font-size:0.9rem;color:var(--text-secondary);white-space:pre-wrap;min-height:60px">${esc(p.history) || 'Tap Edit to add...'}</div>
      </div>
    </div>
  `;
}

function renderProfileLabs() {
  const p = state.currentPatient;
  const labData = p.labData || { dates: [], parameters: [] };
  
  let html = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">🧪 Laboratory Results</div>
        ${labData.parameters?.length ? `<button class="btn btn-danger btn-sm" onclick="clearPatientLabs()" style="padding:4px 8px;font-size:0.7rem">🗑️ Clear</button>` : ''}
      </div>
      <div class="section-body">
        <div class="lab-upload-area ${state.isAnalyzingLab ? 'analyzing' : ''}" onclick="triggerLabUpload()">
          ${state.isAnalyzingLab ? `
            <div class="lab-upload-icon">⏳</div>
            <div class="lab-upload-title">Analyzing Lab Report...</div>
            <div class="lab-upload-subtitle">AI is extracting and interpreting values</div>
          ` : `
            <div class="lab-upload-icon">📷</div>
            <div class="lab-upload-title">Upload Lab Report</div>
            <div class="lab-upload-subtitle">Smart OCR • Kuwait MOH format supported</div>
          `}
        </div>
  `;
  
  if (!labData.parameters?.length) {
    html += `<div style="text-align:center;padding:20px;color:var(--text-muted)">No lab results yet</div></div></div>`;
    $('profileLabs').innerHTML = html;
    return;
  }
  
  // Critical Alert
  const criticals = [];
  labData.parameters.forEach(param => {
    const latest = param.values?.[0];
    if (latest?.status === 'critical' || latest?.status === 'high') {
      criticals.push(`${param.name}: ${latest.value} ${param.unit || ''}`);
    }
  });
  
  if (criticals.length) {
    html += `
        <div class="critical-alert">
          <div class="critical-alert-icon">⚠️</div>
          <div class="critical-alert-content">
            <div class="critical-alert-title">Abnormal Values Detected</div>
            <div class="critical-alert-values">${criticals.join(' • ')}</div>
          </div>
        </div>
    `;
  }
  
  // AI Interpretation with Feedback
  if (labData.interpretation?.summary) {
    const interp = labData.interpretation;
    html += `
        <div class="ai-interpretation">
          <div class="ai-interpretation-header">
            <div class="ai-interpretation-title">🤖 AI Interpretation <span class="ai-badge">NEURAL</span></div>
          </div>
          <div class="ai-interpretation-text">${esc(interp.summary)}</div>
          
          ${interp.clinicalCorrelation ? `
          <div class="ai-details">
            <div class="ai-details-title">Clinical Correlation</div>
            <p style="font-size:0.85rem;color:var(--text-secondary);margin:0">${esc(interp.clinicalCorrelation)}</p>
          </div>
          ` : ''}
          
          ${interp.trends?.length ? `
          <div class="ai-details">
            <div class="ai-details-title">📈 Trends</div>
            <ul class="ai-details-list">
              ${interp.trends.map(t => `<li>${esc(t)}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
          
          ${interp.recommendations?.length ? `
          <div class="ai-details">
            <div class="ai-details-title">💡 Recommendations</div>
            <ul class="ai-details-list">
              ${interp.recommendations.map(r => `<li>${esc(r)}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
          
          <div class="feedback-section">
            <div>
              <div class="feedback-label">Was this interpretation helpful?</div>
              <div class="feedback-sent">✓ Feedback recorded</div>
            </div>
            <div class="feedback-buttons">
              <button class="feedback-btn positive" onclick="sendFeedback(1, 'lab')" title="Helpful">👍</button>
              <button class="feedback-btn negative" onclick="sendFeedback(-1, 'lab')" title="Not helpful">👎</button>
            </div>
          </div>
        </div>
    `;
  }
  
  // Lab Values by Category
  const sortedDates = [...(labData.dates || [])].sort((a, b) => new Date(b) - new Date(a));
  const latestDate = sortedDates[0];
  
  if (latestDate) {
    const categories = {};
    labData.parameters.forEach(param => {
      const latestVal = param.values?.find(v => v.date === latestDate);
      if (latestVal) {
        const cat = getLabCategory(param.name);
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ ...param, latestValue: latestVal });
      }
    });
    
    html += `<div style="margin-bottom:8px;font-size:0.75rem;color:var(--text-muted)">📅 Results from ${formatShortDate(latestDate)}</div>`;
    
    const catOrder = ['Renal Function', 'Electrolytes', 'Glucose & Metabolic', 'Liver Function', 'Complete Blood Count', 'Other'];
    catOrder.forEach(cat => {
      if (!categories[cat]?.length) return;
      const catData = CONFIG.LAB_CATEGORIES[cat];
      
      html += `
        <div class="lab-category">
          <div class="lab-category-header">${catData?.icon || '🔬'} ${cat}</div>
          <div class="lab-category-body">
            <div class="lab-values-grid">
      `;
      
      categories[cat].forEach((param, catIdx) => {
        const v = param.latestValue;
        const status = v.status || 'normal';
        const paramIdx = labData.parameters.findIndex(p => p.name === param.name);
        const valueIdx = param.values?.findIndex(val => val.date === latestDate) || 0;
        html += `
          <div class="lab-value-card ${status}" onclick="openLabOverride(${paramIdx}, ${valueIdx})" title="Click to override">
            <div class="lab-value-name">
              ${esc(param.name)}
              ${v.manualOverride ? '<span class="lab-override-indicator">✏️</span>' : ''}
              ${status !== 'normal' ? `<span class="lab-value-status ${status}">${status === 'high' ? 'HIGH' : status === 'low' ? 'LOW' : '!'}</span>` : ''}
            </div>
            <div class="lab-value-number">${esc(v.value)}</div>
            <div class="lab-value-unit">${esc(param.unit || '')}</div>
            ${param.refMin !== undefined && param.refMax !== undefined ? `<div class="lab-value-range">Reference: ${param.refMin} - ${param.refMax}</div>` : ''}
          </div>
        `;
      });
      
      html += `</div></div></div>`;
    });
  }
  
  // Trend Chart
  if (labData.parameters.length > 0) {
    html += `
      <div class="lab-trend-section">
        <div class="lab-trend-header">
          <div class="section-title">📈 Trends</div>
          <select class="lab-trend-select" id="labTrendSelect" onchange="renderLabTrendChart()">
            ${labData.parameters.map((p, i) => `<option value="${i}">${esc(p.name)}</option>`).join('')}
          </select>
        </div>
        <div class="lab-trend-chart"><canvas id="labTrendChart"></canvas></div>
      </div>
    `;
  }
  
  html += '</div></div>';
  $('profileLabs').innerHTML = html;
  
  if (labData.parameters.length > 0) {
    setTimeout(() => renderLabTrendChart(), 100);
  }
}

window.renderLabTrendChart = function() {
  const p = state.currentPatient;
  const labData = p?.labData;
  if (!labData?.parameters?.length) return;
  
  const idx = parseInt($('labTrendSelect')?.value) || 0;
  const param = labData.parameters[idx];
  if (!param?.values?.length) return;
  
  const ctx = $('labTrendChart');
  if (!ctx) return;
  
  if (state.trendChart) state.trendChart.destroy();
  
  const values = [...param.values].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-10);
  const labels = values.map(v => formatShortDate(v.date));
  const data = values.map(v => parseFloat(v.value) || 0);
  const colors = values.map(v => v.status === 'high' || v.status === 'critical' ? '#f43f5e' : v.status === 'low' ? '#3b82f6' : '#10b981');
  
  state.trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: param.name,
        data,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245,158,11,0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: colors,
        pointBorderColor: colors,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', font: { size: 10 } } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
};

window.triggerLabUpload = function() {
  if (state.isAnalyzingLab) return;
  $('labFileInput').click();
};

// ═══════════════════════════════════════════════════════════════════
// ENHANCED LAB EXTRACTION (Kuwait MOH Format Support)
// ═══════════════════════════════════════════════════════════════════

const LAB_EXTRACTION_PROMPT = `You are a medical laboratory report extraction system. Analyze this lab report image with extreme precision.

CRITICAL INSTRUCTIONS:
1. Extract ALL visible lab values, dates, and reference ranges
2. Pay special attention to:
   - Date format: Look for DD/MM/YYYY or MM/DD/YYYY patterns
   - Cumulative/historical data tables showing multiple dates
   - Age-specific reference ranges (e.g., "<50 years: >450 pg/ml")
   - Units (pg/ml, mmol/L, mg/dL, etc.)
   - Patient demographics if visible

3. For each parameter found, extract:
   - Parameter name (standardized: e.g., "NT-proBNP" not "NT pro BNP")
   - Value (numeric only)
   - Unit
   - Reference range (min-max or descriptive)
   - Date of test (convert to ISO format YYYY-MM-DD)
   - Status: "critical", "high", "low", or "normal" based on reference ranges

4. IMPORTANT FOR KUWAIT MOH FORMAT:
   - Look for "PATIENT CUMULATIVE REPORT" section with historical values
   - Parse the table showing multiple dates and sample numbers
   - Extract ALL historical values, not just the latest
   - Note the "Special Range" section for age-specific cutoffs
   - Handle formats like "16/01/2026 04:32:56" for dates

5. NT-proBNP Specific (ICON Criteria for Acute HF):
   - Rule IN HF for <50 years: >450 pg/ml
   - Rule IN HF for 50-75 years: >900 pg/ml  
   - Rule IN HF for >75 years: >1800 pg/ml
   - Rule OUT HF (all ages): <300 pg/ml
   - Chronic HF (ESC): >125 pg/ml

6. Common Lab Mappings:
   - "NT proBNP" / "NT-proBNP" / "ProBNP" → standardize to "NT-proBNP"
   - Apply age-based reference interpretation for cardiac markers

Return a JSON object with this exact structure:
{
  "confidence": 0.0-1.0,
  "patientInfo": {
    "name": "string or null",
    "hospitalId": "string or null", 
    "dateOfBirth": "YYYY-MM-DD or null",
    "gender": "Male/Female or null",
    "location": "string or null"
  },
  "labData": {
    "dates": ["YYYY-MM-DD", ...],
    "parameters": [
      {
        "name": "Standard Parameter Name",
        "abbrev": "Abbreviation",
        "unit": "unit string",
        "refMin": number or null,
        "refMax": number or null,
        "refDescription": "Age-specific or contextual reference info",
        "values": [
          {
            "date": "YYYY-MM-DD",
            "value": number,
            "status": "critical|high|low|normal"
          }
        ]
      }
    ],
    "interpretation": {
      "summary": "Brief clinical interpretation",
      "clinicalCorrelation": "Clinical context",
      "trends": ["Notable trends"],
      "recommendations": ["Actionable recommendations"]
    }
  }
}

RESPOND ONLY WITH VALID JSON. No markdown, no explanation.`;

async function handleLabUpload(file) {
  state.isAnalyzingLab = true;
  renderProfileLabs();
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      console.log('🔬 Starting enhanced lab extraction...');
      console.log('📡 API:', state.settings.apiUrl.substring(0, 50) + '...');
      console.log('🖼️ Image size:', Math.round(imageData.length / 1024), 'KB');
      
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ 
          action: 'analyzeLabsEnhanced', 
          image: imageData,
          extractionPrompt: LAB_EXTRACTION_PROMPT,
          patientContext: {
            existingLabs: state.currentPatient?.labData?.parameters?.map(p => ({
              name: p.name,
              latestValue: p.values?.[0]?.value,
              latestDate: p.values?.[0]?.date
            })) || []
          }
        })
      });
      
      console.log('📥 Response status:', res.status);
      
      const data = await res.json();
      console.log('📦 Extraction result:', data);
      
      state.isAnalyzingLab = false;
      
      if (data.error || !data.labData) {
        console.error('❌ Extraction error:', data.error);
        toast(data.error || 'Extraction failed', true);
        renderProfileLabs();
        return;
      }
      
      // Store for preview before confirmation
      state.pendingLabData = data.labData;
      state.labExtractionConfidence = data.confidence || 0.8;
      state.currentInteractionId = data.meta?.interactionId;
      
      console.log('✅ Extraction successful, showing preview...');
      console.log('📊 Parameters found:', data.labData.parameters?.length || 0);
      console.log('📅 Dates found:', data.labData.dates?.length || 0);
      
      // Show preview modal for user verification
      showLabExtractionPreview(data);
      
    } catch (e) {
      console.error('❌ Lab extraction error:', e);
      state.isAnalyzingLab = false;
      toast('Extraction failed - check connection', true);
      renderProfileLabs();
    }
  });
}

function showLabExtractionPreview(data) {
  const ld = data.labData;
  const confidence = data.confidence || 0.8;
  const confPercent = Math.round(confidence * 100);
  const confClass = confidence >= 0.8 ? 'high' : confidence >= 0.5 ? 'medium' : 'low';
  
  // Build confidence indicator
  $('labExtractionConfidence').innerHTML = `
    <div class="extraction-confidence">
      <span>Extraction Confidence:</span>
      <div class="confidence-bar">
        <div class="confidence-fill ${confClass}" style="width:${confPercent}%"></div>
      </div>
      <span class="confidence-label">${confPercent}%</span>
    </div>
    ${confidence < 0.7 ? '<p style="color:var(--orange);font-size:0.8rem;margin-bottom:12px">⚠️ Low confidence - please verify values manually</p>' : ''}
  `;
  
  // Build preview table
  let previewHtml = '<div class="extraction-preview">';
  previewHtml += `<div class="extraction-preview-header">
    <span class="extraction-preview-title">Extracted Values</span>
    ${ld.dates?.length ? `<span style="font-size:0.75rem;color:var(--text-muted)">${ld.dates.length} date(s) found</span>` : ''}
  </div>`;
  
  (ld.parameters || []).forEach(param => {
    const latestVal = param.values?.[0];
    if (!latestVal) return;
    
    const statusClass = latestVal.status || 'normal';
    previewHtml += `
      <div class="extraction-item">
        <span class="extraction-name">${esc(param.name)} ${param.unit ? '(' + param.unit + ')' : ''}</span>
        <span class="extraction-value ${statusClass}">
          ${latestVal.value}
          ${param.values.length > 1 ? '<span style="font-size:0.7rem;color:var(--text-muted)"> +' + (param.values.length-1) + ' historical</span>' : ''}
        </span>
      </div>
    `;
  });
  
  previewHtml += '</div>';
  
  // Add interpretation preview if available
  if (ld.interpretation?.summary) {
    previewHtml += `
      <div style="margin-top:16px;padding:16px;background:rgba(139,92,246,0.1);border-radius:var(--radius-sm)">
        <div style="font-weight:600;margin-bottom:8px">🤖 AI Interpretation</div>
        <p style="font-size:0.85rem;color:var(--text-secondary)">${esc(ld.interpretation.summary)}</p>
      </div>
    `;
  }
  
  $('labExtractionPreview').innerHTML = previewHtml;
  openModal('labPreviewModal');
}

window.confirmLabExtraction = async function() {
  if (!state.pendingLabData || !state.currentPatient) return;
  
  const p = state.currentPatient;
  const ld = state.pendingLabData;
  
  // Merge dates
  (ld.dates || []).forEach(d => {
    if (!p.labData.dates.includes(d)) p.labData.dates.push(d);
  });
  p.labData.dates.sort((a, b) => new Date(b) - new Date(a));
  
  // Merge parameters intelligently
  (ld.parameters || []).forEach(newParam => {
    let existing = p.labData.parameters.find(ep => 
      ep.name.toLowerCase() === newParam.name.toLowerCase() ||
      (ep.abbrev && newParam.abbrev && ep.abbrev.toLowerCase() === newParam.abbrev.toLowerCase())
    );
    
    if (existing) {
      // Merge values into existing parameter
      (newParam.values || []).forEach(nv => {
        const ev = existing.values.find(x => x.date === nv.date);
        if (ev) { 
          ev.value = nv.value; 
          ev.status = nv.status; 
        } else {
          existing.values.push(nv);
        }
      });
      // Sort values by date descending
      existing.values.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Update metadata
      if (newParam.refMin !== undefined) existing.refMin = newParam.refMin;
      if (newParam.refMax !== undefined) existing.refMax = newParam.refMax;
      if (newParam.unit) existing.unit = newParam.unit;
      if (newParam.refDescription) existing.refDescription = newParam.refDescription;
    } else {
      // Add as new parameter
      if (newParam.values) {
        newParam.values.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      p.labData.parameters.push(newParam);
    }
  });
  
  // Update interpretation
  if (ld.interpretation) p.labData.interpretation = ld.interpretation;
  
  // Force immediate sync (bypass debounce for lab data)
  await forceSync();
  
  renderProfileLabs();
  closeModal('labPreviewModal');
  toast('Lab results saved!');
  
  // Clear pending data
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
};

window.resetLabExtraction = function() {
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
  state.isAnalyzingLab = false;
  renderProfileLabs();
};

function renderProfileImaging() {
  const p = state.currentPatient;
  const imaging = p.imaging || [];
  
  $('profileImaging').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">📷 Imaging & Studies</div></div>
      <div class="section-body">
        <div class="lab-upload-area ${state.isAnalyzingImaging ? 'analyzing' : ''}" onclick="triggerImagingUpload()">
          ${state.isAnalyzingImaging ? `
            <div class="lab-upload-icon">⏳</div>
            <div class="lab-upload-title">Analyzing...</div>
          ` : `
            <div class="lab-upload-icon">🩻</div>
            <div class="lab-upload-title">Upload Study</div>
            <div class="lab-upload-subtitle">Echo • ECG • X-Ray • CT/MRI</div>
          `}
        </div>
        
        ${imaging.length ? imaging.slice().reverse().map((img, idx) => `
          <div class="imaging-card">
            <div class="imaging-card-header">
              <div class="imaging-type">
                ${img.type === 'ecg' ? '📈' : img.type === 'echo' ? '💓' : img.type === 'xray' ? '🩻' : '🧠'}
                ${(img.type || 'Study').toUpperCase()}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span class="imaging-date">${formatDateTime(img.date)}</span>
                <button class="btn btn-ghost btn-xs" onclick="deleteImaging(${imaging.length - 1 - idx})">🗑️</button>
              </div>
            </div>
            <div class="imaging-summary">${esc(img.summary) || 'No findings recorded'}</div>
          </div>
        `).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No imaging studies</div>'}
      </div>
    </div>
  `;
}

window.triggerImagingUpload = function() {
  if (state.isAnalyzingImaging) return;
  $('imagingFileInput').click();
};

async function handleImagingUpload(file) {
  state.isAnalyzingImaging = true;
  renderProfileImaging();
  
  const type = prompt('Enter study type:\n• echo\n• ecg\n• xray\n• ct') || 'xray';
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'interpret', documentType: type, image: imageData })
      });
      const data = await res.json();
      
      state.isAnalyzingImaging = false;
      
      const p = state.currentPatient;
      if (!p.imaging) p.imaging = [];
      
      p.imaging.push({
        date: new Date().toISOString(),
        type: type,
        summary: data.interpretation?.summary || data.interpretation?.impression || data.interpretation?.conclusion || 'Analysis complete'
      });
      
      saveCloud();
      renderProfileImaging();
      toast('Imaging added!');
    } catch (e) {
      state.isAnalyzingImaging = false;
      toast('Analysis failed', true);
      renderProfileImaging();
    }
  });
}

window.deleteImaging = function(idx) {
  if (!confirm('Delete this imaging study?')) return;
  state.currentPatient.imaging.splice(idx, 1);
  saveCloud();
  renderProfileImaging();
  toast('Imaging deleted');
};

window.clearPatientLabs = function() {
  if (!confirm('Delete all lab results for this patient?')) return;
  state.currentPatient.labData = { dates: [], parameters: [] };
  saveCloud();
  renderProfileLabs();
  toast('Lab data cleared');
};

function renderProfileFluids() {
  const p = state.currentPatient;
  const fluids = p.fluids || [];
  const totalIntake = fluids.reduce((s, f) => s + (f.intake || 0), 0);
  const totalOutput = fluids.reduce((s, f) => s + (f.output || 0), 0);
  const balance = totalIntake - totalOutput;
  
  $('profileFluids').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">💧 Fluid Balance</div><button class="btn btn-primary btn-xs" onclick="openAddFluid()">+ Add</button></div>
      <div class="section-body">
        <div class="fluid-summary">
          <div class="fluid-stat"><div class="fluid-stat-value intake">${totalIntake}</div><div class="fluid-stat-label">Intake (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value output">${totalOutput}</div><div class="fluid-stat-label">Output (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value balance" style="color:${balance >= 0 ? 'var(--emerald)' : 'var(--rose)'}">${balance >= 0 ? '+' : ''}${balance}</div><div class="fluid-stat-label">Balance</div></div>
        </div>
        ${fluids.length ? `<div class="fluid-chart-container"><canvas id="fluidChart"></canvas></div>` : ''}
      </div>
    </div>
  `;
  
  if (fluids.length) setTimeout(() => renderFluidChart(fluids), 100);
}

function renderFluidChart(fluids) {
  const ctx = $('fluidChart');
  if (!ctx) return;
  if (state.fluidChart) state.fluidChart.destroy();
  
  state.fluidChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fluids.map(f => formatDateTime(f.date).split(',')[0]),
      datasets: [
        { label: 'Intake', data: fluids.map(f => f.intake || 0), backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 6 },
        { label: 'Output', data: fluids.map(f => f.output || 0), backgroundColor: 'rgba(249,115,22,0.7)', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#9ca3af' } } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
}

function renderProfilePlans() {
  const p = state.currentPatient;
  const plans = p.plans || [];
  
  $('profilePlans').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">📝 Management Plans</div><button class="btn btn-primary btn-xs" onclick="openAddPlan()">+ Add</button></div>
      <div class="section-body">
        ${plans.length ? plans.slice().reverse().map((plan, idx) => `
          <div class="plan-item">
            <div class="plan-item-header">
              <div class="plan-item-date">${formatDateTime(plan.date)}</div>
              <button class="btn btn-ghost btn-xs" onclick="deletePlan(${plans.length - 1 - idx})">🗑️</button>
            </div>
            <div class="plan-item-content">${esc(plan.content)}</div>
          </div>
        `).join('') : '<div style="text-align:center;padding:30px;color:var(--text-muted)">No plans recorded</div>'}
      </div>
    </div>
  `;
}

window.deletePlan = function(idx) {
  if (!confirm('Delete?')) return;
  state.currentPatient.plans.splice(idx, 1);
  saveCloud();
  renderProfilePlans();
};

// ═══════════════════════════════════════════════════════════════════
// DATA MODALS
// ═══════════════════════════════════════════════════════════════════

window.openEditText = function(type, title) {
  $('editTextTitle').textContent = 'Edit ' + title;
  $('editTextType').value = type;
  $('editTextArea').value = state.currentPatient[type] || '';
  openModal('editTextModal');
};

window.saveEditText = function() {
  state.currentPatient[$('editTextType').value] = $('editTextArea').value;
  saveCloud();
  renderPatientProfile();
  closeModal('editTextModal');
  toast('Saved!');
};

window.openAddVitals = function() {
  state.addDataType = 'vitals';
  $('addDataTitle').textContent = 'Update Vitals';
  const v = state.currentPatient.vitals || {};
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group"><label class="form-label">Heart Rate</label><input type="text" id="addHR" class="form-input" value="${v.hr || ''}"></div>
      <div class="form-group"><label class="form-label">Blood Pressure</label><input type="text" id="addBP" class="form-input" value="${v.bp || ''}" placeholder="120/80"></div>
      <div class="form-group"><label class="form-label">Temperature</label><input type="text" id="addTemp" class="form-input" value="${v.temp || ''}"></div>
      <div class="form-group"><label class="form-label">Respiratory Rate</label><input type="text" id="addRR" class="form-input" value="${v.rr || ''}"></div>
      <div class="form-group"><label class="form-label">SpO₂</label><input type="text" id="addSpO2" class="form-input" value="${v.spo2 || ''}"></div>
    </div>
  `;
  openModal('addDataModal');
};

window.openAddFluid = function() {
  state.addDataType = 'fluid';
  $('addDataTitle').textContent = 'Add Fluid Entry';
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group"><label class="form-label">Intake (mL)</label><input type="number" id="addIntake" class="form-input" value="0"></div>
      <div class="form-group"><label class="form-label">Output (mL)</label><input type="number" id="addOutput" class="form-input" value="0"></div>
    </div>
  `;
  openModal('addDataModal');
};

window.openAddPlan = function() {
  state.addDataType = 'plan';
  $('addDataTitle').textContent = 'Add Plan';
  $('addDataBody').innerHTML = '<div class="form-group"><label class="form-label">Plan</label><textarea id="addPlanContent" class="form-textarea" style="min-height:150px"></textarea></div>';
  openModal('addDataModal');
};

window.saveAddData = function() {
  const p = state.currentPatient;
  const type = state.addDataType;
  const now = new Date().toISOString();
  
  if (type === 'vitals') {
    p.vitals = { hr: $('addHR').value, bp: $('addBP').value, temp: $('addTemp').value, rr: $('addRR').value, spo2: $('addSpO2').value };
  } else if (type === 'fluid') {
    if (!p.fluids) p.fluids = [];
    p.fluids.push({ date: now, intake: parseInt($('addIntake').value) || 0, output: parseInt($('addOutput').value) || 0 });
  } else if (type === 'plan') {
    if (!p.plans) p.plans = [];
    p.plans.push({ date: now, content: $('addPlanContent').value });
  }
  
  saveCloud();
  renderPatientProfile();
  closeModal('addDataModal');
  toast('Saved!');
};

window.editCurrentPatient = function() {
  const p = state.currentPatient;
  $('patientModalTitle').textContent = 'Edit Patient';
  $('ptId').value = p.id;
  $('ptName').value = p.name;
  $('ptWard').value = p.ward;
  $('ptRoom').value = p.room || '';
  $('ptDx').value = p.diagnosis || '';
  $('ptDoctor').value = p.doctor || '';
  $('ptStatus').value = p.status;
  openModal('patientModal');
};

window.deleteCurrentPatient = function() {
  if (!confirm('Delete patient?')) return;
  state.patients = state.patients.filter(p => p.id !== state.currentPatient.id);
  saveCloud();
  closePatientProfile();
  toast('Deleted');
};

// ═══════════════════════════════════════════════════════════════════
// UNIT ACCESS & AUTH
// ═══════════════════════════════════════════════════════════════════

function openUnitAccess(id) {
  console.log('openUnitAccess called with id:', id);
  
  const u = getUnit(id);
  if (!u) {
    console.error('Unit not found:', id);
    toast('Unit not found', true);
    return;
  }
  
  console.log('Opening access modal for unit:', u.name);
  
  state.selectedUnitId = id;
  $('accessIcon').textContent = u.icon;
  $('accessTitle').textContent = u.name;
  $('codeError').classList.remove('show');
  $('userSection').style.display = 'none';
  $('enterBtn').style.display = 'none';
  $('codeInputs').innerHTML = [0,1,2,3].map(i => `<input type="tel" class="code-digit" maxlength="1" data-idx="${i}" inputmode="numeric">`).join('');
  
  const inputs = $$('.code-digit');
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', () => {
      inp.value = inp.value.replace(/\D/g, '');
      if (inp.value && idx < 3) inputs[idx + 1].focus();
      const code = Array.from(inputs).map(i => i.value).join('');
      if (code.length === 4) {
        console.log('Code entered:', code, 'Expected:', u.code);
        if (code === u.code) {
          console.log('Code correct!');
          inputs.forEach(i => { i.classList.add('success'); i.disabled = true; });
          $('userSection').style.display = 'block';
          $('enterBtn').style.display = 'flex';
          $('userName').focus();
        } else {
          console.log('Code incorrect');
          $('codeError').classList.add('show');
          inputs.forEach(i => i.classList.add('error'));
          setTimeout(() => { inputs.forEach(i => { i.classList.remove('error'); i.value = ''; }); inputs[0].focus(); }, 500);
        }
      }
    });
    inp.addEventListener('keydown', e => { if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus(); });
  });
  
  openModal('accessModal');
  setTimeout(() => inputs[0].focus(), 100);
}

// Make openUnitAccess globally accessible
window.openUnitAccess = openUnitAccess;

window.enterUnit = function() {
  const n = $('userName').value.trim();
  if (!n) { toast('Enter name', true); return; }
  state.currentUnit = getUnit(state.selectedUnitId);
  state.currentUser = { name: n, role: $('userRole').value };
  closeModal('accessModal');
  showPage('dashboard');
  $('unitBadge').textContent = state.currentUnit.name;
  $('dashAvatar').textContent = initials(state.currentUser.name);
  $('currentDate').textContent = formatDate();
  renderPatients();
  renderRef();
  toast(`Welcome, ${state.currentUser.name}!`);
};

window.logout = function() {
  state.currentUnit = null;
  state.currentUser = null;
  state.currentFilter = 'all';
  showPage('landing');
};

function showTab(tabName) {
  $$('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add('active');
  $$('.panel').forEach(p => p.classList.remove('active'));
  $('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

function showProfileTab(tabName) {
  $$('.profile-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-tab[data-ptab="${tabName}"]`)?.classList.add('active');
  $$('.profile-panel').forEach(p => p.classList.remove('active'));
  $('profile' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

// Admin functions
window.openAdminLogin = function() { $('adminPwd').value = ''; $('adminError').classList.remove('show'); openModal('adminModal'); };
window.loginAdmin = function() { if ($('adminPwd').value === state.settings.adminPassword) { closeModal('adminModal'); showPage('adminPanel'); $('apiUrl').value = state.settings.apiUrl || ''; $('drugRefUrl').value = state.settings.drugRefUrl || ''; renderUnitsTable(); loadUnitRequests(); } else $('adminError').classList.add('show'); };
window.exitAdmin = function() { showPage('landing'); };
window.addUnit = function() { state.editingUnitId = null; $('unitModalTitle').textContent = 'Add Unit'; $('uName').value = ''; $('uIcon').value = '🏥'; $('uCode').value = ''; $('uDesc').value = ''; openModal('unitModal'); };
window.editUnit = function(id) { const u = getUnit(id); if (!u) return; state.editingUnitId = id; $('unitModalTitle').textContent = 'Edit Unit'; $('uName').value = u.name; $('uIcon').value = u.icon; $('uCode').value = u.code; $('uDesc').value = u.desc || ''; openModal('unitModal'); };
window.saveUnit = function() { const name = $('uName').value.trim(), icon = $('uIcon').value.trim() || '🏥', code = $('uCode').value.trim(), desc = $('uDesc').value.trim(); if (!name || !/^\d{4}$/.test(code)) { toast('Invalid', true); return; } if (state.editingUnitId) { const i = state.units.findIndex(u => u.id === state.editingUnitId); if (i !== -1) state.units[i] = { ...state.units[i], name, icon, code, desc }; } else { state.units.push({ id: 'u' + Date.now(), name, icon, code, desc, color: ['#f59e0b', '#14b8a6', '#3b82f6', '#8b5cf6'][state.units.length % 4] }); } saveCloud(); renderUnitsTable(); renderUnits(); closeModal('unitModal'); toast('Saved!'); };
window.deleteUnit = function(id) { if (!confirm('Delete?')) return; state.units = state.units.filter(u => u.id !== id); saveCloud(); renderUnitsTable(); renderUnits(); };
window.saveSettings = function() { const p = $('newAdminPwd').value.trim(), u = $('apiUrl').value.trim(), d = $('drugRefUrl').value.trim(); if (p) state.settings.adminPassword = p; if (u) state.settings.apiUrl = u; state.settings.drugRefUrl = d; saveCloud(); toast('Saved!'); $('newAdminPwd').value = ''; };

// Admin Tab Navigation
$('adminTabs')?.addEventListener('click', e => {
  const tab = e.target.closest('.admin-tab');
  if (!tab) return;
  $$('.admin-tab').forEach(t => t.classList.remove('active'));
  $$('.admin-tab-panel').forEach(p => p.classList.remove('active'));
  tab.classList.add('active');
  const panelId = 'admin' + tab.dataset.atab.charAt(0).toUpperCase() + tab.dataset.atab.slice(1);
  $(panelId)?.classList.add('active');
});

// ═══════════════════════════════════════════════════════════════════
// UNIT REQUEST SYSTEM
// ═══════════════════════════════════════════════════════════════════

window.openRequestUnit = function() {
  // Reset form
  $('reqName').value = '';
  $('reqEmail').value = '';
  $('reqDepartment').value = '';
  $('reqRole').value = '';
  $('reqUnitName').value = '';
  $('reqMessage').value = '';
  state.selectedIcon = '🏥';
  
  // Reset icon selection
  $$('.request-icon-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelector('.request-icon-option[data-icon="🏥"]')?.classList.add('selected');
  
  // Show form, hide success
  $('requestFormSection').style.display = 'block';
  $('requestSuccessSection').style.display = 'none';
  $('requestFormFooter').style.display = 'flex';
  $('requestSuccessFooter').style.display = 'none';
  
  openModal('requestUnitModal');
};

// Icon selection
$('iconGrid')?.addEventListener('click', e => {
  const opt = e.target.closest('.request-icon-option');
  if (!opt) return;
  $$('.request-icon-option').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  state.selectedIcon = opt.dataset.icon;
});

window.submitUnitRequest = async function() {
  const name = $('reqName').value.trim();
  const email = $('reqEmail').value.trim();
  const department = $('reqDepartment').value.trim();
  const role = $('reqRole').value;
  const unitName = $('reqUnitName').value.trim();
  const message = $('reqMessage').value.trim();
  const icon = state.selectedIcon;
  
  // Validation
  if (!name || !email || !department || !role || !unitName) {
    toast('Please fill all required fields', true);
    return;
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    toast('Please enter a valid email', true);
    return;
  }
  
  const requestId = 'REQ-' + Date.now().toString(36).toUpperCase();
  const request = {
    id: requestId,
    timestamp: new Date().toISOString(),
    status: 'pending',
    requesterName: name,
    requesterEmail: email,
    department,
    role,
    unitName,
    icon,
    message
  };
  
  // Try to save to cloud if API is configured
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'submitUnitRequest', request })
      });
    } catch (e) {
      console.error('Failed to save request to cloud:', e);
    }
  }
  
  // Also save locally
  if (!state.unitRequests) state.unitRequests = [];
  state.unitRequests.push(request);
  saveLocal();
  
  // Show success
  $('requestIdDisplay').textContent = 'Request ID: ' + requestId;
  $('requestFormSection').style.display = 'none';
  $('requestSuccessSection').style.display = 'block';
  $('requestFormFooter').style.display = 'none';
  $('requestSuccessFooter').style.display = 'flex';
  
  toast('Request submitted successfully!');
};

async function loadUnitRequests() {
  // Load from cloud if possible
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getUnitRequests' })
      });
      const data = await res.json();
      if (data.success && data.requests) {
        state.unitRequests = data.requests;
      }
    } catch (e) {
      console.error('Failed to load requests:', e);
    }
  }
  
  renderUnitRequests();
}

window.refreshRequests = loadUnitRequests;

function renderUnitRequests() {
  const pending = (state.unitRequests || []).filter(r => r.status === 'pending');
  const processed = (state.unitRequests || []).filter(r => r.status !== 'pending');
  
  // Update badge
  const badge = $('requestsCount');
  if (pending.length > 0) {
    badge.textContent = pending.length;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
  
  if (!state.unitRequests?.length) {
    $('requestsList').innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-muted)">
        <div style="font-size:2rem;margin-bottom:12px">📭</div>
        <div>No unit requests yet</div>
      </div>
    `;
    return;
  }
  
  const formatDate = iso => new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  
  let html = '';
  
  // Pending first
  pending.forEach(req => {
    html += `
      <div class="request-card" data-id="${req.id}">
        <div class="request-card-time">${formatDate(req.timestamp)}</div>
        <div class="request-card-header">
          <div class="request-card-title">${req.icon || '🏥'} ${esc(req.unitName)}</div>
          <span class="request-card-status pending">Pending</span>
        </div>
        <div class="request-card-details">
          <div class="request-card-detail">👤 ${esc(req.requesterName)}</div>
          <div class="request-card-detail">📧 ${esc(req.requesterEmail)}</div>
          <div class="request-card-detail">🏥 ${esc(req.department)}</div>
          <div class="request-card-detail">👔 ${roleLabels[req.role] || req.role}</div>
        </div>
        ${req.message ? `<div class="request-card-message">"${esc(req.message)}"</div>` : ''}
        <div class="request-card-actions">
          <button class="btn btn-primary btn-sm" onclick="openApproveRequest('${req.id}')">✅ Review & Approve</button>
          <button class="btn btn-danger btn-sm" onclick="quickRejectRequest('${req.id}')">❌ Reject</button>
        </div>
      </div>
    `;
  });
  
  // Processed (collapsed)
  if (processed.length > 0) {
    html += `<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><h4 style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">📋 Previous Requests (${processed.length})</h4>`;
    processed.slice(0, 10).forEach(req => {
      html += `
        <div class="request-card ${req.status}">
          <div class="request-card-time">${formatDate(req.timestamp)}</div>
          <div class="request-card-header">
            <div class="request-card-title">${req.icon || '🏥'} ${esc(req.unitName)}</div>
            <span class="request-card-status ${req.status}">${req.status === 'approved' ? 'Approved' : 'Rejected'}</span>
          </div>
          <div class="request-card-details">
            <div class="request-card-detail">👤 ${esc(req.requesterName)}</div>
            <div class="request-card-detail">📧 ${esc(req.requesterEmail)}</div>
          </div>
          ${req.assignedCode ? `<div style="margin-top:8px;font-size:0.85rem;color:var(--emerald)">Access Code: <code style="background:var(--bg-card);padding:4px 8px;border-radius:4px">${req.assignedCode}</code></div>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }
  
  $('requestsList').innerHTML = html;
}

window.openApproveRequest = function(requestId) {
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  state.selectedRequestId = requestId;
  
  // Pre-fill form
  $('approveUnitName').value = req.unitName;
  $('approveUnitIcon').value = req.icon || '🏥';
  $('approveUnitCode').value = '';
  $('approveUnitDesc').value = req.department;
  
  // Show request details
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  $('approveRequestDetails').innerHTML = `
    <div style="background:var(--bg);padding:20px;border-radius:var(--radius-sm);margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
        <div style="font-size:2.5rem">${req.icon || '🏥'}</div>
        <div>
          <div style="font-weight:700;font-size:1.1rem">${esc(req.unitName)}</div>
          <div style="color:var(--text-muted);font-size:0.85rem">Requested ${new Date(req.timestamp).toLocaleDateString()}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem">
        <div><span style="color:var(--text-muted)">Requester:</span> ${esc(req.requesterName)}</div>
        <div><span style="color:var(--text-muted)">Email:</span> ${esc(req.requesterEmail)}</div>
        <div><span style="color:var(--text-muted)">Department:</span> ${esc(req.department)}</div>
        <div><span style="color:var(--text-muted)">Role:</span> ${roleLabels[req.role] || req.role}</div>
      </div>
      ${req.message ? `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:0.9rem"><span style="color:var(--text-muted)">Message:</span><br>"${esc(req.message)}"</div>` : ''}
    </div>
  `;
  
  openModal('approveRequestModal');
};

window.approveRequest = async function() {
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  const unitName = $('approveUnitName').value.trim();
  const icon = $('approveUnitIcon').value.trim() || '🏥';
  const code = $('approveUnitCode').value.trim();
  const color = $('approveUnitColor').value;
  const desc = $('approveUnitDesc').value.trim();
  
  if (!unitName || !/^\d{4}$/.test(code)) {
    toast('Please enter a valid unit name and 4-digit code', true);
    return;
  }
  
  // Create the unit
  const newUnit = {
    id: 'u' + Date.now(),
    name: unitName,
    icon,
    code,
    desc,
    color
  };
  
  state.units.push(newUnit);
  
  // Update request status
  req.status = 'approved';
  req.assignedCode = code;
  req.approvedAt = new Date().toISOString();
  
  // Save everything
  await saveCloud();
  
  // Also save request update to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  saveLocal();
  renderUnitsTable();
  renderUnits();
  renderUnitRequests();
  closeModal('approveRequestModal');
  
  toast(`Unit "${unitName}" created with code ${code}!`);
};

window.rejectRequest = async function() {
  if (!confirm('Are you sure you want to reject this request?')) return;
  
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  // Save to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  saveLocal();
  renderUnitRequests();
  closeModal('approveRequestModal');
  toast('Request rejected');
};

window.quickRejectRequest = async function(requestId) {
  if (!confirm('Reject this request?')) return;
  
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {}
  }
  
  saveLocal();
  renderUnitRequests();
  toast('Request rejected');
};

// Patient CRUD
window.openAddPatient = function() { $('patientModalTitle').textContent = 'Add Patient'; $('ptId').value = ''; $('ptName').value = ''; $('ptWard').value = 'Ward 14'; $('ptRoom').value = ''; $('ptDx').value = ''; $('ptDoctor').value = state.currentUser?.name || ''; $('ptStatus').value = 'new'; openModal('patientModal'); };
window.savePatient = function() { const id = $('ptId').value, name = $('ptName').value.trim(); if (!name) { toast('Name required', true); return; } const data = { name, ward: $('ptWard').value, room: $('ptRoom').value.trim() || '—', diagnosis: $('ptDx').value.trim() || 'Pending', doctor: $('ptDoctor').value.trim() || 'Unassigned', status: $('ptStatus').value }; if (id) { const i = state.patients.findIndex(p => p.id === parseInt(id)); if (i !== -1) { state.patients[i] = { ...state.patients[i], ...data }; if (state.currentPatient?.id === parseInt(id)) { state.currentPatient = state.patients[i]; renderPatientProfile(); } } } else { state.patients.push({ id: Date.now(), ...data, labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {} }); } saveCloud(); renderPatients(); closeModal('patientModal'); toast('Saved!'); };

// Import
window.openImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; openModal('importModal'); };
window.resetImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; };
window.extractPatients = async function() {
  if (!state.importImage) { toast('No image selected', true); return; }
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') { toast('API URL not configured. Go to Admin settings.', true); return; }
  
  $('importPreview').style.display = 'none';
  $('importLoading').style.display = 'block';
  $('importError').style.display = 'none';
  
  console.log('🔄 Extracting patients from image...');
  console.log('📡 API:', state.settings.apiUrl.substring(0, 50) + '...');
  console.log('🖼️ Image size:', Math.round(state.importImage.length / 1024), 'KB');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'extractPatients', image: state.importImage })
    });
    
    console.log('📥 Response status:', res.status);
    
    if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);
    
    const d = await res.json();
    console.log('📦 Response:', d);
    
    $('importLoading').style.display = 'none';
    
    if (!d.success) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = d.error || 'API returned an error';
      console.error('❌ API Error:', d.error);
      return;
    }
    
    if (!d.patients?.length) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = 'No patients found in image. Try a clearer screenshot.';
      return;
    }
    
    state.importPatients = d.patients.map((p, i) => ({
      id: Date.now() + i, name: p.name, ward: smartWard(p.ward), room: p.room || '—',
      diagnosis: p.diagnosis || 'Pending', doctor: p.doctor || state.currentUser?.name || 'Unassigned',
      status: p.status === 'chronic' ? 'chronic' : 'active',
      labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {}
    }));
    
    $('importResults').style.display = 'block';
    $('importCount').textContent = state.importPatients.length;
    $('importList').innerHTML = state.importPatients.map(p => `<div class="import-item"><div style="flex:1"><b>${esc(p.name)}</b><div style="font-size:0.75rem;color:var(--text-muted)">${esc(p.room)}</div></div><select class="import-ward-select" onchange="state.importPatients.find(x=>x.id===${p.id}).ward=this.value">${CONFIG.VALID_WARDS.map(w => `<option value="${w}" ${w === p.ward ? 'selected' : ''}>${w}</option>`).join('')}</select></div>`).join('');
    $('importConfirmBtn').disabled = false;
    
    console.log('✅ Found', state.importPatients.length, 'patients');
    toast('Found ' + state.importPatients.length + ' patients!');
    
  } catch (e) {
    console.error('❌ Extract error:', e);
    $('importLoading').style.display = 'none';
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = e.message || 'Connection failed';
  }
};
window.confirmImport = function() { if (!state.importPatients.length) return; let added = 0; state.importPatients.forEach(p => { if (!state.patients.some(ep => ep.name.toLowerCase() === p.name.toLowerCase())) { state.patients.push(p); added++; } }); saveCloud(); renderPatients(); closeModal('importModal'); toast(`Imported ${added}!`); };
window.exportPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); const pts = state.currentFilter === 'all' ? [...state.patients] : state.patients.filter(p => p.status === state.currentFilter); if (!pts.length) { toast('No patients', true); return; } doc.setFillColor(245, 158, 11); doc.rect(0, 0, 297, 18, 'F'); doc.setFontSize(16); doc.setTextColor(0); doc.text(state.currentUnit.name + ' - Patient Report', 14, 12); doc.text(formatDate(), 283, 12, 'right'); let y = 28; const wards = {}; pts.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); }); Object.keys(wards).forEach(ward => { if (y > 185) { doc.addPage(); y = 15; } doc.setFillColor(20, 184, 166); doc.rect(14, y, 269, 7, 'F'); doc.setFontSize(9); doc.setTextColor(255); doc.text(ward + ' (' + wards[ward].length + ')', 16, y + 5); y += 10; wards[ward].forEach(p => { if (y > 190) { doc.addPage(); y = 15; } doc.setFillColor(248, 250, 252); doc.rect(14, y, 269, 10, 'F'); doc.setFontSize(8); doc.setTextColor(30); doc.text(p.room || '—', 16, y + 6); doc.text(p.name, 40, y + 6); doc.text((p.diagnosis || '').substring(0, 60), 100, y + 6); doc.text(p.doctor || '', 220, y + 6); y += 12; }); y += 5; }); doc.save(state.currentUnit.name.replace(/\s+/g, '_') + '_Report.pdf'); toast('PDF exported!'); };

// ═══════════════════════════════════════════════════════════════════
// WARD SUGGESTIONS (MANUAL INPUT)
// ═══════════════════════════════════════════════════════════════════

window.showWardSuggestions = function(value) {
  const container = $('wardSuggestions');
  if (!container) return;
  const query = (value || '').toLowerCase().trim();
  
  const commonWards = ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'CCU', 'ER/Unassigned', 'MICU', 'SICU', 'Neuro ICU', 'Cardiac Ward', 'Medical Ward', 'Surgical Ward'];
  
  if (!query) {
    container.innerHTML = commonWards.map(w => 
      `<div class="ward-suggestion" onclick="selectWard('${w}')">${w}</div>`
    ).join('');
    container.classList.add('show');
    return;
  }
  
  const filtered = commonWards.filter(w => 
    w.toLowerCase().includes(query) || 
    w.replace(/\D/g, '').includes(query.replace(/\D/g, ''))
  );
  
  if (filtered.length > 0) {
    container.innerHTML = filtered.map(w => 
      `<div class="ward-suggestion" onclick="selectWard('${w}')">${w}</div>`
    ).join('');
    if (value && !filtered.some(w => w.toLowerCase() === query)) {
      container.innerHTML += `<div class="ward-suggestion" onclick="selectWard('${esc(value)}')" style="color:var(--gold);border-top:1px solid var(--border)">Use: "${esc(value)}"</div>`;
    }
    container.classList.add('show');
  } else {
    container.innerHTML = `<div class="ward-suggestion" onclick="selectWard('${esc(value)}')" style="color:var(--gold)">Use: "${esc(value)}"</div>`;
    container.classList.add('show');
  }
};

window.selectWard = function(ward) {
  $('ptWard').value = ward;
  const container = $('wardSuggestions');
  if (container) container.classList.remove('show');
};

// Hide ward suggestions on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.ward-input-wrapper')) {
    const c = $('wardSuggestions');
    if (c) c.classList.remove('show');
  }
});

// ═══════════════════════════════════════════════════════════════════
// DISCHARGE FUNCTIONALITY
// ═══════════════════════════════════════════════════════════════════

window.openDischargeModal = function(patientId, event) {
  if (event) event.stopPropagation();
  const p = getPatient(patientId);
  if (!p) return;
  if (p.status === 'discharged') {
    toast('Patient already discharged', true);
    return;
  }
  state.dischargePatientId = patientId;
  $('dischargePatientName').textContent = p.name;
  $('dischargeSummary').value = '';
  openModal('dischargeModal');
};

window.confirmDischarge = function() {
  const p = getPatient(state.dischargePatientId);
  if (!p) return;
  
  const summary = $('dischargeSummary').value.trim();
  p.status = 'discharged';
  p.dischargeDate = new Date().toISOString();
  
  if (summary) {
    if (!p.plans) p.plans = [];
    p.plans.push({ date: new Date().toISOString(), content: `🏠 DISCHARGE SUMMARY:\n${summary}` });
  }
  
  saveCloud();
  renderPatients();
  closeModal('dischargeModal');
  toast('Patient discharged');
  
  if (state.currentPatient && state.currentPatient.id === p.id) {
    renderPatientProfile();
  }
};

// ═══════════════════════════════════════════════════════════════════
// LAB OVERRIDE FUNCTIONALITY
// ═══════════════════════════════════════════════════════════════════

window.openLabOverride = function(paramIdx, valueIdx) {
  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]) return;
  
  const param = p.labData.parameters[paramIdx];
  const value = param.values?.[valueIdx];
  
  $('labOverrideName').textContent = `${param.name} (${param.unit || ''})`;
  $('labOverrideValue').value = value?.value || '';
  $('labOverrideParamIdx').value = paramIdx;
  $('labOverrideValueIdx').value = valueIdx;
  
  openModal('labOverrideModal');
};

window.saveLabOverride = function() {
  const paramIdx = parseInt($('labOverrideParamIdx').value);
  const valueIdx = parseInt($('labOverrideValueIdx').value);
  const newValue = $('labOverrideValue').value.trim();
  
  if (!newValue) { toast('Please enter a value', true); return; }
  
  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]?.values?.[valueIdx]) {
    toast('Lab value not found', true);
    return;
  }
  
  const param = p.labData.parameters[paramIdx];
  param.values[valueIdx].value = parseFloat(newValue) || newValue;
  param.values[valueIdx].manualOverride = true;
  param.values[valueIdx].overrideDate = new Date().toISOString();
  
  // Re-evaluate status
  const numVal = parseFloat(newValue);
  if (!isNaN(numVal) && param.refMin !== undefined && param.refMax !== undefined) {
    if (numVal < param.refMin) param.values[valueIdx].status = 'low';
    else if (numVal > param.refMax) param.values[valueIdx].status = 'high';
    else param.values[valueIdx].status = 'normal';
  }
  
  saveCloud();
  renderProfileLabs();
  closeModal('labOverrideModal');
  toast('Lab value updated');
};

// ═══════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════

async function init() {
  console.log('MedWard Pro initializing...');
  
  try {
    loadLocal();
    renderUnits();
    renderScoresGrid();
    renderRef();
    
    // Standard onclick for FABs
    $('adminFab').onclick = openAdminLogin;
    $('syncFab').onclick = manualSync;
    
    $('adminPwd').onkeydown = e => { if (e.key === 'Enter') loginAdmin(); };
    $('userName').onkeydown = e => { if (e.key === 'Enter') enterUnit(); };
    
    // Standard onclick for tabs
    const mainTabs = $('mainTabs');
    if (mainTabs) {
      mainTabs.onclick = e => { 
        const t = e.target.closest('.tab'); 
        if (t) showTab(t.dataset.tab); 
      };
    }
    
    const profileTabs = $('profileTabs');
    if (profileTabs) {
      profileTabs.onclick = e => { 
        const t = e.target.closest('.profile-tab'); 
        if (t) showProfileTab(t.dataset.ptab); 
      };
    }
    
    const statsBar = $('statsBar');
    if (statsBar) {
      statsBar.onclick = e => { 
        const s = e.target.closest('.stat-card'); 
        if (s) { 
          state.currentFilter = s.dataset.filter; 
          renderPatients(); 
        } 
      };
    }
    
    $('labFileInput').onchange = function() { if (this.files[0]) handleLabUpload(this.files[0]); this.value = ''; };
    $('imagingFileInput').onchange = function() { if (this.files[0]) handleImagingUpload(this.files[0]); this.value = ''; };
    $('importFile').onchange = function() { if (this.files[0]) { compress(this.files[0], CONFIG.MAX_IMAGE_SIZE, url => { state.importImage = url; $('importImg').src = url; $('importUpload').style.display = 'none'; $('importPreview').style.display = 'block'; }); } };
    
    // Standard onclick for modal backdrop close
    $$('.modal').forEach(m => {
      m.onclick = e => { if (e.target === m) m.classList.remove('active'); };
    });
    
    console.log('MedWard Pro initialized successfully');
    
    // Initial cloud sync (with error handling)
    try {
      await syncFromCloud();
    } catch (syncError) {
      console.warn('Cloud sync failed, using local data:', syncError);
      toast('Offline mode - using local data');
    }
    
    // Periodic background sync (every 60 seconds) - only if no pending changes
    setInterval(() => {
      if (!syncState.pendingChanges) {
        syncFromCloud().catch(e => console.warn('Background sync failed:', e));
      }
    }, 60000);
    
  } catch (error) {
    console.error('Init error:', error);
    toast('Error initializing app', true);
  }
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();

})();
</script>
</body>
</html>
