<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="theme-color" content="#030712"><meta name="apple-mobile-web-app-capable" content="yes"><title>MedWard Pro v15</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>:root{--bg:#030712;--bg-card:#0a0f1a;--bg-elevated:#111827;--bg-hover:#1f2937;--text:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--gold:#f59e0b;--gold-light:#fbbf24;--teal:#14b8a6;--purple:#8b5cf6;--rose:#f43f5e;--emerald:#10b981;--blue:#3b82f6;--orange:#f97316;--border:rgba(255,255,255,0.08);--border-light:rgba(255,255,255,0.12);--glass:rgba(10,15,26,0.9);--radius:16px;--radius-sm:10px}*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}.mono{font-family:'JetBrains Mono',monospace}.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s}.btn:active{transform:scale(0.97)}.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:#000}.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border-light);color:var(--text)}.btn-secondary:hover{border-color:var(--gold)}.btn-ghost{background:transparent;color:var(--text-secondary);padding:10px}.btn-ghost:hover{color:var(--gold)}.btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}.btn-success{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--emerald)}.btn-success:hover{background:rgba(16,185,129,0.25);border-color:var(--emerald)}.btn-info{background:rgba(56,139,253,0.15);border:1px solid rgba(56,139,253,0.3);color:#58a6ff}.btn-info:hover{background:rgba(56,139,253,0.25);border-color:#58a6ff}.ward-input-wrapper{position:relative}.ward-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--bg-elevated);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);max-height:200px;overflow-y:auto;z-index:10;display:none}.ward-suggestions.show{display:block}.ward-suggestion{padding:12px 16px;cursor:pointer;font-size:0.9rem;transition:background 0.2s}.ward-suggestion:hover{background:var(--bg-hover);color:var(--gold)}.patient-card{position:relative}.patient-card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px}.patient-discharge-btn{padding:6px 12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:6px;color:var(--emerald);font-size:0.7rem;font-weight:600;cursor:pointer;transition:all 0.2s}.patient-discharge-btn:hover{background:rgba(16,185,129,0.2);border-color:var(--emerald)}.patient-discharge-btn.discharged{background:rgba(107,114,128,0.1);border-color:rgba(107,114,128,0.3);color:var(--text-muted);cursor:default}.patient-card.discharged{border-left-color:var(--text-muted);opacity:0.7}.patient-card.discharged .patient-avatar{background:linear-gradient(135deg,var(--text-muted),#4b5563)}.lab-value-card{cursor:pointer;transition:all 0.2s}.lab-value-card:hover{border-color:var(--gold);transform:translateY(-2px)}.lab-override-indicator{font-size:0.6rem;color:var(--gold);margin-left:4px}.med-card-action.info{background:rgba(56,139,253,0.1);border-color:rgba(56,139,253,0.3)}.med-card-action.info:hover{background:rgba(56,139,253,0.2);border-color:#58a6ff}.btn-sm{padding:10px 16px;font-size:0.8rem}.btn-xs{padding:6px 12px;font-size:0.75rem}.btn-full{width:100%}.btn-icon{width:44px;height:44px;padding:0;border-radius:var(--radius-sm)}.form-group{margin-bottom:20px}.form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.9rem;transition:all 0.2s}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold)}.form-textarea{min-height:100px;resize:vertical}.form-input-sm{padding:10px 14px;font-size:0.85rem}.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;font-size:0.65rem;font-weight:700;text-transform:uppercase}.badge-gold{background:rgba(245,158,11,0.15);color:var(--gold)}.badge-teal{background:rgba(20,184,166,0.15);color:var(--teal)}.badge-purple{background:rgba(139,92,246,0.15);color:var(--purple)}.badge-rose{background:rgba(244,63,94,0.15);color:var(--rose)}.badge-emerald{background:rgba(16,185,129,0.15);color:var(--emerald)}.badge-blue{background:rgba(59,130,246,0.15);color:var(--blue)}.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}.modal.active{display:flex}.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:480px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}.modal-box.wide{max-width:700px}.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.modal-title{font-size:1.1rem;font-weight:700}.modal-body{padding:24px;overflow-y:auto;flex:1}.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px}.modal-footer .btn{flex:1}.page{display:none;min-height:100vh;height:100vh;position:fixed;top:0;left:0;right:0;bottom:0;overflow:hidden}.page.active{display:flex;flex-direction:column}#landing{align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at top,#111827 0%,var(--bg) 50%)}.landing-logo{width:88px;height:88px;background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:24px;display:grid;place-items:center;margin-bottom:28px;box-shadow:0 20px 40px rgba(245,158,11,0.3)}.landing-logo svg{width:48px;height:48px;stroke:#000;stroke-width:2.5;fill:none}.landing-title{font-size:2rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.landing-subtitle{color:var(--text-muted);margin-bottom:8px}.landing-version{color:var(--teal);font-size:0.75rem;font-weight:600;margin-bottom:48px}.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;width:100%;max-width:800px}.unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden}.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--gold));transform:scaleX(0);transition:transform 0.3s}.unit-card:hover::before{transform:scaleX(1)}.unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-4px)}.unit-card-icon{font-size:2.5rem;margin-bottom:16px}.unit-card-name{font-size:1.1rem;font-weight:700;margin-bottom:4px}.unit-card-desc{color:var(--text-muted);font-size:0.85rem}.fab{position:fixed;width:56px;height:56px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50;transition:all 0.3s}.fab svg{width:24px;height:24px}.fab:hover{border-color:var(--gold);color:var(--gold)}.admin-fab{bottom:24px;right:24px}.sync-fab{bottom:24px;left:24px}.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}@keyframes rotate{to{transform:rotate(360deg)}}.sync-status{position:fixed;top:12px;right:12px;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:100px;font-size:0.75rem;font-weight:600;z-index:1000;transition:all 0.3s;opacity:0;transform:translateY(-10px);pointer-events:none}.sync-status.visible{opacity:1;transform:translateY(0);pointer-events:auto}.sync-status.syncing{border-color:var(--gold);color:var(--gold)}.sync-status.synced{border-color:var(--emerald);color:var(--emerald)}.sync-status.error{border-color:var(--rose);color:var(--rose)}.sync-status.pending{border-color:var(--orange);color:var(--orange)}.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}.sync-status.syncing .sync-dot{animation:pulse 1s ease infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}.extraction-confidence{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px;font-size:0.8rem}.confidence-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}.confidence-fill{height:100%;border-radius:3px;transition:width 0.5s ease}.confidence-fill.high{background:var(--emerald)}.confidence-fill.medium{background:var(--gold)}.confidence-fill.low{background:var(--rose)}.confidence-label{font-weight:600;min-width:40px;text-align:right}.extraction-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin:16px 0}.extraction-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.extraction-preview-title{font-weight:600;font-size:0.9rem}.extraction-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}.extraction-item:last-child{border-bottom:none}.extraction-name{color:var(--text-secondary)}.extraction-value{font-family:'JetBrains Mono',monospace;font-weight:600}.extraction-value.critical{color:var(--rose)}.extraction-value.high{color:var(--orange)}.extraction-value.low{color:var(--blue)}.extraction-value.normal{color:var(--emerald)}.lab-analysis-loader{position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(12px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:all 0.3s ease}.lab-analysis-loader.active{opacity:1;visibility:visible}.loader-content{text-align:center;max-width:320px;padding:24px}.dna-loader{width:80px;height:80px;margin:0 auto 24px;position:relative}.dna-strand{position:absolute;width:100%;height:100%;animation:dnaRotate 2s linear infinite}.dna-strand:nth-child(2){animation-delay:-1s}.dna-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--gold)}.dna-strand .dna-dot:nth-child(1){top:0;left:50%;transform:translateX(-50%);animation:dnaPulse 1s ease-in-out infinite}.dna-strand .dna-dot:nth-child(2){top:50%;left:0;transform:translateY(-50%);animation:dnaPulse 1s ease-in-out infinite 0.25s;background:var(--teal)}.dna-strand .dna-dot:nth-child(3){bottom:0;left:50%;transform:translateX(-50%);animation:dnaPulse 1s ease-in-out infinite 0.5s}.dna-strand .dna-dot:nth-child(4){top:50%;right:0;transform:translateY(-50%);animation:dnaPulse 1s ease-in-out infinite 0.75s;background:var(--teal)}.dna-connector{position:absolute;top:50%;left:10%;right:10%;height:2px;background:linear-gradient(90deg,var(--gold),var(--teal));transform:translateY(-50%);opacity:0.5}@keyframes dnaRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes dnaPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:0.7}}.loader-title{font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:8px}.loader-subtitle{font-size:0.85rem;color:var(--text-muted);margin-bottom:20px}.loader-steps{text-align:left;background:var(--bg-card);border-radius:var(--radius-sm);padding:16px;border:1px solid var(--border)}.loader-step{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:0.85rem;color:var(--text-muted);transition:all 0.3s}.loader-step:last-child{border-bottom:none}.loader-step.active{color:var(--gold)}.loader-step.complete{color:var(--emerald)}.step-icon{width:24px;height:24px;border-radius:50%;background:var(--bg);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.7rem;transition:all 0.3s}.loader-step.active .step-icon{border-color:var(--gold);background:rgba(245,158,11,0.15);animation:stepPulse 1.5s ease-in-out infinite}.loader-step.complete .step-icon{border-color:var(--emerald);background:var(--emerald);color:#000}@keyframes stepPulse{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4)}50%{box-shadow:0 0 0 8px rgba(245,158,11,0)}}#labPreviewModal .modal-box{max-width:600px;max-height:95vh}#labPreviewModal .modal-header{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(20,184,166,0.05));border-bottom:1px solid rgba(16,185,129,0.2)}#labPreviewModal .modal-body{padding:0;overflow-y:auto}.preview-images{display:flex;gap:8px;padding:16px;background:var(--bg);border-bottom:1px solid var(--border);overflow-x:auto}.preview-images::-webkit-scrollbar{display:none}.preview-thumb{width:64px;height:64px;border-radius:8px;object-fit:cover;border:2px solid var(--teal);flex-shrink:0}.preview-thumb-wrapper{position:relative;flex-shrink:0}.preview-thumb-badge{position:absolute;bottom:-4px;right:-4px;width:20px;height:20px;background:var(--teal);color:#000;border-radius:50%;font-size:0.65rem;font-weight:700;display:flex;align-items:center;justify-content:center}.preview-confidence{padding:16px;background:linear-gradient(180deg,var(--bg-elevated),var(--bg-card));border-bottom:1px solid var(--border)}.confidence-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}.confidence-title{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}.confidence-badge{padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:700}.confidence-badge.high{background:rgba(16,185,129,0.15);color:var(--emerald)}.confidence-badge.medium{background:rgba(245,158,11,0.15);color:var(--gold)}.confidence-badge.low{background:rgba(244,63,94,0.15);color:var(--rose)}.confidence-bar-lg{height:8px;background:var(--border);border-radius:4px;overflow:hidden}.confidence-bar-lg .fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1)}.confidence-bar-lg .fill.high{background:linear-gradient(90deg,var(--emerald),var(--teal))}.confidence-bar-lg .fill.medium{background:linear-gradient(90deg,var(--gold),var(--orange))}.confidence-bar-lg .fill.low{background:linear-gradient(90deg,var(--rose),var(--orange))}.confidence-warning{margin-top:12px;padding:10px 12px;background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.2);border-radius:8px;font-size:0.8rem;color:var(--rose);display:flex;align-items:center;gap:8px}.preview-values{padding:16px}.preview-section{margin-bottom:20px}.preview-section:last-child{margin-bottom:0}.preview-section-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}.preview-section-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.9rem}.preview-section-icon.critical{background:rgba(244,63,94,0.15)}.preview-section-icon.abnormal{background:rgba(245,158,11,0.15)}.preview-section-icon.normal{background:rgba(16,185,129,0.15)}.preview-section-title{font-size:0.8rem;font-weight:700;color:var(--text)}.preview-section-count{font-size:0.7rem;color:var(--text-muted);margin-left:auto}.preview-lab-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px;transition:all 0.2s}.preview-lab-card:last-child{margin-bottom:0}.preview-lab-card:hover{border-color:var(--gold)}.preview-lab-card.critical{border-left:3px solid var(--rose);background:linear-gradient(90deg,rgba(244,63,94,0.08),transparent)}.preview-lab-card.high{border-left:3px solid var(--orange);background:linear-gradient(90deg,rgba(249,115,22,0.08),transparent)}.preview-lab-card.low{border-left:3px solid var(--blue);background:linear-gradient(90deg,rgba(59,130,246,0.08),transparent)}.preview-lab-card.normal{border-left:3px solid var(--emerald)}.preview-lab-info{flex:1;min-width:0}.preview-lab-name{font-size:0.85rem;font-weight:600;color:var(--text);margin-bottom:2px;display:flex;align-items:center;gap:6px}.preview-lab-name .abbrev{font-size:0.7rem;color:var(--text-muted);font-weight:400}.preview-lab-ref{font-size:0.7rem;color:var(--text-muted)}.preview-lab-value{text-align:right}.preview-lab-number{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700}.preview-lab-number.critical{color:var(--rose)}.preview-lab-number.high{color:var(--orange)}.preview-lab-number.low{color:var(--blue)}.preview-lab-number.normal{color:var(--emerald)}.preview-lab-unit{font-size:0.7rem;color:var(--text-muted)}.preview-lab-history{font-size:0.65rem;color:var(--teal);margin-top:2px}.trend-indicator{display:inline-flex;align-items:center;gap:2px;font-size:0.7rem;margin-left:6px}.trend-indicator.up{color:var(--rose)}.trend-indicator.down{color:var(--emerald)}.trend-indicator.stable{color:var(--text-muted)}.preview-interpretation{padding:16px;background:linear-gradient(180deg,rgba(139,92,246,0.05),transparent);border-top:1px solid var(--border)}.interpretation-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:0.8rem;font-weight:700;color:var(--purple)}.interpretation-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.6}.interpretation-findings{margin-top:12px}.interpretation-finding{display:flex;align-items:flex-start;gap:8px;padding:8px 0;font-size:0.8rem;color:var(--text-secondary)}.interpretation-finding::before{content:'•';color:var(--purple);font-weight:bold}.preview-empty{text-align:center;padding:40px 20px;color:var(--text-muted)}.preview-empty-icon{font-size:2rem;margin-bottom:12px;opacity:0.5}.preview-empty-text{font-size:0.9rem}.code-inputs{display:flex;gap:14px;justify-content:center;margin-bottom:20px}.code-digit{width:56px;height:68px;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:700;text-align:center;color:var(--text);transition:all 0.2s}.code-digit:focus{outline:none;border-color:var(--gold)}.code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}.code-digit.error{border-color:var(--rose);animation:shake 0.3s}@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}.code-error{color:var(--rose);font-size:0.85rem;text-align:center;display:none;margin-top:12px}.code-error.show{display:block}#dashboard{background:var(--bg)}.dash-header{background:rgba(10,15,26,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.1);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}.dash-logo{display:flex;align-items:center;gap:10px}.dash-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:10px;display:grid;place-items:center}.dash-logo-icon svg{width:20px;height:20px;stroke:#000;fill:none}.dash-badge{padding:6px 12px;border-radius:100px;font-size:0.75rem;font-weight:600;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05)}.dash-user{display:flex;align-items:center;gap:10px}.dash-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.8rem}.dash-content{flex:1;max-width:1000px;margin:0 auto;padding:16px;padding-bottom:100px;width:100%}.date-banner{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;padding:10px 14px;border-radius:12px;margin-bottom:14px;font-weight:600;font-size:0.8rem;display:flex;align-items:center;gap:8px}.tabs-container{position:fixed;bottom:0;left:0;right:0;background:rgba(10,15,26,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-around;padding:8px 0 calc(8px+env(safe-area-inset-bottom));z-index:1000;gap:0}.tab{flex:1;padding:8px 8px 6px;background:transparent;border:none;border-radius:0;color:var(--text-muted);font-family:inherit;font-size:0.65rem;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:2px;position:relative}.tab:hover{color:var(--text)}.tab.active{color:var(--gold);font-weight:600}.tab.active::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:32px;height:3px;background:var(--gold);border-radius:0 0 3px 3px}.tab-icon{font-size:1.25rem;line-height:1}.tab-label{font-size:0.65rem;letter-spacing:0.02em}.dash-content{padding-bottom:90px}.panel{display:none}.panel.active{display:block}.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}.stat-card{background:#1e293b;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 20px -5px rgba(0,0,0,0.3)}.stat-card:hover,.stat-card.active{border-color:var(--gold);background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(30,41,59,0.5))}.stat-value{font-size:1.3rem;font-weight:800;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-top:4px}.action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}.action-buttons .btn-full{grid-column:span 2}@keyframes shimmer{0%{background-position:-1000px 0}100%{background-position:1000px 0}}.skeleton{animation:shimmer 2s infinite linear;background:linear-gradient(to right,#1e293b 4%,#334155 25%,#1e293b 36%);background-size:1000px 100%;border-radius:8px;height:20px;margin-bottom:10px}.skeleton-text{width:70%;height:16px}.skeleton-title{width:40%;height:24px;margin-bottom:16px}.skeleton-card{background:#1e293b;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px}.label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin-bottom:4px;font-weight:600}.value{font-size:1.1rem;font-weight:600;color:#ffffff}.med-name{font-size:1.2rem;font-weight:700;color:var(--text)}.ward-section{margin-bottom:20px}.ward-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(30,41,59,0.8);backdrop-filter:blur(8px);border-radius:12px;margin-bottom:12px;border-left:4px solid var(--gold)}.ward-title{font-weight:700;font-size:0.9rem;color:var(--gold)}.ward-count{background:var(--gold);color:#000;padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:700}.patient-card{background:#1e293b;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all 0.2s;border-left:4px solid var(--teal);box-shadow:0 4px 20px -5px rgba(0,0,0,0.3)}.patient-card:hover{border-color:rgba(255,255,255,0.15);transform:translateY(-2px);box-shadow:0 8px 30px -5px rgba(0,0,0,0.4)}.patient-card:active{transform:scale(0.98)}.patient-card.critical{border-left-color:var(--rose);background:linear-gradient(90deg,rgba(244,63,94,0.1) 0%,#1e293b 100%)}.patient-card.chronic{border-left-color:var(--purple);background:linear-gradient(90deg,rgba(139,92,246,0.1) 0%,#1e293b 100%)}.patient-card.new{border-left-color:var(--emerald);background:linear-gradient(90deg,rgba(16,185,129,0.1) 0%,#1e293b 100%)}.patient-card.active{border-left-color:var(--gold);background:linear-gradient(90deg,rgba(245,158,11,0.1) 0%,#1e293b 100%)}.patient-header{display:flex;align-items:center;gap:14px}.patient-avatar{width:52px;height:52px;border-radius:14px;display:grid;place-items:center;font-weight:700;font-size:0.9rem;color:#000;flex-shrink:0;background:linear-gradient(135deg,var(--gold),var(--orange))}.patient-card.new .patient-avatar{background:linear-gradient(135deg,var(--emerald),var(--teal))}.patient-card.chronic .patient-avatar{background:linear-gradient(135deg,var(--purple),#a855f7)}.patient-card.critical .patient-avatar{background:linear-gradient(135deg,var(--rose),var(--orange))}.patient-info{flex:1;min-width:0}.patient-name{font-weight:700;font-size:1rem;margin-bottom:4px}.patient-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:0.8rem;color:var(--text-secondary)}.patient-diagnosis{font-size:0.85rem;color:var(--text-secondary);margin-top:12px;padding:12px 14px;background:var(--bg);border-radius:var(--radius-sm)}#patientProfile{background:var(--bg);display:flex;flex-direction:column;height:100vh;overflow:hidden}#patientProfile.active{display:flex}.profile-header{background:rgba(15,23,42,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.1);flex-shrink:0;z-index:10}.patient-header-sticky{position:sticky;top:0;background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:900;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center}.profile-nav{display:flex;align-items:center;gap:10px}.back-btn{width:36px;height:36px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);transition:all 0.2s}.back-btn:hover{border-color:var(--gold);color:var(--gold)}.profile-title{font-size:0.95rem;font-weight:600;flex:1}.profile-actions{display:flex;gap:6px}.profile-actions .btn{padding:6px 10px;font-size:0.7rem}.profile-patient{display:flex;align-items:center;gap:12px;margin-top:10px}.profile-avatar{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;font-size:0.9rem;font-weight:700;color:#000;flex-shrink:0}.profile-details h2{font-size:0.9rem;font-weight:700;margin-bottom:2px}.profile-details .meta{display:flex;flex-wrap:wrap;gap:8px;color:var(--text-secondary);font-size:0.7rem}.profile-body{display:flex;flex:1 1 auto;overflow:hidden;min-height:0;width:100%}.profile-sidebar{width:64px;min-width:64px;flex-shrink:0;background:#0d1117;border-left:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column;padding:12px 6px;gap:6px;overflow-y:auto;order:2}.profile-nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:10px 6px;background:transparent;border:none;border-radius:10px;color:#6b7280;font-family:inherit;font-size:0.6rem;font-weight:500;cursor:pointer;transition:all 0.2s;text-align:center;width:100%;position:relative}.profile-nav-item:hover{color:#9ca3af;background:rgba(255,255,255,0.04)}.profile-nav-item.active{color:#f59e0b;background:rgba(245,158,11,0.15)}.profile-nav-item .nav-icon{font-size:1.2rem}.profile-nav-item .nav-label{font-size:0.55rem;line-height:1.1;max-width:100%;overflow:hidden;text-overflow:ellipsis}.profile-nav-item .nav-badge{position:absolute;top:2px;right:2px;background:var(--rose);color:#fff;font-size:0.5rem;min-width:14px;height:14px;padding:0 3px;border-radius:7px;font-weight:700;display:flex;align-items:center;justify-content:center}.profile-nav-section{display:none}.profile-tabs{display:none}.profile-content{flex:1 1 auto;padding:16px;overflow-y:auto;overflow-x:hidden;background:var(--bg);order:1;min-width:0;width:100%}.profile-panel{display:none}.profile-panel.active{display:block;min-height:200px}.section-card{background:#1e293b;border:1px solid rgba(255,255,255,0.08);border-radius:16px;margin-bottom:16px;overflow:hidden;box-shadow:0 4px 20px -5px rgba(0,0,0,0.3)}.section-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;background:rgba(255,255,255,0.02)}.section-title{font-weight:700;font-size:0.85rem;display:flex;align-items:center;gap:8px}.section-body{padding:16px}.lab-upload-area{background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(20,184,166,0.08));border:2px dashed rgba(255,255,255,0.15);border-radius:12px;padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:16px}.lab-upload-area:hover{border-color:var(--gold);background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(20,184,166,0.12))}.lab-upload-area.analyzing{pointer-events:none;opacity:0.7}.lab-upload-icon{font-size:2rem;margin-bottom:8px}.lab-upload-title{font-weight:700;font-size:0.9rem;margin-bottom:4px}.lab-upload-subtitle{color:var(--text-muted);font-size:0.75rem}@keyframes spin{to{transform:rotate(360deg)}}.ai-interpretation{background:linear-gradient(135deg,rgba(20,184,166,0.08),rgba(59,130,246,0.08));border:1px solid rgba(20,184,166,0.2);border-radius:var(--radius);padding:20px;margin-bottom:24px}.ai-interpretation-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}.ai-interpretation-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--teal)}.ai-badge{background:linear-gradient(135deg,var(--purple),var(--blue));color:#fff;font-size:0.6rem;padding:4px 8px;border-radius:4px;font-weight:700}.ai-interpretation-text{color:var(--text-secondary);font-size:0.9rem;line-height:1.7;margin-bottom:16px}.ai-details{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px}.ai-details-title{font-size:0.75rem;font-weight:600;color:var(--gold);text-transform:uppercase;margin-bottom:12px}.ai-details-list{list-style:none;padding:0;margin:0}.ai-details-list li{font-size:0.85rem;color:var(--text-secondary);padding:6px 0;border-bottom:1px solid var(--border)}.ai-details-list li:last-child{border-bottom:none}.feedback-section{display:flex;align-items:center;justify-content:space-between;padding-top:16px;border-top:1px solid var(--border)}.feedback-label{font-size:0.75rem;color:var(--text-muted)}.feedback-buttons{display:flex;gap:8px}.feedback-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--bg);cursor:pointer;display:grid;place-items:center;font-size:1.1rem;transition:all 0.2s}.feedback-btn:hover{transform:scale(1.1)}.feedback-btn.positive:hover,.feedback-btn.positive.active{background:rgba(16,185,129,0.2);border-color:var(--emerald)}.feedback-btn.negative:hover,.feedback-btn.negative.active{background:rgba(244,63,94,0.2);border-color:var(--rose)}.feedback-btn.active{transform:scale(1.1)}.feedback-sent{font-size:0.75rem;color:var(--emerald);display:none}.feedback-sent.show{display:block}.critical-alert{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;display:flex;align-items:flex-start;gap:12px}.critical-alert-icon{font-size:1.25rem}.critical-alert-content{flex:1}.critical-alert-title{font-weight:700;color:var(--rose);margin-bottom:4px}.critical-alert-values{font-size:0.85rem;color:var(--text-secondary)}.lab-category{background:var(--bg);border-radius:var(--radius-sm);margin-bottom:16px;overflow:hidden}.lab-category-header{padding:12px 16px;background:rgba(245,158,11,0.08);font-weight:600;font-size:0.8rem;color:var(--gold);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px}.lab-category-body{padding:16px}.lab-values-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}.lab-value-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;transition:all 0.2s}.lab-value-card.high{border-left:3px solid var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}.lab-value-card.low{border-left:3px solid var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.05),transparent)}.lab-value-card.critical{border-left:3px solid var(--rose);background:rgba(244,63,94,0.1)}.lab-value-card.normal{border-left:3px solid var(--emerald)}.lab-value-name{font-size:0.75rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}.lab-value-status{font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:4px}.lab-value-status.high,.lab-value-status.critical{background:var(--rose);color:#fff}.lab-value-status.low{background:var(--blue);color:#fff}.lab-value-number{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:600;margin-bottom:4px}.lab-value-card.high .lab-value-number{color:var(--rose)}.lab-value-card.low .lab-value-number{color:var(--blue)}.lab-value-card.normal .lab-value-number{color:var(--emerald)}.lab-value-unit{font-size:0.7rem;color:var(--text-muted)}.lab-value-range{font-size:0.65rem;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}.lab-trend-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}.lab-trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}.lab-trend-select{padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.85rem;min-width:180px}.lab-trend-chart{background:var(--bg);border-radius:var(--radius-sm);padding:20px;height:220px}.vitals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px}.vital-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}.vital-icon{font-size:1.5rem;margin-bottom:8px}.vital-value{font-size:1.25rem;font-weight:700}.vital-label{font-size:0.7rem;color:var(--text-muted);margin-top:4px}.fluid-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.fluid-stat{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}.fluid-stat-value{font-size:1.5rem;font-weight:800}.fluid-stat-value.intake{color:var(--blue)}.fluid-stat-value.output{color:var(--orange)}.fluid-stat-value.balance{color:var(--emerald)}.fluid-stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}.fluid-chart-container{height:200px;margin-top:20px}.plan-item{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;border-left:3px solid var(--gold)}.plan-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.plan-item-date{font-size:0.7rem;color:var(--text-muted)}.plan-item-content{font-size:0.9rem;white-space:pre-wrap}.imaging-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px}.imaging-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}.imaging-type{font-weight:600;display:flex;align-items:center;gap:8px}.imaging-date{font-size:0.75rem;color:var(--text-muted)}.imaging-summary{font-size:0.85rem;color:var(--text-secondary)}.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:16px 28px;border-radius:var(--radius);font-size:0.9rem;opacity:0;transition:all 0.3s;z-index:2000}.toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.error{border-color:var(--rose)}.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}.empty-state{text-align:center;padding:60px 24px;color:var(--text-muted)}.empty-state-icon{font-size:3.5rem;margin-bottom:16px;opacity:0.4}.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 24px;text-align:center;cursor:pointer;transition:all 0.2s}.upload-zone:hover{border-color:var(--gold);background:rgba(245,158,11,0.05)}.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}.ref-card{background:var(--bg);border-radius:var(--radius-sm);padding:18px;border-left:3px solid var(--gold)}.ref-card h4{font-size:0.9rem;margin-bottom:10px}.ref-card p{font-size:0.8rem;color:var(--text-secondary)}.import-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--teal)}.import-ward-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--gold);border-radius:8px;color:var(--gold);font-size:0.75rem;font-weight:600}#adminPanel{background:var(--bg)}.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}.admin-content{max-width:700px;margin:0 auto;padding:24px}.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;overflow:hidden}.units-table{width:100%;border-collapse:collapse}.units-table th,.units-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border)}.units-table th{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase}@media(max-width:640px){.stats-grid{grid-template-columns:repeat(3,1fr)}.action-buttons{grid-template-columns:1fr}.action-buttons .btn-full{grid-column:span 1}.profile-patient{flex-direction:column;text-align:center}.profile-details .meta{justify-content:center}.lab-values-grid{grid-template-columns:repeat(2,1fr)}}.request-unit-btn{margin-top:32px;padding:16px 32px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius);color:var(--text-muted);font-size:0.9rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:10px}.request-unit-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(245,158,11,0.05)}.request-form{display:flex;flex-direction:column;gap:20px}.request-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}@media(max-width:500px){.request-form-row{grid-template-columns:1fr}}.request-form .form-input,.request-form .form-textarea,.request-form .form-select{background:var(--bg);border:1px solid var(--border)}.request-form .form-input:focus,.request-form .form-textarea:focus,.request-form .form-select:focus{border-color:var(--gold)}.request-icon-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}.request-icon-option{width:100%;aspect-ratio:1;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:grid;place-items:center}.request-icon-option:hover{border-color:var(--text-muted)}.request-icon-option.selected{border-color:var(--gold);background:rgba(245,158,11,0.1)}.request-success{text-align:center;padding:40px 20px}.request-success-icon{font-size:4rem;margin-bottom:20px}.request-success-title{font-size:1.25rem;font-weight:700;margin-bottom:8px}.request-success-text{color:var(--text-muted);font-size:0.9rem;margin-bottom:24px}.request-success-id{background:var(--bg);padding:12px 20px;border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:0.9rem;display:inline-block}.requests-list{display:flex;flex-direction:column;gap:12px}.request-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;border-left:4px solid var(--gold)}.request-card.approved{border-left-color:var(--emerald);opacity:0.7}.request-card.rejected{border-left-color:var(--rose);opacity:0.7}.request-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}.request-card-title{font-weight:700;font-size:1rem}.request-card-status{padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:700;text-transform:uppercase}.request-card-status.pending{background:rgba(245,158,11,0.15);color:var(--gold)}.request-card-status.approved{background:rgba(16,185,129,0.15);color:var(--emerald)}.request-card-status.rejected{background:rgba(244,63,94,0.15);color:var(--rose)}.request-card-details{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}.request-card-detail{display:flex;align-items:center;gap:6px}.request-card-message{background:var(--bg-card);padding:12px;border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}.request-card-actions{display:flex;gap:8px}.request-card-time{font-size:0.75rem;color:var(--text-muted);position:absolute;top:16px;right:16px}.admin-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg);padding:4px;border-radius:var(--radius-sm)}.admin-tab{flex:1;padding:12px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}.admin-tab:hover{color:var(--text)}.admin-tab.active{background:var(--bg-elevated);color:var(--gold)}.admin-tab-panel{display:none}.admin-tab-panel.active{display:block}.badge-count{background:var(--rose);color:#fff;padding:2px 8px;border-radius:100px;font-size:0.7rem;margin-left:8px}.approve-form{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-top:12px;display:none}.approve-form.show{display:block}.approve-form-row{display:flex;gap:12px;margin-bottom:12px}.approve-form-row .form-input{flex:1}#scoreCalcModal{padding:0;align-items:stretch}#scoreCalcModal .modal-box{max-width:100%;width:100%;height:100%;max-height:100%;border-radius:0;margin:0;background:#0a0e17;display:flex;flex-direction:column;border:none}@media(min-width:600px){#scoreCalcModal{padding:20px;align-items:center}#scoreCalcModal .modal-box{max-width:420px;width:100%;height:auto;max-height:85vh;border-radius:12px;border:1px solid rgba(255,255,255,0.06)}}.score-calculator{display:flex;flex-direction:column;height:100%;background:#0a0e17;overflow:hidden}.score-calc-header{padding:16px;background:#0d1117;border-bottom:1px solid rgba(255,255,255,0.05);flex-shrink:0}.score-calc-header-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}.score-calc-close{width:28px;height:28px;border-radius:6px;border:none;background:rgba(255,255,255,0.05);color:#8b949e;font-size:14px;cursor:pointer;display:grid;place-items:center;flex-shrink:0}.score-calc-close:active{background:rgba(255,255,255,0.1)}.score-calc-title{font-size:1.1rem;font-weight:600;color:#e6edf3;margin-bottom:2px}.score-calc-purpose{font-size:0.8rem;color:#8b949e}.score-calc-category{display:inline-block;margin-top:10px;padding:4px 8px;background:rgba(56,139,253,0.1);color:#58a6ff;font-size:0.65rem;font-weight:600;border-radius:4px;text-transform:uppercase;letter-spacing:0.5px}.score-calc-body{flex:1;overflow-y:auto;padding:12px;-webkit-overflow-scrolling:touch}.score-calc-fields{display:flex;flex-direction:column;gap:8px}.score-auto-calc{background:linear-gradient(135deg,rgba(46,160,67,0.08),rgba(46,160,67,0.02));border:1px solid rgba(46,160,67,0.2);border-radius:8px;padding:12px;margin-bottom:12px}.score-auto-calc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.score-auto-calc-title{font-size:0.7rem;font-weight:600;color:#3fb950;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:6px}.score-auto-calc-badge{background:#238636;color:#fff;font-size:0.6rem;padding:2px 5px;border-radius:3px;font-weight:600}.score-auto-calc-value{font-family:'JetBrains Mono',monospace;font-size:1.8rem;font-weight:700;color:#e6edf3;text-align:center;padding:4px 0}.score-auto-calc-source{font-size:0.72rem;color:#8b949e;text-align:center}.score-manual-toggle{font-size:0.7rem;color:#8b949e;background:none;border:none;text-decoration:underline;cursor:pointer}.score-field{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#161b22;border:1px solid rgba(255,255,255,0.04);border-radius:8px;cursor:pointer;min-height:44px}.score-field:active{background:#1c2128}.score-field.checked{background:rgba(46,160,67,0.08);border-color:rgba(46,160,67,0.3)}.score-field-checkbox{width:18px;height:18px;min-width:18px;border-radius:4px;border:1.5px solid #30363d;display:grid;place-items:center;background:transparent;transition:all 0.15s}.score-field.checked .score-field-checkbox{background:#238636;border-color:#238636}.score-field.checked .score-field-checkbox::after{content:'✓';color:#fff;font-size:11px;font-weight:700}.score-field-label{flex:1;font-size:0.82rem;color:#c9d1d9;line-height:1.3}.score-field-points{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:#8b949e;padding:2px 6px;background:rgba(255,255,255,0.04);border-radius:4px}.score-field.checked .score-field-points{color:#3fb950;background:rgba(46,160,67,0.1)}.score-field-select{width:100%}.score-field-select label{display:block;font-size:0.72rem;font-weight:500;color:#8b949e;margin-bottom:6px}.score-field-select select{width:100%;padding:10px 32px 10px 10px;background:#161b22;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:0.82rem;appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}.score-field-select select:focus{outline:none;border-color:#388bfd}.score-field-number{display:flex;align-items:center;gap:10px;width:100%}.score-field-number label{flex:1;font-size:0.82rem;color:#c9d1d9}.score-field-number input{width:80px;padding:8px 10px;background:#161b22;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:0.85rem;font-family:'JetBrains Mono',monospace;text-align:center}.score-field-number input:focus{outline:none;border-color:#388bfd}.score-calc-result{padding:14px 16px;background:#0d1117;border-top:1px solid rgba(255,255,255,0.05);flex-shrink:0}.score-result-display{display:flex;align-items:baseline;justify-content:center;gap:6px;margin-bottom:10px}.score-result-value{font-family:'JetBrains Mono',monospace;font-size:2.5rem;font-weight:700;color:#e6edf3}.score-result-max{font-size:0.8rem;color:#484f58}.score-result-interpretation{padding:10px 12px;border-radius:6px}.score-result-risk{font-size:0.9rem;font-weight:600;margin-bottom:2px}.score-result-action{font-size:0.78rem;color:rgba(255,255,255,0.8);line-height:1.35}.score-result-stats{display:flex;justify-content:center;gap:16px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08)}.score-result-stat{text-align:center}.score-result-stat-value{font-family:'JetBrains Mono',monospace;font-size:0.9rem;font-weight:600}.score-result-stat-label{font-size:0.6rem;color:#8b949e;text-transform:uppercase;margin-top:1px}#scoreCalcModal .modal-footer{background:#0d1117;border-top:1px solid rgba(255,255,255,0.05);padding:12px 16px;flex-shrink:0;display:flex;gap:8px}#scoreCalcModal .modal-footer .btn{flex:1;padding:10px}.scores-search-wrapper{position:relative;margin-bottom:14px}.scores-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#484f58}.scores-search-input{width:100%;padding:10px 14px 10px 38px;background:#161b22;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:0.85rem}.scores-search-input:focus{outline:none;border-color:#388bfd}.scores-search-input::placeholder{color:#484f58}.quick-score-ref{background:#161b22;border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:12px;margin-bottom:14px}.quick-score-ref-title{font-size:0.65rem;font-weight:600;color:#8b949e;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}.quick-score-ref-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}.quick-score-ref-item{padding:10px 6px;background:#0d1117;border:1px solid rgba(255,255,255,0.04);border-radius:6px;text-align:center;cursor:pointer}.quick-score-ref-item:active{background:#1c2128}.quick-score-ref-item-name{font-size:0.8rem;font-weight:600;color:#e6edf3}.quick-score-ref-item-hint{font-size:0.65rem;color:#8b949e;margin-top:2px}.emergency-scores-grid{display:flex;flex-direction:column;gap:10px}.emergency-score-group{background:#161b22;border:1px solid rgba(255,255,255,0.04);border-radius:8px;overflow:hidden}.emergency-score-group-header{padding:10px 12px;background:#0d1117;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;gap:8px}.emergency-score-group-icon{font-size:1rem}.emergency-score-group-title{font-size:0.85rem;font-weight:600;color:#e6edf3}.emergency-score-group-body{padding:4px}.emergency-score-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:6px;cursor:pointer;gap:8px}.emergency-score-item:active{background:rgba(255,255,255,0.03)}.emergency-score-item-info{flex:1;min-width:0}.emergency-score-item-name{font-size:0.82rem;font-weight:500;color:#c9d1d9}.emergency-score-item-purpose{font-size:0.7rem;color:#8b949e;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.emergency-score-item-btn{padding:6px 10px;background:#21262d;border:1px solid #30363d;border-radius:5px;color:#c9d1d9;font-size:0.7rem;font-weight:500;cursor:pointer}.emergency-score-item-btn:active{background:#388bfd;color:#fff;border-color:transparent}.patient-scores-section{margin-bottom:16px}.patient-scores-header{margin-bottom:8px}.patient-scores-title{font-size:0.68rem;font-weight:600;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px}.patient-scores-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}.patient-score-chip{padding:12px 10px;background:#161b22;border:1px solid rgba(255,255,255,0.04);border-radius:8px;cursor:pointer;text-align:center}.patient-score-chip:active{background:#1c2128}.patient-score-chip.has-value{border-color:rgba(46,160,67,0.3);background:rgba(46,160,67,0.06)}.patient-score-chip .score-chip-icon{font-size:1.2rem;display:block;margin-bottom:4px}.patient-score-chip .score-chip-name{font-size:0.75rem;font-weight:500;color:#c9d1d9}.patient-score-chip .score-chip-value{display:none;font-family:'JetBrains Mono',monospace;font-size:0.95rem;font-weight:700;margin-top:4px}.patient-score-chip.has-value .score-chip-value{display:block}.patient-score-chip .score-chip-value.low{color:#3fb950}.patient-score-chip .score-chip-value.moderate{color:#d29922}.patient-score-chip .score-chip-value.high{color:#f85149}.history-upload-area{padding:20px;background:#161b22;border:2px dashed #30363d;border-radius:10px;text-align:center;cursor:pointer;margin-bottom:16px;transition:all 0.15s}.history-upload-area:active{background:#1c2128;border-color:#388bfd}.clinical-notes-list{display:flex;flex-direction:column;gap:12px}.clinical-note-card{background:#161b22;border:1px solid rgba(255,255,255,0.06);border-radius:10px;overflow:hidden}.clinical-note-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0d1117;border-bottom:1px solid rgba(255,255,255,0.04)}.clinical-note-type{font-size:0.8rem;font-weight:600;color:#e6edf3}.clinical-note-date{font-size:0.7rem;color:#8b949e}.clinical-note-image{width:100%;max-height:200px;object-fit:cover;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04)}.clinical-note-ai{padding:10px 12px;background:rgba(46,160,67,0.06);border-bottom:1px solid rgba(255,255,255,0.04)}.clinical-note-ai-badge{font-size:0.65rem;font-weight:600;color:#3fb950;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}.clinical-note-ai-text{font-size:0.82rem;color:#c9d1d9;line-height:1.4}.clinical-note-text{padding:12px;font-size:0.85rem;color:#c9d1d9;line-height:1.5;white-space:pre-wrap}.clinical-note-author{padding:0 12px 10px;font-size:0.72rem;color:#8b949e;font-style:italic}.btn-icon-sm{background:transparent;border:none;padding:4px;font-size:0.85rem;cursor:pointer;opacity:0.6;transition:opacity 0.15s}.btn-icon-sm:hover{opacity:1}.btn-danger{background:#da3633!important;border-color:#da3633!important;color:#fff!important}.btn-danger:hover{background:#f85149!important}.meds-container{padding:0}.meds-upload-card{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid rgba(255,255,255,0.06);border-radius:12px;margin-bottom:16px;overflow:hidden}.meds-upload-header{padding:16px;background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(59,130,246,0.08));border-bottom:1px solid rgba(255,255,255,0.04)}.meds-upload-title{font-size:0.9rem;font-weight:600;color:#e6edf3;display:flex;align-items:center;gap:8px}.meds-upload-subtitle{font-size:0.75rem;color:#8b949e;margin-top:4px}.meds-upload-body{padding:16px}.meds-upload-zone{border:2px dashed rgba(139,92,246,0.3);border-radius:10px;padding:28px 20px;text-align:center;cursor:pointer;transition:all 0.2s;background:rgba(139,92,246,0.02)}.meds-upload-zone:active{background:rgba(139,92,246,0.08);border-color:rgba(139,92,246,0.5)}.meds-upload-zone.analyzing{border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.05);pointer-events:none}.meds-upload-icon{font-size:2rem;margin-bottom:8px}.meds-upload-text{font-size:0.85rem;font-weight:500;color:#c9d1d9}.meds-upload-hint{font-size:0.72rem;color:#8b949e;margin-top:4px}.meds-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:0 4px}.meds-list-title{font-size:0.7rem;font-weight:600;color:#8b949e;text-transform:uppercase;letter-spacing:0.5px}.meds-count{font-size:0.7rem;font-weight:600;color:#8b5cf6;background:rgba(139,92,246,0.1);padding:3px 8px;border-radius:10px}.med-card{background:linear-gradient(145deg,#0d1117 0%,#151d2e 100%);border:1px solid rgba(255,255,255,0.08);border-radius:14px;margin-bottom:12px;overflow:hidden;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);box-shadow:0 2px 8px rgba(0,0,0,0.2)}.med-card:hover{border-color:rgba(255,255,255,0.15);box-shadow:0 4px 16px rgba(0,0,0,0.3)}.med-card-header{display:flex;align-items:flex-start;justify-content:space-between;padding:16px 18px 12px;gap:12px}.med-card-main{flex:1;min-width:0}.med-card-name{font-size:1rem;font-weight:700;color:#f0f6fc;margin-bottom:4px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}.med-card-generic{font-size:0.75rem;color:#8b949e;font-style:italic;margin-top:2px}.med-card-actions{display:flex;gap:6px}.med-card-action{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:#8b949e;font-size:0.85rem;cursor:pointer;display:grid;place-items:center;transition:all 0.2s}.med-card-action:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.12);color:#c9d1d9}.med-card-action.info{background:rgba(96,165,250,0.08);border-color:rgba(96,165,250,0.2);color:#60a5fa}.med-card-action.info:hover{background:rgba(96,165,250,0.15);border-color:#60a5fa}.med-card-action.delete:hover{background:rgba(248,81,73,0.12);border-color:rgba(248,81,73,0.3);color:#f85149}.med-card-dose{display:flex;flex-wrap:wrap;gap:8px;padding:0 18px 14px;border-bottom:1px solid rgba(255,255,255,0.04)}.med-dose-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:100px;font-size:0.78rem;font-weight:500}.med-dose-pill.amount{background:rgba(167,139,250,0.1);color:#a78bfa}.med-dose-pill.route{background:rgba(96,165,250,0.1);color:#60a5fa}.med-dose-pill.frequency{background:rgba(52,211,153,0.1);color:#34d399}.med-card-indication{padding:14px 18px;background:rgba(255,255,255,0.015);border-bottom:1px solid rgba(255,255,255,0.04)}.med-indication-label{font-size:0.65rem;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px}.med-indication-text{font-size:0.85rem;color:#c9d1d9;line-height:1.5}.med-status{font-size:0.65rem;font-weight:700;padding:3px 10px;border-radius:100px;text-transform:uppercase;letter-spacing:0.03em}.med-status.active{background:rgba(52,211,153,0.12);color:#34d399}.med-status.prn{background:rgba(251,191,36,0.12);color:#fbbf24}.med-status.discontinued{background:rgba(107,114,128,0.12);color:#9ca3af}.med-status.new{background:rgba(167,139,250,0.12);color:#a78bfa}.med-learn-more{display:flex;align-items:center;justify-content:center;gap:8px;margin:0 18px 16px;padding:12px 16px;background:linear-gradient(135deg,rgba(96,165,250,0.1),rgba(45,212,191,0.08));border:1px solid rgba(96,165,250,0.2);border-radius:10px;font-family:inherit;font-size:0.8rem;font-weight:600;color:#60a5fa;cursor:pointer;transition:all 0.2s;text-decoration:none}.med-learn-more:hover{background:linear-gradient(135deg,rgba(96,165,250,0.15),rgba(45,212,191,0.12));border-color:#60a5fa;box-shadow:0 4px 16px rgba(96,165,250,0.2)}.med-learn-more .sparkle{font-size:1rem}.med-ai-suggestions{background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(59,130,246,0.05));border:1px solid rgba(139,92,246,0.2);border-radius:14px;padding:16px;margin-bottom:20px;position:relative;overflow:hidden}.med-ai-suggestions::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#8b5cf6,#3b82f6,#14b8a6);animation:aiGradient 3s ease infinite}@keyframes aiGradient{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}.med-ai-header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-bottom:14px}.med-ai-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#8b5cf6,#6366f1);display:grid;place-items:center;font-size:1.1rem;box-shadow:0 4px 12px rgba(139,92,246,0.3)}.med-ai-title{display:flex;align-items:center;gap:8px;flex:1}.med-ai-title span:first-child{font-size:0.9rem;font-weight:700;color:#e0e7ff}.med-ai-badge{padding:3px 8px;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.3);border-radius:100px;font-size:0.6rem;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.05em}.med-ai-hint{width:100%;font-size:0.75rem;color:#8b949e;padding-left:46px;margin-top:-4px}.med-ai-chips{display:flex;flex-wrap:wrap;gap:8px}.med-ai-chip{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;font-family:inherit;font-size:0.8rem;font-weight:600;color:#c9d1d9;cursor:pointer;transition:all 0.2s;position:relative}.med-ai-chip:hover{background:rgba(139,92,246,0.1);border-color:rgba(139,92,246,0.3);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}.med-ai-chip-icon{font-size:1rem}.med-ai-chip-info{display:flex;flex-direction:column;align-items:flex-start;gap:2px}.med-ai-chip-name{font-weight:700;color:#f0f6fc}.med-ai-chip-detail{font-size:0.7rem;color:#8b949e;font-weight:500}.med-ai-chip-match{position:absolute;top:-6px;right:-6px;padding:2px 6px;background:linear-gradient(135deg,#10b981,#14b8a6);border-radius:100px;font-size:0.6rem;font-weight:700;color:#000}.med-ai-chip.high-match{border-color:rgba(16,185,129,0.4)}.med-ai-chip.high-match .med-ai-chip-name{color:#34d399}.med-ai-loading{display:flex;align-items:center;gap:10px;padding:12px 16px;color:#8b949e;font-size:0.8rem}.med-ai-pulse{width:8px;height:8px;border-radius:50%;background:#8b5cf6;animation:aiPulse 1.5s ease infinite}@keyframes aiPulse{0%,100%{opacity:0.3;transform:scale(0.8)}50%{opacity:1;transform:scale(1.2)}}.med-ai-empty{padding:16px;text-align:center;color:#6b7280;font-size:0.8rem}.med-ai-empty-icon{font-size:1.5rem;margin-bottom:8px;opacity:0.5}.med-add-form{background:linear-gradient(165deg,#0a101f 0%,#111b2e 50%,#0f1825 100%);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:0;margin-bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05);overflow:hidden}.med-form-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:linear-gradient(135deg,rgba(167,139,250,0.1),rgba(96,165,250,0.05));border-bottom:1px solid rgba(255,255,255,0.06)}.med-form-title{font-size:1.1rem;font-weight:700;color:#f0f6fc;display:flex;align-items:center;gap:10px}.med-form-close{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:#8b949e;font-size:1rem;cursor:pointer;display:grid;place-items:center;transition:all 0.2s}.med-form-close:hover{background:rgba(248,81,73,0.1);border-color:rgba(248,81,73,0.3);color:#f85149}.med-form-section{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}.med-form-section:last-of-type{border-bottom:none}.med-form-section-title{font-size:0.7rem;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:16px;display:flex;align-items:center;gap:8px}.med-form-section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(255,255,255,0.06),transparent)}.med-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}.med-form-group{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}.med-form-group:last-child{margin-bottom:0}.med-form-full{grid-column:1/-1}.med-form-label{font-size:0.75rem;font-weight:600;color:#9ca3af;display:flex;align-items:center;gap:4px}.med-form-label .required{color:#f87171}.med-form-input{padding:14px 16px;background:#080c14;border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:#f0f6fc;font-size:0.9rem;font-family:inherit;transition:all 0.2s;width:100%}.med-form-input:focus{outline:none;border-color:rgba(167,139,250,0.5);box-shadow:0 0 0 3px rgba(167,139,250,0.1),0 4px 12px rgba(0,0,0,0.2)}.med-form-input::placeholder{color:#4b5563}.med-route-chips{display:flex;flex-wrap:wrap;gap:8px}.med-route-chip{padding:10px 16px;background:#080c14;border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#9ca3af;font-size:0.82rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all 0.2s}.med-route-chip:hover{border-color:rgba(96,165,250,0.3);color:#60a5fa}.med-route-chip.selected{background:linear-gradient(135deg,rgba(96,165,250,0.15),rgba(96,165,250,0.08));border-color:#60a5fa;color:#60a5fa;box-shadow:0 0 12px rgba(96,165,250,0.2)}.med-freq-chips{display:flex;flex-wrap:wrap;gap:8px}.med-freq-chip{padding:10px 16px;background:#080c14;border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#9ca3af;font-size:0.82rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all 0.2s}.med-freq-chip:hover{border-color:rgba(52,211,153,0.3);color:#34d399}.med-freq-chip.selected{background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(52,211,153,0.08));border-color:#34d399;color:#34d399;box-shadow:0 0 12px rgba(52,211,153,0.2)}.med-status-options{display:flex;flex-wrap:wrap;gap:8px}.med-status-option{display:flex;align-items:center;gap:8px;padding:10px 16px;background:#080c14;border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#9ca3af;font-size:0.82rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all 0.2s}.med-status-option:hover{border-color:rgba(255,255,255,0.15)}.med-status-option.selected{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.2);color:#f0f6fc}.status-dot{width:8px;height:8px;border-radius:50%}.status-dot.active{background:#34d399}.status-dot.new{background:#a78bfa}.status-dot.prn{background:#fbbf24}.status-dot.discontinued{background:#6b7280}.med-form-actions{display:flex;gap:12px;padding:20px 24px;background:rgba(0,0,0,0.2);border-top:1px solid rgba(255,255,255,0.04)}.med-form-btn{flex:1;padding:14px 20px;border-radius:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px}.med-form-actions .btn-primary{background:linear-gradient(135deg,#f59e0b,#f97316);color:#000;box-shadow:0 4px 16px rgba(245,158,11,0.3)}.med-form-actions .btn-primary:hover{box-shadow:0 6px 24px rgba(245,158,11,0.4);transform:translateY(-1px)}.med-form-actions .btn-secondary{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1)}.meds-empty{text-align:center;padding:48px 24px;color:#6b7280}.meds-empty-icon{font-size:3rem;margin-bottom:16px;opacity:0.5}.meds-empty-title{font-size:1rem;font-weight:600;color:#c9d1d9;margin-bottom:6px}.meds-empty-hint{font-size:0.85rem}.meds-quick-actions{display:flex;gap:10px;margin-bottom:20px}.meds-quick-btn{flex:1;padding:14px 16px;background:linear-gradient(145deg,#0f1729,#151d2e);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:#c9d1d9;font-size:0.82rem;font-weight:600;font-family:inherit;cursor:pointer;text-align:center;transition:all 0.2s}.meds-quick-btn:hover{border-color:rgba(167,139,250,0.4);color:#a78bfa;background:linear-gradient(145deg,#131c33,#1a2540)}.meds-list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}.meds-list-title{font-size:0.75rem;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:0.05em}.meds-count{padding:4px 12px;background:rgba(52,211,153,0.1);border-radius:100px;font-size:0.7rem;font-weight:700;color:#34d399}.plan-section-card{padding:0;overflow:hidden}.plan-section-header{padding:16px 20px;border-bottom:1px solid var(--border)}.plan-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);margin:0}.plan-stat-box{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px 8px;background:var(--bg-card);text-align:center;min-height:80px}.plan-stat-box.urgent-box{background:rgba(239,68,68,0.05)}.plan-stat-ring{position:relative;width:44px;height:44px}.plan-stat-ring svg{width:100%;height:100%;transform:rotate(-90deg)}.ring-bg{fill:none;stroke:rgba(255,255,255,0.1);stroke-width:3}.ring-fill{fill:none;stroke:#10b981;stroke-width:3;stroke-linecap:round}.ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:0.65rem;font-weight:800;color:#10b981}.plan-stat-num{font-size:1.5rem;font-weight:800;line-height:1}.plan-stat-num.amber{color:#f59e0b}.plan-stat-num.green{color:#10b981}.plan-stat-num.red{color:#ef4444}.plan-stat-lbl{font-size:0.65rem;color:#6b7280;margin-top:4px;text-transform:uppercase}.plan-notify-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(139,92,246,0.05);border-bottom:1px solid var(--border)}.notify-label{font-size:0.8rem;color:#a78bfa;font-weight:600}.toggle-switch{position:relative;width:40px;height:22px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-track{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,0.1);border-radius:22px;transition:0.2s}.toggle-track::before{content:'';position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#6b7280;border-radius:50%;transition:0.2s}.toggle-switch input:checked+.toggle-track{background:#8b5cf6}.toggle-switch input:checked+.toggle-track::before{transform:translateX(18px);background:#fff}.plan-ai-box{padding:16px 20px;border-bottom:1px solid var(--border);background:rgba(59,130,246,0.03)}.plan-ai-header{margin-bottom:12px}.ai-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(59,130,246,0.1);border-radius:100px;font-size:0.7rem;font-weight:700;color:#60a5fa}.plan-ai-list{display:flex;flex-direction:column;gap:8px}.plan-ai-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent}.plan-ai-item:active{background:rgba(59,130,246,0.1);border-color:rgba(59,130,246,0.3)}.ai-item-icon{font-size:1rem;flex-shrink:0}.ai-item-text{flex:1;font-size:0.8rem;color:#c9d1d9;line-height:1.3}.ai-item-add{width:24px;height:24px;background:rgba(16,185,129,0.15);border-radius:6px;color:#10b981;display:grid;place-items:center;font-size:1rem;font-weight:600;flex-shrink:0}.plan-tasks-list{padding:0}.tasks-group-header{display:flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(255,255,255,0.02);font-size:0.8rem;font-weight:700;color:#9ca3af;border-bottom:1px solid var(--border)}.tasks-group-header.completed-header{cursor:pointer}.tasks-group-header.completed-header:active{background:rgba(255,255,255,0.04)}.tasks-count{margin-left:auto;padding:2px 8px;background:rgba(245,158,11,0.15);border-radius:100px;font-size:0.65rem;color:#f59e0b}.tasks-count.done{background:rgba(16,185,129,0.15);color:#10b981}.expand-arrow{font-size:0.6rem;color:#6b7280;margin-left:4px}.plan-task-item{display:flex;align-items:flex-start;gap:12px;padding:14px 20px;border-bottom:1px solid var(--border);transition:background 0.2s}.plan-task-item:active{background:rgba(255,255,255,0.02)}.plan-task-item.completed{opacity:0.5}.plan-task-item[data-priority="high"]{border-left:3px solid #ef4444}.plan-task-item[data-priority="medium"]{border-left:3px solid #f59e0b}.plan-task-item[data-priority="low"]{border-left:3px solid #10b981}.task-check-box{width:22px;height:22px;border-radius:6px;flex-shrink:0;border:2px solid rgba(255,255,255,0.2);background:transparent;display:grid;place-items:center;font-size:0.75rem;color:transparent;cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent}.task-check-box:active{border-color:#10b981}.task-check-box.done{background:#10b981;border-color:#10b981;color:#fff}.task-info{flex:1;min-width:0}.task-text{font-size:0.85rem;color:#e5e7eb;line-height:1.4;margin-bottom:6px}.plan-task-item.completed .task-text{text-decoration:line-through;color:#6b7280}.task-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:0.7rem;color:#6b7280}.task-cat{padding:2px 6px;background:rgba(255,255,255,0.04);border-radius:4px;text-transform:capitalize}.task-pri.high{color:#ef4444}.task-pri.medium{color:#f59e0b}.task-pri.low{color:#10b981}.task-btns{display:flex;gap:4px;flex-shrink:0}.task-btn{width:28px;height:28px;border:none;border-radius:6px;background:rgba(255,255,255,0.04);cursor:pointer;display:grid;place-items:center;font-size:0.8rem;-webkit-tap-highlight-color:transparent}.task-btn:active{background:rgba(255,255,255,0.1)}.task-btn.del:active{background:rgba(239,68,68,0.2)}.plan-empty{text-align:center;padding:40px 20px}.plan-empty .empty-icon{font-size:2rem;margin-bottom:8px;opacity:0.5}.plan-empty .empty-text{font-size:0.85rem;color:#6b7280}.task-modal-box{max-width:400px}.task-modal-header{display:flex;align-items:center;gap:12px;padding:16px 20px;background:linear-gradient(135deg,rgba(245,158,11,0.06),rgba(234,88,12,0.03));border-bottom:1px solid var(--border)}.task-modal-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#ea580c);display:grid;place-items:center;font-size:1.2rem}.task-modal-header .modal-close{margin-left:auto}.task-textarea{min-height:80px;resize:vertical}.task-form-row{margin-top:16px}.priority-chips,.category-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}.priority-chip,.category-chip{padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:8px;font-family:inherit;font-size:0.75rem;font-weight:600;color:#9ca3af;cursor:pointer;-webkit-tap-highlight-color:transparent}.priority-chip:active,.category-chip:active{background:rgba(255,255,255,0.08)}.priority-chip.selected.high{background:rgba(239,68,68,0.1);border-color:#ef4444;color:#ef4444}.priority-chip.selected.medium{background:rgba(245,158,11,0.1);border-color:#f59e0b;color:#f59e0b}.priority-chip.selected.low{background:rgba(16,185,129,0.1);border-color:#10b981;color:#10b981}.category-chip.selected{background:rgba(59,130,246,0.1);border-color:#3b82f6;color:#3b82f6}.celebration-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;transition:opacity 0.3s;pointer-events:none}.celebration-overlay.show{opacity:1;pointer-events:auto}.celebration-content{text-align:center;padding:32px 24px;width:100%;max-width:320px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;transform:scale(0.9);transition:transform 0.3s}.celebration-overlay.show .celebration-content{transform:scale(1)}.celebration-confetti{font-size:2.5rem;margin-bottom:12px}.celebration-badge{width:60px;height:60px;margin:0 auto 16px;border-radius:50%;background:linear-gradient(135deg,#10b981,#14b8a6);display:grid;place-items:center;font-size:1.5rem;color:#fff}.celebration-title{font-size:1.2rem;font-weight:800;color:#f0f6fc;margin-bottom:4px}.celebration-subtitle{font-size:0.85rem;color:#8b949e;margin-bottom:4px}.celebration-patient{font-size:1rem;font-weight:700;color:#f59e0b;margin-bottom:16px}.celebration-stats{display:flex;justify-content:center;gap:24px;margin-bottom:16px}.celeb-stat{text-align:center}.celeb-stat-value{display:block;font-size:1.5rem;font-weight:800;color:#10b981}.celeb-stat-label{font-size:0.6rem;color:#6b7280;text-transform:uppercase}.celebration-message{padding:12px;background:rgba(16,185,129,0.1);border-radius:10px;font-size:0.8rem;color:#a7f3d0;margin-bottom:16px;line-height:1.4}.celebration-btn{width:100%;padding:12px;background:#10b981;border:none;border-radius:10px;color:#fff;font-size:0.9rem;font-weight:700;cursor:pointer;font-family:inherit}#drugInfoModal .modal-box{max-width:520px;border-radius:20px;overflow:hidden}#drugInfoModal .modal-header{padding:24px 24px 20px;background:linear-gradient(135deg,rgba(96,165,250,0.08),rgba(167,139,250,0.05));border-bottom:1px solid var(--border);position:relative;display:block}.drug-info-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;background:rgba(96,165,250,0.12);border:1px solid rgba(96,165,250,0.2);border-radius:100px;font-size:0.7rem;font-weight:700;color:#60a5fa;margin-bottom:12px}.drug-info-title{font-size:1.35rem;font-weight:800;color:var(--text);letter-spacing:-0.02em}.drug-info-subtitle{font-size:0.85rem;color:var(--text-muted);margin-top:4px}.patient-context-alert{background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(251,113,133,0.05));border:1px solid rgba(251,191,36,0.25);border-radius:12px;padding:18px;margin-bottom:20px}.patient-context-alert.critical{background:linear-gradient(135deg,rgba(239,68,68,0.12),rgba(251,113,133,0.08));border-color:rgba(239,68,68,0.4);animation:criticalPulse 2s ease infinite}@keyframes criticalPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.2)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}.context-alert-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}.context-alert-icon{width:36px;height:36px;background:rgba(251,191,36,0.15);border-radius:10px;display:grid;place-items:center;font-size:1.1rem}.patient-context-alert.critical .context-alert-icon{background:rgba(239,68,68,0.2)}.context-alert-title{font-size:0.9rem;font-weight:700;color:#fbbf24}.patient-context-alert.critical .context-alert-title{color:#f87171}.context-alert-list{list-style:none;padding:0;margin:0}.context-alert-list li{display:flex;align-items:flex-start;gap:8px;padding:10px 12px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:8px;font-size:0.82rem;color:var(--text-secondary);line-height:1.4}.context-alert-list li:last-child{margin-bottom:0}.context-alert-list li.critical{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2)}.context-alert-list li.high{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2)}.context-alert-list .alert-icon{font-size:1rem;flex-shrink:0;margin-top:1px}.drug-instant-badge{display:flex;align-items:center;gap:8px;padding:10px 16px;margin-bottom:20px;background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(52,211,153,0.05));border:1px solid rgba(16,185,129,0.25);border-radius:10px}.instant-icon{font-size:1.1rem}.drug-instant-badge>span:nth-child(2){font-size:0.85rem;font-weight:700;color:#34d399}.instant-source{margin-left:auto;font-size:0.7rem;font-weight:600;color:#6b7280;padding:3px 10px;background:rgba(255,255,255,0.05);border-radius:100px}.drug-section{margin-bottom:20px}.drug-section-title{display:flex;align-items:center;gap:8px;font-size:0.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}.drug-info-text{font-size:0.88rem;color:var(--text-secondary);line-height:1.65}.drug-info-list{list-style:none;padding:0;margin:0}.drug-info-list li{display:flex;align-items:flex-start;gap:10px;padding:8px 0;font-size:0.85rem;color:var(--text-secondary);border-bottom:1px solid var(--border);line-height:1.5}.drug-info-list li:last-child{border-bottom:none}.drug-info-list li::before{content:'•';color:var(--teal);font-weight:bold;font-size:1rem;line-height:1.4}.drug-info-list.contraindications li::before{color:var(--rose)}.drug-info-list.monitoring li::before{color:var(--blue)}.drug-info-list.interactions li::before{color:var(--gold)}.drug-info-list li strong{color:var(--text);font-weight:600}.renal-dosing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}.renal-dose-item{padding:12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:10px;text-align:center}.renal-label{display:block;font-size:0.7rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px}.renal-value{font-size:0.8rem;color:var(--text-secondary);line-height:1.4}</style></head><body><div class="page active" id="landing"><div class="sync-status" id="syncStatus"><div class="sync-dot"></div><span id="syncStatusText">Synced</span></div><div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><h1 class="landing-title">MedWard Pro</h1><p class="landing-subtitle">Neural Clinical Management System</p><p class="landing-version">🧠 AI-Powered • Drug Info • Lab Override • Discharge • v15.0</p><div class="units-grid" id="unitsGrid"></div><button class="request-unit-btn" onclick="openRequestUnit()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 5v14M5 12h14"/></svg>
Request New Unit Access
</button><div class="fab sync-fab" id="syncFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4-3-9s1.34-9 3-9"/></svg></div><div class="fab admin-fab" id="adminFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div></div><div class="page" id="dashboard"><header class="dash-header"><div class="dash-logo"><div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div><span class="dash-badge" id="unitBadge">Unit</span></div><div class="dash-user"><div class="dash-avatar" id="dashAvatar">DR</div><button class="btn btn-ghost btn-icon" onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button></div></header><div class="dash-content"><div class="date-banner">📅 <span id="currentDate"></span></div><div class="panel active" id="panelPatients"><div class="stats-grid" id="statsBar"><div class="stat-card active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div><div class="stat-card" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div><div class="stat-card" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div><div class="stat-card" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div><div class="stat-card" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div></div><div class="action-buttons"><button class="btn btn-primary btn-sm" onclick="openAddPatient()">➕ Add Patient</button><button class="btn btn-secondary btn-sm" onclick="openImport()">📥 Import List</button><button class="btn btn-secondary btn-sm btn-full" onclick="exportPDF()">📄 Export PDF</button></div><div id="patientsList"></div></div><div class="panel" id="panelScores"><div class="section-card"><div class="section-header"><div class="section-title">📊 Clinical Scoring Calculators</div></div><div class="section-body"><div class="scores-search-wrapper"><svg class="scores-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg><input type="text" class="scores-search-input" id="scoresSearchInput" placeholder="Search scores (e.g., CURB-65, Wells, HEART)..." oninput="filterScores(this.value)"></div><div class="quick-score-ref"><div class="quick-score-ref-title">🚨 Common Emergency Scores</div><div class="quick-score-ref-grid"><div class="quick-score-ref-item" onclick="openScoreCalculator('qSOFA')"><span class="quick-score-ref-item-name">qSOFA</span><span class="quick-score-ref-item-hint">Sepsis screening</span></div><div class="quick-score-ref-item" onclick="openScoreCalculator('Glasgow-Coma')"><span class="quick-score-ref-item-name">GCS</span><span class="quick-score-ref-item-hint">Consciousness</span></div><div class="quick-score-ref-item" onclick="openScoreCalculator('HEART')"><span class="quick-score-ref-item-name">HEART</span><span class="quick-score-ref-item-hint">Chest pain</span></div><div class="quick-score-ref-item" onclick="openScoreCalculator('Wells-PE')"><span class="quick-score-ref-item-name">Wells PE</span><span class="quick-score-ref-item-hint">PE probability</span></div><div class="quick-score-ref-item" onclick="openScoreCalculator('CURB-65')"><span class="quick-score-ref-item-name">CURB-65</span><span class="quick-score-ref-item-hint">Pneumonia</span></div><div class="quick-score-ref-item" onclick="openScoreCalculator('NEWS2')"><span class="quick-score-ref-item-name">NEWS2</span><span class="quick-score-ref-item-hint">Early warning</span></div></div></div><div id="scoresGrid" class="emergency-scores-grid"></div></div></div></div><div class="panel" id="panelReference"><div class="section-card"><div class="section-header"><div class="section-title">📚 Clinical Reference</div></div><div class="section-body"><div class="ref-grid" id="refGrid"></div></div></div></div></div><div class="tabs-container" id="mainTabs"><button class="tab active" data-tab="patients"><span class="tab-icon">👥</span><span class="tab-label">Patients</span></button><button class="tab" data-tab="scores"><span class="tab-icon">📊</span><span class="tab-label">Scores</span></button><button class="tab" data-tab="reference"><span class="tab-icon">📚</span><span class="tab-label">Reference</span></button></div></div><div class="page" id="patientProfile"><div class="profile-header"><div class="profile-nav"><div class="back-btn" onclick="closePatientProfile()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div><div class="profile-title">Patient Profile</div><div class="profile-actions"><button class="btn btn-success btn-sm" onclick="openDischargeModal(state.currentPatient?.id)" id="profileDischargeBtn">🏠 Discharge</button><button class="btn btn-secondary btn-sm" onclick="editCurrentPatient()">✏️</button><button class="btn btn-danger btn-sm" onclick="deleteCurrentPatient()">🗑️</button></div></div><div class="profile-patient" id="profilePatientInfo"></div></div><div class="profile-tabs" id="profileTabs"><button class="profile-tab active" data-ptab="overview">📋 Overview</button><button class="profile-tab" data-ptab="meds">💊 Meds</button><button class="profile-tab" data-ptab="history">📜 History</button><button class="profile-tab" data-ptab="scores">📊 Scores</button><button class="profile-tab" data-ptab="labs">🧪 Labs</button><button class="profile-tab" data-ptab="imaging">🩻 Imaging</button><button class="profile-tab" data-ptab="fluids">💧 Fluids</button><button class="profile-tab" data-ptab="plans">📝 Plans</button></div><div class="profile-body"><div class="profile-content"><div class="profile-panel active" id="profileOverview"></div><div class="profile-panel" id="profileMeds"></div><div class="profile-panel" id="profileHistory"></div><div class="profile-panel" id="profileScores"></div><div class="profile-panel" id="profileLabs"></div><div class="profile-panel" id="profileImaging"></div><div class="profile-panel" id="profileFluids"></div><div class="profile-panel" id="profilePlans"></div></div><nav class="profile-sidebar" id="profileSidebar"><button class="profile-nav-item active" data-ptab="overview"><span class="nav-icon">📋</span><span class="nav-label">Overview</span></button><button class="profile-nav-item" data-ptab="meds"><span class="nav-icon">💊</span><span class="nav-label">Meds</span></button><button class="profile-nav-item" data-ptab="history"><span class="nav-icon">📜</span><span class="nav-label">History</span></button><button class="profile-nav-item" data-ptab="labs"><span class="nav-icon">🧪</span><span class="nav-label">Labs</span><span class="nav-badge" id="labsAlertBadge" style="display:none">!</span></button><button class="profile-nav-item" data-ptab="imaging"><span class="nav-icon">🩻</span><span class="nav-label">Imaging</span></button><button class="profile-nav-item" data-ptab="scores"><span class="nav-icon">📊</span><span class="nav-label">Scores</span></button><button class="profile-nav-item" data-ptab="fluids"><span class="nav-icon">💧</span><span class="nav-label">Fluids</span></button><button class="profile-nav-item" data-ptab="plans"><span class="nav-icon">📝</span><span class="nav-label">Plans</span><span class="nav-badge" id="plansTaskBadge" style="display:none">0</span></button></nav></div></div><div class="page" id="adminPanel"><header class="admin-header"><div style="display:flex;align-items:center;gap:12px"><div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div><span style="font-weight:700">Admin Dashboard</span></div><button class="btn btn-secondary btn-sm" onclick="exitAdmin()">← Exit</button></header><div class="admin-content"><div class="admin-tabs" id="adminTabs"><button class="admin-tab active" data-atab="units">🏥 Units</button><button class="admin-tab" data-atab="requests">📩 Requests <span class="badge-count" id="requestsCount" style="display:none">0</span></button><button class="admin-tab" data-atab="settings">⚙️ Settings</button></div><div class="admin-tab-panel active" id="adminUnits"><div class="admin-section"><div class="section-header"><div class="section-title">🏥 Manage Units</div><button class="btn btn-primary btn-sm" onclick="addUnit()">+ Add Unit</button></div><table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead><tbody id="unitsTable"></tbody></table></div></div><div class="admin-tab-panel" id="adminRequests"><div class="admin-section"><div class="section-header"><div class="section-title">📩 Unit Access Requests</div><button class="btn btn-secondary btn-sm" onclick="refreshRequests()">🔄 Refresh</button></div><div class="section-body"><div class="requests-list" id="requestsList"><div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:2rem;margin-bottom:12px">📭</div><div>No pending requests</div></div></div></div></div></div><div class="admin-tab-panel" id="adminSettings"><div class="admin-section"><div class="section-header"><div class="section-title">⚙️ System Settings</div></div><div class="section-body"><div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="Enter new password"></div><div class="form-group"><label class="form-label">API Endpoint <span style="color:var(--emerald);font-size:0.75rem">(Hardcoded ✓)</span></label><input type="text" id="apiUrl" class="form-input" readonly style="background:rgba(20,184,166,0.1);border-color:var(--emerald);color:var(--text-secondary)"><p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">API URL is hardcoded in the app for all users</p></div><div class="form-group"><label class="form-label">💊 Drug Reference URL</label><input type="text" id="drugRefUrl" class="form-input" placeholder="https://example.com/drug.html"><p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">URL for the "Learn More" button on medications. Leave empty to disable.</p></div><button class="btn btn-primary" onclick="saveSettings()">💾 Save Settings</button></div></div></div></div></div><div class="modal" id="accessModal"><div class="modal-box"><div class="modal-header" style="text-align:center;display:block;border:none"><div id="accessIcon" style="font-size:3rem;margin-bottom:12px">🏥</div><div class="modal-title" id="accessTitle">Unit Access</div><p style="color:var(--text-muted);font-size:0.85rem;margin-top:8px">Enter 4-digit code</p></div><div class="modal-body"><div class="code-inputs" id="codeInputs"></div><p class="code-error" id="codeError">Invalid code</p><div id="userSection" style="display:none;margin-top:28px;padding-top:28px;border-top:1px solid var(--border)"><div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input"></div><div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option></select></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button><button class="btn btn-primary" id="enterBtn" style="display:none" onclick="enterUnit()">Enter</button></div></div></div><div class="modal" id="adminModal"><div class="modal-box"><div class="modal-header" style="text-align:center;display:block;border:none"><div style="font-size:3rem;margin-bottom:12px">⚙️</div><div class="modal-title">Admin Access</div></div><div class="modal-body"><div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPwd" class="form-input"></div><p class="code-error" id="adminError">Invalid</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('adminModal')">Cancel</button><button class="btn btn-primary" onclick="loginAdmin()">Login</button></div></div></div><div class="modal" id="patientModal"><div class="modal-box" style="max-width:540px"><div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div><div class="modal-body"><input type="hidden" id="ptId"><div class="form-group"><label class="form-label">Patient Name</label><input type="text" id="ptName" class="form-input"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div class="form-group"><label class="form-label">Ward</label><div class="ward-input-wrapper"><input type="text" id="ptWard" class="form-input" placeholder="Type ward (e.g., Ward 14, ICU)" autocomplete="off" oninput="showWardSuggestions(this.value)" onfocus="showWardSuggestions(this.value)"><div class="ward-suggestions" id="wardSuggestions"></div></div></div><div class="form-group"><label class="form-label">Room</label><input type="text" id="ptRoom" class="form-input"></div></div><div class="form-group"><label class="form-label">Diagnosis</label><textarea id="ptDx" class="form-textarea"></textarea></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div class="form-group"><label class="form-label">Doctor</label><input type="text" id="ptDoctor" class="form-input"></div><div class="form-group"><label class="form-label">Status</label><select id="ptStatus" class="form-select"><option value="new">🆕 New</option><option value="active">✅ Active</option><option value="critical">🚨 Critical</option><option value="chronic">💜 Chronic</option><option value="discharged">🏠 Discharged</option></select></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button><button class="btn btn-primary" onclick="savePatient()">Save</button></div></div></div><div class="modal" id="unitModal"><div class="modal-box"><div class="modal-header"><div class="modal-title" id="unitModalTitle">Add Unit</div></div><div class="modal-body"><div class="form-group"><label class="form-label">Name</label><input type="text" id="uName" class="form-input"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div class="form-group"><label class="form-label">Icon</label><input type="text" id="uIcon" class="form-input" value="🏥" style="font-size:1.75rem;text-align:center"></div><div class="form-group"><label class="form-label">Code</label><input type="text" id="uCode" class="form-input" maxlength="4"></div></div><div class="form-group"><label class="form-label">Description</label><input type="text" id="uDesc" class="form-input"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button><button class="btn btn-primary" onclick="saveUnit()">Save</button></div></div></div><div class="modal" id="importModal"><div class="modal-box" style="max-width:560px"><div class="modal-header"><div class="modal-title">📥 Import Patients</div></div><div class="modal-body"><div id="importUpload"><div class="upload-zone" onclick="document.getElementById('importFile').click()"><div style="font-size:2.5rem;margin-bottom:12px">📷</div><div style="font-weight:600">Upload Screenshot</div></div><input type="file" id="importFile" accept="image/*" style="display:none"></div><div id="importPreview" style="display:none"><img id="importImg" style="width:100%;max-height:160px;object-fit:contain;border-radius:12px;margin-bottom:16px"><div style="display:flex;gap:12px"><button class="btn btn-secondary btn-sm" style="flex:1" onclick="resetImport()">Change</button><button class="btn btn-primary btn-sm" style="flex:2" onclick="extractPatients()">🤖 Extract</button></div></div><div id="importLoading" style="display:none;text-align:center;padding:48px"><div class="spinner"></div></div><div id="importResults" style="display:none"><div style="display:flex;justify-content:space-between;margin-bottom:16px"><span style="font-weight:600">Found</span><span id="importCount" class="badge badge-emerald">0</span></div><div id="importList" style="max-height:320px;overflow-y:auto"></div></div><div id="importError" style="display:none;text-align:center;padding:40px"><div style="font-size:2.5rem;margin-bottom:16px">⚠️</div><div id="importErrorMsg" style="color:var(--rose)">Error</div><button class="btn btn-secondary btn-sm" style="margin-top:16px" onclick="resetImport()">Retry</button></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button><button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>Import</button></div></div></div><div class="modal" id="editTextModal"><div class="modal-box wide"><div class="modal-header"><div class="modal-title" id="editTextTitle">Edit</div></div><div class="modal-body"><input type="hidden" id="editTextType"><textarea id="editTextArea" class="form-textarea" style="min-height:200px"></textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('editTextModal')">Cancel</button><button class="btn btn-primary" onclick="saveEditText()">Save</button></div></div></div><div class="modal" id="addDataModal"><div class="modal-box wide"><div class="modal-header"><div class="modal-title" id="addDataTitle">Add</div></div><div class="modal-body" id="addDataBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addDataModal')">Cancel</button><button class="btn btn-primary" onclick="saveAddData()">Save</button></div></div></div><div class="modal" id="requestUnitModal"><div class="modal-box wide"><div class="modal-header"><div class="modal-title">📩 Request New Unit Access</div><button class="btn btn-ghost" onclick="closeModal('requestUnitModal')">✕</button></div><div class="modal-body" id="requestUnitBody"><div id="requestFormSection"><p style="color:var(--text-secondary);margin-bottom:24px;font-size:0.9rem">Fill out this form to request a new unit. Your request will be reviewed by an administrator who will create your unit and provide access credentials.</p><div class="request-form"><div class="request-form-row"><div class="form-group"><label class="form-label">Your Full Name *</label><input type="text" id="reqName" class="form-input" placeholder="Dr. John Smith"></div><div class="form-group"><label class="form-label">Email Address *</label><input type="email" id="reqEmail" class="form-input" placeholder="john.smith@hospital.com"></div></div><div class="request-form-row"><div class="form-group"><label class="form-label">Department *</label><input type="text" id="reqDepartment" class="form-input" placeholder="e.g., Internal Medicine, Cardiology"></div><div class="form-group"><label class="form-label">Position/Role *</label><select id="reqRole" class="form-input"><option value="">Select role...</option><option value="attending">Attending Physician</option><option value="consultant">Consultant</option><option value="resident">Resident</option><option value="intern">Intern</option><option value="nurse_manager">Nurse Manager</option><option value="head_nurse">Head Nurse</option><option value="other">Other</option></select></div></div><div class="form-group"><label class="form-label">Requested Unit Name *</label><input type="text" id="reqUnitName" class="form-input" placeholder="e.g., Cardiology Unit A, ICU Team 2"></div><div class="form-group"><label class="form-label">Unit Icon</label><div class="request-icon-grid" id="iconGrid"><div class="request-icon-option selected" data-icon="🏥">🏥</div><div class="request-icon-option" data-icon="❤️">❤️</div><div class="request-icon-option" data-icon="🫀">🫀</div><div class="request-icon-option" data-icon="🧠">🧠</div><div class="request-icon-option" data-icon="🫁">🫁</div><div class="request-icon-option" data-icon="🦴">🦴</div><div class="request-icon-option" data-icon="👶">👶</div><div class="request-icon-option" data-icon="🩺">🩺</div><div class="request-icon-option" data-icon="💉">💉</div><div class="request-icon-option" data-icon="🔬">🔬</div><div class="request-icon-option" data-icon="⚕️">⚕️</div><div class="request-icon-option" data-icon="🚑">🚑</div></div></div><div class="form-group"><label class="form-label">Reason for Request / Additional Notes</label><textarea id="reqMessage" class="form-textarea" placeholder="Briefly describe why you need this unit and any specific requirements..."></textarea></div></div></div><div id="requestSuccessSection" style="display:none"><div class="request-success"><div class="request-success-icon">✅</div><div class="request-success-title">Request Submitted Successfully!</div><div class="request-success-text">Your request has been sent to the administrator for review. You will receive your unit access code once approved.</div><div class="request-success-id" id="requestIdDisplay">Request ID: REQ-XXXXXX</div></div></div></div><div class="modal-footer" id="requestFormFooter"><button class="btn btn-secondary" onclick="closeModal('requestUnitModal')">Cancel</button><button class="btn btn-primary" onclick="submitUnitRequest()">📤 Submit Request</button></div><div class="modal-footer" id="requestSuccessFooter" style="display:none"><button class="btn btn-primary btn-full" onclick="closeModal('requestUnitModal')">Done</button></div></div></div><div class="modal" id="approveRequestModal"><div class="modal-box wide"><div class="modal-header"><div class="modal-title">✅ Approve Unit Request</div><button class="btn btn-ghost" onclick="closeModal('approveRequestModal')">✕</button></div><div class="modal-body"><div id="approveRequestDetails"></div><div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><h4 style="margin-bottom:16px;font-size:0.9rem">Create Unit Access</h4><div class="request-form"><div class="request-form-row"><div class="form-group"><label class="form-label">Unit Name</label><input type="text" id="approveUnitName" class="form-input"></div><div class="form-group"><label class="form-label">Unit Icon</label><input type="text" id="approveUnitIcon" class="form-input" style="font-size:1.5rem;text-align:center"></div></div><div class="request-form-row"><div class="form-group"><label class="form-label">4-Digit Access Code *</label><input type="text" id="approveUnitCode" class="form-input mono" maxlength="4" placeholder="1234" style="font-size:1.5rem;text-align:center;letter-spacing:8px"></div><div class="form-group"><label class="form-label">Unit Color</label><select id="approveUnitColor" class="form-input"><option value="#14b8a6">🟢 Teal</option><option value="#f59e0b">🟡 Gold</option><option value="#3b82f6">🔵 Blue</option><option value="#8b5cf6">🟣 Purple</option><option value="#f43f5e">🔴 Rose</option><option value="#10b981">🟢 Emerald</option></select></div></div><div class="form-group"><label class="form-label">Unit Description</label><input type="text" id="approveUnitDesc" class="form-input" placeholder="Brief description of the unit"></div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('approveRequestModal')">Cancel</button><button class="btn btn-danger" onclick="rejectRequest()">❌ Reject</button><button class="btn btn-primary" onclick="approveRequest()">✅ Approve & Create Unit</button></div></div></div><div class="modal" id="labPreviewModal"><div class="modal-box wide"><div class="modal-header"><div class="modal-title">🧪 Lab Extraction Preview</div><button class="btn btn-ghost" onclick="closeModal('labPreviewModal'); resetLabExtraction()">✕</button></div><div class="modal-body" id="labPreviewBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('labPreviewModal'); resetLabExtraction()">Cancel</button><button class="btn btn-primary" id="confirmLabBtn" onclick="confirmLabExtraction()">✓ Confirm & Save</button></div></div></div><div class="lab-analysis-loader" id="labAnalysisLoader"><div class="loader-content"><div class="dna-loader"><div class="dna-strand"><div class="dna-dot"></div><div class="dna-dot"></div><div class="dna-dot"></div><div class="dna-dot"></div></div><div class="dna-strand"><div class="dna-dot"></div><div class="dna-dot"></div><div class="dna-dot"></div><div class="dna-dot"></div></div><div class="dna-connector"></div></div><div class="loader-title">Analyzing Lab Results</div><div class="loader-subtitle">Processing with Claude AI</div><div class="loader-steps"><div class="loader-step" id="step1"><div class="step-icon">1</div><span>Preparing image for analysis...</span></div><div class="loader-step" id="step2"><div class="step-icon">2</div><span>Extracting lab values...</span></div><div class="loader-step" id="step3"><div class="step-icon">3</div><span>Identifying reference ranges...</span></div><div class="loader-step" id="step4"><div class="step-icon">4</div><span>Generating clinical interpretation...</span></div></div></div></div><div class="modal" id="scoreCalcModal" style="padding:0"><div class="modal-box wide" style="border:none;background:transparent"><div class="score-calculator"><div class="score-calc-header"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="score-calc-title" id="scoreCalcTitle">Score Name</div><div class="score-calc-purpose" id="scoreCalcPurpose">Purpose description</div></div><button onclick="closeModal('scoreCalcModal')" style="background:rgba(148,163,184,0.1);border:none;width:32px;height:32px;border-radius:8px;color:#94a3b8;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button></div><div class="score-calc-category" id="scoreCalcCategory">Category</div></div><div class="score-calc-body"><div class="score-calc-fields" id="scoreCalcFields"></div></div><div class="score-calc-result" id="scoreCalcResult"><div class="score-result-display"><div class="score-result-value" id="scoreResultValue">0</div><div class="score-result-max" id="scoreResultMax">of 10</div></div><div class="score-result-interpretation" id="scoreResultInterpretation"><div class="score-result-risk">Low Risk</div><div class="score-result-action">Recommended action here</div></div></div><div class="modal-footer" style="background:#080c14;border-top:1px solid rgba(148,163,184,0.06);padding:12px 16px;gap:10px"><button class="btn btn-secondary" onclick="closeModal('scoreCalcModal')" style="background:#1e293b;border:1px solid rgba(148,163,184,0.12);flex:1">Close</button><button class="btn btn-primary" id="saveScoreBtn" onclick="savePatientScore()" style="display:none;flex:1">💾 Save</button></div></div></div></div><div class="modal" id="drugInfoModal"><div class="modal-box wide"><div class="modal-header"><div class="drug-info-badge"><span>✨</span> AI-Powered Analysis</div><div class="modal-title drug-info-title" id="drugInfoTitle">Drug Name</div><p class="drug-info-subtitle">Comprehensive drug information & patient-specific warnings</p></div><div class="modal-body" id="drugInfoBody"><div style="text-align:center;padding:40px"><div class="spinner"></div><p style="margin-top:16px;color:var(--text-muted)">Analyzing drug information...</p></div></div><div class="modal-footer"><button class="btn btn-secondary btn-full" onclick="closeModal('drugInfoModal')">Close</button></div></div></div><div class="modal" id="addMedModal"><div class="modal-box"><div class="modal-header"><div class="med-modal-icon">💊</div><div class="med-modal-title" id="addMedModalTitle">Add Medication</div><p class="med-modal-subtitle">Enter medication details for this patient</p></div><div class="modal-body"><div class="med-form-section"><div class="med-form-section-title"><span>💉</span> Drug Information</div><div class="med-input-group"><label class="med-input-label">Drug Name <span class="required">*</span></label><input type="text" class="med-input" id="medNameNew" placeholder="e.g., Metformin, Lisinopril"></div><div class="med-form-row"><div class="med-input-group"><label class="med-input-label">Dose <span class="required">*</span></label><input type="text" class="med-input" id="medDoseNew" placeholder="e.g., 500mg"></div><div class="med-input-group"><label class="med-input-label">Generic Name</label><input type="text" class="med-input" id="medGenericNew" placeholder="Optional"></div></div></div><div class="med-form-section"><div class="med-form-section-title"><span>🎯</span> Route of Administration</div><div class="med-pill-group" id="routePills"><button type="button" class="med-pill selected" data-route="PO">PO</button><button type="button" class="med-pill" data-route="IV">IV</button><button type="button" class="med-pill" data-route="IM">IM</button><button type="button" class="med-pill" data-route="SC">SC</button><button type="button" class="med-pill" data-route="INH">INH</button><button type="button" class="med-pill" data-route="TOP">TOP</button><button type="button" class="med-pill" data-route="SL">SL</button><button type="button" class="med-pill" data-route="PR">PR</button></div></div><div class="med-form-section"><div class="med-form-section-title"><span>🕐</span> Frequency</div><div class="med-freq-grid" id="freqPills"><button type="button" class="med-freq-pill selected" data-freq="OD"><div class="med-freq-label">OD</div><div class="med-freq-desc">Once daily</div></button><button type="button" class="med-freq-pill" data-freq="BD"><div class="med-freq-label">BD</div><div class="med-freq-desc">Twice daily</div></button><button type="button" class="med-freq-pill" data-freq="TDS"><div class="med-freq-label">TDS</div><div class="med-freq-desc">3× daily</div></button><button type="button" class="med-freq-pill" data-freq="QID"><div class="med-freq-label">QID</div><div class="med-freq-desc">4× daily</div></button><button type="button" class="med-freq-pill" data-freq="Q6H"><div class="med-freq-label">Q6H</div><div class="med-freq-desc">Every 6h</div></button><button type="button" class="med-freq-pill" data-freq="Q8H"><div class="med-freq-label">Q8H</div><div class="med-freq-desc">Every 8h</div></button><button type="button" class="med-freq-pill" data-freq="Q12H"><div class="med-freq-label">Q12H</div><div class="med-freq-desc">Every 12h</div></button><button type="button" class="med-freq-pill" data-freq="PRN"><div class="med-freq-label">PRN</div><div class="med-freq-desc">As needed</div></button></div></div><div class="med-form-section"><div class="med-form-section-title"><span>📋</span> Clinical Details</div><div class="med-input-group"><label class="med-input-label">Indication</label><input type="text" class="med-input" id="medIndicationNew" placeholder="e.g., Type 2 Diabetes, Hypertension"></div><div class="med-input-group"><label class="med-input-label">Status</label><div class="med-status-group" id="statusPills"><button type="button" class="med-status-pill active selected" data-status="active"><span class="med-status-dot"></span>Active
        </button><button type="button" class="med-status-pill new" data-status="new"><span class="med-status-dot"></span>New
        </button><button type="button" class="med-status-pill prn" data-status="prn"><span class="med-status-dot"></span>PRN
        </button><button type="button" class="med-status-pill discontinued" data-status="discontinued"><span class="med-status-dot"></span>Stopped
        </button></div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addMedModal')">Cancel</button><button class="btn btn-primary" onclick="saveMedicationNew()">Save Medication</button></div></div></div><div class="toast" id="toast"></div><input type="file" id="labFileInput" accept="image/*" style="display:none"><div class="modal" id="labOverrideModal"><div class="modal-box"><div class="modal-header"><div class="modal-title">✏️ Override Lab Value</div></div><div class="modal-body"><div class="form-group"><label class="form-label" id="labOverrideName">Parameter</label><input type="text" id="labOverrideValue" class="form-input mono" placeholder="Enter new value"></div><input type="hidden" id="labOverrideParamIdx"><input type="hidden" id="labOverrideValueIdx"><p style="font-size:0.8rem;color:var(--text-muted);margin-top:12px">⚠️ This will override the extracted value. Manual changes are marked with ✏️</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('labOverrideModal')">Cancel</button><button class="btn btn-primary" onclick="saveLabOverride()">Save Override</button></div></div></div><div class="modal" id="dischargeModal"><div class="modal-box"><div class="modal-header" style="text-align:center;display:block;border:none"><div style="font-size:3rem;margin-bottom:12px">🏠</div><div class="modal-title">Discharge Patient</div></div><div class="modal-body"><p style="text-align:center;color:var(--text-secondary);margin-bottom:20px">Are you sure you want to discharge <strong id="dischargePatientName"></strong>?</p><div class="form-group"><label class="form-label">Discharge Summary (Optional)</label><textarea id="dischargeSummary" class="form-textarea" placeholder="Enter discharge notes, follow-up instructions..."></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('dischargeModal')">Cancel</button><button class="btn btn-success" onclick="confirmDischarge()">✓ Confirm Discharge</button></div></div></div><input type="file" id="labFileInputHidden" accept="image/*" style="display:none"><input type="file" id="imagingFileInput" accept="image/*" style="display:none"><script>
(function(){
'use strict';

const CONFIG = {
  STORAGE_KEY: 'medward_pro_v12',
  ADMIN_PASSWORD: 'admin123',
  // Hardcoded API URL - central Google Apps Script for all users
  API_URL: 'https://script.google.com/macros/s/AKfycbznXa9YNna26Srt1eZVEnSV-dIiubFLTwg3ryLdE-maGNCQhydP_8E6AK4QPXkeQrw7lA/exec',
  MAX_IMAGE_SIZE: 1500000,
  IMAGE_QUALITY: 0.85,
  MAX_DIM: 2000,
  SYNC_DEBOUNCE_MS: 1500,
  VALID_WARDS: ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned'],
  LAB_CATEGORIES: {
    'Cardiac Markers': { icon: '❤️', terms: ['Troponin', 'BNP', 'proBNP', 'NT-proBNP', 'CK-MB', 'Myoglobin'] },
    'Renal Function': { icon: '🫘', terms: ['Urea', 'Creatinine', 'Creat', 'eGFR', 'BUN'] },
    'Electrolytes': { icon: '⚡', terms: ['Na', 'Sodium', 'K', 'Potassium', 'Cl', 'Chloride', 'CO2', 'Bicarbonate', 'Mg', 'Magnesium', 'Ca', 'Calcium', 'Phosphate', 'Phos'] },
    'Glucose & Metabolic': { icon: '🍬', terms: ['Glucose', 'Gluc', 'FBG', 'RBG', 'HbA1c', 'Lactate'] },
    'Liver Function': { icon: '🫀', terms: ['ALT', 'AST', 'ALP', 'GGT', 'Bilirubin', 'Albumin', 'Total Protein'] },
    'Complete Blood Count': { icon: '🩸', terms: ['Hgb', 'Hemoglobin', 'WBC', 'Platelets', 'RBC', 'MCV', 'Hct'] },
    'Other': { icon: '🔬', terms: ['Urate', 'Uric Acid', 'Anion Gap', 'Osmolality', 'CRP', 'ESR', 'Procalcitonin'] }
  },

  // CLINICAL SCORING SYSTEMS

  // Patient-specific scores - appear in patient profile based on diagnosis
  PATIENT_SCORES: {
    'atrial fibrillation': ['CHA2DS2-VASc'], 'af': ['CHA2DS2-VASc'], 'afib': ['CHA2DS2-VASc'],
    'pneumonia': ['CURB-65'], 'cap': ['CURB-65'],
    'pe': ['Wells-PE'], 'pulmonary embolism': ['Wells-PE'],
    'head injury': ['GCS'], 'trauma': ['GCS'], 'altered mental status': ['GCS']
  },

  // Complete scoring calculators with formulas
  SCORING_CALCULATORS: {
    'CHA2DS2-VASc': {
      name: 'CHA₂DS₂-VASc Score', category: 'Cardiac', purpose: 'Stroke risk in AF',
      fields: [
        { id: 'chf', label: 'CHF/LV dysfunction', points: 1, type: 'checkbox' },
        { id: 'htn', label: 'Hypertension', points: 1, type: 'checkbox' },
        { id: 'age75', label: 'Age ≥75', points: 2, type: 'checkbox' },
        { id: 'dm', label: 'Diabetes', points: 1, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke/TIA', points: 2, type: 'checkbox' },
        { id: 'vascular', label: 'Vascular disease', points: 1, type: 'checkbox' },
        { id: 'age65', label: 'Age 65-74', points: 1, type: 'checkbox' },
        { id: 'female', label: 'Female', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Low', action: 'No anticoagulation', color: '#10b981' },
        { min: 1, max: 1, risk: 'Moderate', action: 'Consider anticoagulation', color: '#f59e0b' },
        { min: 2, max: 9, risk: 'High', action: 'Anticoagulation recommended', color: '#ef4444' }
      ]
    },
    'CURB-65': {
      name: 'CURB-65', category: 'Respiratory', purpose: 'Pneumonia severity',
      fields: [
        { id: 'confusion', label: 'Confusion', points: 1, type: 'checkbox' },
        { id: 'urea', label: 'Urea >7 mmol/L', points: 1, type: 'checkbox' },
        { id: 'rr', label: 'RR ≥30', points: 1, type: 'checkbox' },
        { id: 'bp', label: 'BP <90/60', points: 1, type: 'checkbox' },
        { id: 'age', label: 'Age ≥65', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'Outpatient treatment', color: '#10b981' },
        { min: 2, max: 2, risk: 'Moderate', action: 'Consider admission', color: '#f59e0b' },
        { min: 3, max: 5, risk: 'High', action: 'Admit, consider ICU', color: '#ef4444' }
      ]
    },
    'Wells-PE': {
      name: 'Wells PE Score', category: 'Respiratory', purpose: 'PE probability',
      fields: [
        { id: 'dvt', label: 'Clinical DVT signs', points: 3, type: 'checkbox' },
        { id: 'alternative', label: 'PE most likely diagnosis', points: 3, type: 'checkbox' },
        { id: 'hr', label: 'HR >100', points: 1.5, type: 'checkbox' },
        { id: 'immobile', label: 'Immobilization/surgery', points: 1.5, type: 'checkbox' },
        { id: 'prior', label: 'Previous DVT/PE', points: 1.5, type: 'checkbox' },
        { id: 'hemoptysis', label: 'Hemoptysis', points: 1, type: 'checkbox' },
        { id: 'malignancy', label: 'Malignancy', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'D-dimer, if negative PE excluded', color: '#10b981' },
        { min: 2, max: 6, risk: 'Moderate', action: 'D-dimer or imaging', color: '#f59e0b' },
        { min: 7, max: 15, risk: 'High', action: 'Imaging recommended', color: '#ef4444' }
      ]
    },
    'GCS': {
      name: 'Glasgow Coma Scale', category: 'Neuro', purpose: 'Consciousness level',
      fields: [
        { id: 'eye', label: 'Eye Opening', type: 'select', options: [
          { value: 1, label: '1 - None' }, { value: 2, label: '2 - To pain' },
          { value: 3, label: '3 - To voice' }, { value: 4, label: '4 - Spontaneous' }
        ]},
        { id: 'verbal', label: 'Verbal', type: 'select', options: [
          { value: 1, label: '1 - None' }, { value: 2, label: '2 - Incomprehensible' },
          { value: 3, label: '3 - Inappropriate' }, { value: 4, label: '4 - Confused' },
          { value: 5, label: '5 - Oriented' }
        ]},
        { id: 'motor', label: 'Motor', type: 'select', options: [
          { value: 1, label: '1 - None' }, { value: 2, label: '2 - Extension' },
          { value: 3, label: '3 - Flexion' }, { value: 4, label: '4 - Withdrawal' },
          { value: 5, label: '5 - Localizes' }, { value: 6, label: '6 - Obeys' }
        ]}
      ],
      interpretation: [
        { min: 13, max: 15, risk: 'Mild', action: 'Minor injury', color: '#10b981' },
        { min: 9, max: 12, risk: 'Moderate', action: 'Moderate injury', color: '#f59e0b' },
        { min: 3, max: 8, risk: 'Severe', action: 'Severe injury, intubate', color: '#ef4444' }
      ]
    }
  },

  REFS: []
};

const state = {
  units: [], settings: {}, patients: [], currentUnit: null, currentUser: null, currentPatient: null,
  selectedUnitId: null, editingUnitId: null, importImage: null, importPatients: [], currentFilter: 'all',
  fluidChart: null, trendChart: null, addDataType: null, isAnalyzingLab: false, isAnalyzingImaging: false,
  currentInteractionId: null, sessionId: null, unitRequests: [], selectedRequestId: null, selectedIcon: '🏥',
  pendingLabData: null, pendingLabImage: null, labExtractionConfidence: 0, isAnalyzingMeds: false, dischargePatientId: null
};

// Generate session ID
state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

// Sync state tracking for reactive auto-sync
let syncState = {
  status: 'synced',
  lastSyncTime: null,
  pendingChanges: false,
  syncTimeout: null,
  errorCount: 0
};

const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = t => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
const initials = n => { if (!n) return '?'; const p = n.trim().split(/\s+/); return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : n.substring(0, 2).toUpperCase(); };

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }
window.closeModal = closeModal;

function showPage(pageId) {
  $$('.page').forEach(p => p.classList.remove('active'));
  $(pageId).classList.add('active');
}

function formatDate(d) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  d = d || new Date();
  return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

function formatDateTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatShortDate(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function compress(file, max, cb) {
  const r = new FileReader();
  r.onload = e => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas'), ctx = c.getContext('2d');
      let w = img.width, h = img.height, q = CONFIG.IMAGE_QUALITY;
      if (w > CONFIG.MAX_DIM || h > CONFIG.MAX_DIM) {
        if (w > h) { h = Math.round(h * CONFIG.MAX_DIM / w); w = CONFIG.MAX_DIM; }
        else { w = Math.round(w * CONFIG.MAX_DIM / h); h = CONFIG.MAX_DIM; }
      }
      c.width = w; c.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      let url = c.toDataURL('image/jpeg', q);
      while (url.length > max && q > 0.3) { q -= 0.1; url = c.toDataURL('image/jpeg', q); }
      cb(url);
    };
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}

function smartWard(raw) {
  if (!raw) return 'Ward 14';
  const w = String(raw).toLowerCase();
  if (w.includes('14')) return 'Ward 14';
  if (w.includes('22')) return 'Ward 22';
  if (w.includes('27')) return 'Ward 27';
  if (w.includes('icu')) return 'ICU';
  if (w.includes('er') || w.includes('unassign')) return 'ER/Unassigned';
  return 'Ward 14';
}

function getLabCategory(name) {
  const n = (name || '').toLowerCase();
  for (const [cat, data] of Object.entries(CONFIG.LAB_CATEGORIES)) {
    if (data.terms.some(t => n.includes(t.toLowerCase()))) return cat;
  }
  return 'Other';
}

// STORAGE

let isSyncing = false;

function loadLocal() {
  try {
    const s = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (s) {
      const d = JSON.parse(s);
      if (d.units?.length) state.units = d.units;
      if (d.settings) state.settings = { ...state.settings, ...d.settings }

if (!Array.isArray(state.patients) || state.patients.length === 0) {
  state.patients = [{
    id: Date.now(),
    name: 'Demo Patient',
    age: 65,
    bed: '12A',
    diagnosis: 'Community Acquired Pneumonia',
    status: 'active',
    ward: state.currentUnit || 'Unit A',
    labData: { dates: [], parameters: [] },
    imaging: [], fluids: [], plans: [], history: '', vitals: {}
  }];
}
;
      if (d.patients) state.patients = d.patients;
      if (d.unitRequests) state.unitRequests = d.unitRequests;
    }
  } catch (e) { console.log('Local storage load error:', e); }

  // Default unit
  if (!state.units.length) state.units = [{ id: 'med-e', name: 'Medicine Unit E', icon: '🏥', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }];

  // Demo patients if none exist (for testing)
  if (!state.patients.length) {
        state.patients = [
      { id: 1, name: 'John Smith', ward: 'Ward 14', room: '101', diagnosis: 'Community Acquired Pneumonia', doctor: 'Dr. Ahmed', status: 'active', labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: { hr: '78', bp: '120/80', temp: '37.2', rr: '18', spo2: '96%' } },
      { id: 2, name: 'Sarah Johnson', ward: 'Ward 14', room: '102', diagnosis: 'DKA - Diabetic Ketoacidosis', doctor: 'Dr. Fatima', status: 'critical', labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: { hr: '110', bp: '90/60', temp: '36.8', rr: '24', spo2: '94%' } },
      { id: 3, name: 'Mohammed Ali', ward: 'Ward 22', room: '205', diagnosis: 'Acute COPD Exacerbation', doctor: 'Dr. Ahmed', status: 'chronic', labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: { hr: '92', bp: '140/90', temp: '37.8', rr: '22', spo2: '89%' } }
    ];
  }

  state.settings.adminPassword = state.settings.adminPassword || CONFIG.ADMIN_PASSWORD;
  // Always use hardcoded API URL - this ensures all users have the correct endpoint
  state.settings.apiUrl = CONFIG.API_URL;
}

function saveLocal() {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
      units: state.units, settings: state.settings, patients: state.patients, unitRequests: state.unitRequests, lastUpdated: new Date().toISOString()
    }));
  } catch (e) {}
}

async function syncCloud() {
  // Redirect to new system
  await syncFromCloud();
}

// REACTIVE AUTO-SYNC SYSTEM

function updateSyncStatus(status, message) {
  syncState.status = status;
  const el = $('syncStatus');
  const textEl = $('syncStatusText');

  if (!el || !textEl) return;

  el.className = 'sync-status visible ' + status;
  textEl.textContent = message || {
    synced: 'Synced',
    pending: 'Saving...',
    syncing: 'Syncing...',
    error: 'Sync failed'
  }[status];

  if (status === 'synced') {
    setTimeout(() => {
      if (syncState.status === 'synced') {
        el.classList.remove('visible');
      }
    }, 2000);
  }
}

function markDirty() {
  syncState.pendingChanges = true;
  updateSyncStatus('pending', 'Saving...');

  if (syncState.syncTimeout) {
    clearTimeout(syncState.syncTimeout);
  }

  syncState.syncTimeout = setTimeout(() => {
    performSync();
  }, CONFIG.SYNC_DEBOUNCE_MS);
}

async function performSync() {
  if (!syncState.pendingChanges) return;

  // Always save locally first
  saveLocal();

  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    syncState.pendingChanges = false;
    updateSyncStatus('synced', 'Saved locally');
    return;
  }

  updateSyncStatus('syncing', 'Syncing to cloud...');

  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'saveData',
        payload: {
          units: state.units,
          settings: {
            adminPassword: state.settings.adminPassword,
            apiUrl: state.settings.apiUrl  // Include API URL so all users get it
          },
          patients: state.patients,
          unitRequests: state.unitRequests
        }
      })
    });

    if (!res.ok) throw new Error('HTTP ' + res.status);

    syncState.pendingChanges = false;
    syncState.lastSyncTime = Date.now();
    syncState.errorCount = 0;
    updateSyncStatus('synced', 'Synced');

  } catch (e) {
    console.error('Sync error:', e);
    syncState.errorCount++;

    if (syncState.errorCount >= 3) {
      updateSyncStatus('error', 'Sync failed - check connection');
    } else {
      setTimeout(() => performSync(), 5000);
      updateSyncStatus('pending', 'Retrying...');
    }
  }
}

async function saveCloud() {
  markDirty();
}

// Force immediate sync - bypasses debounce for critical operations like lab saves
async function forceSync() {
  // Clear any pending debounced sync
  if (syncState.syncTimeout) {
    clearTimeout(syncState.syncTimeout);
    syncState.syncTimeout = null;
  }

  // Save locally first
  saveLocal();

  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    console.log('⚠️ No API URL configured - saved locally only');
    updateSyncStatus('synced', 'Saved locally');
    return true;
  }

  updateSyncStatus('syncing', 'Saving to cloud...');
  console.log('☁️ Force syncing to cloud...');
  console.log('📦 Patients to save:', state.patients.length);

  // Log lab data for debugging
  state.patients.forEach(p => {
    if (p.labData?.parameters?.length) {
      console.log(`   Patient ${p.name}: ${p.labData.parameters.length} lab parameters`);
    }
  });

  try {
    const payload = {
      units: state.units,
      settings: {
        adminPassword: state.settings.adminPassword,
        apiUrl: state.settings.apiUrl  // Include API URL so all users get it
      },
      patients: state.patients,
      unitRequests: state.unitRequests
    };

    console.log('📤 Sending payload size:', JSON.stringify(payload).length, 'bytes');

    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'saveData',
        payload: payload
      })
    });

    const responseText = await res.text();

    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error('Invalid response: ' + responseText.substring(0, 100));
    }

    if (!res.ok || !result.success) {
      throw new Error(result.error || 'Save failed');
    }

    syncState.pendingChanges = false;
    syncState.lastSyncTime = Date.now();
    syncState.errorCount = 0;
    updateSyncStatus('synced', 'Synced');
        return true;

  } catch (e) {
    console.error('❌ Sync error:', e);
    syncState.errorCount++;
    updateSyncStatus('error', 'Sync failed: ' + e.message);
    toast('Failed to save to cloud: ' + e.message, true);
    return false;
  }
}

async function manualSync() {
  const syncFab = $('syncFab');
  syncFab.classList.add('syncing');
  updateSyncStatus('syncing', 'Syncing...');

  try {
    await syncFromCloud();
    syncState.pendingChanges = true;
    await performSync();
    toast('Synced successfully!');
  } catch (e) {
    toast('Sync failed', true);
  }

  syncFab.classList.remove('syncing');
}

async function syncFromCloud() {
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') return;

  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'loadData' })
    });

    const data = await res.json();

    if (data.success && data.data) {
      // Update units
      if (data.data.units?.length) {
        state.units = data.data.units;
              }

      // Update settings - IMPORTANT: preserve local apiUrl if cloud doesn't have it
      if (data.data.settings) {
        const cloudApiUrl = data.data.settings.apiUrl;
        state.settings = { ...state.settings, ...data.data.settings };
        // If cloud has apiUrl, use it; otherwise keep local
        if (cloudApiUrl && cloudApiUrl !== 'YOUR_API_URL_HERE') {
          state.settings.apiUrl = cloudApiUrl;
        }
              }

      // Update patients - GUARDED: don't let empty cloud overwrite local data
      const cloudPatients = data.data.patients;
      if (Array.isArray(cloudPatients)) {
        if (cloudPatients.length > 0) {
          // Cloud has patients - use them
          state.patients = cloudPatients;
                  } else if (state.patients.length === 0) {
          // Both empty - accept cloud (no data loss)
          state.patients = cloudPatients;
                  } else {
          // Cloud empty but local has data - KEEP LOCAL to prevent data loss
                  }

        // Log lab data for debugging
        state.patients.forEach(p => {
          if (p.labData?.parameters?.length) {
            console.log(`   → ${p.name}: ${p.labData.parameters.length} lab parameters`);
          }
        });

        // If we have a current patient open, refresh their reference
        if (state.currentPatient) {
          const refreshedPatient = state.patients.find(p => p.id === state.currentPatient.id);
          if (refreshedPatient) {
            state.currentPatient = refreshedPatient;
                      }
        }
      }

      // Update unit requests
      if (data.data.unitRequests) {
        state.unitRequests = data.data.unitRequests;
      }

      // Save to local storage
      saveLocal();

      // Re-render appropriate view with diagnostic logging
      console.log('🔄 Re-rendering view. State:', {
        currentPatient: state.currentPatient?.name || null,
        currentUnit: state.currentUnit?.name || null,
        currentFilter: state.currentFilter,
        patientCount: state.patients.length
      });

      if (state.currentPatient) {
                renderPatientProfile();
      } else if (state.currentUnit) {
                renderPatients();
      } else {
                renderUnits();
      }

          }
  } catch (e) {
    console.error('❌ Load from cloud failed:', e);
    // Still render whatever we have in local state
        if (state.currentPatient) {
      renderPatientProfile();
    } else if (state.currentUnit) {
      renderPatients();
    } else {
      renderUnits();
    }
  }
}

function getUnit(id) { return state.units.find(u => u.id === id); }
function getPatient(id) { return state.patients.find(p => p.id === id); }

// FEEDBACK SYSTEM (RLHF)

async function sendFeedback(rating, interpretationType = 'lab') {
  if (!state.currentInteractionId || !state.currentPatient) return;

  const p = state.currentPatient;

  try {
    await fetch(state.settings.apiUrl, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'recordFeedback',
        interactionId: state.currentInteractionId,
        patientId: p.id,
        interpretationType,
        rating,
        interpretation: p.labData?.interpretation?.summary || '',
        labValues: p.labData?.parameters?.map(param => ({
          name: param.name,
          value: param.values?.[0]?.value,
          status: param.values?.[0]?.status
        })) || [],
        sessionId: state.sessionId
      })
    });

    // Update UI
    $$('.feedback-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.feedback-btn.${rating > 0 ? 'positive' : 'negative'}`)?.classList.add('active');
    document.querySelector('.feedback-sent')?.classList.add('show');

    toast(rating > 0 ? 'Thanks! This helps improve accuracy.' : 'Feedback noted. We\'ll improve.');
  } catch (e) {
    console.error('Feedback error:', e);
  }
}

window.sendFeedback = sendFeedback;

// RENDER FUNCTIONS

function renderUnits() {
  $('unitsGrid').innerHTML = state.units.map(u => `
    <div class="unit-card" style="--unit-color:${u.color || '#f59e0b'}" data-id="${u.id}"><div class="unit-card-icon">${u.icon || '🏥'}</div><div class="unit-card-name">${esc(u.name)}</div><div class="unit-card-desc">${esc(u.desc || '')}</div></div>
  `).join('');
  $$('.unit-card').forEach(c => c.onclick = () => openUnitAccess(c.dataset.id));
}

function renderUnitsTable() {
  $('unitsTable').innerHTML = state.units.map(u => `
    <tr><td><span style="font-size:1.25rem;margin-right:10px">${u.icon}</span><b>${esc(u.name)}</b></td><td><code style="background:var(--bg);padding:6px 14px;border-radius:8px">${u.code}</code></td><td><button class="btn btn-ghost btn-xs" onclick="editUnit('${u.id}')">✏️</button><button class="btn btn-ghost btn-xs" onclick="deleteUnit('${u.id}')">🗑️</button></td></tr>
  `).join('');
}

function renderPatients() {
  const container = $('patientsList');
  if (!container) { console.warn('patientsList container not found'); return; }

  // Safety: Default to 'all' if filter is broken/undefined
  if (!state.currentFilter) state.currentFilter = 'all';

  // Safety: Ensure patients array exists
  const patients = state.patients || [];

  const f = state.currentFilter;
  let filtered = f === 'all' ? [...patients] : patients.filter(p => p.status === f);

  const wards = {};
  filtered.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); });

  if (!filtered.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👥</div><div>No patients</div></div>';
    updateStats();
    return;
  }

  const order = ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned', 'Unassigned'];
  let html = '';
  Object.keys(wards).sort((a, b) => (order.indexOf(a) === -1 ? 99 : order.indexOf(a)) - (order.indexOf(b) === -1 ? 99 : order.indexOf(b))).forEach(ward => {
    const ps = wards[ward];
    html += `<div class="ward-section"><div class="ward-header"><div class="ward-title">📍 ${esc(ward)}</div><div class="ward-count">${ps.length}</div></div>`;
    ps.forEach(p => {
      html += `<div class="patient-card ${p.status}" onclick="openPatientProfile(${p.id})"><div class="patient-header"><div class="patient-avatar">${initials(p.name)}</div><div class="patient-info"><div class="patient-name">${esc(p.name)} ${p.status === 'new' ? '<span class="badge badge-emerald">NEW</span>' : ''} ${p.status === 'critical' ? '<span class="badge badge-rose">CRITICAL</span>' : ''}</div><div class="patient-meta"><span>🛏️ ${esc(p.room || '—')}</span><span>👨‍⚕️ ${esc(p.doctor || '—')}</span></div></div></div><div class="patient-diagnosis">${esc(p.diagnosis || 'Pending')}</div></div>`;
    });
    html += '</div>';
  });

  container.innerHTML = html;
  updateStats();
}

function updateStats() {
  const a = state.patients;
  $('statTotal').textContent = a.length;
  $('statNew').textContent = a.filter(p => p.status === 'new').length;
  $('statActive').textContent = a.filter(p => p.status === 'active').length;
  $('statCritical').textContent = a.filter(p => p.status === 'critical').length;
  $('statChronic').textContent = a.filter(p => p.status === 'chronic').length;
  $$('.stat-card').forEach(s => s.classList.toggle('active', s.dataset.filter === state.currentFilter));
}

function renderRef() {
  $('refGrid').innerHTML = CONFIG.REFS.map(r => `<div class="ref-card"><h4>${r.title}</h4><p>${r.content}</p></div>`).join('');
}

// CLINICAL SCORING SYSTEM

let currentScoreId = null;
let currentScoreValues = {};

const SCORE_CATEGORY_ICONS = {
  'Cardiac': '❤️',
  'Respiratory': '🫁',
  'Neurological': '🧠',
  'GI': '🫃',
  'Critical Care': '🏥',
  'Renal': '🫘',
  'Vascular': '🩸',
  'Surgical': '🔪'
};

function renderScoresGrid() {
  const categories = {};
  Object.entries(CONFIG.SCORING_CALCULATORS).forEach(([id, score]) => {
    const cat = score.category || 'Other';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push({ id, ...score });
  });

  let html = '';
  Object.entries(categories).forEach(([category, scores]) => {
    const icon = SCORE_CATEGORY_ICONS[category] || '📊';
    html += `
      <div class="emergency-score-group"><div class="emergency-score-group-header"><span class="emergency-score-group-icon">${icon}</span><span class="emergency-score-group-title">${category}</span></div><div class="emergency-score-group-body">
          ${scores.map(s => `
            <div class="emergency-score-item" onclick="openScoreCalculator('${s.id}')"><div class="emergency-score-item-info"><div class="emergency-score-item-name">${s.name}</div><div class="emergency-score-item-purpose">${s.purpose}</div></div><button class="emergency-score-item-btn">Calculate</button></div>
          `).join('')}
        </div></div>
    `;
  });

  $('scoresGrid').innerHTML = html;
}

window.filterScores = function(query) {
  const q = query.toLowerCase().trim();
  const groups = $$('.emergency-score-group');

  groups.forEach(group => {
    const items = group.querySelectorAll('.emergency-score-item');
    let visibleCount = 0;

    items.forEach(item => {
      const name = item.querySelector('.emergency-score-item-name').textContent.toLowerCase();
      const purpose = item.querySelector('.emergency-score-item-purpose').textContent.toLowerCase();
      const match = !q || name.includes(q) || purpose.includes(q);
      item.style.display = match ? 'flex' : 'none';
      if (match) visibleCount++;
    });

    group.style.display = visibleCount > 0 ? 'block' : 'none';
  });
};

window.openScoreCalculator = function(scoreId) {
  const score = CONFIG.SCORING_CALCULATORS[scoreId];
  if (!score) return;

  currentScoreId = scoreId;
  currentScoreValues = {};

  const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
  $('scoreCalcTitle').textContent = score.name;
  $('scoreCalcPurpose').textContent = score.purpose;
  $('scoreCalcCategory').innerHTML = `${icon} ${score.category}`;

  // Show save button only if patient is open
  $('saveScoreBtn').style.display = state.currentPatient ? 'block' : 'none';

  // Get patient lab data for auto-calculation
  const patientLabs = getPatientLabValues();
  const autoCalcData = getAutoCalcForScore(scoreId, patientLabs);

  // Render fields with improved design
  let fieldsHtml = '';

  // If we have auto-calculated result, show it first
  if (autoCalcData.hasAuto) {
    fieldsHtml += `
      <div class="score-auto-calc"><div class="score-auto-calc-header"><div class="score-auto-calc-title"><span>🤖 Auto-calculated from Labs</span><span class="score-auto-calc-badge">SMART</span></div><button class="score-manual-toggle" onclick="toggleManualMode()">Enter manually</button></div><div class="score-auto-calc-value">${autoCalcData.display}</div><div class="score-auto-calc-source">${autoCalcData.source}</div></div><div id="manualScoreFields" style="display:none">
    `;

    // Set the auto-calculated values
    Object.assign(currentScoreValues, autoCalcData.values);
  }

  let fieldIndex = 0;
  score.fields.forEach(field => {
    fieldIndex++;

    if (field.type === 'checkbox') {
      const pointsDisplay = field.points > 0 ? `+${field.points}` : field.points;
      fieldsHtml += `
        <div class="score-field" onclick="toggleScoreCheckbox('${field.id}', ${field.points || 1})"><div class="score-field-checkbox" id="check_${field.id}"></div><div class="score-field-label">${field.label}</div><div class="score-field-points">${pointsDisplay}</div></div>
      `;
      currentScoreValues[field.id] = currentScoreValues[field.id] || 0;
    } else if (field.type === 'select') {
      const preselectedValue = currentScoreValues[field.id] || '';
      fieldsHtml += `
        <div class="score-field" style="flex-direction:column;align-items:stretch;gap:8px"><div class="score-field-select"><label>${fieldIndex}. ${field.label}</label><select id="select_${field.id}" onchange="updateScoreSelect('${field.id}', this.value)"><option value="">Select an option...</option>
              ${field.options.map(o => `<option value="${o.value}" ${o.value == preselectedValue ? 'selected' : ''}>${o.label}</option>`).join('')}
            </select></div></div>
      `;
      currentScoreValues[field.id] = currentScoreValues[field.id] || 0;
    } else if (field.type === 'number') {
      const prefilledValue = currentScoreValues[field.id] || '';
      fieldsHtml += `
        <div class="score-field" style="flex-direction:column;align-items:stretch;gap:8px"><div class="score-field-number"><label>${field.label}</label><input type="number" id="num_${field.id}" min="${field.min || 0}" max="${field.max || 100}" step="${field.step || 1}" value="${prefilledValue}" placeholder="0" onchange="updateScoreNumber('${field.id}', this.value)" oninput="updateScoreNumber('${field.id}', this.value)"></div></div>
      `;
      if (currentScoreValues[field.id] === undefined) currentScoreValues[field.id] = null;
    }
  });

  if (autoCalcData.hasAuto) {
    fieldsHtml += '</div>';
  }

  $('scoreCalcFields').innerHTML = fieldsHtml;
  updateScoreResult();
  openModal('scoreCalcModal');
};

// Get patient's lab values in a normalized format
function getPatientLabValues() {
  if (!state.currentPatient?.labData?.parameters) return {};

  const labs = {};
  const params = state.currentPatient.labData.parameters;

  params.forEach(p => {
    const name = p.name.toLowerCase();
    const value = parseFloat(p.value);
    if (isNaN(value)) return;

    // Normalize common lab names
    if (name.includes('creatinine') || name.includes('creat')) labs.creatinine = value;
    if (name.includes('urea') || name === 'bun') labs.urea = value;
    if (name.includes('egfr')) labs.egfr = value;
    if (name.includes('bilirubin') && !name.includes('direct')) labs.bilirubin = value;
    if (name.includes('inr')) labs.inr = value;
    if (name.includes('albumin')) labs.albumin = value;
    if (name.includes('sodium') || name === 'na') labs.sodium = value;
    if (name.includes('potassium') || name === 'k') labs.potassium = value;
    if (name.includes('hemoglobin') || name === 'hgb' || name === 'hb') labs.hemoglobin = value;
    if (name.includes('platelet')) labs.platelets = value;
    if (name.includes('wbc') || name.includes('white')) labs.wbc = value;
    if (name.includes('lactate')) labs.lactate = value;
    if (name.includes('glucose') || name === 'gluc') labs.glucose = value;
  });

  return labs;
}

// Get auto-calculation data for specific scores
function getAutoCalcForScore(scoreId, labs) {
  const result = { hasAuto: false, display: '', source: '', values: {} };

  if (!state.currentPatient) return result;

  // KDIGO AKI - Auto-calculate from creatinine
  if (scoreId === 'KDIGO-AKI' && labs.creatinine) {
    const cr = labs.creatinine;
    const baseline = state.currentPatient.baselineCreatinine || 1.0; // Default baseline
    const ratio = cr / baseline;

    let stage = 1;
    if (cr >= 4.0 || ratio >= 3) stage = 3;
    else if (ratio >= 2) stage = 2;
    else if (cr >= baseline + 0.3 || ratio >= 1.5) stage = 1;
    else stage = 0;

    if (stage > 0) {
      result.hasAuto = true;
      result.display = `Stage ${stage}`;
      result.source = `Based on Cr: ${cr} mg/dL (baseline: ${baseline})`;
      result.values = { stage: stage };
    }
  }

  // MELD Score - Auto-calculate from labs
  if (scoreId === 'MELD' && labs.creatinine && labs.bilirubin && labs.inr) {
    result.hasAuto = true;
    result.values = {
      creatinine: labs.creatinine,
      bilirubin: labs.bilirubin,
      inr: labs.inr
    };

    const cr = Math.min(Math.max(labs.creatinine, 1), 4);
    const bili = Math.max(labs.bilirubin, 1);
    const inr = Math.max(labs.inr, 1);
    const meld = Math.round(10 * (0.957 * Math.log(cr) + 0.378 * Math.log(bili) + 1.12 * Math.log(inr) + 0.643));

    result.display = Math.min(Math.max(meld, 6), 40).toString();
    result.source = `Cr: ${labs.creatinine} | Bili: ${labs.bilirubin} | INR: ${labs.inr}`;
  }

  // Child-Pugh - Partial auto-fill
  if (scoreId === 'Child-Pugh') {
    if (labs.bilirubin || labs.albumin || labs.inr) {
      result.hasAuto = true;
      result.source = 'Partial data from labs';

      const parts = [];
      if (labs.bilirubin) {
        result.values.bilirubin = labs.bilirubin < 2 ? 1 : labs.bilirubin <= 3 ? 2 : 3;
        parts.push(`Bili: ${labs.bilirubin}`);
      }
      if (labs.albumin) {
        result.values.albumin = labs.albumin > 3.5 ? 1 : labs.albumin >= 2.8 ? 2 : 3;
        parts.push(`Alb: ${labs.albumin}`);
      }
      if (labs.inr) {
        result.values.inr = labs.inr < 1.7 ? 1 : labs.inr <= 2.3 ? 2 : 3;
        parts.push(`INR: ${labs.inr}`);
      }

      const total = (result.values.bilirubin || 0) + (result.values.albumin || 0) + (result.values.inr || 0);
      result.display = `${total}+ pts`;
      result.source = parts.join(' | ') + ' (complete manually)';
    }
  }

  // Glasgow-Blatchford - Auto-fill from labs
  if (scoreId === 'Glasgow-Blatchford') {
    if (labs.urea || labs.hemoglobin) {
      result.hasAuto = true;
      const parts = [];

      if (labs.urea) {
        // BUN scoring
        let bunScore = 0;
        if (labs.urea >= 25) bunScore = 6;
        else if (labs.urea >= 10) bunScore = 4;
        else if (labs.urea >= 8) bunScore = 3;
        else if (labs.urea >= 6.5) bunScore = 2;
        result.values.bun = bunScore;
        parts.push(`Urea: ${labs.urea}`);
      }

      if (labs.hemoglobin) {
        // Simplified - assuming male for now
        let hgbScore = 0;
        if (labs.hemoglobin < 10) hgbScore = 6;
        else if (labs.hemoglobin < 12) hgbScore = 3;
        else if (labs.hemoglobin < 13) hgbScore = 1;
        result.values.hgb_male = hgbScore;
        parts.push(`Hgb: ${labs.hemoglobin}`);
      }

      result.display = 'Partial';
      result.source = parts.join(' | ') + ' (add vitals)';
    }
  }

  return result;
}

window.toggleManualMode = function() {
  const manualFields = $('manualScoreFields');
  const autoCalc = document.querySelector('.score-auto-calc');

  if (manualFields.style.display === 'none') {
    manualFields.style.display = 'block';
    autoCalc.style.opacity = '0.5';
  } else {
    manualFields.style.display = 'none';
    autoCalc.style.opacity = '1';
  }
};

window.toggleScoreCheckbox = function(fieldId, points) {
  const checkbox = $('check_' + fieldId);
  const field = checkbox.closest('.score-field');

  if (checkbox.classList.contains('checked')) {
    checkbox.classList.remove('checked');
    field.classList.remove('checked');
    currentScoreValues[fieldId] = 0;
  } else {
    checkbox.classList.add('checked');
    field.classList.add('checked');
    currentScoreValues[fieldId] = points;
  }

  updateScoreResult();
};

window.updateScoreSelect = function(fieldId, value) {
  currentScoreValues[fieldId] = parseFloat(value) || 0;
  updateScoreResult();
};

window.updateScoreNumber = function(fieldId, value) {
  currentScoreValues[fieldId] = parseFloat(value) || null;
  updateScoreResult();
};

function updateScoreResult() {
  const score = CONFIG.SCORING_CALCULATORS[currentScoreId];
  if (!score) return;

  // Calculate total
  let total = 0;
  let maxScore = 0;

  score.fields.forEach(field => {
    const val = currentScoreValues[field.id];
    if (field.type === 'checkbox') {
      total += val || 0;
      maxScore += Math.abs(field.points) || 1;
    } else if (field.type === 'select' && field.options) {
      total += val || 0;
      maxScore += Math.max(...field.options.map(o => Math.abs(o.value)));
    }
  });

  // Special handling for MELD score calculation
  if (currentScoreId === 'MELD') {
    const cr = currentScoreValues.creatinine || 1;
    const bili = currentScoreValues.bilirubin || 1;
    const inr = currentScoreValues.inr || 1;
    const dialysis = currentScoreValues.dialysis || 0;

    const crVal = Math.min(Math.max(dialysis ? 4 : cr, 1), 4);
    const biliVal = Math.max(bili, 1);
    const inrVal = Math.max(inr, 1);

    total = Math.round(10 * (0.957 * Math.log(crVal) + 0.378 * Math.log(biliVal) + 1.12 * Math.log(inrVal) + 0.643));
    total = Math.min(Math.max(total, 6), 40);
    maxScore = 40;
  }

  $('scoreResultValue').textContent = total;
  $('scoreResultMax').textContent = maxScore > 0 ? `of ${maxScore}` : '';

  // Find interpretation
  const interp = score.interpretation.find(i => total >= i.min && total <= i.max) || score.interpretation[score.interpretation.length - 1];

  if (interp) {
    const interpEl = $('scoreResultInterpretation');

    // Create gradient based on risk color
    const baseColor = interp.color;
    interpEl.style.background = `linear-gradient(135deg, ${baseColor}22 0%, ${baseColor}11 100%)`;
    interpEl.style.border = `1px solid ${baseColor}40`;
    interpEl.style.color = '#f1f5f9';

    let statsHtml = '';
    Object.entries(interp).forEach(([key, val]) => {
      if (!['min', 'max', 'risk', 'action', 'color'].includes(key)) {
        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        statsHtml += `
          <div class="score-result-stat"><div class="score-result-stat-value" style="color:${baseColor}">${val}</div><div class="score-result-stat-label">${label}</div></div>
        `;
      }
    });

    interpEl.innerHTML = `
      <div class="score-result-risk" style="color:${baseColor}">${interp.risk}</div><div class="score-result-action">${interp.action}</div>
      ${statsHtml ? `<div class="score-result-stats">${statsHtml}</div>` : ''}
    `;
  }
}

window.savePatientScore = function() {
  if (!state.currentPatient || !currentScoreId) return;

  const score = CONFIG.SCORING_CALCULATORS[currentScoreId];
  if (!score) return;

  // Calculate total
  let total = 0;
  score.fields.forEach(field => {
    const val = currentScoreValues[field.id];
    if (field.type === 'checkbox' || field.type === 'select') {
      total += val || 0;
    }
  });

  // Handle MELD special calculation
  if (currentScoreId === 'MELD') {
    const cr = currentScoreValues.creatinine || 1;
    const bili = currentScoreValues.bilirubin || 1;
    const inr = currentScoreValues.inr || 1;
    const dialysis = currentScoreValues.dialysis || 0;
    const crVal = Math.min(Math.max(dialysis ? 4 : cr, 1), 4);
    total = Math.round(10 * (0.957 * Math.log(crVal) + 0.378 * Math.log(Math.max(bili, 1)) + 1.12 * Math.log(Math.max(inr, 1)) + 0.643));
    total = Math.min(Math.max(total, 6), 40);
  }

  const interp = score.interpretation.find(i => total >= i.min && total <= i.max) || score.interpretation[score.interpretation.length - 1];

  // Initialize scores array if needed
  if (!state.currentPatient.scores) state.currentPatient.scores = [];

  // Add or update score
  const existingIdx = state.currentPatient.scores.findIndex(s => s.id === currentScoreId);
  const scoreEntry = {
    id: currentScoreId,
    name: score.name,
    value: total,
    risk: interp?.risk || 'Unknown',
    color: interp?.color || '#6b7280',
    date: new Date().toISOString(),
    values: { ...currentScoreValues }
  };

  if (existingIdx >= 0) {
    state.currentPatient.scores[existingIdx] = scoreEntry;
  } else {
    state.currentPatient.scores.push(scoreEntry);
  }

  saveCloud();
  closeModal('scoreCalcModal');
  toast(`${score.name}: ${total} saved!`);

  if ($('profileScores')) renderProfileScores();
};

function getRelevantScoresForPatient(patient) {
  if (!patient?.diagnosis) return [];

  const dx = patient.diagnosis.toLowerCase();
  const relevantScores = new Set();

  // Check each diagnosis keyword
  Object.entries(CONFIG.PATIENT_SCORES).forEach(([keyword, scores]) => {
    if (dx.includes(keyword.toLowerCase())) {
      scores.forEach(s => relevantScores.add(s));
    }
  });

  // Always include some universal scores
  if (patient.status === 'critical') {
    ['qSOFA', 'SOFA', 'NEWS2', 'Glasgow-Coma'].forEach(s => relevantScores.add(s));
  }

  return Array.from(relevantScores).filter(s => CONFIG.SCORING_CALCULATORS[s]);
}

function renderProfileScores() {
  const p = state.currentPatient;
  if (!p) return;

  const relevantScores = getRelevantScoresForPatient(p);
  const savedScores = p.scores || [];

  let html = `
    <div class="section-card"><div class="section-header"><div class="section-title">📊 Clinical Scores</div></div><div class="section-body">
  `;

  // Relevant scores based on diagnosis
  if (relevantScores.length > 0) {
    html += `
      <div class="patient-scores-section"><div class="patient-scores-header"><div class="patient-scores-title">Recommended for this patient</div></div><div class="patient-scores-grid">
    `;

    relevantScores.forEach(scoreId => {
      const score = CONFIG.SCORING_CALCULATORS[scoreId];
      const saved = savedScores.find(s => s.id === scoreId);
      const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';

      let valueClass = '';
      if (saved) {
        const interp = score.interpretation.find(i => saved.value >= i.min && saved.value <= i.max);
        if (interp) {
          if (interp.color === '#10b981' || interp.color === '#22c55e') valueClass = 'low';
          else if (interp.color === '#f59e0b') valueClass = 'moderate';
          else valueClass = 'high';
        }
      }

      html += `
        <div class="patient-score-chip ${saved ? 'has-value' : ''}" onclick="openScoreCalculator('${scoreId}')"><span class="score-chip-icon">${icon}</span><span class="score-chip-name">${score.name.replace(' Score', '').replace(' Classification', '')}</span>
          ${saved ? `<span class="score-chip-value ${valueClass}">${saved.value}</span>` : ''}
        </div>
      `;
    });

    html += '</div></div>';
  }

  // Saved scores history
  if (savedScores.length > 0) {
    html += `
      <div class="patient-scores-section" style="margin-top:24px"><div class="patient-scores-header"><div class="patient-scores-title">Calculated Scores</div></div><div style="display:flex;flex-direction:column;gap:8px">
    `;

    savedScores.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(saved => {
      html += `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg);border-radius:var(--radius-sm);border-left:3px solid ${saved.color}"><div><div style="font-weight:600;font-size:0.9rem">${saved.name}</div><div style="font-size:0.75rem;color:var(--text-muted)">${formatDateTime(saved.date)}</div></div><div style="text-align:right"><div style="font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700;color:${saved.color}">${saved.value}</div><div style="font-size:0.7rem;color:${saved.color}">${saved.risk}</div></div></div>
      `;
    });

    html += '</div></div>';
  }

  // Quick access to all scores
  html += `
    <div class="patient-scores-section" style="margin-top:24px"><div class="patient-scores-header"><div class="patient-scores-title">All Available Scores</div></div><div class="patient-scores-grid">
  `;

  Object.entries(CONFIG.SCORING_CALCULATORS).slice(0, 12).forEach(([id, score]) => {
    const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
    const saved = savedScores.find(s => s.id === id);

    html += `
      <div class="patient-score-chip ${saved ? 'has-value' : ''}" onclick="openScoreCalculator('${id}')"><span class="score-chip-icon">${icon}</span><span class="score-chip-name">${score.name.replace(' Score', '').replace(' Classification', '').substring(0, 15)}</span></div>
    `;
  });

  html += `
        </div><button class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%" onclick="showTab('scores')">View All Scores →</button></div></div></div>`;

  $('profileScores').innerHTML = html;
}

// PATIENT PROFILE

window.openPatientProfile = function(id) {
  console.log('Opening patient profile for ID:', id);
  const p = getPatient(id);
  if (!p) { console.error('Patient not found:', id); return; }
  console.log('Found patient:', p.name);
  state.currentPatient = p;
  state.currentInteractionId = null;
  if (!p.labData) p.labData = { dates: [], parameters: [], interpretation: null };
  if (!p.imaging) p.imaging = [];
  if (!p.fluids) p.fluids = [];
  if (!p.plans) p.plans = [];
  if (!p.vitals) p.vitals = {};
  if (!p.history) p.history = '';
  if (!p.scores) p.scores = [];
  renderPatientProfile();
  showPage('patientProfile');
  console.log('Patient profile shown');
};

window.closePatientProfile = function() {
  state.currentPatient = null;
  state.currentInteractionId = null;
  if (state.trendChart) { state.trendChart.destroy(); state.trendChart = null; }
  if (state.fluidChart) { state.fluidChart.destroy(); state.fluidChart = null; }
  showPage('dashboard');
  renderPatients();
};

function renderPatientProfile() {
  try {
  const p = state.currentPatient;
  console.log('renderPatientProfile called, patient:', p);

  // Show debug info immediately
  const infoEl = $('profilePatientInfo');
  if (!infoEl) { console.error('profilePatientInfo element not found!'); return; }

  if (!p) {
    console.error('No current patient');
    infoEl.innerHTML = '<div style="color:red;padding:20px">DEBUG: No patient data</div>';
    return;
  }

  const avatarBg = p.status === 'critical' ? 'var(--rose),var(--orange)' :
                   p.status === 'chronic' ? 'var(--purple),#a855f7' :
                   p.status === 'discharged' ? 'var(--text-muted),#4b5563' :
                   p.status === 'new' ? 'var(--emerald),var(--teal)' : 'var(--gold),var(--orange)';

  // Update discharge button visibility
  const dischargeBtn = $('profileDischargeBtn');
  if (dischargeBtn) dischargeBtn.style.display = p.status === 'discharged' ? 'none' : '';

  infoEl.innerHTML = `
    <div class="profile-avatar" style="background:linear-gradient(135deg,${avatarBg})">${initials(p.name)}</div><div class="profile-details"><h2>${esc(p.name)}</h2><div class="meta"><span>🛏️ ${esc(p.ward)} • ${esc(p.room || '—')}</span><span>👨‍⚕️ ${esc(p.doctor || 'Unassigned')}</span><span class="badge badge-${p.status === 'critical' ? 'rose' : p.status === 'chronic' ? 'purple' : p.status === 'discharged' ? 'secondary' : p.status === 'new' ? 'emerald' : 'teal'}">${p.status}</span>
        ${p.dischargeDate ? `<span style="font-size:0.75rem;color:var(--text-muted)">📅 Discharged ${formatShortDate(p.dischargeDate)}</span>` : ''}
      </div></div>
  `;
  console.log('Patient info rendered');

  renderProfileOverview();
  console.log('Overview rendered');
  renderProfileMeds();
  console.log('Meds rendered');
  renderProfileHistory();
  renderProfileScores();
  renderProfileLabs();
  renderProfileImaging();
  renderProfileFluids();
  renderProfilePlans();
  updateProfileBadges();
  console.log('All profile sections rendered');
  } catch(e) {
    console.error('renderPatientProfile error:', e);
    $('profilePatientInfo').innerHTML = '<div style="color:red;padding:20px">ERROR: ' + e.message + '</div>';
  }
}

// MEDICATIONS MODULE - Pristine Pharmaceutical Design

function renderProfileMeds() {
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];

  const activeMeds = p.medications.filter(m => m.status !== 'discontinued');
  const discontinuedMeds = p.medications.filter(m => m.status === 'discontinued');

  let html = `
    <div class="meds-container"><div class="meds-upload-card"><div class="meds-upload-header"><div class="meds-upload-title"><span>📷</span> Smart Medication Import
          </div><div class="meds-upload-subtitle">AI-powered extraction from medication lists, prescriptions & MAR sheets</div></div><div class="meds-upload-body"><div class="meds-upload-zone ${state.isAnalyzingMeds ? 'analyzing' : ''}" onclick="triggerMedsUpload()">
            ${state.isAnalyzingMeds ? `
              <div class="meds-upload-icon">⏳</div><div class="meds-upload-text">Analyzing medications...</div><div class="meds-upload-hint">Extracting drug names, doses & indications</div>
            ` : `
              <div class="meds-upload-icon">💊</div><div class="meds-upload-text">Tap to upload medication list</div><div class="meds-upload-hint">Supports handwritten & printed formats</div>
            `}
          </div></div></div><div class="meds-quick-actions"><button class="meds-quick-btn" onclick="showAddMedForm()">+ Add Manually</button><button class="meds-quick-btn" onclick="reconcileMeds()">⚖️ Reconcile</button></div>
  `;

  // Active Medications
  if (activeMeds.length > 0) {
    html += `
      <div class="meds-list-header"><div class="meds-list-title">Active Medications</div><div class="meds-count">${activeMeds.length} active</div></div>
    `;

    activeMeds.forEach((med, idx) => {
      const realIdx = p.medications.indexOf(med);
      html += renderMedCard(med, realIdx);
    });
  }

  // Discontinued
  if (discontinuedMeds.length > 0) {
    html += `
      <div class="meds-list-header" style="margin-top:20px"><div class="meds-list-title">Discontinued</div><div class="meds-count" style="background:rgba(248,81,73,0.1);color:#f85149">${discontinuedMeds.length}</div></div>
    `;

    discontinuedMeds.forEach((med, idx) => {
      const realIdx = p.medications.indexOf(med);
      html += renderMedCard(med, realIdx);
    });
  }

  // Empty State
  if (p.medications.length === 0) {
    html += `
      <div class="meds-empty"><div class="meds-empty-icon">💊</div><div class="meds-empty-title">No medications recorded</div><div class="meds-empty-hint">Upload a photo or add manually</div></div>
    `;
  }

  html += `
      
      <div class="med-add-form" id="medAddForm" style="display:none"><div class="med-form-header"><div class="med-form-title">💊 Add Medication</div><button class="med-form-close" onclick="hideAddMedForm()">✕</button></div><div class="med-form-section"><div class="med-form-section-title">Drug Information</div><div class="med-ai-suggestions" id="medAiSuggestions"><div class="med-ai-header"><div class="med-ai-icon">🧠</div><div class="med-ai-title"><span>Neural Suggestions</span><span class="med-ai-badge">AI-Powered</span></div><div class="med-ai-hint">Based on diagnosis & similar patients</div></div><div class="med-ai-chips" id="medSuggestionChips"><div class="med-ai-loading"><span class="med-ai-pulse"></span>
                Analyzing patient profile...
              </div></div></div><div class="med-form-group med-form-full"><label class="med-form-label">Drug Name <span class="required">*</span></label><input type="text" class="med-form-input" id="medName" placeholder="e.g., Metformin" oninput="filterMedSuggestions(this.value)"></div><div class="med-form-row"><div class="med-form-group"><label class="med-form-label">Generic Name</label><input type="text" class="med-form-input" id="medGeneric" placeholder="Optional"></div><div class="med-form-group"><label class="med-form-label">Dose <span class="required">*</span></label><input type="text" class="med-form-input" id="medDose" placeholder="e.g., 500mg"></div></div></div><div class="med-form-section"><div class="med-form-section-title">Administration</div><div class="med-form-group"><label class="med-form-label">Route</label><div class="med-route-chips" id="medRouteChips"><button type="button" class="med-route-chip selected" data-value="PO">PO</button><button type="button" class="med-route-chip" data-value="IV">IV</button><button type="button" class="med-route-chip" data-value="IM">IM</button><button type="button" class="med-route-chip" data-value="SC">SC</button><button type="button" class="med-route-chip" data-value="INH">INH</button><button type="button" class="med-route-chip" data-value="TOP">TOP</button><button type="button" class="med-route-chip" data-value="SL">SL</button><button type="button" class="med-route-chip" data-value="PR">PR</button></div><input type="hidden" id="medRoute" value="PO"></div><div class="med-form-group"><label class="med-form-label">Frequency <span class="required">*</span></label><div class="med-freq-chips" id="medFreqChips"><button type="button" class="med-freq-chip selected" data-value="OD">OD</button><button type="button" class="med-freq-chip" data-value="BD">BD</button><button type="button" class="med-freq-chip" data-value="TDS">TDS</button><button type="button" class="med-freq-chip" data-value="QID">QID</button><button type="button" class="med-freq-chip" data-value="Q4H">Q4H</button><button type="button" class="med-freq-chip" data-value="Q6H">Q6H</button><button type="button" class="med-freq-chip" data-value="Q8H">Q8H</button><button type="button" class="med-freq-chip" data-value="PRN">PRN</button></div><input type="hidden" id="medFreq" value="OD"></div></div><div class="med-form-section"><div class="med-form-section-title">Clinical Details</div><div class="med-form-group med-form-full"><label class="med-form-label">Indication</label><input type="text" class="med-form-input" id="medIndication" placeholder="e.g., Type 2 Diabetes Mellitus"></div><div class="med-form-group"><label class="med-form-label">Status</label><div class="med-status-options" id="medStatusOptions"><button type="button" class="med-status-option selected" data-value="active"><span class="status-dot active"></span> Active
              </button><button type="button" class="med-status-option" data-value="new"><span class="status-dot new"></span> New
              </button><button type="button" class="med-status-option" data-value="prn"><span class="status-dot prn"></span> PRN
              </button><button type="button" class="med-status-option" data-value="discontinued"><span class="status-dot discontinued"></span> Stopped
              </button></div><input type="hidden" id="medStatus" value="active"></div></div><div class="med-form-actions"><button class="btn btn-secondary med-form-btn" onclick="hideAddMedForm()">Cancel</button><button class="btn btn-primary med-form-btn" onclick="saveMedication()"><span>💾</span> Save Medication
          </button></div></div></div>
  `;

  $('profileMeds').innerHTML = html;
}

function renderMedCard(med, idx) {
  const statusClass = med.status || 'active';
  const statusLabels = { active: 'Active', new: 'New', prn: 'PRN', discontinued: 'Stopped' };
  const drugNameEsc = esc(med.name).replace(/'/g, "\\'");

  return `
    <div class="med-card"><div class="med-card-header"><div class="med-card-main"><div class="med-card-name">
            ${esc(med.name)}
            <span class="med-status ${statusClass}">${statusLabels[statusClass] || statusClass}</span></div>
          ${med.generic ? `<div class="med-card-generic">${esc(med.generic)}</div>` : ''}
        </div><div class="med-card-actions"><button class="med-card-action info" onclick="openDrugInfo('${drugNameEsc}', ${idx})" title="Drug Info">📚</button><button class="med-card-action" onclick="editMedication(${idx})" title="Edit">✏️</button><button class="med-card-action delete" onclick="deleteMedication(${idx})" title="Delete">🗑️</button></div></div><div class="med-card-dose"><span class="med-dose-pill amount">💊 ${esc(med.dose || '—')}</span><span class="med-dose-pill route">📍 ${esc(med.route || 'PO')}</span><span class="med-dose-pill frequency">🕐 ${esc(med.frequency || 'OD')}</span></div>
      ${med.indication ? `
        <div class="med-card-indication"><div class="med-indication-label">Indication</div><div class="med-indication-text">${esc(med.indication)}</div></div>
      ` : ''}
      <button class="med-learn-more" onclick="openDrugInfo('${drugNameEsc}', ${idx})"><span class="sparkle">✨</span>
        Learn More – AI-Powered Drug Info
      </button></div>
  `;
}

window.triggerMedsUpload = function() {
  if (state.isAnalyzingMeds) return;
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => handleMedsUpload(e.target.files[0]);
  input.click();
};

async function handleMedsUpload(file) {
  if (!file) return;

  state.isAnalyzingMeds = true;
  renderProfileMeds();

  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'extractMedications',
          image: imageData,
          patientDiagnosis: state.currentPatient.diagnosis || ''
        })
      });
      const data = await res.json();

      state.isAnalyzingMeds = false;

      if (data.medications && Array.isArray(data.medications)) {
        const p = state.currentPatient;
        if (!p.medications) p.medications = [];

        // Add extracted medications
        data.medications.forEach(med => {
          p.medications.push({
            name: med.name || med.drug || 'Unknown',
            dose: med.dose || med.dosage || '',
            route: med.route || 'PO',
            frequency: med.frequency || med.schedule || 'OD',
            indication: med.indication || med.reason || '',
            generic: med.generic || '',
            status: 'new',
            addedDate: new Date().toISOString()
          });
        });

        saveCloud();
        renderProfileMeds();
        toast(`${data.medications.length} medication(s) imported`);
      } else {
        toast('No medications found in image', true);
        renderProfileMeds();
      }
    } catch (e) {
      state.isAnalyzingMeds = false;
      toast('Failed to analyze medications', true);
      renderProfileMeds();
    }
  });
}

window.showAddMedForm = function() {
  state.editingMedIdx = null;

  // Show inline form
  const form = $('medAddForm');
  if (form) {
    form.style.display = 'block';

    // Reset values
    $('medName').value = '';
    $('medDose').value = '';
    $('medGeneric').value = '';
    $('medIndication').value = '';
    $('medRoute').value = 'PO';
    $('medFreq').value = 'OD';
    $('medStatus').value = 'active';

    // Reset chip selections
    document.querySelectorAll('#medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector('#medRouteChips .med-route-chip[data-value="PO"]')?.classList.add('selected');

    document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector('#medFreqChips .med-freq-chip[data-value="OD"]')?.classList.add('selected');

    document.querySelectorAll('#medStatusOptions .med-status-option').forEach(c => c.classList.remove('selected'));
    document.querySelector('#medStatusOptions .med-status-option[data-value="active"]')?.classList.add('selected');

    // Initialize chip handlers
    initMedFormChipHandlers();

    // Render AI suggestions
    renderMedSuggestions();

    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

function initMedFormChipHandlers() {
  // Route chips
  document.querySelectorAll('#medRouteChips .med-route-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      $('medRoute').value = this.dataset.value;
    };
  });

  // Frequency chips
  document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      $('medFreq').value = this.dataset.value;
    };
  });

  // Status options
  document.querySelectorAll('#medStatusOptions .med-status-option').forEach(option => {
    option.onclick = function() {
      document.querySelectorAll('#medStatusOptions .med-status-option').forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      $('medStatus').value = this.dataset.value;
    };
  });
}

// Keep old modal handler for backward compatibility
function initMedPillHandlers() {
  // Route pills
  document.querySelectorAll('#routePills .med-pill').forEach(pill => {
    pill.onclick = function() {
      document.querySelectorAll('#routePills .med-pill').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
    };
  });

  // Frequency pills
  document.querySelectorAll('#freqPills .med-freq-pill').forEach(pill => {
    pill.onclick = function() {
      document.querySelectorAll('#freqPills .med-freq-pill').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
    };
  });

  // Status pills
  document.querySelectorAll('#statusPills .med-status-pill').forEach(pill => {
    pill.onclick = function() {
      document.querySelectorAll('#statusPills .med-status-pill').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
    };
  });
}

window.hideAddMedForm = function() {
  const form = $('medAddForm');
  if (form) form.style.display = 'none';
};

window.saveMedication = function() {
  const name = $('medName')?.value?.trim();
  const dose = $('medDose')?.value?.trim();

  if (!name || !dose) {
    toast('Please enter drug name and dose', 'error');
    return;
  }

  const route = $('medRoute')?.value || 'PO';
  const frequency = $('medFreq')?.value || 'OD';
  const status = $('medStatus')?.value || 'active';

  const med = {
    name: name,
    dose: dose,
    route: route,
    frequency: frequency,
    indication: $('medIndication')?.value?.trim() || '',
    generic: $('medGeneric')?.value?.trim() || '',
    status: status,
    addedDate: new Date().toISOString()
  };

  const p = state.currentPatient;
  if (!p.medications) p.medications = [];

  if (state.editingMedIdx !== null) {
    // Edit existing
    p.medications[state.editingMedIdx] = { ...p.medications[state.editingMedIdx], ...med };
    toast('Medication updated');
  } else {
    // Add new
    p.medications.push(med);
    toast('Medication added');
  }

  saveCloud();
  hideAddMedForm();
  renderProfileMeds();
};

window.saveMedicationNew = function() {
  const name = $('medNameNew').value.trim();
  const dose = $('medDoseNew').value.trim();

  if (!name || !dose) {
    toast('Please enter drug name and dose', 'error');
    return;
  }

  const route = document.querySelector('#routePills .med-pill.selected')?.dataset.route || 'PO';
  const frequency = document.querySelector('#freqPills .med-freq-pill.selected')?.dataset.freq || 'OD';
  const status = document.querySelector('#statusPills .med-status-pill.selected')?.dataset.status || 'active';

  const med = {
    name: name,
    dose: dose,
    route: route,
    frequency: frequency,
    indication: $('medIndicationNew').value.trim(),
    generic: $('medGenericNew').value.trim(),
    status: status,
    addedDate: new Date().toISOString()
  };

  const p = state.currentPatient;
  if (!p.medications) p.medications = [];

  if (state.editingMedIdx !== null && state.editingMedIdx !== undefined) {
    p.medications[state.editingMedIdx] = { ...p.medications[state.editingMedIdx], ...med };
    toast('Medication updated');
  } else {
    p.medications.push(med);
    toast('Medication added');
  }

  state.editingMedIdx = null;
  saveCloud();
  closeModal('addMedModal');
  renderProfileMeds();
};

window.editMedication = function(idx) {
  const med = state.currentPatient.medications[idx];
  if (!med) return;

  state.editingMedIdx = idx;

  // Show inline form
  const form = $('medAddForm');
  if (form) {
    form.style.display = 'block';

    // Set values
    $('medName').value = med.name || '';
    $('medDose').value = med.dose || '';
    $('medGeneric').value = med.generic || '';
    $('medIndication').value = med.indication || '';
    $('medRoute').value = med.route || 'PO';
    $('medFreq').value = med.frequency || 'OD';
    $('medStatus').value = med.status || 'active';

    // Set route chip
    document.querySelectorAll('#medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector(`#medRouteChips .med-route-chip[data-value="${med.route || 'PO'}"]`)?.classList.add('selected');

    // Set frequency chip
    document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector(`#medFreqChips .med-freq-chip[data-value="${med.frequency || 'OD'}"]`)?.classList.add('selected');

    // Set status option
    document.querySelectorAll('#medStatusOptions .med-status-option').forEach(c => c.classList.remove('selected'));
    document.querySelector(`#medStatusOptions .med-status-option[data-value="${med.status || 'active'}"]`)?.classList.add('selected');

    // Initialize chip handlers
    initMedFormChipHandlers();

    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

window.deleteMedication = function(idx) {
  if (!confirm('Delete this medication?')) return;
  state.currentPatient.medications.splice(idx, 1);
  saveCloud();
  renderProfileMeds();
  toast('Medication deleted');
};

window.reconcileMeds = function() {
  toast('Medication reconciliation - Coming soon');
};

// NEURAL MEDICATION LEARNING SYSTEM

const MedLearning = {
  // Knowledge base of condition-medication associations
  knowledgeBase: {
    // Diabetes
    'diabetes': [
      { name: 'Metformin', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Type 2 Diabetes', weight: 10 },
      { name: 'Gliclazide', dose: '80mg', route: 'PO', frequency: 'OD', indication: 'Type 2 Diabetes', weight: 8 },
      { name: 'Insulin Glargine', dose: '10 units', route: 'SC', frequency: 'OD', indication: 'Diabetes', weight: 7 },
      { name: 'Sitagliptin', dose: '100mg', route: 'PO', frequency: 'OD', indication: 'Type 2 Diabetes', weight: 6 },
      { name: 'Empagliflozin', dose: '10mg', route: 'PO', frequency: 'OD', indication: 'Type 2 Diabetes', weight: 6 }
    ],
    'dm': [
      { name: 'Metformin', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Type 2 Diabetes', weight: 10 }
    ],
    // Hypertension
    'hypertension': [
      { name: 'Amlodipine', dose: '5mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 10 },
      { name: 'Lisinopril', dose: '10mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 9 },
      { name: 'Losartan', dose: '50mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 8 },
      { name: 'Hydrochlorothiazide', dose: '25mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 7 },
      { name: 'Atenolol', dose: '50mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 6 }
    ],
    'htn': [
      { name: 'Amlodipine', dose: '5mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 10 }
    ],
    // Heart Failure
    'heart failure': [
      { name: 'Furosemide', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 10 },
      { name: 'Spironolactone', dose: '25mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 9 },
      { name: 'Carvedilol', dose: '6.25mg', route: 'PO', frequency: 'BD', indication: 'Heart Failure', weight: 8 },
      { name: 'Ramipril', dose: '2.5mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 8 },
      { name: 'Sacubitril/Valsartan', dose: '49/51mg', route: 'PO', frequency: 'BD', indication: 'Heart Failure', weight: 7 }
    ],
    'chf': [
      { name: 'Furosemide', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 10 }
    ],
    // Infection/Pneumonia
    'pneumonia': [
      { name: 'Amoxicillin/Clavulanate', dose: '625mg', route: 'PO', frequency: 'TDS', indication: 'Pneumonia', weight: 10 },
      { name: 'Azithromycin', dose: '500mg', route: 'PO', frequency: 'OD', indication: 'Pneumonia', weight: 9 },
      { name: 'Ceftriaxone', dose: '1g', route: 'IV', frequency: 'OD', indication: 'Pneumonia', weight: 8 },
      { name: 'Levofloxacin', dose: '750mg', route: 'PO', frequency: 'OD', indication: 'Pneumonia', weight: 7 }
    ],
    'infection': [
      { name: 'Amoxicillin/Clavulanate', dose: '625mg', route: 'PO', frequency: 'TDS', indication: 'Infection', weight: 9 },
      { name: 'Ciprofloxacin', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Infection', weight: 8 }
    ],
    'sepsis': [
      { name: 'Piperacillin/Tazobactam', dose: '4.5g', route: 'IV', frequency: 'Q6H', indication: 'Sepsis', weight: 10 },
      { name: 'Vancomycin', dose: '1g', route: 'IV', frequency: 'Q12H', indication: 'Sepsis', weight: 9 },
      { name: 'Meropenem', dose: '1g', route: 'IV', frequency: 'Q8H', indication: 'Sepsis', weight: 8 }
    ],
    // ACS/MI
    'acs': [
      { name: 'Aspirin', dose: '81mg', route: 'PO', frequency: 'OD', indication: 'ACS', weight: 10 },
      { name: 'Clopidogrel', dose: '75mg', route: 'PO', frequency: 'OD', indication: 'ACS', weight: 10 },
      { name: 'Atorvastatin', dose: '80mg', route: 'PO', frequency: 'OD', indication: 'ACS', weight: 9 },
      { name: 'Enoxaparin', dose: '1mg/kg', route: 'SC', frequency: 'BD', indication: 'ACS', weight: 8 },
      { name: 'Metoprolol', dose: '25mg', route: 'PO', frequency: 'BD', indication: 'ACS', weight: 7 }
    ],
    'mi': [
      { name: 'Aspirin', dose: '81mg', route: 'PO', frequency: 'OD', indication: 'MI', weight: 10 },
      { name: 'Clopidogrel', dose: '75mg', route: 'PO', frequency: 'OD', indication: 'MI', weight: 10 }
    ],
    // COPD/Asthma
    'copd': [
      { name: 'Salbutamol', dose: '100mcg', route: 'INH', frequency: 'PRN', indication: 'COPD', weight: 10 },
      { name: 'Tiotropium', dose: '18mcg', route: 'INH', frequency: 'OD', indication: 'COPD', weight: 9 },
      { name: 'Budesonide/Formoterol', dose: '160/4.5mcg', route: 'INH', frequency: 'BD', indication: 'COPD', weight: 8 },
      { name: 'Prednisolone', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'COPD Exacerbation', weight: 7 }
    ],
    'asthma': [
      { name: 'Salbutamol', dose: '100mcg', route: 'INH', frequency: 'PRN', indication: 'Asthma', weight: 10 },
      { name: 'Fluticasone/Salmeterol', dose: '250/50mcg', route: 'INH', frequency: 'BD', indication: 'Asthma', weight: 9 }
    ],
    // CKD
    'ckd': [
      { name: 'Calcium Carbonate', dose: '500mg', route: 'PO', frequency: 'TDS', indication: 'CKD', weight: 8 },
      { name: 'Sodium Bicarbonate', dose: '500mg', route: 'PO', frequency: 'TDS', indication: 'CKD', weight: 7 },
      { name: 'Erythropoietin', dose: '4000 units', route: 'SC', frequency: 'Weekly', indication: 'CKD Anemia', weight: 6 }
    ],
    'renal': [
      { name: 'Furosemide', dose: '40mg', route: 'IV', frequency: 'BD', indication: 'Renal', weight: 8 }
    ],
    // Pain
    'pain': [
      { name: 'Paracetamol', dose: '1g', route: 'PO', frequency: 'QID', indication: 'Pain', weight: 10 },
      { name: 'Ibuprofen', dose: '400mg', route: 'PO', frequency: 'TDS', indication: 'Pain', weight: 8 },
      { name: 'Tramadol', dose: '50mg', route: 'PO', frequency: 'Q6H', indication: 'Pain', weight: 7 },
      { name: 'Morphine', dose: '5mg', route: 'IV', frequency: 'Q4H', indication: 'Severe Pain', weight: 6 }
    ],
    // GI
    'gerd': [
      { name: 'Omeprazole', dose: '20mg', route: 'PO', frequency: 'OD', indication: 'GERD', weight: 10 },
      { name: 'Pantoprazole', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'GERD', weight: 9 }
    ],
    'nausea': [
      { name: 'Ondansetron', dose: '4mg', route: 'IV', frequency: 'Q8H', indication: 'Nausea', weight: 10 },
      { name: 'Metoclopramide', dose: '10mg', route: 'PO', frequency: 'TDS', indication: 'Nausea', weight: 8 }
    ],
    // DVT/PE
    'dvt': [
      { name: 'Enoxaparin', dose: '1mg/kg', route: 'SC', frequency: 'BD', indication: 'DVT', weight: 10 },
      { name: 'Rivaroxaban', dose: '15mg', route: 'PO', frequency: 'BD', indication: 'DVT', weight: 9 },
      { name: 'Warfarin', dose: '5mg', route: 'PO', frequency: 'OD', indication: 'DVT', weight: 8 }
    ],
    'pe': [
      { name: 'Enoxaparin', dose: '1mg/kg', route: 'SC', frequency: 'BD', indication: 'PE', weight: 10 },
      { name: 'Heparin', dose: '5000 units', route: 'IV', frequency: 'Infusion', indication: 'PE', weight: 9 }
    ],
    // Stroke
    'stroke': [
      { name: 'Aspirin', dose: '300mg', route: 'PO', frequency: 'OD', indication: 'Stroke', weight: 10 },
      { name: 'Atorvastatin', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'Stroke', weight: 9 },
      { name: 'Clopidogrel', dose: '75mg', route: 'PO', frequency: 'OD', indication: 'Stroke', weight: 8 }
    ],
    // Seizure
    'seizure': [
      { name: 'Levetiracetam', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Seizure', weight: 10 },
      { name: 'Phenytoin', dose: '100mg', route: 'PO', frequency: 'TDS', indication: 'Seizure', weight: 8 },
      { name: 'Valproate', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Seizure', weight: 7 }
    ],
    'epilepsy': [
      { name: 'Levetiracetam', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Epilepsy', weight: 10 }
    ]
  },

  // Lab-based suggestions
  labTriggers: {
    'potassium': {
      low: [{ name: 'Potassium Chloride', dose: '20mEq', route: 'PO', frequency: 'BD', indication: 'Hypokalemia', weight: 10 }],
      high: [{ name: 'Calcium Gluconate', dose: '1g', route: 'IV', frequency: 'STAT', indication: 'Hyperkalemia', weight: 10 },
             { name: 'Insulin Regular', dose: '10 units', route: 'IV', frequency: 'STAT', indication: 'Hyperkalemia', weight: 9 }]
    },
    'hemoglobin': {
      low: [{ name: 'Ferrous Sulfate', dose: '325mg', route: 'PO', frequency: 'TDS', indication: 'Anemia', weight: 9 },
            { name: 'Packed RBCs', dose: '1 unit', route: 'IV', frequency: 'STAT', indication: 'Severe Anemia', weight: 8 }]
    },
    'glucose': {
      high: [{ name: 'Insulin Regular', dose: 'Sliding Scale', route: 'SC', frequency: 'Q6H', indication: 'Hyperglycemia', weight: 10 }]
    },
    'creatinine': {
      high: [{ name: 'IV Normal Saline', dose: '1L', route: 'IV', frequency: 'Over 4hr', indication: 'AKI', weight: 9 }]
    },
    'inr': {
      high: [{ name: 'Vitamin K', dose: '10mg', route: 'IV', frequency: 'STAT', indication: 'Elevated INR', weight: 10 }]
    }
  },

  // Learn from existing patients in the system
  learnFromPatients: function() {
    const learned = {};
    const patients = state.patients || [];

    patients.forEach(p => {
      if (!p.diagnosis || !p.medications?.length) return;

      const dxLower = p.diagnosis.toLowerCase();
      p.medications.forEach(med => {
        if (!med.name) return;

        // Create a key from diagnosis keywords
        const keywords = dxLower.split(/[\s,\/]+/).filter(w => w.length > 2);
        keywords.forEach(keyword => {
          if (!learned[keyword]) learned[keyword] = [];

          // Check if already exists
          const existing = learned[keyword].find(m => m.name.toLowerCase() === med.name.toLowerCase());
          if (existing) {
            existing.weight += 2; // Increase weight for repeated use
            existing.count = (existing.count || 1) + 1;
          } else {
            learned[keyword].push({
              name: med.name,
              dose: med.dose,
              route: med.route,
              frequency: med.frequency,
              indication: med.indication || p.diagnosis,
              weight: 5,
              count: 1,
              learned: true
            });
          }
        });
      });
    });

    return learned;
  },

  // Get suggestions for current patient
  getSuggestions: function(patient) {
    if (!patient) return [];

    const suggestions = [];
    const addedMeds = new Set((patient.medications || []).map(m => m.name?.toLowerCase()));
    const diagnosis = (patient.diagnosis || '').toLowerCase();

    // 1. Match from knowledge base
    Object.entries(this.knowledgeBase).forEach(([condition, meds]) => {
      if (diagnosis.includes(condition)) {
        meds.forEach(med => {
          if (!addedMeds.has(med.name.toLowerCase())) {
            suggestions.push({
              ...med,
              source: 'knowledge',
              matchType: 'diagnosis',
              matchTerm: condition
            });
          }
        });
      }
    });

    // 2. Learn from similar patients
    const learned = this.learnFromPatients();
    const dxKeywords = diagnosis.split(/[\s,\/]+/).filter(w => w.length > 2);

    dxKeywords.forEach(keyword => {
      if (learned[keyword]) {
        learned[keyword].forEach(med => {
          if (!addedMeds.has(med.name.toLowerCase())) {
            const existing = suggestions.find(s => s.name.toLowerCase() === med.name.toLowerCase());
            if (existing) {
              existing.weight += med.weight;
              existing.patientCount = med.count;
            } else {
              suggestions.push({
                ...med,
                source: 'learned',
                matchType: 'similar_patients',
                patientCount: med.count
              });
            }
          }
        });
      }
    });

    // 3. Check lab values for triggers
    if (patient.labData?.parameters) {
      patient.labData.parameters.forEach(param => {
        const paramName = param.name?.toLowerCase();
        const latestValue = param.values?.[0];

        if (latestValue && this.labTriggers[paramName]) {
          const status = latestValue.status;
          let triggerMeds = [];

          if (status === 'critical' || status === 'high') {
            triggerMeds = this.labTriggers[paramName].high || [];
          } else if (status === 'low') {
            triggerMeds = this.labTriggers[paramName].low || [];
          }

          triggerMeds.forEach(med => {
            if (!addedMeds.has(med.name.toLowerCase())) {
              suggestions.push({
                ...med,
                source: 'lab',
                matchType: 'lab_value',
                labParam: param.name,
                labValue: latestValue.value,
                labStatus: status,
                weight: med.weight + (status === 'critical' ? 5 : 0)
              });
            }
          });
        }
      });
    }

    // Sort by weight and deduplicate
    const unique = [];
    const seen = new Set();

    suggestions
      .sort((a, b) => b.weight - a.weight)
      .forEach(s => {
        const key = s.name.toLowerCase();
        if (!seen.has(key)) {
          seen.add(key);
          unique.push(s);
        }
      });

    return unique.slice(0, 8); // Top 8 suggestions
  }
};

// Render suggestions in the form
function renderMedSuggestions() {
  const container = $('medSuggestionChips');
  if (!container) return;

  const patient = state.currentPatient;
  if (!patient) {
    container.innerHTML = '<div class="med-ai-empty"><div class="med-ai-empty-icon">🤖</div>No patient selected</div>';
    return;
  }

  const suggestions = MedLearning.getSuggestions(patient);

  if (suggestions.length === 0) {
    container.innerHTML = `
      <div class="med-ai-empty"><div class="med-ai-empty-icon">💊</div>
        No suggestions available for this diagnosis
      </div>
    `;
    return;
  }

  container.innerHTML = suggestions.map(s => {
    const isHighMatch = s.weight >= 9;
    const matchIcon = s.source === 'lab' ? '🔬' : s.source === 'learned' ? '📊' : '📋';
    const matchText = s.source === 'lab'
      ? `${s.labParam}: ${s.labValue} (${s.labStatus})`
      : s.source === 'learned'
      ? `Used in ${s.patientCount || 1} similar patient${s.patientCount > 1 ? 's' : ''}`
      : s.matchTerm;

    return `
      <button type="button" class="med-ai-chip ${isHighMatch ? 'high-match' : ''}"
              onclick="applyMedSuggestion(${JSON.stringify(s).replace(/"/g, '&quot;')})"><span class="med-ai-chip-icon">${matchIcon}</span><div class="med-ai-chip-info"><span class="med-ai-chip-name">${esc(s.name)}</span><span class="med-ai-chip-detail">${esc(s.dose)} ${esc(s.route)} ${esc(s.frequency)}</span></div>
        ${isHighMatch ? '<span class="med-ai-chip-match">Best</span>' : ''}
      </button>
    `;
  }).join('');
}

// Apply suggestion to form
window.applyMedSuggestion = function(suggestion) {
  $('medName').value = suggestion.name;
  $('medDose').value = suggestion.dose;
  $('medIndication').value = suggestion.indication || '';
  $('medRoute').value = suggestion.route;
  $('medFreq').value = suggestion.frequency;

  // Update route chips
  document.querySelectorAll('#medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
  document.querySelector(`#medRouteChips .med-route-chip[data-value="${suggestion.route}"]`)?.classList.add('selected');

  // Update frequency chips
  document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
  document.querySelector(`#medFreqChips .med-freq-chip[data-value="${suggestion.frequency}"]`)?.classList.add('selected');

  toast(`${suggestion.name} applied`);
};

// Filter suggestions as user types
window.filterMedSuggestions = function(query) {
  if (!query || query.length < 2) {
    renderMedSuggestions();
    return;
  }

  const container = $('medSuggestionChips');
  if (!container) return;

  const patient = state.currentPatient;
  const allSuggestions = MedLearning.getSuggestions(patient);
  const filtered = allSuggestions.filter(s =>
    s.name.toLowerCase().includes(query.toLowerCase())
  );

  if (filtered.length === 0) {
    container.innerHTML = `<div class="med-ai-empty">No matches for "${esc(query)}"</div>`;
    return;
  }

  container.innerHTML = filtered.map(s => {
    const isHighMatch = s.weight >= 9;
    return `
      <button type="button" class="med-ai-chip ${isHighMatch ? 'high-match' : ''}"
              onclick="applyMedSuggestion(${JSON.stringify(s).replace(/"/g, '&quot;')})"><span class="med-ai-chip-icon">💊</span><div class="med-ai-chip-info"><span class="med-ai-chip-name">${esc(s.name)}</span><span class="med-ai-chip-detail">${esc(s.dose)} ${esc(s.route)} ${esc(s.frequency)}</span></div></button>
    `;
  }).join('');
};

// AI-POWERED DRUG INFO - Neural Learning Module

const DrugKnowledgeBase = {
  drugs: {},
  getDrug: function(name) { return this.drugs[name?.toLowerCase()]; },
  searchDrugs: function(query) { return []; },
  getPatientWarnings: function(drugName, patient) { return []; },
  learnedInteractions: {},
  recordInteraction: function() {}
};

window.openDrugInfo = async function(drugName, medIdx) {
  const p = state.currentPatient;
  const med = medIdx !== undefined ? p.medications?.[medIdx] : null;

  $('drugInfoTitle').textContent = drugName;
  openModal('drugInfoModal');

  // INSTANT: Check local knowledge base first
  const localDrug = DrugKnowledgeBase.getDrug(drugName);
  const patientWarnings = DrugKnowledgeBase.getPatientWarnings(drugName, p);

  if (localDrug) {
    // Render immediately from local knowledge
    renderDrugInfoFromKnowledge(localDrug, drugName, patientWarnings, med);
    return;
  }

  // If not in local KB, show loading and try API
  $('drugInfoBody').innerHTML = `
    <div style="text-align:center;padding:40px"><div class="spinner"></div><p style="margin-top:16px;color:var(--text-muted)">Fetching ${esc(drugName)} information...</p></div>
  `;

  try {
    const patientContext = {
      diagnosis: p.diagnosis || '',
      medications: (p.medications || []).map(m => m.name).filter(n => n !== drugName),
      labData: p.labData?.parameters?.slice(0, 5).map(param => ({
        name: param.name,
        value: param.values?.[0]?.value,
        status: param.values?.[0]?.status
      })) || []
    };

    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'getDrugInfo',
        drugName: drugName,
        patientContext: patientContext,
        indication: med?.indication || ''
      })
    });

    const data = await res.json();

    if (data.error) throw new Error(data.error);

    renderDrugInfoContent(data, drugName, patientContext);

  } catch (e) {
    console.error('Drug info error:', e);
    renderBasicDrugInfo(drugName, med);
  }
};

function renderDrugInfoFromKnowledge(drug, drugName, warnings, med) {
  let html = '';

  // Header badge showing instant lookup
  html += `
    <div class="drug-instant-badge"><span class="instant-icon">⚡</span><span>Instant Lookup</span><span class="instant-source">Neural Knowledge Base</span></div>
  `;

  // Patient-specific warnings (most important - show first)
  if (warnings.length > 0) {
    const criticalWarnings = warnings.filter(w => w.severity === 'critical' || w.severity === 'high');
    const otherWarnings = warnings.filter(w => w.severity !== 'critical' && w.severity !== 'high');

    html += `
      <div class="patient-context-alert ${criticalWarnings.length > 0 ? 'critical' : ''}"><div class="context-alert-header"><div class="context-alert-icon">${criticalWarnings.length > 0 ? '🚨' : '⚠️'}</div><div class="context-alert-title">${criticalWarnings.length > 0 ? 'Critical Alerts for This Patient' : 'Patient-Specific Warnings'}</div></div><ul class="context-alert-list">
          ${warnings.map(w => `
            <li class="${w.severity}"><span class="alert-icon">${w.icon}</span><span>${esc(w.text)}</span></li>
          `).join('')}
        </ul></div>
    `;
  }

  // Drug class & mechanism
  html += `
    <div class="drug-section"><div class="drug-section-title"><span>🧬</span> ${esc(drug.class || 'Drug Class')}</div><p class="drug-info-text">${esc(drug.mechanism)}</p></div>
  `;

  // Side Effects
  if (drug.sideEffects?.length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>⚡</span> Side Effects</div><ul class="drug-info-list">
          ${drug.sideEffects.map(s => `<li>${esc(s)}</li>`).join('')}
        </ul></div>
    `;
  }

  // Contraindications
  if (drug.contraindications?.length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>🚫</span> Contraindications</div><ul class="drug-info-list contraindications">
          ${drug.contraindications.map(c => `<li>${esc(c)}</li>`).join('')}
        </ul></div>
    `;
  }

  // Monitoring
  if (drug.monitoring?.length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>📊</span> Monitoring Parameters</div><ul class="drug-info-list monitoring">
          ${drug.monitoring.map(m => `<li>${esc(m)}</li>`).join('')}
        </ul></div>
    `;
  }

  // Key Interactions
  if (drug.interactions && Object.keys(drug.interactions).length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>💊</span> Key Drug Interactions</div><ul class="drug-info-list interactions">
          ${Object.entries(drug.interactions).map(([trigger, desc]) => `
            <li><strong>${esc(trigger)}:</strong> ${esc(desc)}</li>
          `).join('')}
        </ul></div>
    `;
  }

  // Renal Dosing
  if (drug.renalDosing) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>🫘</span> Renal Dosing</div><div class="renal-dosing-grid"><div class="renal-dose-item"><span class="renal-label">Mild</span><span class="renal-value">${esc(drug.renalDosing.mild)}</span></div><div class="renal-dose-item"><span class="renal-label">Moderate</span><span class="renal-value">${esc(drug.renalDosing.moderate)}</span></div><div class="renal-dose-item"><span class="renal-label">Severe</span><span class="renal-value">${esc(drug.renalDosing.severe)}</span></div></div></div>
    `;
  }

  $('drugInfoBody').innerHTML = html;
}

function renderDrugInfoContent(data, drugName, context) {
  const warnings = data.warnings || [];
  const mechanism = data.mechanism || 'Information not available.';
  const sideEffects = data.sideEffects || [];
  const contraindications = data.contraindications || [];
  const monitoring = data.monitoring || [];
  const interactions = data.interactions || [];

  let html = '';

  // Patient-specific warnings
  if (warnings.length > 0 || interactions.length > 0) {
    html += `
      <div class="patient-context-alert"><div class="context-alert-header"><div class="context-alert-icon">⚠️</div><div class="context-alert-title">Patient-Specific Warnings</div></div><ul class="context-alert-list">
          ${warnings.map(w => `<li><span class="alert-icon">${w.icon || '⚡'}</span>${esc(w.text || w)}</li>`).join('')}
          ${interactions.map(i => `<li><span class="alert-icon">💊</span>Drug interaction: ${esc(i)}</li>`).join('')}
        </ul></div>
    `;
  }

  // Mechanism of Action
  html += `
    <div class="drug-section"><div class="drug-section-title"><span>🔬</span> Mechanism of Action</div><p class="drug-info-text">${esc(mechanism)}</p></div>
  `;

  // Side Effects
  if (sideEffects.length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>⚡</span> Common Side Effects</div><ul class="drug-info-list">
          ${sideEffects.map(s => `<li>${esc(s)}</li>`).join('')}
        </ul></div>
    `;
  }

  // Contraindications
  if (contraindications.length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>🚫</span> Contraindications</div><ul class="drug-info-list">
          ${contraindications.map(c => `<li>${esc(c)}</li>`).join('')}
        </ul></div>
    `;
  }

  // Monitoring
  if (monitoring.length > 0) {
    html += `
      <div class="drug-section"><div class="drug-section-title"><span>📊</span> Monitoring Parameters</div><ul class="drug-info-list">
          ${monitoring.map(m => `<li>${esc(m)}</li>`).join('')}
        </ul></div>
    `;
  }

  $('drugInfoBody').innerHTML = html;
}

function renderBasicDrugInfo(drugName, med) {
  $('drugInfoBody').innerHTML = `
    <div class="drug-section"><div class="drug-section-title"><span>💊</span> ${esc(drugName)}</div><p class="drug-info-text">
        ${med?.indication ? `<strong>Indication:</strong> ${esc(med.indication)}<br><br>` : ''}
        <strong>Dose:</strong> ${esc(med?.dose || 'Not specified')}<br><strong>Route:</strong> ${esc(med?.route || 'PO')}<br><strong>Frequency:</strong> ${esc(med?.frequency || 'As prescribed')}
      </p><p style="margin-top:16px;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;font-size:0.85rem;color:#fbbf24">
        ⚠️ For detailed AI-powered drug information, ensure your API is configured in Admin Settings.
      </p></div>
  `;
}

function renderProfileHistory() {
  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];

  let html = `
    <div class="section-card"><div class="section-header"><div class="section-title">📜 Clinical Notes & Documents</div><button class="btn btn-primary btn-sm" onclick="addClinicalNote()">+ Add Note</button></div><div class="section-body"><div class="history-upload-area" onclick="triggerHistoryUpload()"><div style="font-size:1.5rem;margin-bottom:6px">📷</div><div style="font-weight:600;font-size:0.85rem">Upload Document</div><div style="font-size:0.75rem;color:#8b949e">Progress notes, referrals, consults, discharge summaries</div></div>
  `;

  if (!p.clinicalNotes.length) {
    html += `<div style="text-align:center;padding:24px;color:#8b949e"><div style="font-size:1.5rem;margin-bottom:8px">📝</div><div>No clinical notes yet</div><div style="font-size:0.75rem;margin-top:4px">Add notes or upload documents</div></div>`;
  } else {
    html += `<div class="clinical-notes-list">`;

    p.clinicalNotes.slice().reverse().forEach((note, idx) => {
      const realIdx = p.clinicalNotes.length - 1 - idx;
      const typeIcons = { progress: '📝', consult: '👨‍⚕️', referral: '📤', discharge: '🏥', imaging: '🩻', other: '📄' };
      const icon = typeIcons[note.type] || '📄';

      html += `
        <div class="clinical-note-card"><div class="clinical-note-header"><div class="clinical-note-type">${icon} ${(note.type || 'Note').charAt(0).toUpperCase() + (note.type || 'note').slice(1)}</div><div style="display:flex;align-items:center;gap:8px"><span class="clinical-note-date">${formatDateTime(note.date)}</span><button class="btn-icon-sm" onclick="deleteClinicalNote(${realIdx})" title="Delete">🗑️</button></div></div>
          ${note.image ? `<img src="${note.image}" class="clinical-note-image" onclick="viewNoteImage(${realIdx})">` : ''}
          ${note.aiSummary ? `
            <div class="clinical-note-ai"><div class="clinical-note-ai-badge">🤖 AI Summary</div><div class="clinical-note-ai-text">${esc(note.aiSummary)}</div></div>
          ` : ''}
          ${note.text ? `<div class="clinical-note-text">${esc(note.text)}</div>` : ''}
          ${note.author ? `<div class="clinical-note-author">— ${esc(note.author)}</div>` : ''}
        </div>
      `;
    });

    html += `</div>`;
  }

  html += `</div></div>`;
  $('profileHistory').innerHTML = html;
}

window.addClinicalNote = function() {
  const type = prompt('Note type:\\n• progress\\n• consult\\n• referral\\n• discharge\\n• other') || 'progress';
  const text = prompt('Enter note text:');
  if (!text) return;

  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];

  p.clinicalNotes.push({
    date: new Date().toISOString(),
    type: type,
    text: text,
    author: state.settings.userName || 'Unknown'
  });

  saveCloud();
  renderProfileHistory();
  toast('Note added');
};

window.triggerHistoryUpload = function() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => handleHistoryUpload(e.target.files[0]);
  input.click();
};

async function handleHistoryUpload(file) {
  if (!file) return;

  const type = prompt('Document type:\\n• progress\\n• consult\\n• referral\\n• discharge\\n• other') || 'other';

  toast('Analyzing document...');

  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'interpret',
          documentType: 'clinical_note',
          noteType: type,
          image: imageData
        })
      });
      const data = await res.json();

      const p = state.currentPatient;
      if (!p.clinicalNotes) p.clinicalNotes = [];

      p.clinicalNotes.push({
        date: new Date().toISOString(),
        type: type,
        image: imageData,
        aiSummary: data.interpretation?.summary || data.interpretation?.text || 'Document uploaded',
        author: state.settings.userName || 'Unknown'
      });

      saveCloud();
      renderProfileHistory();
      toast('Document analyzed and saved');
    } catch (e) {
      toast('Failed to analyze document', true);
    }
  });
}

window.deleteClinicalNote = function(idx) {
  if (!confirm('Delete this note?')) return;
  state.currentPatient.clinicalNotes.splice(idx, 1);
  saveCloud();
  renderProfileHistory();
  toast('Note deleted');
};

window.viewNoteImage = function(idx) {
  const note = state.currentPatient.clinicalNotes[idx];
  if (!note?.image) return;

  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'padding:10px;z-index:9999';
  modal.innerHTML = `
    <div class="modal-box" style="max-width:90%;max-height:90vh;padding:0;background:#000"><img src="${note.image}" style="max-width:100%;max-height:85vh;object-fit:contain"><button onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer">✕ Close</button></div>
  `;
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
};

function renderProfileOverview() {
  try {
  const p = state.currentPatient;
  if (!p) return;
  $('profileOverview').innerHTML = `
    <div class="section-card"><div class="section-header"><div class="section-title">📋 Diagnosis</div></div><div class="section-body"><div style="font-size:0.95rem;color:var(--text-secondary)">${esc(p.diagnosis) || 'No diagnosis recorded'}</div></div></div><div class="section-card"><div class="section-header"><div class="section-title">🩺 Vitals</div><button class="btn btn-secondary btn-xs" onclick="openAddVitals()">Update</button></div><div class="section-body"><div class="vitals-grid"><div class="vital-card"><div class="vital-icon">❤️</div><div class="vital-value">${p.vitals?.hr || '—'}</div><div class="vital-label">HR</div></div><div class="vital-card"><div class="vital-icon">🩸</div><div class="vital-value">${p.vitals?.bp || '—'}</div><div class="vital-label">BP</div></div><div class="vital-card"><div class="vital-icon">🌡️</div><div class="vital-value">${p.vitals?.temp || '—'}</div><div class="vital-label">Temp</div></div><div class="vital-card"><div class="vital-icon">💨</div><div class="vital-value">${p.vitals?.rr || '—'}</div><div class="vital-label">RR</div></div><div class="vital-card"><div class="vital-icon">🫁</div><div class="vital-value">${p.vitals?.spo2 || '—'}</div><div class="vital-label">SpO₂</div></div></div></div></div><div class="section-card"><div class="section-header"><div class="section-title">📝 History & Examination</div><button class="btn btn-secondary btn-xs" onclick="openEditText('history', 'History')">Edit</button></div><div class="section-body"><div style="font-size:0.9rem;color:var(--text-secondary);white-space:pre-wrap;min-height:60px">${esc(p.history) || 'Tap Edit to add...'}</div></div></div>
  `;
  } catch(e) { console.error('renderProfileOverview error:', e); }
}

function renderProfileLabs() {
  const p = state.currentPatient;
  const labData = p.labData || { dates: [], parameters: [] };

  let html = `
    <div class="section-card"><div class="section-header"><div class="section-title">🧪 Laboratory Results</div>
        ${labData.parameters?.length ? `<button class="btn btn-danger btn-sm" onclick="clearPatientLabs()" style="padding:4px 8px;font-size:0.7rem">🗑️ Clear</button>` : ''}
      </div><div class="section-body"><div class="lab-upload-area ${state.isAnalyzingLab ? 'analyzing' : ''}" onclick="triggerLabUpload()">
          ${state.isAnalyzingLab ? `
            <div class="lab-upload-icon">⏳</div><div class="lab-upload-title">Analyzing Lab Report...</div><div class="lab-upload-subtitle">AI is extracting and interpreting values</div>
          ` : `
            <div class="lab-upload-icon">📷</div><div class="lab-upload-title">Upload Lab Report</div><div class="lab-upload-subtitle">Smart OCR • Kuwait MOH format supported</div>
          `}
        </div>
  `;

  if (!labData.parameters?.length) {
    html += `<div style="text-align:center;padding:20px;color:var(--text-muted)">No lab results yet</div></div></div>`;
    $('profileLabs').innerHTML = html;
    return;
  }

  // Critical Alert
  const criticals = [];
  labData.parameters.forEach(param => {
    const latest = param.values?.[0];
    if (latest?.status === 'critical' || latest?.status === 'high') {
      criticals.push(`${param.name}: ${latest.value} ${param.unit || ''}`);
    }
  });

  if (criticals.length) {
    html += `
        <div class="critical-alert"><div class="critical-alert-icon">⚠️</div><div class="critical-alert-content"><div class="critical-alert-title">Abnormal Values Detected</div><div class="critical-alert-values">${criticals.join(' • ')}</div></div></div>
    `;
  }

  // AI Interpretation with Feedback
  if (labData.interpretation?.summary) {
    const interp = labData.interpretation;
    html += `
        <div class="ai-interpretation"><div class="ai-interpretation-header"><div class="ai-interpretation-title">🤖 AI Interpretation <span class="ai-badge">NEURAL</span></div></div><div class="ai-interpretation-text">${esc(interp.summary)}</div>

          ${interp.clinicalCorrelation ? `
          <div class="ai-details"><div class="ai-details-title">Clinical Correlation</div><p style="font-size:0.85rem;color:var(--text-secondary);margin:0">${esc(interp.clinicalCorrelation)}</p></div>
          ` : ''}

          ${interp.trends?.length ? `
          <div class="ai-details"><div class="ai-details-title">📈 Trends</div><ul class="ai-details-list">
              ${interp.trends.map(t => `<li>${esc(t)}</li>`).join('')}
            </ul></div>
          ` : ''}

          ${interp.recommendations?.length ? `
          <div class="ai-details"><div class="ai-details-title">💡 Recommendations</div><ul class="ai-details-list">
              ${interp.recommendations.map(r => `<li>${esc(r)}</li>`).join('')}
            </ul></div>
          ` : ''}

          <div class="feedback-section"><div><div class="feedback-label">Was this interpretation helpful?</div><div class="feedback-sent">✓ Feedback recorded</div></div><div class="feedback-buttons"><button class="feedback-btn positive" onclick="sendFeedback(1, 'lab')" title="Helpful">👍</button><button class="feedback-btn negative" onclick="sendFeedback(-1, 'lab')" title="Not helpful">👎</button></div></div></div>
    `;
  }

  // Lab Values by Category
  const sortedDates = [...(labData.dates || [])].sort((a, b) => new Date(b) - new Date(a));
  const latestDate = sortedDates[0];

  if (latestDate) {
    const categories = {};
    labData.parameters.forEach(param => {
      const latestVal = param.values?.find(v => v.date === latestDate);
      if (latestVal) {
        const cat = getLabCategory(param.name);
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ ...param, latestValue: latestVal });
      }
    });

    html += `<div style="margin-bottom:8px;font-size:0.75rem;color:var(--text-muted)">📅 Results from ${formatShortDate(latestDate)}</div>`;

    const catOrder = ['Renal Function', 'Electrolytes', 'Glucose & Metabolic', 'Liver Function', 'Complete Blood Count', 'Other'];
    catOrder.forEach(cat => {
      if (!categories[cat]?.length) return;
      const catData = CONFIG.LAB_CATEGORIES[cat];

      html += `
        <div class="lab-category"><div class="lab-category-header">${catData?.icon || '🔬'} ${cat}</div><div class="lab-category-body"><div class="lab-values-grid">
      `;

      categories[cat].forEach((param, catIdx) => {
        const v = param.latestValue;
        const status = v.status || 'normal';
        const paramIdx = labData.parameters.findIndex(p => p.name === param.name);
        const valueIdx = param.values?.findIndex(val => val.date === latestDate) || 0;
        html += `
          <div class="lab-value-card ${status}" onclick="openLabOverride(${paramIdx}, ${valueIdx})" title="Click to override"><div class="lab-value-name">
              ${esc(param.name)}
              ${v.manualOverride ? '<span class="lab-override-indicator">✏️</span>' : ''}
              ${status !== 'normal' ? `<span class="lab-value-status ${status}">${status === 'high' ? 'HIGH' : status === 'low' ? 'LOW' : '!'}</span>` : ''}
            </div><div class="lab-value-number">${esc(v.value)}</div><div class="lab-value-unit">${esc(param.unit || '')}</div>
            ${param.refMin !== undefined && param.refMax !== undefined ? `<div class="lab-value-range">Reference: ${param.refMin} - ${param.refMax}</div>` : ''}
          </div>
        `;
      });

      html += `</div></div></div>`;
    });
  }

  // Trend Chart
  if (labData.parameters.length > 0) {
    html += `
      <div class="lab-trend-section"><div class="lab-trend-header"><div class="section-title">📈 Trends</div><select class="lab-trend-select" id="labTrendSelect" onchange="renderLabTrendChart()">
            ${labData.parameters.map((p, i) => `<option value="${i}">${esc(p.name)}</option>`).join('')}
          </select></div><div class="lab-trend-chart"><canvas id="labTrendChart"></canvas></div></div>
    `;
  }

  html += '</div></div>';
  $('profileLabs').innerHTML = html;

  if (labData.parameters.length > 0) {
    setTimeout(() => renderLabTrendChart(), 100);
  }
}

window.renderLabTrendChart = function() {
  const p = state.currentPatient;
  const labData = p?.labData;
  if (!labData?.parameters?.length) return;

  const idx = parseInt($('labTrendSelect')?.value) || 0;
  const param = labData.parameters[idx];
  if (!param?.values?.length) return;

  const ctx = $('labTrendChart');
  if (!ctx) return;

  if (state.trendChart) state.trendChart.destroy();

  const values = [...param.values].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-10);
  const labels = values.map(v => formatShortDate(v.date));
  const data = values.map(v => parseFloat(v.value) || 0);
  const colors = values.map(v => v.status === 'high' || v.status === 'critical' ? '#f43f5e' : v.status === 'low' ? '#3b82f6' : '#10b981');

  state.trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: param.name,
        data,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245,158,11,0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: colors,
        pointBorderColor: colors,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', font: { size: 10 } } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
};

window.triggerLabUpload = function() {
  if (state.isAnalyzingLab) return;
  $('labFileInput').click();
};

// ENHANCED LAB EXTRACTION (Kuwait MOH Format Support)

const LAB_EXTRACTION_PROMPT = `You are a medical laboratory report extraction system. Analyze this lab report image with extreme precision.

CRITICAL INSTRUCTIONS:
1. Extract ALL visible lab values, dates, and reference ranges
2. Pay special attention to:
   - Date format: Look for DD/MM/YYYY or MM/DD/YYYY patterns
   - Cumulative/historical data tables showing multiple dates
   - Age-specific reference ranges (e.g., "<50 years: >450 pg/ml")
   - Units (pg/ml, mmol/L, mg/dL, etc.)
   - Patient demographics if visible

3. For each parameter found, extract:
   - Parameter name (standardized: e.g., "NT-proBNP" not "NT pro BNP")
   - Value (numeric only)
   - Unit
   - Reference range (min-max or descriptive)
   - Date of test (convert to ISO format YYYY-MM-DD)
   - Status: "critical", "high", "low", or "normal" based on reference ranges

4. IMPORTANT FOR KUWAIT MOH FORMAT:
   - Look for "PATIENT CUMULATIVE REPORT" section with historical values
   - Parse the table showing multiple dates and sample numbers
   - Extract ALL historical values, not just the latest
   - Note the "Special Range" section for age-specific cutoffs
   - Handle formats like "16/01/2026 04:32:56" for dates

5. NT-proBNP Specific (ICON Criteria for Acute HF):
   - Rule IN HF for <50 years: >450 pg/ml
   - Rule IN HF for 50-75 years: >900 pg/ml
   - Rule IN HF for >75 years: >1800 pg/ml
   - Rule OUT HF (all ages): <300 pg/ml
   - Chronic HF (ESC): >125 pg/ml

6. Common Lab Mappings:
   - "NT proBNP" / "NT-proBNP" / "ProBNP" → standardize to "NT-proBNP"
   - Apply age-based reference interpretation for cardiac markers

Return a JSON object with this exact structure:
{
  "confidence": 0.0-1.0,
  "patientInfo": {
    "name": "string or null",
    "hospitalId": "string or null",
    "dateOfBirth": "YYYY-MM-DD or null",
    "gender": "Male/Female or null",
    "location": "string or null"
  },
  "labData": {
    "dates": ["YYYY-MM-DD", ...],
    "parameters": [
      {
        "name": "Standard Parameter Name",
        "abbrev": "Abbreviation",
        "unit": "unit string",
        "refMin": number or null,
        "refMax": number or null,
        "refDescription": "Age-specific or contextual reference info",
        "values": [
          {
            "date": "YYYY-MM-DD",
            "value": number,
            "status": "critical|high|low|normal"
          }
        ]
      }
    ],
    "interpretation": {
      "summary": "Brief clinical interpretation",
      "clinicalCorrelation": "Clinical context",
      "trends": ["Notable trends"],
      "recommendations": ["Actionable recommendations"]
    }
  }
}

RESPOND ONLY WITH VALID JSON. No markdown, no explanation.`;

async function handleLabUpload(file) {
  // Guard: Check API URL
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    toast('API not configured. Go to Admin → Settings', true);
    return;
  }

  state.isAnalyzingLab = true;
  renderProfileLabs();

  // Show professional loader
  showLabLoader();

  // Store image for preview
  state.pendingLabImage = URL.createObjectURL(file);

  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      console.log('🔬 Starting enhanced lab extraction...');
      console.log('📡 API:', state.settings.apiUrl);
      console.log('🖼️ Image size:', Math.round(imageData.length / 1024), 'KB');

      const requestBody = {
        action: 'analyzeLabsEnhanced',
        image: imageData,
        extractionPrompt: LAB_EXTRACTION_PROMPT,
        patientContext: {
          existingLabs: state.currentPatient?.labData?.parameters?.map(p => ({
            name: p.name,
            latestValue: p.values?.[0]?.value,
            latestDate: p.values?.[0]?.date
          })) || []
        }
      };

      console.log('📤 Sending request with keys:', Object.keys(requestBody).join(', '));
      console.log('📤 Image data starts with:', imageData.substring(0, 50));

      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(requestBody)
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error('❌ HTTP Error:', res.status, errorText);
        throw new Error('HTTP ' + res.status + ': ' + errorText.substring(0, 100));
      }

      const data = await res.json();
      console.log('📦 Extraction result:', data);

      state.isAnalyzingLab = false;
      hideLabLoader();

      if (data.error || !data.labData) {
        console.error('❌ Extraction error:', data.error);
        let errorMsg = data.error || 'Extraction failed';
        if (data.debug) {
          const d = data.debug;
          alert('DEBUG INFO:\n\nLength: ' + d.rawResponseLength + '\nFirst { at: ' + d.firstBraceAt + '\nLast } at: ' + d.lastBraceAt + '\n\nExtracted:\n' + d.extractedPreview + '\n\nRaw:\n' + d.rawResponsePreview);
        }
        toast(errorMsg.substring(0, 100), true);
        renderProfileLabs();
        return;
      }

      // Store for preview before confirmation
      state.pendingLabData = data.labData;
      state.labExtractionConfidence = data.confidence || 0.8;
      state.currentInteractionId = data.meta?.interactionId;

            console.log('📊 Parameters found:', data.labData.parameters?.length || 0);
      console.log('📅 Dates found:', data.labData.dates?.length || 0);

      // Show enhanced preview modal
      showLabExtractionPreview(data);

    } catch (e) {
      console.error('❌ Lab extraction error:', e);
      console.error('❌ Error name:', e.name);
      console.error('❌ Error message:', e.message);
      state.isAnalyzingLab = false;
      hideLabLoader();
      toast('Extraction failed: ' + (e.message || 'check connection'), true);
      renderProfileLabs();
    }
  });
}

function showLabExtractionPreview(data) {
  const ld = data.labData;
  const confidence = data.confidence || 0.8;
  const confPercent = Math.round(confidence * 100);
  const confClass = confidence >= 0.8 ? 'high' : confidence >= 0.5 ? 'medium' : 'low';
  const confLabel = confidence >= 0.8 ? 'High Confidence' : confidence >= 0.5 ? 'Medium Confidence' : 'Low Confidence';

  // Group parameters by status for organized display
  const criticalParams = [];
  const abnormalParams = [];
  const normalParams = [];

  (ld.parameters || []).forEach(param => {
    const latestVal = param.values?.[0];
    if (!latestVal) return;

    const status = latestVal.status || 'normal';
    if (status === 'critical') {
      criticalParams.push({ ...param, latestStatus: status });
    } else if (status === 'high' || status === 'low') {
      abnormalParams.push({ ...param, latestStatus: status });
    } else {
      normalParams.push({ ...param, latestStatus: status });
    }
  });

  let html = '';

  // Image thumbnail section
  if (state.pendingLabImage) {
    html += `
      <div class="preview-images"><div class="preview-thumb-wrapper"><img src="${state.pendingLabImage}" class="preview-thumb" alt="Lab Image"><div class="preview-thumb-badge">1</div></div></div>
    `;
  }

  // Confidence section
  html += `
    <div class="preview-confidence"><div class="confidence-header"><span class="confidence-title">Extraction Confidence</span><span class="confidence-badge ${confClass}">${confLabel}</span></div><div class="confidence-bar-lg"><div class="fill ${confClass}" style="width:${confPercent}%"></div></div>
      ${confidence < 0.7 ? `
        <div class="confidence-warning">
          ⚠️ Low confidence extraction - please verify values carefully before saving
        </div>
      ` : ''}
    </div>
  `;

  // Extracted values section
  html += '<div class="preview-values">';

  // Check if we have any parameters
  const totalParams = criticalParams.length + abnormalParams.length + normalParams.length;

  if (totalParams === 0) {
    html += `
      <div class="preview-empty"><div class="preview-empty-icon">🔬</div><div class="preview-empty-text">No lab values could be extracted from this image.<br>Try uploading a clearer image.</div></div>
    `;
  } else {
    // Critical Values Section
    if (criticalParams.length > 0) {
      html += buildLabPreviewSection('Critical Values', 'critical', '🚨', criticalParams);
    }

    // Abnormal Values Section
    if (abnormalParams.length > 0) {
      html += buildLabPreviewSection('Abnormal Values', 'abnormal', '⚠️', abnormalParams);
    }

    // Normal Values Section
    if (normalParams.length > 0) {
      html += buildLabPreviewSection('Normal Values', 'normal', '✓', normalParams);
    }
  }

  html += '</div>';

  // Interpretation Section
  if (ld.interpretation?.summary || ld.interpretation?.criticalFindings?.length) {
    html += `
      <div class="preview-interpretation"><div class="interpretation-header"><span>🤖</span> AI Clinical Interpretation
        </div>
        ${ld.interpretation.summary ? `<div class="interpretation-text">${esc(ld.interpretation.summary)}</div>` : ''}
        ${ld.interpretation.criticalFindings?.length ? `
          <div class="interpretation-findings">
            ${ld.interpretation.criticalFindings.map(f => `
              <div class="interpretation-finding">${esc(f)}</div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
  }

  $('labPreviewBody').innerHTML = html;
  openModal('labPreviewModal');
}

// Helper function to build preview sections
function buildLabPreviewSection(title, type, icon, params) {
  let html = `
    <div class="preview-section"><div class="preview-section-header"><div class="preview-section-icon ${type}">${icon}</div><span class="preview-section-title">${title}</span><span class="preview-section-count">${params.length} value${params.length !== 1 ? 's' : ''}</span></div>
  `;

  params.forEach(param => {
    const latestVal = param.values?.[0];
    if (!latestVal) return;

    const status = latestVal.status || 'normal';
    const historyCount = (param.values?.length || 1) - 1;

    // Calculate trend if we have history
    let trendHtml = '';
    if (param.values?.length >= 2) {
      const current = parseFloat(latestVal.value);
      const previous = parseFloat(param.values[1].value);
      if (!isNaN(current) && !isNaN(previous)) {
        const diff = current - previous;
        const pctChange = Math.abs((diff / previous) * 100).toFixed(0);
        if (diff > 0) {
          trendHtml = `<span class="trend-indicator up">↑${pctChange}%</span>`;
        } else if (diff < 0) {
          trendHtml = `<span class="trend-indicator down">↓${pctChange}%</span>`;
        } else {
          trendHtml = `<span class="trend-indicator stable">→</span>`;
        }
      }
    }

    // Build reference range text
    let refText = '';
    if (param.refMin !== undefined && param.refMax !== undefined && param.refMin !== null && param.refMax !== null) {
      refText = `Ref: ${param.refMin} - ${param.refMax}`;
    } else if (param.refDescription) {
      refText = `Ref: ${param.refDescription}`;
    }

    html += `
      <div class="preview-lab-card ${status}"><div class="preview-lab-info"><div class="preview-lab-name">
            ${esc(param.name)}
            ${param.abbrev ? `<span class="abbrev">(${esc(param.abbrev)})</span>` : ''}
          </div>
          ${refText ? `<div class="preview-lab-ref">${esc(refText)}</div>` : ''}
        </div><div class="preview-lab-value"><div class="preview-lab-number ${status}">
            ${latestVal.value}${trendHtml}
          </div>
          ${param.unit ? `<div class="preview-lab-unit">${esc(param.unit)}</div>` : ''}
          ${historyCount > 0 ? `<div class="preview-lab-history">+${historyCount} historical</div>` : ''}
        </div></div>
    `;
  });

  html += '</div>';
  return html;
}

window.confirmLabExtraction = async function() {
  if (!state.pendingLabData || !state.currentPatient) return;

  const p = state.currentPatient;
  const ld = state.pendingLabData;

  // Merge dates
  (ld.dates || []).forEach(d => {
    if (!p.labData.dates.includes(d)) p.labData.dates.push(d);
  });
  p.labData.dates.sort((a, b) => new Date(b) - new Date(a));

  // Merge parameters intelligently
  (ld.parameters || []).forEach(newParam => {
    let existing = p.labData.parameters.find(ep =>
      ep.name.toLowerCase() === newParam.name.toLowerCase() ||
      (ep.abbrev && newParam.abbrev && ep.abbrev.toLowerCase() === newParam.abbrev.toLowerCase())
    );

    if (existing) {
      // Merge values into existing parameter
      (newParam.values || []).forEach(nv => {
        const ev = existing.values.find(x => x.date === nv.date);
        if (ev) {
          ev.value = nv.value;
          ev.status = nv.status;
        } else {
          existing.values.push(nv);
        }
      });
      // Sort values by date descending
      existing.values.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Update metadata
      if (newParam.refMin !== undefined) existing.refMin = newParam.refMin;
      if (newParam.refMax !== undefined) existing.refMax = newParam.refMax;
      if (newParam.unit) existing.unit = newParam.unit;
      if (newParam.refDescription) existing.refDescription = newParam.refDescription;
    } else {
      // Add as new parameter
      if (newParam.values) {
        newParam.values.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      p.labData.parameters.push(newParam);
    }
  });

  // Update interpretation
  if (ld.interpretation) p.labData.interpretation = ld.interpretation;

  // Force immediate sync (bypass debounce for lab data)
  await forceSync();

  renderProfileLabs();
  closeModal('labPreviewModal');
  toast('Lab results saved!');

  // Clear pending data
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
};

window.resetLabExtraction = function() {
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
  state.isAnalyzingLab = false;
  if (state.pendingLabImage) {
    URL.revokeObjectURL(state.pendingLabImage);
    state.pendingLabImage = null;
  }
  renderProfileLabs();
};

// LAB ANALYSIS LOADING ANIMATION FUNCTIONS

function showLabLoader() {
  const loader = $('labAnalysisLoader');
  if (!loader) return;

  // Reset all steps
  ['step1', 'step2', 'step3', 'step4'].forEach(id => {
    const step = $(id);
    if (step) {
      step.classList.remove('active', 'complete');
      step.querySelector('.step-icon').textContent = id.replace('step', '');
    }
  });

  loader.classList.add('active');

  // Animate steps progressively
  setTimeout(() => setLoaderStep(1), 100);
  setTimeout(() => setLoaderStep(2), 1500);
  setTimeout(() => setLoaderStep(3), 3000);
  setTimeout(() => setLoaderStep(4), 4500);
}

function setLoaderStep(stepNum) {
  // Complete previous steps
  for (let i = 1; i < stepNum; i++) {
    const prev = $('step' + i);
    if (prev) {
      prev.classList.remove('active');
      prev.classList.add('complete');
      prev.querySelector('.step-icon').textContent = '✓';
    }
  }

  // Activate current step
  const current = $('step' + stepNum);
  if (current) {
    current.classList.add('active');
  }
}

function hideLabLoader() {
  const loader = $('labAnalysisLoader');
  if (loader) {
    // Complete all steps first
    ['step1', 'step2', 'step3', 'step4'].forEach(id => {
      const step = $(id);
      if (step) {
        step.classList.remove('active');
        step.classList.add('complete');
        step.querySelector('.step-icon').textContent = '✓';
      }
    });

    // Small delay then hide
    setTimeout(() => {
      loader.classList.remove('active');
    }, 500);
  }
}

function renderProfileImaging() {
  const p = state.currentPatient;
  const imaging = p.imaging || [];

  $('profileImaging').innerHTML = `
    <div class="section-card"><div class="section-header"><div class="section-title">📷 Imaging & Studies</div></div><div class="section-body"><div class="lab-upload-area ${state.isAnalyzingImaging ? 'analyzing' : ''}" onclick="triggerImagingUpload()">
          ${state.isAnalyzingImaging ? `
            <div class="lab-upload-icon">⏳</div><div class="lab-upload-title">Analyzing...</div>
          ` : `
            <div class="lab-upload-icon">🩻</div><div class="lab-upload-title">Upload Study</div><div class="lab-upload-subtitle">Echo • ECG • X-Ray • CT/MRI</div>
          `}
        </div>

        ${imaging.length ? imaging.slice().reverse().map((img, idx) => `
          <div class="imaging-card"><div class="imaging-card-header"><div class="imaging-type">
                ${img.type === 'ecg' ? '📈' : img.type === 'echo' ? '💓' : img.type === 'xray' ? '🩻' : '🧠'}
                ${(img.type || 'Study').toUpperCase()}
              </div><div style="display:flex;align-items:center;gap:8px"><span class="imaging-date">${formatDateTime(img.date)}</span><button class="btn btn-ghost btn-xs" onclick="deleteImaging(${imaging.length - 1 - idx})">🗑️</button></div></div><div class="imaging-summary">${esc(img.summary) || 'No findings recorded'}</div></div>
        `).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No imaging studies</div>'}
      </div></div>
  `;
}

window.triggerImagingUpload = function() {
  if (state.isAnalyzingImaging) return;
  $('imagingFileInput').click();
};

async function handleImagingUpload(file) {
  state.isAnalyzingImaging = true;
  renderProfileImaging();

  const type = prompt('Enter study type:\n• echo\n• ecg\n• xray\n• ct') || 'xray';

  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'interpret', documentType: type, image: imageData })
      });
      const data = await res.json();

      state.isAnalyzingImaging = false;

      const p = state.currentPatient;
      if (!p.imaging) p.imaging = [];

      p.imaging.push({
        date: new Date().toISOString(),
        type: type,
        summary: data.interpretation?.summary || data.interpretation?.impression || data.interpretation?.conclusion || 'Analysis complete'
      });

      saveCloud();
      renderProfileImaging();
      toast('Imaging added!');
    } catch (e) {
      state.isAnalyzingImaging = false;
      toast('Analysis failed', true);
      renderProfileImaging();
    }
  });
}

window.deleteImaging = function(idx) {
  if (!confirm('Delete this imaging study?')) return;
  state.currentPatient.imaging.splice(idx, 1);
  saveCloud();
  renderProfileImaging();
  toast('Imaging deleted');
};

window.clearPatientLabs = function() {
  if (!confirm('Delete all lab results for this patient?')) return;
  state.currentPatient.labData = { dates: [], parameters: [] };
  saveCloud();
  renderProfileLabs();
  toast('Lab data cleared');
};

function renderProfileFluids() {
  const p = state.currentPatient;
  const fluids = p.fluids || [];
  const totalIntake = fluids.reduce((s, f) => s + (f.intake || 0), 0);
  const totalOutput = fluids.reduce((s, f) => s + (f.output || 0), 0);
  const balance = totalIntake - totalOutput;

  $('profileFluids').innerHTML = `
    <div class="section-card"><div class="section-header"><div class="section-title">💧 Fluid Balance</div><button class="btn btn-primary btn-xs" onclick="openAddFluid()">+ Add</button></div><div class="section-body"><div class="fluid-summary"><div class="fluid-stat"><div class="fluid-stat-value intake">${totalIntake}</div><div class="fluid-stat-label">Intake (mL)</div></div><div class="fluid-stat"><div class="fluid-stat-value output">${totalOutput}</div><div class="fluid-stat-label">Output (mL)</div></div><div class="fluid-stat"><div class="fluid-stat-value balance" style="color:${balance >= 0 ? 'var(--emerald)' : 'var(--rose)'}">${balance >= 0 ? '+' : ''}${balance}</div><div class="fluid-stat-label">Balance</div></div></div>
        ${fluids.length ? `<div class="fluid-chart-container"><canvas id="fluidChart"></canvas></div>` : ''}
      </div></div>
  `;

  if (fluids.length) setTimeout(() => renderFluidChart(fluids), 100);
}

function renderFluidChart(fluids) {
  const ctx = $('fluidChart');
  if (!ctx) return;
  if (state.fluidChart) state.fluidChart.destroy();

  state.fluidChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fluids.map(f => formatDateTime(f.date).split(',')[0]),
      datasets: [
        { label: 'Intake', data: fluids.map(f => f.intake || 0), backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 6 },
        { label: 'Output', data: fluids.map(f => f.output || 0), backgroundColor: 'rgba(249,115,22,0.7)', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#9ca3af' } } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
}

function renderProfilePlans() {
  const p = state.currentPatient;
  if (!p.plans) p.plans = [];
  if (!p.tasks) p.tasks = [];

  // Convert old plans to tasks if needed
  if (p.plans.length > 0 && p.tasks.length === 0) {
    p.plans.forEach(plan => {
      const lines = plan.content.split('\n').filter(l => l.trim());
      lines.forEach(line => {
        p.tasks.push({
          id: Date.now() + Math.random(),
          text: line.replace(/^[-•*]\s*/, ''),
          completed: false,
          priority: 'medium',
          category: 'general',
          createdAt: plan.date,
          createdBy: state.currentUser || 'Unknown'
        });
      });
    });
  }

  const tasks = p.tasks || [];
  const pendingTasks = tasks.filter(t => !t.completed);
  const completedTasks = tasks.filter(t => t.completed);
  const completionRate = tasks.length > 0 ? Math.round((completedTasks.length / tasks.length) * 100) : 0;
  const urgentCount = tasks.filter(t => t.priority === 'high' && !t.completed).length;

  // Check if all tasks just got completed
  if (tasks.length > 0 && pendingTasks.length === 0 && !p._celebrationShown) {
    p._celebrationShown = true;
    setTimeout(() => showPlanCompletionCelebration(p), 500);
  } else if (pendingTasks.length > 0) {
    p._celebrationShown = false;
  }

  // Get AI suggestions based on patient context
  const suggestions = ClinicalPlanAI.getSuggestions(p);

  $('profilePlans').innerHTML = `
    <div class="section-card plan-section-card"><div class="section-header plan-section-header"><div class="section-title">📋 Clinical Plan</div><button class="btn btn-primary btn-xs" id="addTaskBtn">+ Add Task</button></div><div class="plan-stats-grid"><div class="plan-stat-box"><div class="plan-stat-ring"><svg viewBox="0 0 36 36"><path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/><path class="ring-fill" stroke-dasharray="${completionRate}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/></svg><span class="ring-text">${completionRate}%</span></div></div><div class="plan-stat-box"><span class="plan-stat-num amber">${pendingTasks.length}</span><span class="plan-stat-lbl">Pending</span></div><div class="plan-stat-box"><span class="plan-stat-num green">${completedTasks.length}</span><span class="plan-stat-lbl">Done</span></div><div class="plan-stat-box ${urgentCount > 0 ? 'urgent-box' : ''}"><span class="plan-stat-num red">${urgentCount}</span><span class="plan-stat-lbl">Urgent</span></div></div><div class="plan-notify-bar"><span class="notify-label">🔔 Reminders</span><label class="toggle-switch"><input type="checkbox" id="planNotifyToggle" ${p.notificationsEnabled ? 'checked' : ''}><span class="toggle-track"></span></label></div>

      ${suggestions.length > 0 ? `
        <div class="plan-ai-box"><div class="plan-ai-header"><span class="ai-badge">🧠 AI Suggestions</span></div><div class="plan-ai-list">
            ${suggestions.slice(0, 4).map((s, idx) => `
              <div class="plan-ai-item" data-suggestion-idx="${idx}"><span class="ai-item-icon">${s.icon}</span><span class="ai-item-text">${esc(s.text)}</span><span class="ai-item-add">+</span></div>
            `).join('')}
          </div></div>
      ` : ''}

      <div class="plan-tasks-list">
        ${pendingTasks.length > 0 ? `
          <div class="tasks-group-header"><span>⏳ Pending</span><span class="tasks-count">${pendingTasks.length}</span></div>
          ${pendingTasks.sort((a, b) => {
            const order = { high: 0, medium: 1, low: 2 };
            return order[a.priority] - order[b.priority];
          }).map(task => `
            <div class="plan-task-item" data-task-id="${task.id}" data-priority="${task.priority}"><div class="task-check-box ${task.completed ? 'done' : ''}" data-action="toggle"></div><div class="task-info"><div class="task-text">${esc(task.text)}</div><div class="task-meta"><span class="task-cat">${getCategoryIcon(task.category)} ${task.category || 'general'}</span><span class="task-pri ${task.priority}">${getPriorityDot(task.priority)}</span></div></div><div class="task-btns"><button class="task-btn" data-action="edit">✏️</button><button class="task-btn del" data-action="delete">🗑️</button></div></div>
          `).join('')}
        ` : `
          <div class="plan-empty"><div class="empty-icon">✅</div><div class="empty-text">No pending tasks</div></div>
        `}

        ${completedTasks.length > 0 ? `
          <div class="tasks-group-header completed-header" id="completedHeader"><span>✓ Completed</span><span class="tasks-count done">${completedTasks.length}</span><span class="expand-arrow">▼</span></div><div class="completed-tasks-list" id="completedTasksList" style="display:none">
            ${completedTasks.map(task => `
              <div class="plan-task-item completed" data-task-id="${task.id}"><div class="task-check-box done" data-action="toggle">✓</div><div class="task-info"><div class="task-text">${esc(task.text)}</div></div><div class="task-btns"><button class="task-btn del" data-action="delete">🗑️</button></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div></div>
  `;

  // Store suggestions for click handlers
  state._planSuggestions = suggestions;

  // Attach event handlers (mobile-friendly approach)
  initPlanEventHandlers();

  // Check notifications
  checkPendingTaskNotifications(p);
}

function getCategoryIcon(cat) {
  const icons = { labs: '🔬', imaging: '📷', medication: '💊', consult: '👨‍⚕️', procedure: '🏥', discharge: '🏠', monitoring: '📊', general: '📝' };
  return icons[cat] || '📝';
}

function getPriorityDot(pri) {
  const dots = { high: '🔴 High', medium: '🟡 Med', low: '🟢 Low' };
  return dots[pri] || '🟡 Med';
}

function initPlanEventHandlers() {
  // Add Task button
  const addBtn = document.getElementById('addTaskBtn');
  if (addBtn) {
    addBtn.onclick = function() { openTaskModal(); };
  }

  // Notification toggle
  const notifyToggle = document.getElementById('planNotifyToggle');
  if (notifyToggle) {
    notifyToggle.onchange = function() { togglePlanNotifications(this.checked); };
  }

  // Completed section toggle
  const completedHeader = document.getElementById('completedHeader');
  if (completedHeader) {
    completedHeader.onclick = function() {
      const list = document.getElementById('completedTasksList');
      const arrow = this.querySelector('.expand-arrow');
      if (list.style.display === 'none') {
        list.style.display = 'block';
        arrow.textContent = '▲';
      } else {
        list.style.display = 'none';
        arrow.textContent = '▼';
      }
    };
  }

  // AI Suggestion items
  document.querySelectorAll('.plan-ai-item').forEach(item => {
    item.onclick = function() {
      const idx = parseInt(this.dataset.suggestionIdx);
      const s = state._planSuggestions?.[idx];
      if (s) addSuggestedTask(s.text, s.priority, s.category);
    };
  });

  // Task items - use event delegation on parent
  document.querySelectorAll('.plan-task-item').forEach(item => {
    const taskId = item.dataset.taskId;

    // Checkbox
    const checkbox = item.querySelector('[data-action="toggle"]');
    if (checkbox) {
      checkbox.onclick = function(e) {
        e.stopPropagation();
        toggleTaskComplete(taskId);
      };
    }

    // Edit button
    const editBtn = item.querySelector('[data-action="edit"]');
    if (editBtn) {
      editBtn.onclick = function(e) {
        e.stopPropagation();
        editTask(taskId);
      };
    }

    // Delete button
    const deleteBtn = item.querySelector('[data-action="delete"]');
    if (deleteBtn) {
      deleteBtn.onclick = function(e) {
        e.stopPropagation();
        deleteTask(taskId);
      };
    }
  });
}

// Render individual task item
function renderTaskItem(task, isCompleted) {
  const priorityColors = {
    high: { bg: 'rgba(239,68,68,0.1)', border: 'rgba(239,68,68,0.3)', text: '#f87171', icon: '🔴' },
    medium: { bg: 'rgba(251,191,36,0.1)', border: 'rgba(251,191,36,0.3)', text: '#fbbf24', icon: '🟡' },
    low: { bg: 'rgba(52,211,153,0.1)', border: 'rgba(52,211,153,0.3)', text: '#34d399', icon: '🟢' }
  };
  const priority = priorityColors[task.priority] || priorityColors.medium;

  const categoryIcons = {
    labs: '🔬', imaging: '📷', medication: '💊', consult: '👨‍⚕️',
    procedure: '🏥', discharge: '🏠', monitoring: '📊', general: '📝'
  };
  const catIcon = categoryIcons[task.category] || '📝';

  return `
    <div class="task-item ${isCompleted ? 'completed' : ''} priority-${task.priority}" data-task-id="${task.id}"><button class="task-checkbox ${isCompleted ? 'checked' : ''}"
              onclick="toggleTaskComplete('${task.id}')">
        ${isCompleted ? '✓' : ''}
      </button><div class="task-content"><div class="task-text">${esc(task.text)}</div><div class="task-meta"><span class="task-category">${catIcon} ${task.category || 'General'}</span><span class="task-priority" style="color:${priority.text}">${priority.icon} ${task.priority}</span>
          ${task.dueDate ? `<span class="task-due">📅 ${formatDate(task.dueDate)}</span>` : ''}
        </div></div><div class="task-actions">
        ${!isCompleted ? `
          <button class="task-action-btn edit" onclick="editTask('${task.id}')" title="Edit">✏️</button>
        ` : ''}
        <button class="task-action-btn delete" onclick="deleteTask('${task.id}')" title="Delete">🗑️</button></div></div>
  `;
}

// Clinical Plan AI Suggestions
const ClinicalPlanAI = {
  getSuggestions: function(patient) {
    const suggestions = [];
    const diagnosis = (patient.diagnosis || '').toLowerCase();
    const existingTasks = (patient.tasks || []).map(t => t.text.toLowerCase());
    const meds = (patient.medications || []).map(m => m.name?.toLowerCase());
    const labs = patient.labData?.parameters || [];

    // Diagnosis-based suggestions
    const diagnosisSuggestions = {
      'diabetes': [
        { text: 'Check HbA1c if not done in 3 months', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Review blood glucose log', priority: 'medium', category: 'monitoring', icon: '📊' },
        { text: 'Diabetic foot examination', priority: 'medium', category: 'procedure', icon: '🦶' },
        { text: 'Ophthalmology referral for retinopathy screening', priority: 'low', category: 'consult', icon: '👁️' }
      ],
      'hypertension': [
        { text: 'Ensure BP monitoring TDS', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Check renal function panel', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Review antihypertensive compliance', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'pneumonia': [
        { text: 'Repeat CXR in 48-72h if no improvement', priority: 'medium', category: 'imaging', icon: '📷' },
        { text: 'Check inflammatory markers (CRP, WBC)', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Assess oxygen requirements', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Review antibiotic de-escalation at 48h', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'heart failure': [
        { text: 'Daily weight monitoring', priority: 'high', category: 'monitoring', icon: '⚖️' },
        { text: 'Strict fluid restriction (1.5L/day)', priority: 'high', category: 'general', icon: '💧' },
        { text: 'Check BNP/NT-proBNP trend', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Optimize diuretic dosing', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Echocardiogram if not recent', priority: 'medium', category: 'imaging', icon: '📷' }
      ],
      'acs': [
        { text: 'Serial troponins q6h x3', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Continuous cardiac monitoring', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Cardiology consult', priority: 'high', category: 'consult', icon: '👨‍⚕️' },
        { text: 'Ensure DAPT initiated', priority: 'high', category: 'medication', icon: '💊' }
      ],
      'mi': [
        { text: 'Serial troponins q6h x3', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Cardiology consult for cath consideration', priority: 'high', category: 'consult', icon: '👨‍⚕️' }
      ],
      'sepsis': [
        { text: 'Repeat lactate in 2-4h', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Ensure blood cultures before antibiotics', priority: 'high', category: 'labs', icon: '🧫' },
        { text: 'Fluid resuscitation 30mL/kg', priority: 'high', category: 'general', icon: '💧' },
        { text: 'Reassess antibiotic coverage at 48h', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'ckd': [
        { text: 'Avoid nephrotoxic medications', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Check electrolytes and renal panel', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Nephrology consult if new AKI on CKD', priority: 'medium', category: 'consult', icon: '👨‍⚕️' }
      ],
      'stroke': [
        { text: 'Neurology consult', priority: 'high', category: 'consult', icon: '🧠' },
        { text: 'Swallowing assessment before oral intake', priority: 'high', category: 'procedure', icon: '🏥' },
        { text: 'PT/OT evaluation', priority: 'medium', category: 'consult', icon: '🏃' },
        { text: 'Initiate secondary prevention', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'dvt': [
        { text: 'Ensure therapeutic anticoagulation', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Compression stockings', priority: 'medium', category: 'general', icon: '🧦' },
        { text: 'Repeat Doppler if symptoms worsen', priority: 'medium', category: 'imaging', icon: '📷' }
      ],
      'pe': [
        { text: 'Continuous O2 monitoring', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Therapeutic anticoagulation', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Echocardiogram for RV strain', priority: 'medium', category: 'imaging', icon: '📷' }
      ],
      'copd': [
        { text: 'Peak flow monitoring', priority: 'medium', category: 'monitoring', icon: '📊' },
        { text: 'Ensure bronchodilator availability', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Steroid taper plan', priority: 'medium', category: 'medication', icon: '💊' }
      ]
    };

    // Check diagnosis matches
    Object.entries(diagnosisSuggestions).forEach(([condition, items]) => {
      if (diagnosis.includes(condition)) {
        items.forEach(item => {
          if (!existingTasks.some(t => t.includes(item.text.toLowerCase().slice(0, 20)))) {
            suggestions.push(item);
          }
        });
      }
    });

    // Lab-triggered suggestions
    labs.forEach(param => {
      const status = param.values?.[0]?.status;
      const name = param.name?.toLowerCase();

      if (status === 'critical' || status === 'high' || status === 'low') {
        if (name?.includes('potassium') && (status === 'high' || status === 'critical')) {
          suggestions.push({
            text: 'Repeat potassium in 2-4h after treatment',
            priority: 'high', category: 'labs', icon: '🔬'
          });
          suggestions.push({
            text: 'ECG to assess for hyperkalemia changes',
            priority: 'high', category: 'procedure', icon: '💓'
          });
        }
        if (name?.includes('hemoglobin') && status === 'low') {
          suggestions.push({
            text: 'Type and screen if transfusion anticipated',
            priority: 'medium', category: 'labs', icon: '🩸'
          });
        }
        if (name?.includes('creatinine') && (status === 'high' || status === 'critical')) {
          suggestions.push({
            text: 'Review all medications for renal dosing',
            priority: 'high', category: 'medication', icon: '💊'
          });
        }
      }
    });

    // Medication-triggered suggestions
    if (meds.some(m => m?.includes('warfarin'))) {
      suggestions.push({
        text: 'Check INR daily until stable',
        priority: 'high', category: 'labs', icon: '🔬'
      });
    }
    if (meds.some(m => m?.includes('vancomycin'))) {
      suggestions.push({
        text: 'Vancomycin trough before 4th dose',
        priority: 'high', category: 'labs', icon: '🔬'
      });
    }
    if (meds.some(m => m?.includes('digoxin'))) {
      suggestions.push({
        text: 'Check digoxin level and potassium',
        priority: 'medium', category: 'labs', icon: '🔬'
      });
    }

    // General suggestions based on status
    if (patient.status === 'critical') {
      suggestions.push({
        text: 'ICU consultation for escalation of care',
        priority: 'high', category: 'consult', icon: '🚨'
      });
    }

    // Discharge planning if stable
    if (patient.status === 'stable' && !existingTasks.some(t => t.includes('discharge'))) {
      suggestions.push({
        text: 'Review discharge criteria and plan',
        priority: 'low', category: 'discharge', icon: '🏠'
      });
    }

    // Deduplicate and limit
    const unique = [];
    const seen = new Set();
    suggestions.forEach(s => {
      const key = s.text.toLowerCase().slice(0, 30);
      if (!seen.has(key)) {
        seen.add(key);
        unique.push(s);
      }
    });

    return unique.slice(0, 6);
  }
};

// Task Management Functions
window.openTaskModal = function(existingTask = null) {
  state.editingTaskId = existingTask?.id || null;

  const modalHtml = `
    <div class="modal active" id="taskModal" onclick="if(event.target===this)closeModal('taskModal')"><div class="modal-box task-modal-box"><div class="modal-header task-modal-header"><div class="task-modal-icon">📋</div><div><h3 class="modal-title">${existingTask ? 'Edit Task' : 'Add Clinical Task'}</h3><p class="modal-subtitle">For ${esc(state.currentPatient.name)}</p></div><button class="modal-close" onclick="closeModal('taskModal')">✕</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Task Description <span class="required">*</span></label><textarea id="taskText" class="form-textarea task-textarea"
                      placeholder="e.g., Check morning labs, Discuss with cardiology...">${existingTask?.text || ''}</textarea></div><div class="task-form-row"><div class="form-group"><label class="form-label">Priority</label><div class="priority-chips" id="priorityChips"><button type="button" class="priority-chip high ${existingTask?.priority === 'high' ? 'selected' : ''}" data-value="high">
                  🔴 High
                </button><button type="button" class="priority-chip medium ${(!existingTask || existingTask?.priority === 'medium') ? 'selected' : ''}" data-value="medium">
                  🟡 Medium
                </button><button type="button" class="priority-chip low ${existingTask?.priority === 'low' ? 'selected' : ''}" data-value="low">
                  🟢 Low
                </button></div></div></div><div class="task-form-row"><div class="form-group"><label class="form-label">Category</label><div class="category-chips" id="categoryChips"><button type="button" class="category-chip ${(!existingTask || existingTask?.category === 'general') ? 'selected' : ''}" data-value="general">📝 General</button><button type="button" class="category-chip ${existingTask?.category === 'labs' ? 'selected' : ''}" data-value="labs">🔬 Labs</button><button type="button" class="category-chip ${existingTask?.category === 'imaging' ? 'selected' : ''}" data-value="imaging">📷 Imaging</button><button type="button" class="category-chip ${existingTask?.category === 'medication' ? 'selected' : ''}" data-value="medication">💊 Meds</button><button type="button" class="category-chip ${existingTask?.category === 'consult' ? 'selected' : ''}" data-value="consult">👨‍⚕️ Consult</button><button type="button" class="category-chip ${existingTask?.category === 'procedure' ? 'selected' : ''}" data-value="procedure">🏥 Procedure</button><button type="button" class="category-chip ${existingTask?.category === 'monitoring' ? 'selected' : ''}" data-value="monitoring">📊 Monitor</button><button type="button" class="category-chip ${existingTask?.category === 'discharge' ? 'selected' : ''}" data-value="discharge">🏠 Discharge</button></div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button><button class="btn btn-primary" onclick="saveTask()">
            💾 ${existingTask ? 'Update' : 'Add'} Task
          </button></div></div></div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // Initialize chip handlers
  document.querySelectorAll('#priorityChips .priority-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#priorityChips .priority-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
    };
  });

  document.querySelectorAll('#categoryChips .category-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#categoryChips .category-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
    };
  });

  $('taskText').focus();
};

window.saveTask = function() {
  const text = $('taskText')?.value?.trim();
  if (!text) {
    toast('Please enter a task description', true);
    return;
  }

  const priority = document.querySelector('#priorityChips .priority-chip.selected')?.dataset.value || 'medium';
  const category = document.querySelector('#categoryChips .category-chip.selected')?.dataset.value || 'general';

  const p = state.currentPatient;
  if (!p.tasks) p.tasks = [];

  if (state.editingTaskId) {
    const task = p.tasks.find(t => t.id === state.editingTaskId);
    if (task) {
      task.text = text;
      task.priority = priority;
      task.category = category;
      task.updatedAt = new Date().toISOString();
    }
    toast('Task updated');
  } else {
    p.tasks.push({
      id: Date.now().toString(),
      text: text,
      completed: false,
      priority: priority,
      category: category,
      createdAt: new Date().toISOString(),
      createdBy: state.currentUser || 'Unknown'
    });
    toast('Task added');

    // Schedule notification for this task
    if (p.notificationsEnabled) {
      scheduleTaskNotification(p, p.tasks[p.tasks.length - 1]);
    }
  }

  saveCloud();
  closeModal('taskModal');
  renderProfilePlans();
};

window.addSuggestedTask = function(text, priority, category) {
  const p = state.currentPatient;
  if (!p.tasks) p.tasks = [];

  p.tasks.push({
    id: Date.now().toString(),
    text: text,
    completed: false,
    priority: priority,
    category: category,
    createdAt: new Date().toISOString(),
    createdBy: state.currentUser || 'Unknown',
    aiSuggested: true
  });

  saveCloud();
  renderProfilePlans();
  toast('Task added from AI suggestion');
};

window.toggleTaskComplete = function(taskId) {
  const p = state.currentPatient;
  const task = p.tasks?.find(t => t.id === taskId);
  if (!task) return;

  task.completed = !task.completed;
  task.completedAt = task.completed ? new Date().toISOString() : null;
  task.completedBy = task.completed ? (state.currentUser || 'Unknown') : null;

  saveCloud();
  renderProfilePlans();

  if (task.completed) {
    toast('✓ Task completed');
  }
};

window.editTask = function(taskId) {
  const task = state.currentPatient.tasks?.find(t => t.id === taskId);
  if (task) openTaskModal(task);
};

window.deleteTask = function(taskId) {
  if (!confirm('Delete this task?')) return;

  const p = state.currentPatient;
  p.tasks = p.tasks.filter(t => t.id !== taskId);
  saveCloud();
  renderProfilePlans();
  toast('Task deleted');
};

window.toggleCompletedTasks = function() {
  const list = $('completedTasksList');
  const icon = $('completedExpandIcon');
  if (list.style.display === 'none') {
    list.style.display = 'block';
    icon.textContent = '▲';
  } else {
    list.style.display = 'none';
    icon.textContent = '▼';
  }
};

// Notification System
window.togglePlanNotifications = async function(enabled) {
  const p = state.currentPatient;
  p.notificationsEnabled = enabled;
  saveCloud();

  if (enabled) {
    const permission = await requestNotificationPermission();
    if (permission) {
      toast('🔔 Notifications enabled');
      checkPendingTaskNotifications(p);
    } else {
      toast('Please enable notifications in browser settings', true);
      p.notificationsEnabled = false;
      $('planNotifyToggle').checked = false;
      saveCloud();
    }
  } else {
    toast('Notifications disabled');
  }
};

async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    console.log('Notifications not supported');
    return false;
  }

  if (Notification.permission === 'granted') return true;

  const permission = await Notification.requestPermission();
  return permission === 'granted';
}

function checkPendingTaskNotifications(patient) {
  if (!patient.notificationsEnabled) return;
  if (!('Notification' in window) || Notification.permission !== 'granted') return;

  const pendingTasks = (patient.tasks || []).filter(t => !t.completed);
  const highPriorityTasks = pendingTasks.filter(t => t.priority === 'high');

  // Store last notification time to avoid spam
  const lastNotified = localStorage.getItem(`lastTaskNotify_${patient.id}`);
  const now = Date.now();

  // Only notify every 30 minutes minimum
  if (lastNotified && (now - parseInt(lastNotified)) < 30 * 60 * 1000) return;

  if (highPriorityTasks.length > 0) {
    sendTaskNotification(patient, highPriorityTasks);
    localStorage.setItem(`lastTaskNotify_${patient.id}`, now.toString());
  }
}

function scheduleTaskNotification(patient, task) {
  if (!patient.notificationsEnabled) return;

  // For high priority tasks, notify after 15 minutes if not done
  if (task.priority === 'high') {
    setTimeout(() => {
      const currentTask = state.currentPatient?.tasks?.find(t => t.id === task.id);
      if (currentTask && !currentTask.completed) {
        sendSingleTaskNotification(patient, task);
      }
    }, 15 * 60 * 1000);
  }
}

function sendTaskNotification(patient, tasks) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;

  const notification = new Notification(`MedWard: ${patient.name}`, {
    body: `${tasks.length} urgent task${tasks.length > 1 ? 's' : ''} pending:\n• ${tasks[0].text}${tasks.length > 1 ? `\n• +${tasks.length - 1} more` : ''}`,
    icon: '📋',
    tag: `tasks-${patient.id}`,
    requireInteraction: true,
    vibrate: [200, 100, 200]
  });

  notification.onclick = function() {
    window.focus();
    if (state.currentPatient?.id !== patient.id) {
      const p = state.patients.find(pt => pt.id === patient.id);
      if (p) {
        state.currentPatient = p;
        state.activeTab = 'plans';
        showPatientProfile();
      }
    }
    notification.close();
  };
}

function sendSingleTaskNotification(patient, task) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;

  new Notification(`MedWard: Reminder`, {
    body: `Urgent task for ${patient.name}:\n${task.text}`,
    icon: '🔴',
    tag: `task-${task.id}`,
    vibrate: [200, 100, 200]
  });
}

// Completion Celebration
function showPlanCompletionCelebration(patient) {
  const celebrationHtml = `
    <div class="celebration-overlay" id="celebrationOverlay" onclick="closeCelebration()"><div class="celebration-content" onclick="event.stopPropagation()"><div class="celebration-confetti">🎉</div><div class="celebration-badge"><div class="badge-ring"></div><div class="badge-icon">✓</div></div><h2 class="celebration-title">Outstanding Work!</h2><p class="celebration-subtitle">All clinical tasks completed for</p><div class="celebration-patient">${esc(patient.name)}</div><div class="celebration-stats"><div class="celeb-stat"><span class="celeb-stat-value">${patient.tasks?.length || 0}</span><span class="celeb-stat-label">Tasks Completed</span></div><div class="celeb-stat"><span class="celeb-stat-value">${patient.tasks?.filter(t => t.priority === 'high').length || 0}</span><span class="celeb-stat-label">High Priority</span></div></div><div class="celebration-message"><span class="msg-icon">🏆</span><span>Clinical excellence achieved. Ready for review or discharge planning.</span></div><button class="celebration-btn" onclick="closeCelebration()">Continue</button></div></div>
  `;

  document.body.insertAdjacentHTML('beforeend', celebrationHtml);

  // Trigger confetti animation
  setTimeout(() => {
    const overlay = $('celebrationOverlay');
    if (overlay) overlay.classList.add('show');
  }, 50);

  // Send congratulations notification
  if (patient.notificationsEnabled && Notification.permission === 'granted') {
    new Notification('MedWard: Excellent Work! 🏆', {
      body: `All tasks completed for ${patient.name}. Clinical plan achieved!`,
      icon: '🎉'
    });
  }
}

window.closeCelebration = function() {
  const overlay = $('celebrationOverlay');
  if (overlay) {
    overlay.classList.remove('show');
    setTimeout(() => overlay.remove(), 300);
  }
};

window.deletePlan = function(idx) {
  if (!confirm('Delete?')) return;
  state.currentPatient.plans.splice(idx, 1);
  saveCloud();
  renderProfilePlans();
};

// DATA MODALS

window.openEditText = function(type, title) {
  $('editTextTitle').textContent = 'Edit ' + title;
  $('editTextType').value = type;
  $('editTextArea').value = state.currentPatient[type] || '';
  openModal('editTextModal');
};

window.saveEditText = function() {
  state.currentPatient[$('editTextType').value] = $('editTextArea').value;
  saveCloud();
  renderPatientProfile();
  closeModal('editTextModal');
  toast('Saved!');
};

window.openAddVitals = function() {
  state.addDataType = 'vitals';
  $('addDataTitle').textContent = 'Update Vitals';
  const v = state.currentPatient.vitals || {};
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div class="form-group"><label class="form-label">Heart Rate</label><input type="text" id="addHR" class="form-input" value="${v.hr || ''}"></div><div class="form-group"><label class="form-label">Blood Pressure</label><input type="text" id="addBP" class="form-input" value="${v.bp || ''}" placeholder="120/80"></div><div class="form-group"><label class="form-label">Temperature</label><input type="text" id="addTemp" class="form-input" value="${v.temp || ''}"></div><div class="form-group"><label class="form-label">Respiratory Rate</label><input type="text" id="addRR" class="form-input" value="${v.rr || ''}"></div><div class="form-group"><label class="form-label">SpO₂</label><input type="text" id="addSpO2" class="form-input" value="${v.spo2 || ''}"></div></div>
  `;
  openModal('addDataModal');
};

window.openAddFluid = function() {
  state.addDataType = 'fluid';
  $('addDataTitle').textContent = 'Add Fluid Entry';
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div class="form-group"><label class="form-label">Intake (mL)</label><input type="number" id="addIntake" class="form-input" value="0"></div><div class="form-group"><label class="form-label">Output (mL)</label><input type="number" id="addOutput" class="form-input" value="0"></div></div>
  `;
  openModal('addDataModal');
};

window.openAddPlan = function() {
  openTaskModal();
};

window.saveAddData = function() {
  const p = state.currentPatient;
  const type = state.addDataType;
  const now = new Date().toISOString();

  if (type === 'vitals') {
    p.vitals = { hr: $('addHR').value, bp: $('addBP').value, temp: $('addTemp').value, rr: $('addRR').value, spo2: $('addSpO2').value };
  } else if (type === 'fluid') {
    if (!p.fluids) p.fluids = [];
    p.fluids.push({ date: now, intake: parseInt($('addIntake').value) || 0, output: parseInt($('addOutput').value) || 0 });
  } else if (type === 'plan') {
    if (!p.plans) p.plans = [];
    p.plans.push({ date: now, content: $('addPlanContent').value });
  }

  saveCloud();
  renderPatientProfile();
  closeModal('addDataModal');
  toast('Saved!');
};

window.editCurrentPatient = function() {
  const p = state.currentPatient;
  $('patientModalTitle').textContent = 'Edit Patient';
  $('ptId').value = p.id;
  $('ptName').value = p.name;
  $('ptWard').value = p.ward;
  $('ptRoom').value = p.room || '';
  $('ptDx').value = p.diagnosis || '';
  $('ptDoctor').value = p.doctor || '';
  $('ptStatus').value = p.status;
  openModal('patientModal');
};

window.deleteCurrentPatient = function() {
  if (!confirm('Delete patient?')) return;
  state.patients = state.patients.filter(p => p.id !== state.currentPatient.id);
  saveCloud();
  closePatientProfile();
  toast('Deleted');
};

// UNIT ACCESS & AUTH

function openUnitAccess(id) {
  const u = getUnit(id);
  if (!u) return;
  state.selectedUnitId = id;
  $('accessIcon').textContent = u.icon;
  $('accessTitle').textContent = u.name;
  $('codeError').classList.remove('show');
  $('userSection').style.display = 'none';
  $('enterBtn').style.display = 'none';
  $('codeInputs').innerHTML = [0,1,2,3].map(i => `<input type="tel" class="code-digit" maxlength="1" data-idx="${i}" inputmode="numeric">`).join('');

  const inputs = $$('.code-digit');
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', () => {
      inp.value = inp.value.replace(/\D/g, '');
      if (inp.value && idx < 3) inputs[idx + 1].focus();
      const code = Array.from(inputs).map(i => i.value).join('');
      if (code.length === 4) {
        if (code === u.code) {
          inputs.forEach(i => { i.classList.add('success'); i.disabled = true; });
          $('userSection').style.display = 'block';
          $('enterBtn').style.display = 'flex';
          $('userName').focus();
        } else {
          $('codeError').classList.add('show');
          inputs.forEach(i => i.classList.add('error'));
          setTimeout(() => { inputs.forEach(i => { i.classList.remove('error'); i.value = ''; }); inputs[0].focus(); }, 500);
        }
      }
    });
    inp.addEventListener('keydown', e => { if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus(); });
  });

  openModal('accessModal');
  setTimeout(() => inputs[0].focus(), 100);
}

window.enterUnit = function() {
  const n = $('userName').value.trim();
  if (!n) { toast('Enter name', true); return; }
  state.currentUnit = getUnit(state.selectedUnitId);
  state.currentUser = { name: n, role: $('userRole').value };
  closeModal('accessModal');
  showPage('dashboard');
  $('unitBadge').textContent = state.currentUnit.name;
  $('dashAvatar').textContent = initials(state.currentUser.name);
  $('currentDate').textContent = formatDate();
  renderPatients();
  renderRef();
  toast(`Welcome, ${state.currentUser.name}!`);
};

window.logout = function() {
  state.currentUnit = null;
  state.currentUser = null;
  state.currentFilter = 'all';
  showPage('landing');
};

function showTab(tabName) {
  $$('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add('active');
  $$('.panel').forEach(p => p.classList.remove('active'));
  $('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

function showProfileTab(tabName) {
  // Update mobile tabs
  $$('.profile-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-tab[data-ptab="${tabName}"]`)?.classList.add('active');
  // Update sidebar navigation
  $$('.profile-nav-item').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-nav-item[data-ptab="${tabName}"]`)?.classList.add('active');
  // Show panel
  $$('.profile-panel').forEach(p => p.classList.remove('active'));
  $('profile' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
  // Update badges if needed
  updateProfileBadges();
}

function updateProfileBadges() {
  const p = state.currentPatient;
  if (!p) return;
  // Labs badge - show if critical values
  const labsBadge = $('labsAlertBadge');
  if (labsBadge) {
    const hasCritical = p.labData?.parameters?.some(param =>
      param.values?.[0]?.status === 'critical' || param.values?.[0]?.status === 'high'
    );
    labsBadge.style.display = hasCritical ? 'inline' : 'none';
  }
  // Plans badge - show pending task count
  const plansBadge = $('plansTaskBadge');
  if (plansBadge) {
    const pendingCount = (p.tasks || []).filter(t => !t.completed).length;
    plansBadge.textContent = pendingCount;
    plansBadge.style.display = pendingCount > 0 ? 'inline' : 'none';
  }
}

// Admin functions
window.openAdminLogin = function() { $('adminPwd').value = ''; $('adminError').classList.remove('show'); openModal('adminModal'); };
window.loginAdmin = function() { if ($('adminPwd').value === state.settings.adminPassword) { closeModal('adminModal'); showPage('adminPanel'); $('apiUrl').value = state.settings.apiUrl || ''; $('drugRefUrl').value = state.settings.drugRefUrl || ''; renderUnitsTable(); loadUnitRequests(); } else $('adminError').classList.add('show'); };
window.exitAdmin = function() { showPage('landing'); };
window.addUnit = function() { state.editingUnitId = null; $('unitModalTitle').textContent = 'Add Unit'; $('uName').value = ''; $('uIcon').value = '🏥'; $('uCode').value = ''; $('uDesc').value = ''; openModal('unitModal'); };
window.editUnit = function(id) { const u = getUnit(id); if (!u) return; state.editingUnitId = id; $('unitModalTitle').textContent = 'Edit Unit'; $('uName').value = u.name; $('uIcon').value = u.icon; $('uCode').value = u.code; $('uDesc').value = u.desc || ''; openModal('unitModal'); };
window.saveUnit = function() { const name = $('uName').value.trim(), icon = $('uIcon').value.trim() || '🏥', code = $('uCode').value.trim(), desc = $('uDesc').value.trim(); if (!name || !/^\d{4}$/.test(code)) { toast('Invalid', true); return; } if (state.editingUnitId) { const i = state.units.findIndex(u => u.id === state.editingUnitId); if (i !== -1) state.units[i] = { ...state.units[i], name, icon, code, desc }; } else { state.units.push({ id: 'u' + Date.now(), name, icon, code, desc, color: ['#f59e0b', '#14b8a6', '#3b82f6', '#8b5cf6'][state.units.length % 4] }); } saveCloud(); renderUnitsTable(); renderUnits(); closeModal('unitModal'); toast('Saved!'); };
window.deleteUnit = function(id) { if (!confirm('Delete?')) return; state.units = state.units.filter(u => u.id !== id); saveCloud(); renderUnitsTable(); renderUnits(); };
window.saveSettings = function() { const p = $('newAdminPwd').value.trim(), u = $('apiUrl').value.trim(), d = $('drugRefUrl').value.trim(); if (p) state.settings.adminPassword = p; if (u) state.settings.apiUrl = u; state.settings.drugRefUrl = d; saveCloud(); toast('Saved!'); $('newAdminPwd').value = ''; };

// Admin Tab Navigation
$('adminTabs')?.addEventListener('click', e => {
  const tab = e.target.closest('.admin-tab');
  if (!tab) return;
  $$('.admin-tab').forEach(t => t.classList.remove('active'));
  $$('.admin-tab-panel').forEach(p => p.classList.remove('active'));
  tab.classList.add('active');
  const panelId = 'admin' + tab.dataset.atab.charAt(0).toUpperCase() + tab.dataset.atab.slice(1);
  $(panelId)?.classList.add('active');
});

// UNIT REQUEST SYSTEM

window.openRequestUnit = function() {
  // Reset form
  $('reqName').value = '';
  $('reqEmail').value = '';
  $('reqDepartment').value = '';
  $('reqRole').value = '';
  $('reqUnitName').value = '';
  $('reqMessage').value = '';
  state.selectedIcon = '🏥';

  // Reset icon selection
  $$('.request-icon-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelector('.request-icon-option[data-icon="🏥"]')?.classList.add('selected');

  // Show form, hide success
  $('requestFormSection').style.display = 'block';
  $('requestSuccessSection').style.display = 'none';
  $('requestFormFooter').style.display = 'flex';
  $('requestSuccessFooter').style.display = 'none';

  openModal('requestUnitModal');
};

// Icon selection
$('iconGrid')?.addEventListener('click', e => {
  const opt = e.target.closest('.request-icon-option');
  if (!opt) return;
  $$('.request-icon-option').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  state.selectedIcon = opt.dataset.icon;
});

window.submitUnitRequest = async function() {
  const name = $('reqName').value.trim();
  const email = $('reqEmail').value.trim();
  const department = $('reqDepartment').value.trim();
  const role = $('reqRole').value;
  const unitName = $('reqUnitName').value.trim();
  const message = $('reqMessage').value.trim();
  const icon = state.selectedIcon;

  // Validation
  if (!name || !email || !department || !role || !unitName) {
    toast('Please fill all required fields', true);
    return;
  }

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    toast('Please enter a valid email', true);
    return;
  }

  const requestId = 'REQ-' + Date.now().toString(36).toUpperCase();
  const request = {
    id: requestId,
    timestamp: new Date().toISOString(),
    status: 'pending',
    requesterName: name,
    requesterEmail: email,
    department,
    role,
    unitName,
    icon,
    message
  };

  // Try to save to cloud if API is configured
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'submitUnitRequest', request })
      });
    } catch (e) {
      console.error('Failed to save request to cloud:', e);
    }
  }

  // Also save locally
  if (!state.unitRequests) state.unitRequests = [];
  state.unitRequests.push(request);
  saveLocal();

  // Show success
  $('requestIdDisplay').textContent = 'Request ID: ' + requestId;
  $('requestFormSection').style.display = 'none';
  $('requestSuccessSection').style.display = 'block';
  $('requestFormFooter').style.display = 'none';
  $('requestSuccessFooter').style.display = 'flex';

  toast('Request submitted successfully!');
};

async function loadUnitRequests() {
  // Load from cloud if possible
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getUnitRequests' })
      });
      const data = await res.json();
      if (data.success && data.requests) {
        state.unitRequests = data.requests;
      }
    } catch (e) {
      console.error('Failed to load requests:', e);
    }
  }

  renderUnitRequests();
}

window.refreshRequests = loadUnitRequests;

function renderUnitRequests() {
  const pending = (state.unitRequests || []).filter(r => r.status === 'pending');
  const processed = (state.unitRequests || []).filter(r => r.status !== 'pending');

  // Update badge
  const badge = $('requestsCount');
  if (pending.length > 0) {
    badge.textContent = pending.length;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }

  if (!state.unitRequests?.length) {
    $('requestsList').innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:2rem;margin-bottom:12px">📭</div><div>No unit requests yet</div></div>
    `;
    return;
  }

  const formatDate = iso => new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };

  let html = '';

  // Pending first
  pending.forEach(req => {
    html += `
      <div class="request-card" data-id="${req.id}"><div class="request-card-time">${formatDate(req.timestamp)}</div><div class="request-card-header"><div class="request-card-title">${req.icon || '🏥'} ${esc(req.unitName)}</div><span class="request-card-status pending">Pending</span></div><div class="request-card-details"><div class="request-card-detail">👤 ${esc(req.requesterName)}</div><div class="request-card-detail">📧 ${esc(req.requesterEmail)}</div><div class="request-card-detail">🏥 ${esc(req.department)}</div><div class="request-card-detail">👔 ${roleLabels[req.role] || req.role}</div></div>
        ${req.message ? `<div class="request-card-message">"${esc(req.message)}"</div>` : ''}
        <div class="request-card-actions"><button class="btn btn-primary btn-sm" onclick="openApproveRequest('${req.id}')">✅ Review & Approve</button><button class="btn btn-danger btn-sm" onclick="quickRejectRequest('${req.id}')">❌ Reject</button></div></div>
    `;
  });

  // Processed (collapsed)
  if (processed.length > 0) {
    html += `<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><h4 style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">📋 Previous Requests (${processed.length})</h4>`;
    processed.slice(0, 10).forEach(req => {
      html += `
        <div class="request-card ${req.status}"><div class="request-card-time">${formatDate(req.timestamp)}</div><div class="request-card-header"><div class="request-card-title">${req.icon || '🏥'} ${esc(req.unitName)}</div><span class="request-card-status ${req.status}">${req.status === 'approved' ? 'Approved' : 'Rejected'}</span></div><div class="request-card-details"><div class="request-card-detail">👤 ${esc(req.requesterName)}</div><div class="request-card-detail">📧 ${esc(req.requesterEmail)}</div></div>
          ${req.assignedCode ? `<div style="margin-top:8px;font-size:0.85rem;color:var(--emerald)">Access Code: <code style="background:var(--bg-card);padding:4px 8px;border-radius:4px">${req.assignedCode}</code></div>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }

  $('requestsList').innerHTML = html;
}

window.openApproveRequest = function(requestId) {
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;

  state.selectedRequestId = requestId;

  // Pre-fill form
  $('approveUnitName').value = req.unitName;
  $('approveUnitIcon').value = req.icon || '🏥';
  $('approveUnitCode').value = '';
  $('approveUnitDesc').value = req.department;

  // Show request details
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  $('approveRequestDetails').innerHTML = `
    <div style="background:var(--bg);padding:20px;border-radius:var(--radius-sm);margin-bottom:16px"><div style="display:flex;align-items:center;gap:16px;margin-bottom:16px"><div style="font-size:2.5rem">${req.icon || '🏥'}</div><div><div style="font-weight:700;font-size:1.1rem">${esc(req.unitName)}</div><div style="color:var(--text-muted);font-size:0.85rem">Requested ${new Date(req.timestamp).toLocaleDateString()}</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem"><div><span style="color:var(--text-muted)">Requester:</span> ${esc(req.requesterName)}</div><div><span style="color:var(--text-muted)">Email:</span> ${esc(req.requesterEmail)}</div><div><span style="color:var(--text-muted)">Department:</span> ${esc(req.department)}</div><div><span style="color:var(--text-muted)">Role:</span> ${roleLabels[req.role] || req.role}</div></div>
      ${req.message ? `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:0.9rem"><span style="color:var(--text-muted)">Message:</span><br>"${esc(req.message)}"</div>` : ''}
    </div>
  `;

  openModal('approveRequestModal');
};

window.approveRequest = async function() {
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;

  const unitName = $('approveUnitName').value.trim();
  const icon = $('approveUnitIcon').value.trim() || '🏥';
  const code = $('approveUnitCode').value.trim();
  const color = $('approveUnitColor').value;
  const desc = $('approveUnitDesc').value.trim();

  if (!unitName || !/^\d{4}$/.test(code)) {
    toast('Please enter a valid unit name and 4-digit code', true);
    return;
  }

  // Create the unit
  const newUnit = {
    id: 'u' + Date.now(),
    name: unitName,
    icon,
    code,
    desc,
    color
  };

  state.units.push(newUnit);

  // Update request status
  req.status = 'approved';
  req.assignedCode = code;
  req.approvedAt = new Date().toISOString();

  // Save everything
  await saveCloud();

  // Also save request update to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }

  saveLocal();
  renderUnitsTable();
  renderUnits();
  renderUnitRequests();
  closeModal('approveRequestModal');

  toast(`Unit "${unitName}" created with code ${code}!`);
};

window.rejectRequest = async function() {
  if (!confirm('Are you sure you want to reject this request?')) return;

  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;

  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();

  // Save to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }

  saveLocal();
  renderUnitRequests();
  closeModal('approveRequestModal');
  toast('Request rejected');
};

window.quickRejectRequest = async function(requestId) {
  if (!confirm('Reject this request?')) return;

  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;

  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();

  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {}
  }

  saveLocal();
  renderUnitRequests();
  toast('Request rejected');
};

// Patient CRUD
window.openAddPatient = function() { $('patientModalTitle').textContent = 'Add Patient'; $('ptId').value = ''; $('ptName').value = ''; $('ptWard').value = 'Ward 14'; $('ptRoom').value = ''; $('ptDx').value = ''; $('ptDoctor').value = state.currentUser?.name || ''; $('ptStatus').value = 'new'; openModal('patientModal'); };
window.savePatient = function() { const id = $('ptId').value, name = $('ptName').value.trim(); if (!name) { toast('Name required', true); return; } const data = { name, ward: $('ptWard').value, room: $('ptRoom').value.trim() || '—', diagnosis: $('ptDx').value.trim() || 'Pending', doctor: $('ptDoctor').value.trim() || 'Unassigned', status: $('ptStatus').value }; if (id) { const i = state.patients.findIndex(p => p.id === parseInt(id)); if (i !== -1) { state.patients[i] = { ...state.patients[i], ...data }; if (state.currentPatient?.id === parseInt(id)) { state.currentPatient = state.patients[i]; renderPatientProfile(); } } } else { state.patients.push({ id: Date.now(), ...data, labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {} }); } saveCloud(); renderPatients(); closeModal('patientModal'); toast('Saved!'); };

// Import
window.openImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; openModal('importModal'); };
window.resetImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; };
window.extractPatients = async function() {
  if (!state.importImage) { toast('No image selected', true); return; }
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') { toast('API URL not configured. Go to Admin settings.', true); return; }

  $('importPreview').style.display = 'none';
  $('importLoading').style.display = 'block';
  $('importError').style.display = 'none';

    console.log('📡 API:', state.settings.apiUrl.substring(0, 50) + '...');
  console.log('🖼️ Image size:', Math.round(state.importImage.length / 1024), 'KB');

  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'extractPatients', image: state.importImage })
    });

    if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);

    const d = await res.json();
    console.log('📦 Response:', d);

    $('importLoading').style.display = 'none';

    if (!d.success) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = d.error || 'API returned an error';
      console.error('❌ API Error:', d.error);
      return;
    }

    if (!d.patients?.length) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = 'No patients found in image. Try a clearer screenshot.';
      return;
    }

    state.importPatients = d.patients.map((p, i) => ({
      id: Date.now() + i, name: p.name, ward: smartWard(p.ward), room: p.room || '—',
      diagnosis: p.diagnosis || 'Pending', doctor: p.doctor || state.currentUser?.name || 'Unassigned',
      status: p.status === 'chronic' ? 'chronic' : 'active',
      labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {}
    }));

    $('importResults').style.display = 'block';
    $('importCount').textContent = state.importPatients.length;
    $('importList').innerHTML = state.importPatients.map(p => `<div class="import-item"><div style="flex:1"><b>${esc(p.name)}</b><div style="font-size:0.75rem;color:var(--text-muted)">${esc(p.room)}</div></div><select class="import-ward-select" onchange="state.importPatients.find(x=>x.id===${p.id}).ward=this.value">${CONFIG.VALID_WARDS.map(w => `<option value="${w}" ${w === p.ward ? 'selected' : ''}>${w}</option>`).join('')}</select></div>`).join('');
    $('importConfirmBtn').disabled = false;

        toast('Found ' + state.importPatients.length + ' patients!');

  } catch (e) {
    console.error('❌ Extract error:', e);
    $('importLoading').style.display = 'none';
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = e.message || 'Connection failed';
  }
};
window.confirmImport = function() { if (!state.importPatients.length) return; let added = 0; state.importPatients.forEach(p => { if (!state.patients.some(ep => ep.name.toLowerCase() === p.name.toLowerCase())) { state.patients.push(p); added++; } }); saveCloud(); renderPatients(); closeModal('importModal'); toast(`Imported ${added}!`); };
window.exportPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); const pts = state.currentFilter === 'all' ? [...state.patients] : state.patients.filter(p => p.status === state.currentFilter); if (!pts.length) { toast('No patients', true); return; } doc.setFillColor(245, 158, 11); doc.rect(0, 0, 297, 18, 'F'); doc.setFontSize(16); doc.setTextColor(0); doc.text(state.currentUnit.name + ' - Patient Report', 14, 12); doc.text(formatDate(), 283, 12, 'right'); let y = 28; const wards = {}; pts.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); }); Object.keys(wards).forEach(ward => { if (y > 185) { doc.addPage(); y = 15; } doc.setFillColor(20, 184, 166); doc.rect(14, y, 269, 7, 'F'); doc.setFontSize(9); doc.setTextColor(255); doc.text(ward + ' (' + wards[ward].length + ')', 16, y + 5); y += 10; wards[ward].forEach(p => { if (y > 190) { doc.addPage(); y = 15; } doc.setFillColor(248, 250, 252); doc.rect(14, y, 269, 10, 'F'); doc.setFontSize(8); doc.setTextColor(30); doc.text(p.room || '—', 16, y + 6); doc.text(p.name, 40, y + 6); doc.text((p.diagnosis || '').substring(0, 60), 100, y + 6); doc.text(p.doctor || '', 220, y + 6); y += 12; }); y += 5; }); doc.save(state.currentUnit.name.replace(/\s+/g, '_') + '_Report.pdf'); toast('PDF exported!'); };

// WARD SUGGESTIONS (MANUAL INPUT)

window.showWardSuggestions = function(value) {
  const container = $('wardSuggestions');
  if (!container) return;
  const query = (value || '').toLowerCase().trim();

  const commonWards = ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'CCU', 'ER/Unassigned', 'MICU', 'SICU', 'Neuro ICU', 'Cardiac Ward', 'Medical Ward', 'Surgical Ward'];

  if (!query) {
    container.innerHTML = commonWards.map(w =>
      `<div class="ward-suggestion" onclick="selectWard('${w}')">${w}</div>`
    ).join('');
    container.classList.add('show');
    return;
  }

  const filtered = commonWards.filter(w =>
    w.toLowerCase().includes(query) ||
    w.replace(/\D/g, '').includes(query.replace(/\D/g, ''))
  );

  if (filtered.length > 0) {
    container.innerHTML = filtered.map(w =>
      `<div class="ward-suggestion" onclick="selectWard('${w}')">${w}</div>`
    ).join('');
    if (value && !filtered.some(w => w.toLowerCase() === query)) {
      container.innerHTML += `<div class="ward-suggestion" onclick="selectWard('${esc(value)}')" style="color:var(--gold);border-top:1px solid var(--border)">Use: "${esc(value)}"</div>`;
    }
    container.classList.add('show');
  } else {
    container.innerHTML = `<div class="ward-suggestion" onclick="selectWard('${esc(value)}')" style="color:var(--gold)">Use: "${esc(value)}"</div>`;
    container.classList.add('show');
  }
};

window.selectWard = function(ward) {
  $('ptWard').value = ward;
  const container = $('wardSuggestions');
  if (container) container.classList.remove('show');
};

// Hide ward suggestions on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.ward-input-wrapper')) {
    const c = $('wardSuggestions');
    if (c) c.classList.remove('show');
  }
});

// DISCHARGE FUNCTIONALITY

window.openDischargeModal = function(patientId, event) {
  if (event) event.stopPropagation();
  const p = getPatient(patientId);
  if (!p) return;
  if (p.status === 'discharged') {
    toast('Patient already discharged', true);
    return;
  }
  state.dischargePatientId = patientId;
  $('dischargePatientName').textContent = p.name;
  $('dischargeSummary').value = '';
  openModal('dischargeModal');
};

window.confirmDischarge = function() {
  const p = getPatient(state.dischargePatientId);
  if (!p) return;

  const summary = $('dischargeSummary').value.trim();
  p.status = 'discharged';
  p.dischargeDate = new Date().toISOString();

  if (summary) {
    if (!p.plans) p.plans = [];
    p.plans.push({ date: new Date().toISOString(), content: `🏠 DISCHARGE SUMMARY:\n${summary}` });
  }

  saveCloud();
  renderPatients();
  closeModal('dischargeModal');
  toast('Patient discharged');

  if (state.currentPatient && state.currentPatient.id === p.id) {
    renderPatientProfile();
  }
};

// LAB OVERRIDE FUNCTIONALITY

window.openLabOverride = function(paramIdx, valueIdx) {
  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]) return;

  const param = p.labData.parameters[paramIdx];
  const value = param.values?.[valueIdx];

  $('labOverrideName').textContent = `${param.name} (${param.unit || ''})`;
  $('labOverrideValue').value = value?.value || '';
  $('labOverrideParamIdx').value = paramIdx;
  $('labOverrideValueIdx').value = valueIdx;

  openModal('labOverrideModal');
};

window.saveLabOverride = function() {
  const paramIdx = parseInt($('labOverrideParamIdx').value);
  const valueIdx = parseInt($('labOverrideValueIdx').value);
  const newValue = $('labOverrideValue').value.trim();

  if (!newValue) { toast('Please enter a value', true); return; }

  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]?.values?.[valueIdx]) {
    toast('Lab value not found', true);
    return;
  }

  const param = p.labData.parameters[paramIdx];
  param.values[valueIdx].value = parseFloat(newValue) || newValue;
  param.values[valueIdx].manualOverride = true;
  param.values[valueIdx].overrideDate = new Date().toISOString();

  // Re-evaluate status
  const numVal = parseFloat(newValue);
  if (!isNaN(numVal) && param.refMin !== undefined && param.refMax !== undefined) {
    if (numVal < param.refMin) param.values[valueIdx].status = 'low';
    else if (numVal > param.refMax) param.values[valueIdx].status = 'high';
    else param.values[valueIdx].status = 'normal';
  }

  saveCloud();
  renderProfileLabs();
  closeModal('labOverrideModal');
  toast('Lab value updated');
};

// INIT - "Render First, Sync Later" Pattern

async function init() {
  try {
    // 1. CRITICAL: Load and render local data IMMEDIATELY (0ms delay)
    loadLocal();

    // 2. Render the UI right away with whatever we have
    renderUnits();
    renderScoresGrid();
    renderRef();

    // If user was in a unit, render patients immediately
    if (state.currentUnit) {
            renderPatients();
    }

    // 3. Setup Event Listeners
    $('adminFab').onclick = openAdminLogin;
    $('syncFab').onclick = manualSync;
    $('adminPwd').onkeydown = e => { if (e.key === 'Enter') loginAdmin(); };
    $('userName').onkeydown = e => { if (e.key === 'Enter') enterUnit(); };
    $('mainTabs').onclick = e => { const t = e.target.closest('.tab'); if (t) showTab(t.dataset.tab); };
    $('profileTabs').onclick = e => { const t = e.target.closest('.profile-tab'); if (t) showProfileTab(t.dataset.ptab); };
    $('profileSidebar').onclick = e => { const t = e.target.closest('.profile-nav-item'); if (t) showProfileTab(t.dataset.ptab); };
    $('statsBar').onclick = e => { const s = e.target.closest('.stat-card'); if (s) { state.currentFilter = s.dataset.filter; renderPatients(); } };

    $('labFileInput').onchange = function() { if (this.files[0]) handleLabUpload(this.files[0]); this.value = ''; };
    $('imagingFileInput').onchange = function() { if (this.files[0]) handleImagingUpload(this.files[0]); this.value = ''; };
    $('importFile').onchange = function() { if (this.files[0]) { compress(this.files[0], CONFIG.MAX_IMAGE_SIZE, url => { state.importImage = url; $('importImg').src = url; $('importUpload').style.display = 'none'; $('importPreview').style.display = 'block'; }); } };

    $$('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.classList.remove('active'); });

    // 4. Background Cloud Sync (Don't block the UI)
    try {
      await syncFromCloud();
      // syncFromCloud already triggers re-render on success
    } catch (syncError) {
      console.warn('⚠️ Background sync failed:', syncError);
      toast('Offline Mode: Using local data', false);
      // No need to render - we already did it above
    }

    // 5. Periodic background sync (every 60 seconds)
    setInterval(() => {
      if (!syncState.pendingChanges) {
        syncFromCloud().catch(e => console.warn('Auto-sync failed:', e));
      }
    }, 60000);

  } catch (criticalError) {
    console.error('❌ Critical Init Error:', criticalError);
    toast('System Error - Check Console', true);
  }
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();

})();
</script></body></html>
