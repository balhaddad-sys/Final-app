<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>MedWard Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
:root{--bg:#060a13;--bg-card:#0d1424;--bg-elevated:#111b2e;--bg-input:#0f172a;--text:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;--gold:#d4a437;--gold-light:#fbbf24;--gold-glow:rgba(212,164,55,0.15);--teal:#14b8a6;--blue:#3b82f6;--purple:#8b5cf6;--rose:#f43f5e;--orange:#f97316;--emerald:#10b981;--lime:#84cc16;--border:rgba(148,163,184,0.12);--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;-webkit-tap-highlight-color:transparent}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border:none;border-radius:var(--radius);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn:active{transform:scale(0.98)}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg)}
.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text)}
.btn-danger{background:rgba(244,63,94,0.15);border:1px solid var(--rose);color:var(--rose)}
.btn-export{background:rgba(16,185,129,0.15);border:1px solid var(--emerald);color:var(--emerald)}
.btn-sm{padding:8px 14px;font-size:0.8rem}
.btn-xs{padding:6px 10px;font-size:0.7rem}
.btn-full{width:100%}
.btn-icon{width:40px;height:40px;padding:0;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer;display:grid;place-items:center}
.form-group{margin-bottom:18px}
.form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:inherit;font-size:0.9rem}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--gold)}
.form-textarea{min-height:80px;resize:vertical}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;border-bottom:1px solid var(--border)}
.modal-title{font-size:1.15rem;font-weight:700}
.modal-body{padding:20px}
.modal-footer{padding:16px 20px 20px;display:flex;gap:12px}
.modal-footer .btn{flex:1}
#landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
#landing.hidden{display:none}
.landing-logo{width:80px;height:80px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:20px;display:grid;place-items:center;margin-bottom:24px;box-shadow:0 8px 32px rgba(212,164,55,0.25)}
.landing-logo svg{width:44px;height:44px;stroke:var(--bg);stroke-width:2.5;fill:none}
.landing-title{font-size:1.8rem;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.landing-subtitle{color:var(--text-secondary);margin-bottom:40px}
.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;width:100%;max-width:800px}
.unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--gold))}
.unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-2px)}
.unit-card-icon{font-size:2rem;margin-bottom:12px}
.unit-card-name{font-size:1.05rem;font-weight:600;margin-bottom:2px}
.unit-card-desc{color:var(--text-muted);font-size:0.75rem}
.fab{position:fixed;width:50px;height:50px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50;transition:all 0.3s}
.fab svg{width:20px;height:20px}
.fab:hover{border-color:var(--gold);color:var(--gold)}
.admin-fab{bottom:20px;right:20px}
.sync-fab{bottom:20px;left:20px}
.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}
@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.code-inputs{display:flex;gap:10px;justify-content:center;margin-bottom:16px}
.code-digit{width:48px;height:56px;background:var(--bg-elevated);border:2px solid var(--border);border-radius:var(--radius);font-family:monospace;font-size:1.5rem;font-weight:700;text-align:center;color:var(--text)}
.code-digit:focus{outline:none;border-color:var(--gold)}
.code-digit.error{border-color:var(--rose);animation:shake 0.3s}
.code-digit.success{border-color:var(--emerald)}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.code-error{color:var(--rose);font-size:0.8rem;text-align:center;display:none}
.code-error.show{display:block}
#dashboard{display:none;min-height:100vh;padding-bottom:20px}
#dashboard.active{display:block}
.dash-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.dash-logo{display:flex;align-items:center;gap:10px}
.dash-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:10px;display:grid;place-items:center}
.dash-logo-icon svg{width:20px;height:20px;stroke:var(--bg);fill:none}
.dash-badge{padding:5px 12px;border-radius:100px;font-size:0.75rem;font-weight:600}
.dash-user{display:flex;align-items:center;gap:10px}
.dash-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.8rem}
.dash-content{max-width:1100px;margin:0 auto;padding:16px}
.date-header{background:linear-gradient(135deg,var(--gold),var(--orange));color:var(--bg);padding:12px 16px;border-radius:var(--radius);margin-bottom:16px;font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px}
.tabs{display:flex;gap:4px;background:var(--bg-card);border-radius:var(--radius);padding:4px;margin-bottom:16px;overflow-x:auto}
.tab{flex:1;padding:10px 16px;background:transparent;border:none;border-radius:8px;color:var(--text-muted);font-family:inherit;font-size:0.8rem;font-weight:500;cursor:pointer;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:6px;min-width:70px}
.tab.active{background:var(--bg-elevated);color:var(--gold)}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
.stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
.stat:hover,.stat.active{border-color:var(--gold);background:var(--gold-glow)}
.stat-value{font-size:1.2rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-label{font-size:0.55rem;color:var(--text-muted);text-transform:uppercase;margin-top:2px}
.action-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.patients-list{display:grid;gap:10px}
.ward-group{margin-bottom:16px}
.ward-header{background:var(--bg-elevated);padding:10px 14px;border-radius:8px;margin-bottom:10px;font-weight:600;font-size:0.85rem;display:flex;justify-content:space-between;align-items:center;color:var(--gold)}
.ward-count{background:var(--gold);color:var(--bg);padding:2px 10px;border-radius:100px;font-size:0.7rem}
.patient{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;border-left:4px solid var(--teal);transition:all 0.2s}
.patient.critical{border-left-color:var(--rose);background:rgba(244,63,94,0.05)}
.patient.chronic{border-left-color:var(--purple)}
.patient.new{border-left-color:var(--lime);background:linear-gradient(135deg,rgba(132,204,22,0.1),rgba(132,204,22,0.02));animation:pulseNew 2s ease-in-out infinite}
@keyframes pulseNew{0%,100%{box-shadow:0 0 0 0 rgba(132,204,22,0.3)}50%{box-shadow:0 0 0 6px rgba(132,204,22,0)}}
.patient-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.patient-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.8rem;color:var(--bg);flex-shrink:0}
.patient.new .patient-avatar{background:linear-gradient(135deg,var(--lime),var(--emerald))}
.patient-info{flex:1;min-width:0}
.patient-name{font-weight:600;font-size:0.95rem;display:flex;align-items:center;gap:8px}
.new-badge{background:var(--lime);color:var(--bg);padding:2px 6px;border-radius:4px;font-size:0.55rem;font-weight:700;text-transform:uppercase}
.patient-meta{font-size:0.7rem;color:var(--text-muted);display:flex;flex-wrap:wrap;gap:8px;margin-top:2px}
.patient-status{padding:4px 10px;border-radius:100px;font-size:0.6rem;font-weight:600;text-transform:uppercase}
.patient-status.active{background:rgba(20,184,166,0.15);color:var(--teal)}
.patient-status.critical{background:rgba(244,63,94,0.15);color:var(--rose)}
.patient-status.chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
.patient-status.new{background:rgba(132,204,22,0.15);color:var(--lime)}
.patient-dx{font-size:0.8rem;color:var(--text-secondary);padding:10px;background:var(--bg-elevated);border-radius:8px;margin:10px 0}
.patient-actions{display:flex;gap:6px}
.patient-actions .btn{flex:1}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px}
.card-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:0.9rem}
.card-body{padding:16px}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:30px 20px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover{border-color:var(--gold);background:var(--gold-glow)}
.analysis-types{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:16px}
.analysis-type{background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
.analysis-type:hover,.analysis-type.active{border-color:var(--gold);background:var(--gold-glow)}
.analysis-type-icon{font-size:1.3rem;margin-bottom:4px}
.analysis-type-name{font-size:0.7rem;font-weight:600}
.result-card{background:var(--bg-elevated);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.result-card h4{font-size:0.85rem;margin-bottom:10px}
.result-card p,.result-card li{font-size:0.8rem;color:var(--text-secondary);margin:4px 0}
.result-card ul{padding-left:16px}
.result-card b{color:var(--gold)}
.abnormal{color:var(--rose)!important}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.ref-card{background:var(--bg-elevated);border-radius:8px;padding:14px;border-left:3px solid var(--gold)}
.ref-card h4{font-size:0.85rem;margin-bottom:8px}
.ref-card p{font-size:0.75rem;color:var(--text-secondary)}
#adminPanel{display:none;min-height:100vh}
#adminPanel.active{display:block}
.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.admin-content{max-width:800px;margin:0 auto;padding:20px}
.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px}
.admin-section-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.admin-section-title{font-size:0.95rem;font-weight:600}
.admin-section-body{padding:16px}
.units-table{width:100%;border-collapse:collapse}
.units-table th,.units-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
.units-table th{font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase}
.import-patient{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-elevated);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--teal)}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg-card);border:1px solid var(--emerald);padding:12px 20px;border-radius:var(--radius);font-size:0.85rem;opacity:0;transition:0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.image-gallery{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.image-thumb{position:relative;width:72px;height:72px;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.image-thumb img{width:100%;height:100%;object-fit:cover}
.image-thumb-remove{position:absolute;top:2px;right:2px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,0.7);border:none;color:white;font-size:11px;cursor:pointer;display:grid;place-items:center}
@media(max-width:600px){.stats{grid-template-columns:repeat(3,1fr)}.action-bar{grid-template-columns:1fr}.analysis-types{grid-template-columns:repeat(2,1fr)}.patient-actions{flex-direction:column}}
  </style>
</head>
<body>

<div id="landing">
  <div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
  <h1 class="landing-title">MedWard Enterprise</h1>
  <p class="landing-subtitle">Select your unit to continue</p>
  <div class="units-grid" id="unitsGrid"></div>
  <div class="fab sync-fab" id="syncFab" title="Sync"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9"/></svg></div>
  <div class="fab admin-fab" id="adminFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
</div>

<div class="modal" id="accessModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:center">
      <div id="accessIcon" style="font-size:2.5rem;margin-bottom:8px">üè•</div>
      <div class="modal-title" id="accessTitle">Unit</div>
      <div style="color:var(--text-muted);font-size:0.8rem;margin-top:4px">Enter 4-digit code</div>
    </div>
    <div class="modal-body">
      <div class="code-inputs" id="codeInputs"></div>
      <p class="code-error" id="codeError">Invalid code</p>
      <div id="userSection" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
        <div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input" placeholder="Dr. Name"></div>
        <div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option><option value="nurse">Nurse</option></select></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="accessCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="enterBtn" style="display:none">Enter Unit</button>
    </div>
  </div>
</div>

<div class="modal" id="adminModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:center">
      <div style="font-size:2.5rem;margin-bottom:8px">‚öôÔ∏è</div>
      <div class="modal-title">Admin Access</div>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPwd" class="form-input" placeholder="Password"></div>
      <p class="code-error" id="adminError">Invalid password</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="adminCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="adminLoginBtn">Login</button>
    </div>
  </div>
</div>

<div id="adminPanel">
  <header class="admin-header">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
      <span style="font-weight:600">MedWard</span>
      <span style="background:var(--purple);padding:2px 8px;border-radius:100px;font-size:0.65rem;font-weight:600;margin-left:8px">ADMIN</span>
    </div>
    <button class="btn btn-secondary btn-sm" id="exitAdminBtn">Exit</button>
  </header>
  <div class="admin-content">
    <div class="admin-section">
      <div class="admin-section-header"><div class="admin-section-title">üè• Units</div><button class="btn btn-primary btn-sm" id="addUnitBtn">+ Add</button></div>
      <div class="admin-section-body" style="padding:0"><table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead><tbody id="unitsTable"></tbody></table></div>
    </div>
    <div class="admin-section">
      <div class="admin-section-header"><div class="admin-section-title">‚öôÔ∏è Settings</div></div>
      <div class="admin-section-body">
        <div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="Leave blank to keep current"></div>
        <div class="form-group"><label class="form-label">API URL</label><input type="text" id="apiUrl" class="form-input" placeholder="https://script.google.com/..."></div>
        <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<div id="dashboard">
  <header class="dash-header">
    <div class="dash-logo">
      <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
      <span class="dash-badge" id="unitBadge">Unit</span>
    </div>
    <div class="dash-user">
      <div class="dash-avatar" id="dashAvatar">DR</div>
      <button class="btn-icon" id="logoutBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
  </header>
  <div class="dash-content">
    <div class="date-header" id="dateHeader">üìÖ <span id="currentDate">Loading...</span></div>
    <div class="tabs">
      <button class="tab active" data-tab="patients">üë• <span>Patients</span></button>
      <button class="tab" data-tab="analysis">üî¨ <span>Analysis</span></button>
      <button class="tab" data-tab="reference">üìö <span>Reference</span></button>
    </div>
    <div class="panel active" id="panelPatients">
      <div class="stats" id="statsBar">
        <div class="stat active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
        <div class="stat" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div>
        <div class="stat" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
        <div class="stat" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
        <div class="stat" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary btn-sm" id="addPatientBtn">‚ûï Add Patient</button>
        <button class="btn btn-secondary btn-sm" id="importBtn">üì• Import</button>
        <button class="btn btn-export btn-sm" id="exportBtn">üìÑ Export PDF</button>
      </div>
      <div class="patients-list" id="patientsList"></div>
    </div>
    <div class="panel" id="panelAnalysis">
      <div class="card">
        <div class="card-header">üî¨ Medical Image Analysis</div>
        <div class="card-body">
          <div class="upload-zone" id="uploadZone"><div style="font-size:2rem;margin-bottom:10px">üì§</div><div style="font-weight:600">Upload Medical Images</div><div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Labs, X-Rays, CT/MRI, ECG</div></div>
          <input type="file" id="analysisFile" accept="image/*" multiple style="display:none">
          <div class="analysis-types">
            <div class="analysis-type active" data-type="lab"><div class="analysis-type-icon">üß™</div><div class="analysis-type-name">Labs</div></div>
            <div class="analysis-type" data-type="xray"><div class="analysis-type-icon">ü©ª</div><div class="analysis-type-name">X-Ray</div></div>
            <div class="analysis-type" data-type="ct"><div class="analysis-type-icon">üß†</div><div class="analysis-type-name">CT/MRI</div></div>
            <div class="analysis-type" data-type="ecg"><div class="analysis-type-icon">üíì</div><div class="analysis-type-name">ECG</div></div>
          </div>
          <div id="analysisPreview" style="display:none;margin-top:16px"></div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" id="analyzeBtn" disabled>ü§ñ Analyze with AI</button>
      <div id="analysisLoading" style="display:none;text-align:center;padding:30px"><div class="spinner"></div><div style="margin-top:12px;font-weight:600">Analyzing...</div><div id="analysisTimer" style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">0s</div></div>
      <div id="analysisResults" style="margin-top:16px"></div>
    </div>
    <div class="panel" id="panelReference"><div class="card"><div class="card-header">üìö Quick Reference</div><div class="card-body"><div class="ref-grid" id="refGrid"></div></div></div></div>
  </div>
</div>

<div class="modal" id="patientModal">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div>
    <div class="modal-body">
      <input type="hidden" id="ptId">
      <div class="form-group"><label class="form-label">Patient Name</label><input type="text" id="ptName" class="form-input" placeholder="Full name"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group"><label class="form-label">Ward</label><input type="text" id="ptWard" class="form-input" placeholder="Ward 14"></div>
        <div class="form-group"><label class="form-label">Room/Bed</label><input type="text" id="ptRoom" class="form-input" placeholder="11-1"></div>
      </div>
      <div class="form-group"><label class="form-label">Diagnosis</label><textarea id="ptDx" class="form-textarea" placeholder="Primary diagnosis"></textarea></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group"><label class="form-label">Assigned Doctor</label><input type="text" id="ptDoctor" class="form-input" placeholder="Dr. Name"></div>
        <div class="form-group"><label class="form-label">Status</label><select id="ptStatus" class="form-select"><option value="new">üÜï New</option><option value="active">‚úÖ Active</option><option value="critical">üö® Critical</option><option value="chronic">üíú Chronic</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" id="patientCancelBtn">Cancel</button><button class="btn btn-primary" id="patientSaveBtn">Save</button></div>
  </div>
</div>

<div class="modal" id="unitModal">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title" id="unitModalTitle">Add Unit</div></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="uName" class="form-input" placeholder="Neurology"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group"><label class="form-label">Icon</label><input type="text" id="uIcon" class="form-input" value="üè•" style="font-size:1.3rem;text-align:center"></div>
        <div class="form-group"><label class="form-label">Code (4 digits)</label><input type="text" id="uCode" class="form-input" placeholder="1234" maxlength="4"></div>
      </div>
      <div class="form-group"><label class="form-label">Description</label><input type="text" id="uDesc" class="form-input" placeholder="Brief description"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" id="unitCancelBtn">Cancel</button><button class="btn btn-primary" id="unitSaveBtn">Save</button></div>
  </div>
</div>

<div class="modal" id="importModal">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title">üì• Import Patients</div><div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">AI extracts patient data from screenshots</div></div>
    <div class="modal-body">
      <div id="importUpload"><div class="upload-zone" id="importDropzone"><div style="font-size:2rem;margin-bottom:8px">üì§</div><div style="font-weight:600">Upload Screenshot</div><div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Excel, Sheets, or EMR screenshot</div></div><input type="file" id="importFile" accept="image/*" style="display:none"></div>
      <div id="importPreview" style="display:none"><img id="importImg" src="" style="width:100%;max-height:150px;object-fit:contain;border-radius:8px"><div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-secondary btn-sm" id="importChangeBtn" style="flex:1">Change</button><button class="btn btn-primary btn-sm" id="importExtractBtn" style="flex:2">ü§ñ Extract</button></div></div>
      <div id="importLoading" style="display:none;text-align:center;padding:30px"><div class="spinner"></div><div style="margin-top:12px">Extracting patients...</div></div>
      <div id="importResults" style="display:none"><div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="font-weight:600">‚úì Found Patients</span><span id="importCount" style="background:var(--emerald);color:white;padding:2px 10px;border-radius:100px;font-size:0.75rem">0</span></div><div id="importList" style="max-height:250px;overflow-y:auto"></div></div>
      <div id="importError" style="display:none;text-align:center;padding:20px;color:var(--rose)"><div style="font-size:1.5rem;margin-bottom:8px">‚ö†Ô∏è</div><div id="importErrorMsg">Error</div><button class="btn btn-secondary btn-sm" id="importRetryBtn" style="margin-top:12px">Try Again</button></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" id="importCancelBtn">Cancel</button><button class="btn btn-primary" id="importConfirmBtn" disabled>Import All</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
'use strict';

const CONFIG={STORAGE_KEY:'medward_v3',ADMIN_PASSWORD:'admin123',API_URL:'https://script.google.com/macros/s/AKfycbwnPMayEKM6rHJB2qZ-DDECoVB4Kte1EcoBiea0pmcasfyAeW7RGeADiH5DMXGRJOSJ/exec',MAX_IMAGES:5,MAX_IMAGE_SIZE:1024*1024,IMAGE_QUALITY:0.6,MAX_IMAGE_DIMENSION:1200};

const DEFAULT_UNITS=[{id:'neuro',name:'Neurology',icon:'üß†',desc:'Stroke & Neuro Care',code:'1234',color:'#a855f7'},{id:'cardio',name:'Cardiology',icon:'‚ù§Ô∏è',desc:'Cardiac Care',code:'5678',color:'#ef4444'},{id:'icu',name:'ICU',icon:'üè•',desc:'Intensive Care',code:'9012',color:'#f97316'}];

const REFERENCES=[{title:'üö® Critical Labs',content:'<b>K:</b> <2.5 or >6.5<br><b>Na:</b> <120 or >160<br><b>Glucose:</b> <40 or >500'},{title:'‚ö° Hyperkalemia',content:'<b>Stabilize:</b> Ca gluconate<br><b>Shift:</b> Insulin + D50<br><b>Remove:</b> Kayexalate'},{title:'‚ù§Ô∏è ACS Protocol',content:'<b>MONA:</b> Morphine, O‚ÇÇ, Nitrates, ASA<br><b>STEMI:</b> PCI <90min'},{title:'üß† Stroke tPA',content:'<b>Window:</b> ‚â§4.5h<br><b>Dose:</b> 0.9 mg/kg (max 90mg)'},{title:'ü¶† Sepsis',content:'<b>Hour-1:</b> Lactate, cultures, antibiotics<br><b>Fluids:</b> 30mL/kg'},{title:'üíä Seizure',content:'<b>1st:</b> Lorazepam 4mg<br><b>2nd:</b> Levetiracetam 60mg/kg'}];

const state={units:[],settings:{},patients:[],currentUnit:null,currentUser:null,selectedUnitId:null,editingUnitId:null,analysisImages:[],analysisType:'lab',importImage:null,importPatients:[],currentFilter:'all'};

const $=id=>document.getElementById(id);
const $$=sel=>document.querySelectorAll(sel);

function toast(msg,isError=false){const t=$('toast');t.textContent=msg;t.className='toast show'+(isError?' error':'');setTimeout(()=>t.className='toast',3000);}
function initials(name){if(!name)return'?';const p=name.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.substring(0,2).toUpperCase();}
function escapeHtml(text){if(!text)return'';const d=document.createElement('div');d.textContent=text;return d.innerHTML;}
function openModal(id){$(id).classList.add('active');}
function closeModal(id){$(id).classList.remove('active');}
function formatDate(d){const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];const months=['January','February','March','April','May','June','July','August','September','October','November','December'];d=d||new Date();const day=days[d.getDay()],date=d.getDate(),month=months[d.getMonth()],year=d.getFullYear();const suffix=date===1||date===21||date===31?'st':date===2||date===22?'nd':date===3||date===23?'rd':'th';return day+', '+date+suffix+' '+month+' '+year;}
function compressImage(file,maxSize,cb){const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas'),ctx=c.getContext('2d');let w=img.width,h=img.height,q=CONFIG.IMAGE_QUALITY;const maxD=CONFIG.MAX_IMAGE_DIMENSION;if(w>maxD||h>maxD){if(w>h){h=Math.round(h*maxD/w);w=maxD;}else{w=Math.round(w*maxD/h);h=maxD;}}c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);let dataUrl=c.toDataURL('image/jpeg',q);while(dataUrl.length>maxSize&&q>0.3){q-=0.1;dataUrl=c.toDataURL('image/jpeg',q);}cb(dataUrl);};img.src=e.target.result;};r.readAsDataURL(file);}

let isSyncing=false,lastSyncTime=0;

async function loadStorage(){state.units=DEFAULT_UNITS.slice();state.settings={adminPassword:CONFIG.ADMIN_PASSWORD,apiUrl:CONFIG.API_URL};state.patients=[];loadFromLocalStorage();await syncFromDrive(true);setInterval(()=>syncFromDrive(false),30000);}
function loadFromLocalStorage(){try{const s=localStorage.getItem(CONFIG.STORAGE_KEY);if(s){const d=JSON.parse(s);if(d.units&&d.units.length)state.units=d.units.filter(u=>u&&u.id&&u.name&&u.code);if(d.settings){state.settings.adminPassword=d.settings.adminPassword||CONFIG.ADMIN_PASSWORD;state.settings.apiUrl=d.settings.apiUrl||CONFIG.API_URL;}if(d.patients)state.patients=d.patients;lastSyncTime=d.lastUpdated?new Date(d.lastUpdated).getTime():0;}}catch(e){console.warn('Load failed:',e);}if(!state.units.length)state.units=DEFAULT_UNITS.slice();}
async function syncFromDrive(isInit=false){if(isSyncing)return;isSyncing=true;try{const res=await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'loadData'})});const r=await res.json();if(r.success&&r.data){const d=r.data,t=d.lastUpdated?new Date(d.lastUpdated).getTime():0;if(t>lastSyncTime||isInit){if(d.units&&d.units.length)state.units=d.units;if(d.settings)state.settings={...state.settings,...d.settings};if(d.patients)state.patients=d.patients;lastSyncTime=t||Date.now();saveToLocalStorage();if(!isInit&&!state.currentUnit)renderUnits();else if(!isInit)renderPatients();}}}catch(e){console.warn('Sync failed:',e);}isSyncing=false;}
function saveToLocalStorage(){try{localStorage.setItem(CONFIG.STORAGE_KEY,JSON.stringify({units:state.units,settings:state.settings,patients:state.patients,lastUpdated:new Date().toISOString()}));}catch(e){}}
async function saveStorage(){lastSyncTime=Date.now();saveToLocalStorage();try{await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'saveData',payload:{units:state.units,settings:{adminPassword:state.settings.adminPassword},patients:state.patients,lastUpdated:new Date().toISOString()}})});}catch(e){console.warn('Save failed:',e);}}
async function forceSync(){lastSyncTime=0;await syncFromDrive(true);}
function getUnit(id){return state.units.find(u=>u.id===id);}

function renderUnits(){const c=$('unitsGrid');if(!state.units.length){c.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted)">No units configured.</div>';return;}c.innerHTML=state.units.map(u=>'<div class="unit-card" style="--unit-color:'+(u.color||'#d4a437')+'" data-id="'+u.id+'"><div class="unit-card-icon">'+(u.icon||'üè•')+'</div><div class="unit-card-name">'+(u.name||'Unknown')+'</div><div class="unit-card-desc">'+(u.desc||'')+'</div></div>').join('');$$('.unit-card').forEach(c=>c.addEventListener('click',()=>openUnitAccess(c.dataset.id)));}

function renderUnitsTable(){$('unitsTable').innerHTML=state.units.map(u=>'<tr><td>'+u.icon+' <b>'+u.name+'</b></td><td><code style="background:var(--bg-elevated);padding:3px 8px;border-radius:4px">'+u.code+'</code></td><td><button class="btn-icon edit-unit" data-id="'+u.id+'">‚úèÔ∏è</button><button class="btn-icon delete-unit" data-id="'+u.id+'">üóëÔ∏è</button></td></tr>').join('')||'<tr><td colspan="3" style="text-align:center;padding:30px;color:var(--text-muted)">No units</td></tr>';$$('.edit-unit').forEach(b=>b.addEventListener('click',()=>editUnit(b.dataset.id)));$$('.delete-unit').forEach(b=>b.addEventListener('click',()=>deleteUnit(b.dataset.id)));}

function renderPatients(){const c=$('patientsList'),f=state.currentFilter;let filtered=state.patients;if(f!=='all')filtered=state.patients.filter(p=>p.status===f);const wards={};filtered.forEach(p=>{const w=p.ward||'Unassigned';if(!wards[w])wards[w]=[];wards[w].push(p);});if(!filtered.length){c.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted)">No '+(f==='all'?'':f+' ')+'patients found.</div>';}else{let h='';Object.keys(wards).sort().forEach(w=>{const pts=wards[w];h+='<div class="ward-group"><div class="ward-header"><span>üìç '+escapeHtml(w)+'</span><span class="ward-count">'+pts.length+'</span></div>';pts.forEach(p=>{const isNew=p.status==='new';h+='<div class="patient '+p.status+'" data-id="'+p.id+'"><div class="patient-header"><div class="patient-avatar">'+initials(p.name)+'</div><div class="patient-info"><div class="patient-name">'+escapeHtml(p.name)+(isNew?' <span class="new-badge">New</span>':'')+'</div><div class="patient-meta"><span>üõèÔ∏è '+escapeHtml(p.room||'‚Äî')+'</span><span>üë®‚Äç‚öïÔ∏è '+escapeHtml(p.doctor||'‚Äî')+'</span></div></div><span class="patient-status '+p.status+'">'+p.status+'</span></div><div class="patient-dx">'+escapeHtml(p.diagnosis||'Pending')+'</div><div class="patient-actions"><button class="btn btn-secondary btn-xs edit-pt" data-id="'+p.id+'">‚úèÔ∏è Edit</button><button class="btn btn-danger btn-xs delete-pt" data-id="'+p.id+'">üóëÔ∏è</button></div></div>';});h+='</div>';});c.innerHTML=h;$$('.edit-pt').forEach(b=>b.addEventListener('click',()=>editPatient(parseInt(b.dataset.id))));$$('.delete-pt').forEach(b=>b.addEventListener('click',()=>deletePatient(parseInt(b.dataset.id))));}updateStats();}

function updateStats(){$('statTotal').textContent=state.patients.length;$('statNew').textContent=state.patients.filter(p=>p.status==='new').length;$('statActive').textContent=state.patients.filter(p=>p.status==='active').length;$('statCritical').textContent=state.patients.filter(p=>p.status==='critical').length;$('statChronic').textContent=state.patients.filter(p=>p.status==='chronic').length;$$('.stat').forEach(s=>s.classList.toggle('active',s.dataset.filter===state.currentFilter));}

function renderReference(){$('refGrid').innerHTML=REFERENCES.map(r=>'<div class="ref-card"><h4>'+r.title+'</h4><p>'+r.content+'</p></div>').join('');}

function openUnitAccess(id){const u=getUnit(id);if(!u)return;state.selectedUnitId=id;$('accessIcon').textContent=u.icon;$('accessTitle').textContent=u.name;$('codeError').classList.remove('show');$('userSection').style.display='none';$('enterBtn').style.display='none';$('codeInputs').innerHTML=Array(4).fill(0).map((_,i)=>'<input type="tel" class="code-digit" maxlength="1" data-idx="'+i+'" inputmode="numeric">').join('');const inputs=$$('.code-digit');inputs.forEach((inp,idx)=>{inp.addEventListener('input',()=>{inp.value=inp.value.replace(/\D/g,'');if(inp.value&&idx<3)inputs[idx+1].focus();const code=Array.from(inputs).map(i=>i.value).join('');if(code.length===4){if(code===u.code){inputs.forEach(i=>{i.classList.add('success');i.disabled=true;});$('codeError').classList.remove('show');$('userSection').style.display='block';$('enterBtn').style.display='flex';$('userName').focus();}else{$('codeError').classList.add('show');inputs.forEach(i=>i.classList.add('error'));setTimeout(()=>{inputs.forEach(i=>{i.classList.remove('error');i.value='';});inputs[0].focus();},500);}}});inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!inp.value&&idx>0)inputs[idx-1].focus();});});openModal('accessModal');setTimeout(()=>inputs[0].focus(),100);}

function enterUnit(){const name=$('userName').value.trim();if(!name){toast('Enter your name',true);return;}state.currentUnit=getUnit(state.selectedUnitId);state.currentUser={name,role:$('userRole').value};closeModal('accessModal');showDashboard();}

function showDashboard(){const u=state.currentUnit;$('landing').classList.add('hidden');$('dashboard').classList.add('active');$('unitBadge').textContent=u.name;$('unitBadge').style.cssText='border:1px solid '+u.color+';color:'+u.color+';background:'+u.color+'20';$('dashAvatar').textContent=initials(state.currentUser.name);$('currentDate').textContent=formatDate();renderPatients();renderReference();toast('Welcome to '+u.name);}

function logout(){state.currentUnit=null;state.currentUser=null;state.currentFilter='all';$('dashboard').classList.remove('active');$('landing').classList.remove('hidden');}

function showTab(name){$$('.tab').forEach(t=>t.classList.remove('active'));$$('.panel').forEach(p=>p.classList.remove('active'));document.querySelector('.tab[data-tab="'+name+'"]').classList.add('active');$('panel'+name.charAt(0).toUpperCase()+name.slice(1)).classList.add('active');}

function openAdminLogin(){$('adminPwd').value='';$('adminError').classList.remove('show');openModal('adminModal');setTimeout(()=>$('adminPwd').focus(),100);}
function loginAdmin(){if($('adminPwd').value===state.settings.adminPassword){closeModal('adminModal');showAdmin();}else $('adminError').classList.add('show');}
function showAdmin(){$('landing').classList.add('hidden');$('adminPanel').classList.add('active');$('apiUrl').value=state.settings.apiUrl||'';renderUnitsTable();}
function exitAdmin(){$('adminPanel').classList.remove('active');$('landing').classList.remove('hidden');}
function addUnit(){state.editingUnitId=null;$('unitModalTitle').textContent='Add Unit';$('uName').value='';$('uIcon').value='üè•';$('uCode').value='';$('uDesc').value='';openModal('unitModal');}
function editUnit(id){const u=getUnit(id);if(!u)return;state.editingUnitId=id;$('unitModalTitle').textContent='Edit Unit';$('uName').value=u.name;$('uIcon').value=u.icon;$('uCode').value=u.code;$('uDesc').value=u.desc||'';openModal('unitModal');}
function saveUnit(){const name=$('uName').value.trim(),icon=$('uIcon').value.trim()||'üè•',code=$('uCode').value.trim(),desc=$('uDesc').value.trim();if(!name){toast('Name required',true);return;}if(!/^\d{4}$/.test(code)){toast('Code must be 4 digits',true);return;}if(state.editingUnitId){const i=state.units.findIndex(u=>u.id===state.editingUnitId);if(i!==-1)state.units[i]={...state.units[i],name,icon,code,desc};toast('Unit updated!');}else{const colors=['#d4a437','#14b8a6','#3b82f6','#a855f7','#ef4444','#f97316'];state.units.push({id:'u'+Date.now(),name,icon,code,desc,color:colors[state.units.length%colors.length]});toast('Unit created!');}saveStorage();renderUnitsTable();renderUnits();closeModal('unitModal');}
function deleteUnit(id){if(!confirm('Delete this unit?'))return;state.units=state.units.filter(u=>u.id!==id);saveStorage();renderUnitsTable();renderUnits();toast('Unit deleted');}
function saveSettings(){const pwd=$('newAdminPwd').value.trim(),url=$('apiUrl').value.trim();if(pwd)state.settings.adminPassword=pwd;if(url)state.settings.apiUrl=url;saveStorage();toast('Settings saved!');$('newAdminPwd').value='';}

function openAddPatient(){$('patientModalTitle').textContent='Add Patient';$('ptId').value='';$('ptName').value='';$('ptWard').value='';$('ptRoom').value='';$('ptDx').value='';$('ptDoctor').value=state.currentUser?state.currentUser.name:'';$('ptStatus').value='new';openModal('patientModal');}
function editPatient(id){const p=state.patients.find(x=>x.id===id);if(!p)return;$('patientModalTitle').textContent='Edit Patient';$('ptId').value=p.id;$('ptName').value=p.name;$('ptWard').value=p.ward||'';$('ptRoom').value=p.room;$('ptDx').value=p.diagnosis;$('ptDoctor').value=p.doctor||'';$('ptStatus').value=p.status;openModal('patientModal');}
function savePatient(){const id=$('ptId').value,name=$('ptName').value.trim(),ward=$('ptWard').value.trim()||'Unassigned',room=$('ptRoom').value.trim()||'‚Äî',diagnosis=$('ptDx').value.trim()||'Pending',doctor=$('ptDoctor').value.trim()||state.currentUser?.name||'Unassigned',status=$('ptStatus').value;if(!name){toast('Name required',true);return;}if(id){const i=state.patients.findIndex(p=>p.id===parseInt(id));if(i!==-1)state.patients[i]={...state.patients[i],name,ward,room,diagnosis,doctor,status};toast('Patient updated!');}else{state.patients.push({id:Date.now(),name,ward,room,diagnosis,doctor,status,createdAt:new Date().toISOString()});toast('Patient added!');}saveStorage();renderPatients();closeModal('patientModal');}
function deletePatient(id){if(!confirm('Delete this patient?'))return;state.patients=state.patients.filter(p=>p.id!==id);saveStorage();renderPatients();toast('Patient deleted');}

function exportPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF();const u=state.currentUnit,dateStr=formatDate(),f=state.currentFilter;let filtered=state.patients;if(f!=='all')filtered=state.patients.filter(p=>p.status===f);doc.setFontSize(16);doc.setFont('helvetica','bold');doc.setTextColor(212,164,55);doc.text(u.name+' - Patient List',14,20);doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(100,100,100);doc.text(dateStr,14,28);doc.text('Total: '+filtered.length+(f!=='all'?' ('+f+')':''),14,34);const wards={};filtered.forEach(p=>{const w=p.ward||'Unassigned';if(!wards[w])wards[w]=[];wards[w].push(p);});const data=[];Object.keys(wards).sort().forEach(w=>wards[w].forEach(p=>data.push([w,p.room||'‚Äî',p.name,p.diagnosis||'Pending',p.doctor||'‚Äî',p.status.charAt(0).toUpperCase()+p.status.slice(1)])));doc.autoTable({startY:40,head:[['Ward','Room','Patient Name','Diagnosis','Doctor','Status']],body:data,theme:'grid',headStyles:{fillColor:[212,164,55],textColor:[0,0,0],fontStyle:'bold',fontSize:9},bodyStyles:{fontSize:8,cellPadding:3},columnStyles:{0:{cellWidth:22},1:{cellWidth:16},2:{cellWidth:32},3:{cellWidth:50},4:{cellWidth:28},5:{cellWidth:20}},didParseCell:function(d){if(d.section==='body'&&d.column.index===5){const s=d.cell.raw.toLowerCase();if(s==='critical'){d.cell.styles.textColor=[244,63,94];d.cell.styles.fontStyle='bold';}else if(s==='new'){d.cell.styles.textColor=[132,204,22];d.cell.styles.fontStyle='bold';}else if(s==='chronic')d.cell.styles.textColor=[139,92,246];}},alternateRowStyles:{fillColor:[245,245,245]}});const pc=doc.internal.getNumberOfPages();doc.setFontSize(8);doc.setTextColor(150,150,150);for(let i=1;i<=pc;i++){doc.setPage(i);doc.text('Generated by MedWard Enterprise',14,doc.internal.pageSize.height-10);doc.text('Page '+i+' of '+pc,doc.internal.pageSize.width-30,doc.internal.pageSize.height-10);}doc.save(u.name.replace(/\s+/g,'_')+'_Patients_'+new Date().toISOString().split('T')[0]+'.pdf');toast('PDF exported!');}

let analysisTimer=null,analysisSeconds=0;
function startTimer(){analysisSeconds=0;$('analysisTimer').textContent='0s';analysisTimer=setInterval(()=>{analysisSeconds++;$('analysisTimer').textContent=analysisSeconds+'s';},1000);}
function stopTimer(){if(analysisTimer){clearInterval(analysisTimer);analysisTimer=null;}}
function addAnalysisImage(file){if(state.analysisImages.length>=CONFIG.MAX_IMAGES){toast('Max '+CONFIG.MAX_IMAGES+' images',true);return;}compressImage(file,CONFIG.MAX_IMAGE_SIZE,dataUrl=>{state.analysisImages.push({id:Date.now(),data:dataUrl});renderAnalysisImages();$('analyzeBtn').disabled=false;toast('Image added');});}
function removeAnalysisImage(id){state.analysisImages=state.analysisImages.filter(i=>i.id!==id);renderAnalysisImages();if(!state.analysisImages.length)$('analyzeBtn').disabled=true;}
function renderAnalysisImages(){const p=$('analysisPreview');if(!state.analysisImages.length){p.style.display='none';return;}p.innerHTML='<div class="image-gallery">'+state.analysisImages.map(i=>'<div class="image-thumb"><img src="'+i.data+'"><button class="image-thumb-remove" data-id="'+i.id+'">‚úï</button></div>').join('')+'</div>';p.style.display='block';$$('.image-thumb-remove').forEach(b=>b.addEventListener('click',()=>removeAnalysisImage(parseInt(b.dataset.id))));}
async function runAnalysis(){if(!state.analysisImages.length)return;$('analyzeBtn').disabled=true;$('analysisLoading').style.display='block';$('analysisResults').innerHTML='';startTimer();const types={lab:'Laboratory Results',xray:'X-Ray',ct:'CT/MRI Scan',ecg:'ECG'};try{const res=await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'interpret',documentType:state.analysisType,image:state.analysisImages[0].data})});const d=await res.json();stopTimer();$('analysisLoading').style.display='none';$('analyzeBtn').disabled=false;if(d.error){$('analysisResults').innerHTML='<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>'+escapeHtml(d.error)+'</p></div>';return;}let h='<div class="result-card"><h4>üìã '+types[state.analysisType]+' Analysis</h4><div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:10px">Completed in '+analysisSeconds+'s</div>';if(d.interpretation){const i=d.interpretation;if(i.summary)h+='<p><b>Summary:</b> '+escapeHtml(i.summary)+'</p>';if(i.keyFindings&&i.keyFindings.length)h+='<p><b>Key Findings:</b></p><ul>'+i.keyFindings.map(f=>'<li>'+escapeHtml(f)+'</li>').join('')+'</ul>';if(i.abnormalities&&i.abnormalities.length)h+='<p><b class="abnormal">Abnormalities:</b></p><ul>'+i.abnormalities.map(a=>'<li class="abnormal">'+escapeHtml(a)+'</li>').join('')+'</ul>';}h+='</div>';$('analysisResults').innerHTML=h;toast('Analysis complete!');}catch(e){stopTimer();$('analysisLoading').style.display='none';$('analyzeBtn').disabled=false;$('analysisResults').innerHTML='<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>Connection failed.</p></div>';}}

function openImport(){state.importImage=null;state.importPatients=[];$('importUpload').style.display='block';$('importPreview').style.display='none';$('importLoading').style.display='none';$('importResults').style.display='none';$('importError').style.display='none';$('importConfirmBtn').disabled=true;$('importFile').value='';openModal('importModal');}
function resetImport(){state.importImage=null;state.importPatients=[];$('importUpload').style.display='block';$('importPreview').style.display='none';$('importLoading').style.display='none';$('importResults').style.display='none';$('importError').style.display='none';$('importConfirmBtn').disabled=true;}
function handleImportFile(file){compressImage(file,CONFIG.MAX_IMAGE_SIZE,dataUrl=>{state.importImage=dataUrl;$('importImg').src=dataUrl;$('importUpload').style.display='none';$('importPreview').style.display='block';});}
async function extractPatients(){if(!state.importImage)return;$('importPreview').style.display='none';$('importLoading').style.display='block';try{const res=await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'extractPatients',image:state.importImage})});const d=await res.json();$('importLoading').style.display='none';if(d.error){showImportError(d.error);return;}let pts=d.patients||[];if(!pts.length){showImportError('No patients found.');return;}state.importPatients=pts.map((p,i)=>({id:Date.now()+i,name:(p.name||'Unknown').trim(),ward:(p.ward||'Unassigned').trim(),room:(p.room||p.bed||'‚Äî').trim(),diagnosis:(p.diagnosis||p.condition||'Pending').trim(),status:normalizeStatus(p.status),doctor:p.doctor||state.currentUser?.name||'Unassigned',createdAt:new Date().toISOString()})).filter(p=>p.name&&p.name!=='Unknown');if(!state.importPatients.length){showImportError('No valid patients.');return;}showImportResults();}catch(e){$('importLoading').style.display='none';showImportError('Connection failed.');}}
function normalizeStatus(s){if(!s)return'active';s=String(s).toLowerCase();if(s.includes('new'))return'new';if(s.match(/critical|icu|urgent/))return'critical';if(s.match(/chronic|stable|non-chronic/))return'chronic';return'active';}
function showImportError(msg){$('importError').style.display='block';$('importErrorMsg').textContent=msg;}
function showImportResults(){$('importResults').style.display='block';$('importCount').textContent=state.importPatients.length;const wards={};state.importPatients.forEach(p=>{const w=p.ward||'Unassigned';if(!wards[w])wards[w]=[];wards[w].push(p);});let html='';Object.keys(wards).sort().forEach(w=>{html+='<div style="margin-bottom:12px"><div style="font-size:0.7rem;font-weight:600;color:var(--gold);margin-bottom:6px;padding:4px 8px;background:var(--bg-elevated);border-radius:4px">üìç '+escapeHtml(w)+' ('+wards[w].length+')</div>';wards[w].slice(0,5).forEach(p=>{html+='<div class="import-patient" style="border-left-color:'+(p.status==='critical'?'var(--rose)':p.status==='chronic'?'var(--purple)':'var(--teal)')+'"><div style="width:28px;height:28px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:6px;display:grid;place-items:center;font-weight:600;font-size:0.65rem;color:var(--bg)">'+initials(p.name)+'</div><div style="flex:1;min-width:0"><div style="font-weight:600;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+escapeHtml(p.name)+'</div><div style="font-size:0.65rem;color:var(--text-muted)">üõèÔ∏è '+escapeHtml(p.room||'‚Äî')+' ‚Ä¢ '+escapeHtml(p.status)+'</div></div></div>';});if(wards[w].length>5)html+='<div style="font-size:0.7rem;color:var(--text-muted);padding-left:10px">+'+(wards[w].length-5)+' more in '+w+'</div>';html+='</div>';});$('importList').innerHTML=html;$('importConfirmBtn').disabled=false;toast('Found '+state.importPatients.length+' patients in '+Object.keys(wards).length+' wards!');}
function confirmImport(){if(!state.importPatients.length)return;let added=0;state.importPatients.forEach(p=>{if(!state.patients.some(ep=>ep.name.toLowerCase()===p.name.toLowerCase())){state.patients.push(p);added++;}});saveStorage();renderPatients();closeModal('importModal');toast('Imported '+added+' patients!');}

function initEventListeners(){$('adminFab').addEventListener('click',openAdminLogin);$('adminLoginBtn').addEventListener('click',loginAdmin);$('adminCancelBtn').addEventListener('click',()=>closeModal('adminModal'));$('adminPwd').addEventListener('keydown',e=>{if(e.key==='Enter')loginAdmin();});$('exitAdminBtn').addEventListener('click',exitAdmin);$('addUnitBtn').addEventListener('click',addUnit);$('unitSaveBtn').addEventListener('click',saveUnit);$('unitCancelBtn').addEventListener('click',()=>closeModal('unitModal'));$('saveSettingsBtn').addEventListener('click',saveSettings);$('syncFab').addEventListener('click',async()=>{$('syncFab').classList.add('syncing');await forceSync();renderUnits();$('syncFab').classList.remove('syncing');toast('Synced!');});$('accessCancelBtn').addEventListener('click',()=>closeModal('accessModal'));$('enterBtn').addEventListener('click',enterUnit);$('userName').addEventListener('keydown',e=>{if(e.key==='Enter')enterUnit();});$('logoutBtn').addEventListener('click',logout);document.querySelector('.tabs').addEventListener('click',e=>{const t=e.target.closest('.tab');if(t)showTab(t.dataset.tab);});$('statsBar').addEventListener('click',e=>{const s=e.target.closest('.stat');if(s){state.currentFilter=s.dataset.filter;renderPatients();}});$('addPatientBtn').addEventListener('click',openAddPatient);$('patientSaveBtn').addEventListener('click',savePatient);$('patientCancelBtn').addEventListener('click',()=>closeModal('patientModal'));$('exportBtn').addEventListener('click',exportPDF);$('importBtn').addEventListener('click',openImport);$('importDropzone').addEventListener('click',()=>$('importFile').click());$('importFile').addEventListener('change',function(){if(this.files[0])handleImportFile(this.files[0]);});$('importChangeBtn').addEventListener('click',resetImport);$('importExtractBtn').addEventListener('click',extractPatients);$('importRetryBtn').addEventListener('click',resetImport);$('importCancelBtn').addEventListener('click',()=>closeModal('importModal'));$('importConfirmBtn').addEventListener('click',confirmImport);$('uploadZone').addEventListener('click',()=>$('analysisFile').click());$('analysisFile').addEventListener('change',function(){Array.from(this.files).forEach(f=>{if(f.type.startsWith('image/'))addAnalysisImage(f);});this.value='';});document.querySelector('.analysis-types').addEventListener('click',e=>{const t=e.target.closest('.analysis-type');if(t){state.analysisType=t.dataset.type;$$('.analysis-type').forEach(x=>x.classList.remove('active'));t.classList.add('active');}});$('analyzeBtn').addEventListener('click',runAnalysis);$$('.modal').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active');}));}

async function init(){console.log('[MedWard] Initializing...');await loadStorage();renderUnits();initEventListeners();console.log('[MedWard] Ready');}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
})();
</script>
</body>
</html>
