<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#005eb8">
<meta name="apple-mobile-web-app-capable" content="yes">
<!-- Cache Control - Always fetch fresh -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Loading | MedWard Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #005eb8;
  --primary-dark: #003087;
  --bg-app: #f8fafc;
  --bg-surface: #ffffff;
  --text-main: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --success: #059669;
  --danger: #dc2626;
  --warning: #d97706;
}

body.dark-theme {
  --primary: #60a5fa;
  --primary-dark: #93c5fd;
  --bg-app: #0f172a;
  --bg-surface: #1e293b;
  --text-main: #f8fafc;
  --text-secondary: #cbd5e1;
  --text-muted: #64748b;
  --border: #334155;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-app);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  transition: background-color 0.3s, color 0.3s;
}

.loading-container {
  text-align: center;
  max-width: 360px;
  width: 100%;
}

.loading-logo {
  width: 80px;
  height: 80px;
  background: var(--primary);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 24px;
  box-shadow: 0 8px 24px rgba(0, 94, 184, 0.25);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
}

.loading-logo svg {
  width: 44px;
  height: 44px;
  stroke: #fff;
  stroke-width: 2.5;
  fill: none;
}

.loading-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.loading-status {
  color: var(--text-secondary);
  font-size: 0.95rem;
  margin-bottom: 24px;
  min-height: 24px;
}

.loading-spinner-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 16px;
}

.loading-spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-progress {
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* Progress Bar */
.progress-bar-container {
  width: 100%;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  margin: 20px 0;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-dark));
  border-radius: 3px;
  width: 0%;
  transition: width 0.3s ease;
}

/* Error Box */
.loading-error {
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fca5a5;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  display: none;
}

body.dark-theme .loading-error {
  background: #7f1d1d;
  border-color: #991b1b;
  color: #fca5a5;
}

.loading-error.show {
  display: block;
}

.error-icon {
  font-size: 1.5rem;
  margin-bottom: 8px;
}

.error-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.error-message {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-bottom: 12px;
}

/* Buttons */
.btn-group {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.btn {
  flex: 1;
  padding: 12px 16px;
  border-radius: 10px;
  font-family: inherit;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.btn-primary {
  background: var(--primary);
  color: #fff;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--bg-surface);
  color: var(--text-main);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--primary);
  color: var(--primary);
}

/* Skip Link */
.skip-link {
  margin-top: 24px;
  display: none;
}

.skip-link.show {
  display: block;
}

.skip-link button {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 0.85rem;
  cursor: pointer;
  padding: 8px 16px;
  border-radius: 8px;
  transition: all 0.2s;
}

.skip-link button:hover {
  color: var(--primary);
  background: var(--bg-surface);
}

/* Timeout Warning */
.timeout-warning {
  background: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
  border-radius: 10px;
  padding: 12px 16px;
  margin-top: 16px;
  font-size: 0.85rem;
  display: none;
}

body.dark-theme .timeout-warning {
  background: #78350f;
  border-color: #92400e;
  color: #fcd34d;
}

.timeout-warning.show {
  display: block;
}

/* Retry Counter */
.retry-info {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 8px;
}

/* Loading Footer */
.loading-footer {
  position: fixed;
  bottom: 20px;
  color: var(--text-muted);
  font-size: 0.75rem;
}

/* Success State */
.loading-success {
  display: none;
}

.loading-success.show {
  display: block;
}

.success-icon {
  width: 60px;
  height: 60px;
  background: var(--success);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  animation: scaleIn 0.3s ease;
}

@keyframes scaleIn {
  from { transform: scale(0); }
  to { transform: scale(1); }
}

.success-icon svg {
  width: 32px;
  height: 32px;
  stroke: #fff;
  stroke-width: 3;
  fill: none;
}
</style>
</head>
<body>
<script>
// Apply saved theme immediately
(function() {
  const theme = localStorage.getItem('MEDWARD_THEME');
  if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-theme');
  }
})();
</script>

<div class="loading-container">
  <!-- Normal Loading State -->
  <div id="loadingState">
    <div class="loading-logo">
      <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    </div>
    
    <h1 class="loading-title">MedWard Pro</h1>
    <p class="loading-status" id="loadingStatus">Connecting to cloud...</p>
    
    <div class="loading-spinner-container">
      <div class="loading-spinner" id="spinner"></div>
      <span class="loading-progress" id="loadingProgress">Please wait</span>
    </div>
    
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div class="timeout-warning" id="timeoutWarning">
      â±ï¸ This is taking longer than expected. Check your connection.
    </div>
    
    <div class="skip-link" id="skipLink">
      <button onclick="skipToOffline()">Skip and use cached data â†’</button>
    </div>
    
    <div class="retry-info" id="retryInfo"></div>
  </div>
  
  <!-- Success State -->
  <div class="loading-success" id="successState">
    <div class="success-icon">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <h2 style="margin-bottom: 8px;">Ready!</h2>
    <p style="color: var(--text-secondary);">Redirecting to your dashboard...</p>
  </div>
  
  <!-- Error State -->
  <div class="loading-error" id="errorBox">
    <div class="error-icon">âš ï¸</div>
    <div class="error-title" id="errorTitle">Connection Failed</div>
    <div class="error-message" id="errorMessage">Could not reach the server</div>
    <div style="margin-top: 12px;">
      <button onclick="toggleDiagnostics()" style="background:none;border:none;color:var(--primary);font-size:0.85rem;cursor:pointer;text-decoration:underline">
        ğŸ” Show Diagnostics
      </button>
    </div>
    <div id="diagnosticsPanel" style="display:none;margin-top:12px;padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;text-align:left;font-size:0.8rem">
      <div style="font-weight:600;margin-bottom:8px;color:var(--primary)">Diagnostic Information</div>
      <div style="line-height:1.6">
        <div>â€¢ Browser Online: <span id="diagOnline"></span></div>
        <div>â€¢ Google Script URL: <span style="font-size:0.7rem;word-break:break-all" id="diagUrl"></span></div>
        <div>â€¢ Last Error: <span id="diagError"></span></div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);color:var(--text-muted);font-size:0.75rem">
          <strong>Common Solutions:</strong><br>
          1. Check your internet connection<br>
          2. Verify the Google Script is deployed<br>
          3. Script settings: Execute as "Me", Access "Anyone"<br>
          4. Try refreshing the page<br>
          5. Check browser console (F12) for details
        </div>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="loadCloudData()">Try Again</button>
      <button class="btn btn-secondary" onclick="skipToOffline()" id="offlineBtn">Use Offline</button>
    </div>
  </div>
</div>

<div class="loading-footer">
  v17.1 â€¢ Cloud-First Edition
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/AKfycbzmWYRlBlhcXAvyB_l6F8oj3tbBm_YY2wwyR5hJNSxPs-QBP5OI4dZ8prQLindVcoKfHA/exec',
  TIMEOUT_MS: 15000,           // 15 seconds timeout
  WARNING_MS: 8000,            // Show warning after 8 seconds
  MAX_RETRIES: 3,              // Maximum auto-retry attempts
  RETRY_DELAY_MS: 2000,        // 2 seconds between retries
  SKIP_DELAY_MS: 5000          // Show skip option after 5 seconds
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let retryCount = 0;
let loadTimeout = null;
let warningTimeout = null;
let skipTimeout = null;
let abortController = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUTH = {
  user: sessionStorage.getItem('MW_USER') || localStorage.getItem('MW_USER'),
  pass: sessionStorage.getItem('MW_PASS') || localStorage.getItem('MW_PASS')
};

if (!AUTH.user || !AUTH.pass) {
  window.location.href = 'login.html';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(status, progress) {
  document.getElementById('loadingStatus').textContent = status;
  document.getElementById('loadingProgress').textContent = progress;
}

function setProgress(percent) {
  document.getElementById('progressBar').style.width = percent + '%';
}

function showError(title, message, showOffline = true) {
  clearAllTimeouts();

  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('successState').classList.remove('show');
  document.getElementById('errorBox').classList.add('show');
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorMessage').textContent = message;

  // Populate diagnostics
  updateDiagnostics();

  // Only show offline button if we have cached data
  const hasCache = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');
  document.getElementById('offlineBtn').style.display = (showOffline && hasCache) ? 'block' : 'none';
}

function toggleDiagnostics() {
  const panel = document.getElementById('diagnosticsPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    updateDiagnostics();
  } else {
    panel.style.display = 'none';
  }
}

function updateDiagnostics() {
  // Update online status
  const diagOnline = document.getElementById('diagOnline');
  if (diagOnline) {
    diagOnline.textContent = navigator.onLine ? 'âœ… Yes' : 'âŒ No';
    diagOnline.style.color = navigator.onLine ? '#059669' : '#dc2626';
  }

  // Update URL
  const diagUrl = document.getElementById('diagUrl');
  if (diagUrl) {
    diagUrl.textContent = CONFIG.API_URL;
  }

  // Update last error
  const diagError = document.getElementById('diagError');
  if (diagError) {
    try {
      const errorStr = sessionStorage.getItem('MW_LAST_ERROR');
      if (errorStr) {
        const error = JSON.parse(errorStr);
        diagError.textContent = error.message;
        diagError.style.color = '#dc2626';
      } else {
        diagError.textContent = 'No error details available';
        diagError.style.color = 'var(--text-muted)';
      }
    } catch (e) {
      diagError.textContent = 'Error reading diagnostics';
    }
  }
}

function hideError() {
  document.getElementById('errorBox').classList.remove('show');
  document.getElementById('loadingState').style.display = 'block';
}

function showSuccess() {
  clearAllTimeouts();
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorBox').classList.remove('show');
  document.getElementById('successState').classList.add('show');
}

function showTimeoutWarning() {
  document.getElementById('timeoutWarning').classList.add('show');
}

function showSkipOption() {
  const hasCache = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');
  if (hasCache) {
    document.getElementById('skipLink').classList.add('show');
  }
}

function updateRetryInfo() {
  if (retryCount > 0) {
    document.getElementById('retryInfo').textContent = `Retry attempt ${retryCount} of ${CONFIG.MAX_RETRIES}`;
  } else {
    document.getElementById('retryInfo').textContent = '';
  }
}

function clearAllTimeouts() {
  if (loadTimeout) clearTimeout(loadTimeout);
  if (warningTimeout) clearTimeout(warningTimeout);
  if (skipTimeout) clearTimeout(skipTimeout);
  if (abortController) abortController.abort();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKIP TO OFFLINE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function skipToOffline() {
  clearAllTimeouts();
  
  const localCache = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');
  
  if (!localCache) {
    showError('No Cached Data', 'You need to connect at least once to use offline mode.', false);
    return;
  }
  
  setStatus('Using cached data...', 'Offline mode');
  setProgress(100);
  
  // Mark as offline mode
  localStorage.setItem('MW_CLOUD_VERIFIED', 'offline_' + Date.now().toString());
  localStorage.setItem('MW_OFFLINE_MODE', 'true');
  
  console.log('âš¡ Skipping to offline mode');
  
  setTimeout(() => {
    showSuccess();
    setTimeout(() => {
      window.location.href = 'landing.html';
    }, 500);
  }, 300);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN: LOAD CLOUD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCloudData() {
  hideError();
  updateRetryInfo();
  setProgress(10);
  setStatus('Connecting to cloud...', 'Please wait');
  
  // Reset UI state
  document.getElementById('timeoutWarning').classList.remove('show');
  document.getElementById('skipLink').classList.remove('show');
  
  // Set up timeout warning
  warningTimeout = setTimeout(() => {
    showTimeoutWarning();
  }, CONFIG.WARNING_MS);
  
  // Set up skip option
  skipTimeout = setTimeout(() => {
    showSkipOption();
  }, CONFIG.SKIP_DELAY_MS);
  
  // Create abort controller for timeout
  abortController = new AbortController();
  
  // Set up hard timeout
  loadTimeout = setTimeout(() => {
    abortController.abort();
  }, CONFIG.TIMEOUT_MS);
  
  try {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 1: Fetch data from cloud
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Loading your data...', 'Fetching from server');
    setProgress(30);
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      cache: 'no-store',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'loadData',
        username: AUTH.user,
        password: AUTH.pass,
        clientRev: 0
      }),
      signal: abortController.signal
    });
    
    setProgress(50);
    
    const text = await response.text();

    // Enhanced logging for debugging
    console.log('ğŸ“¡ Response status:', response.status, response.statusText);
    console.log('ğŸ“¡ Response length:', text.length, 'characters');
    console.log('ğŸ“¡ Response preview:', text.substring(0, 200));

    // Check for HTML response (wrong URL or error)
    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
      console.error('âŒ Received HTML instead of JSON. The Google Script might not be properly deployed.');
      console.error('ğŸ“„ Response:', text.substring(0, 500));

      // Store response for debugging
      try {
        sessionStorage.setItem('MW_LAST_RESPONSE', text.substring(0, 1000));
      } catch (e) {}

      throw new Error('Google Script returned HTML instead of JSON. Please check:\nâ€¢ Script is deployed as "Web app"\nâ€¢ Execute as: "Me"\nâ€¢ Who has access: "Anyone"');
    }

    setProgress(60);

    let result;
    try {
      result = JSON.parse(text);
    } catch (parseError) {
      console.error('âŒ Failed to parse response as JSON:', parseError);
      console.error('ğŸ“„ Response:', text);

      // Store response for debugging
      try {
        sessionStorage.setItem('MW_LAST_RESPONSE', text.substring(0, 1000));
      } catch (e) {}

      throw new Error('Invalid response from Google Script. Response: ' + text.substring(0, 100));
    }

    if (!result.success) {
      console.error('âŒ Server returned error:', result.error);
      throw new Error(result.error || 'Failed to load data from server');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 2: Process the data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Processing data...', 'Almost ready');
    setProgress(75);
    
    let data = result.data;
    if (typeof data === 'string') {
      data = JSON.parse(data);
    }
    
    // Handle empty/new user
    if (!data) {
      data = {
        units: [{ id: 'med-e', name: 'Medicine Unit E', icon: 'ğŸ¥', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }],
        settings: {},
        patients: [],
        unitRequests: [],
        trash: { patients: [], units: [] }
      };
    }
    
    const patientCount = data.patients?.length || 0;
    const unitCount = data.units?.length || 0;
    
    console.log('â˜ï¸ Cloud data received:', patientCount, 'patients,', unitCount, 'units');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 3: Warm the local cache
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Syncing local cache...', `${patientCount} patients, ${unitCount} units`);
    setProgress(90);
    
    const cachePayload = JSON.stringify({
      units: data.units || [],
      settings: data.settings || {},
      patients: data.patients || [],
      unitRequests: data.unitRequests || [],
      trash: data.trash || { patients: [], units: [] },
      rev: result.rev || 1,
      lastUpdated: new Date().toISOString(),
      _cloudVerified: true
    });
    
    // Write to ALL cache keys
    localStorage.setItem('medward_pro_v12', cachePayload);
    localStorage.setItem('MEDWARD_CACHE', cachePayload);
    localStorage.setItem('MW_REV', String(result.rev || 1));
    localStorage.setItem('MW_CLOUD_VERIFIED', Date.now().toString());
    localStorage.removeItem('MW_OFFLINE_MODE');
    
    console.log('âœ… Cache warmed successfully');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 4: Success - redirect
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setProgress(100);
    showSuccess();
    
    setTimeout(() => {
      window.location.href = 'landing.html';
    }, 600);
    
  } catch (error) {
    clearAllTimeouts();
    console.error('âŒ Cloud load failed:', error);

    // Enhanced error logging for debugging
    const errorDetails = {
      name: error.name,
      message: error.message,
      timestamp: new Date().toISOString(),
      apiUrl: CONFIG.API_URL,
      navigatorOnline: navigator.onLine,
      retryAttempt: retryCount
    };
    console.error('ğŸ“Š Error Details:', errorDetails);

    // Store error details for debug panel
    try {
      sessionStorage.setItem('MW_LAST_ERROR', JSON.stringify(errorDetails));
    } catch (e) {
      console.warn('Could not save error details');
    }

    // Check if it was a timeout/abort
    if (error.name === 'AbortError') {
      handleLoadFailure('Connection Timeout', `The server took too long to respond (${CONFIG.TIMEOUT_MS/1000}s). Please check your internet connection or try again.`);
      return;
    }

    // Check for network errors
    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      handleLoadFailure('Network Error', 'Could not reach the Google Script. Please check:\nâ€¢ Your internet connection\nâ€¢ The script URL is correct\nâ€¢ The script is deployed and accessible');
      return;
    }

    // Other errors
    handleLoadFailure('Connection Failed', error.message || 'An unexpected error occurred.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HANDLE LOAD FAILURE WITH AUTO-RETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleLoadFailure(title, message) {
  const hasCache = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');
  
  // Auto-retry logic
  if (retryCount < CONFIG.MAX_RETRIES) {
    retryCount++;
    setStatus('Retrying...', `Attempt ${retryCount} of ${CONFIG.MAX_RETRIES}`);
    updateRetryInfo();
    
    setTimeout(() => {
      loadCloudData();
    }, CONFIG.RETRY_DELAY_MS);
    return;
  }
  
  // Max retries reached
  if (hasCache) {
    // Offer to continue in offline mode
    showError(
      'Unable to Connect',
      'Could not reach the server after multiple attempts. You can continue with your cached data.',
      true
    );
  } else {
    // No cache - must retry
    showError(
      title,
      message + ' Please ensure you have an internet connection and try again.',
      false
    );
  }
  
  // Reset retry count for manual retry
  retryCount = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
console.log('ğŸš€ MedWard Pro - Cloud Loading');
console.log('ğŸ“¡ Google Script URL:', CONFIG.API_URL);
console.log('â±ï¸ Timeout:', CONFIG.TIMEOUT_MS / 1000, 'seconds');
console.log('ğŸ”„ Max retries:', CONFIG.MAX_RETRIES);
console.log('ğŸŒ Browser online:', navigator.onLine);
console.log('ğŸ’¾ Has cache:', !!(localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE')));
console.log('');
console.log('If the connection fails, check:');
console.log('1. Google Script is deployed as Web app');
console.log('2. Execute as: Me');
console.log('3. Who has access: Anyone');
console.log('4. Script URL matches the one above');
console.log('');

loadCloudData();
</script>
</body>
</html>
