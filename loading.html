<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#005eb8">
<meta name="apple-mobile-web-app-capable" content="yes">
<!-- Cache Control - Always fetch fresh -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Loading | MedWard Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #005eb8;
  --primary-dark: #003087;
  --bg-app: #f8fafc;
  --bg-surface: #ffffff;
  --text-main: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --success: #059669;
  --danger: #dc2626;
}

body.dark-theme {
  --primary: #60a5fa;
  --primary-dark: #93c5fd;
  --bg-app: #0f172a;
  --bg-surface: #1e293b;
  --text-main: #f8fafc;
  --text-secondary: #cbd5e1;
  --text-muted: #64748b;
  --border: #334155;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-app);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  transition: background-color 0.3s, color 0.3s;
}

.loading-container {
  text-align: center;
  max-width: 320px;
}

.loading-logo {
  width: 80px;
  height: 80px;
  background: var(--primary);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 24px;
  box-shadow: 0 8px 24px rgba(0, 94, 184, 0.25);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
}

.loading-logo svg {
  width: 44px;
  height: 44px;
  stroke: #fff;
  stroke-width: 2.5;
  fill: none;
}

.loading-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.loading-status {
  color: var(--text-secondary);
  font-size: 0.95rem;
  margin-bottom: 24px;
}

.loading-spinner-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 16px;
}

.loading-spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-progress {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.loading-error {
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fca5a5;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  display: none;
}

body.dark-theme .loading-error {
  background: #7f1d1d;
  border-color: #991b1b;
}

.loading-error.show {
  display: block;
}

.retry-btn {
  margin-top: 12px;
  padding: 10px 20px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
}

.retry-btn:hover {
  background: var(--primary-dark);
}

.loading-footer {
  position: fixed;
  bottom: 20px;
  color: var(--text-muted);
  font-size: 0.75rem;
}
</style>
</head>
<body>
<script>
// Apply saved theme immediately
(function() {
  const theme = localStorage.getItem('MEDWARD_THEME');
  if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-theme');
  }
})();
</script>

<div class="loading-container">
  <div class="loading-logo">
    <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
  </div>
  
  <h1 class="loading-title">MedWard Pro</h1>
  <p class="loading-status" id="loadingStatus">Connecting to cloud...</p>
  
  <div class="loading-spinner-container">
    <div class="loading-spinner" id="spinner"></div>
    <span class="loading-progress" id="loadingProgress">Please wait</span>
  </div>
  
  <div class="loading-error" id="errorBox">
    <div id="errorMessage">Failed to load data</div>
    <button class="retry-btn" onclick="loadCloudData()">Try Again</button>
  </div>
</div>

<div class="loading-footer">
  v17.1 â€¢ Cloud-First Edition
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzmWYRlBlhcXAvyB_l6F8oj3tbBm_YY2wwyR5hJNSxPs-QBP5OI4dZ8prQLindVcoKfHA/exec';

// Get credentials
const AUTH = {
  user: sessionStorage.getItem('MW_USER') || localStorage.getItem('MW_USER'),
  pass: sessionStorage.getItem('MW_PASS') || localStorage.getItem('MW_PASS')
};

// Check if logged in
if (!AUTH.user || !AUTH.pass) {
  window.location.href = 'login.html';
}

// Update status display
function setStatus(status, progress) {
  document.getElementById('loadingStatus').textContent = status;
  document.getElementById('loadingProgress').textContent = progress;
}

function showError(message) {
  document.getElementById('spinner').style.display = 'none';
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorBox').classList.add('show');
}

function hideError() {
  document.getElementById('spinner').style.display = 'block';
  document.getElementById('errorBox').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN: Fetch cloud data and warm cache
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCloudData() {
  hideError();
  setStatus('Connecting to cloud...', 'Please wait');

  try {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 1: Fetch data from cloud
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Loading your data...', 'Fetching from server');

    console.log('ðŸ“¡ Fetching from API:', API_URL);
    console.log('   Username:', AUTH.user);
    console.log('   Action: loadData');

    // Add timeout to prevent hanging
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

    const response = await fetch(API_URL, {
      method: 'POST',
      cache: 'no-store',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'loadData',
        username: AUTH.user,
        password: AUTH.pass,
        clientRev: 0  // Force full load - we want fresh data
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    console.log('ðŸ“¡ Response status:', response.status, response.statusText);
    console.log('   Response headers:', Object.fromEntries(response.headers.entries()));

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const text = await response.text();
    console.log('ðŸ“¡ Response text (first 200 chars):', text.substring(0, 200));

    // Check for HTML response (wrong URL or error)
    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
      console.error('âŒ Server returned HTML instead of JSON');
      throw new Error('Server returned invalid response (HTML instead of JSON)');
    }

    const result = JSON.parse(text);
    console.log('ðŸ“¡ Parsed result:', { success: result.success, error: result.error, dataKeys: Object.keys(result.data || {}) });
    
    if (!result.success) {
      throw new Error(result.error || 'Failed to load data');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 2: Process the data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Processing data...', 'Almost ready');
    
    let data = result.data;
    if (typeof data === 'string') {
      data = JSON.parse(data);
    }
    
    // Handle empty/new user
    if (!data) {
      data = {
        units: [{ id: 'med-e', name: 'Medicine Unit E', icon: 'ðŸ¥', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }],
        settings: {},
        patients: [],
        unitRequests: [],
        trash: { patients: [], units: [] }
      };
    }
    
    const patientCount = data.patients?.length || 0;
    const unitCount = data.units?.length || 0;
    
    console.log('â˜ï¸ Cloud data received:', patientCount, 'patients,', unitCount, 'units');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 3: Warm the local cache
    // This is the critical step - overwrites any stale local data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Syncing local cache...', patientCount + ' patients, ' + unitCount + ' units');
    
    const cachePayload = JSON.stringify({
      units: data.units || [],
      settings: data.settings || {},
      patients: data.patients || [],
      unitRequests: data.unitRequests || [],
      trash: data.trash || { patients: [], units: [] },
      rev: result.rev || 1,
      lastUpdated: new Date().toISOString(),
      _cloudVerified: true  // Mark as verified from cloud
    });
    
    // Write to ALL cache keys to ensure consistency
    localStorage.setItem('medward_pro_v12', cachePayload);
    localStorage.setItem('MEDWARD_CACHE', cachePayload);
    localStorage.setItem('MW_REV', String(result.rev || 1));
    
    // Set verification timestamp - dashboard will check this
    localStorage.setItem('MW_CLOUD_VERIFIED', Date.now().toString());

    // Clear offline mode flag since we successfully synced with cloud
    localStorage.removeItem('MW_OFFLINE_MODE');

    console.log('âœ… Cache warmed successfully');
    console.log('   MW_CLOUD_VERIFIED:', Date.now());
    console.log('   Dashboard will use this verified cache');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 4: Redirect to landing page
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    setStatus('Ready!', 'Redirecting...');
    
    // Small delay so user sees "Ready!" message
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 300);
    
  } catch (error) {
    console.error('âŒ Cloud load failed:', error);
    console.error('   Error type:', error.name);
    console.error('   Error message:', error.message);
    console.error('   Full error:', error);

    // Determine error type for better user messaging
    let errorMessage = 'Connection failed';
    if (error.name === 'AbortError') {
      errorMessage = 'Request timeout - server took too long to respond';
      console.error('   Cause: Request timeout (30 seconds)');
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error - check your internet connection';
      console.error('   Cause: Network error or CORS issue');
    } else if (error.message.includes('HTTP')) {
      errorMessage = `Server error: ${error.message}`;
      console.error('   Cause: HTTP error from server');
    } else {
      errorMessage = error.message;
      console.error('   Cause:', error.message);
    }

    // Check if we have local cache to fall back to
    const localCache = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');

    if (localCache) {
      // We have local data - let user continue in offline mode
      setStatus('Offline mode', 'Using cached data');

      // CRITICAL FIX: Set MW_CLOUD_VERIFIED even in offline mode to prevent redirect loop
      // Mark it with a special value to indicate it's offline cached data
      localStorage.setItem('MW_CLOUD_VERIFIED', 'offline_' + Date.now().toString());
      localStorage.setItem('MW_OFFLINE_MODE', 'true');

      console.log('âš ï¸ Using offline cached data - cloud sync failed');
      console.log('   MW_CLOUD_VERIFIED:', localStorage.getItem('MW_CLOUD_VERIFIED'));
      console.log('   Dashboard will use cached data in offline mode');
      console.log('   Error that triggered offline mode:', errorMessage);

      // Let user proceed after a moment
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1500);
    } else {
      // No local cache - show error and retry automatically
      showError(`${errorMessage}. Retrying...`);

      // Auto-retry after 3 seconds
      setTimeout(() => {
        loadCloudData();
      }, 3000);
    }
  }
}

// Start loading immediately
loadCloudData();
</script>
</body>
</html>
