/**
 * FIXED Login Page Initialization Script
 * =======================================
 * Replace the existing <script type="module"> section in login.html with this
 * 
 * Key fixes:
 * 1. Sets MW_AUTH_PENDING flag before Google redirect
 * 2. Better handling of redirect result
 * 3. Longer waits for mobile devices
 */

import { login, register, signInWithGoogle, handleGoogleRedirect } from './firebase.auth.js';
import { requireAuth, setLegacyCredentials, safeRedirect } from './auth.guard.js';
import { configureAuthPersistence } from './firebase.config.js';
import { auth } from './firebase.config.js';
import { getRedirectResult } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';

// ═══════════════════════════════════════════════════════════════════
// DEBUG HELPER - Shows messages on screen for mobile debugging
// ═══════════════════════════════════════════════════════════════════
function debugLog(msg) {
  console.log('[DEBUG]', msg);
  // Uncomment below to show debug messages on screen
  // const msgEl = document.getElementById('message');
  // if (msgEl) {
  //   msgEl.className = 'message success';
  //   msgEl.style.display = 'block';
  //   msgEl.innerHTML = (msgEl.innerHTML ? msgEl.innerHTML + '<br>' : '') + msg;
  // }
}

// ═══════════════════════════════════════════════════════════════════
// MOBILE REDIRECT FLOW - Must run FIRST before anything else
// ═══════════════════════════════════════════════════════════════════

(async function() {
  debugLog('1. Page loaded');

  // Check if we're returning from a Google redirect
  const authPending = sessionStorage.getItem('MW_AUTH_PENDING');
  debugLog('2. Auth pending flag: ' + (authPending ? 'YES' : 'NO'));

  try {
    debugLog('3. Calling getRedirectResult...');
    const result = await getRedirectResult(auth);
    debugLog('4. getRedirectResult done: ' + (result ? 'HAS RESULT' : 'null'));

    if (result && result.user) {
      debugLog('5. SUCCESS! User: ' + result.user.email);
      
      // Clear the pending flag since we succeeded
      sessionStorage.removeItem('MW_AUTH_PENDING');
      
      // Set legacy credentials for backward compatibility
      setLegacyCredentials(result.user);
      
      // Redirect to landing
      debugLog('6. Redirecting to landing.html...');
      window.location.href = 'landing.html';
      return;  // Stop execution - we're navigating away
    }

    debugLog('5. No redirect result');
    
    // If we had pending auth but no redirect result, wait longer
    // This handles the case where getRedirectResult fails but auth state exists
    if (authPending) {
      debugLog('6. Had pending auth, checking auth.currentUser...');
      
      // Wait a moment for Firebase to hydrate
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      if (auth.currentUser) {
        debugLog('7. Found user via currentUser: ' + auth.currentUser.email);
        sessionStorage.removeItem('MW_AUTH_PENDING');
        setLegacyCredentials(auth.currentUser);
        window.location.href = 'landing.html';
        return;
      }
      
      debugLog('7. No currentUser found, continuing to requireAuth...');
    }

  } catch (error) {
    debugLog('ERROR in getRedirectResult: ' + error.code + ' - ' + error.message);
    console.error('[Login] Redirect result error:', error);
    
    // Don't block on error - continue to normal auth check
  }

  // Clear pending flag if we get here - it didn't work
  sessionStorage.removeItem('MW_AUTH_PENDING');

  debugLog('8. Running requireAuth...');

  // Normal auth check - if user is already logged in, redirect to landing
  requireAuth({
    onAuthed: (user) => {
      debugLog('9. requireAuth: AUTHED as ' + user.email);
      setLegacyCredentials(user);
      safeRedirect('landing.html');
    },
    onUnauthed: () => {
      debugLog('9. requireAuth: NOT AUTHED - staying on login page');
      // User is not authenticated - they should stay on login page
      // No action needed
    },
    // FIXED: Use longer debounce for mobile
    nullDebounce: 1500
  });
})();

// ═══════════════════════════════════════════════════════════════════
// GOOGLE SIGN-IN HANDLER - FIXED VERSION
// ═══════════════════════════════════════════════════════════════════

async function handleGoogleSignIn() {
  const btn = document.getElementById('googleSignInBtn');
  const originalContent = btn.innerHTML;
  const rememberMe = document.getElementById('remember').checked;

  // Show loading state
  btn.disabled = true;
  btn.innerHTML = '<div class="loading-spinner"></div><span>Signing in...</span>';

  try {
    // Set auth persistence before attempting sign-in
    await configureAuthPersistence(rememberMe);

    // FIXED: Set pending flag BEFORE starting Google sign-in
    // This tells the landing page and login page that auth should be coming
    sessionStorage.setItem('MW_AUTH_PENDING', 'true');
    
    console.log('[Login] Starting Google sign-in...');
    const result = await signInWithGoogle();
    console.log('[Login] Google sign-in result:', result);

    if (result.success && result.pending) {
      // Mobile redirect - page will navigate away to Google
      // Keep the pending flag - it will be checked when we return
      console.log('[Login] Redirecting to Google (mobile flow)...');
      // Keep loading state, page will redirect
    } else if (result.success && result.user) {
      // Desktop popup success - redirect immediately
      console.log('[Login] Google sign-in successful (popup flow)');
      sessionStorage.removeItem('MW_AUTH_PENDING');  // Clear flag since we succeeded
      showMessage('Successfully signed in with Google!', false);
      setLegacyCredentials(result.user);
      safeRedirect('landing.html');
    } else if (!result.cancelled) {
      // Error occurred - clear pending flag
      sessionStorage.removeItem('MW_AUTH_PENDING');
      console.error('[Login] Google sign-in failed:', result.error);
      showMessage(result.error || 'Google sign-in failed');
      btn.disabled = false;
      btn.innerHTML = originalContent;
    } else {
      // User cancelled - clear pending flag
      sessionStorage.removeItem('MW_AUTH_PENDING');
      btn.disabled = false;
      btn.innerHTML = originalContent;
    }
  } catch (error) {
    // Error - clear pending flag
    sessionStorage.removeItem('MW_AUTH_PENDING');
    console.error('[Login] Google sign-in exception:', error);
    showMessage('Connection error. Please try again.');
    btn.disabled = false;
    btn.innerHTML = originalContent;
  }
}

// Make handleGoogleSignIn available globally
window.handleGoogleSignIn = handleGoogleSignIn;
