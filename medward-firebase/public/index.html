<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedWard Pro - Firebase Integration Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 30px;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
    }
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #dc3545;
    }
    .status-dot.connected {
      background: #28a745;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
    }
    .section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Fira Code', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .info { color: #2196f3; }
    .warning { color: #ff9800; }
    .loading {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .auth-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    @media (max-width: 600px) {
      .auth-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MedWard Pro - Firebase Integration Test</h1>
    <p class="subtitle">Test all Cloud Functions endpoints</p>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <div class="status-dot" id="firebaseStatus"></div>
        <span>Firebase</span>
      </div>
      <div class="status-item">
        <div class="status-dot" id="authStatus"></div>
        <span>Auth: <span id="authUser">Not signed in</span></span>
      </div>
    </div>

    <!-- Authentication Section -->
    <div class="section">
      <h2>Authentication</h2>
      <div class="auth-form">
        <div class="input-group">
          <label>Email</label>
          <input type="email" id="email" placeholder="test@example.com" value="test@medward.pro">
        </div>
        <div class="input-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Password" value="test123456">
        </div>
      </div>
      <div class="btn-group">
        <button class="btn-success" onclick="signIn()">Sign In</button>
        <button class="btn-primary" onclick="signUp()">Sign Up</button>
        <button class="btn-warning" onclick="signInWithGoogle()">Google Sign In</button>
        <button class="btn-danger" onclick="signOutUser()">Sign Out</button>
      </div>
    </div>

    <!-- Health Check Section -->
    <div class="section">
      <h2>System Health</h2>
      <div class="btn-group">
        <button class="btn-primary" onclick="checkHealth()">Check Backend Health</button>
      </div>
    </div>

    <!-- Data Operations Section -->
    <div class="section">
      <h2>Data Operations</h2>
      <div class="btn-group">
        <button class="btn-primary" onclick="loadUserData()">Load Data</button>
        <button class="btn-success" onclick="saveUserData()">Save Test Data</button>
        <button class="btn-secondary" onclick="getUserProfile()">Get Profile</button>
        <button class="btn-secondary" onclick="callHeartbeat()">Heartbeat</button>
      </div>
    </div>

    <!-- AI Functions Section -->
    <div class="section">
      <h2>AI Clinical Functions</h2>
      <div class="input-group">
        <label>Clinical Question / Input</label>
        <textarea id="clinicalInput" placeholder="Enter your clinical question, lab values, drug name, symptoms, or diagnosis...">What are the common causes of hypokalemia and how should it be managed?</textarea>
      </div>
      <div class="btn-group">
        <button class="btn-primary" onclick="askClinical()">Ask Clinical Question</button>
        <button class="btn-secondary" onclick="analyzeLabs()">Analyze Labs</button>
        <button class="btn-secondary" onclick="getDrugInfo()">Get Drug Info</button>
        <button class="btn-warning" onclick="generateDifferential()">Generate Differential</button>
        <button class="btn-success" onclick="getTreatmentPlan()">Get Treatment Plan</button>
        <button class="btn-danger" onclick="oncallConsult()">On-Call Consult</button>
      </div>
    </div>

    <!-- Trash Operations Section -->
    <div class="section">
      <h2>Trash Management</h2>
      <div class="btn-group">
        <button class="btn-secondary" onclick="getTrash()">View Trash</button>
        <button class="btn-danger" onclick="emptyTrash()">Empty Trash</button>
      </div>
    </div>

    <!-- Inbox Section -->
    <div class="section">
      <h2>Patient Inbox</h2>
      <div class="btn-group">
        <button class="btn-primary" onclick="checkInbox()">Check Inbox</button>
      </div>
    </div>

    <!-- Output Section -->
    <div class="section">
      <h2>Output</h2>
      <button class="btn-secondary" onclick="clearOutput()" style="margin-bottom: 15px;">Clear Output</button>
      <div id="output">Ready to test Firebase Cloud Functions...\n\nClick any button above to begin testing.</div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports (CDN v12.8.0)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
    import {
      getFunctions,
      httpsCallable,
      connectFunctionsEmulator
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-functions.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDuug0BTqO6DsSuyS2RkVcrcXCIB7E0oB4",
      authDomain: "medward-pro.firebaseapp.com",
      projectId: "medward-pro",
      storageBucket: "medward-pro.firebasestorage.app",
      messagingSenderId: "1033128540980",
      appId: "1:1033128540980:web:07bba197713232b0b54361",
      measurementId: "G-LQYE3F4T5C"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app, 'us-central1');

    // Connect to emulators in development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      connectFunctionsEmulator(functions, 'localhost', 5001);
      log('info', 'Connected to Firebase Functions Emulator on port 5001');
    }

    // Update Firebase status
    document.getElementById('firebaseStatus').classList.add('connected');
    log('success', 'Firebase initialized successfully');

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      const authStatus = document.getElementById('authStatus');
      const authUser = document.getElementById('authUser');
      if (user) {
        authStatus.classList.add('connected');
        authUser.textContent = user.email;
        log('success', `Signed in as: ${user.email}`);
      } else {
        authStatus.classList.remove('connected');
        authUser.textContent = 'Not signed in';
      }
    });

    // Logging function
    function log(type, message) {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = {
        success: '[SUCCESS]',
        error: '[ERROR]',
        info: '[INFO]',
        warning: '[WARNING]'
      }[type] || '[LOG]';
      output.innerHTML += `\n<span class="${type}">${timestamp} ${prefix} ${message}</span>`;
      output.scrollTop = output.scrollHeight;
    }

    function logJSON(label, data) {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      output.innerHTML += `\n<span class="info">${timestamp} [RESULT] ${label}:</span>\n${JSON.stringify(data, null, 2)}`;
      output.scrollTop = output.scrollHeight;
    }

    // Clear output
    window.clearOutput = function() {
      document.getElementById('output').innerHTML = 'Output cleared. Ready for new tests...';
    };

    // Authentication functions
    window.signIn = async function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        log('info', `Signing in as ${email}...`);
        const result = await signInWithEmailAndPassword(auth, email, password);
        log('success', `Signed in successfully: ${result.user.email}`);
      } catch (error) {
        log('error', `Sign in failed: ${error.message}`);
      }
    };

    window.signUp = async function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        log('info', `Creating account for ${email}...`);
        const result = await createUserWithEmailAndPassword(auth, email, password);
        log('success', `Account created: ${result.user.email}`);
      } catch (error) {
        log('error', `Sign up failed: ${error.message}`);
      }
    };

    window.signInWithGoogle = async function() {
      try {
        log('info', 'Opening Google sign-in popup...');
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        log('success', `Google sign-in successful: ${result.user.email}`);
      } catch (error) {
        log('error', `Google sign-in failed: ${error.message}`);
      }
    };

    window.signOutUser = async function() {
      try {
        await signOut(auth);
        log('success', 'Signed out successfully');
      } catch (error) {
        log('error', `Sign out failed: ${error.message}`);
      }
    };

    // Health check
    window.checkHealth = async function() {
      try {
        log('info', 'Checking backend health...');
        // healthCheck is an HTTP function, not callable
        const response = await fetch(
          window.location.hostname === 'localhost'
            ? 'http://localhost:5001/medward-pro/us-central1/healthCheck'
            : 'https://us-central1-medward-pro.cloudfunctions.net/healthCheck'
        );
        const data = await response.json();
        logJSON('Health Check', data);
        log('success', 'Backend is healthy!');
      } catch (error) {
        log('error', `Health check failed: ${error.message}`);
      }
    };

    // Data operations
    window.loadUserData = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Loading user data...');
        const loadData = httpsCallable(functions, 'loadData');
        const result = await loadData({ deviceId: 'test-device' });
        logJSON('User Data', result.data);
        log('success', 'Data loaded successfully');
      } catch (error) {
        log('error', `Load data failed: ${error.message}`);
      }
    };

    window.saveUserData = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Saving test data...');
        const saveData = httpsCallable(functions, 'saveData');
        const testData = {
          payload: {
            patients: [
              { id: 'test_patient_1', name: 'Test Patient', mrn: '12345', unitId: 'unit_1' }
            ],
            units: [
              { id: 'unit_1', name: 'Test Ward', code: '1234' }
            ]
          },
          deviceId: 'test-device'
        };
        const result = await saveData(testData);
        logJSON('Save Result', result.data);
        log('success', 'Data saved successfully');
      } catch (error) {
        log('error', `Save data failed: ${error.message}`);
      }
    };

    window.getUserProfile = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Getting user profile...');
        const getProfile = httpsCallable(functions, 'getUserProfile');
        const result = await getProfile({});
        logJSON('User Profile', result.data);
        log('success', 'Profile retrieved successfully');
      } catch (error) {
        log('error', `Get profile failed: ${error.message}`);
      }
    };

    window.callHeartbeat = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Sending heartbeat...');
        const heartbeat = httpsCallable(functions, 'heartbeat');
        const result = await heartbeat({ deviceId: 'test-device', clientRev: 0 });
        logJSON('Heartbeat Response', result.data);
        log('success', 'Heartbeat successful');
      } catch (error) {
        log('error', `Heartbeat failed: ${error.message}`);
      }
    };

    // AI Functions
    window.askClinical = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      const input = document.getElementById('clinicalInput').value;
      if (!input) {
        log('warning', 'Please enter a clinical question');
        return;
      }
      try {
        log('info', 'Sending clinical question to AI...');
        const askClinical = httpsCallable(functions, 'askClinical');
        const result = await askClinical({ question: input });
        logJSON('Clinical Answer', result.data);
        log('success', 'AI response received');
      } catch (error) {
        log('error', `Clinical question failed: ${error.message}`);
      }
    };

    window.analyzeLabs = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      const input = document.getElementById('clinicalInput').value;
      try {
        log('info', 'Analyzing labs...');
        const analyze = httpsCallable(functions, 'analyzeLabs');
        const labs = input || 'WBC: 12.5, Hgb: 95 g/L, Platelets: 250, K+: 3.2, Na+: 138, Creatinine: 120';
        const result = await analyze({ labs: labs });
        logJSON('Lab Analysis', result.data);
        log('success', 'Lab analysis complete');
      } catch (error) {
        log('error', `Lab analysis failed: ${error.message}`);
      }
    };

    window.getDrugInfo = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      const input = document.getElementById('clinicalInput').value;
      const drugName = input || 'Metformin';
      try {
        log('info', `Getting drug info for: ${drugName}...`);
        const drugInfo = httpsCallable(functions, 'getDrugInfo');
        const result = await drugInfo({ drugName: drugName });
        logJSON('Drug Information', result.data);
        log('success', 'Drug info retrieved');
      } catch (error) {
        log('error', `Get drug info failed: ${error.message}`);
      }
    };

    window.generateDifferential = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      const input = document.getElementById('clinicalInput').value;
      const symptoms = input || 'Fever, cough, shortness of breath, and fatigue for 3 days';
      try {
        log('info', 'Generating differential diagnosis...');
        const differential = httpsCallable(functions, 'generateDifferential');
        const result = await differential({ symptoms: symptoms });
        logJSON('Differential Diagnosis', result.data);
        log('success', 'Differential generated');
      } catch (error) {
        log('error', `Differential failed: ${error.message}`);
      }
    };

    window.getTreatmentPlan = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      const input = document.getElementById('clinicalInput').value;
      const diagnosis = input || 'Community-acquired pneumonia';
      try {
        log('info', 'Getting treatment plan...');
        const treatment = httpsCallable(functions, 'getTreatmentPlan');
        const result = await treatment({ diagnosis: diagnosis });
        logJSON('Treatment Plan', result.data);
        log('success', 'Treatment plan generated');
      } catch (error) {
        log('error', `Treatment plan failed: ${error.message}`);
      }
    };

    window.oncallConsult = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      const input = document.getElementById('clinicalInput').value;
      const scenario = input || 'Nurse calling about patient with sudden onset chest pain and diaphoresis';
      try {
        log('info', 'Requesting on-call consultation...');
        const consult = httpsCallable(functions, 'oncallConsult');
        const result = await consult({ scenario: scenario, urgency: 'high' });
        logJSON('On-Call Consultation', result.data);
        log('success', 'Consultation complete');
      } catch (error) {
        log('error', `On-call consult failed: ${error.message}`);
      }
    };

    // Trash functions
    window.getTrash = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Loading trash...');
        const getTrash = httpsCallable(functions, 'getTrash');
        const result = await getTrash({});
        logJSON('Trash Contents', result.data);
        log('success', 'Trash loaded');
      } catch (error) {
        log('error', `Get trash failed: ${error.message}`);
      }
    };

    window.emptyTrash = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Emptying trash...');
        const empty = httpsCallable(functions, 'emptyTrash');
        const result = await empty({});
        logJSON('Empty Trash Result', result.data);
        log('success', 'Trash emptied');
      } catch (error) {
        log('error', `Empty trash failed: ${error.message}`);
      }
    };

    // Inbox functions
    window.checkInbox = async function() {
      if (!auth.currentUser) {
        log('warning', 'Please sign in first');
        return;
      }
      try {
        log('info', 'Checking inbox...');
        const inbox = httpsCallable(functions, 'checkInbox');
        const result = await inbox({});
        logJSON('Inbox', result.data);
        log('success', 'Inbox checked');
      } catch (error) {
        log('error', `Check inbox failed: ${error.message}`);
      }
    };

    // Initial log
    log('info', 'MedWard Pro Firebase Test Page loaded');
    log('info', 'Firebase Project: medward-pro');
    log('info', `Running in ${window.location.hostname === 'localhost' ? 'EMULATOR' : 'PRODUCTION'} mode`);
  </script>
</body>
</html>
