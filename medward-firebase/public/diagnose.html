<!DOCTYPE html>
<html>
<head>
  <title>MedWard Diagnostics</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #0f0; }
    .pass { color: #0f0; }
    .fail { color: #f00; }
    .warn { color: #ff0; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #output { white-space: pre-wrap; border: 1px solid #333; padding: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>MedWard Pro - System Diagnostics</h1>
  <button onclick="runAllTests()">Run All Tests</button>
  <button onclick="document.getElementById('output').innerHTML=''">Clear</button>
  <div id="output"></div>

  <script>
    const config = {
      apiKey: "AIzaSyCf2bHaKm_-CMnppQJ4raMN1YKVg1ZVLeE",
      authDomain: "medward-pro.firebaseapp.com",
      projectId: "medward-pro",
      storageBucket: "medward-pro.firebasestorage.app",
      messagingSenderId: "1033128540980",
      appId: "1:1033128540980:web:10fc72b1e8d3f3731ad332"
    };

    const app = firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();
    functions.useEmulator && functions.region('us-central1');

    function log(msg, type = 'info') {
      const el = document.getElementById('output');
      const cls = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : type === 'warn' ? 'warn' : '';
      el.innerHTML += `<span class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</span>\n`;
    }

    async function runAllTests() {
      log('=== STARTING DIAGNOSTICS ===\n');

      // Test 1: Firebase Init
      log('1. Firebase Initialization...');
      try {
        log(`   App Name: ${app.name}`, 'pass');
        log(`   Project ID: ${config.projectId}`, 'pass');
      } catch(e) {
        log(`   FAILED: ${e.message}`, 'fail');
      }

      // Test 2: Auth State
      log('\n2. Authentication...');
      const user = auth.currentUser;
      if (user) {
        log(`   Signed in as: ${user.email}`, 'pass');
        log(`   UID: ${user.uid}`, 'pass');
      } else {
        log('   Not signed in - signing in with Google...', 'warn');
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await auth.signInWithPopup(provider);
          log(`   Signed in as: ${result.user.email}`, 'pass');
          log(`   UID: ${result.user.uid}`, 'pass');
        } catch(e) {
          log(`   Auth FAILED: ${e.message}`, 'fail');
        }
      }

      // Test 3: Firestore Read
      log('\n3. Firestore Connection...');
      try {
        const uid = auth.currentUser?.uid;
        if (uid) {
          const userDoc = await db.collection('users').doc(uid).get();
          if (userDoc.exists) {
            log(`   User document exists`, 'pass');
            log(`   Data: ${JSON.stringify(userDoc.data()).substring(0, 100)}...`, 'pass');
          } else {
            log(`   User document does NOT exist`, 'warn');
          }

          // Check units
          const unitsSnap = await db.collection('units').where('members', 'array-contains', uid).get();
          log(`   Units found: ${unitsSnap.size}`, unitsSnap.size > 0 ? 'pass' : 'warn');
          unitsSnap.forEach(doc => {
            log(`   - ${doc.data().name} (${doc.id})`, 'pass');
          });
        }
      } catch(e) {
        log(`   Firestore FAILED: ${e.message}`, 'fail');
      }

      // Test 4: Cloud Functions
      log('\n4. Cloud Functions...');
      try {
        const healthCheck = functions.httpsCallable('healthCheck');
        const result = await healthCheck();
        log(`   healthCheck: ${JSON.stringify(result.data)}`, 'pass');
      } catch(e) {
        log(`   healthCheck FAILED: ${e.message}`, 'fail');
      }

      try {
        const getUserProfile = functions.httpsCallable('getUserProfile');
        const result = await getUserProfile();
        log(`   getUserProfile: ${JSON.stringify(result.data).substring(0, 100)}...`, 'pass');
      } catch(e) {
        log(`   getUserProfile FAILED: ${e.message}`, 'fail');
      }

      try {
        const loadData = functions.httpsCallable('loadData');
        const result = await loadData();
        log(`   loadData: ${JSON.stringify(result.data).substring(0, 100)}...`, 'pass');
      } catch(e) {
        log(`   loadData FAILED: ${e.message}`, 'fail');
      }

      // Test 5: Window globals
      log('\n5. Global Variables...');
      log(`   window.state: ${typeof window.state}`, window.state ? 'pass' : 'fail');
      log(`   window.callFunction: ${typeof window.callFunction}`, typeof window.callFunction === 'function' ? 'pass' : 'fail');
      log(`   window.loadData: ${typeof window.loadData}`, typeof window.loadData === 'function' ? 'pass' : 'fail');
      log(`   window.FirebaseFunctions: ${typeof window.FirebaseFunctions}`, window.FirebaseFunctions ? 'pass' : 'fail');

      log('\n=== DIAGNOSTICS COMPLETE ===');
    }
  </script>
</body>
</html>
