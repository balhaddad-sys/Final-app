rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidTimestamp(field) {
      return field is timestamp || field == request.time;
    }

    // User profile document
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can update their own profile (but not change uid)
      allow update: if isOwner(userId)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid']));

      // Only Cloud Functions can create (via Admin SDK)
      // This prevents manual user creation - must go through auth trigger
      allow create: if false;

      // Users can delete their own account
      allow delete: if isOwner(userId);

      // User data subcollection (active, trash, inbox, sessions)
      match /data/{docId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // Allow user lookup by email (for patient handover feature)
    // Limited to 1 result to prevent enumeration
    match /users/{userId} {
      allow list: if isAuthenticated()
        && request.query.limit <= 1;
    }

    // Legacy collections (patients, units) - for backward compatibility
    // These may be used during migration from old structure
    match /patients/{patientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
        && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isAuthenticated()
        && resource.data.createdBy == request.auth.uid;
    }

    match /units/{unitId} {
      // Anyone authenticated can read units they're a member of
      allow read: if isAuthenticated()
        && (resource.data.members.hasAny([request.auth.uid])
            || resource.data.admins.hasAny([request.auth.uid]));

      // Only admins can update unit
      allow update: if isAuthenticated()
        && resource.data.admins.hasAny([request.auth.uid]);

      // Anyone can create a unit (they become admin)
      allow create: if isAuthenticated()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.admins.hasAny([request.auth.uid]);

      // Only admins can delete
      allow delete: if isAuthenticated()
        && resource.data.admins.hasAny([request.auth.uid]);
    }

    // Archive collection for soft-deleted items
    match /Archive/{docId} {
      allow read, write: if isAuthenticated();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
