<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedWard Monitor | God Mode</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
<script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
<style>
:root {
  --bg: #09090b;
  --bg-surface: #0c0c0f;
  --bg-card: #111114;
  --bg-elevated: #18181b;
  --border: #27272a;
  --border-glow: #3b82f6;
  --text: #e4e4e7;
  --text-dim: #71717a;
  --text-bright: #fafafa;
  --green: #10b981;
  --green-glow: #34d399;
  --red: #ef4444;
  --red-glow: #f87171;
  --blue: #3b82f6;
  --blue-glow: #60a5fa;
  --amber: #f59e0b;
  --purple: #8b5cf6;
  --cyan: #06b6d4;
  --font-mono: 'JetBrains Mono', 'Courier New', monospace;
  --font-display: 'Orbitron', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-mono);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCANLINE EFFECT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    rgba(0, 0, 0, 0.1) 0px,
    rgba(0, 0, 0, 0.1) 1px,
    transparent 1px,
    transparent 2px
  );
  pointer-events: none;
  z-index: 9999;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 2px;
  color: var(--green);
  text-shadow: 0 0 10px var(--green);
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--green), var(--cyan));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 100px;
  font-size: 0.75rem;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-dim);
  transition: all 0.3s;
}

.status-dot.online {
  background: var(--green);
  box-shadow: 0 0 8px var(--green-glow);
  animation: pulse 2s infinite;
}

.status-dot.offline {
  background: var(--red);
  box-shadow: 0 0 8px var(--red-glow);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.server-time {
  font-size: 0.8rem;
  color: var(--text-dim);
  font-variant-numeric: tabular-nums;
}

.btn {
  padding: 8px 16px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  background: var(--bg-card);
  border-color: var(--blue);
}

.btn-danger {
  border-color: var(--red);
  color: var(--red);
}

.btn-danger:hover {
  background: var(--red);
  color: white;
}

.btn-exit {
  background: transparent;
  border: none;
  color: var(--text-dim);
}

.btn-exit:hover {
  color: var(--red);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN GRID LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-grid {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 0;
  min-height: calc(100vh - 57px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--card-accent, var(--blue));
}

.stat-card.green::before { background: var(--green); }
.stat-card.red::before { background: var(--red); }
.stat-card.amber::before { background: var(--amber); }
.stat-card.purple::before { background: var(--purple); }

.stat-label {
  font-size: 0.7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.stat-value {
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-bright);
  text-shadow: 0 0 20px currentColor;
}

.stat-card.green .stat-value { color: var(--green); }
.stat-card.red .stat-value { color: var(--red); }
.stat-card.amber .stat-value { color: var(--amber); }
.stat-card.purple .stat-value { color: var(--purple); }

.stat-meta {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 4px;
}

/* Quick Actions */
.quick-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: auto;
}

.action-btn {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 10px;
}

.action-btn:hover {
  background: var(--bg-elevated);
  border-color: var(--blue);
  transform: translateX(4px);
}

.action-btn.danger:hover {
  border-color: var(--red);
  color: var(--red);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT AREA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-content {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  overflow: hidden;
}

/* Latency Graph Section */
.graph-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.section-title {
  font-size: 0.75rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::before {
  content: '';
  width: 8px;
  height: 8px;
  background: var(--blue);
  border-radius: 2px;
}

.latency-display {
  font-family: var(--font-display);
  font-size: 1.2rem;
  color: var(--green);
}

.latency-display.slow { color: var(--amber); }
.latency-display.critical { color: var(--red); }

.graph-container {
  height: 80px;
  display: flex;
  align-items: flex-end;
  gap: 3px;
  background: var(--bg);
  border-radius: 8px;
  padding: 12px;
  overflow: hidden;
}

.bar {
  flex: 1;
  max-width: 12px;
  min-width: 4px;
  background: linear-gradient(to top, var(--blue), var(--cyan));
  border-radius: 2px 2px 0 0;
  transition: height 0.3s ease-out;
  opacity: 0.8;
}

.bar:hover {
  opacity: 1;
}

.bar.slow {
  background: linear-gradient(to top, var(--amber), #fcd34d);
}

.bar.critical {
  background: linear-gradient(to top, var(--red), var(--red-glow));
  animation: glow-red 1s infinite;
}

@keyframes glow-red {
  0%, 100% { box-shadow: 0 0 5px var(--red); }
  50% { box-shadow: 0 0 15px var(--red); }
}

/* Terminal / Log Section */
.terminal-section {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 300px;
}

.terminal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
}

.terminal-tabs {
  display: flex;
  gap: 4px;
}

.terminal-tab {
  padding: 6px 12px;
  background: transparent;
  border: none;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 0.75rem;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s;
}

.terminal-tab:hover {
  color: var(--text);
  background: var(--bg-card);
}

.terminal-tab.active {
  color: var(--green);
  background: var(--bg-card);
}

.terminal-body {
  flex: 1;
  background: #000;
  padding: 12px;
  overflow-y: auto;
  font-size: 0.8rem;
  line-height: 1.6;
}

.log-entry {
  display: flex;
  gap: 12px;
  padding: 4px 0;
  border-bottom: 1px solid #111;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.log-time {
  color: #444;
  min-width: 80px;
}

.log-type {
  color: var(--blue);
  min-width: 100px;
  font-weight: 500;
}

.log-type.error {
  color: var(--red);
}

.log-type.success {
  color: var(--green);
}

.log-type.warning {
  color: var(--amber);
}

.log-user {
  color: var(--purple);
  min-width: 100px;
}

.log-details {
  color: var(--text-dim);
  flex: 1;
}

.log-details.error {
  color: var(--red-glow);
}

/* Empty state */
.terminal-empty {
  color: var(--text-dim);
  text-align: center;
  padding: 40px;
}

.terminal-empty-icon {
  font-size: 2rem;
  margin-bottom: 12px;
  opacity: 0.5;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING OVERLAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.loading-overlay.hidden {
  display: none;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 3px solid var(--border);
  border-top-color: var(--green);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-family: var(--font-display);
  font-size: 0.9rem;
  color: var(--green);
  letter-spacing: 2px;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCESS DENIED SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.access-denied {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.access-denied.hidden {
  display: none;
}

.access-denied-icon {
  font-size: 4rem;
  margin-bottom: 24px;
  animation: shake 0.5s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.access-denied-title {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--red);
  letter-spacing: 3px;
  margin-bottom: 12px;
  text-shadow: 0 0 20px var(--red);
}

.access-denied-text {
  color: var(--text-dim);
  font-size: 0.9rem;
  margin-bottom: 32px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 900px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
  
  .quick-actions {
    grid-column: 1 / -1;
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  .action-btn {
    flex: 1;
    min-width: 140px;
  }
}

@media (max-width: 600px) {
  .sidebar {
    grid-template-columns: 1fr;
  }
  
  .topbar {
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .topbar-left, .topbar-right {
    width: 100%;
    justify-content: space-between;
  }
}
</style>
</head>
<body>

<!-- Access Denied Screen -->
<div class="access-denied" id="accessDenied">
  <div class="access-denied-icon">ğŸ”’</div>
  <div class="access-denied-title">ACCESS DENIED</div>
  <div class="access-denied-text">Administrator credentials required</div>
  <button class="btn" onclick="window.location.href='login.html'">â† Return to Login</button>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">INITIALIZING SYSTEM MONITOR...</div>
</div>

<!-- Main App (hidden until authenticated) -->
<div id="mainApp" style="display:none">
  
  <!-- Top Bar -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo">
        <div class="logo-icon">âš¡</div>
        MEDWARD MONITOR
      </div>
      <div class="status-badge">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Connecting...</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="server-time" id="serverTime">--:--:--</div>
      <button class="btn" onclick="fetchStats()">â†» Refresh</button>
      <button class="btn btn-exit" onclick="exitMonitor()">âœ• Exit</button>
    </div>
  </header>

  <!-- Main Grid -->
  <div class="main-grid">
    
    <!-- Sidebar Stats -->
    <aside class="sidebar">
      <div class="stat-card green">
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="statUsers">--</div>
        <div class="stat-meta">Registered accounts</div>
      </div>
      
      <div class="stat-card" id="errorCard">
        <div class="stat-label">Error Rate</div>
        <div class="stat-value" id="statErrors">--%</div>
        <div class="stat-meta">Last 100 operations</div>
      </div>
      
      <div class="stat-card purple">
        <div class="stat-label">Avg Latency</div>
        <div class="stat-value" id="statLatency">--ms</div>
        <div class="stat-meta">API response time</div>
      </div>
      
      <div class="stat-card amber">
        <div class="stat-label">Storage Used</div>
        <div class="stat-value" id="statStorage">--</div>
        <div class="stat-meta">Google Drive quota</div>
      </div>
      
      <div class="quick-actions">
        <button class="action-btn" onclick="fetchStats()">
          <span>ğŸ”„</span> Force Sync
        </button>
        <button class="action-btn" onclick="exportLogs()">
          <span>ğŸ“¥</span> Export Logs
        </button>
        <button class="action-btn danger" onclick="confirmPurgeLogs()">
          <span>ğŸ—‘ï¸</span> Purge Logs
        </button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Latency Graph -->
      <section class="graph-section">
        <div class="section-header">
          <div class="section-title">API Heartbeat (Real-time Latency)</div>
          <div class="latency-display" id="currentLatency">--ms</div>
        </div>
        <div class="graph-container" id="latencyGraph">
          <!-- Bars will be added dynamically -->
        </div>
      </section>
      
      <!-- Terminal Logs -->
      <section class="terminal-section">
        <div class="terminal-header">
          <div class="terminal-tabs">
            <button class="terminal-tab active" data-filter="all">All Events</button>
            <button class="terminal-tab" data-filter="error">Errors</button>
            <button class="terminal-tab" data-filter="LOGIN">Logins</button>
            <button class="terminal-tab" data-filter="SAVE">Data Ops</button>
          </div>
          <div style="font-size:0.7rem; color:var(--text-dim)">
            <span id="logCount">0</span> events
          </div>
        </div>
        <div class="terminal-body" id="terminal">
          <div class="terminal-empty">
            <div class="terminal-empty-icon">ğŸ“¡</div>
            <div>Waiting for system events...</div>
          </div>
        </div>
      </section>
      
    </main>
  </div>
  
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = localStorage.getItem('MEDWARD_API_URL');
const ADMIN_KEY = sessionStorage.getItem('MW_ADMIN_KEY');
const VALID_KEYS = ['MEDWARD_ADMIN_MASTER', 'SHIFU_GOD_MODE'];

// State
let allLogs = [];
let latencyHistory = [];
let currentFilter = 'all';
let pingInterval;
let statsInterval;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECURITY CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAccess() {
  if (!ADMIN_KEY || !VALID_KEYS.includes(ADMIN_KEY)) {
    document.getElementById('accessDenied').classList.remove('hidden');
    document.getElementById('loading').classList.add('hidden');
    return false;
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  if (!checkAccess()) return;
  
  if (!API_URL) {
    alert('API URL not configured. Please login to MedWard first.');
    window.location.href = 'login.html';
    return;
  }
  
  // Show main app
  document.getElementById('accessDenied').classList.add('hidden');
  document.getElementById('mainApp').style.display = 'block';
  
  // Initial fetch
  await fetchStats();
  
  // Hide loading
  document.getElementById('loading').classList.add('hidden');
  
  // Start real-time updates
  startRealTimeUpdates();
  
  // Update clock
  updateClock();
  setInterval(updateClock, 1000);
  
  // Setup tab listeners
  setupTabs();
}

function startRealTimeUpdates() {
  // Ping every 2 seconds for latency graph
  pingInterval = setInterval(pingServer, 2000);
  
  // Full stats every 10 seconds
  statsInterval = setInterval(fetchStats, 10000);
}

function updateClock() {
  const now = new Date();
  document.getElementById('serverTime').textContent = now.toLocaleTimeString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callAPI(action, payload = {}) {
  const start = Date.now();
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, adminKey: ADMIN_KEY, ...payload })
    });
    const data = await res.json();
    const latency = Date.now() - start;
    return { ...data, latency };
  } catch (e) {
    return { success: false, error: e.message, latency: 0 };
  }
}

async function pingServer() {
  const start = Date.now();
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'ping', adminKey: ADMIN_KEY })
    });
    await res.json();
    const latency = Date.now() - start;
    updateLatency(latency);
    updateStatus(true);
  } catch (e) {
    updateLatency(0, true);
    updateStatus(false);
  }
}

async function fetchStats() {
  const res = await callAPI('getSystemStats');
  
  if (res.success) {
    // Update stats
    document.getElementById('statUsers').textContent = res.stats?.users || '0';
    document.getElementById('statErrors').textContent = res.stats?.errorRate || '0%';
    document.getElementById('statStorage').textContent = res.stats?.storageUsed || '0 MB';
    
    // Update error card color based on rate
    const errorRate = parseFloat(res.stats?.errorRate || '0');
    const errorCard = document.getElementById('errorCard');
    errorCard.className = 'stat-card ' + (errorRate > 10 ? 'red' : errorRate > 5 ? 'amber' : 'green');
    
    // Update logs
    if (res.logs) {
      allLogs = res.logs;
      renderLogs();
    }
    
    updateStatus(true);
  } else {
    updateStatus(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatus(isOnline) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  
  if (isOnline) {
    dot.className = 'status-dot online';
    text.textContent = 'SYSTEM ONLINE';
  } else {
    dot.className = 'status-dot offline';
    text.textContent = 'CONNECTION LOST';
  }
}

function updateLatency(ms, isError = false) {
  // Update display
  const display = document.getElementById('currentLatency');
  const avgDisplay = document.getElementById('statLatency');
  
  if (isError) {
    display.textContent = 'ERR';
    display.className = 'latency-display critical';
  } else {
    display.textContent = ms + 'ms';
    display.className = 'latency-display' + (ms > 2000 ? ' critical' : ms > 1000 ? ' slow' : '');
    
    // Track history for average
    latencyHistory.push(ms);
    if (latencyHistory.length > 30) latencyHistory.shift();
    
    const avg = Math.round(latencyHistory.reduce((a, b) => a + b, 0) / latencyHistory.length);
    avgDisplay.textContent = avg + 'ms';
  }
  
  // Update graph
  const graph = document.getElementById('latencyGraph');
  const bar = document.createElement('div');
  bar.className = 'bar';
  
  if (isError) {
    bar.className += ' critical';
    bar.style.height = '100%';
  } else {
    // Scale: 2000ms = 100% height
    const height = Math.min(100, Math.max(5, (ms / 2000) * 100));
    bar.style.height = height + '%';
    
    if (ms > 2000) bar.className += ' critical';
    else if (ms > 1000) bar.className += ' slow';
  }
  
  graph.appendChild(bar);
  
  // Keep max 60 bars
  while (graph.children.length > 60) {
    graph.removeChild(graph.children[0]);
  }
}

function renderLogs() {
  const terminal = document.getElementById('terminal');
  const countEl = document.getElementById('logCount');
  
  // Filter logs
  let filtered = allLogs;
  if (currentFilter === 'error') {
    filtered = allLogs.filter(l => l.isError);
  } else if (currentFilter !== 'all') {
    filtered = allLogs.filter(l => l.type?.includes(currentFilter));
  }
  
  countEl.textContent = filtered.length;
  
  if (filtered.length === 0) {
    terminal.innerHTML = `
      <div class="terminal-empty">
        <div class="terminal-empty-icon">ğŸ“¡</div>
        <div>No events matching filter</div>
      </div>
    `;
    return;
  }
  
  terminal.innerHTML = filtered.map(log => {
    const time = new Date(log.timestamp).toLocaleTimeString();
    const typeClass = log.isError ? 'error' : (log.type?.includes('SUCCESS') || log.type?.includes('LOGIN')) ? 'success' : '';
    const detailClass = log.isError ? 'error' : '';
    
    return `
      <div class="log-entry">
        <span class="log-time">[${time}]</span>
        <span class="log-type ${typeClass}">${log.type || 'UNKNOWN'}</span>
        <span class="log-user">${log.user || 'System'}</span>
        <span class="log-details ${detailClass}">${log.details || ''}</span>
      </div>
    `;
  }).join('');
}

function setupTabs() {
  document.querySelectorAll('.terminal-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.terminal-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentFilter = tab.dataset.filter;
      renderLogs();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportLogs() {
  const data = JSON.stringify(allLogs, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `medward_logs_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

async function confirmPurgeLogs() {
  const confirm1 = confirm('âš ï¸ DANGER: This will permanently delete all system logs.\n\nAre you sure?');
  if (!confirm1) return;
  
  const confirm2 = prompt('Type "PURGE" to confirm:');
  if (confirm2 !== 'PURGE') {
    alert('Purge cancelled.');
    return;
  }
  
  const res = await callAPI('purgeLogs');
  if (res.success) {
    allLogs = [];
    renderLogs();
    alert('âœ“ Logs purged successfully');
  } else {
    alert('Failed to purge logs: ' + (res.error || 'Unknown error'));
  }
}

function exitMonitor() {
  // Clear intervals
  clearInterval(pingInterval);
  clearInterval(statsInterval);
  
  // Clear admin key
  sessionStorage.removeItem('MW_ADMIN_KEY');
  
  // Redirect
  window.location.href = 'login.html';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
<script src="medward-tour.js"></script>
</body>
</html>
