/**
 * MedWard Lab Extraction Engine v1.0
 * Sophisticated algorithm for accurate medical lab value extraction
 * Works alongside Claude Vision for maximum accuracy
 */

const LabEngine = (function() {
  'use strict';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // LAB VALUE REFERENCE DATABASE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const LAB_REFERENCE = {
    // Hematology
    wbc: { name: 'WBC', unit: 'x10‚Åπ/L', low: 4.0, high: 11.0, critical_low: 2.0, critical_high: 30.0, category: 'hematology' },
    rbc: { name: 'RBC', unit: 'x10¬π¬≤/L', low: 4.5, high: 5.5, male: [4.5, 5.5], female: [4.0, 5.0], category: 'hematology' },
    hemoglobin: { name: 'Hemoglobin', aliases: ['hgb', 'hb'], unit: 'g/dL', low: 12, high: 17, male: [13.5, 17.5], female: [12, 16], critical_low: 7, critical_high: 20, category: 'hematology' },
    hematocrit: { name: 'Hematocrit', aliases: ['hct'], unit: '%', low: 36, high: 50, male: [40, 54], female: [36, 48], category: 'hematology' },
    platelets: { name: 'Platelets', aliases: ['plt'], unit: 'x10‚Åπ/L', low: 150, high: 400, critical_low: 50, critical_high: 1000, category: 'hematology' },
    mcv: { name: 'MCV', unit: 'fL', low: 80, high: 100, category: 'hematology' },
    mch: { name: 'MCH', unit: 'pg', low: 27, high: 33, category: 'hematology' },
    mchc: { name: 'MCHC', unit: 'g/dL', low: 32, high: 36, category: 'hematology' },
    rdw: { name: 'RDW', unit: '%', low: 11.5, high: 14.5, category: 'hematology' },
    neutrophils: { name: 'Neutrophils', aliases: ['neut', 'neu'], unit: '%', low: 40, high: 70, category: 'hematology' },
    lymphocytes: { name: 'Lymphocytes', aliases: ['lymph', 'lym'], unit: '%', low: 20, high: 40, category: 'hematology' },
    monocytes: { name: 'Monocytes', aliases: ['mono'], unit: '%', low: 2, high: 8, category: 'hematology' },
    eosinophils: { name: 'Eosinophils', aliases: ['eos'], unit: '%', low: 1, high: 4, category: 'hematology' },
    basophils: { name: 'Basophils', aliases: ['baso'], unit: '%', low: 0, high: 1, category: 'hematology' },

    // Chemistry - Electrolytes
    sodium: { name: 'Sodium', aliases: ['na'], unit: 'mmol/L', low: 136, high: 145, critical_low: 120, critical_high: 160, category: 'electrolytes' },
    potassium: { name: 'Potassium', aliases: ['k'], unit: 'mmol/L', low: 3.5, high: 5.0, critical_low: 2.5, critical_high: 6.5, category: 'electrolytes' },
    chloride: { name: 'Chloride', aliases: ['cl'], unit: 'mmol/L', low: 98, high: 106, category: 'electrolytes' },
    bicarbonate: { name: 'Bicarbonate', aliases: ['hco3', 'co2', 'tco2'], unit: 'mmol/L', low: 22, high: 29, category: 'electrolytes' },
    calcium: { name: 'Calcium', aliases: ['ca'], unit: 'mg/dL', low: 8.5, high: 10.5, critical_low: 6.0, critical_high: 13.0, category: 'electrolytes' },
    calcium_mmol: { name: 'Calcium', aliases: ['ca'], unit: 'mmol/L', low: 2.1, high: 2.6, category: 'electrolytes' },
    magnesium: { name: 'Magnesium', aliases: ['mg'], unit: 'mg/dL', low: 1.7, high: 2.2, category: 'electrolytes' },
    phosphate: { name: 'Phosphate', aliases: ['phos', 'phosphorus', 'po4'], unit: 'mg/dL', low: 2.5, high: 4.5, category: 'electrolytes' },

    // Renal Function
    bun: { name: 'BUN', aliases: ['urea nitrogen'], unit: 'mg/dL', low: 7, high: 20, category: 'renal' },
    urea: { name: 'Urea', unit: 'mmol/L', low: 2.5, high: 7.1, category: 'renal' },
    creatinine: { name: 'Creatinine', aliases: ['cr', 'creat'], unit: 'mg/dL', low: 0.7, high: 1.3, male: [0.7, 1.3], female: [0.6, 1.1], category: 'renal' },
    creatinine_umol: { name: 'Creatinine', aliases: ['cr', 'creat'], unit: 'Œºmol/L', low: 62, high: 115, category: 'renal' },
    egfr: { name: 'eGFR', unit: 'mL/min/1.73m¬≤', low: 90, high: 999, category: 'renal' },
    uric_acid: { name: 'Uric Acid', aliases: ['urate'], unit: 'mg/dL', low: 3.5, high: 7.2, category: 'renal' },

    // Liver Function
    ast: { name: 'AST', aliases: ['sgot', 'aspartate'], unit: 'U/L', low: 10, high: 40, critical_high: 1000, category: 'liver' },
    alt: { name: 'ALT', aliases: ['sgpt', 'alanine'], unit: 'U/L', low: 7, high: 56, critical_high: 1000, category: 'liver' },
    alp: { name: 'ALP', aliases: ['alkaline phosphatase', 'alk phos'], unit: 'U/L', low: 44, high: 147, category: 'liver' },
    ggt: { name: 'GGT', aliases: ['gamma gt'], unit: 'U/L', low: 9, high: 48, category: 'liver' },
    bilirubin_total: { name: 'Total Bilirubin', aliases: ['tbil', 't.bil', 'bilirubin', 't bil'], unit: 'mg/dL', low: 0.1, high: 1.2, critical_high: 15, category: 'liver' },
    bilirubin_direct: { name: 'Direct Bilirubin', aliases: ['dbil', 'd.bil', 'd bil'], unit: 'mg/dL', low: 0, high: 0.3, category: 'liver' },
    albumin: { name: 'Albumin', aliases: ['alb'], unit: 'g/dL', low: 3.5, high: 5.0, category: 'liver' },
    protein_total: { name: 'Total Protein', aliases: ['tp', 't protein'], unit: 'g/dL', low: 6.0, high: 8.3, category: 'liver' },

    // Cardiac Markers
    troponin: { name: 'Troponin I', aliases: ['trop', 'tni', 'hs troponin', 'hs-tni'], unit: 'ng/L', low: 0, high: 14, critical_high: 100, category: 'cardiac' },
    troponin_ng: { name: 'Troponin I', unit: 'ng/mL', low: 0, high: 0.04, critical_high: 0.5, category: 'cardiac' },
    bnp: { name: 'BNP', unit: 'pg/mL', low: 0, high: 100, critical_high: 500, category: 'cardiac' },
    nt_probnp: { name: 'NT-proBNP', aliases: ['ntprobnp', 'nt pro bnp'], unit: 'pg/mL', low: 0, high: 125, critical_high: 900, category: 'cardiac' },
    ck: { name: 'CK', aliases: ['cpk', 'creatine kinase'], unit: 'U/L', low: 30, high: 200, category: 'cardiac' },
    ck_mb: { name: 'CK-MB', aliases: ['ckmb'], unit: 'ng/mL', low: 0, high: 5, category: 'cardiac' },
    ldh: { name: 'LDH', aliases: ['lactate dehydrogenase'], unit: 'U/L', low: 140, high: 280, category: 'cardiac' },

    // Glucose & Diabetes
    glucose: { name: 'Glucose', aliases: ['glu', 'blood sugar', 'bs', 'fbg', 'fbs'], unit: 'mg/dL', low: 70, high: 100, critical_low: 40, critical_high: 500, category: 'metabolic' },
    glucose_mmol: { name: 'Glucose', unit: 'mmol/L', low: 3.9, high: 5.6, critical_low: 2.2, critical_high: 27.8, category: 'metabolic' },
    hba1c: { name: 'HbA1c', aliases: ['a1c', 'glycated hemoglobin'], unit: '%', low: 4, high: 5.6, category: 'metabolic' },

    // Lipid Panel
    cholesterol: { name: 'Total Cholesterol', aliases: ['chol', 'tc'], unit: 'mg/dL', low: 0, high: 200, category: 'lipid' },
    ldl: { name: 'LDL', aliases: ['ldl-c'], unit: 'mg/dL', low: 0, high: 100, category: 'lipid' },
    hdl: { name: 'HDL', aliases: ['hdl-c'], unit: 'mg/dL', low: 40, high: 999, category: 'lipid' },
    triglycerides: { name: 'Triglycerides', aliases: ['tg', 'trigs'], unit: 'mg/dL', low: 0, high: 150, category: 'lipid' },

    // Coagulation
    pt: { name: 'PT', aliases: ['prothrombin time'], unit: 'seconds', low: 11, high: 13.5, category: 'coagulation' },
    inr: { name: 'INR', aliases: ['pt/inr'], unit: '', low: 0.9, high: 1.1, category: 'coagulation' },
    ptt: { name: 'PTT', aliases: ['aptt', 'activated ptt'], unit: 'seconds', low: 25, high: 35, category: 'coagulation' },
    fibrinogen: { name: 'Fibrinogen', unit: 'mg/dL', low: 200, high: 400, category: 'coagulation' },
    d_dimer: { name: 'D-Dimer', aliases: ['ddimer'], unit: 'ng/mL', low: 0, high: 500, category: 'coagulation' },

    // Inflammatory Markers
    crp: { name: 'CRP', aliases: ['c-reactive protein'], unit: 'mg/L', low: 0, high: 10, category: 'inflammatory' },
    esr: { name: 'ESR', aliases: ['sed rate'], unit: 'mm/hr', low: 0, high: 20, male: [0, 15], female: [0, 20], category: 'inflammatory' },
    procalcitonin: { name: 'Procalcitonin', aliases: ['pct'], unit: 'ng/mL', low: 0, high: 0.1, critical_high: 2, category: 'inflammatory' },
    lactate: { name: 'Lactate', aliases: ['lactic acid', 'lac'], unit: 'mmol/L', low: 0.5, high: 2.0, critical_high: 4, category: 'inflammatory' },

    // Thyroid
    tsh: { name: 'TSH', unit: 'mIU/L', low: 0.4, high: 4.0, category: 'thyroid' },
    t4: { name: 'T4', aliases: ['free t4', 'ft4'], unit: 'ng/dL', low: 0.8, high: 1.8, category: 'thyroid' },
    t3: { name: 'T3', aliases: ['free t3', 'ft3'], unit: 'pg/mL', low: 2.3, high: 4.2, category: 'thyroid' },

    // Blood Gas
    ph: { name: 'pH', unit: '', low: 7.35, high: 7.45, critical_low: 7.2, critical_high: 7.6, category: 'blood_gas' },
    pco2: { name: 'pCO2', unit: 'mmHg', low: 35, high: 45, category: 'blood_gas' },
    po2: { name: 'pO2', unit: 'mmHg', low: 80, high: 100, category: 'blood_gas' },
    sao2: { name: 'SaO2', aliases: ['o2 sat'], unit: '%', low: 95, high: 100, category: 'blood_gas' },
    base_excess: { name: 'Base Excess', aliases: ['be'], unit: 'mEq/L', low: -2, high: 2, category: 'blood_gas' },

    // Urinalysis
    specific_gravity: { name: 'Specific Gravity', aliases: ['sp gr', 'sg'], unit: '', low: 1.005, high: 1.030, category: 'urinalysis' }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PATTERN MATCHING REGEX
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Build comprehensive regex patterns for each lab
  function buildLabPatterns() {
    const patterns = [];
    
    for (const [key, lab] of Object.entries(LAB_REFERENCE)) {
      const names = [lab.name];
      if (lab.aliases) names.push(...lab.aliases);
      
      // Create pattern for each name variant
      names.forEach(name => {
        // Pattern: Name followed by value with optional flag
        // Handles: "Sodium: 142", "Na* 142 H", "Potassium 5.8 mmol/L HH"
        const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        patterns.push({
          key,
          lab,
          regex: new RegExp(
            `(?:^|\\s|[,;])${escapedName}[\\s:=*]*([<>]?\\d+\\.?\\d*)\\s*([a-zA-Z/%¬≤¬≥Œº\\/]+)?\\s*(H{1,2}|L{1,2}|\\*|high|low|critical)?`,
            'gi'
          )
        });
      });
    }
    
    return patterns;
  }

  const LAB_PATTERNS = buildLabPatterns();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CORE EXTRACTION FUNCTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * Extract all lab values from text
   * @param {string} text - Raw text from OCR or input
   * @returns {Array} Array of extracted lab values with interpretation
   */
  function extractLabValues(text) {
    if (!text) return [];
    
    const results = [];
    const foundLabs = new Set();
    const normalizedText = normalizeText(text);
    
    // Method 1: Pattern matching with known lab names
    LAB_PATTERNS.forEach(({ key, lab, regex }) => {
      let match;
      regex.lastIndex = 0; // Reset regex
      
      while ((match = regex.exec(normalizedText)) !== null) {
        const value = parseFloat(match[1]);
        if (isNaN(value)) continue;
        
        const unit = match[2] || lab.unit;
        const flag = match[3] ? match[3].toUpperCase() : null;
        
        // Avoid duplicates
        const labKey = `${key}_${value}`;
        if (foundLabs.has(labKey)) continue;
        foundLabs.add(labKey);
        
        const interpretation = interpretValue(key, value, flag);
        
        results.push({
          name: lab.name,
          key,
          value,
          unit,
          flag: interpretation.flag,
          status: interpretation.status,
          severity: interpretation.severity,
          reference: `${lab.low}-${lab.high}`,
          category: lab.category,
          interpretation: interpretation.text
        });
      }
    });
    
    // Method 2: Generic number extraction with context
    const genericPattern = /(\w+[\w\s]*?)[:\s=*]+([<>]?\d+\.?\d*)\s*([a-zA-Z/%¬≤¬≥Œº\/]+)?\s*(H{1,2}|L{1,2}|\*)?/gi;
    let genericMatch;
    
    while ((genericMatch = genericPattern.exec(normalizedText)) !== null) {
      const possibleName = genericMatch[1].trim().toLowerCase();
      const value = parseFloat(genericMatch[2]);
      
      if (isNaN(value)) continue;
      
      // Check if we already captured this
      const alreadyFound = results.some(r => 
        r.name.toLowerCase().includes(possibleName) || 
        possibleName.includes(r.name.toLowerCase())
      );
      
      if (!alreadyFound && possibleName.length > 1 && possibleName.length < 30) {
        // Try to match to a known lab
        const matchedLab = findClosestLab(possibleName);
        if (matchedLab) {
          const interpretation = interpretValue(matchedLab.key, value, genericMatch[4]);
          results.push({
            name: matchedLab.lab.name,
            key: matchedLab.key,
            value,
            unit: genericMatch[3] || matchedLab.lab.unit,
            flag: interpretation.flag,
            status: interpretation.status,
            severity: interpretation.severity,
            reference: `${matchedLab.lab.low}-${matchedLab.lab.high}`,
            category: matchedLab.lab.category,
            interpretation: interpretation.text
          });
        }
      }
    }
    
    // Sort by severity (critical first) then by category
    results.sort((a, b) => {
      const severityOrder = { critical: 0, high: 1, low: 2, normal: 3 };
      const sevDiff = (severityOrder[a.severity] || 3) - (severityOrder[b.severity] || 3);
      if (sevDiff !== 0) return sevDiff;
      return a.category.localeCompare(b.category);
    });
    
    return results;
  }

  /**
   * Normalize text for better matching
   */
  function normalizeText(text) {
    return text
      .replace(/[‚Äì‚Äî]/g, '-')
      .replace(/['']/g, "'")
      .replace(/[""]/g, '"')
      .replace(/\s+/g, ' ')
      .replace(/(\d),(\d)/g, '$1.$2') // European decimal
      .replace(/x\s*10\^?(\d+)/gi, 'x10$1')
      .trim();
  }

  /**
   * Find closest matching lab from name
   */
  function findClosestLab(name) {
    const normalized = name.toLowerCase().replace(/[^a-z0-9]/g, '');
    
    for (const [key, lab] of Object.entries(LAB_REFERENCE)) {
      const labName = lab.name.toLowerCase().replace(/[^a-z0-9]/g, '');
      if (labName === normalized || labName.includes(normalized) || normalized.includes(labName)) {
        return { key, lab };
      }
      
      if (lab.aliases) {
        for (const alias of lab.aliases) {
          const aliasNorm = alias.toLowerCase().replace(/[^a-z0-9]/g, '');
          if (aliasNorm === normalized || aliasNorm.includes(normalized) || normalized.includes(aliasNorm)) {
            return { key, lab };
          }
        }
      }
    }
    
    return null;
  }

  /**
   * Interpret a lab value against reference ranges
   */
  function interpretValue(key, value, flagHint) {
    const lab = LAB_REFERENCE[key];
    if (!lab) {
      return { flag: flagHint || '', status: 'unknown', severity: 'normal', text: '' };
    }
    
    let status = 'normal';
    let severity = 'normal';
    let flag = '';
    let text = '';
    
    // Check critical values first
    if (lab.critical_low !== undefined && value < lab.critical_low) {
      status = 'critically low';
      severity = 'critical';
      flag = 'LL';
      text = `Critically low ${lab.name}. Immediate attention required.`;
    } else if (lab.critical_high !== undefined && value > lab.critical_high) {
      status = 'critically high';
      severity = 'critical';
      flag = 'HH';
      text = `Critically elevated ${lab.name}. Immediate attention required.`;
    } else if (value < lab.low) {
      status = 'low';
      severity = 'low';
      flag = 'L';
      text = `Low ${lab.name}.`;
    } else if (value > lab.high) {
      status = 'high';
      severity = 'high';
      flag = 'H';
      text = `Elevated ${lab.name}.`;
    } else {
      status = 'normal';
      severity = 'normal';
      flag = '';
      text = `${lab.name} within normal limits.`;
    }
    
    // Use hint flag if provided and more severe
    if (flagHint) {
      const hintUpper = flagHint.toUpperCase();
      if ((hintUpper === 'HH' || hintUpper === 'LL') && severity !== 'critical') {
        severity = 'critical';
        flag = hintUpper;
      }
    }
    
    return { flag, status, severity, text };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CLINICAL INTERPRETATION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * Generate clinical interpretation from extracted labs
   */
  function generateInterpretation(labs) {
    if (!labs || labs.length === 0) {
      return { summary: 'No lab values extracted.', findings: [], recommendations: [] };
    }
    
    const abnormal = labs.filter(l => l.severity !== 'normal');
    const critical = labs.filter(l => l.severity === 'critical');
    const normal = labs.filter(l => l.severity === 'normal');
    
    // Group by category
    const byCategory = {};
    labs.forEach(lab => {
      if (!byCategory[lab.category]) byCategory[lab.category] = [];
      byCategory[lab.category].push(lab);
    });
    
    // Generate summary
    let summary = '';
    if (critical.length > 0) {
      summary = `‚ö†Ô∏è CRITICAL: ${critical.length} critical value(s) requiring immediate attention. `;
    }
    if (abnormal.length > 0) {
      summary += `${abnormal.length} abnormal finding(s) identified. `;
    }
    if (normal.length > 0) {
      summary += `${normal.length} value(s) within normal limits.`;
    }
    
    // Generate findings
    const findings = abnormal.map(lab => ({
      name: lab.name,
      value: `${lab.value} ${lab.unit}`,
      flag: lab.flag,
      severity: lab.severity,
      interpretation: lab.interpretation,
      reference: lab.reference
    }));
    
    // Generate pattern-based insights
    const insights = detectPatterns(labs, byCategory);
    
    // Generate recommendations
    const recommendations = generateRecommendations(labs, byCategory, insights);
    
    return {
      summary,
      findings,
      normalFindings: normal.map(l => `${l.name}: ${l.value} ${l.unit}`),
      insights,
      recommendations,
      categories: byCategory
    };
  }

  /**
   * Detect clinical patterns from lab combinations
   */
  function detectPatterns(labs, byCategory) {
    const insights = [];
    
    // Helper to find lab by key
    const findLab = (key) => labs.find(l => l.key === key || l.key.startsWith(key));
    
    // Renal function assessment
    const cr = findLab('creatinine');
    const bun = findLab('bun') || findLab('urea');
    const k = findLab('potassium');
    const egfr = findLab('egfr');
    
    if (cr && cr.severity !== 'normal') {
      if (bun && bun.severity !== 'normal') {
        insights.push('üî¥ Elevated creatinine and BUN/urea suggest renal impairment. Consider AKI vs CKD.');
      }
      if (k && k.severity === 'high') {
        insights.push('‚ö†Ô∏è Hyperkalemia with renal dysfunction - monitor closely, consider treatment.');
      }
    }
    
    // Liver function assessment
    const ast = findLab('ast');
    const alt = findLab('alt');
    const alp = findLab('alp');
    const bili = findLab('bilirubin');
    const albumin = findLab('albumin');
    
    if (ast && alt && ast.severity !== 'normal' && alt.severity !== 'normal') {
      const ratio = ast.value / alt.value;
      if (ratio > 2) {
        insights.push('üìä AST:ALT ratio >2 suggests alcoholic liver disease or cirrhosis.');
      } else if (ratio < 1) {
        insights.push('üìä AST:ALT ratio <1 more consistent with viral hepatitis or NAFLD.');
      }
      if (ast.value > 1000 || alt.value > 1000) {
        insights.push('üî¥ Markedly elevated transaminases - consider acute hepatitis, ischemia, or drug-induced injury.');
      }
    }
    
    // Cardiac markers
    const trop = findLab('troponin');
    const bnp = findLab('bnp') || findLab('nt_probnp');
    
    if (trop && trop.severity !== 'normal') {
      insights.push('‚ù§Ô∏è Elevated troponin - evaluate for ACS, demand ischemia, or other causes of myocardial injury.');
    }
    if (bnp && bnp.severity !== 'normal') {
      insights.push('‚ù§Ô∏è Elevated BNP/NT-proBNP suggests cardiac strain or heart failure.');
    }
    
    // Anemia workup
    const hgb = findLab('hemoglobin');
    const mcv = findLab('mcv');
    
    if (hgb && hgb.severity === 'low') {
      if (mcv) {
        if (mcv.value < 80) {
          insights.push('ü©∏ Microcytic anemia - consider iron deficiency, thalassemia, or chronic disease.');
        } else if (mcv.value > 100) {
          insights.push('ü©∏ Macrocytic anemia - consider B12/folate deficiency, liver disease, or myelodysplasia.');
        } else {
          insights.push('ü©∏ Normocytic anemia - consider acute blood loss, chronic disease, or renal failure.');
        }
      }
    }
    
    // Infection/Inflammation
    const wbc = findLab('wbc');
    const crp = findLab('crp');
    const pct = findLab('procalcitonin');
    const lactate = findLab('lactate');
    
    if (wbc && wbc.severity === 'high') {
      insights.push('ü¶† Leukocytosis - consider infection, inflammation, or stress response.');
    }
    if (lactate && lactate.severity !== 'normal') {
      insights.push('‚ö†Ô∏è Elevated lactate - evaluate for tissue hypoperfusion, sepsis, or metabolic cause.');
    }
    
    // Electrolyte disturbances
    const na = findLab('sodium');
    if (na && na.severity !== 'normal') {
      if (na.severity === 'low') {
        insights.push('üíß Hyponatremia - assess volume status, consider SIADH, diuretics, or other causes.');
      } else {
        insights.push('üíß Hypernatremia - assess hydration status and free water deficit.');
      }
    }
    
    // Acid-base
    const ph = findLab('ph');
    const pco2 = findLab('pco2');
    const hco3 = findLab('bicarbonate');
    
    if (ph) {
      if (ph.value < 7.35) {
        if (pco2 && pco2.value > 45) {
          insights.push('ü´Å Respiratory acidosis - evaluate ventilation.');
        } else if (hco3 && hco3.value < 22) {
          insights.push('‚öóÔ∏è Metabolic acidosis - calculate anion gap, consider causes.');
        }
      } else if (ph.value > 7.45) {
        if (pco2 && pco2.value < 35) {
          insights.push('ü´Å Respiratory alkalosis - consider hyperventilation, pain, anxiety.');
        } else if (hco3 && hco3.value > 28) {
          insights.push('‚öóÔ∏è Metabolic alkalosis - consider vomiting, diuretics, contraction.');
        }
      }
    }
    
    return insights;
  }

  /**
   * Generate clinical recommendations
   */
  function generateRecommendations(labs, byCategory, insights) {
    const recs = [];
    const critical = labs.filter(l => l.severity === 'critical');
    
    if (critical.length > 0) {
      recs.push('üö® Notify senior physician of critical values immediately.');
      critical.forEach(lab => {
        if (lab.key.includes('potassium') && lab.flag === 'HH') {
          recs.push('Consider ECG, calcium gluconate, insulin/dextrose, and potassium-lowering measures.');
        }
        if (lab.key.includes('hemoglobin') && lab.flag === 'LL') {
          recs.push('Assess for active bleeding, consider transfusion if symptomatic.');
        }
        if (lab.key.includes('glucose') && lab.flag === 'LL') {
          recs.push('Immediate glucose administration required. Check for cause of hypoglycemia.');
        }
      });
    }
    
    // Add follow-up recommendations
    const abnormal = labs.filter(l => l.severity !== 'normal');
    if (abnormal.length > 0) {
      recs.push('Repeat abnormal labs to assess trend.');
    }
    
    if (byCategory['renal'] && byCategory['renal'].some(l => l.severity !== 'normal')) {
      recs.push('Monitor fluid balance and urine output closely.');
    }
    
    if (byCategory['liver'] && byCategory['liver'].some(l => l.severity !== 'normal')) {
      recs.push('Consider liver function trend and hepatology input if worsening.');
    }
    
    if (byCategory['cardiac'] && byCategory['cardiac'].some(l => l.severity !== 'normal')) {
      recs.push('Serial cardiac enzymes and ECG monitoring recommended.');
    }
    
    return recs;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PUBLIC API
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  return {
    extractLabValues,
    generateInterpretation,
    LAB_REFERENCE,
    
    /**
     * Full analysis pipeline
     * @param {string} text - Raw text from image/input
     * @returns {Object} Complete analysis with labs, interpretation, recommendations
     */
    analyze: function(text) {
      const labs = extractLabValues(text);
      const interpretation = generateInterpretation(labs);
      
      return {
        labs,
        ...interpretation,
        extractedCount: labs.length,
        criticalCount: labs.filter(l => l.severity === 'critical').length,
        abnormalCount: labs.filter(l => l.severity !== 'normal').length
      };
    },
    
    /**
     * Get reference range for a lab
     */
    getReference: function(labName) {
      const key = labName.toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const [k, lab] of Object.entries(LAB_REFERENCE)) {
        if (k.includes(key) || lab.name.toLowerCase().includes(key)) {
          return lab;
        }
        if (lab.aliases && lab.aliases.some(a => a.toLowerCase().includes(key))) {
          return lab;
        }
      }
      return null;
    }
  };
})();

// Export for browser
if (typeof window !== 'undefined') {
  window.LabEngine = LabEngine;
}
