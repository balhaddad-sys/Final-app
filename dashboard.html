<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#005eb8">
<meta name="apple-mobile-web-app-capable" content="yes">
<!-- ═══════════════════════════════════════════════════════════════════
     CACHE CONTROL - Prevent browser from serving stale versions
     ═══════════════════════════════════════════════════════════════════ -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>MedWard Pro v17.5</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.css"/>
<script src="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.js.iife.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ═══════════════════════════════════════════════════════════════════════════
   MEDWARD PRO v16 - CLINICAL WARD MANAGEMENT SYSTEM
   ═══════════════════════════════════════════════════════════════════════════
   
   TABLE OF CONTENTS:
   01. Design Tokens (CSS Variables)
   02. Dark Mode Overrides
   03. Global Reset & Accessibility
   04. Typography & Base Elements
   05. Layout Components (Header, Nav, Pages)
   06. UI Components (Cards, Buttons, Badges, Modals)
   07. Feature-Specific Styles
   08. Utilities & Helpers
   
   ═══════════════════════════════════════════════════════════════════════════ */

/* ═══════════════════════════════════════════════════════════════════════════
   01. DESIGN TOKENS (CSS Variables)
   ═══════════════════════════════════════════════════════════════════════════ */
/* 1. CLINICAL VARIABLES (The "UpToDate" Palette) */
/* 1. Base Variables (Day Mode / Medscape Style) */
:root {
    --primary: #005eb8;       /* NHS/Medical Standard Blue */
    --primary-dark: #003087;  /* Deep Navy for headings */
    --primary-light: #e6f0f9; /* Very faint blue for active states */
    --primary-dim: #e0f2fe;   /* Light Blue for backgrounds */
    --accent: #009688;        /* Teal for secondary actions */

    --bg-app: #f3f4f6;        /* Light Gray Background (Reduces glare) */
    --bg-surface: #ffffff;    /* Pure White Cards */
    --bg-input: #f9fafb;      /* Very light gray for inputs */

    --text-main: #111827;     /* Near Black (High Contrast) */
    --text-secondary: #6b7280;/* Gray for labels */
    --text-muted: #9ca3af;    /* Light gray for metadata */

    --border: #e5e7eb;        /* Subtle divider lines */

    --success-bg: #d1fae5; --success-text: #065f46;
    --danger-bg: #fee2e2;  --danger-text: #991b1b;
    --warning-bg: #fef3c7; --warning-text: #92400e;

    --nav-height: 60px;
    --header-height: 56px;

    /* Legacy color mappings for compatibility */
    --bg:#f3f4f6;
    --bg-card:#ffffff;
    --bg-elevated:#f9fafb;
    --bg-hover:#e5e7eb;
    --text:#111827;
    --text-muted:#6b7280;
    --gold:#005eb8;
    --gold-light:#0077cc;
    --teal:#14b8a6;
    --purple:#8b5cf6;
    --rose:#dc2626;
    --emerald:#059669;
    --success:#059669;
    --danger:#dc2626;
    --warning:#d97706;
    --blue:#3b82f6;
    --orange:#d97706;
    --border-light:#d1d5db;
    --glass:rgba(255,255,255,0.9);
    --radius:16px;
    --radius-sm:10px;
    --bottom-nav-height:65px;
    
    --shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* ═══════════════════════════════════════════════════════════════════════════
   02. DARK MODE OVERRIDES (Night Shift)
   ═══════════════════════════════════════════════════════════════════════════ */
body.dark-theme {
    --primary: #60a5fa;      /* Lighter Blue for dark backgrounds */
    --primary-dark: #93c5fd;
    --primary-light: #1e3a5f;
    --primary-dim: #1e293b;  /* Dark Blue/Slate */
    
    --bg-app: #0f172a;       /* Deep Navy/Black */
    --bg-surface: #1e293b;   /* Slate Gray */
    --bg-input: #334155;     /* Dark input background */
    
    --text-main: #f8fafc;    /* White */
    --text-secondary: #cbd5e1;
    --text-muted: #64748b;
    
    --border: #334155;       /* Darker border */
    
    --success-bg: #064e3b; --success-text: #6ee7b7;
    --danger-bg: #7f1d1d;  --danger-text: #fca5a5;
    --warning-bg: #78350f; --warning-text: #fcd34d;
    
    /* Legacy color mappings for dark mode */
    --bg: #0f172a;
    --bg-card: #1e293b;
    --bg-elevated: #334155;
    --bg-hover: #475569;
    --text: #f8fafc;
    --glass: rgba(30,41,59,0.95);
    --border-light: #475569;
    
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
}

/* 3. Global Transition (Makes the switch smooth) */
body, .card, .patient-row, .app-header, .bottom-nav, input, select, textarea, 
.modal-content, .action-sheet-content, .tab, .btn, .stat-card, .profile-card,
.section-card, .proto-card, .drug-card, .sys-card {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* 2. GLOBAL RESET */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}

/* Accessibility: Visible Focus Styles */
:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}
button:focus-visible, .btn:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, a:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(0, 94, 184, 0.15);
}
/* Skip link for screen readers */
.skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--primary);
    color: white;
    padding: 8px 16px;
    z-index: 10000;
    transition: top 0.3s;
}
.skip-link:focus {
    top: 0;
}
html,body{height:100%}
body {
    background-color: var(--bg-app);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding-bottom: calc(var(--nav-height) + 20px); /* Space for bottom nav */
    -webkit-font-smoothing: antialiased;
    line-height: 1.6;
    overflow-x: hidden;
}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
.mono{font-family:'JetBrains Mono',monospace}
/* Utilities */
.hidden { display: none !important; }
.btn-icon { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border-light);color:var(--text)}
.btn-secondary:hover{border-color:var(--primary)}
.btn-ghost{background:transparent;color:var(--text-secondary);padding:10px}
.btn-ghost:hover{color:var(--primary)}
.btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}
.btn-success{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--emerald)}
.btn-success:hover{background:rgba(16,185,129,0.25);border-color:var(--emerald)}
.btn-info{background:rgba(56,139,253,0.15);border:1px solid rgba(56,139,253,0.3);color:#58a6ff}
.btn-info:hover{background:rgba(56,139,253,0.25);border-color:#58a6ff}

/* ═══════════════════════════════════════════════════════════════════
   PRESTIGE ICON SYSTEM - Fine-Line Medical Grade Icons
   ═══════════════════════════════════════════════════════════════════ */
.icon-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.icon-btn:hover {
    background: var(--bg-elevated);
    color: var(--primary);
}
.icon-btn:active {
    transform: scale(0.95);
}
.icon-btn svg {
    width: 20px;
    height: 20px;
    stroke-width: 1.5;
    flex-shrink: 0;
}
.icon-btn.sm svg { width: 16px; height: 16px; }
.icon-btn.lg svg { width: 24px; height: 24px; }

/* Icon Button Variants */
.icon-btn.btn-delete:hover { 
    color: #dc2626; 
    background: rgba(220, 38, 38, 0.1); 
}
.icon-btn.btn-edit:hover { 
    color: var(--primary); 
    background: var(--primary-light); 
}
.icon-btn.btn-labs:hover { 
    color: #8b5cf6; 
    background: rgba(139, 92, 246, 0.1); 
}
.icon-btn.btn-meds:hover { 
    color: #14b8a6; 
    background: rgba(20, 184, 166, 0.1); 
}
.icon-btn.btn-docs:hover { 
    color: #f59e0b; 
    background: rgba(245, 158, 11, 0.1); 
}

/* Action Button with Border */
.action-icon-btn {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    padding: 10px;
    border-radius: 10px;
}
.action-icon-btn:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(0, 94, 184, 0.15);
}

/* Inline Icon in Text */
.inline-icon {
    width: 16px;
    height: 16px;
    stroke-width: 1.5;
    vertical-align: -3px;
    margin-right: 4px;
}

/* Section Header Icons */
.section-icon {
    width: 18px;
    height: 18px;
    stroke-width: 1.5;
    color: var(--primary);
    margin-right: 8px;
}

/* Status Icons */
.status-icon {
    width: 14px;
    height: 14px;
    stroke-width: 2;
}
.status-icon.critical { color: #dc2626; }
.status-icon.warning { color: #f59e0b; }
.status-icon.success { color: #059669; }
.status-icon.info { color: #3b82f6; }

/* SVG Spin Animation */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.spin { animation: spin 1s linear infinite; }

/* Tab Icon Styling */
.tab-icon, .nav-icon {
  display: inline-flex;
  align-items: center;
  margin-right: 6px;
  vertical-align: -4px;
}
/* ═══════════════════════════════════════════════════════════════════
   3. PROFESSIONAL HEADER
   ═══════════════════════════════════════════════════════════════════ */
.app-header {
    background: var(--primary);
    color: white;
    height: var(--header-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.brand { font-weight: 700; font-size: 1.15rem; letter-spacing: -0.3px; }
.brand-title {
    font-size: 1.15rem;
    font-weight: 700;
    letter-spacing: -0.3px;
}
.header-actions {
    display: flex;
    gap: 20px; /* Space between icons for easier targeting */
}
.header-actions .icon-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 12px; /* Increased from 8px for better touch target */
    margin: -8px; /* Visual compensation to maintain spacing */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
    min-width: 44px; /* Apple HIG minimum touch target */
    min-height: 44px;
    border-radius: 8px;
}
.header-actions .icon-btn:hover {
    opacity: 0.8;
    background: rgba(255,255,255,0.1);
}
.header-actions .icon-btn svg {
    width: 22px;
    height: 22px;
}

/* ═══════════════════════════════════════════════════════════════════
   6. BOTTOM NAVIGATION (Thumb Zone)
   ═══════════════════════════════════════════════════════════════════ */
.bottom-nav {
    position: fixed;
    bottom: 0; left: 0; width: 100%;
    height: var(--nav-height);
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 1000;
    padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
    flex: 1; height: 100%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--text-muted);
    font-size: 0.7rem; font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    border: none;
    position: relative;
    min-height: 60px; /* Ensure minimum touch target height */
    padding: 8px 4px;
}
.nav-item.active {
    color: var(--primary);
    background: rgba(0,94,184,0.05);
}
.nav-item:active {
    background: rgba(0,94,184,0.1);
    transform: scale(0.96);
}
.nav-icon { font-size: 1.4rem; margin-bottom: 3px; }

/* Legacy bottom nav support */
.tabs-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--bottom-nav-height);
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 1000;
    padding-bottom: env(safe-area-inset-bottom);
}
.tab-bottom {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    font-size: 0.7rem;
    gap: 4px;
    height: 100%;
    transition: color 0.2s;
    background: transparent;
    border: none;
    cursor: pointer;
}
.tab-bottom.active {
    color: var(--primary);
    background: rgba(0,94,184,0.05);
}
.tab-bottom i{font-size:1.4rem;margin-bottom:2px}
/* Ward Input Autocomplete */
.ward-input-wrapper{position:relative}
.ward-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--bg-elevated);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);max-height:200px;overflow-y:auto;z-index:10;display:none}
.ward-suggestions.show{display:block}
.ward-suggestion{padding:12px 16px;cursor:pointer;font-size:0.9rem;transition:background 0.2s}
.ward-suggestion:hover{background:var(--bg-hover);color:var(--primary)}
/* Patient Card Discharge */
.patient-card{position:relative}
.patient-card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px}
.patient-discharge-btn{padding:6px 12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:6px;color:var(--emerald);font-size:0.7rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.patient-discharge-btn:hover{background:rgba(16,185,129,0.2);border-color:var(--emerald)}
.patient-discharge-btn.discharged{background:rgba(107,114,128,0.1);border-color:rgba(107,114,128,0.3);color:var(--text-muted);cursor:default}
.patient-card.discharged{border-left-color:var(--text-muted);opacity:0.7}
.patient-card.discharged .patient-avatar{background:linear-gradient(135deg,var(--text-muted),#4b5563)}

/* Clinical Clarity Profile Actions */
.profile-actions {
    display: flex;
    gap: 6px;
}
.profile-actions .btn-sm {
    padding: 8px 14px;
    font-size: 0.75rem;
    border-radius: 8px;
    font-weight: 600;
    white-space: nowrap;
}
/* Professional Discharge Button */
#profileDischargeBtn {
    background: var(--success-bg);
    border: 1px solid var(--success-text);
    color: var(--success-text);
}
#profileDischargeBtn:hover {
    background: #a7f3d0;
    border-color: #047857;
}
/* Edit button styling */
.profile-actions .btn-secondary {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-secondary);
}
.profile-actions .btn-secondary:hover {
    background: var(--bg-hover);
    border-color: var(--primary);
    color: var(--primary);
}
/* Delete button styling */
.profile-actions .btn-danger {
    background: var(--danger-bg);
    border: 1px solid var(--danger-text);
    color: var(--danger-text);
}
.profile-actions .btn-danger:hover {
    background: #fecaca;
    border-color: #7f1d1d;
}
/* Lab Override */
.lab-value-card{cursor:pointer;transition:all 0.2s}
.lab-value-card:hover{border-color:var(--primary);transform:translateY(-2px)}
.lab-override-indicator{font-size:0.6rem;color:var(--gold);margin-left:4px}
/* Med Card Drug Info Button */
.med-card-action.info{background:rgba(56,139,253,0.1);border-color:rgba(56,139,253,0.3)}
.med-card-action.info:hover{background:rgba(56,139,253,0.2);border-color:#58a6ff}
.btn-sm{padding:10px 16px;font-size:0.8rem}
.btn-xs{padding:6px 12px;font-size:0.75rem}
.btn-full{width:100%}
.btn-icon{width:44px;height:44px;padding:0;border-radius:var(--radius-sm)}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.9rem;transition:all 0.2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary)}
.form-textarea{min-height:100px;resize:vertical}
.form-input-sm{padding:10px 14px;font-size:0.85rem}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;font-size:0.65rem;font-weight:700;text-transform:uppercase}
.badge-gold{background:rgba(0,94,184,0.15);color:var(--primary)}
.badge-teal{background:rgba(20,184,166,0.15);color:var(--teal)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--purple)}
.badge-rose{background:rgba(244,63,94,0.15);color:var(--rose)}
.badge-emerald{background:rgba(16,185,129,0.15);color:var(--emerald)}
.badge-blue{background:rgba(59,130,246,0.15);color:var(--blue)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:480px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-box.wide{max-width:700px}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.modal-title{font-size:1.1rem;font-weight:700}
.modal-body{padding:24px;overflow-y:auto;flex:1;padding-bottom:90px}
/* ═══════════════════════════════════════════════════════════════════
   STICKY FOOTER DOCK - Professional Medical Form Standard (Fitts's Law)
   ═══════════════════════════════════════════════════════════════════ */
.modal-footer {
    position: sticky;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    padding: 16px 24px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
    z-index: 100;
    display: flex;
    gap: 12px;
    flex-shrink: 0;
    padding-bottom: max(16px, env(safe-area-inset-bottom)); /* iPhone Safe Area */
}
.modal-footer .btn{flex:1;min-height:48px;font-size:1rem}
.modal-footer .btn-primary{flex:2} /* Make primary action larger/easier to hit */
.modal-footer .btn-secondary{flex:1}
.page{display:none;position:fixed;top:0;left:0;right:0;bottom:0;overflow-y:auto;-webkit-overflow-scrolling:touch;z-index:1;background:var(--bg-app);transition:background-color 0.3s ease}
.page.active{display:flex;flex-direction:column;z-index:10;visibility:visible}
#landing{align-items:center;justify-content:flex-start;padding:24px;padding-top:60px;padding-bottom:100px;background:var(--bg-app);transition:background-color 0.3s ease}
.landing-logo{width:72px;height:72px;background:var(--primary);border-radius:20px;display:grid;place-items:center;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,94,184,0.15);flex-shrink:0;transition:background-color 0.3s ease}
.landing-logo svg{width:40px;height:40px;stroke:#fff;stroke-width:2.5;fill:none}
.landing-title{font-size:1.8rem;font-weight:800;margin-bottom:6px;color:var(--text-main);transition:color 0.3s ease}
.landing-subtitle{color:var(--text-secondary);margin-bottom:6px;font-size:0.9rem;transition:color 0.3s ease}
.landing-version{color:var(--primary);font-size:0.7rem;font-weight:600;margin-bottom:20px;transition:color 0.3s ease}
.units-grid{display:grid;grid-template-columns:1fr;gap:12px;width:100%;max-width:400px}
.unit-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden}
.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--primary));transform:scaleX(0);transition:transform 0.3s}
.unit-card:hover::before{transform:scaleX(1)}
.unit-card:hover{border-color:var(--unit-color,var(--primary));transform:translateY(-2px)}
.unit-card-icon{font-size:2rem;margin-bottom:12px}
.unit-card-name{font-size:1rem;font-weight:700;margin-bottom:4px}
.unit-card-desc{color:var(--text-muted);font-size:0.8rem}
.fab{position:fixed;width:56px;height:56px;background:var(--bg-surface);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-secondary);z-index:50;transition:all 0.3s}
.fab svg{width:24px;height:24px}
.fab:hover{border-color:var(--primary);color:var(--primary)}
.admin-fab{bottom:24px;right:24px}
.sync-fab{bottom:24px;left:24px}
.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--primary);color:var(--primary)}
@keyframes rotate{to{transform:rotate(360deg)}}
/* Sync Status Indicator */
.sync-status{position:fixed;top:12px;right:12px;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:100px;font-size:0.75rem;font-weight:600;z-index:1000;transition:all 0.3s;opacity:0;transform:translateY(-10px);pointer-events:none}
.sync-status.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-status.syncing{border-color:var(--primary);color:var(--primary)}
.sync-status.synced{border-color:var(--emerald);color:var(--emerald)}
.sync-status.error{border-color:var(--rose);color:var(--rose)}
.sync-status.pending{border-color:var(--orange);color:var(--orange)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.sync-status.syncing .sync-dot{animation:pulse 1s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
/* Lab Extraction Confidence */
.extraction-confidence{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px;font-size:0.8rem}
.confidence-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.confidence-fill{height:100%;border-radius:3px;transition:width 0.5s ease}
.confidence-fill.high{background:var(--emerald)}
.confidence-fill.medium{background:var(--gold)}
.confidence-fill.low{background:var(--rose)}
.confidence-label{font-weight:600;min-width:40px;text-align:right}
/* Lab Extraction Preview */
.extraction-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin:16px 0}
.extraction-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.extraction-preview-title{font-weight:600;font-size:0.9rem}
.extraction-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.extraction-item:last-child{border-bottom:none}
.extraction-name{color:var(--text-secondary)}
.extraction-value{font-family:'JetBrains Mono',monospace;font-weight:600}
.extraction-value.critical{color:var(--rose)}
.extraction-value.high{color:var(--orange)}
.extraction-value.low{color:var(--blue)}
.extraction-value.normal{color:var(--emerald)}
/* ═══════════════════════════════════════════════════════════════════════════ */
/* PROFESSIONAL LAB ANALYSIS LOADING ANIMATION                                  */
/* ═══════════════════════════════════════════════════════════════════════════ */
.lab-analysis-loader{position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(12px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:all 0.3s ease}
.lab-analysis-loader.active{opacity:1;visibility:visible}
.loader-content{text-align:center;max-width:320px;padding:24px}
.dna-loader{width:80px;height:80px;margin:0 auto 24px;position:relative}
.dna-strand{position:absolute;width:100%;height:100%;animation:dnaRotate 2s linear infinite}
.dna-strand:nth-child(2){animation-delay:-1s}
.dna-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--gold)}
.dna-strand .dna-dot:nth-child(1){top:0;left:50%;transform:translateX(-50%);animation:dnaPulse 1s ease-in-out infinite}
.dna-strand .dna-dot:nth-child(2){top:50%;left:0;transform:translateY(-50%);animation:dnaPulse 1s ease-in-out infinite 0.25s;background:var(--teal)}
.dna-strand .dna-dot:nth-child(3){bottom:0;left:50%;transform:translateX(-50%);animation:dnaPulse 1s ease-in-out infinite 0.5s}
.dna-strand .dna-dot:nth-child(4){top:50%;right:0;transform:translateY(-50%);animation:dnaPulse 1s ease-in-out infinite 0.75s;background:var(--teal)}
.dna-connector{position:absolute;top:50%;left:10%;right:10%;height:2px;background:linear-gradient(90deg,var(--gold),var(--teal));transform:translateY(-50%);opacity:0.5}
@keyframes dnaRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes dnaPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:0.7}}
.loader-title{font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:8px}
.loader-subtitle{font-size:0.85rem;color:var(--text-muted);margin-bottom:20px}
.loader-steps{text-align:left;background:var(--bg-card);border-radius:var(--radius-sm);padding:16px;border:1px solid var(--border)}
.loader-step{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:0.85rem;color:var(--text-muted);transition:all 0.3s}
.loader-step:last-child{border-bottom:none}
.loader-step.active{color:var(--primary)}
.loader-step.complete{color:var(--emerald)}
.step-icon{width:24px;height:24px;border-radius:50%;background:var(--bg);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.7rem;transition:all 0.3s}
.loader-step.active .step-icon{border-color:var(--primary);background:rgba(0,94,184,0.15);animation:stepPulse 1.5s ease-in-out infinite}
.loader-step.complete .step-icon{border-color:var(--emerald);background:var(--emerald);color:#000}
@keyframes stepPulse{0%,100%{box-shadow:0 0 0 0 rgba(0,94,184,0.4)}50%{box-shadow:0 0 0 8px rgba(0,94,184,0)}}
/* ═══════════════════════════════════════════════════════════════════════════ */
/* ENHANCED LAB EXTRACTION PREVIEW MODAL                                        */
/* ═══════════════════════════════════════════════════════════════════════════ */
#labPreviewModal .modal-box{max-width:600px;max-height:95vh}
#labPreviewModal .modal-header{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(20,184,166,0.05));border-bottom:1px solid rgba(16,185,129,0.2)}
#labPreviewModal .modal-body{padding:0;overflow-y:auto}
.preview-images{display:flex;gap:8px;padding:16px;background:var(--bg);border-bottom:1px solid var(--border);overflow-x:auto}
.preview-images::-webkit-scrollbar{display:none}
.preview-thumb{width:64px;height:64px;border-radius:8px;object-fit:cover;border:2px solid var(--teal);flex-shrink:0}
.preview-thumb-wrapper{position:relative;flex-shrink:0}
.preview-thumb-badge{position:absolute;bottom:-4px;right:-4px;width:20px;height:20px;background:var(--teal);color:#000;border-radius:50%;font-size:0.65rem;font-weight:700;display:flex;align-items:center;justify-content:center}
.preview-confidence{padding:16px;background:linear-gradient(180deg,var(--bg-elevated),var(--bg-card));border-bottom:1px solid var(--border)}
.confidence-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.confidence-title{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
.confidence-badge{padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:700}
.confidence-badge.high{background:rgba(16,185,129,0.15);color:var(--emerald)}
.confidence-badge.medium{background:rgba(217,119,6,0.15);color:var(--warning)}
.confidence-badge.low{background:rgba(244,63,94,0.15);color:var(--rose)}
.confidence-bar-lg{height:8px;background:var(--border);border-radius:4px;overflow:hidden}
.confidence-bar-lg .fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1)}
.confidence-bar-lg .fill.high{background:linear-gradient(90deg,var(--emerald),var(--teal))}
.confidence-bar-lg .fill.medium{background:linear-gradient(90deg,var(--gold),var(--orange))}
.confidence-bar-lg .fill.low{background:linear-gradient(90deg,var(--rose),var(--orange))}
.confidence-warning{margin-top:12px;padding:10px 12px;background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.2);border-radius:8px;font-size:0.8rem;color:var(--rose);display:flex;align-items:center;gap:8px}
.preview-values{padding:16px}
.preview-section{margin-bottom:20px}
.preview-section:last-child{margin-bottom:0}
.preview-section-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.preview-section-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.9rem}
.preview-section-icon.critical{background:rgba(244,63,94,0.15)}
.preview-section-icon.abnormal{background:rgba(245,158,11,0.15)}
.preview-section-icon.normal{background:rgba(16,185,129,0.15)}
.preview-section-title{font-size:0.8rem;font-weight:700;color:var(--text)}
.preview-section-count{font-size:0.7rem;color:var(--text-muted);margin-left:auto}
.preview-lab-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px;transition:all 0.2s}
.preview-lab-card:last-child{margin-bottom:0}
.preview-lab-card:hover{border-color:var(--primary)}
.preview-lab-card.critical{border-left:3px solid var(--rose);background:linear-gradient(90deg,rgba(244,63,94,0.08),transparent)}
.preview-lab-card.high{border-left:3px solid var(--orange);background:linear-gradient(90deg,rgba(249,115,22,0.08),transparent)}
.preview-lab-card.low{border-left:3px solid var(--blue);background:linear-gradient(90deg,rgba(59,130,246,0.08),transparent)}
.preview-lab-card.normal{border-left:3px solid var(--emerald)}
.preview-lab-info{flex:1;min-width:0}
.preview-lab-name{font-size:0.85rem;font-weight:600;color:var(--text);margin-bottom:2px;display:flex;align-items:center;gap:6px}
.preview-lab-name .abbrev{font-size:0.7rem;color:var(--text-muted);font-weight:400}
.preview-lab-ref{font-size:0.7rem;color:var(--text-muted)}
.preview-lab-value{text-align:right}
.preview-lab-number{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700}
.preview-lab-number.critical{color:var(--rose)}
.preview-lab-number.high{color:var(--orange)}
.preview-lab-number.low{color:var(--blue)}
.preview-lab-number.normal{color:var(--emerald)}
.preview-lab-unit{font-size:0.7rem;color:var(--text-muted)}
.preview-lab-history{font-size:0.65rem;color:var(--teal);margin-top:2px}
.trend-indicator{display:inline-flex;align-items:center;gap:2px;font-size:0.7rem;margin-left:6px}
.trend-indicator.up{color:var(--rose)}
.trend-indicator.down{color:var(--emerald)}
.trend-indicator.stable{color:var(--text-muted)}
.preview-interpretation{padding:16px;background:linear-gradient(180deg,rgba(139,92,246,0.05),transparent);border-top:1px solid var(--border)}
.interpretation-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:0.8rem;font-weight:700;color:var(--purple)}
.interpretation-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.6}
.interpretation-findings{margin-top:12px}
.interpretation-finding{display:flex;align-items:flex-start;gap:8px;padding:8px 0;font-size:0.8rem;color:var(--text-secondary)}
.interpretation-finding::before{content:'•';color:var(--purple);font-weight:bold}
.preview-empty{text-align:center;padding:40px 20px;color:var(--text-muted)}
.preview-empty-icon{font-size:2rem;margin-bottom:12px;opacity:0.5}
.preview-empty-text{font-size:0.9rem}
.code-inputs{display:flex;gap:14px;justify-content:center;margin-bottom:20px}
.code-digit{width:56px;height:68px;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:700;text-align:center;color:var(--text);transition:all 0.2s}
.code-digit:focus{outline:none;border-color:var(--gold)}
.code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}
.code-digit.error{border-color:var(--rose);animation:shake 0.3s}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
@keyframes spin{to{transform:rotate(360deg)}}
.code-error{color:var(--rose);font-size:0.85rem;text-align:center;display:none;margin-top:12px}
.code-error.show{display:block}
#dashboard{background:var(--bg-app)}
.dash-header{background:var(--bg-surface);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;gap:8px}
.dash-brand{display:flex;align-items:center;gap:8px;min-width:0;flex-shrink:1}
.dash-brand-logo{width:36px;height:36px;background:var(--primary);border-radius:10px;display:grid;place-items:center;flex-shrink:0}
.dash-brand-logo svg{width:20px;height:20px;stroke:#fff;stroke-width:2.5;fill:none}
.dash-unit{font-weight:700;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px}
.dash-badge{background:var(--bg-app);padding:2px 8px;border-radius:8px;font-size:0.65rem;color:var(--text-muted);display:none}
.dash-user{display:flex;align-items:center;gap:6px;flex-shrink:0}
.dash-avatar{width:36px;height:36px;background:var(--primary);border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.8rem;color:#fff}
.dash-content{flex:1;max-width:1000px;margin:0 auto;padding:12px;width:100%}
.date-banner{background:var(--bg-surface);color:var(--text-main);padding:12px 16px;border-radius:var(--radius);margin-bottom:12px;font-weight:600;font-size:0.9rem;display:flex;align-items:center;gap:10px;border:1px solid var(--border)}
.tabs-container{background:var(--bg-surface);border-radius:var(--radius);padding:4px;margin-bottom:12px;display:flex;gap:4px;border:1px solid var(--border)}
.tab{flex:1;padding:10px 8px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-secondary);font-family:inherit;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.tab:hover{color:var(--text-main)}
.tab.active{background:var(--bg-elevated);color:var(--primary)}
.panel{display:none}
.panel.active{display:block}
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
.stat-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
.stat-card:hover,.stat-card.active{border-color:var(--primary);background:rgba(0,94,184,0.05)}
.stat-value{font-size:1.4rem;font-weight:800;color:var(--primary)}
.stat-label{font-size:0.65rem;color:var(--text-muted);margin-top:2px;text-transform:uppercase}
.action-buttons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.action-buttons .btn{padding:10px 8px;font-size:0.8rem}
.stat-value{font-size:1.5rem;font-weight:800;color:var(--primary)}
.stat-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
/* action-buttons handled above */
.ward-section{margin-bottom:24px}
.ward-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--bg-surface);border-radius:var(--radius-sm);margin-bottom:14px;border-left:4px solid var(--primary);border:1px solid var(--border);border-left:4px solid var(--primary)}
.ward-title{font-weight:700;font-size:0.95rem;color:var(--primary-dark)}
.ward-count{background:var(--primary);color:#fff;padding:4px 14px;border-radius:100px;font-size:0.75rem;font-weight:700}
/* ═══════════════════════════════════════════════════════════════════
   4. PATIENT LIST (Spreadsheet Style)
   ═══════════════════════════════════════════════════════════════════ */
#patientsList{padding:12px;display:flex;flex-direction:column;gap:8px}
#patientList {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* ═══════════════════════════════════════════════════════════════════
   5. THE PATIENT ROW (The Core Component)
   ═══════════════════════════════════════════════════════════════════ */
.patient-row {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    transition: background 0.1s;
    position: relative;
    overflow: hidden;
    cursor: pointer;
}
.patient-row:active { background: var(--primary-light); }

/* The colored strip on the left indicating status */
.patient-row::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    background: var(--primary);
}

/* Typography */
.p-name { font-size: 1.05rem; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
.p-demographics { font-size: 0.85rem; color: var(--text-secondary); }
.p-meta { text-align: right; }
.p-badge {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    background: var(--bg-app);
    color: var(--text-secondary);
}

/* Legacy patient card styles */
.patient-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-left: 4px solid var(--primary);
    border-radius: 8px;
    padding: 14px 16px; /* Increased padding for better touch target */
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0;
    min-height: 72px; /* Ensure minimum touch target (Apple HIG recommends 44px min) */
}
.patient-card:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,94,184,0.1)}
.patient-card:active{transform:scale(0.98);background:var(--primary-light)}
.patient-card.critical{border-left-color:var(--danger);background:linear-gradient(90deg,rgba(220,38,38,0.03),transparent)}
.patient-card.chronic{border-left-color:var(--purple)}
.patient-card.new{border-left-color:var(--success);background:linear-gradient(90deg,rgba(5,150,105,0.03),transparent)}
/* List-style patient info */
.p-info{flex:1;min-width:0}
.p-details{font-size:0.85rem;color:var(--text-secondary);margin-top:2px}
.p-chevron{margin-left:12px;color:var(--text-secondary)}
/* Legacy styles for profile pages */
.patient-header{display:flex;align-items:center;gap:16px}
.patient-avatar{width:52px;height:52px;border-radius:14px;display:grid;place-items:center;font-weight:700;font-size:0.9rem;color:#fff;flex-shrink:0;background:linear-gradient(135deg,var(--primary),var(--primary-dark))}
.patient-card.new .patient-avatar{background:linear-gradient(135deg,var(--success),var(--teal))}
.patient-card.chronic .patient-avatar{background:linear-gradient(135deg,var(--purple),#a855f7)}
.patient-card.critical .patient-avatar{background:linear-gradient(135deg,var(--danger),var(--warning))}
.patient-info{flex:1;min-width:0}
.patient-name{font-weight:700;font-size:1rem;margin-bottom:4px;color:var(--text-main)}
.patient-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:0.8rem;color:var(--text-secondary)}
.patient-diagnosis{font-size:0.85rem;color:var(--text-secondary);margin-top:12px;padding:12px 14px;background:var(--bg-app);border-radius:var(--radius-sm)}
#patientProfile{background:var(--bg);display:flex;flex-direction:column;height:100vh}
.profile-header{background:var(--bg-elevated);padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;flex-shrink:0}
.profile-nav{display:flex;align-items:center;gap:12px;margin-bottom:0}
.back-btn{width:36px;height:36px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);transition:all 0.2s}
.back-btn:hover{border-color:var(--primary);color:var(--primary)}
.profile-title{font-size:1rem;font-weight:700;flex:1}
.profile-actions{display:flex;gap:6px}
.profile-actions .btn{padding:6px 12px;font-size:0.75rem}
.profile-patient{display:flex;align-items:center;gap:12px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.profile-avatar{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;font-size:1rem;font-weight:800;color:#000;flex-shrink:0}
.profile-details h2{font-size:1rem;font-weight:700;margin-bottom:2px}
.profile-details .meta{display:flex;flex-wrap:wrap;gap:10px;color:var(--text-secondary);font-size:0.75rem}
/* Profile Layout - Sidebar on all devices */
.profile-body{display:flex;flex:1;overflow:hidden;min-height:0}
.profile-sidebar{width:200px;min-width:200px;background:var(--bg-surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:16px 12px;gap:4px;overflow-y:auto}
.profile-sidebar::-webkit-scrollbar{width:4px}
.profile-sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.profile-nav-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:transparent;border:none;border-radius:10px;color:var(--text-secondary);font-family:inherit;font-size:0.85rem;font-weight:500;cursor:pointer;transition:all 0.2s;text-align:left;width:100%;position:relative}
.profile-nav-item:hover{color:var(--text-main);background:var(--bg-app)}
.profile-nav-item.active{color:var(--primary);background:rgba(0,94,184,0.1);border-left:3px solid var(--primary);padding-left:11px}
.profile-nav-item .nav-icon{font-size:1.1rem;width:24px;text-align:center}
.profile-nav-item .nav-label{flex:1}
.profile-nav-item .nav-badge{background:rgba(244,63,94,0.2);color:#f87171;font-size:0.65rem;padding:2px 6px;border-radius:10px;font-weight:600}
.profile-nav-section{font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:16px 14px 8px;margin-top:8px}
.profile-nav-section:first-child{margin-top:0;padding-top:8px}
/* Hide mobile tabs - sidebar only */
.profile-tabs{display:none}
.profile-content{flex:1;padding:24px;overflow-y:auto;background:var(--bg)}
/* Mobile adjustments - bottom tabs instead of sidebar */
@media(max-width:768px){
.profile-sidebar{display:none!important}
.profile-tabs{
  display:flex!important;
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--bg-surface);
  border-top:1px solid var(--border);
  padding:8px 4px;
  padding-bottom:calc(8px + env(safe-area-inset-bottom));
  z-index:1000;
  box-shadow:0 -2px 10px rgba(0,0,0,0.1);
  gap:4px;
}
.profile-tab{
  flex:1 1 0;
  min-width:0;
  min-height:56px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:6px 2px;
  border-radius:12px;
  font-size:0.65rem;
  font-weight:600;
  gap:3px;
  background:transparent;
  border:none;
  color:var(--text-muted);
  cursor:pointer;
  transition:all 0.2s;
  -webkit-tap-highlight-color:transparent;
}
.profile-tab .tab-icon{
  font-size:1.3rem;
  line-height:1;
}
.profile-tab.active{
  color:var(--primary);
  background:var(--primary-light);
}
.profile-tab:active{
  transform:scale(0.95);
}
#patientProfile{padding-bottom:90px}
.profile-content{padding:16px;padding-bottom:100px}
}
body.dark-theme .profile-tabs{background:var(--bg-surface);border-color:var(--border);box-shadow:0 -2px 10px rgba(0,0,0,0.3)}
body.dark-theme .profile-tab.active{background:rgba(96,165,250,0.15)}
.profile-panel{display:none}
.profile-panel.active{display:block}
.section-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px;overflow:hidden}
.section-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.section-title{font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px}
.section-body{padding:20px}
/* Lab Upload Area */
.lab-upload-area{background:var(--bg-surface);border:1px dashed var(--border-light);border-radius:var(--radius-sm);padding:14px 16px;cursor:pointer;transition:all 0.2s;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.lab-upload-area:hover{border-color:var(--primary);background:rgba(0,94,184,0.03)}
.lab-upload-area.analyzing{pointer-events:none;opacity:0.7}
.lab-upload-icon{font-size:1.3rem;flex-shrink:0}
.lab-upload-content{flex:1;min-width:0}
.lab-upload-title{font-weight:600;font-size:0.82rem;margin-bottom:1px}
.lab-upload-subtitle{color:var(--text-muted);font-size:0.7rem}
@keyframes spin{to{transform:rotate(360deg)}}
/* AI Interpretation Card with Feedback */
.ai-interpretation{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.ai-interpretation-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ai-interpretation-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text)}
.ai-badge{background:var(--text-muted);color:#fff;font-size:0.6rem;padding:4px 8px;border-radius:4px;font-weight:700;letter-spacing:0.5px}
.ai-interpretation-text{color:var(--text-secondary);font-size:0.9rem;line-height:1.7;margin-bottom:16px}
.ai-details{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px}
.ai-details-title{font-size:0.75rem;font-weight:600;color:var(--primary);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.ai-details-list{list-style:none;padding:0;margin:0}
.ai-details-list li{font-size:0.85rem;color:var(--text-secondary);padding:6px 0;border-bottom:1px solid var(--border)}
.ai-details-list li:last-child{border-bottom:none}
.ai-disclaimer{font-size:0.7rem;color:var(--text-muted);background:var(--bg);padding:8px 12px;border-radius:6px;margin-bottom:12px;display:flex;align-items:center;gap:6px;border-left:3px solid var(--text-muted)}
/* Feedback Buttons */
.feedback-section{display:flex;align-items:center;justify-content:space-between;padding-top:16px;border-top:1px solid var(--border)}
.feedback-label{font-size:0.75rem;color:var(--text-muted)}
.feedback-buttons{display:flex;gap:8px}
.feedback-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--bg);cursor:pointer;display:grid;place-items:center;font-size:1.1rem;transition:all 0.2s}
.feedback-btn:hover{transform:scale(1.1)}
.feedback-btn.positive:hover,.feedback-btn.positive.active{background:rgba(16,185,129,0.2);border-color:var(--emerald)}
.feedback-btn.negative:hover,.feedback-btn.negative.active{background:rgba(244,63,94,0.2);border-color:var(--rose)}
.feedback-btn.active{transform:scale(1.1)}
.feedback-sent{font-size:0.75rem;color:var(--emerald);display:none}
.feedback-sent.show{display:block}
/* Critical Alert */
.critical-alert{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;display:flex;align-items:flex-start;gap:12px}
.critical-alert-icon{font-size:1.25rem;flex-shrink:0}
.critical-alert-content{flex:1;min-width:0}
.critical-alert-title{font-weight:700;color:var(--rose);margin-bottom:8px}
.critical-alert-values{font-size:0.85rem;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:6px 12px}
.critical-alert-values .val-item{white-space:nowrap}
/* Lab Categories */
.lab-category{background:var(--bg);border-radius:var(--radius-sm);margin-bottom:16px;overflow:hidden}
.lab-category-header{padding:12px 16px;background:rgba(0,94,184,0.08);font-weight:600;font-size:0.8rem;color:var(--primary);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px}
.lab-category-body{padding:16px}
.lab-values-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.lab-value-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;transition:all 0.2s}
.lab-value-card.high{border-left:3px solid var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.lab-value-card.low{border-left:3px solid var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.05),transparent)}
.lab-value-card.critical{border-left:3px solid var(--rose);background:rgba(244,63,94,0.1)}
.lab-value-card.normal{border-left:3px solid var(--emerald)}
.lab-value-name{font-size:0.75rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.lab-value-status{font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:4px}
.lab-value-status.high,.lab-value-status.critical{background:var(--rose);color:#fff}
.lab-value-status.low{background:var(--blue);color:#fff}
.lab-value-number{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:600;margin-bottom:4px}
.lab-value-card.high .lab-value-number{color:var(--rose)}
.lab-value-card.low .lab-value-number{color:var(--blue)}
.lab-value-card.normal .lab-value-number{color:var(--emerald)}
.lab-value-unit{font-size:0.7rem;color:var(--text-muted)}
.lab-value-range{font-size:0.65rem;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
/* Professional Trend Row Styles (Delta Card Design) */
.trend-row{display:grid;grid-template-columns:1fr 70px 80px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg-card)}
.trend-row:last-child{border-bottom:none}
.test-meta{display:flex;flex-direction:column}
.test-name{font-weight:600;color:var(--text-main);font-size:0.9rem}
.test-unit{font-size:0.7rem;color:var(--text-muted);margin-top:2px}
.delta-badge{font-size:0.7rem;font-weight:700;font-family:'JetBrains Mono',monospace;padding:3px 8px;border-radius:6px;display:inline-block;margin-top:4px}
.delta-bad{background:#fee2e2;color:#dc2626}
.delta-good{background:#d1fae5;color:#059669}
.delta-neutral{background:#f3f4f6;color:#6b7280}
.current-val{text-align:right;font-size:1.15rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text-main)}
.val-abnormal{color:#dc2626}
.val-low{color:#3b82f6}
.lab-sparkline{flex-shrink:0;display:flex;align-items:center;justify-content:center}
.lab-trend-indicator{font-family:'JetBrains Mono',monospace}
/* Trend Section */
.lab-trend-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
.lab-trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.lab-trend-select{padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.85rem;min-width:180px}
.lab-trend-chart{background:var(--bg);border-radius:var(--radius-sm);padding:20px;height:220px}
/* Other sections */
.vitals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px}
.vital-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center;border:1px solid var(--border)}
.vital-icon{margin-bottom:8px;display:flex;justify-content:center}
.vital-icon svg{width:28px;height:28px;color:var(--primary)}
.vital-value{font-size:1.25rem;font-weight:700;font-family:'JetBrains Mono',monospace}
.vital-value.empty{color:var(--text-muted);font-size:1rem}
.vital-label{font-size:0.7rem;color:var(--text-muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px}
.fluid-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.fluid-stat{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.fluid-stat-value{font-size:1.5rem;font-weight:800}
.fluid-stat-value.intake{color:var(--blue)}
.fluid-stat-value.output{color:var(--orange)}
.fluid-stat-value.balance{color:var(--emerald)}
.fluid-stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.fluid-chart-container{height:200px;margin-top:20px}
.plan-item{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;border-left:3px solid var(--gold)}
.plan-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.plan-item-date{font-size:0.7rem;color:var(--text-muted)}
.plan-item-content{font-size:0.9rem;white-space:pre-wrap}
.imaging-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px}
.imaging-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.imaging-type{font-weight:600;display:flex;align-items:center;gap:8px}
.imaging-date{font-size:0.75rem;color:var(--text-muted)}
.imaging-summary{font-size:0.85rem;color:var(--text-secondary)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:16px 28px;border-radius:var(--radius);font-size:0.9rem;opacity:0;transition:all 0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
.empty-state{text-align:center;padding:60px 24px;color:var(--text-muted)}
.empty-state-icon{font-size:3.5rem;margin-bottom:16px;opacity:0.4}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 24px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover{border-color:var(--primary);background:rgba(0,94,184,0.05)}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ref-card{background:var(--bg-surface);border-radius:var(--radius-sm);padding:18px;border-left:3px solid var(--primary);border:1px solid var(--border);border-left:3px solid var(--primary)}
.ref-card h4{font-size:0.9rem;margin-bottom:10px}
.ref-card p{font-size:0.8rem;color:var(--text-secondary)}
.import-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--teal)}
.import-ward-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--primary);border-radius:8px;color:var(--primary);font-size:0.75rem;font-weight:600}
#adminPanel{background:var(--bg)}
.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 20px;display:flex;justify-content:space-between;align-items:center}
.admin-content{max-width:700px;margin:0 auto;padding:16px;width:100%}
.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px;overflow:hidden}
.admin-section .section-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.admin-section .section-title{font-weight:700;font-size:1rem}
.admin-section .section-body{padding:16px}

/* Admin Unit Cards - Mobile First */
.admin-unit-card{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px;border:1px solid var(--border);transition:all 0.2s;gap:12px}
.admin-unit-card:last-child{margin-bottom:0}
.admin-unit-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.admin-unit-main{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
.admin-unit-icon{font-size:1.75rem;flex-shrink:0;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border-radius:10px;border:1px solid var(--border)}
.admin-unit-info{min-width:0;flex:1}
.admin-unit-name{font-weight:700;font-size:0.95rem;color:var(--text);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.admin-unit-code{font-size:0.75rem;color:var(--text-muted);display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.admin-unit-code code{background:var(--primary);color:#fff;padding:2px 8px;border-radius:5px;font-weight:600;font-size:0.8rem;letter-spacing:1px}
.admin-unit-actions{display:flex;gap:6px;flex-shrink:0}
.admin-action-btn{width:38px;height:38px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;color:var(--text-secondary)}
.admin-action-btn:hover{border-color:var(--primary);color:var(--primary);background:rgba(0,94,184,0.05)}
.admin-action-btn.delete:hover{border-color:var(--rose);color:var(--rose);background:rgba(244,63,94,0.05)}
.admin-empty-state{text-align:center;padding:40px 20px}
.admin-empty-icon{font-size:3rem;margin-bottom:12px;opacity:0.5}
.admin-empty-text{font-weight:600;color:var(--text);margin-bottom:4px}
.admin-empty-hint{font-size:0.85rem;color:var(--text-muted)}

/* Admin Tabs - Improved Mobile */
.admin-tabs{display:flex;gap:4px;margin-bottom:16px;background:var(--bg);padding:4px;border-radius:var(--radius-sm);overflow-x:auto;-webkit-overflow-scrolling:touch}
.admin-tab{flex:1;min-width:0;padding:12px 8px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-family:inherit;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:4px}
.admin-tab:hover{color:var(--text)}
.admin-tab.active{background:var(--bg-card);color:var(--primary);box-shadow:0 1px 3px rgba(0,0,0,0.08)}

/* Admin Mobile Responsive */
@media(max-width:480px){
.admin-content{padding:12px}
.admin-section .section-header{padding:14px}
.admin-section .section-body{padding:12px}
.admin-unit-card{padding:12px;gap:10px}
.admin-unit-main{gap:10px}
.admin-unit-icon{width:40px;height:40px;font-size:1.5rem;border-radius:8px}
.admin-unit-name{font-size:0.9rem}
.admin-unit-code{font-size:0.7rem}
.admin-unit-code code{padding:2px 6px;font-size:0.75rem}
.admin-action-btn{width:34px;height:34px;border-radius:6px}
.admin-action-btn svg{width:16px;height:16px}
}
@media(max-width:640px){
.stats-grid{grid-template-columns:repeat(5,1fr);gap:6px}
.stat-card{padding:10px 4px}
.stat-value{font-size:1.2rem}
.stat-label{font-size:0.6rem}
.action-buttons{grid-template-columns:1fr 1fr 1fr;gap:6px}
.action-buttons .btn{font-size:0.75rem;padding:10px 6px}
.profile-patient{flex-direction:column;text-align:center}
.profile-details .meta{justify-content:center}
.lab-values-grid{grid-template-columns:repeat(2,1fr)}
}
/* Unit Request Styles */
.request-unit-btn{margin-top:32px;padding:16px 32px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius);color:var(--text-muted);font-size:0.9rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:10px}
.request-unit-btn:hover{border-color:var(--primary);color:var(--primary);background:rgba(0,94,184,0.05)}
.request-form{display:flex;flex-direction:column;gap:20px}
.request-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:500px){.request-form-row{grid-template-columns:1fr}}
.request-form .form-input,.request-form .form-textarea,.request-form .form-select{background:var(--bg);border:1px solid var(--border)}
.request-form .form-input:focus,.request-form .form-textarea:focus,.request-form .form-select:focus{border-color:var(--primary)}
.request-icon-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.request-icon-option{width:100%;aspect-ratio:1;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:grid;place-items:center}
.request-icon-option:hover{border-color:var(--text-muted)}
.request-icon-option.selected{border-color:var(--primary);background:rgba(0,94,184,0.1)}
.request-success{text-align:center;padding:40px 20px}
.request-success-icon{font-size:4rem;margin-bottom:20px}
.request-success-title{font-size:1.25rem;font-weight:700;margin-bottom:8px}
.request-success-text{color:var(--text-muted);font-size:0.9rem;margin-bottom:24px}
.request-success-id{background:var(--bg);padding:12px 20px;border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:0.9rem;display:inline-block}
/* Admin Requests */
.requests-list{display:flex;flex-direction:column;gap:12px}
.request-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;border-left:4px solid var(--gold)}
.request-card.approved{border-left-color:var(--emerald);opacity:0.7}
.request-card.rejected{border-left-color:var(--rose);opacity:0.7}
.request-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.request-card-title{font-weight:700;font-size:1rem}
.request-card-status{padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:700;text-transform:uppercase}
.request-card-status.pending{background:rgba(217,119,6,0.15);color:var(--warning)}
.request-card-status.approved{background:rgba(16,185,129,0.15);color:var(--emerald)}
.request-card-status.rejected{background:rgba(244,63,94,0.15);color:var(--rose)}
.request-card-details{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}
.request-card-detail{display:flex;align-items:center;gap:6px}
.request-card-message{background:var(--bg-card);padding:12px;border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}
.request-card-actions{display:flex;gap:8px}
.request-card-time{font-size:0.75rem;color:var(--text-muted);position:absolute;top:16px;right:16px}
.admin-tab-panel{display:none}
.admin-tab-panel.active{display:block}
.badge-count{background:var(--rose);color:#fff;padding:2px 8px;border-radius:100px;font-size:0.7rem;margin-left:8px}
.approve-form{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-top:12px;display:none}
.approve-form.show{display:block}
.approve-form-row{display:flex;gap:12px;margin-bottom:12px}
.approve-form-row .form-input{flex:1}

/* ═══════════════════════════════════════════════════════════════════
   CLINICAL SCORING SYSTEM - PROFESSIONAL MEDICAL UI
   ═══════════════════════════════════════════════════════════════════ */

/* Modal - Full screen mobile, centered desktop */
#scoreCalcModal{padding:0;align-items:stretch}
#scoreCalcModal .modal-box{
  max-width:100%;width:100%;height:100%;max-height:100%;
  border-radius:0;margin:0;background:var(--bg-surface);
  display:flex;flex-direction:column;border:none
}
@media(min-width:600px){
  #scoreCalcModal{padding:20px;align-items:center}
  #scoreCalcModal .modal-box{
    max-width:420px;width:100%;height:auto;max-height:85vh;
    border-radius:12px;border:1px solid var(--border)
  }
}

/* Calculator Layout */
.score-calculator{
  display:flex;flex-direction:column;height:100%;
  background:var(--bg-surface);overflow:hidden
}

/* Header */
.score-calc-header{
  padding:16px;background:var(--bg-app);
  border-bottom:1px solid var(--border);flex-shrink:0
}
.score-calc-header-top{
  display:flex;justify-content:space-between;align-items:flex-start;gap:12px
}
.score-calc-close{
  width:28px;height:28px;border-radius:6px;border:none;
  background:var(--bg-elevated);color:var(--text-secondary);
  font-size:14px;cursor:pointer;display:grid;place-items:center;flex-shrink:0
}
.score-calc-close:active{background:var(--bg-hover)}
.score-calc-title{font-size:1.1rem;font-weight:600;color:var(--text-main);margin-bottom:2px}
.score-calc-purpose{font-size:0.8rem;color:var(--text-secondary)}
.score-calc-category{
  display:inline-block;margin-top:10px;padding:4px 8px;
  background:rgba(56,139,253,0.1);color:#58a6ff;
  font-size:0.65rem;font-weight:600;border-radius:4px;
  text-transform:uppercase;letter-spacing:0.5px
}

/* Body */
.score-calc-body{
  flex:1;overflow-y:auto;padding:12px;
  -webkit-overflow-scrolling:touch
}
.score-calc-fields{display:flex;flex-direction:column;gap:8px}

/* Auto-calc Banner */
.score-auto-calc{
  background:linear-gradient(135deg,rgba(46,160,67,0.08),rgba(46,160,67,0.02));
  border:1px solid rgba(46,160,67,0.2);border-radius:8px;
  padding:12px;margin-bottom:12px
}
.score-auto-calc-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:8px
}
.score-auto-calc-title{
  font-size:0.7rem;font-weight:600;color:#3fb950;
  text-transform:uppercase;letter-spacing:0.5px;
  display:flex;align-items:center;gap:6px
}
.score-auto-calc-badge{
  background:#238636;color:#fff;font-size:0.6rem;
  padding:2px 5px;border-radius:3px;font-weight:600
}
.score-auto-calc-value{
  font-family:'JetBrains Mono',monospace;font-size:1.8rem;
  font-weight:700;color:#e6edf3;text-align:center;padding:4px 0
}
.score-auto-calc-source{font-size:0.72rem;color:#8b949e;text-align:center}
.score-manual-toggle{
  font-size:0.7rem;color:#8b949e;background:none;border:none;
  text-decoration:underline;cursor:pointer
}

/* Checkbox Field */
.score-field{
  display:flex;align-items:center;gap:10px;padding:10px 12px;
  background:var(--bg-surface);border:1px solid var(--border);
  border-radius:8px;cursor:pointer;min-height:44px
}
.score-field:active{background:var(--bg-elevated)}
.score-field.checked{
  background:rgba(5,150,105,0.08);
  border-color:rgba(5,150,105,0.3)
}
.score-field-checkbox{
  width:18px;height:18px;min-width:18px;border-radius:4px;
  border:1.5px solid var(--border);display:grid;place-items:center;
  background:transparent;transition:all 0.15s
}
.score-field.checked .score-field-checkbox{
  background:var(--success);border-color:var(--success)
}
.score-field.checked .score-field-checkbox::after{
  content:'✓';color:#fff;font-size:11px;font-weight:700
}
.score-field-label{flex:1;font-size:0.82rem;color:var(--text-main);line-height:1.3}
.score-field-points{
  font-family:'JetBrains Mono',monospace;font-size:0.7rem;
  color:var(--text-secondary);padding:2px 6px;background:var(--bg-elevated);
  border-radius:4px
}
.score-field.checked .score-field-points{color:var(--success);background:rgba(5,150,105,0.1)}

/* Select Field */
.score-field-select{width:100%}
.score-field-select label{
  display:block;font-size:0.72rem;font-weight:500;
  color:var(--text-secondary);margin-bottom:6px
}
.score-field-select select{
  width:100%;padding:10px 32px 10px 10px;
  background:var(--bg-surface);border:1px solid var(--border);
  border-radius:6px;color:var(--text-main);font-size:0.82rem;
  appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%234b5563' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center
}
.score-field-select select:focus{outline:none;border-color:var(--primary)}

/* Number Field */
.score-field-number{display:flex;align-items:center;gap:10px;width:100%}
.score-field-number label{flex:1;font-size:0.82rem;color:var(--text-main)}
.score-field-number input{
  width:80px;padding:8px 10px;background:var(--bg-surface);
  border:1px solid var(--border);border-radius:6px;color:var(--text-main);
  font-size:0.85rem;font-family:'JetBrains Mono',monospace;text-align:center
}
.score-field-number input:focus{outline:none;border-color:var(--primary)}

/* Result */
.score-calc-result{
  padding:14px 16px;background:var(--bg-app);
  border-top:1px solid var(--border);flex-shrink:0
}
.score-result-display{
  display:flex;align-items:baseline;justify-content:center;gap:6px;margin-bottom:10px
}
.score-result-value{
  font-family:'JetBrains Mono',monospace;font-size:2.5rem;
  font-weight:700;color:var(--text-main)
}
.score-result-max{font-size:0.8rem;color:var(--text-muted)}
.score-result-interpretation{padding:10px 12px;border-radius:6px}
.score-result-risk{font-size:0.9rem;font-weight:600;margin-bottom:2px}
.score-result-action{font-size:0.78rem;color:rgba(255,255,255,0.8);line-height:1.35}
.score-result-stats{
  display:flex;justify-content:center;gap:16px;
  margin-top:10px;padding-top:10px;
  border-top:1px solid rgba(255,255,255,0.08)
}
.score-result-stat{text-align:center}
.score-result-stat-value{font-family:'JetBrains Mono',monospace;font-size:0.9rem;font-weight:600}
.score-result-stat-label{font-size:0.6rem;color:#8b949e;text-transform:uppercase;margin-top:1px}

/* Footer */
#scoreCalcModal .modal-footer{
  background:var(--bg-app);border-top:1px solid var(--border);
  padding:12px 16px;flex-shrink:0;display:flex;gap:8px
}
#scoreCalcModal .modal-footer .btn{flex:1;padding:10px}

/* ═══ DASHBOARD SCORES TAB ═══ */
.scores-search-wrapper{position:relative;margin-bottom:14px}
.scores-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)}
.scores-search-input{
  width:100%;padding:10px 14px 10px 38px;
  background:var(--bg-surface);border:1px solid var(--border);
  border-radius:6px;color:var(--text-main);font-size:0.85rem
}
.scores-search-input:focus{outline:none;border-color:var(--primary)}
.scores-search-input::placeholder{color:var(--text-muted)}

/* Quick Scores */
.quick-score-ref{
  background:var(--bg-surface);border:1px solid var(--border);
  border-radius:8px;padding:12px;margin-bottom:14px
}
.quick-score-ref-title{
  font-size:0.65rem;font-weight:600;color:var(--text-secondary);
  margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px
}
.quick-score-ref-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.quick-score-ref-item{
  padding:10px 6px;background:var(--bg-elevated);border:1px solid var(--border);
  border-radius:6px;text-align:center;cursor:pointer
}
.quick-score-ref-item:active{background:var(--bg-hover)}
.quick-score-ref-item-name{font-size:0.8rem;font-weight:600;color:var(--text-main)}
.quick-score-ref-item-hint{font-size:0.65rem;color:var(--text-secondary);margin-top:2px}

/* Score Groups */
.emergency-scores-grid{display:flex;flex-direction:column;gap:10px}
.emergency-score-group{
  background:var(--bg-surface);border:1px solid var(--border);
  border-radius:8px;overflow:hidden
}
.emergency-score-group-header{
  padding:10px 12px;background:var(--bg-app);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px
}
.emergency-score-group-icon{font-size:1rem}
.emergency-score-group-title{font-size:0.85rem;font-weight:600;color:var(--text-main)}
.emergency-score-group-body{padding:4px}
.emergency-score-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px;border-radius:6px;cursor:pointer;gap:8px
}
.emergency-score-item:active{background:var(--bg-elevated)}
.emergency-score-item-info{flex:1;min-width:0}
.emergency-score-item-name{font-size:0.82rem;font-weight:500;color:var(--text-main)}
.emergency-score-item-purpose{font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.emergency-score-item-btn{
  padding:6px 10px;background:var(--bg-elevated);border:1px solid var(--border);
  border-radius:5px;color:var(--text-main);font-size:0.7rem;font-weight:500;cursor:pointer
}
.emergency-score-item-btn:active{background:var(--primary);color:#fff;border-color:transparent}

/* ═══ PATIENT PROFILE SCORES ═══ */
.patient-scores-section{margin-bottom:16px}
.patient-scores-header{margin-bottom:8px}
.patient-scores-title{font-size:0.68rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px}
.patient-scores-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.patient-score-chip{
  padding:12px 10px;background:var(--bg-surface);
  border:1px solid var(--border);border-radius:8px;
  cursor:pointer;text-align:center
}
.patient-score-chip:active{background:var(--bg-elevated)}
.patient-score-chip.has-value{
  border-color:rgba(5,150,105,0.3);background:rgba(5,150,105,0.06)
}
.patient-score-chip .score-chip-icon{font-size:1.2rem;display:block;margin-bottom:4px}
.patient-score-chip .score-chip-name{font-size:0.75rem;font-weight:500;color:var(--text-main)}
.patient-score-chip .score-chip-value{
  display:none;font-family:'JetBrains Mono',monospace;
  font-size:0.95rem;font-weight:700;margin-top:4px
}
.patient-score-chip.has-value .score-chip-value{display:block}
.patient-score-chip .score-chip-value.low{color:#3fb950}
.patient-score-chip .score-chip-value.moderate{color:#d29922}
.patient-score-chip .score-chip-value.high{color:#f85149}

/* ═══ CLINICAL HISTORY & NOTES ═══ */
.history-upload-area{
  padding:20px;background:var(--bg-surface);border:2px dashed var(--border);
  border-radius:10px;text-align:center;cursor:pointer;
  margin-bottom:16px;transition:all 0.15s
}
.history-upload-area:active{background:var(--bg-elevated);border-color:var(--primary)}

/* ═══════════════════════════════════════════════════════════════════
   UNIFIED HISTORY SUMMARY - Single consolidated view
   ═══════════════════════════════════════════════════════════════════ */
.history-upload-zone{
  display:flex;align-items:center;gap:12px;
  padding:14px 16px;background:var(--bg);border:1px dashed var(--border);
  border-radius:10px;cursor:pointer;transition:all 0.2s;margin-bottom:16px
}
.history-upload-zone:hover{border-color:var(--primary);background:rgba(0,94,184,0.03)}
.history-upload-zone.analyzing{border-color:var(--gold);background:rgba(251,191,36,0.05);cursor:default}
.history-upload-zone svg{color:var(--text-muted);flex-shrink:0}
.history-upload-zone span{font-size:0.82rem;color:var(--text-muted)}
.history-upload-zone .upload-spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite}

.history-empty{text-align:center;padding:32px 20px;color:var(--text-muted)}

/* History Upload Button */
.history-upload-btn{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:14px 20px;margin-bottom:16px;
  background:var(--primary);color:#fff;border:none;border-radius:10px;
  font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;
  transition:all 0.2s
}
.history-upload-btn:hover{opacity:0.9}
.history-upload-btn:disabled{background:var(--border);cursor:not-allowed}
.history-upload-btn svg{width:20px;height:20px}

.unified-summary{
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:12px;padding:20px;margin-bottom:20px
}
.unified-summary-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)
}
.unified-summary-title{
  display:flex;align-items:center;gap:8px;
  font-weight:700;font-size:0.95rem;color:var(--text)
}
.unified-summary-title svg{color:var(--primary)}
.unified-summary-meta{font-size:0.75rem;color:var(--text-muted)}

/* Formatted Summary Content */
.unified-summary-content{
  font-size:0.88rem;color:var(--text-secondary);line-height:1.7;
  margin-bottom:16px
}
.summary-section{margin-bottom:16px}
.summary-section:last-child{margin-bottom:0}
.summary-section-header{
  display:flex;align-items:center;gap:8px;
  font-weight:700;font-size:0.82rem;color:var(--text);
  margin-bottom:8px;padding-bottom:6px;
  border-bottom:1px solid var(--border)
}
.summary-section-header svg{width:16px;height:16px;color:var(--primary)}
.summary-section-body{
  font-size:0.85rem;color:var(--text-secondary);line-height:1.7
}
.summary-section-body ul{margin:0;padding-left:18px}
.summary-section-body li{margin-bottom:4px}

/* Legacy text format */
.unified-summary-text{
  font-size:0.9rem;color:var(--text-secondary);line-height:1.7;
  margin-bottom:16px
}

.unified-section{
  background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px
}
.unified-section-title{
  font-size:0.72rem;font-weight:700;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px
}
.unified-section-content{display:flex;flex-wrap:wrap;gap:6px}
.unified-tag{
  display:inline-block;padding:4px 10px;border-radius:100px;
  font-size:0.75rem;font-weight:500
}
.unified-tag.diagnosis{background:rgba(239,68,68,0.1);color:#ef4444}
.unified-tag.med{background:rgba(139,92,246,0.1);color:#8b5cf6}
.unified-tag.more{background:var(--bg-card);color:var(--text-muted);border:1px solid var(--border)}

/* Document Gallery */
.documents-gallery{
  background:var(--bg);border-radius:10px;padding:14px;
  border:1px solid var(--border)
}
.documents-gallery-header{
  display:flex;justify-content:space-between;align-items:center;
  font-size:0.82rem;font-weight:600;color:var(--text);margin-bottom:12px
}
.documents-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px
}
.document-thumb{
  position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;
  background:var(--bg-card);border:1px solid var(--border);cursor:pointer;
  transition:all 0.2s
}
.document-thumb:hover{border-color:var(--primary);transform:scale(1.02)}
.document-thumb img{width:100%;height:100%;object-fit:cover}
.document-thumb-icon{
  width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  font-size:1.5rem;background:var(--bg)
}
.document-thumb-overlay{
  position:absolute;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);opacity:0;transition:opacity 0.2s;
  display:flex;align-items:flex-start;justify-content:flex-end;padding:4px
}
.document-thumb:hover .document-thumb-overlay{opacity:1}
.document-thumb-delete{
  width:24px;height:24px;border-radius:6px;border:none;
  background:rgba(255,255,255,0.9);color:#dc2626;cursor:pointer;
  display:flex;align-items:center;justify-content:center
}
.document-thumb-date{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(transparent,rgba(0,0,0,0.7));
  color:#fff;font-size:0.6rem;padding:12px 6px 4px;text-align:center
}

.clinical-notes-list{display:flex;flex-direction:column;gap:10px}
.clinical-note-card{
  background:var(--bg-surface);border:1px solid var(--border);
  border-radius:10px;overflow:hidden
}
.clinical-note-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;background:var(--bg-app);
  border-bottom:1px solid var(--border)
}
.clinical-note-type{font-size:0.78rem;font-weight:600;color:var(--text-main);display:flex;align-items:center;gap:6px}
.clinical-note-date{font-size:0.72rem;color:var(--text-secondary)}
.clinical-note-image{
  width:100%;max-height:150px;object-fit:cover;cursor:pointer;
  border-bottom:1px solid var(--border)
}
.clinical-note-ai{
  padding:12px;background:rgba(46,160,67,0.12);
  border-bottom:1px solid var(--border)
}
.clinical-note-ai-badge{
  font-size:0.65rem;font-weight:700;color:#22c55e;
  margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px
}
.clinical-note-ai-text{
  font-size:0.82rem;color:var(--text-main);line-height:1.45;
  display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;
  overflow:hidden;text-overflow:ellipsis
}
.clinical-note-ai-text.expanded{-webkit-line-clamp:unset;display:block}
.clinical-note-expand{
  font-size:0.72rem;color:#22c55e;cursor:pointer;margin-top:8px;
  font-weight:600;display:inline-block
}
.clinical-note-expand:hover{text-decoration:underline}
.clinical-note-text{padding:12px;font-size:0.85rem;color:var(--text-main);line-height:1.45;white-space:pre-wrap}
.clinical-note-author{padding:0 12px 10px;font-size:0.72rem;color:var(--text-secondary);font-style:italic}
.clinical-note-extracted{padding:10px 12px;border-top:1px solid var(--border)}
.clinical-note-extracted-title{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.clinical-note-extracted-content{font-size:0.78rem;line-height:1.35}
.btn-icon-sm{
  background:transparent;border:none;padding:4px;
  font-size:0.85rem;cursor:pointer;opacity:0.7;transition:opacity 0.15s
}
.btn-icon-sm:hover{opacity:1}
.btn-danger{background:#da3633!important;border-color:#da3633!important;color:#fff!important}
.btn-danger:hover{background:#f85149!important}

/* History/Meds upload loading state */
.upload-zone-compact.analyzing{
  border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.05);
  pointer-events:none
}
.upload-zone-compact .upload-spinner{
  width:20px;height:20px;border:2px solid rgba(251,191,36,0.3);
  border-top-color:#fbbf24;border-radius:50%;animation:spin 1s linear infinite
}

/* ═══════════════════════════════════════════════════════════════════
   MEDICATIONS - PRISTINE PHARMACEUTICAL DESIGN
   ═══════════════════════════════════════════════════════════════════ */

.meds-container{padding:0}

/* Upload Card */
.meds-upload-card{
  background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;margin-bottom:12px;overflow:hidden
}
.meds-upload-header{
  padding:12px 16px;background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(59,130,246,0.08));
  border-bottom:1px solid rgba(255,255,255,0.04)
}
.meds-upload-title{
  font-size:0.85rem;font-weight:600;color:#e6edf3;
  display:flex;align-items:center;gap:8px
}
.meds-upload-subtitle{font-size:0.7rem;color:#8b949e;margin-top:2px}
.meds-upload-body{padding:12px}
.meds-upload-zone{
  border:2px dashed rgba(139,92,246,0.3);border-radius:10px;
  padding:16px;text-align:center;cursor:pointer;
  transition:all 0.2s;background:rgba(139,92,246,0.02);
  display:flex;align-items:center;gap:12px
}
.meds-upload-zone:active{
  background:rgba(139,92,246,0.08);border-color:rgba(139,92,246,0.5)
}
.meds-upload-zone.analyzing{
  border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.05);
  pointer-events:none
}
.meds-upload-icon{font-size:1.5rem;flex-shrink:0}
.meds-upload-text{font-size:0.82rem;font-weight:500;color:#c9d1d9;text-align:left}
.meds-upload-hint{font-size:0.7rem;color:#8b949e;margin-top:2px;text-align:left}
.meds-upload-content{flex:1;min-width:0}

/* Compact upload zone variant */
.upload-zone-compact{
  border:1px dashed rgba(139,92,246,0.25);border-radius:10px;
  padding:14px 16px;cursor:pointer;transition:all 0.2s;
  background:rgba(139,92,246,0.02);display:flex;align-items:center;gap:12px
}
.upload-zone-compact:active{background:rgba(139,92,246,0.08);border-color:rgba(139,92,246,0.5)}
.upload-zone-compact .upload-icon{font-size:1.3rem;flex-shrink:0}
.upload-zone-compact .upload-text{font-size:0.8rem;font-weight:500;color:#c9d1d9}
.upload-zone-compact .upload-hint{font-size:0.68rem;color:#8b949e;margin-top:1px}

/* Medications List Header */
.meds-list-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:12px;padding:0 4px
}
.meds-list-title{
  font-size:0.7rem;font-weight:600;color:#8b949e;
  text-transform:uppercase;letter-spacing:0.5px
}
.meds-count{
  font-size:0.7rem;font-weight:600;color:#8b5cf6;
  background:rgba(139,92,246,0.1);padding:3px 8px;border-radius:10px
}

/* ═══════════════════════════════════════════════════════════════════════════
   MEDICATION SYSTEM - PREMIUM REDESIGN v15
═══════════════════════════════════════════════════════════════════════════ */

/* Medication Card - Professional Design */
.med-card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:16px;margin-bottom:12px;overflow:hidden;
  transition:all 0.2s cubic-bezier(0.4,0,0.2,1);
  box-shadow:0 1px 3px rgba(0,0,0,0.05)
}
.med-card:hover{border-color:var(--primary);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.med-card-header{
  display:flex;align-items:flex-start;justify-content:space-between;
  padding:16px 18px 12px;gap:12px
}
.med-card-main{flex:1;min-width:0}
.med-card-name{
  font-size:1.05rem;font-weight:700;color:var(--text);
  margin-bottom:4px;display:flex;align-items:center;gap:10px;flex-wrap:wrap
}
.med-card-generic{font-size:0.75rem;color:var(--text-muted);font-style:italic;margin-top:2px}

/* Simplified Actions - Icon Row */
.med-card-actions{
  display:flex;
  gap:4px;
  opacity:0.6;
  transition:opacity 0.2s
}
.med-card:hover .med-card-actions{opacity:1}
.med-card-action{
  width:28px;height:28px;border-radius:6px;border:none;
  background:transparent;color:var(--text-muted);
  font-size:0.75rem;cursor:pointer;display:grid;place-items:center;transition:all 0.15s
}
.med-card-action:hover{background:var(--bg-elevated);color:var(--primary)}
.med-card-action.delete:hover{background:rgba(220,38,38,0.1);color:#dc2626}

/* Simplified Dose Display - Single Line */
.med-card-dose{
  display:flex;align-items:center;gap:16px;padding:10px 18px;
  background:var(--bg);font-size:0.85rem;color:var(--text-secondary)
}
.med-dose-item{display:flex;align-items:center;gap:6px}
.med-dose-item .label{font-weight:600;color:var(--text-muted);font-size:0.7rem;text-transform:uppercase}
.med-dose-item .value{font-weight:600;color:var(--text)}

/* Legacy pill styles (for compatibility) */
.med-dose-pill{
  display:inline-flex;align-items:center;gap:4px;
  padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;
  background:var(--bg-elevated);color:var(--text-secondary)
}
.med-dose-pill.amount{color:var(--primary)}
.med-dose-pill.route{color:var(--text)}
.med-dose-pill.frequency{color:var(--teal)}

/* Indication */
.med-card-indication{
  padding:12px 18px;background:var(--bg);border-top:1px solid var(--border)
}
.med-indication-label{
  font-size:0.65rem;font-weight:700;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px
}
.med-indication-text{font-size:0.85rem;color:var(--text-secondary);line-height:1.5}

/* Status Badge */
.med-status{
  font-size:0.6rem;font-weight:700;padding:3px 8px;
  border-radius:4px;text-transform:uppercase;letter-spacing:0.03em
}
.med-status.active{background:rgba(52,211,153,0.15);color:#34d399}
.med-status.prn{background:rgba(251,191,36,0.15);color:#fbbf24}
.med-status.discontinued{background:rgba(107,114,128,0.15);color:#9ca3af}
.med-status.new{background:rgba(167,139,250,0.15);color:#a78bfa}

/* Learn More Button - Simplified */
.med-learn-more{
  display:flex;align-items:center;justify-content:center;gap:8px;
  padding:10px 18px;
  background:transparent;
  border:none;border-top:1px solid var(--border);
  font-family:inherit;font-size:0.8rem;font-weight:600;color:var(--primary);
  cursor:pointer;transition:all 0.2s;text-decoration:none;width:100%
}
.med-learn-more:hover{background:rgba(0,94,184,0.05)}
.med-learn-more .sparkle{font-size:0.9rem}

/* ═══════════════════════════════════════════════════════════════════════════
   MEDICATION SUGGESTIONS - Clean Professional Design
═══════════════════════════════════════════════════════════════════════════ */

.med-ai-suggestions{
  background:var(--bg-surface);
  border:1px solid var(--border);
  border-radius:12px;padding:14px;margin-bottom:16px
}
.med-ai-header{
  display:flex;align-items:center;gap:10px;margin-bottom:12px;
  padding-bottom:10px;border-bottom:1px solid var(--border)
}
.med-ai-icon{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--primary),#0077cc);
  display:grid;place-items:center;font-size:0.95rem;color:white
}
.med-ai-title{display:flex;flex-direction:column;flex:1}
.med-ai-title span:first-child{font-size:0.85rem;font-weight:700;color:var(--text)}
.med-ai-badge{
  font-size:0.65rem;color:var(--text-muted);font-weight:500;margin-top:2px
}
.med-ai-hint{display:none}

/* Suggestion Chips - Clean Card Style */
.med-ai-chips{display:flex;flex-direction:column;gap:6px}
.med-ai-chip{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;background:var(--bg-elevated);
  border:1px solid var(--border);border-radius:10px;
  font-family:inherit;cursor:pointer;transition:all 0.15s;position:relative;
  text-align:left;width:100%
}
.med-ai-chip:hover{
  background:var(--bg-hover);border-color:var(--primary);
  transform:translateX(4px)
}
.med-ai-chip-icon{
  width:36px;height:36px;border-radius:8px;
  background:var(--bg-surface);border:1px solid var(--border);
  display:grid;place-items:center;font-size:1rem;flex-shrink:0
}
.med-ai-chip-info{display:flex;flex-direction:column;flex:1;min-width:0}
.med-ai-chip-name{font-size:0.9rem;font-weight:600;color:var(--text)}
.med-ai-chip-detail{font-size:0.75rem;color:var(--text-muted);margin-top:2px}
.med-ai-chip-match{
  padding:4px 8px;background:var(--success);
  border-radius:4px;font-size:0.6rem;font-weight:700;color:white;
  text-transform:uppercase;letter-spacing:0.02em
}
.med-ai-chip.high-match{border-color:rgba(16,185,129,0.4);background:rgba(16,185,129,0.05)}
.med-ai-chip.high-match .med-ai-chip-name{color:var(--success)}

/* Loading State */
.med-ai-loading{
  display:flex;align-items:center;gap:10px;
  padding:12px 16px;color:#8b949e;font-size:0.8rem
}
.med-ai-pulse{
  width:8px;height:8px;border-radius:50%;background:#8b5cf6;
  animation:aiPulse 1.5s ease infinite
}
@keyframes aiPulse{
  0%,100%{opacity:0.3;transform:scale(0.8)}
  50%{opacity:1;transform:scale(1.2)}
}

/* No Suggestions */
.med-ai-empty{
  padding:16px;text-align:center;color:#6b7280;font-size:0.8rem
}
.med-ai-empty-icon{font-size:1.5rem;margin-bottom:8px;opacity:0.5}

/* ═══════════════════════════════════════════════════════════════════════════
   PRESTIGE PHARMACY INTERFACE v17.0
═══════════════════════════════════════════════════════════════════════════ */

/* Upload Zone */
.pharmacy-upload {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: var(--bg-surface);
  border: 1px dashed var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 16px;
}
.pharmacy-upload:hover {
  border-color: var(--primary);
  background: var(--primary-light);
}
.pharmacy-upload.analyzing {
  border-style: solid;
  border-color: var(--primary);
  cursor: default;
}
.pharmacy-upload-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  background: var(--bg-input);
  border-radius: 10px;
  color: var(--text-secondary);
}
.pharmacy-upload.analyzing .pharmacy-upload-icon {
  color: var(--primary);
}
.pharmacy-upload-title {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-main);
}
.pharmacy-upload-hint {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* Action Buttons */
.pharmacy-actions {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}
.pharmacy-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px 8px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-secondary);
  font-size: 0.8rem;
  font-weight: 500;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s ease;
}
.pharmacy-action-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--primary-light);
}
.pharmacy-action-btn.primary {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}
.pharmacy-action-btn.primary:hover {
  background: var(--primary-dark);
}
.pharmacy-action-btn svg {
  width: 18px;
  height: 18px;
  stroke-width: 1.5;
}

/* Section Headers */
.pharmacy-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.pharmacy-section-title {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.pharmacy-count {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--success);
  background: rgba(5, 150, 105, 0.1);
  padding: 3px 10px;
  border-radius: 20px;
}
.pharmacy-count.discontinued {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

/* Empty State */
.pharmacy-empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}
.pharmacy-empty-icon {
  display: flex;
  justify-content: center;
  margin-bottom: 12px;
  color: var(--text-muted);
  opacity: 0.5;
}
.pharmacy-empty-icon svg {
  width: 48px;
  height: 48px;
}
.pharmacy-empty-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 4px;
}
.pharmacy-empty-hint {
  font-size: 0.8rem;
}

/* Form Overlay */
.pharmacy-form-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  z-index: 2000;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 20px;
}
.pharmacy-form {
  background: var(--bg-surface);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 500px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
}
@media (min-width: 600px) {
  .pharmacy-form-overlay {
    align-items: center;
  }
  .pharmacy-form {
    border-radius: 20px;
  }
}

/* Form Header */
.pharmacy-form-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg-surface);
  z-index: 10;
}
.pharmacy-form-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-main);
}
.pharmacy-form-title svg {
  color: var(--primary);
}

/* Search Section */
.pharmacy-search-section {
  padding: 16px 20px;
  background: var(--bg-input);
  border-bottom: 1px solid var(--border);
}
.pharmacy-search-box {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 4px 14px;
}
.pharmacy-search-box:focus-within {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 94, 184, 0.1);
}
.pharmacy-search-box svg {
  color: var(--text-muted);
  flex-shrink: 0;
}
.pharmacy-search-input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 12px 0;
  font-size: 0.95rem;
  color: var(--text-main);
  font-family: inherit;
  outline: none;
}
.pharmacy-search-input::placeholder {
  color: var(--text-muted);
}
.pharmacy-suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
}
.pharmacy-suggestion {
  padding: 6px 12px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 0.8rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.pharmacy-suggestion:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--primary-light);
}

/* Form Fields */
.pharmacy-field {
  padding: 12px 20px;
}
.pharmacy-label {
  display: block;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 10px;
}
.pharmacy-input {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 0.9rem;
  color: var(--text-main);
  font-family: inherit;
  transition: all 0.2s;
}
.pharmacy-input:focus {
  outline: none;
  border-color: var(--primary);
  background: var(--bg-surface);
}
.pharmacy-dose-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 12px 20px;
}
.pharmacy-dose-row .pharmacy-field {
  padding: 0;
}

/* Chip Selection */
.pharmacy-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.pharmacy-chip {
  padding: 10px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-secondary);
  font-family: inherit;
  cursor: pointer;
  transition: all 0.15s;
}
.pharmacy-chip:hover {
  border-color: var(--primary);
  color: var(--primary);
}
.pharmacy-chip.selected {
  background: rgba(0, 94, 184, 0.1);
  border-color: var(--primary);
  color: var(--primary);
}

/* Status Chips */
.pharmacy-status-chips {
  display: flex;
  gap: 8px;
}
.pharmacy-status {
  flex: 1;
  padding: 10px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  font-family: inherit;
  cursor: pointer;
  transition: all 0.15s;
}
.pharmacy-status.active.selected {
  background: rgba(5, 150, 105, 0.1);
  border-color: #059669;
  color: #059669;
}
.pharmacy-status.new.selected {
  background: rgba(59, 130, 246, 0.1);
  border-color: #3b82f6;
  color: #3b82f6;
}
.pharmacy-status.prn.selected {
  background: rgba(245, 158, 11, 0.1);
  border-color: #f59e0b;
  color: #f59e0b;
}

/* Form Actions */
.pharmacy-form-actions {
  display: flex;
  gap: 12px;
  padding: 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-input);
}
.pharmacy-form-actions .btn {
  flex: 1;
  padding: 14px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   LEGACY MEDICATION FORM STYLES (keeping for compatibility)
═══════════════════════════════════════════════════════════════════════════ */

.med-add-form{
  background:linear-gradient(165deg,#0a101f 0%,#111b2e 50%,#0f1825 100%);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;padding:0;margin-bottom:20px;
  box-shadow:0 8px 32px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05);
  overflow:hidden
}
.med-form-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px;
  background:linear-gradient(135deg,rgba(167,139,250,0.1),rgba(96,165,250,0.05));
  border-bottom:1px solid rgba(255,255,255,0.06)
}
.med-form-title{
  font-size:1.1rem;font-weight:700;color:#f0f6fc;
  display:flex;align-items:center;gap:10px
}
.med-form-close{
  width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.03);color:#8b949e;font-size:1rem;
  cursor:pointer;display:grid;place-items:center;transition:all 0.2s
}
.med-form-close:hover{background:rgba(248,81,73,0.1);border-color:rgba(248,81,73,0.3);color:#f85149}

.med-form-section{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.med-form-section:last-of-type{border-bottom:none}
.med-form-section-title{
  font-size:0.7rem;font-weight:700;color:#6b7280;
  text-transform:uppercase;letter-spacing:0.08em;margin-bottom:16px;
  display:flex;align-items:center;gap:8px
}
.med-form-section-title::after{
  content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(255,255,255,0.06),transparent)
}

.med-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.med-form-group{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.med-form-group:last-child{margin-bottom:0}
.med-form-full{grid-column:1/-1}
.med-form-label{
  font-size:0.75rem;font-weight:600;color:#9ca3af;
  display:flex;align-items:center;gap:4px
}
.med-form-label .required{color:#f87171}
.med-form-input{
  padding:14px 16px;background:var(--bg-surface);border:1px solid var(--border);
  border-radius:12px;color:var(--text-main);font-size:0.9rem;font-family:inherit;
  transition:all 0.2s;width:100%
}
.med-form-input:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(0,94,184,0.1)
}
.med-form-input::placeholder{color:var(--text-muted)}

/* Route Chips - Premium */
.med-route-chips{display:flex;flex-wrap:wrap;gap:8px}
.med-route-chip{
  padding:10px 16px;background:var(--bg-surface);border:1px solid var(--border);
  border-radius:10px;color:var(--text-secondary);font-size:0.82rem;font-weight:600;
  font-family:inherit;cursor:pointer;transition:all 0.2s
}
.med-route-chip:hover{border-color:var(--primary);color:var(--primary)}
.med-route-chip.selected{
  background:rgba(0,94,184,0.08);
  border-color:var(--primary);color:var(--primary);
  box-shadow:0 0 0 2px rgba(0,94,184,0.1)
}

/* Frequency Chips - Premium */
.med-freq-chips{display:flex;flex-wrap:wrap;gap:8px}
.med-freq-chip{
  padding:10px 16px;background:var(--bg-surface);border:1px solid var(--border);
  border-radius:10px;color:var(--text-secondary);font-size:0.82rem;font-weight:600;
  font-family:inherit;cursor:pointer;transition:all 0.2s
}
.med-freq-chip:hover{border-color:var(--success);color:var(--success)}
.med-freq-chip.selected{
  background:rgba(5,150,105,0.08);
  border-color:var(--success);color:var(--success);
  box-shadow:0 0 0 2px rgba(5,150,105,0.1)
}

/* Status Options - Premium */
.med-status-options{display:flex;flex-wrap:wrap;gap:8px}
.med-status-option{
  display:flex;align-items:center;gap:8px;
  padding:10px 16px;background:var(--bg-surface);border:1px solid var(--border);
  border-radius:10px;color:var(--text-secondary);font-size:0.82rem;font-weight:600;
  font-family:inherit;cursor:pointer;transition:all 0.2s
}
.med-status-option:hover{border-color:var(--primary)}
.med-status-option.selected{
  background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.2);color:#f0f6fc
}
.status-dot{width:8px;height:8px;border-radius:50%}
.status-dot.active{background:#34d399}
.status-dot.new{background:#a78bfa}
.status-dot.prn{background:#fbbf24}
.status-dot.discontinued{background:#6b7280}

/* Form Actions - Premium */
.med-form-actions{
  display:flex;gap:12px;padding:20px 24px;
  background:rgba(0,0,0,0.2);border-top:1px solid rgba(255,255,255,0.04)
}
.med-form-btn{
  flex:1;padding:14px 20px;border-radius:12px;font-weight:600;
  display:flex;align-items:center;justify-content:center;gap:8px
}
.med-form-actions .btn-primary{
  background:linear-gradient(135deg,#f59e0b,#f97316);color:#000;
  box-shadow:0 4px 16px rgba(245,158,11,0.3)
}
.med-form-actions .btn-primary:hover{
  box-shadow:0 6px 24px rgba(245,158,11,0.4);transform:translateY(-1px)
}
.med-form-actions .btn-secondary{
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1)
}

/* ═══════════════════════════════════════════════════════════════════════════
   ADD MEDICATION MODAL - Clean Professional Design
═══════════════════════════════════════════════════════════════════════════ */

/* Modal Header */
.med-modal-icon{font-size:1.5rem;margin-bottom:4px}
.med-modal-title{font-size:1.15rem;font-weight:700;color:var(--text)}
.med-modal-subtitle{font-size:0.8rem;color:var(--text-muted);margin-top:4px}

/* Input Groups */
.med-input-group{margin-bottom:16px}
.med-input-group:last-child{margin-bottom:0}
.med-input-label{
  display:block;font-size:0.75rem;font-weight:600;
  color:var(--text-muted);margin-bottom:6px
}
.med-input-label .required{color:#ef4444}

/* Clean Input Field */
.med-input{
  width:100%;padding:14px 16px;
  background:var(--bg-elevated);
  border:1px solid var(--border);border-radius:10px;
  color:var(--text);font-size:0.95rem;font-family:inherit;
  transition:all 0.2s
}
.med-input:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(0,94,184,0.1)
}
.med-input::placeholder{color:var(--text-muted)}

/* Route Pills - Clean Horizontal Layout */
.med-pill-group{
  display:flex;flex-wrap:wrap;gap:8px
}
.med-pill{
  padding:10px 16px;
  background:var(--bg-elevated);
  border:1px solid var(--border);border-radius:8px;
  color:var(--text-secondary);font-size:0.85rem;font-weight:600;
  font-family:inherit;cursor:pointer;transition:all 0.15s
}
.med-pill:hover{border-color:var(--primary);color:var(--primary)}
.med-pill.selected{
  background:var(--primary);border-color:var(--primary);color:white
}

/* Frequency Grid - Clean Cards */
.med-freq-grid{
  display:grid;grid-template-columns:repeat(4,1fr);gap:8px
}
@media (max-width:500px){
  .med-freq-grid{grid-template-columns:repeat(2,1fr)}
}
.med-freq-pill{
  padding:12px 8px;
  background:var(--bg-elevated);
  border:1px solid var(--border);border-radius:10px;
  font-family:inherit;cursor:pointer;transition:all 0.15s;
  text-align:center
}
.med-freq-pill:hover{border-color:var(--primary)}
.med-freq-pill.selected{
  background:rgba(0,94,184,0.1);border-color:var(--primary)
}
.med-freq-label{font-size:0.9rem;font-weight:700;color:var(--text)}
.med-freq-desc{font-size:0.7rem;color:var(--text-muted);margin-top:2px}
.med-freq-pill.selected .med-freq-label{color:var(--primary)}

/* Status Pills - Clean Minimal */
.med-status-group{display:flex;flex-wrap:wrap;gap:8px}
.med-status-pill{
  display:flex;align-items:center;gap:6px;
  padding:8px 14px;
  background:var(--bg-elevated);
  border:1px solid var(--border);border-radius:8px;
  font-size:0.82rem;font-weight:600;color:var(--text-secondary);
  font-family:inherit;cursor:pointer;transition:all 0.15s
}
.med-status-pill:hover{border-color:var(--text-muted)}
.med-status-pill.selected{
  background:rgba(255,255,255,0.05);border-color:var(--text-muted);color:var(--text)
}
.med-status-dot{width:8px;height:8px;border-radius:50%}
.med-status-pill.active .med-status-dot{background:#34d399}
.med-status-pill.new .med-status-dot{background:#a78bfa}
.med-status-pill.prn .med-status-dot{background:#fbbf24}
.med-status-pill.discontinued .med-status-dot{background:#6b7280}

/* Empty State */
.meds-empty{text-align:center;padding:48px 24px;color:#6b7280}
.meds-empty-icon{font-size:3rem;margin-bottom:16px;opacity:0.5}
.meds-empty-title{font-size:1rem;font-weight:600;color:#c9d1d9;margin-bottom:6px}
.meds-empty-hint{font-size:0.85rem}

/* Quick Actions */
.meds-quick-actions{display:flex;gap:10px;margin-bottom:20px}
.meds-quick-btn{
  flex:1;padding:14px 16px;background:linear-gradient(145deg,#0f1729,#151d2e);
  border:1px solid rgba(255,255,255,0.08);border-radius:12px;
  color:#c9d1d9;font-size:0.82rem;font-weight:600;font-family:inherit;
  cursor:pointer;text-align:center;transition:all 0.2s
}
.meds-quick-btn:hover{border-color:rgba(167,139,250,0.4);color:#a78bfa;background:linear-gradient(145deg,#131c33,#1a2540)}

/* Medication Scanner */
.med-scan-btn{background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:white;border:none;padding:14px 16px;border-radius:12px;font-weight:600;font-size:0.82rem;display:flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;transition:all 0.2s;font-family:inherit}
.med-scan-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,0.3)}
.med-scan-btn:active{transform:scale(0.97)}
#medScanModal .modal-box{max-width:520px;border-radius:20px;max-height:90vh;overflow-y:auto}
.med-scan-preview{width:100%;max-height:180px;object-fit:contain;border-radius:12px;margin-bottom:16px;background:#1a1a2e}
.med-scan-result{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1));border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:16px;margin-bottom:16px}
.med-scan-drug-name{font-size:1.3rem;font-weight:700;color:var(--primary);margin-bottom:4px}
.med-scan-brand{font-size:0.9rem;color:var(--text-muted);font-style:italic;margin-bottom:12px}
.med-scan-details{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.med-scan-detail{background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:8px}
.med-scan-detail-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.med-scan-detail-value{font-size:0.9rem;font-weight:600;color:var(--text)}
.med-scan-confidence{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.confidence-bar{flex:1;height:6px;background:var(--bg-hover);border-radius:3px;overflow:hidden}
.confidence-fill{height:100%;border-radius:3px;transition:width 0.5s ease}
.confidence-fill.high{background:var(--emerald)}
.confidence-fill.medium{background:var(--warning)}
.confidence-fill.low{background:var(--danger)}
.med-scan-actions{display:flex;gap:10px;margin-top:16px}
.med-scan-actions .btn{flex:1}
.med-scan-loading{text-align:center;padding:40px 20px}
.med-scan-error{background:var(--danger-bg);color:var(--danger-text);padding:16px;border-radius:12px;text-align:center}

/* Multi-medication scan results */
.med-scan-type-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(139,92,246,0.15);border-radius:20px;font-size:0.75rem;font-weight:600;color:#a78bfa;margin-bottom:16px}
.med-scan-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
.med-scan-item{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px}
.med-scan-item-check{width:20px;height:20px;border:2px solid rgba(255,255,255,0.2);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
.med-scan-item-check.checked{background:var(--primary);border-color:var(--primary)}
.med-scan-item-check.checked::after{content:'✓';color:white;font-size:12px;font-weight:bold}
.med-scan-item-info{flex:1;min-width:0}
.med-scan-item-name{font-weight:600;color:var(--text);font-size:0.95rem}
.med-scan-item-details{font-size:0.8rem;color:var(--text-muted);margin-top:2px}
.med-scan-item-btn{padding:6px 10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:6px;color:#60a5fa;font-size:0.75rem;cursor:pointer;transition:all 0.2s}
.med-scan-item-btn:hover{background:rgba(59,130,246,0.2);border-color:#60a5fa}
.med-scan-select-all{display:flex;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid var(--border);margin-bottom:12px;cursor:pointer}
.med-scan-select-all span{font-size:0.85rem;color:var(--text-muted)}

/* List Header */
.meds-list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.meds-list-title{font-size:0.75rem;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:0.05em}
.meds-count{padding:4px 12px;background:rgba(52,211,153,0.1);border-radius:100px;font-size:0.7rem;font-weight:700;color:#34d399}

/* ═══════════════════════════════════════════════════════════════════════════
   CLINICAL ACTION PLAN - Simple Clean Design
═══════════════════════════════════════════════════════════════════════════ */

.plan-section-card{padding:0;overflow:hidden}
.plan-section-header{padding:16px 20px;border-bottom:1px solid var(--border)}

/* Stats Grid */
.plan-stats-grid{
  display:grid;grid-template-columns:repeat(4,1fr);gap:1px;
  background:var(--border);margin:0
}
.plan-stat-box{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:16px 8px;background:var(--bg-card);text-align:center;min-height:80px
}
.plan-stat-box.urgent-box{background:rgba(239,68,68,0.05)}
.plan-stat-ring{position:relative;width:44px;height:44px}
.plan-stat-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:rgba(255,255,255,0.1);stroke-width:3}
.ring-fill{fill:none;stroke:#10b981;stroke-width:3;stroke-linecap:round}
.ring-text{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:0.65rem;font-weight:800;color:#10b981
}
.plan-stat-num{font-size:1.5rem;font-weight:800;line-height:1}
.plan-stat-num.amber{color:#f59e0b}
.plan-stat-num.green{color:#10b981}
.plan-stat-num.red{color:#ef4444}
.plan-stat-lbl{font-size:0.65rem;color:#6b7280;margin-top:4px;text-transform:uppercase}

/* Notify Bar */
.plan-notify-bar{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;background:rgba(139,92,246,0.05);
  border-bottom:1px solid var(--border)
}
.notify-label{font-size:0.8rem;color:#a78bfa;font-weight:600}
.toggle-switch{position:relative;width:40px;height:22px}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-track{
  position:absolute;cursor:pointer;inset:0;
  background:rgba(255,255,255,0.1);border-radius:22px;transition:0.2s
}
.toggle-track::before{
  content:'';position:absolute;height:16px;width:16px;left:3px;bottom:3px;
  background:#6b7280;border-radius:50%;transition:0.2s
}
.toggle-switch input:checked + .toggle-track{background:#8b5cf6}
.toggle-switch input:checked + .toggle-track::before{transform:translateX(18px);background:#fff}

/* AI Box */
.plan-ai-box{padding:16px 20px;border-bottom:1px solid var(--border);background:rgba(59,130,246,0.03)}
.plan-ai-header{margin-bottom:12px}
.ai-badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;background:rgba(59,130,246,0.1);
  border-radius:100px;font-size:0.7rem;font-weight:700;color:#60a5fa
}
.plan-ai-list{display:flex;flex-direction:column;gap:8px}
.plan-ai-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;background:var(--bg-elevated);
  border:1px solid var(--border);border-radius:10px;cursor:pointer;
  transition:all 0.2s;-webkit-tap-highlight-color:transparent
}
.plan-ai-item:active{background:rgba(59,130,246,0.1);border-color:rgba(59,130,246,0.3)}
.ai-item-icon{font-size:1rem;flex-shrink:0}
.ai-item-text{flex:1;font-size:0.8rem;color:var(--text-secondary);line-height:1.3}
.ai-item-add{
  width:24px;height:24px;background:rgba(16,185,129,0.15);
  border-radius:6px;color:#10b981;display:grid;place-items:center;
  font-size:1rem;font-weight:600;flex-shrink:0
}

/* Tasks List */
.plan-tasks-list{padding:0}
.tasks-group-header{
  display:flex;align-items:center;gap:8px;
  padding:12px 20px;background:var(--bg);
  font-size:0.8rem;font-weight:700;color:var(--text-muted);
  border-bottom:1px solid var(--border)
}
.tasks-group-header.completed-header{cursor:pointer}
.tasks-group-header.completed-header:active{background:var(--bg-elevated)}
.tasks-count{
  margin-left:auto;padding:2px 8px;background:rgba(245,158,11,0.15);
  border-radius:100px;font-size:0.65rem;color:#f59e0b
}
.tasks-count.done{background:rgba(16,185,129,0.15);color:#10b981}
.expand-arrow{font-size:0.6rem;color:var(--text-muted);margin-left:4px}

/* Task Item */
.plan-task-item{
  display:flex;align-items:flex-start;gap:12px;
  padding:14px 20px;border-bottom:1px solid var(--border);
  transition:background 0.2s
}
.plan-task-item:active{background:var(--bg-elevated)}
.plan-task-item.completed{opacity:0.5}
.plan-task-item[data-priority="high"]{border-left:3px solid #ef4444}
.plan-task-item[data-priority="medium"]{border-left:3px solid #f59e0b}
.plan-task-item[data-priority="low"]{border-left:3px solid #10b981}

.task-check-box{
  width:22px;height:22px;border-radius:6px;flex-shrink:0;
  border:2px solid var(--border);background:transparent;
  display:grid;place-items:center;font-size:0.75rem;color:transparent;
  cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent
}
.task-check-box:active{border-color:#10b981}
.task-check-box.done{background:#10b981;border-color:#10b981;color:#fff}

.task-info{flex:1;min-width:0}
.task-text{font-size:0.85rem;color:var(--text);line-height:1.4;margin-bottom:6px}
.plan-task-item.completed .task-text{text-decoration:line-through;color:var(--text-muted)}
.task-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:0.7rem;color:var(--text-muted)}
.task-cat{padding:2px 6px;background:var(--bg);border-radius:4px;text-transform:capitalize}
.task-pri.high{color:#ef4444}
.task-pri.medium{color:#f59e0b}
.task-pri.low{color:#10b981}

.task-btns{display:flex;gap:4px;flex-shrink:0}
.task-btn{
  width:28px;height:28px;border:none;border-radius:6px;
  background:var(--bg);cursor:pointer;
  display:grid;place-items:center;font-size:0.8rem;
  -webkit-tap-highlight-color:transparent
}
.task-btn:active{background:var(--bg-elevated)}
.task-btn.del:active{background:rgba(239,68,68,0.2)}

/* Empty State */
.plan-empty{text-align:center;padding:40px 20px}
.plan-empty .empty-icon{font-size:2rem;margin-bottom:8px;opacity:0.5}
.plan-empty .empty-text{font-size:0.85rem;color:var(--text-muted)}

/* Task Modal */
.task-modal-box{max-width:400px}
.task-modal-header{
  display:flex;align-items:center;gap:12px;padding:16px 20px;
  background:linear-gradient(135deg,rgba(245,158,11,0.06),rgba(234,88,12,0.03));
  border-bottom:1px solid var(--border)
}
.task-modal-icon{
  width:40px;height:40px;border-radius:10px;
  background:linear-gradient(135deg,#f59e0b,#ea580c);
  display:grid;place-items:center;font-size:1.2rem
}
.task-modal-header .modal-close{margin-left:auto}
.task-textarea{min-height:80px;resize:vertical}

.task-form-row{margin-top:16px}
.priority-chips,.category-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.priority-chip,.category-chip{
  padding:8px 12px;background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.08);border-radius:8px;
  font-family:inherit;font-size:0.75rem;font-weight:600;color:#9ca3af;
  cursor:pointer;-webkit-tap-highlight-color:transparent
}
.priority-chip:active,.category-chip:active{background:rgba(255,255,255,0.08)}
.priority-chip.selected.high{background:rgba(239,68,68,0.1);border-color:#ef4444;color:#ef4444}
.priority-chip.selected.medium{background:rgba(245,158,11,0.1);border-color:#f59e0b;color:#f59e0b}
.priority-chip.selected.low{background:rgba(16,185,129,0.1);border-color:#10b981;color:#10b981}
.category-chip.selected{background:rgba(59,130,246,0.1);border-color:#3b82f6;color:#3b82f6}

/* Celebration */
.celebration-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);
  z-index:10000;display:flex;align-items:center;justify-content:center;
  padding:20px;opacity:0;transition:opacity 0.3s;pointer-events:none
}
.celebration-overlay.show{opacity:1;pointer-events:auto}
.celebration-content{
  text-align:center;padding:32px 24px;width:100%;max-width:320px;
  background:var(--bg-card);border:1px solid var(--border);border-radius:20px;
  transform:scale(0.9);transition:transform 0.3s
}
.celebration-overlay.show .celebration-content{transform:scale(1)}
.celebration-confetti{font-size:2.5rem;margin-bottom:12px}
.celebration-badge{
  width:60px;height:60px;margin:0 auto 16px;border-radius:50%;
  background:linear-gradient(135deg,#10b981,#14b8a6);
  display:grid;place-items:center;font-size:1.5rem;color:#fff
}
.celebration-title{font-size:1.2rem;font-weight:800;color:#f0f6fc;margin-bottom:4px}
.celebration-subtitle{font-size:0.85rem;color:#8b949e;margin-bottom:4px}
.celebration-patient{font-size:1rem;font-weight:700;color:#f59e0b;margin-bottom:16px}
.celebration-stats{display:flex;justify-content:center;gap:24px;margin-bottom:16px}
.celeb-stat{text-align:center}
.celeb-stat-value{display:block;font-size:1.5rem;font-weight:800;color:#10b981}
.celeb-stat-label{font-size:0.6rem;color:#6b7280;text-transform:uppercase}
.celebration-message{
  padding:12px;background:rgba(16,185,129,0.1);border-radius:10px;
  font-size:0.8rem;color:#a7f3d0;margin-bottom:16px;line-height:1.4
}
.celebration-btn{
  width:100%;padding:12px;background:#10b981;
  border:none;border-radius:10px;color:#fff;font-size:0.9rem;font-weight:700;
  cursor:pointer;font-family:inherit
}

/* ═══════════════════════════════════════════════════════════════════════════
   AI DRUG INFO MODAL - NEW FEATURE
═══════════════════════════════════════════════════════════════════════════ */
#drugInfoModal .modal-box{max-width:520px;border-radius:20px;overflow:hidden}
#drugInfoModal .modal-header{
  padding:24px 24px 20px;
  background:linear-gradient(135deg,rgba(96,165,250,0.08),rgba(167,139,250,0.05));
  border-bottom:1px solid var(--border);position:relative;display:block
}
.drug-info-badge{
  display:inline-flex;align-items:center;gap:6px;padding:5px 12px;
  background:rgba(96,165,250,0.12);border:1px solid rgba(96,165,250,0.2);
  border-radius:100px;font-size:0.7rem;font-weight:700;color:#60a5fa;margin-bottom:12px
}
.drug-info-title{font-size:1.35rem;font-weight:800;color:var(--text);letter-spacing:-0.02em}
.drug-info-subtitle{font-size:0.85rem;color:var(--text-muted);margin-top:4px}

/* Patient Context Alert */
.patient-context-alert{
  background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(251,113,133,0.05));
  border:1px solid rgba(251,191,36,0.25);border-radius:12px;padding:18px;margin-bottom:20px
}
.patient-context-alert.critical{
  background:linear-gradient(135deg,rgba(239,68,68,0.12),rgba(251,113,133,0.08));
  border-color:rgba(239,68,68,0.4);
  animation:criticalPulse 2s ease infinite
}
@keyframes criticalPulse{
  0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.2)}
  50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}
}
.context-alert-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.context-alert-icon{
  width:36px;height:36px;background:rgba(251,191,36,0.15);border-radius:10px;
  display:grid;place-items:center;font-size:1.1rem
}
.patient-context-alert.critical .context-alert-icon{background:rgba(239,68,68,0.2)}
.context-alert-title{font-size:0.9rem;font-weight:700;color:#fbbf24}
.patient-context-alert.critical .context-alert-title{color:#f87171}
.context-alert-list{list-style:none;padding:0;margin:0}
.context-alert-list li{
  display:flex;align-items:flex-start;gap:8px;padding:10px 12px;
  background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:8px;
  font-size:0.82rem;color:var(--text-secondary);line-height:1.4
}
.context-alert-list li:last-child{margin-bottom:0}
.context-alert-list li.critical{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2)}
.context-alert-list li.high{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2)}
.context-alert-list .alert-icon{font-size:1rem;flex-shrink:0;margin-top:1px}

/* Instant Lookup Badge */
.drug-instant-badge{
  display:flex;align-items:center;gap:8px;
  padding:10px 16px;margin-bottom:20px;
  background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(52,211,153,0.05));
  border:1px solid rgba(16,185,129,0.25);border-radius:10px
}
.instant-icon{font-size:1.1rem}
.drug-instant-badge>span:nth-child(2){font-size:0.85rem;font-weight:700;color:#34d399}
.instant-source{
  margin-left:auto;font-size:0.7rem;font-weight:600;color:#6b7280;
  padding:3px 10px;background:rgba(255,255,255,0.05);border-radius:100px
}

/* Drug Info Sections */
.drug-section{margin-bottom:20px}
.drug-section-title{
  display:flex;align-items:center;gap:8px;font-size:0.75rem;font-weight:700;
  color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;
  margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)
}
.drug-info-text{font-size:0.88rem;color:var(--text-secondary);line-height:1.65}
.drug-info-list{list-style:none;padding:0;margin:0}
.drug-info-list li{
  display:flex;align-items:flex-start;gap:10px;padding:8px 0;
  font-size:0.85rem;color:var(--text-secondary);border-bottom:1px solid var(--border);
  line-height:1.5
}
.drug-info-list li:last-child{border-bottom:none}
.drug-info-list li::before{content:'•';color:var(--teal);font-weight:bold;font-size:1rem;line-height:1.4}
.drug-info-list.contraindications li::before{color:var(--rose)}
.drug-info-list.monitoring li::before{color:var(--blue)}
.drug-info-list.interactions li::before{color:var(--gold)}
.drug-info-list li strong{color:var(--text);font-weight:600}

/* Renal Dosing Grid */
.renal-dosing-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px
}
.renal-dose-item{
  padding:12px;background:rgba(255,255,255,0.03);
  border:1px solid var(--border);border-radius:10px;text-align:center
}
.renal-label{
  display:block;font-size:0.7rem;font-weight:700;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px
}
.renal-value{font-size:0.8rem;color:var(--text-secondary);line-height:1.4}

/* Collapsible Sections */
.drug-collapsible-section{
  margin-bottom:16px;
  border:1px solid var(--border);
  border-radius:10px;
  overflow:hidden;
  background:var(--bg-elevated)
}
.drug-collapsible-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  cursor:pointer;
  background:rgba(255,255,255,0.02);
  transition:all 0.2s ease;
  user-select:none
}
.drug-collapsible-header:hover{
  background:rgba(255,255,255,0.04)
}
.drug-collapsible-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:0.85rem;
  font-weight:700;
  color:var(--text);
  text-transform:uppercase;
  letter-spacing:0.03em
}
.drug-collapsible-title span{
  font-size:1.1rem
}
.drug-collapsible-toggle{
  font-size:1.2rem;
  color:var(--text-muted);
  transition:transform 0.3s ease;
  line-height:1
}
.drug-collapsible-section.active .drug-collapsible-toggle{
  transform:rotate(180deg)
}
.drug-collapsible-content{
  max-height:0;
  overflow:hidden;
  transition:max-height 0.3s ease;
  padding:0 18px
}
.drug-collapsible-section.active .drug-collapsible-content{
  max-height:2000px;
  padding:0 18px 18px
}
.drug-collapsible-body{
  padding-top:8px
}

/* Enhanced Section Styling */
.drug-section-highlight{
  background:linear-gradient(135deg,rgba(96,165,250,0.05),rgba(167,139,250,0.03));
  border:2px solid var(--primary);
  border-radius:10px;
  padding:18px;
  margin-bottom:20px
}
.drug-section-critical{
  background:linear-gradient(135deg,rgba(239,68,68,0.08),rgba(251,113,133,0.05));
  border:2px solid rgba(239,68,68,0.4);
  border-radius:10px;
  padding:18px;
  margin-bottom:20px
}

/* Data Sources Footer */
.drug-data-sources{
  margin-top:24px;
  padding:16px;
  background:var(--bg-elevated);
  border-radius:10px;
  border:1px solid var(--border)
}
.drug-data-sources-title{
  font-size:0.75rem;
  font-weight:700;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:0.05em;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:6px
}
.drug-data-source-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 0;
  font-size:0.8rem;
  color:var(--text-secondary)
}
.drug-data-source-badge{
  padding:2px 8px;
  background:rgba(96,165,250,0.1);
  border-radius:4px;
  font-size:0.7rem;
  font-weight:600;
  color:#60a5fa
}

/* Responsive Design */
@media only screen and (max-width: 600px) {
  #drugInfoModal .modal-box{
    max-width:95%;
    margin:10px;
    border-radius:16px
  }
  .drug-info-title{
    font-size:1.15rem
  }
  .drug-section-title{
    font-size:0.7rem
  }
  .drug-collapsible-title{
    font-size:0.75rem
  }
  .renal-dosing-grid{
    grid-template-columns:1fr;
    gap:8px
  }
  .drug-collapsible-header{
    padding:12px 14px
  }
  .drug-collapsible-content{
    padding:0 14px
  }
  .drug-collapsible-section.active .drug-collapsible-content{
    padding:0 14px 14px
  }
}

/* ═══════════════════════════════════════════════════════════════════
   PLAN SECTION - Professional Interactive Design
   ═══════════════════════════════════════════════════════════════════ */
.plan-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
}

.plan-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.plan-header-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 1rem;
  color: var(--text);
}

.plan-header-title svg {
  width: 20px;
  height: 20px;
  color: var(--primary);
}

.plan-header-actions {
  display: flex;
  gap: 8px;
}

.plan-btn {
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.2s;
}

.plan-btn-edit {
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

.plan-btn-edit:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.plan-btn-add {
  background: var(--primary);
  color: white;
}

.plan-btn-add:hover {
  opacity: 0.9;
}

.plan-content {
  padding: 16px;
}

.plan-empty {
  text-align: center;
  padding: 24px 16px;
  color: var(--text-muted);
}

.plan-empty-icon {
  font-size: 2.5rem;
  margin-bottom: 8px;
  opacity: 0.5;
}

.plan-empty-text {
  font-size: 0.9rem;
  margin-bottom: 12px;
}

.plan-items {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.plan-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  transition: all 0.2s;
}

.plan-item:hover {
  border-color: var(--primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.plan-item-check {
  width: 22px;
  height: 22px;
  min-width: 22px;
  border-radius: 6px;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 2px;
}

.plan-item-check:hover {
  border-color: var(--primary);
  background: rgba(0,94,184,0.05);
}

.plan-item-check.completed {
  background: var(--emerald);
  border-color: var(--emerald);
  color: white;
}

.plan-item-content {
  flex: 1;
}

.plan-item-text {
  font-size: 0.9rem;
  color: var(--text-main);
  line-height: 1.4;
}

.plan-item.completed .plan-item-text {
  text-decoration: line-through;
  color: var(--text-muted);
}

.plan-item-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 6px;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.plan-item-priority {
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.65rem;
  text-transform: uppercase;
}

.plan-item-priority.high {
  background: #fef2f2;
  color: #dc2626;
}

.plan-item-priority.medium {
  background: #fffbeb;
  color: #d97706;
}

.plan-item-priority.low {
  background: #f0fdf4;
  color: #16a34a;
}

.plan-summary {
  padding: 12px 16px;
  background: var(--bg);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.8rem;
}

.plan-summary-stat {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--text-secondary);
}

.plan-summary-stat span {
  font-weight: 700;
  color: var(--primary);
}

/* Add Plan Modal */
.plan-modal-body {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.plan-priority-select {
  display: flex;
  gap: 8px;
}

.plan-priority-option {
  flex: 1;
  padding: 10px;
  border: 2px solid var(--border);
  border-radius: 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.85rem;
  font-weight: 600;
}

.plan-priority-option:hover {
  border-color: var(--primary);
}

.plan-priority-option.selected {
  border-color: var(--primary);
  background: var(--primary-light);
  color: var(--primary);
}

.plan-priority-option.high.selected {
  border-color: #dc2626;
  background: #fef2f2;
  color: #dc2626;
}

.plan-priority-option.medium.selected {
  border-color: #d97706;
  background: #fffbeb;
  color: #d97706;
}

.plan-priority-option.low.selected {
  border-color: #16a34a;
  background: #f0fdf4;
  color: #16a34a;
}

/* ═══════════════════════════════════════════════════════════════════
   ONCALL ASSISTANT STYLES
   ═══════════════════════════════════════════════════════════════════ */
.oncall-tab {
  background: linear-gradient(135deg, #7c3aed, #6d28d9) !important;
  color: white !important;
  border-color: #7c3aed !important;
}

.oncall-tab.active {
  background: linear-gradient(135deg, #6d28d9, #5b21b6) !important;
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3) !important;
}

/* OnCall Landing Button - Clean & Compact */
.oncall-landing-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #7c3aed, #5b21b6);
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 30px;
  margin: 16px auto;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.35);
  transition: all 0.2s ease;
}

.oncall-landing-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(124, 58, 237, 0.45);
}

/* AI Assistant Landing Button */
.ai-landing-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #0891b2, #0e7490);
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 30px;
  margin: 8px auto 16px;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.35);
  transition: all 0.2s ease;
}

.ai-landing-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(8, 145, 178, 0.45);
}

.abx-landing-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 30px;
  margin: 8px auto 16px;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
  transition: all 0.2s ease;
}

.abx-landing-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.45);
}

.oncall-btn-icon {
  font-size: 1rem;
}

.oncall-btn-text {
  letter-spacing: 0.02em;
}

.oncall-btn-arrow {
  font-size: 1rem;
  opacity: 0.8;
}

.oncall-hero {
  background: linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #1e40af 100%);
  color: white;
  padding: 24px;
  border-radius: 16px;
  text-align: center;
  margin-bottom: 20px;
}

.oncall-hero-icon {
  font-size: 3rem;
  margin-bottom: 12px;
}

.oncall-hero-title {
  font-size: 1.4rem;
  font-weight: 800;
  margin-bottom: 4px;
}

.oncall-hero-subtitle {
  font-size: 0.9rem;
  opacity: 0.9;
}

.oncall-tools-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.oncall-tool-card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.oncall-tool-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  border-color: var(--primary);
}

.oncall-tool-card.ai-card {
  background: linear-gradient(135deg, #f3e8ff, #faf5ff);
  border-color: #c4b5fd;
}

.oncall-tool-card.ai-card:hover {
  border-color: #7c3aed;
}

.oncall-tool-icon {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  margin: 0 auto 10px;
}

.oncall-tool-title {
  font-weight: 700;
  font-size: 0.85rem;
  color: var(--text-main);
  margin-bottom: 2px;
}

.oncall-tool-desc {
  font-size: 0.7rem;
  color: var(--text-muted);
}

.oncall-fullpage-btn {
  margin-top: 16px;
}

.oncall-fullpage-btn .btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 16px;
  font-size: 1rem;
}

/* OnCall Modal */
#oncallModal .modal-box {
  max-width: 500px;
  max-height: 85vh;
  overflow-y: auto;
}

.oncall-modal-header {
  padding: 20px;
  background: linear-gradient(135deg, #0284c7, #0369a1);
  color: white;
  border-radius: 20px 20px 0 0;
}

.oncall-modal-title {
  font-size: 1.2rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.oncall-modal-body {
  padding: 20px;
}

.oncall-input-group {
  margin-bottom: 16px;
}

.oncall-input-label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.oncall-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 1rem;
  font-family: inherit;
  background: #f9fafb;
  transition: all 0.2s;
}

.oncall-input:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 4px rgba(2,132,199,0.1);
}

.oncall-select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 1rem;
  background: #f9fafb;
  -webkit-appearance: none;
  cursor: pointer;
}

.oncall-gender-btns {
  display: flex;
  gap: 10px;
}

.oncall-gender-btn {
  flex: 1;
  padding: 14px;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: white;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.oncall-gender-btn.selected {
  background: var(--primary-light);
  border-color: var(--primary);
  color: var(--primary-dark);
}

.oncall-calc-btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
}

.oncall-result {
  margin-top: 16px;
  padding: 18px;
  border-radius: 14px;
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border-left: 5px solid var(--primary);
}

.oncall-result.danger {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border-left-color: #dc2626;
}

.oncall-result.warning {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  border-left-color: #d97706;
}

.oncall-result.success {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border-left-color: #059669;
}

.oncall-result-title {
  font-weight: 800;
  font-size: 1.1rem;
  margin-bottom: 10px;
}

.oncall-result.danger .oncall-result-title { color: #991b1b; }
.oncall-result.warning .oncall-result-title { color: #92400e; }
.oncall-result.success .oncall-result-title { color: #065f46; }

.oncall-result-content {
  font-size: 0.9rem;
  line-height: 1.6;
  color: var(--text-secondary);
}

.oncall-result-item {
  margin-bottom: 6px;
  padding-left: 16px;
  position: relative;
}

.oncall-result-item::before {
  content: "•";
  position: absolute;
  left: 0;
  color: var(--primary);
  font-weight: bold;
}

.oncall-result.danger .oncall-result-item::before { color: #dc2626; }

.oncall-citation {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px dashed var(--border);
  font-size: 0.7rem;
  color: var(--text-muted);
  font-style: italic;
}

/* AI Chat in OnCall */
.oncall-ai-input-wrap {
  position: relative;
}

.oncall-ai-input {
  width: 100%;
  padding: 14px 50px 14px 16px;
  border: 2px solid #c4b5fd;
  border-radius: 12px;
  font-size: 1rem;
  background: #faf5ff;
}

.oncall-ai-input:focus {
  border-color: #7c3aed;
  box-shadow: 0 0 0 4px rgba(124,58,237,0.1);
}

.oncall-ai-send {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 38px;
  height: 38px;
  border-radius: 10px;
  background: #7c3aed;
  border: none;
  color: white;
  cursor: pointer;
}

.oncall-ai-response {
  margin-top: 16px;
  padding: 16px;
  background: linear-gradient(135deg, #f3e8ff, #faf5ff);
  border-radius: 12px;
  border: 1px solid #e9d5ff;
  font-size: 0.9rem;
  line-height: 1.6;
  white-space: pre-wrap;
}

.oncall-ai-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #7c3aed;
}

.oncall-ai-dots {
  display: flex;
  gap: 4px;
}

.oncall-ai-dot {
  width: 8px;
  height: 8px;
  background: #7c3aed;
  border-radius: 50%;
  animation: oncallBounce 1.4s ease-in-out infinite;
}

.oncall-ai-dot:nth-child(2) { animation-delay: 0.2s; }
.oncall-ai-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes oncallBounce {
  0%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-6px); }
}

/* ═══════════════════════════════════════════════════════════════════════════════
   SYNC ENGINE v2.0 STYLES - Multi-Device Presence & Sync Indicator
   ═══════════════════════════════════════════════════════════════════════════════ */
/* ═══════════════════════════════════════════════════════════════════════════════
   SYNC STATUS UI v2.0 - Multi-Device Presence & Sync Indicator
   
   Add these styles to the dashboard <style> section
   ═══════════════════════════════════════════════════════════════════════════════ */

/* Sync Status Container - Fixed position in header */
.sync-status-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Main Sync Status Badge */
.sync-status-v2 {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.sync-status-v2.synced {
  background: rgba(5, 150, 105, 0.1);
  border-color: rgba(5, 150, 105, 0.3);
  color: #059669;
}

.sync-status-v2.syncing,
.sync-status-v2.loading {
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.3);
  color: #3b82f6;
}

.sync-status-v2.pending {
  background: rgba(217, 119, 6, 0.1);
  border-color: rgba(217, 119, 6, 0.3);
  color: #d97706;
}

.sync-status-v2.error {
  background: rgba(220, 38, 38, 0.1);
  border-color: rgba(220, 38, 38, 0.3);
  color: #dc2626;
}

.sync-status-v2.offline {
  background: rgba(107, 114, 128, 0.1);
  border-color: rgba(107, 114, 128, 0.3);
  color: #6b7280;
}

/* Sync Icon */
.sync-icon {
  font-size: 0.9rem;
  line-height: 1;
}

.sync-icon.spinning {
  animation: syncSpin 1s linear infinite;
}

@keyframes syncSpin {
  to { transform: rotate(360deg); }
}

/* Active Sessions Badge */
.active-sessions-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: rgba(251, 191, 36, 0.15);
  border: 1px solid rgba(251, 191, 36, 0.3);
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
  color: #92400e;
  cursor: help;
}

body.dark-theme .active-sessions-badge {
  background: rgba(251, 191, 36, 0.1);
  border-color: rgba(251, 191, 36, 0.2);
  color: #fcd34d;
}

.active-sessions-badge .sessions-icon {
  font-size: 0.85rem;
}

/* Conflict Modal */
.conflict-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.conflict-modal.active {
  opacity: 1;
  visibility: visible;
}

.conflict-content {
  background: var(--bg-surface);
  border-radius: 16px;
  width: 100%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.conflict-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
  text-align: center;
}

.conflict-icon {
  font-size: 3rem;
  margin-bottom: 12px;
}

.conflict-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.conflict-subtitle {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.conflict-body {
  padding: 20px;
}

.conflict-device-info {
  background: var(--bg-app);
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 16px;
}

.conflict-device-info .device-name {
  font-weight: 600;
  font-size: 0.9rem;
}

.conflict-device-info .device-time {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.conflict-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.conflict-btn {
  padding: 14px 20px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.9rem;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.conflict-btn.primary {
  background: var(--primary);
  color: #fff;
}

.conflict-btn.secondary {
  background: var(--bg-app);
  border: 1px solid var(--border);
  color: var(--text-main);
}

.conflict-btn.danger {
  background: rgba(220, 38, 38, 0.1);
  border: 1px solid rgba(220, 38, 38, 0.3);
  color: #dc2626;
}

/* Read-Only Mode Banner */
.readonly-banner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-bottom: 2px solid #f59e0b;
  padding: 10px 16px;
  display: none;
  align-items: center;
  justify-content: center;
  gap: 8px;
  z-index: 9998;
  font-size: 0.85rem;
  font-weight: 500;
  color: #92400e;
}

.readonly-banner.active {
  display: flex;
}

body.dark-theme .readonly-banner {
  background: linear-gradient(135deg, #78350f 0%, #451a03 100%);
  border-bottom-color: #92400e;
  color: #fcd34d;
}

.readonly-banner .banner-icon {
  font-size: 1.1rem;
}

.readonly-banner .banner-text {
  flex: 1;
}

.readonly-banner .banner-retry {
  padding: 4px 12px;
  border-radius: 6px;
  background: rgba(0, 0, 0, 0.1);
  border: none;
  font-weight: 600;
  font-size: 0.8rem;
  color: inherit;
  cursor: pointer;
}

/* Device Presence Tooltip */
.sessions-tooltip {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  padding: 12px;
  min-width: 200px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
}

.sessions-tooltip.active {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.sessions-tooltip-title {
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.session-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
}

.session-item:last-child {
  border-bottom: none;
}

.session-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--primary);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
}

.session-avatar.current {
  background: #059669;
}

.session-info {
  flex: 1;
}

.session-name {
  font-size: 0.85rem;
  font-weight: 600;
}

.session-time {
  font-size: 0.7rem;
  color: var(--text-muted);
}

.session-current-badge {
  font-size: 0.65rem;
  padding: 2px 6px;
  background: rgba(5, 150, 105, 0.15);
  color: #059669;
  border-radius: 4px;
  font-weight: 600;
}

/* Revision Badge */
.rev-badge {
  font-size: 0.65rem;
  padding: 2px 6px;
  background: var(--bg-app);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}

/* Drug Monograph Styles */
.section-title {
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 8px;
}

#modal-drug-monograph .modal-content {
  max-width: 600px;
  margin: auto;
}

#mono-safety-banner {
  padding: 12px;
  border-radius: 8px;
  font-size: 0.9rem;
  line-height: 1.5;
}

/* ═══════════════════════════════════════════════════════════════════
   DRUG MONOGRAPH MODAL - Premium Clinical Design (Theme Compatible)
   ═══════════════════════════════════════════════════════════════════ */

/* Pro Cards - Theme Compatible */
.pro-card {
  background: var(--bg-surface);
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  transition: all 0.2s ease;
}

.pro-card:hover {
  border-color: var(--primary);
  box-shadow: 0 4px 12px rgba(0, 94, 184, 0.1);
}

.pro-label {
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.pro-label::before {
  content: '';
  width: 3px;
  height: 12px;
  background: var(--primary);
  border-radius: 2px;
}

/* Shimmer Loading Effect - Theme Compatible */
.shimmer-line {
  background: var(--bg-elevated);
  border-radius: 8px;
  animation: shimmer 1.5s infinite linear;
  background: linear-gradient(
    to right, 
    var(--bg-elevated) 8%, 
    var(--bg-hover) 18%, 
    var(--bg-elevated) 33%
  );
  background-size: 800px 104px;
}

@keyframes shimmer {
  0% { background-position: -468px 0 }
  100% { background-position: 468px 0 }
}

/* Drug Monograph Modal Styles */
#modal-drug-monograph .modal-content {
  background: var(--bg-app);
  border-radius: 20px;
  max-width: 500px;
  width: 95%;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 1px solid var(--border);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
}

#modal-drug-monograph .mono-header {
  background: linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--border);
  position: relative;
}

#modal-drug-monograph .mono-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 20px;
  right: 20px;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
  opacity: 0.3;
}

#modal-drug-monograph .mono-title {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text-main);
  line-height: 1.2;
}

#modal-drug-monograph .mono-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 10px;
  padding: 6px 14px;
  border-radius: 100px;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#modal-drug-monograph .mono-badge.safe {
  background: rgba(16, 185, 129, 0.15);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

#modal-drug-monograph .mono-badge.caution {
  background: rgba(251, 191, 36, 0.15);
  color: #f59e0b;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

#modal-drug-monograph .mono-badge.warning {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

#modal-drug-monograph .mono-close {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 1.1rem;
  transition: all 0.2s ease;
}

#modal-drug-monograph .mono-close:hover {
  background: var(--bg-hover);
  color: var(--text-main);
  border-color: var(--primary);
}

#modal-drug-monograph .mono-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: var(--bg-app);
}

#modal-drug-monograph .mono-footer {
  background: var(--bg-surface);
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
}

#modal-drug-monograph .mono-footer .btn {
  flex: 1;
  padding: 14px 20px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.95rem;
}

/* Renal Alert - Theme Compatible */
.mono-alert-renal {
  margin-top: 14px;
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 113, 133, 0.05));
  border-left: 4px solid #f97316;
  padding: 12px 14px;
  border-radius: 8px;
  font-size: 0.88rem;
  color: var(--text-secondary);
}

.mono-alert-renal strong {
  color: #f97316;
}

/* Pro Card Content Styles */
.pro-card .dose-text {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main);
  line-height: 1.5;
}

.pro-card .info-text {
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

.pro-card .pearl-list {
  margin: 0;
  padding-left: 0;
  list-style: none;
}

.pro-card .pearl-list li {
  position: relative;
  padding: 8px 0 8px 24px;
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.5;
  border-bottom: 1px solid var(--border);
}

.pro-card .pearl-list li:last-child {
  border-bottom: none;
}

.pro-card .pearl-list li::before {
  content: '💎';
  position: absolute;
  left: 0;
  top: 8px;
  font-size: 0.8rem;
}

</style>
</head>
<body>
<script>
// Immediate theme initialization to prevent flash
(function() {
  const savedTheme = localStorage.getItem('MEDWARD_THEME');
  if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-theme');
  }
})();
</script>

<!-- Auth Check - Redirect to login if not authenticated, or landing if no unit selected -->
<script>
(function() {
  const user = sessionStorage.getItem('MW_USER') || localStorage.getItem('MW_USER');
  const pass = sessionStorage.getItem('MW_PASS') || localStorage.getItem('MW_PASS');
  // Check sessionStorage first, then localStorage fallback
  const unit = sessionStorage.getItem('MW_UNIT') || localStorage.getItem('MW_SELECTED_UNIT');
  
  if (!user || !pass) {
    window.location.href = 'login.html';
    return;
  }
  
  if (!unit) {
    window.location.href = 'landing.html';
    return;
  }
  
  // If unit was found in localStorage but not sessionStorage, copy it over
  if (!sessionStorage.getItem('MW_UNIT') && localStorage.getItem('MW_SELECTED_UNIT')) {
    sessionStorage.setItem('MW_UNIT', localStorage.getItem('MW_SELECTED_UNIT'));
    sessionStorage.setItem('MW_UNIT_NAME', localStorage.getItem('MW_SELECTED_UNIT_NAME') || '');
  }
})();
</script>

<!-- Read-Only Mode Banner (Sync Engine v2.0) -->
<div class="readonly-banner" id="readonlyBanner">
  <span class="banner-icon">⚠️</span>
  <span class="banner-text" id="readonlyText">Viewing cached data. Changes cannot be saved.</span>
  <button class="banner-retry" onclick="retryCloudConnection()">Retry</button>
</div>



<!-- DASHBOARD -->
<div class="page active" id="dashboard">
<header class="dash-header">
<div class="dash-brand">
<div class="dash-brand-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
<span class="dash-unit" id="unitBadge">Unit</span>
</div>
<div class="dash-user">
<button class="btn btn-ghost btn-sm" onclick="openUserSettings()" title="Settings">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
</button>
<a href="landing.html" class="btn btn-ghost btn-sm" title="Switch Unit">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a>
<div class="dash-avatar" id="dashAvatar">DR</div>
<button id="logoutBtn" class="btn btn-ghost btn-sm" title="Logout" style="color:var(--rose)">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
</button>
</div>
</header>
<!-- ═══════════════════════════════════════════════════════════════════
     SYNC STATUS BAR - Shows read-only/offline status
     ═══════════════════════════════════════════════════════════════════ -->
<div id="syncStatusBar" style="font-size:0.75rem; padding:6px 12px; text-align:center; display:none; font-weight:500;">
  Initializing...
</div>
<div class="dash-content">
<div class="date-banner"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span id="currentDate"></span></div>
<div class="tabs-container" id="mainTabs">
<button class="tab active" data-tab="patients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>Patients</button>
<button class="tab" data-tab="scores"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Scores</button>
<button class="tab" data-tab="reference"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>Reference</button>
</div>
<div class="panel active" id="panelPatients">
<div class="stats-grid" id="statsBar">
<div class="stat-card active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
<div class="stat-card" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div>
<div class="stat-card" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
<div class="stat-card" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
<div class="stat-card" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
</div>
<div class="action-buttons" style="display:flex;gap:8px;margin-bottom:16px;">
<button class="btn btn-primary" onclick="openAddPatient()" style="flex:1;padding:12px;font-size:0.85rem;display:flex;align-items:center;justify-content:center;gap:6px;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><path d="M12 5v14M5 12h14"/></svg>
  Add Patient
</button>
<a href="handover.html" class="btn btn-secondary" style="flex:1;padding:12px;font-size:0.85rem;display:flex;align-items:center;justify-content:center;gap:6px;text-decoration:none;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg>
  Handover
</a>
</div>
<div id="patientsList"></div>
</div>
<div class="panel" id="panelScores">
<div class="section-card">
<div class="section-header"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Clinical Scoring Calculators</div></div>
<div class="section-body">
<div class="scores-search-wrapper">
  <svg class="scores-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
  <input type="text" class="scores-search-input" id="scoresSearchInput" placeholder="Search scores (e.g., CURB-65, Wells, HEART)..." oninput="filterScores(this.value)">
</div>
<div class="quick-score-ref">
  <div class="quick-score-ref-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px;color:#dc2626"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Common Emergency Scores</div>
  <div class="quick-score-ref-grid">
    <div class="quick-score-ref-item" onclick="openScoreCalculator('qSOFA')">
      <span class="quick-score-ref-item-name">qSOFA</span>
      <span class="quick-score-ref-item-hint">Sepsis screening</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('Glasgow-Coma')">
      <span class="quick-score-ref-item-name">GCS</span>
      <span class="quick-score-ref-item-hint">Consciousness</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('HEART')">
      <span class="quick-score-ref-item-name">HEART</span>
      <span class="quick-score-ref-item-hint">Chest pain</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('Wells-PE')">
      <span class="quick-score-ref-item-name">Wells PE</span>
      <span class="quick-score-ref-item-hint">PE probability</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('CURB-65')">
      <span class="quick-score-ref-item-name">CURB-65</span>
      <span class="quick-score-ref-item-hint">Pneumonia</span>
    </div>
    <div class="quick-score-ref-item" onclick="openScoreCalculator('NEWS2')">
      <span class="quick-score-ref-item-name">NEWS2</span>
      <span class="quick-score-ref-item-hint">Early warning</span>
    </div>
  </div>
</div>
<div id="scoresGrid" class="emergency-scores-grid"></div>
</div>
</div>
</div>
<div class="panel" id="panelReference">
<div class="section-card">
<div class="section-header"><div class="section-title">📚 Clinical Reference</div></div>
<div class="section-body"><div class="ref-grid" id="refGrid"></div></div>
</div>
</div>

</div>
</div>

<!-- PATIENT PROFILE -->
<div class="page" id="patientProfile">
<div class="profile-header">
<div class="profile-nav">
<div class="back-btn" onclick="closePatientProfile()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
<div class="profile-title">Patient Profile</div>
<div class="profile-actions">
<button class="btn btn-success btn-sm" onclick="openDischargeModal()" id="profileDischargeBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="margin-right:4px"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Discharge</button>
<button class="icon-btn btn-edit" onclick="editCurrentPatient()" title="Edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
<button class="icon-btn btn-delete" onclick="deleteCurrentPatient()" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
</div>
</div>
<div class="profile-patient" id="profilePatientInfo"></div>
</div>
<!-- Mobile tabs (shown on small screens) -->
<div class="profile-tabs" id="profileTabs">
<button class="profile-tab active" data-ptab="overview"><svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>Overview</button>
<button class="profile-tab" data-ptab="meds"><svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 117-7l7 7a4.95 4.95 0 11-7 7z"/><path d="M8.5 8.5l7 7"/></svg>Meds</button>
<button class="profile-tab" data-ptab="labs"><svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M9 3h6v5l4 9a2 2 0 01-2 3H7a2 2 0 01-2-3l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>Labs</button>
<button class="profile-tab" data-ptab="history"><svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>History</button>
<button class="profile-tab" data-ptab="plans"><svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Plans</button>
</div>
<!-- Main body with sidebar -->
<div class="profile-body">
<!-- Sidebar navigation (shown on desktop) -->
<nav class="profile-sidebar" id="profileSidebar">
<div class="profile-nav-section">Patient Data</div>
<button class="profile-nav-item active" data-ptab="overview">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
<span class="nav-label">Overview</span>
</button>
<button class="profile-nav-item" data-ptab="meds">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 117-7l7 7a4.95 4.95 0 11-7 7z"/><path d="M8.5 8.5l7 7"/></svg>
<span class="nav-label">Medications</span>
</button>
<button class="profile-nav-item" data-ptab="history">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
<span class="nav-label">History</span>
</button>
<div class="profile-nav-section">Diagnostics</div>
<button class="profile-nav-item" data-ptab="labs">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M9 3h6v5l4 9a2 2 0 01-2 3H7a2 2 0 01-2-3l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>
<span class="nav-label">Labs</span>
<span class="nav-badge" id="labsAlertBadge" style="display:none">!</span>
</button>
<button class="profile-nav-item" data-ptab="imaging">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
<span class="nav-label">Imaging</span>
</button>
<button class="profile-nav-item" data-ptab="scores">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
<span class="nav-label">Scores</span>
</button>
<div class="profile-nav-section">Management</div>
<button class="profile-nav-item" data-ptab="fluids">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/></svg>
<span class="nav-label">Fluids</span>
</button>
<button class="profile-nav-item" data-ptab="plans">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
<span class="nav-label">Plans</span>
<span class="nav-badge" id="plansTaskBadge" style="display:none">0</span>
</button>
</nav>
<!-- Content panels -->
<div class="profile-content">
<div class="profile-panel active" id="profileOverview"></div>
<div class="profile-panel" id="profileMeds"></div>
<div class="profile-panel" id="profileHistory"></div>
<div class="profile-panel" id="profileScores"></div>
<div class="profile-panel" id="profileLabs"></div>
<div class="profile-panel" id="profileImaging"></div>
<div class="profile-panel" id="profileFluids"></div>
<div class="profile-panel" id="profilePlans"></div>
</div>
</div>
</div>

<!-- ADMIN -->
<div class="page" id="adminPanel">
<header class="admin-header">
<div style="display:flex;align-items:center;gap:12px">
<div style="width:36px;height:36px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center">
<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
</div>
<span style="font-weight:700;font-size:1.1rem">Admin</span>
</div>
<button class="btn btn-secondary btn-sm" onclick="exitAdmin()" style="padding:10px 16px;font-size:0.85rem"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><polyline points="15 18 9 12 15 6"/></svg>Exit</button>
</header>
<div class="admin-content">
<div class="admin-tabs" id="adminTabs">
<button class="admin-tab active" data-atab="units" onclick="switchAdminTab('units')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>Units</button>
<button class="admin-tab" data-atab="requests" onclick="switchAdminTab('requests')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>Requests <span class="badge-count" id="requestsCount" style="display:none">0</span></button>
<button class="admin-tab" data-atab="trash" onclick="switchAdminTab('trash')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>Trash</button>
<button class="admin-tab" data-atab="settings" onclick="switchAdminTab('settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="vertical-align:-3px;margin-right:4px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</button>
</div>

<div class="admin-tab-panel active" id="adminUnits">
<div class="admin-section">
<div class="section-header"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>Manage Units</div><button class="btn btn-primary btn-sm" onclick="addUnit()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Unit</button></div>
<div class="section-body" id="unitsTable"></div>
</div>
</div>

<div class="admin-tab-panel" id="adminRequests">
<div class="admin-section">
<div class="section-header"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>Requests</div><button class="btn btn-secondary btn-sm" onclick="refreshRequests()" style="padding:8px 12px;font-size:0.8rem"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>Refresh</button></div>
<div class="section-body">
<div class="requests-list" id="requestsList">
<div class="admin-empty-state">
<div class="admin-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg></div>
<div class="admin-empty-text">No pending requests</div>
<div class="admin-empty-hint">Unit access requests will appear here</div>
</div>
</div>
</div>
</div>
</div>

<div class="admin-tab-panel" id="adminTrash">
<div class="admin-section">
<div class="section-header"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>Trash</div><button class="btn btn-danger btn-sm" onclick="emptyTrashPermanently()">Empty Trash</button></div>
<div class="section-body" id="trashContent">
<div class="admin-empty-state">
<div class="admin-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></div>
<div class="admin-empty-text">Trash is empty</div>
<div class="admin-empty-hint">Deleted items will appear here for recovery</div>
</div>
</div>
</div>
</div>

<div class="admin-tab-panel" id="adminSettings">
<div class="admin-section">
<div class="section-header"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</div></div>
<div class="section-body">
<div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="Enter new password"></div>
<div class="form-group">
<label class="form-label">API Endpoint <span style="color:var(--emerald);font-size:0.7rem;background:rgba(5,150,105,0.1);padding:2px 8px;border-radius:4px;margin-left:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="vertical-align:-2px;margin-right:2px"><polyline points="20 6 9 17 4 12"/></svg>Connected</span></label>
<input type="text" id="apiUrl" class="form-input" readonly style="background:var(--bg);font-size:0.8rem;color:var(--text-muted)">
</div>
<div class="form-group">
<label class="form-label">💊 Drug Reference URL</label>
<input type="text" id="drugRefUrl" class="form-input" placeholder="https://example.com/drug.html">
<p style="font-size:0.75rem;color:var(--text-muted);margin-top:6px">Optional: URL for medication info</p>
</div>
<button class="btn btn-primary" onclick="saveSettings()" style="width:100%;margin-top:8px">💾 Save Settings</button>
</div>
</div>

<!-- TRASH MANAGEMENT SECTION -->
<div class="admin-section">
<div class="section-header"><div class="section-title">🗑️ Trash Bin</div></div>
<div class="section-body">
<p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:12px">Deleted patients are stored safely here. You can restore them or permanently delete.</p>
<button class="btn btn-secondary" onclick="openTrashView()" style="width:100%">
  <span style="margin-right:8px">🗑️</span> View Deleted Items
</button>
</div>
</div>

<!-- USER SESSION SECTION -->
<div class="admin-section">
<div class="section-header"><div class="section-title">👤 User Session</div></div>
<div class="section-body">
<div id="currentUserInfo" style="background:var(--bg-elevated);padding:12px;border-radius:8px;margin-bottom:12px;font-size:0.85rem;">
  <div style="color:var(--text-secondary);margin-bottom:4px">Logged in as:</div>
  <div id="authUserDisplay" style="font-weight:600;color:var(--text-main)">—</div>
</div>
<button class="btn btn-danger" onclick="doLogout()" style="width:100%;border-left:4px solid #dc2626;">
  <span style="margin-right:8px">🚪</span> Log Out
</button>
<p style="font-size:0.75rem;color:var(--text-muted);margin-top:8px">This will clear your session on this device</p>
</div>
</div>

<!-- IMPORT WARD LIST SECTION -->
<div class="admin-section">
<div class="section-header">
  <div class="section-title">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" style="vertical-align:-3px;margin-right:6px">
      <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
    </svg>
    Import Ward List
  </div>
</div>
<div class="section-body">
  <!-- Target Unit Indicator -->
  <div id="importTargetUnit" style="padding:10px 12px;background:linear-gradient(135deg,rgba(0,94,184,0.1),rgba(0,119,204,0.05));border:1px solid rgba(0,94,184,0.2);border-radius:8px;margin-bottom:14px;display:flex;align-items:center;gap:8px">
    <span style="font-size:1.2rem">🏥</span>
    <div>
      <div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Importing to</div>
      <div id="importTargetUnitName" style="font-weight:700;color:var(--primary)">Select a unit first</div>
    </div>
  </div>
  
  <p style="color:var(--text-secondary);font-size:0.82rem;margin-bottom:14px">
    Import patients from Google Sheets. Patients will be assigned to the current unit with their ward as their physical location.
  </p>
  
  <!-- Sheet URL Input -->
  <div class="form-group">
    <label class="form-label">📊 Google Sheet URL or ID</label>
    <input type="text" id="import_sheetUrl" class="form-input" placeholder="Paste full sheet URL or just the Sheet ID">
    <p style="font-size:0.7rem;color:var(--text-muted);margin-top:4px">
      Example: https://docs.google.com/spreadsheets/d/1ABC123.../edit
    </p>
  </div>
  
  <!-- Tab Name (Optional) -->
  <div class="form-group">
    <label class="form-label">📑 Tab Name <span style="color:var(--text-muted);font-weight:400">(optional)</span></label>
    <input type="text" id="import_tabName" class="form-input" placeholder="e.g., Male list (active)">
  </div>
  
  <!-- Import Options -->
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--text-secondary);cursor:pointer">
      <input type="checkbox" id="import_clearExisting" style="width:16px;height:16px;accent-color:var(--primary)">
      Replace existing patients (in current unit only)
    </label>
  </div>
  
  <!-- Action Buttons -->
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <button class="btn btn-primary" onclick="importWardList()" style="flex:1" id="btnImportList">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="vertical-align:-3px;margin-right:6px">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
      </svg>
      Import Patients
    </button>
    <button class="btn btn-secondary" onclick="previewImport()" id="btnPreviewImport">Preview</button>
  </div>
  
  <!-- Status Display -->
  <div id="importStatus" style="display:none;padding:10px 12px;border-radius:8px;font-size:0.82rem;margin-bottom:10px"></div>
  
  <!-- Last Import Info -->
  <div id="lastImportInfo" style="font-size:0.75rem;color:var(--text-muted);padding:8px 10px;background:var(--bg-elevated);border-radius:6px;display:none">
    <div style="display:flex;align-items:center;gap:6px">
      <span style="color:var(--success)">✓</span>
      <span id="lastImportText">Last import: —</span>
    </div>
  </div>
</div>
</div>
</div>
</div>
</div>

<!-- TRASH VIEW MODAL -->
<div class="modal" id="trashModal">
<div class="modal-box" style="max-width:500px;max-height:80vh;display:flex;flex-direction:column;">
<div class="modal-header">
<div class="modal-title">🗑️ Trash Bin</div>
<button class="btn-icon" onclick="closeModal('trashModal')" style="color:var(--text-secondary)">&times;</button>
</div>
<div class="modal-body" style="flex:1;overflow-y:auto;padding:0;">
<div style="padding:12px 16px;background:var(--bg-elevated);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
  <span style="font-size:0.85rem;color:var(--text-secondary)">Deleted items are stored here safely</span>
  <button class="btn btn-ghost btn-sm" onclick="fetchTrash()" style="padding:6px 10px;font-size:0.75rem">🔄 Refresh</button>
</div>
<div id="trash-list" style="padding:12px;min-height:200px;">
  <div style="text-align:center;color:var(--text-muted);padding:40px 20px;">
    <div style="font-size:2rem;margin-bottom:8px;">📭</div>
    <div>Loading trash...</div>
  </div>
</div>
</div>
<div class="modal-footer" style="border-top:1px solid var(--border);padding:12px 16px;display:flex;justify-content:space-between;">
<button class="btn btn-danger btn-sm" onclick="emptyTrashConfirm()" style="font-size:0.8rem">🗑️ Empty Trash</button>
<button class="btn btn-secondary btn-sm" onclick="closeModal('trashModal')">Close</button>
</div>
</div>
</div>

<!-- MODALS -->
<div class="modal" id="accessModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div id="accessIcon" style="font-size:3rem;margin-bottom:12px">🏥</div>
<div class="modal-title" id="accessTitle">Unit Access</div>
<p style="color:var(--text-muted);font-size:0.85rem;margin-top:8px">Enter your details to continue</p>
</div>
<div class="modal-body">
<div id="userSection">
<div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input" placeholder="Enter your name"></div>
<div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option></select></div>
<div class="form-group" style="margin-top:16px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:0.85rem;color:var(--text-secondary)">
<input type="checkbox" id="rememberMe" style="width:18px;height:18px;accent-color:var(--primary)">
<span>Remember me on this device</span>
</label>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
<button class="btn btn-primary" id="enterBtn" onclick="enterUnit()">Enter Unit</button>
</div>
</div>
</div>

<!-- USER SETTINGS MODAL -->
<div class="modal" id="userSettingsModal">
<div class="modal-box" style="max-width:500px;max-height:85vh;display:flex;flex-direction:column;">
<div class="modal-header">
  <div class="modal-title" style="display:flex;align-items:center;gap:10px;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    Settings
  </div>
  <button class="btn btn-ghost btn-sm" onclick="closeModal('userSettingsModal')" style="padding:8px">&times;</button>
</div>
<div class="modal-body" style="flex:1;overflow-y:auto;padding:0;">
  
  <!-- IMPORT WARD LIST SECTION -->
  <div style="padding:16px;border-bottom:1px solid var(--border);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--emerald),var(--teal));display:grid;place-items:center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
      </div>
      <div>
        <div style="font-weight:700;color:var(--text);font-size:0.95rem;">Import Ward List</div>
        <div style="font-size:0.75rem;color:var(--text-muted);">Pull patients from Google Sheets</div>
      </div>
    </div>
    
    <div class="form-group" style="margin-bottom:12px;">
      <label class="form-label">📊 Google Sheet URL or ID</label>
      <input type="text" id="user_import_sheetUrl" class="form-input" placeholder="Paste sheet URL or ID" style="font-size:0.85rem;">
    </div>
    
    <div class="form-group" style="margin-bottom:12px;">
      <label class="form-label">📑 Tab Name <span style="color:var(--text-muted);font-weight:400">(optional)</span></label>
      <input type="text" id="user_import_tabName" class="form-input" placeholder="e.g., Male list (active)" style="font-size:0.85rem;">
    </div>
    
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
      <input type="checkbox" id="user_import_clearExisting" style="width:16px;height:16px;accent-color:var(--primary);">
      <label for="user_import_clearExisting" style="font-size:0.8rem;color:var(--text-secondary);cursor:pointer;">Replace existing patients</label>
    </div>
    
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" onclick="userImportWardList()" style="flex:1;padding:10px;font-size:0.85rem;" id="btnUserImportList">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right:6px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
        Import
      </button>
      <button class="btn btn-secondary" onclick="userPreviewImport()" style="padding:10px 16px;font-size:0.85rem;" id="btnUserPreviewImport">Preview</button>
    </div>
    
    <!-- Cleanup button -->
    <button class="btn" onclick="cleanupWardUnits()" style="width:100%;margin-top:8px;padding:8px;font-size:0.8rem;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-muted);" id="btnCleanupUnits">
      🧹 Cleanup Ward Units (if units showing incorrectly)
    </button>
    
    <div id="userImportStatus" style="display:none;padding:10px;border-radius:8px;font-size:0.8rem;margin-top:10px;"></div>
    
    <div id="userLastImportInfo" style="display:none;font-size:0.7rem;color:var(--text-muted);margin-top:8px;padding:6px 8px;background:var(--bg-elevated);border-radius:6px;">
      <span style="color:var(--success)">✓</span> <span id="userLastImportText">Last import: —</span>
    </div>
  </div>
  
  <!-- EXPORT PDF SECTION -->
  <div style="padding:16px;border-bottom:1px solid var(--border);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#dc2626,#f59e0b);display:grid;place-items:center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      </div>
      <div>
        <div style="font-weight:700;color:var(--text);font-size:0.95rem;">Export Ward List</div>
        <div style="font-size:0.75rem;color:var(--text-muted);">Download PDF for handover/rounds</div>
      </div>
    </div>
    
    <!-- Current Unit Indicator -->
    <div id="exportUnitIndicator" style="padding:10px 12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;display:flex;align-items:center;gap:8px">
      <span style="font-size:1.1rem">🏥</span>
      <div>
        <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Exporting from</div>
        <div id="exportUnitName" style="font-weight:600;color:var(--text)">Select a unit first</div>
      </div>
    </div>
    
    <!-- Export Info -->
    <div style="background:var(--bg-elevated);padding:10px 12px;border-radius:8px;margin-bottom:12px;font-size:0.8rem;color:var(--text-secondary);">
      <div style="margin-bottom:6px;font-weight:600;color:var(--text);">📋 PDF will include:</div>
      <div>• <strong style="color:#4CAF50">Active List</strong> - grouped by ward (top)</div>
      <div>• <strong style="color:#FF9800">Chronic List</strong> - grouped by ward (bottom)</div>
      <div>• <strong style="color:#FF9800">New patients</strong> highlighted in orange</div>
    </div>
    
    <!-- Export Button -->
    <button class="btn btn-primary" onclick="exportUnitToPDF()" style="width:100%;padding:12px;font-size:0.9rem;" id="btnExportPDF">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right:8px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
      Export to PDF
    </button>
    
    <div id="exportStatus" style="display:none;padding:10px;border-radius:8px;font-size:0.8rem;margin-top:10px;"></div>
  </div>
  
  <!-- USER INFO SECTION -->
  <div style="padding:16px;border-bottom:1px solid var(--border);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--blue));display:grid;place-items:center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div>
        <div style="font-weight:700;color:var(--text);font-size:0.95rem;">User Session</div>
        <div style="font-size:0.75rem;color:var(--text-muted);">Current login info</div>
      </div>
    </div>
    <div style="background:var(--bg-elevated);padding:12px;border-radius:8px;font-size:0.85rem;">
      <div style="color:var(--text-muted);margin-bottom:4px;">Logged in as:</div>
      <div id="settingsUserDisplay" style="font-weight:600;color:var(--text);">—</div>
    </div>
  </div>
  
  <!-- APP INFO -->
  <div style="padding:16px;">
    <div style="text-align:center;color:var(--text-muted);font-size:0.75rem;">
      <div style="font-weight:600;margin-bottom:4px;">MedWard Pro</div>
      <div>v15.0 • Ward Management System</div>
    </div>
  </div>
  
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" onclick="closeModal('userSettingsModal')" style="flex:1;">Close</button>
</div>
</div>
</div>

<div class="modal" id="adminModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div style="font-size:3rem;margin-bottom:12px">⚙️</div>
<div class="modal-title">Admin Access</div>
</div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPwd" class="form-input"></div>
<p class="code-error" id="adminError">Invalid</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('adminModal')">Cancel</button>
<button class="btn btn-primary" onclick="loginAdmin()">Login</button>
</div>
</div>
</div>

<div class="modal" id="patientModal">
<div class="modal-box" style="max-width:540px">
<div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div>
<div class="modal-body">
<input type="hidden" id="ptId">
<div class="form-group"><label class="form-label">Patient Name</label><input type="text" id="ptName" class="form-input"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group">
  <label class="form-label">Ward</label>
  <div class="ward-input-wrapper">
    <input type="text" id="ptWard" class="form-input" placeholder="Type ward (e.g., Ward 14, ICU)" autocomplete="off" oninput="showWardSuggestions(this.value)" onfocus="showWardSuggestions(this.value)">
    <div class="ward-suggestions" id="wardSuggestions"></div>
  </div>
</div>
<div class="form-group"><label class="form-label">Room</label><input type="text" id="ptRoom" class="form-input"></div>
</div>
<div class="form-group"><label class="form-label">Diagnosis</label><textarea id="ptDx" class="form-textarea"></textarea></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Doctor</label><input type="text" id="ptDoctor" class="form-input"></div>
<div class="form-group"><label class="form-label">Status</label><select id="ptStatus" class="form-select"><option value="new">🆕 New</option><option value="active">✅ Active</option><option value="critical">🚨 Critical</option><option value="chronic">💜 Chronic</option><option value="discharged">🏠 Discharged</option></select></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
<button class="btn btn-primary" onclick="savePatient()">Save</button>
</div>
</div>
</div>

<div class="modal" id="unitModal">
<div class="modal-box">
<div class="modal-header"><div class="modal-title" id="unitModalTitle">Add Unit</div></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name</label><input type="text" id="uName" class="form-input"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Icon</label><input type="text" id="uIcon" class="form-input" value="🏥" style="font-size:1.75rem;text-align:center"></div>
<div class="form-group"><label class="form-label">Code</label><input type="text" id="uCode" class="form-input" maxlength="4"></div>
</div>
<div class="form-group"><label class="form-label">Description</label><input type="text" id="uDesc" class="form-input"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveUnit()">Save</button>
</div>
</div>
</div>

<div class="modal" id="importModal">
<div class="modal-box" style="max-width:560px">
<div class="modal-header"><div class="modal-title">📥 Import Patients</div></div>
<div class="modal-body">
<div id="importUpload">
<div class="upload-zone" onclick="document.getElementById('importFile').click()">
<div style="font-size:2.5rem;margin-bottom:12px">📷</div>
<div style="font-weight:600">Upload Screenshot</div>
</div>
<input type="file" id="importFile" accept="image/*" style="display:none">
</div>
<div id="importPreview" style="display:none">
<img id="importImg" style="width:100%;max-height:160px;object-fit:contain;border-radius:12px;margin-bottom:16px">
<div style="display:flex;gap:12px">
<button class="btn btn-secondary btn-sm" style="flex:1" onclick="resetImport()">Change</button>
<button class="btn btn-primary btn-sm" style="flex:2" onclick="extractPatients()">🤖 Extract</button>
</div>
</div>
<div id="importLoading" style="display:none;text-align:center;padding:48px"><div class="spinner"></div></div>
<div id="importResults" style="display:none">
<div style="display:flex;justify-content:space-between;margin-bottom:16px"><span style="font-weight:600">Found</span><span id="importCount" class="badge badge-emerald">0</span></div>
<div id="importList" style="max-height:320px;overflow-y:auto"></div>
</div>
<div id="importError" style="display:none;text-align:center;padding:40px">
<div style="font-size:2.5rem;margin-bottom:16px">⚠️</div>
<div id="importErrorMsg" style="color:var(--rose)">Error</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px" onclick="resetImport()">Retry</button>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
<button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>Import</button>
</div>
</div>
</div>

<div class="modal" id="editTextModal">
<div class="modal-box wide">
<div class="modal-header"><div class="modal-title" id="editTextTitle">Edit</div></div>
<div class="modal-body">
<input type="hidden" id="editTextType">
<textarea id="editTextArea" class="form-textarea" style="min-height:200px"></textarea>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('editTextModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveEditText()">Save</button>
</div>
</div>
</div>

<!-- ONCALL TOOL MODAL -->
<div class="modal" id="oncallModal">
<div class="modal-box" style="max-width:500px">
<div class="oncall-modal-header">
  <div class="oncall-modal-title" id="oncallModalTitle">🧪 Tool</div>
</div>
<div class="oncall-modal-body" id="oncallModalBody"></div>
<div class="modal-footer">
<button class="btn btn-secondary btn-full" onclick="closeModal('oncallModal')">Close</button>
</div>
</div>
</div>

<div class="modal" id="addDataModal">
<div class="modal-box wide">
<div class="modal-header"><div class="modal-title" id="addDataTitle">Add</div></div>
<div class="modal-body" id="addDataBody"></div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('addDataModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveAddData()">Save</button>
</div>
</div>
</div>

<!-- REQUEST UNIT MODAL -->
<div class="modal" id="requestUnitModal">
<div class="modal-box wide">
<div class="modal-header">
<div class="modal-title">📩 Request New Unit Access</div>
<button class="btn btn-ghost" onclick="closeModal('requestUnitModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div>
<div class="modal-body" id="requestUnitBody">
<div id="requestFormSection">
<p style="color:var(--text-secondary);margin-bottom:24px;font-size:0.9rem">Fill out this form to request a new unit. Your request will be reviewed by an administrator who will create your unit and provide access credentials.</p>
<div class="request-form">
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Your Full Name *</label>
<input type="text" id="reqName" class="form-input" placeholder="Dr. John Smith">
</div>
<div class="form-group">
<label class="form-label">Email Address *</label>
<input type="email" id="reqEmail" class="form-input" placeholder="john.smith@hospital.com">
</div>
</div>
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Department *</label>
<input type="text" id="reqDepartment" class="form-input" placeholder="e.g., Internal Medicine, Cardiology">
</div>
<div class="form-group">
<label class="form-label">Position/Role *</label>
<select id="reqRole" class="form-input">
<option value="">Select role...</option>
<option value="attending">Attending Physician</option>
<option value="consultant">Consultant</option>
<option value="resident">Resident</option>
<option value="intern">Intern</option>
<option value="nurse_manager">Nurse Manager</option>
<option value="head_nurse">Head Nurse</option>
<option value="other">Other</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Requested Unit Name *</label>
<input type="text" id="reqUnitName" class="form-input" placeholder="e.g., Cardiology Unit A, ICU Team 2">
</div>
<div class="form-group">
<label class="form-label">Unit Icon</label>
<div class="request-icon-grid" id="iconGrid">
<div class="request-icon-option selected" data-icon="🏥">🏥</div>
<div class="request-icon-option" data-icon="❤️">❤️</div>
<div class="request-icon-option" data-icon="🫀">🫀</div>
<div class="request-icon-option" data-icon="🧠">🧠</div>
<div class="request-icon-option" data-icon="🫁">🫁</div>
<div class="request-icon-option" data-icon="🦴">🦴</div>
<div class="request-icon-option" data-icon="👶">👶</div>
<div class="request-icon-option" data-icon="🩺">🩺</div>
<div class="request-icon-option" data-icon="💉">💉</div>
<div class="request-icon-option" data-icon="🔬">🔬</div>
<div class="request-icon-option" data-icon="⚕️">⚕️</div>
<div class="request-icon-option" data-icon="🚑">🚑</div>
</div>
</div>
<div class="form-group">
<label class="form-label">Reason for Request / Additional Notes</label>
<textarea id="reqMessage" class="form-textarea" placeholder="Briefly describe why you need this unit and any specific requirements..."></textarea>
</div>
</div>
</div>
<div id="requestSuccessSection" style="display:none">
<div class="request-success">
<div class="request-success-icon">✅</div>
<div class="request-success-title">Request Submitted Successfully!</div>
<div class="request-success-text">Your request has been sent to the administrator for review. You will receive your unit access code once approved.</div>
<div class="request-success-id" id="requestIdDisplay">Request ID: REQ-XXXXXX</div>
</div>
</div>
</div>
<div class="modal-footer" id="requestFormFooter">
<button class="btn btn-secondary" onclick="closeModal('requestUnitModal')">Cancel</button>
<button class="btn btn-primary" onclick="submitUnitRequest()">📤 Submit Request</button>
</div>
<div class="modal-footer" id="requestSuccessFooter" style="display:none">
<button class="btn btn-primary btn-full" onclick="closeModal('requestUnitModal')">Done</button>
</div>
</div>
</div>

<!-- APPROVE REQUEST MODAL -->
<div class="modal" id="approveRequestModal">
<div class="modal-box wide">
<div class="modal-header">
<div class="modal-title">✅ Approve Unit Request</div>
<button class="btn btn-ghost" onclick="closeModal('approveRequestModal')" aria-label="Close"<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div>
<div class="modal-body" style="padding:20px">
<!-- Request Details Section -->
<div id="approveRequestDetails" style="margin-bottom:20px"></div>

<!-- Create Unit Section -->
<div style="background:var(--bg-surface);border:2px solid var(--primary);border-radius:12px;padding:20px">
<h4 style="margin:0 0 20px 0;font-size:1rem;color:var(--primary);display:flex;align-items:center;gap:8px">
  <span>🔐</span> Create Unit Access
</h4>

<!-- Row 1: Unit Name + Icon -->
<div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:16px">
  <div class="form-group" style="margin:0">
    <label class="form-label">Unit Name</label>
    <input type="text" id="approveUnitName" class="form-input" style="font-weight:600">
  </div>
  <div class="form-group" style="margin:0;width:80px">
    <label class="form-label">Icon</label>
    <input type="text" id="approveUnitIcon" class="form-input" style="font-size:1.5rem;text-align:center">
  </div>
</div>

<!-- Row 2: Access Code + Color -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
  <div class="form-group" style="margin:0">
    <label class="form-label" style="color:var(--danger);font-weight:700">🔑 Access Code *</label>
    <input type="text" id="approveUnitCode" class="form-input mono" maxlength="4" placeholder="1234" style="font-size:1.5rem;text-align:center;letter-spacing:8px;font-weight:700;padding:12px">
  </div>
  <div class="form-group" style="margin:0">
    <label class="form-label">Color</label>
    <select id="approveUnitColor" class="form-input" style="padding:12px">
      <option value="#14b8a6">🟢 Teal</option>
      <option value="#f59e0b">🟡 Gold</option>
      <option value="#3b82f6">🔵 Blue</option>
      <option value="#8b5cf6">🟣 Purple</option>
      <option value="#f43f5e">🔴 Rose</option>
      <option value="#10b981">🟢 Emerald</option>
    </select>
  </div>
</div>

<!-- Row 3: Description -->
<div class="form-group" style="margin:0 0 16px 0">
  <label class="form-label">Description</label>
  <input type="text" id="approveUnitDesc" class="form-input" placeholder="Brief description">
</div>

<!-- Email Notice -->
<div style="padding:12px;background:var(--success-bg);border-radius:8px;border:1px solid var(--success)">
  <div style="font-size:0.8rem;color:var(--success-text)">📧 <strong>The requester will receive an email</strong> with access code and confirmation.</div>
</div>
</div>
</div>

<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('approveRequestModal')">Cancel</button>
<button class="btn btn-danger" onclick="rejectRequest()">✕ Reject</button>
<button class="btn btn-primary" onclick="approveRequest()" style="background:var(--success)">✅ Approve</button>
</div>
</div>
</div>

<!-- Enhanced Lab Extraction Preview Modal -->
<div class="modal" id="labPreviewModal">
  <div class="modal-box wide">
    <div class="modal-header">
      <div class="modal-title">🧪 Lab Extraction Preview</div>
      <button class="btn btn-ghost" onclick="closeModal('labPreviewModal'); resetLabExtraction()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body" id="labPreviewBody">
      <!-- Dynamic content inserted by showLabExtractionPreview() -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('labPreviewModal'); resetLabExtraction()">Cancel</button>
      <button class="btn btn-primary" id="confirmLabBtn" onclick="confirmLabExtraction()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><polyline points="20 6 9 17 4 12"/></svg>Confirm & Save</button>
    </div>
  </div>
</div>

<!-- Professional Lab Analysis Loader -->
<div class="lab-analysis-loader" id="labAnalysisLoader">
  <div class="loader-content">
    <div class="dna-loader">
      <div class="dna-strand">
        <div class="dna-dot"></div>
        <div class="dna-dot"></div>
        <div class="dna-dot"></div>
        <div class="dna-dot"></div>
      </div>
      <div class="dna-strand">
        <div class="dna-dot"></div>
        <div class="dna-dot"></div>
        <div class="dna-dot"></div>
        <div class="dna-dot"></div>
      </div>
      <div class="dna-connector"></div>
    </div>
    <div class="loader-title">Analyzing Lab Results</div>
    <div class="loader-subtitle">Processing with Claude AI</div>
    <div class="loader-steps">
      <div class="loader-step" id="step1">
        <div class="step-icon">1</div>
        <span>Preparing image for analysis...</span>
      </div>
      <div class="loader-step" id="step2">
        <div class="step-icon">2</div>
        <span>Extracting lab values...</span>
      </div>
      <div class="loader-step" id="step3">
        <div class="step-icon">3</div>
        <span>Identifying reference ranges...</span>
      </div>
      <div class="loader-step" id="step4">
        <div class="step-icon">4</div>
        <span>Generating clinical interpretation...</span>
      </div>
    </div>
  </div>
</div>

<!-- Score Calculator Modal - Mobile-First Design -->
<div class="modal" id="scoreCalcModal" style="padding:0">
  <div class="modal-box wide" style="border:none;background:transparent">
    <div class="score-calculator">
      <div class="score-calc-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="score-calc-title" id="scoreCalcTitle">Score Name</div>
            <div class="score-calc-purpose" id="scoreCalcPurpose">Purpose description</div>
          </div>
          <button onclick="closeModal('scoreCalcModal')" style="background:rgba(148,163,184,0.1);border:none;width:32px;height:32px;border-radius:8px;color:#94a3b8;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="score-calc-category" id="scoreCalcCategory">Category</div>
      </div>
      <div class="score-calc-body">
        <div class="score-calc-fields" id="scoreCalcFields"></div>
      </div>
      <div class="score-calc-result" id="scoreCalcResult">
        <div class="score-result-display">
          <div class="score-result-value" id="scoreResultValue">0</div>
          <div class="score-result-max" id="scoreResultMax">of 10</div>
        </div>
        <div class="score-result-interpretation" id="scoreResultInterpretation">
          <div class="score-result-risk">Low Risk</div>
          <div class="score-result-action">Recommended action here</div>
        </div>
      </div>
      <div class="modal-footer" style="padding:12px 16px;gap:10px">
        <button class="btn btn-secondary" onclick="closeModal('scoreCalcModal')" style="flex:1">Close</button>
        <button class="btn btn-primary" id="saveScoreBtn" onclick="savePatientScore()" style="display:none;flex:1">💾 Save</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Drug Info Modal -->
<div class="modal" id="drugInfoModal">
<div class="modal-box wide">
<div class="modal-header">
  <div class="drug-info-badge"><span>✨</span> AI-Powered Analysis</div>
  <div class="modal-title drug-info-title" id="drugInfoTitle">Drug Name</div>
  <p class="drug-info-subtitle">Comprehensive drug information & patient-specific warnings</p>
</div>
<div class="modal-body" id="drugInfoBody">
  <div style="text-align:center;padding:40px">
    <div class="spinner"></div>
    <p style="margin-top:16px;color:var(--text-muted)">Analyzing drug information...</p>
  </div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('drugInfoModal')">Close</button>
<button class="btn btn-primary" id="drugAddToOrdersBtn" onclick="addDrugToOrders()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="vertical-align:-2px;margin-right:6px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add to Orders</button>
</div>
</div>
</div>

<!-- Drug Monograph Modal - Premium Clinical Design -->
<div id="modal-drug-monograph" class="modal">
    <div class="modal-content">
        
        <!-- Premium Header -->
        <div class="mono-header">
            <button class="mono-close" onclick="closeModal('modal-drug-monograph')">✕</button>
            <h1 id="mono-title" class="mono-title">Loading...</h1>
            <span id="mono-badge" class="mono-badge hidden">Checking...</span>
        </div>

        <!-- Body -->
        <div class="mono-body">

            <!-- Shimmer Loading Effect -->
            <div id="mono-loading">
                <div class="shimmer-line" style="width:100%; height:24px; margin-bottom:12px;"></div>
                <div class="shimmer-line" style="width:65%; height:20px; margin-bottom:24px;"></div>
                <div class="shimmer-line" style="width:100%; height:80px; margin-bottom:16px; border-radius:12px;"></div>
                <div class="shimmer-line" style="width:100%; height:80px; border-radius:12px;"></div>
            </div>

            <!-- Content Cards -->
            <div id="mono-content" class="hidden">

                <!-- Dosing Card -->
                <div class="pro-card">
                    <div class="pro-label">💊 Recommended Dosing</div>
                    <div id="mono-text-dose" class="dose-text"></div>

                    <!-- Renal Alert - Only Shows When Needed -->
                    <div id="mono-alert-renal" class="mono-alert-renal hidden">
                        <strong>⚠️ Renal Adjustment:</strong> <span id="mono-text-renal"></span>
                    </div>
                </div>

                <!-- Interactions Card -->
                <div class="pro-card">
                    <div class="pro-label">⚡ Interactions Check</div>
                    <div id="mono-text-ix" class="info-text"></div>
                </div>

                <!-- Clinical Pearls Card -->
                <div class="pro-card">
                    <div class="pro-label">🎯 Clinical Pearls</div>
                    <ul id="mono-list-pearls" class="pearl-list"></ul>
                </div>

            </div>
        </div>

        <!-- Footer Action -->
        <div class="mono-footer">
            <button class="btn btn-secondary" onclick="closeModal('modal-drug-monograph')">Close</button>
            <button class="btn btn-primary" onclick="confirmPrescribeFromMonograph()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="vertical-align:-2px;margin-right:6px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add to Orders
            </button>
        </div>

    </div>
</div>

<!-- Add Medication Modal - Premium -->
<div class="modal" id="addMedModal">
<div class="modal-box">
<div class="modal-header">
  <div class="med-modal-icon">💊</div>
  <div class="med-modal-title" id="addMedModalTitle">Add Medication</div>
  <p class="med-modal-subtitle">Enter medication details for this patient</p>
</div>
<div class="modal-body">
  <!-- Drug Name -->
  <div class="med-form-section">
    <div class="med-form-section-title"><span>💉</span> Drug Information</div>
    <div class="med-input-group">
      <label class="med-input-label">Drug Name <span class="required">*</span></label>
      <input type="text" class="med-input" id="medNameNew" placeholder="e.g., Metformin, Lisinopril">
    </div>
    <div class="med-form-row">
      <div class="med-input-group">
        <label class="med-input-label">Dose <span class="required">*</span></label>
        <input type="text" class="med-input" id="medDoseNew" placeholder="e.g., 500mg">
      </div>
      <div class="med-input-group">
        <label class="med-input-label">Generic Name</label>
        <input type="text" class="med-input" id="medGenericNew" placeholder="Optional">
      </div>
    </div>
  </div>
  
  <!-- Route -->
  <div class="med-form-section">
    <div class="med-form-section-title"><span>🎯</span> Route of Administration</div>
    <div class="med-pill-group" id="routePills">
      <button type="button" class="med-pill selected" data-route="PO">PO</button>
      <button type="button" class="med-pill" data-route="IV">IV</button>
      <button type="button" class="med-pill" data-route="IM">IM</button>
      <button type="button" class="med-pill" data-route="SC">SC</button>
      <button type="button" class="med-pill" data-route="INH">INH</button>
      <button type="button" class="med-pill" data-route="TOP">TOP</button>
      <button type="button" class="med-pill" data-route="SL">SL</button>
      <button type="button" class="med-pill" data-route="PR">PR</button>
    </div>
  </div>
  
  <!-- Frequency -->
  <div class="med-form-section">
    <div class="med-form-section-title"><span>🕐</span> Frequency</div>
    <div class="med-freq-grid" id="freqPills">
      <button type="button" class="med-freq-pill selected" data-freq="OD">
        <div class="med-freq-label">OD</div>
        <div class="med-freq-desc">Once daily</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="BD">
        <div class="med-freq-label">BD</div>
        <div class="med-freq-desc">Twice daily</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="TDS">
        <div class="med-freq-label">TDS</div>
        <div class="med-freq-desc">3× daily</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="QID">
        <div class="med-freq-label">QID</div>
        <div class="med-freq-desc">4× daily</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="Q6H">
        <div class="med-freq-label">Q6H</div>
        <div class="med-freq-desc">Every 6h</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="Q8H">
        <div class="med-freq-label">Q8H</div>
        <div class="med-freq-desc">Every 8h</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="Q12H">
        <div class="med-freq-label">Q12H</div>
        <div class="med-freq-desc">Every 12h</div>
      </button>
      <button type="button" class="med-freq-pill" data-freq="PRN">
        <div class="med-freq-label">PRN</div>
        <div class="med-freq-desc">As needed</div>
      </button>
    </div>
  </div>
  
  <!-- Clinical Details -->
  <div class="med-form-section">
    <div class="med-form-section-title"><span>📋</span> Clinical Details</div>
    <div class="med-input-group">
      <label class="med-input-label">Indication</label>
      <input type="text" class="med-input" id="medIndicationNew" placeholder="e.g., Type 2 Diabetes, Hypertension">
    </div>
    <div class="med-input-group">
      <label class="med-input-label">Status</label>
      <div class="med-status-group" id="statusPills">
        <button type="button" class="med-status-pill active selected" data-status="active">
          <span class="med-status-dot"></span>Active
        </button>
        <button type="button" class="med-status-pill new" data-status="new">
          <span class="med-status-dot"></span>New
        </button>
        <button type="button" class="med-status-pill prn" data-status="prn">
          <span class="med-status-dot"></span>PRN
        </button>
        <button type="button" class="med-status-pill discontinued" data-status="discontinued">
          <span class="med-status-dot"></span>Stopped
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" onclick="closeModal('addMedModal')">Cancel</button>
  <button class="btn btn-primary" onclick="saveMedicationNew()">Save Medication</button>
</div>
</div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="labFileInput" accept="image/*" multiple style="display:none">
<input type="file" id="medScanInput" accept="image/*" capture="environment" style="display:none">

<!-- Medication Scan Modal -->
<div class="modal" id="medScanModal">
<div class="modal-box">
<div class="modal-header">
  <div class="drug-info-badge"><span>📷</span> AI Medication Scanner</div>
  <div class="modal-title">Identify Medication</div>
  <p class="drug-info-subtitle">Point camera at pill bottle, blister pack, or box</p>
</div>
<div class="modal-body" id="medScanBody">
  <div style="text-align:center;padding:40px">
    <div class="spinner"></div>
    <p style="margin-top:16px;color:var(--text-muted)">Ready to scan...</p>
  </div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary btn-full" onclick="closeModal('medScanModal')">Close</button>
</div>
</div>
</div>

<!-- Lab Override Modal -->
<div class="modal" id="labOverrideModal">
<div class="modal-box">
<div class="modal-header"><div class="modal-title">✏️ Override Lab Value</div></div>
<div class="modal-body">
<div class="form-group">
  <label class="form-label" id="labOverrideName">Parameter</label>
  <input type="text" id="labOverrideValue" class="form-input mono" placeholder="Enter new value">
</div>
<input type="hidden" id="labOverrideParamIdx">
<input type="hidden" id="labOverrideValueIdx">
<p style="font-size:0.8rem;color:var(--text-muted);margin-top:12px">⚠️ This will override the extracted value. Manual changes are marked with ✏️</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('labOverrideModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveLabOverride()">Save Override</button>
</div>
</div>
</div>

<!-- Lab History Modal -->
<div class="modal" id="labHistoryModal">
<div class="modal-box" style="max-width:400px">
<div class="modal-header">
  <div class="modal-title" id="labHistoryTitle">📊 Lab History</div>
  <button class="btn-ghost" onclick="closeModal('labHistoryModal')" style="font-size:1.2rem"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div>
<div class="modal-body" style="padding:0;max-height:60vh;overflow-y:auto">
  <div id="labHistoryContent"></div>
</div>
<div class="modal-footer" style="justify-content:space-between">
  <button class="btn btn-secondary" onclick="closeModal('labHistoryModal')">Close</button>
  <button class="btn btn-primary" onclick="openLabOverrideFromHistory()">✏️ Edit Current</button>
</div>
</div>
</div>

<!-- Discharge Confirmation Modal -->
<div class="modal" id="dischargeModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div style="font-size:3rem;margin-bottom:12px">🏠</div>
<div class="modal-title">Discharge Patient</div>
</div>
<div class="modal-body">
<p style="text-align:center;color:var(--text-secondary);margin-bottom:20px">Are you sure you want to discharge <strong id="dischargePatientName"></strong>?</p>
<div class="form-group">
<label class="form-label">Discharge Summary (Optional)</label>
<textarea id="dischargeSummary" class="form-textarea" placeholder="Enter discharge notes, follow-up instructions..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('dischargeModal')">Cancel</button>
<button class="btn btn-success" onclick="confirmDischarge()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><polyline points="20 6 9 17 4 12"/></svg>Confirm Discharge</button>
</div>
</div>
</div>

<input type="file" id="labFileInputHidden" accept="image/*" multiple style="display:none">
<input type="file" id="imagingFileInput" accept="image/*" style="display:none">
<script>
(function(){
'use strict';

// ═══════════════════════════════════════════════════════════════════════════
// AUTHENTICATION GUARD - Redirect to login if not authenticated
// ═══════════════════════════════════════════════════════════════════════════
(function authGuard() {
  const user = sessionStorage.getItem('MW_USER') || localStorage.getItem('MW_USER');
  const pass = sessionStorage.getItem('MW_PASS') || localStorage.getItem('MW_PASS');
  if (!user || !pass) {
    console.log('⚠️ No credentials found - redirecting to login');
    window.location.href = 'login.html';
    return;
  }
})();

/* ═══════════════════════════════════════════════════════════════════════════
   MEDWARD PRO - JAVASCRIPT APPLICATION (LUXURY STANDARD)
   ═══════════════════════════════════════════════════════════════════════════
   
   TABLE OF CONTENTS:
   00. Prestige Icon Library (SVG)
   01. Configuration & Constants
   02. State Management
   03. Utility Functions
   04. API & Data Services
   05. UI Rendering
   06. Feature Modules
   07. Event Handlers
   08. Initialization
   
   ═══════════════════════════════════════════════════════════════════════════ */

// ═══════════════════════════════════════════════════════════════════════════
// 00. PRESTIGE ICON LIBRARY (Fine-Line SVG Icons)
// ═══════════════════════════════════════════════════════════════════════════
const ICONS = {
  // Navigation & Actions
  home: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
  menu: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>',
  search: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>',
  settings: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
  close: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  
  // CRUD Operations
  plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
  save: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
  check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
  
  // Medical / Clinical
  user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>',
  userPlus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
  activity: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  heart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
  
  // Labs & Science
  flask: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3h6v5l4 9a2 2 0 01-2 3H7a2 2 0 01-2-3l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>',
  microscope: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 100-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 01-2-2V6h6v4a2 2 0 01-2 2z"/><path d="M12 6V3a1 1 0 00-1-1H9a1 1 0 00-1 1v3"/></svg>',
  droplet: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/></svg>',
  thermometer: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/></svg>',
  
  // Medications
  pill: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 117 -7l7 7a4.95 4.95 0 11-7 7z"/><path d="M8.5 8.5l7 7"/></svg>',
  capsule: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 5.5l13 13a4.5 4.5 0 11-6.36 6.36L5.5 18.22V5.5z"/><path d="M18.5 5.5a4.5 4.5 0 010 6.36l-6.36-6.36a4.5 4.5 0 016.36 0z"/></svg>',
  
  // Documents & Files
  fileText: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
  clipboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
  folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>',
  upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
  download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  camera: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>',
  
  // Communication
  send: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
  share: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
  
  // Status & Alerts
  alertCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
  alertTriangle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  checkCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
  info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
  
  // UI Elements
  chevronRight: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
  chevronLeft: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>',
  chevronDown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
  chevronUp: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',
  moreVertical: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',
  moreHorizontal: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>',
  refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>',
  sync: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2 11.5a10 10 0 0118.8-4.3"/><path d="M22 12.5a10 10 0 01-18.8 4.3"/></svg>',
  filter: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
  
  // Theme
  sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
  moon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>',
  
  // Auth
  logout: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
  login: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>',
  
  // QR Code
  qrCode: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><rect x="18" y="14" width="3" height="3"/><rect x="14" y="18" width="3" height="3"/><rect x="18" y="18" width="3" height="3"/></svg>',
  scan: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M23 6V1H18"/><path d="M1 6V1H6"/><path d="M23 18V23H18"/><path d="M1 18V23H6"/><line x1="1" y1="12" x2="23" y2="12"/></svg>',
  
  // Building/Hospital
  building: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>',
  
  // Chart/Graph
  chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  trendUp: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
  trendDown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>',
  
  // Clock/Time
  clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  
  // Inbox
  inbox: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>',
  
  // Book/Reference
  book: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',
  
  // External Link
  externalLink: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
  
  // Hospital Cross
  cross: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2h8v8h6v8h-6v8H8v-8H2v-8h6V2z"/></svg>'
};

// Helper function to get icon HTML
function icon(name, className = '') {
  return ICONS[name] ? `<span class="icon ${className}">${ICONS[name]}</span>` : '';
}

// ═══════════════════════════════════════════════════════════════════════════
// 01. CONFIGURATION & CONSTANTS
// ═══════════════════════════════════════════════════════════════════════════
const CONFIG = {
  // ═══════════════════════════════════════════════════════════════════
  // APP METADATA
  // ═══════════════════════════════════════════════════════════════════
  VERSION: '17.1.0',
  BUILD_DATE: '2026-01-26',
  BUILD_ID: '2026-01-26.1-cloudfirst',  // ★ BUMP ON EVERY DEPLOY - triggers cache purge
  APP_NAME: 'MedWard Pro',
  
  // ═══════════════════════════════════════════════════════════════════
  // STORAGE KEYS
  // ═══════════════════════════════════════════════════════════════════
  STORAGE_KEY: 'medward_pro_v12',
  CACHE_KEY: 'MEDWARD_CACHE',  // Local-First Cache
  THEME_KEY: 'MEDWARD_THEME',
  ONBOARDING_KEY: 'medward_onboarding_v16',
  
  // ═══════════════════════════════════════════════════════════════════
  // ADMIN & SECURITY
  // ═══════════════════════════════════════════════════════════════════
  ADMIN_PASSWORD: 'admin123',
  
  // ═══════════════════════════════════════════════════════════════════
  // API CONFIGURATION
  // ═══════════════════════════════════════════════════════════════════
  API_URL: 'https://script.google.com/macros/s/AKfycbyVRA0E6by1lud8waH0Vu7HWuWKlwlOcnq3Qn2cNK3OaVZNrADyNczv0OuYdSq1SJBpZg/exec',
  FORMSUBMIT_URL: 'https://formsubmit.co/ajax/',
  
  // ═══════════════════════════════════════════════════════════════════
  // IMAGE PROCESSING
  // ═══════════════════════════════════════════════════════════════════
  MAX_IMAGE_SIZE: 1500000,
  IMAGE_QUALITY: 0.85,
  MAX_DIM: 2000,
  
  // ═══════════════════════════════════════════════════════════════════
  // NETWORK SETTINGS
  // ═══════════════════════════════════════════════════════════════════
  SYNC_DEBOUNCE_MS: 1500,
  FETCH_TIMEOUT_MS: 30000,
  MAX_RETRIES: 2,
  
  // ═══════════════════════════════════════════════════════════════════
  // CLOUD-FIRST BOOT SETTINGS
  // ═══════════════════════════════════════════════════════════════════
  CLOUD_BOOT_TIMEOUT_MS: 4000,   // Max wait for cloud on boot (then fallback to local)
  CACHE_WARM_DELAY_MS: 10000,    // Delay before writing local cache after cloud boot
  
  // ═══════════════════════════════════════════════════════════════════
  // CLINICAL SETTINGS
  // ═══════════════════════════════════════════════════════════════════
  VALID_WARDS: ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned'],
  LAB_CATEGORIES: {
    'Cardiac Markers': { icon: 'heart', terms: ['Troponin', 'BNP', 'proBNP', 'NT-proBNP', 'CK-MB', 'Myoglobin'] },
    'Renal Function': { icon: 'droplet', terms: ['Urea', 'Creatinine', 'Creat', 'eGFR', 'BUN'] },
    'Electrolytes': { icon: 'activity', terms: ['Na', 'Sodium', 'K', 'Potassium', 'Cl', 'Chloride', 'CO2', 'Bicarbonate', 'Mg', 'Magnesium', 'Ca', 'Calcium', 'Phosphate', 'Phos'] },
    'Glucose & Metabolic': { icon: 'thermometer', terms: ['Glucose', 'Gluc', 'FBG', 'RBG', 'HbA1c', 'Lactate'] },
    'Liver Function': { icon: 'flask', terms: ['ALT', 'AST', 'ALP', 'GGT', 'Bilirubin', 'Albumin', 'Total Protein'] },
    'Complete Blood Count': { icon: 'droplet', terms: ['Hgb', 'Hemoglobin', 'WBC', 'Platelets', 'RBC', 'MCV', 'Hct'] },
    'Other': { icon: 'microscope', terms: ['Urate', 'Uric Acid', 'Anion Gap', 'Osmolality', 'CRP', 'ESR', 'Procalcitonin'] }
  },
  
  // ═══════════════════════════════════════════════════════════════════
  // REQUIRED DOM ELEMENTS (for boot diagnostics)
  // ═══════════════════════════════════════════════════════════════════
  REQUIRED_ELEMENTS: ['dashboard', 'patientsList']
};

// ═══════════════════════════════════════════════════════════════════════════
// 🚨 BOOT MIGRATION SYSTEM - Purges stale cache on new builds
// ═══════════════════════════════════════════════════════════════════════════
// This runs SYNCHRONOUSLY before anything else to ensure fresh state

(async function bootMigration() {
  const BUILD_ID = CONFIG.BUILD_ID;
  const prevBuild = localStorage.getItem('MW_BUILD_ID');
  
  // ═══════════════════════════════════════════════════════════════════
  // HANDLE ?fresh=1 - User-triggered cache purge (safe mode boot)
  // ═══════════════════════════════════════════════════════════════════
  const url = new URL(location.href);
  if (url.searchParams.get('fresh') === '1') {
    console.log('🔄 Fresh start requested - purging all caches...');
    
    await purgeServiceWorkerAndCaches();
    
    // Clear local state (but NOT credentials)
    localStorage.removeItem(CONFIG.STORAGE_KEY);
    localStorage.removeItem(CONFIG.CACHE_KEY);
    localStorage.removeItem('MW_REV');
    localStorage.removeItem('MW_BUILD_ID');
    localStorage.removeItem('MW_DIRTY');
    
    // Remove ?fresh=1 and reload
    url.searchParams.delete('fresh');
    location.replace(url.toString());
    return; // Stop execution - page will reload
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // BUILD MISMATCH - Purge caches and reload with new build
  // ═══════════════════════════════════════════════════════════════════
  if (prevBuild && prevBuild !== BUILD_ID) {
    console.log('🔄 Build mismatch detected:', prevBuild, '→', BUILD_ID);
    console.log('   Purging Service Worker and Cache Storage...');
    
    await purgeServiceWorkerAndCaches();
    
    // Clear derived state (NOT patient data - that's in cloud)
    localStorage.removeItem('MW_REV');
    localStorage.removeItem('MW_DIRTY');
    // Keep STORAGE_KEY and CACHE_KEY - they have patient data
    // But mark them as potentially stale
    localStorage.setItem('MW_CACHE_STALE', '1');
    
    // Mark new build
    localStorage.setItem('MW_BUILD_ID', BUILD_ID);
    
    // Force reload with cache-bust
    url.searchParams.set('v', BUILD_ID);
    location.replace(url.toString());
    return; // Stop execution - page will reload
  }
  
  // First time or same build - just mark it
  if (!prevBuild) {
    localStorage.setItem('MW_BUILD_ID', BUILD_ID);
    console.log('📱 First boot - Build ID:', BUILD_ID);
  } else {
    console.log('✅ Build ID matches:', BUILD_ID);
  }
})();

// ═══════════════════════════════════════════════════════════════════════════
// SERVICE WORKER & CACHE PURGE - Nuclear option for stale assets
// ═══════════════════════════════════════════════════════════════════════════

async function purgeServiceWorkerAndCaches() {
  // Unregister ALL service workers
  if ('serviceWorker' in navigator) {
    try {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
        console.log('   ✅ Unregistered SW:', registration.scope);
      }
    } catch (e) {
      console.warn('   ⚠️ SW unregister failed:', e);
    }
  }
  
  // Clear ALL Cache Storage
  if (window.caches?.keys) {
    try {
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => {
        console.log('   ✅ Deleted cache:', name);
        return caches.delete(name);
      }));
    } catch (e) {
      console.warn('   ⚠️ Cache clear failed:', e);
    }
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// BOOT DIAGNOSTICS - Validates app configuration and DOM before initialization
// ═══════════════════════════════════════════════════════════════════════════
const Diagnostics = {
  errors: [],
  warnings: [],
  
  run() {
    this.errors = [];
    this.warnings = [];
    
    // Check CONFIG
    if (!CONFIG.API_URL || CONFIG.API_URL === 'YOUR_API_URL_HERE') {
      this.warnings.push('API URL not configured - cloud sync disabled');
    }
    
    // Check required DOM elements
    CONFIG.REQUIRED_ELEMENTS.forEach(id => {
      if (!document.getElementById(id)) {
        this.errors.push(`Required element #${id} not found`);
      }
    });
    
    // Check localStorage availability
    try {
      localStorage.setItem('__test__', '1');
      localStorage.removeItem('__test__');
    } catch (e) {
      this.warnings.push('localStorage unavailable - data will not persist');
    }
    
    // Check network
    if (!navigator.onLine) {
      this.warnings.push('Offline - cloud features unavailable');
    }
    
    // Log results
    if (this.errors.length > 0) {
      console.error('🚨 BOOT ERRORS:', this.errors);
    }
    if (this.warnings.length > 0) {
      console.warn('⚠️ BOOT WARNINGS:', this.warnings);
    }
    if (this.errors.length === 0 && this.warnings.length === 0) {
      console.log(`✅ ${CONFIG.APP_NAME} v${CONFIG.VERSION} booted successfully`);
    }
    
    return this.errors.length === 0;
  },
  
  // Developer mode panel (accessed via ?debug=1)
  showDebugPanel() {
    if (!new URLSearchParams(window.location.search).has('debug')) return;

    // Get last error from session storage if available
    let lastError = null;
    try {
      const errorStr = sessionStorage.getItem('MW_LAST_ERROR');
      if (errorStr) lastError = JSON.parse(errorStr);
    } catch (e) {}

    const panel = document.createElement('div');
    panel.id = 'debugPanel';
    panel.style.cssText = 'position:fixed;bottom:70px;right:10px;background:#1e293b;color:#f8fafc;padding:16px;border-radius:12px;font-size:12px;font-family:monospace;max-width:400px;max-height:600px;overflow-y:auto;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,0.3)';
    panel.innerHTML = `
      <div style="font-weight:bold;margin-bottom:8px;color:#60a5fa">🔧 Debug Panel</div>
      <div>Version: ${CONFIG.VERSION}</div>
      <div>Build: ${CONFIG.BUILD_DATE}</div>
      <div>API: ${CONFIG.API_URL ? '✅ Configured' : '❌ Missing'}</div>
      <div>Storage: ${localStorage.getItem(CONFIG.STORAGE_KEY) ? '✅ Has data' : '⚪ Empty'}</div>
      <div>Theme: ${localStorage.getItem(CONFIG.THEME_KEY) || 'system'}</div>
      <div>Online: ${navigator.onLine ? '✅' : '❌'}</div>
      <div>Cloud Verified: ${localStorage.getItem('MW_CLOUD_VERIFIED') ? '✅' : '❌'}</div>
      <div>Offline Mode: ${localStorage.getItem('MW_OFFLINE_MODE') === 'true' ? '✅ Yes' : '❌ No'}</div>
      <div>Sync Read-Only: ${typeof sync !== 'undefined' ? (sync.isReadOnly ? '⚠️ Yes' : '✅ No') : 'N/A'}</div>
      <div>Sync Hydrated: ${typeof sync !== 'undefined' ? (sync.isHydrated ? '✅' : '❌') : 'N/A'}</div>
      <div>Cloud Loaded: ${typeof sync !== 'undefined' ? (sync.cloudLoaded ? '✅' : '❌') : 'N/A'}</div>
      ${lastError ? `<div style="color:#fca5a5;margin-top:8px;padding:8px;background:#991b1b;border-radius:4px">
        <div style="font-weight:bold">Last Error:</div>
        <div>${lastError.name}: ${lastError.message}</div>
        <div style="font-size:10px;opacity:0.8;margin-top:4px">${lastError.timestamp}</div>
      </div>` : ''}
      ${this.errors.length ? `<div style="color:#fca5a5;margin-top:8px">Errors: ${this.errors.join(', ')}</div>` : ''}
      ${this.warnings.length ? `<div style="color:#fcd34d;margin-top:4px">Warnings: ${this.warnings.join(', ')}</div>` : ''}
      <div id="debugTestResult" style="margin-top:8px;display:none;padding:8px;background:#334155;border-radius:4px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
        <button onclick="testGoogleScript()" style="padding:6px 12px;background:#059669;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:11px">Test Script</button>
        <button onclick="showErrorLog()" style="padding:6px 12px;background:#d97706;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:11px">Error Log</button>
        <button onclick="navigator.clipboard.writeText(JSON.stringify(Diagnostics,null,2))" style="padding:6px 12px;background:#3b82f6;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:11px">Copy Info</button>
        <button onclick="this.parentElement.parentElement.remove()" style="padding:6px 12px;background:#334155;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:11px">Close</button>
      </div>
    `;
    document.body.appendChild(panel);

    // Add test function to window
    window.testGoogleScript = async function() {
      const resultDiv = document.getElementById('debugTestResult');
      if (!resultDiv) return;

      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '⏳ Testing Google Script connection...';

      try {
        const AUTH = {
          user: sessionStorage.getItem('MW_USER') || localStorage.getItem('MW_USER'),
          pass: sessionStorage.getItem('MW_PASS') || localStorage.getItem('MW_PASS')
        };

        const startTime = Date.now();
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          cache: 'no-store',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: 'ping',
            username: AUTH.user,
            password: AUTH.pass
          })
        });

        const elapsed = Date.now() - startTime;
        const text = await response.text();

        console.log('🔍 Test Response:', {
          status: response.status,
          statusText: response.statusText,
          elapsed: elapsed + 'ms',
          responseLength: text.length,
          responsePreview: text.substring(0, 200)
        });

        if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
          resultDiv.innerHTML = `<div style="color:#fca5a5">❌ Script returned HTML (not deployed correctly)</div><div style="font-size:10px;margin-top:4px;opacity:0.8">Time: ${elapsed}ms</div>`;
          return;
        }

        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          resultDiv.innerHTML = `<div style="color:#fca5a5">❌ Invalid JSON response</div><div style="font-size:10px;margin-top:4px">${text.substring(0, 100)}</div>`;
          return;
        }

        if (result.success) {
          resultDiv.innerHTML = `<div style="color:#6ee7b7">✅ Script is working!</div><div style="font-size:10px;margin-top:4px;opacity:0.8">Time: ${elapsed}ms</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color:#fca5a5">❌ ${result.error || 'Unknown error'}</div><div style="font-size:10px;margin-top:4px;opacity:0.8">Time: ${elapsed}ms</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div style="color:#fca5a5">❌ ${error.message}</div><div style="font-size:10px;margin-top:4px">${error.name}</div>`;
      }
    };

    window.showErrorLog = function() {
      const lastResponse = sessionStorage.getItem('MW_LAST_RESPONSE');
      const lastError = sessionStorage.getItem('MW_LAST_ERROR');
      console.group('📋 Error Log');
      console.log('Last Error:', lastError ? JSON.parse(lastError) : 'None');
      console.log('Last Response:', lastResponse || 'None');
      console.groupEnd();
      alert('Error log printed to console (F12)');
    };
  }
};

// ═══════════════════════════════════════════════════════════════════════════
// CLINICAL SCORING SYSTEMS
// ═══════════════════════════════════════════════════════════════════════════
  
// Patient-specific scores - appear in patient profile based on diagnosis
const PATIENT_SCORES = {
    // Cardiac
    'heart failure': ['NYHA', 'MAGGIC', 'H2FPEF', 'HFA-PEFF'],
    'hf': ['NYHA', 'MAGGIC', 'H2FPEF', 'HFA-PEFF'],
    'chf': ['NYHA', 'MAGGIC', 'H2FPEF', 'HFA-PEFF'],
    'atrial fibrillation': ['CHA2DS2-VASc', 'HAS-BLED', 'EHRA'],
    'af': ['CHA2DS2-VASc', 'HAS-BLED', 'EHRA'],
    'afib': ['CHA2DS2-VASc', 'HAS-BLED', 'EHRA'],
    'acs': ['TIMI', 'GRACE', 'HEART', 'Killip'],
    'stemi': ['TIMI', 'Killip', 'GRACE'],
    'nstemi': ['TIMI', 'GRACE', 'HEART'],
    'unstable angina': ['TIMI', 'HEART'],
    'chest pain': ['HEART', 'TIMI', 'Wells-PE'],
    'mi': ['TIMI', 'GRACE', 'Killip'],
    
    // Respiratory
    'pneumonia': ['CURB-65', 'PSI', 'A-DROP'],
    'cap': ['CURB-65', 'PSI'],
    'copd': ['GOLD', 'BODE', 'mMRC'],
    'copd exacerbation': ['GOLD', 'DECAF', 'BAP-65'],
    'asthma': ['GINA', 'Asthma-Control'],
    'pe': ['Wells-PE', 'Geneva', 'PESI', 'sPESI'],
    'pulmonary embolism': ['Wells-PE', 'Geneva', 'PESI', 'sPESI'],
    
    // Neurological
    'stroke': ['NIHSS', 'mRS', 'ABCD2', 'ICH'],
    'cva': ['NIHSS', 'mRS', 'ABCD2'],
    'tia': ['ABCD2', 'mRS'],
    'ich': ['ICH', 'FUNC'],
    'seizure': ['ILAE', 'Status-Epilepticus'],
    
    // GI/Hepatic
    'gi bleed': ['Glasgow-Blatchford', 'Rockall', 'AIMS65'],
    'gib': ['Glasgow-Blatchford', 'Rockall', 'AIMS65'],
    'upper gi bleed': ['Glasgow-Blatchford', 'Rockall', 'AIMS65'],
    'cirrhosis': ['Child-Pugh', 'MELD', 'MELD-Na'],
    'liver failure': ['Child-Pugh', 'MELD', 'MELD-Na', 'CLIF-SOFA'],
    'hepatic encephalopathy': ['West-Haven', 'Child-Pugh'],
    'pancreatitis': ['Ranson', 'BISAP', 'Atlanta'],
    'acute pancreatitis': ['Ranson', 'BISAP', 'APACHE-II'],
    
    // Renal
    'aki': ['KDIGO-AKI', 'RIFLE', 'AKIN'],
    'acute kidney injury': ['KDIGO-AKI', 'RIFLE', 'AKIN'],
    'ckd': ['KDIGO-CKD', 'eGFR-Stage'],
    
    // Infectious
    'sepsis': ['qSOFA', 'SOFA', 'NEWS2', 'SIRS'],
    'septic shock': ['SOFA', 'APACHE-II', 'NEWS2'],
    'meningitis': ['Glasgow-Coma', 'LAMP'],
    'endocarditis': ['Duke', 'HACEK'],
    
    // Critical Care
    'icu': ['APACHE-II', 'SOFA', 'SAPS-II', 'NEWS2'],
    'critical': ['APACHE-II', 'SOFA', 'NEWS2', 'Glasgow-Coma'],
    'intubated': ['RSBI', 'APACHE-II'],
    'ventilator': ['RSBI', 'P/F-Ratio'],
    
    // Surgical/Trauma
    'surgery': ['ASA', 'Caprini', 'RCRI'],
    'post-op': ['ASA', 'Caprini', 'Surgical-Apgar'],
    'trauma': ['ISS', 'RTS', 'GCS'],
    'fall': ['Morse-Fall', 'STRATIFY'],
    'fracture': ['FRAX', 'Caprini'],
    
    // VTE
    'dvt': ['Wells-DVT', 'Caprini', 'Padua'],
    'deep vein thrombosis': ['Wells-DVT', 'Caprini'],
    'vte': ['Caprini', 'Padua', 'Wells-DVT'],
    
    // Diabetes
    'dka': ['DKA-Severity', 'Anion-Gap'],
    'diabetic ketoacidosis': ['DKA-Severity', 'Anion-Gap'],
    'hhs': ['HHS-Severity', 'Osmolality'],
    'diabetes': ['HbA1c-Control', 'UKPDS']
};

// Complete scoring calculators with formulas
const SCORING_CALCULATORS = {
    // ═══ CARDIAC SCORES ═══
    'CHA2DS2-VASc': {
      name: 'CHA₂DS₂-VASc Score',
      category: 'Cardiac',
      purpose: 'Stroke risk in atrial fibrillation',
      fields: [
        { id: 'chf', label: 'CHF/LV dysfunction', points: 1, type: 'checkbox' },
        { id: 'htn', label: 'Hypertension', points: 1, type: 'checkbox' },
        { id: 'age75', label: 'Age ≥75', points: 2, type: 'checkbox' },
        { id: 'dm', label: 'Diabetes mellitus', points: 1, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke/TIA/thromboembolism', points: 2, type: 'checkbox' },
        { id: 'vascular', label: 'Vascular disease (MI, PAD, aortic plaque)', points: 1, type: 'checkbox' },
        { id: 'age65', label: 'Age 65-74', points: 1, type: 'checkbox' },
        { id: 'female', label: 'Sex category (female)', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Low', action: 'No anticoagulation (or ASA)', color: '#10b981', annual: '0%' },
        { min: 1, max: 1, risk: 'Low-Moderate', action: 'Consider anticoagulation', color: '#f59e0b', annual: '1.3%' },
        { min: 2, max: 9, risk: 'Moderate-High', action: 'Anticoagulation recommended', color: '#ef4444', annual: '≥2.2%' }
      ]
    },
    
    'HAS-BLED': {
      name: 'HAS-BLED Score',
      category: 'Cardiac',
      purpose: 'Bleeding risk on anticoagulation',
      fields: [
        { id: 'htn', label: 'Hypertension (SBP >160)', points: 1, type: 'checkbox' },
        { id: 'renal', label: 'Abnormal renal function', points: 1, type: 'checkbox' },
        { id: 'liver', label: 'Abnormal liver function', points: 1, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke history', points: 1, type: 'checkbox' },
        { id: 'bleeding', label: 'Bleeding history/predisposition', points: 1, type: 'checkbox' },
        { id: 'inr', label: 'Labile INR (if on warfarin)', points: 1, type: 'checkbox' },
        { id: 'elderly', label: 'Elderly (>65)', points: 1, type: 'checkbox' },
        { id: 'drugs', label: 'Drugs (antiplatelets, NSAIDs)', points: 1, type: 'checkbox' },
        { id: 'alcohol', label: 'Alcohol excess', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 2, risk: 'Low', action: 'Anticoagulation generally safe', color: '#10b981', annual: '1-2%' },
        { min: 3, max: 9, risk: 'High', action: 'Caution - address modifiable risks', color: '#ef4444', annual: '≥3.7%' }
      ]
    },
    
    'HEART': {
      name: 'HEART Score',
      category: 'Cardiac',
      purpose: 'Risk stratification for chest pain',
      fields: [
        { id: 'history', label: 'History', type: 'select', options: [
          { value: 0, label: 'Slightly suspicious' },
          { value: 1, label: 'Moderately suspicious' },
          { value: 2, label: 'Highly suspicious' }
        ]},
        { id: 'ecg', label: 'ECG', type: 'select', options: [
          { value: 0, label: 'Normal' },
          { value: 1, label: 'Non-specific repolarization' },
          { value: 2, label: 'Significant ST deviation' }
        ]},
        { id: 'age', label: 'Age', type: 'select', options: [
          { value: 0, label: '<45 years' },
          { value: 1, label: '45-64 years' },
          { value: 2, label: '≥65 years' }
        ]},
        { id: 'risk', label: 'Risk Factors', type: 'select', options: [
          { value: 0, label: 'No known risk factors' },
          { value: 1, label: '1-2 risk factors' },
          { value: 2, label: '≥3 risk factors or known CAD' }
        ]},
        { id: 'troponin', label: 'Initial Troponin', type: 'select', options: [
          { value: 0, label: '≤ normal limit' },
          { value: 1, label: '1-3x normal limit' },
          { value: 2, label: '>3x normal limit' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 3, risk: 'Low', action: 'Consider discharge with outpatient follow-up', color: '#10b981', mace: '0.9-1.7%' },
        { min: 4, max: 6, risk: 'Intermediate', action: 'Admit for observation and serial troponins', color: '#f59e0b', mace: '12-16.6%' },
        { min: 7, max: 10, risk: 'High', action: 'Early invasive strategy recommended', color: '#ef4444', mace: '50-65%' }
      ]
    },
    
    'TIMI': {
      name: 'TIMI Risk Score (NSTEMI)',
      category: 'Cardiac',
      purpose: 'Risk stratification for NSTEMI/UA',
      fields: [
        { id: 'age', label: 'Age ≥65', points: 1, type: 'checkbox' },
        { id: 'cad', label: '≥3 CAD risk factors', points: 1, type: 'checkbox' },
        { id: 'known_cad', label: 'Known CAD (stenosis ≥50%)', points: 1, type: 'checkbox' },
        { id: 'asa', label: 'ASA use in past 7 days', points: 1, type: 'checkbox' },
        { id: 'angina', label: '≥2 angina episodes in 24h', points: 1, type: 'checkbox' },
        { id: 'ecg', label: 'ST changes ≥0.5mm', points: 1, type: 'checkbox' },
        { id: 'biomarker', label: 'Elevated cardiac biomarkers', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 2, risk: 'Low', action: 'Conservative management may be appropriate', color: '#10b981', events: '4.7-8.3%' },
        { min: 3, max: 4, risk: 'Intermediate', action: 'Consider early invasive strategy', color: '#f59e0b', events: '13.2-19.9%' },
        { min: 5, max: 7, risk: 'High', action: 'Early invasive strategy strongly recommended', color: '#ef4444', events: '26.2-40.9%' }
      ]
    },
    
    'Killip': {
      name: 'Killip Classification',
      category: 'Cardiac',
      purpose: 'Heart failure severity in MI',
      fields: [
        { id: 'class', label: 'Clinical Findings', type: 'select', options: [
          { value: 1, label: 'Class I: No heart failure signs' },
          { value: 2, label: 'Class II: S3, rales <50% lung fields' },
          { value: 3, label: 'Class III: Pulmonary edema, rales >50%' },
          { value: 4, label: 'Class IV: Cardiogenic shock' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'Class I', action: 'Standard care', color: '#10b981', mortality: '6%' },
        { min: 2, max: 2, risk: 'Class II', action: 'Monitor closely, diuretics PRN', color: '#f59e0b', mortality: '17%' },
        { min: 3, max: 3, risk: 'Class III', action: 'ICU, aggressive treatment', color: '#ef4444', mortality: '38%' },
        { min: 4, max: 4, risk: 'Class IV', action: 'ICU, vasopressors, consider MCS', color: '#7f1d1d', mortality: '81%' }
      ]
    },
    
    'NYHA': {
      name: 'NYHA Functional Classification',
      category: 'Cardiac',
      purpose: 'Heart failure functional capacity',
      fields: [
        { id: 'class', label: 'Functional Limitation', type: 'select', options: [
          { value: 1, label: 'Class I: No limitation of physical activity' },
          { value: 2, label: 'Class II: Slight limitation; comfortable at rest' },
          { value: 3, label: 'Class III: Marked limitation; comfortable only at rest' },
          { value: 4, label: 'Class IV: Unable to carry on any activity without symptoms' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'Class I', action: 'Standard GDMT', color: '#10b981', mortality: '5-10%/yr' },
        { min: 2, max: 2, risk: 'Class II', action: 'GDMT optimization', color: '#22c55e', mortality: '10-15%/yr' },
        { min: 3, max: 3, risk: 'Class III', action: 'Consider device therapy', color: '#f59e0b', mortality: '15-25%/yr' },
        { min: 4, max: 4, risk: 'Class IV', action: 'Advanced therapies, transplant evaluation', color: '#ef4444', mortality: '50-75%/yr' }
      ]
    },
    
    // ═══ RESPIRATORY SCORES ═══
    'CURB-65': {
      name: 'CURB-65 Score',
      category: 'Respiratory',
      purpose: 'Pneumonia severity assessment',
      fields: [
        { id: 'confusion', label: 'Confusion (new onset)', points: 1, type: 'checkbox' },
        { id: 'urea', label: 'Urea >7 mmol/L (BUN >19)', points: 1, type: 'checkbox' },
        { id: 'rr', label: 'Respiratory rate ≥30/min', points: 1, type: 'checkbox' },
        { id: 'bp', label: 'BP: SBP <90 or DBP ≤60', points: 1, type: 'checkbox' },
        { id: 'age', label: 'Age ≥65 years', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'Consider outpatient treatment', color: '#10b981', mortality: '0.6-2.7%' },
        { min: 2, max: 2, risk: 'Moderate', action: 'Consider short hospitalization or close outpatient follow-up', color: '#f59e0b', mortality: '6.8%' },
        { min: 3, max: 5, risk: 'Severe', action: 'Hospitalize; consider ICU if score 4-5', color: '#ef4444', mortality: '14-27.8%' }
      ]
    },
    
    'Wells-PE': {
      name: 'Wells Score for PE',
      category: 'Respiratory',
      purpose: 'Pulmonary embolism probability',
      fields: [
        { id: 'dvt', label: 'Clinical signs/symptoms of DVT', points: 3, type: 'checkbox' },
        { id: 'alternative', label: 'PE is #1 diagnosis OR equally likely', points: 3, type: 'checkbox' },
        { id: 'hr', label: 'Heart rate >100', points: 1.5, type: 'checkbox' },
        { id: 'immobile', label: 'Immobilization ≥3 days or surgery in past 4 weeks', points: 1.5, type: 'checkbox' },
        { id: 'prior', label: 'Previous PE or DVT', points: 1.5, type: 'checkbox' },
        { id: 'hemoptysis', label: 'Hemoptysis', points: 1, type: 'checkbox' },
        { id: 'malignancy', label: 'Malignancy (treatment within 6 months)', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'D-dimer; if negative, PE excluded', color: '#10b981', probability: '1.3%' },
        { min: 2, max: 6, risk: 'Moderate', action: 'D-dimer; if positive, CTPA', color: '#f59e0b', probability: '16.2%' },
        { min: 7, max: 12.5, risk: 'High', action: 'CTPA recommended', color: '#ef4444', probability: '37.5%' }
      ]
    },
    
    'Wells-DVT': {
      name: 'Wells Score for DVT',
      category: 'Vascular',
      purpose: 'Deep vein thrombosis probability',
      fields: [
        { id: 'cancer', label: 'Active cancer', points: 1, type: 'checkbox' },
        { id: 'paralysis', label: 'Paralysis/paresis/recent cast', points: 1, type: 'checkbox' },
        { id: 'bedridden', label: 'Bedridden >3 days or major surgery <12 weeks', points: 1, type: 'checkbox' },
        { id: 'tenderness', label: 'Localized tenderness along deep veins', points: 1, type: 'checkbox' },
        { id: 'swelling', label: 'Entire leg swollen', points: 1, type: 'checkbox' },
        { id: 'calf', label: 'Calf swelling >3 cm vs other leg', points: 1, type: 'checkbox' },
        { id: 'edema', label: 'Pitting edema (symptomatic leg only)', points: 1, type: 'checkbox' },
        { id: 'collateral', label: 'Collateral superficial veins', points: 1, type: 'checkbox' },
        { id: 'prior', label: 'Previously documented DVT', points: 1, type: 'checkbox' },
        { id: 'alternative', label: 'Alternative diagnosis as likely as DVT', points: -2, type: 'checkbox' }
      ],
      interpretation: [
        { min: -2, max: 0, risk: 'Low', action: 'D-dimer; if negative, DVT excluded', color: '#10b981', probability: '5%' },
        { min: 1, max: 2, risk: 'Moderate', action: 'D-dimer; if positive, ultrasound', color: '#f59e0b', probability: '17%' },
        { min: 3, max: 9, risk: 'High', action: 'Ultrasound recommended', color: '#ef4444', probability: '53%' }
      ]
    },
    
    'PESI': {
      name: 'PESI Score (Simplified)',
      category: 'Respiratory',
      purpose: 'PE mortality risk stratification',
      fields: [
        { id: 'age', label: 'Age >80 years', points: 1, type: 'checkbox' },
        { id: 'cancer', label: 'History of cancer', points: 1, type: 'checkbox' },
        { id: 'chf', label: 'Chronic cardiopulmonary disease', points: 1, type: 'checkbox' },
        { id: 'hr', label: 'Heart rate ≥110', points: 1, type: 'checkbox' },
        { id: 'sbp', label: 'SBP <100 mmHg', points: 1, type: 'checkbox' },
        { id: 'sao2', label: 'O₂ saturation <90%', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Low', action: 'Consider outpatient treatment', color: '#10b981', mortality: '1.0%' },
        { min: 1, max: 6, risk: 'High', action: 'Hospitalization recommended', color: '#ef4444', mortality: '10.9%' }
      ]
    },
    
    // ═══ NEUROLOGICAL SCORES ═══
    'Glasgow-Coma': {
      name: 'Glasgow Coma Scale',
      category: 'Neurological',
      purpose: 'Level of consciousness assessment',
      fields: [
        { id: 'eye', label: 'Eye Opening', type: 'select', options: [
          { value: 1, label: '1 - No response' },
          { value: 2, label: '2 - To pain' },
          { value: 3, label: '3 - To voice' },
          { value: 4, label: '4 - Spontaneous' }
        ]},
        { id: 'verbal', label: 'Verbal Response', type: 'select', options: [
          { value: 1, label: '1 - No response' },
          { value: 2, label: '2 - Incomprehensible sounds' },
          { value: 3, label: '3 - Inappropriate words' },
          { value: 4, label: '4 - Confused' },
          { value: 5, label: '5 - Oriented' }
        ]},
        { id: 'motor', label: 'Motor Response', type: 'select', options: [
          { value: 1, label: '1 - No response' },
          { value: 2, label: '2 - Extension to pain' },
          { value: 3, label: '3 - Flexion to pain' },
          { value: 4, label: '4 - Withdrawal from pain' },
          { value: 5, label: '5 - Localizes pain' },
          { value: 6, label: '6 - Obeys commands' }
        ]}
      ],
      interpretation: [
        { min: 3, max: 8, risk: 'Severe', action: 'Intubation usually indicated', color: '#ef4444', note: 'Coma' },
        { min: 9, max: 12, risk: 'Moderate', action: 'Close monitoring required', color: '#f59e0b', note: 'Impaired' },
        { min: 13, max: 15, risk: 'Minor', action: 'Generally good prognosis', color: '#10b981', note: 'Minor injury' }
      ]
    },
    
    'NIHSS': {
      name: 'NIH Stroke Scale',
      category: 'Neurological',
      purpose: 'Stroke severity assessment',
      fields: [
        { id: 'loc', label: '1a. Level of Consciousness', type: 'select', options: [
          { value: 0, label: '0 - Alert' },
          { value: 1, label: '1 - Not alert, arousable' },
          { value: 2, label: '2 - Not alert, requires repeated stimulation' },
          { value: 3, label: '3 - Unresponsive' }
        ]},
        { id: 'loc_q', label: '1b. LOC Questions (month, age)', type: 'select', options: [
          { value: 0, label: '0 - Both correct' },
          { value: 1, label: '1 - One correct' },
          { value: 2, label: '2 - Neither correct' }
        ]},
        { id: 'loc_c', label: '1c. LOC Commands (open/close eyes, grip)', type: 'select', options: [
          { value: 0, label: '0 - Both correct' },
          { value: 1, label: '1 - One correct' },
          { value: 2, label: '2 - Neither correct' }
        ]},
        { id: 'gaze', label: '2. Best Gaze', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Partial gaze palsy' },
          { value: 2, label: '2 - Forced deviation' }
        ]},
        { id: 'visual', label: '3. Visual Fields', type: 'select', options: [
          { value: 0, label: '0 - No visual loss' },
          { value: 1, label: '1 - Partial hemianopia' },
          { value: 2, label: '2 - Complete hemianopia' },
          { value: 3, label: '3 - Bilateral hemianopia' }
        ]},
        { id: 'facial', label: '4. Facial Palsy', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Minor paralysis' },
          { value: 2, label: '2 - Partial paralysis' },
          { value: 3, label: '3 - Complete paralysis' }
        ]},
        { id: 'motor_arm', label: '5. Motor Arm (worse side)', type: 'select', options: [
          { value: 0, label: '0 - No drift' },
          { value: 1, label: '1 - Drift before 10 seconds' },
          { value: 2, label: '2 - Falls before 10 seconds' },
          { value: 3, label: '3 - No effort against gravity' },
          { value: 4, label: '4 - No movement' }
        ]},
        { id: 'motor_leg', label: '6. Motor Leg (worse side)', type: 'select', options: [
          { value: 0, label: '0 - No drift' },
          { value: 1, label: '1 - Drift before 5 seconds' },
          { value: 2, label: '2 - Falls before 5 seconds' },
          { value: 3, label: '3 - No effort against gravity' },
          { value: 4, label: '4 - No movement' }
        ]},
        { id: 'ataxia', label: '7. Limb Ataxia', type: 'select', options: [
          { value: 0, label: '0 - Absent' },
          { value: 1, label: '1 - Present in one limb' },
          { value: 2, label: '2 - Present in two limbs' }
        ]},
        { id: 'sensory', label: '8. Sensory', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Mild-moderate loss' },
          { value: 2, label: '2 - Severe or total loss' }
        ]},
        { id: 'language', label: '9. Best Language', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Mild-moderate aphasia' },
          { value: 2, label: '2 - Severe aphasia' },
          { value: 3, label: '3 - Mute/global aphasia' }
        ]},
        { id: 'dysarthria', label: '10. Dysarthria', type: 'select', options: [
          { value: 0, label: '0 - Normal' },
          { value: 1, label: '1 - Mild-moderate' },
          { value: 2, label: '2 - Severe/unintelligible' }
        ]},
        { id: 'neglect', label: '11. Extinction/Neglect', type: 'select', options: [
          { value: 0, label: '0 - No abnormality' },
          { value: 1, label: '1 - Mild (one modality)' },
          { value: 2, label: '2 - Severe (more than one modality)' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 4, risk: 'Minor', action: 'May not benefit from thrombolysis', color: '#10b981', outcome: 'Good' },
        { min: 5, max: 15, risk: 'Moderate', action: 'Consider thrombolysis if eligible', color: '#f59e0b', outcome: 'Variable' },
        { min: 16, max: 20, risk: 'Moderate-Severe', action: 'Thrombolysis if eligible; higher hemorrhage risk', color: '#f97316', outcome: 'Guarded' },
        { min: 21, max: 42, risk: 'Severe', action: 'Poor prognosis; discuss goals of care', color: '#ef4444', outcome: 'Poor' }
      ]
    },
    
    'ABCD2': {
      name: 'ABCD² Score',
      category: 'Neurological',
      purpose: 'Stroke risk after TIA',
      fields: [
        { id: 'age', label: 'Age ≥60 years', points: 1, type: 'checkbox' },
        { id: 'bp', label: 'BP ≥140/90 mmHg', points: 1, type: 'checkbox' },
        { id: 'weakness', label: 'Unilateral weakness', points: 2, type: 'checkbox' },
        { id: 'speech', label: 'Speech impairment without weakness', points: 1, type: 'checkbox' },
        { id: 'duration60', label: 'Duration ≥60 min', points: 2, type: 'checkbox' },
        { id: 'duration10', label: 'Duration 10-59 min', points: 1, type: 'checkbox' },
        { id: 'dm', label: 'Diabetes', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 3, risk: 'Low', action: 'Outpatient workup may be appropriate', color: '#10b981', stroke_2d: '1.0%' },
        { min: 4, max: 5, risk: 'Moderate', action: 'Consider hospitalization', color: '#f59e0b', stroke_2d: '4.1%' },
        { min: 6, max: 7, risk: 'High', action: 'Hospitalization recommended', color: '#ef4444', stroke_2d: '8.1%' }
      ]
    },
    
    // ═══ GI/HEPATIC SCORES ═══
    'Glasgow-Blatchford': {
      name: 'Glasgow-Blatchford Score',
      category: 'GI',
      purpose: 'Upper GI bleed risk stratification',
      fields: [
        { id: 'bun', label: 'BUN (mmol/L)', type: 'select', options: [
          { value: 0, label: '<6.5' },
          { value: 2, label: '6.5-7.9' },
          { value: 3, label: '8.0-9.9' },
          { value: 4, label: '10.0-24.9' },
          { value: 6, label: '≥25' }
        ]},
        { id: 'hgb_male', label: 'Hemoglobin - Male (g/dL)', type: 'select', options: [
          { value: 0, label: '≥13' },
          { value: 1, label: '12.0-12.9' },
          { value: 3, label: '10.0-11.9' },
          { value: 6, label: '<10' }
        ]},
        { id: 'hgb_female', label: 'Hemoglobin - Female (g/dL)', type: 'select', options: [
          { value: 0, label: '≥12' },
          { value: 1, label: '10.0-11.9' },
          { value: 6, label: '<10' }
        ]},
        { id: 'sbp', label: 'Systolic BP', type: 'select', options: [
          { value: 0, label: '≥110' },
          { value: 1, label: '100-109' },
          { value: 2, label: '90-99' },
          { value: 3, label: '<90' }
        ]},
        { id: 'pulse', label: 'Pulse ≥100', points: 1, type: 'checkbox' },
        { id: 'melena', label: 'Melena', points: 1, type: 'checkbox' },
        { id: 'syncope', label: 'Syncope', points: 2, type: 'checkbox' },
        { id: 'liver', label: 'Hepatic disease', points: 2, type: 'checkbox' },
        { id: 'hf', label: 'Heart failure', points: 2, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 0, risk: 'Very Low', action: 'May be managed as outpatient', color: '#10b981', intervention: '0.5%' },
        { min: 1, max: 5, risk: 'Low', action: 'Consider admission, likely no intervention', color: '#22c55e', intervention: '5%' },
        { min: 6, max: 11, risk: 'Moderate', action: 'Admission, endoscopy within 24h', color: '#f59e0b', intervention: '25%' },
        { min: 12, max: 23, risk: 'High', action: 'ICU admission, urgent endoscopy', color: '#ef4444', intervention: '>50%' }
      ]
    },
    
    'Child-Pugh': {
      name: 'Child-Pugh Score',
      category: 'GI',
      purpose: 'Cirrhosis severity and prognosis',
      fields: [
        { id: 'encephalopathy', label: 'Encephalopathy', type: 'select', options: [
          { value: 1, label: 'None' },
          { value: 2, label: 'Grade 1-2 (controlled)' },
          { value: 3, label: 'Grade 3-4 (poorly controlled)' }
        ]},
        { id: 'ascites', label: 'Ascites', type: 'select', options: [
          { value: 1, label: 'None' },
          { value: 2, label: 'Mild/controlled with diuretics' },
          { value: 3, label: 'Moderate-severe/refractory' }
        ]},
        { id: 'bilirubin', label: 'Bilirubin (mg/dL)', type: 'select', options: [
          { value: 1, label: '<2' },
          { value: 2, label: '2-3' },
          { value: 3, label: '>3' }
        ]},
        { id: 'albumin', label: 'Albumin (g/dL)', type: 'select', options: [
          { value: 1, label: '>3.5' },
          { value: 2, label: '2.8-3.5' },
          { value: 3, label: '<2.8' }
        ]},
        { id: 'inr', label: 'INR', type: 'select', options: [
          { value: 1, label: '<1.7' },
          { value: 2, label: '1.7-2.3' },
          { value: 3, label: '>2.3' }
        ]}
      ],
      interpretation: [
        { min: 5, max: 6, risk: 'Class A', action: 'Well-compensated; standard care', color: '#10b981', survival_1y: '100%', survival_2y: '85%' },
        { min: 7, max: 9, risk: 'Class B', action: 'Significant functional compromise', color: '#f59e0b', survival_1y: '81%', survival_2y: '57%' },
        { min: 10, max: 15, risk: 'Class C', action: 'Decompensated; consider transplant evaluation', color: '#ef4444', survival_1y: '45%', survival_2y: '35%' }
      ]
    },
    
    'MELD': {
      name: 'MELD Score',
      category: 'GI',
      purpose: 'End-stage liver disease severity',
      fields: [
        { id: 'creatinine', label: 'Creatinine (mg/dL)', type: 'number', min: 0.1, max: 10, step: 0.1 },
        { id: 'bilirubin', label: 'Bilirubin (mg/dL)', type: 'number', min: 0.1, max: 50, step: 0.1 },
        { id: 'inr', label: 'INR', type: 'number', min: 0.5, max: 10, step: 0.1 },
        { id: 'dialysis', label: 'Dialysis (at least 2x/week)', points: 0, type: 'checkbox' }
      ],
      formula: 'MELD = 10 × (0.957 × ln(Cr) + 0.378 × ln(Bili) + 1.12 × ln(INR) + 0.643)',
      interpretation: [
        { min: 6, max: 9, risk: 'Low', action: 'Standard care', color: '#10b981', mortality_3m: '1.9%' },
        { min: 10, max: 19, risk: 'Moderate', action: 'Close monitoring', color: '#f59e0b', mortality_3m: '6.0%' },
        { min: 20, max: 29, risk: 'High', action: 'Consider transplant listing', color: '#f97316', mortality_3m: '19.6%' },
        { min: 30, max: 40, risk: 'Very High', action: 'High priority for transplant', color: '#ef4444', mortality_3m: '52.6%' }
      ]
    },
    
    // ═══ SEPSIS/CRITICAL CARE SCORES ═══
    'qSOFA': {
      name: 'qSOFA Score',
      category: 'Critical Care',
      purpose: 'Quick sepsis screening',
      fields: [
        { id: 'rr', label: 'Respiratory rate ≥22/min', points: 1, type: 'checkbox' },
        { id: 'mental', label: 'Altered mental status (GCS <15)', points: 1, type: 'checkbox' },
        { id: 'sbp', label: 'Systolic BP ≤100 mmHg', points: 1, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Low', action: 'Low risk; monitor clinically', color: '#10b981', note: 'Not qSOFA positive' },
        { min: 2, max: 3, risk: 'High', action: 'High risk of poor outcome; consider ICU, calculate full SOFA', color: '#ef4444', note: 'qSOFA positive' }
      ]
    },
    
    'SOFA': {
      name: 'SOFA Score',
      category: 'Critical Care',
      purpose: 'Sequential Organ Failure Assessment',
      fields: [
        { id: 'pao2', label: 'PaO₂/FiO₂ (Respiration)', type: 'select', options: [
          { value: 0, label: '≥400' },
          { value: 1, label: '300-399' },
          { value: 2, label: '200-299' },
          { value: 3, label: '100-199 with respiratory support' },
          { value: 4, label: '<100 with respiratory support' }
        ]},
        { id: 'platelets', label: 'Platelets (×10³/μL)', type: 'select', options: [
          { value: 0, label: '≥150' },
          { value: 1, label: '100-149' },
          { value: 2, label: '50-99' },
          { value: 3, label: '20-49' },
          { value: 4, label: '<20' }
        ]},
        { id: 'bilirubin', label: 'Bilirubin (mg/dL)', type: 'select', options: [
          { value: 0, label: '<1.2' },
          { value: 1, label: '1.2-1.9' },
          { value: 2, label: '2.0-5.9' },
          { value: 3, label: '6.0-11.9' },
          { value: 4, label: '≥12' }
        ]},
        { id: 'map', label: 'Cardiovascular (MAP/Vasopressors)', type: 'select', options: [
          { value: 0, label: 'MAP ≥70, no vasopressors' },
          { value: 1, label: 'MAP <70, no vasopressors' },
          { value: 2, label: 'Dopamine ≤5 or dobutamine any dose' },
          { value: 3, label: 'Dopamine >5 or epi/norepi ≤0.1' },
          { value: 4, label: 'Dopamine >15 or epi/norepi >0.1' }
        ]},
        { id: 'gcs', label: 'Glasgow Coma Scale', type: 'select', options: [
          { value: 0, label: '15' },
          { value: 1, label: '13-14' },
          { value: 2, label: '10-12' },
          { value: 3, label: '6-9' },
          { value: 4, label: '<6' }
        ]},
        { id: 'creatinine', label: 'Creatinine (mg/dL) or Urine Output', type: 'select', options: [
          { value: 0, label: '<1.2' },
          { value: 1, label: '1.2-1.9' },
          { value: 2, label: '2.0-3.4' },
          { value: 3, label: '3.5-4.9 or UO <500 mL/day' },
          { value: 4, label: '≥5.0 or UO <200 mL/day' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 6, risk: 'Low', action: 'Mortality <10%', color: '#10b981', mortality: '<10%' },
        { min: 7, max: 9, risk: 'Moderate', action: 'Mortality 15-20%', color: '#f59e0b', mortality: '15-20%' },
        { min: 10, max: 12, risk: 'High', action: 'Mortality 40-50%', color: '#f97316', mortality: '40-50%' },
        { min: 13, max: 24, risk: 'Very High', action: 'Mortality >80%', color: '#ef4444', mortality: '>80%' }
      ]
    },
    
    'NEWS2': {
      name: 'NEWS2 Score',
      category: 'Critical Care',
      purpose: 'National Early Warning Score',
      fields: [
        { id: 'rr', label: 'Respiratory Rate', type: 'select', options: [
          { value: 3, label: '≤8' },
          { value: 1, label: '9-11' },
          { value: 0, label: '12-20' },
          { value: 2, label: '21-24' },
          { value: 3, label: '≥25' }
        ]},
        { id: 'spo2', label: 'SpO₂ Scale 1 (no COPD)', type: 'select', options: [
          { value: 3, label: '≤91%' },
          { value: 2, label: '92-93%' },
          { value: 1, label: '94-95%' },
          { value: 0, label: '≥96%' }
        ]},
        { id: 'air', label: 'Air or Oxygen', type: 'select', options: [
          { value: 0, label: 'Air' },
          { value: 2, label: 'Oxygen' }
        ]},
        { id: 'sbp', label: 'Systolic BP', type: 'select', options: [
          { value: 3, label: '≤90' },
          { value: 2, label: '91-100' },
          { value: 1, label: '101-110' },
          { value: 0, label: '111-219' },
          { value: 3, label: '≥220' }
        ]},
        { id: 'pulse', label: 'Pulse', type: 'select', options: [
          { value: 3, label: '≤40' },
          { value: 1, label: '41-50' },
          { value: 0, label: '51-90' },
          { value: 1, label: '91-110' },
          { value: 2, label: '111-130' },
          { value: 3, label: '≥131' }
        ]},
        { id: 'consciousness', label: 'Consciousness', type: 'select', options: [
          { value: 0, label: 'Alert' },
          { value: 3, label: 'CVPU (Confusion, Voice, Pain, Unresponsive)' }
        ]},
        { id: 'temp', label: 'Temperature', type: 'select', options: [
          { value: 3, label: '≤35.0°C' },
          { value: 1, label: '35.1-36.0°C' },
          { value: 0, label: '36.1-38.0°C' },
          { value: 1, label: '38.1-39.0°C' },
          { value: 2, label: '≥39.1°C' }
        ]}
      ],
      interpretation: [
        { min: 0, max: 4, risk: 'Low', action: 'Standard ward care; reassess per protocol', color: '#10b981', frequency: 'Q12h' },
        { min: 5, max: 6, risk: 'Medium', action: 'Urgent ward-based response', color: '#f59e0b', frequency: 'Q1h' },
        { min: 7, max: 20, risk: 'High', action: 'Emergency response; consider ICU', color: '#ef4444', frequency: 'Continuous' }
      ]
    },
    
    // ═══ RENAL SCORES ═══
    'KDIGO-AKI': {
      name: 'KDIGO AKI Staging',
      category: 'Renal',
      purpose: 'Acute kidney injury classification',
      fields: [
        { id: 'stage', label: 'AKI Stage', type: 'select', options: [
          { value: 1, label: 'Stage 1: Cr ↑ ≥0.3 mg/dL or 1.5-1.9× baseline, UO <0.5 mL/kg/h for 6-12h' },
          { value: 2, label: 'Stage 2: Cr 2.0-2.9× baseline, UO <0.5 mL/kg/h for ≥12h' },
          { value: 3, label: 'Stage 3: Cr ≥3× baseline or ≥4 mg/dL, UO <0.3 mL/kg/h for ≥24h or anuria ≥12h, or RRT initiation' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'Stage 1', action: 'Optimize volume, avoid nephrotoxins, monitor', color: '#f59e0b', note: 'Mild AKI' },
        { min: 2, max: 2, risk: 'Stage 2', action: 'Consider nephrology consult', color: '#f97316', note: 'Moderate AKI' },
        { min: 3, max: 3, risk: 'Stage 3', action: 'Nephrology consult, consider RRT', color: '#ef4444', note: 'Severe AKI' }
      ]
    },
    
    // ═══ SURGICAL/PERIOPERATIVE SCORES ═══
    'Caprini': {
      name: 'Caprini VTE Risk Score',
      category: 'Surgical',
      purpose: 'VTE risk in surgical patients',
      fields: [
        { id: 'age41', label: 'Age 41-60', points: 1, type: 'checkbox' },
        { id: 'age61', label: 'Age 61-74', points: 2, type: 'checkbox' },
        { id: 'age75', label: 'Age ≥75', points: 3, type: 'checkbox' },
        { id: 'minor_surgery', label: 'Minor surgery planned', points: 1, type: 'checkbox' },
        { id: 'major_surgery', label: 'Major surgery (>45 min)', points: 2, type: 'checkbox' },
        { id: 'obesity', label: 'BMI >25', points: 1, type: 'checkbox' },
        { id: 'swelling', label: 'Leg swelling', points: 1, type: 'checkbox' },
        { id: 'varicose', label: 'Varicose veins', points: 1, type: 'checkbox' },
        { id: 'chf', label: 'Heart failure', points: 1, type: 'checkbox' },
        { id: 'sepsis', label: 'Sepsis (<1 month)', points: 1, type: 'checkbox' },
        { id: 'pneumonia', label: 'Serious lung disease', points: 1, type: 'checkbox' },
        { id: 'pregnant', label: 'Pregnancy/postpartum', points: 1, type: 'checkbox' },
        { id: 'bedrest', label: 'Bed rest', points: 1, type: 'checkbox' },
        { id: 'immobile', label: 'Immobilizing cast', points: 2, type: 'checkbox' },
        { id: 'central_line', label: 'Central venous access', points: 2, type: 'checkbox' },
        { id: 'malignancy', label: 'Malignancy (present/previous)', points: 2, type: 'checkbox' },
        { id: 'prior_vte', label: 'History of DVT/PE', points: 3, type: 'checkbox' },
        { id: 'family_vte', label: 'Family history of VTE', points: 3, type: 'checkbox' },
        { id: 'factor_v', label: 'Factor V Leiden or other thrombophilia', points: 3, type: 'checkbox' },
        { id: 'stroke', label: 'Stroke (<1 month)', points: 5, type: 'checkbox' },
        { id: 'hip_knee', label: 'Hip/knee arthroplasty', points: 5, type: 'checkbox' },
        { id: 'fracture', label: 'Hip, pelvis, or leg fracture', points: 5, type: 'checkbox' },
        { id: 'sci', label: 'Acute spinal cord injury', points: 5, type: 'checkbox' }
      ],
      interpretation: [
        { min: 0, max: 1, risk: 'Very Low', action: 'Early ambulation', color: '#10b981', vte_risk: '0.5%' },
        { min: 2, max: 2, risk: 'Low', action: 'Pneumatic compression devices', color: '#22c55e', vte_risk: '1.5%' },
        { min: 3, max: 4, risk: 'Moderate', action: 'Pharmacologic prophylaxis', color: '#f59e0b', vte_risk: '3%' },
        { min: 5, max: 100, risk: 'High', action: 'Pharmacologic prophylaxis + mechanical', color: '#ef4444', vte_risk: '6%' }
      ]
    },
    
    'ASA': {
      name: 'ASA Physical Status',
      category: 'Surgical',
      purpose: 'Preoperative risk classification',
      fields: [
        { id: 'class', label: 'ASA Class', type: 'select', options: [
          { value: 1, label: 'ASA I: Healthy patient' },
          { value: 2, label: 'ASA II: Mild systemic disease' },
          { value: 3, label: 'ASA III: Severe systemic disease' },
          { value: 4, label: 'ASA IV: Life-threatening disease' },
          { value: 5, label: 'ASA V: Moribund, not expected to survive' },
          { value: 6, label: 'ASA VI: Brain-dead organ donor' }
        ]}
      ],
      interpretation: [
        { min: 1, max: 1, risk: 'ASA I', action: 'Proceed with standard care', color: '#10b981', mortality: '0.06%' },
        { min: 2, max: 2, risk: 'ASA II', action: 'Proceed with standard care', color: '#22c55e', mortality: '0.5%' },
        { min: 3, max: 3, risk: 'ASA III', action: 'Close perioperative monitoring', color: '#f59e0b', mortality: '2.2%' },
        { min: 4, max: 4, risk: 'ASA IV', action: 'Consider risk vs benefit carefully', color: '#f97316', mortality: '7.8%' },
        { min: 5, max: 5, risk: 'ASA V', action: 'Surgery only if life-saving', color: '#ef4444', mortality: '51%' }
      ]
    }
};

const REFS = [
    { title: '🚨 Critical Labs', content: '<b>K:</b> <2.5 or >6.5<br><b>Na:</b> <120 or >160<br><b>Glucose:</b> <40 or >500' },
    { title: '⚡ Hyperkalemia', content: '<b>Stabilize:</b> Ca gluconate 1g<br><b>Shift:</b> Insulin + D50<br><b>Remove:</b> Kayexalate' },
    { title: '❤️ ACS', content: '<b>MONA:</b> Morphine, O₂, Nitrates, ASA<br><b>STEMI:</b> PCI <90min' },
    { title: '🧠 Stroke tPA', content: '<b>Window:</b> ≤4.5h<br><b>Dose:</b> 0.9mg/kg max 90mg' },
    { title: '🦠 Sepsis', content: '<b>Hour-1:</b> Lactate, cultures, abx<br><b>Fluids:</b> 30mL/kg' },
    { title: '💊 Status Epilepticus', content: '<b>1st:</b> Lorazepam 4mg<br><b>2nd:</b> Levetiracetam 60mg/kg' }
];

const state = {
  units: [], settings: {}, patients: [], currentUnit: null, currentUser: null, currentPatient: null,
  selectedUnitId: null, editingUnitId: null, importImage: null, importPatients: [], currentFilter: 'all',
  fluidChart: null, trendChart: null, addDataType: null, isAnalyzingLab: false, isAnalyzingImaging: false,
  currentInteractionId: null, sessionId: null, unitRequests: [], selectedRequestId: null, selectedIcon: '🏥',
  pendingLabData: null, pendingLabImage: null, labExtractionConfidence: 0, isAnalyzingMeds: false, dischargePatientId: null,
  trash: { patients: [], units: [], medications: [] } // Recycle bin for deleted items
};

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-USER AUTHENTICATION SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

const AUTH = {
  user: null,
  pass: null
};

// Initialize AUTH from storage on load
(function initAuth() {
  // Check localStorage first (persistent), then sessionStorage (session-only)
  const localUser = localStorage.getItem('MW_USER');
  const localPass = localStorage.getItem('MW_PASS');
  const sessUser = sessionStorage.getItem('MW_USER');
  const sessPass = sessionStorage.getItem('MW_PASS');
  
  AUTH.user = sessUser || localUser;
  AUTH.pass = sessPass || localPass;
})();

// Logout function  
function doLogout() {
  if (!confirm("Log out of MedWard Pro?")) return;
  
  // Clear ALL storage
  localStorage.removeItem('MW_USER');
  localStorage.removeItem('MW_PASS');
  sessionStorage.removeItem('MW_USER');
  sessionStorage.removeItem('MW_PASS');
  AUTH.user = null;
  AUTH.pass = null;
  
  // Redirect to login page
  window.location.href = 'login.html';
}

// Cloud caller - injects credentials into all authenticated requests
async function callCloud(action, payload = {}) {
  // Inject credentials for non-auth actions
  if (action !== 'login' && action !== 'register') {
    if (AUTH.user && AUTH.pass) {
      payload.username = AUTH.user;
      payload.password = AUTH.pass;
    }
  }
  
  payload.action = action;
  
  const apiUrl = state.settings?.apiUrl || CONFIG.API_URL;
  
  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(payload)
  });
  
  return await response.json();
}

// ═══════════════════════════════════════════════════════════════════════════════
// TRASH MANAGEMENT FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Move item to trash (soft delete)
async function movePatientToTrash(id) {
  if (!confirm("Move this patient to Trash? You can restore them later.")) return;
  
  // Optimistic local update
  const patient = state.patients.find(p => p.id === id);
  if (patient) {
    patient.deletedAt = new Date().toISOString();
    if (!state.trash.patients) state.trash.patients = [];
    state.trash.patients.push(patient);
  }
  state.patients = state.patients.filter(p => p.id !== id);
  renderPatients();
  saveLocal();
  
  // Cloud sync
  try {
    await callCloud('moveToTrash', { itemIds: [id], itemType: 'patients' });
    toast("Moved to Trash");
  } catch (e) {
    console.error('Trash error:', e);
    toast("Moved locally (sync pending)", true);
  }
}

// Fetch trash contents from cloud
async function fetchTrash() {
  showLoading("Loading Trash...");
  try {
    const res = await callCloud('getTrash');
    hideLoading();
    
    if (res.success && res.trash) {
      state.trash = res.trash;
      renderTrashContent();
    } else {
      toast("Failed to load trash", true);
    }
  } catch (e) {
    hideLoading();
    // Use local trash
    renderTrashContent();
  }
}

// Render trash content in admin panel
function renderTrashContent() {
  const container = document.getElementById('trashContent');
  if (!container) return;
  
  const patients = state.trash?.patients || [];
  const units = state.trash?.units || [];
  
  if (patients.length === 0 && units.length === 0) {
    container.innerHTML = `
      <div class="admin-empty-state">
        <div class="admin-empty-icon">🗑️</div>
        <div class="admin-empty-text">Trash is empty</div>
        <div class="admin-empty-hint">Deleted items will appear here</div>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  // Patients in trash
  if (patients.length > 0) {
    html += '<div style="margin-bottom:16px"><h4 style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px">👥 Patients</h4>';
    patients.forEach(p => {
      const deletedDate = p.deletedAt ? new Date(p.deletedAt).toLocaleDateString() : 'Unknown';
      html += `
        <div class="trash-item" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px;opacity:0.8">
          <div>
            <div style="font-weight:600">${esc(p.name)}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">Deleted: ${deletedDate}</div>
          </div>
          <button class="btn btn-success btn-sm" onclick="restorePatientFromTrash('${p.id}')" style="padding:6px 12px;font-size:0.75rem">♻️ Restore</button>
        </div>
      `;
    });
    html += '</div>';
  }
  
  // Units in trash
  if (units.length > 0) {
    html += '<div><h4 style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px">🏥 Units</h4>';
    units.forEach(u => {
      const deletedDate = u.deletedAt ? new Date(u.deletedAt).toLocaleDateString() : 'Unknown';
      html += `
        <div class="trash-item" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px;opacity:0.8">
          <div>
            <div style="font-weight:600">${esc(u.name)}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">Deleted: ${deletedDate}</div>
          </div>
          <button class="btn btn-success btn-sm" onclick="restoreUnitFromTrash('${u.id}')" style="padding:6px 12px;font-size:0.75rem">♻️ Restore</button>
        </div>
      `;
    });
    html += '</div>';
  }
  
  container.innerHTML = html;
}

// Restore patient from trash
async function restorePatientFromTrash(id) {
  showLoading("Restoring...");
  try {
    const res = await callCloud('restoreTrash', { itemIds: [id], itemType: 'patients' });
    hideLoading();
    
    if (res.success) {
      toast("Patient restored!");
      // Refresh data
      await syncFromCloud();
      fetchTrash();
      renderPatients();
    } else {
      toast("Restore failed", true);
    }
  } catch (e) {
    hideLoading();
    toast("Restore failed", true);
  }
}

// Restore unit from trash
async function restoreUnitFromTrash(id) {
  showLoading("Restoring...");
  try {
    const res = await callCloud('restoreTrash', { itemIds: [id], itemType: 'units' });
    hideLoading();
    
    if (res.success) {
      toast("Unit restored!");
      await syncFromCloud();
      fetchTrash();
      renderUnits();
    } else {
      toast("Restore failed", true);
    }
  } catch (e) {
    hideLoading();
    toast("Restore failed", true);
  }
}

// Empty trash permanently
async function emptyTrashPermanently() {
  if (!confirm("⚠️ Permanently delete all items in Trash?\n\nThis action cannot be undone!")) return;
  
  showLoading("Emptying Trash...");
  try {
    const res = await callCloud('emptyTrash');
    hideLoading();
    
    if (res.success) {
      state.trash = { patients: [], units: [], medications: [] };
      renderTrashContent();
      toast("Trash emptied permanently");
    } else {
      toast("Failed to empty trash", true);
    }
  } catch (e) {
    hideLoading();
    toast("Failed to empty trash", true);
  }
}

// Make functions globally available
window.movePatientToTrash = movePatientToTrash;
window.fetchTrash = fetchTrash;
window.restorePatientFromTrash = restorePatientFromTrash;
window.restoreUnitFromTrash = restoreUnitFromTrash;
window.emptyTrashPermanently = emptyTrashPermanently;
window.doLogout = doLogout;

// Generate session ID
state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

/**
 * MEDWARD PRO v3.0 - ELITE MULTI-DEVICE SYNC ENGINE
 * 
 * FIXES ALL 7 IDENTIFIED ISSUES:
 * ✓ #1: Single unified sync state
 * ✓ #2: Checksum validation for up-to-date detection
 * ✓ #3: Mutex-protected cloud operations
 * ✓ #4: Reliable patch persistence with ACK
 * ✓ #5: Cloud-first boot
 * ✓ #6: Coordinated with server locks
 * ✓ #7: Safe conflict resolution
 */

const SYNC_VERSION = '3.0.0';

const SYNC_CONFIG = {
  DEBOUNCE_MS: 800,
  HEARTBEAT_MS: 60000,
  FETCH_TIMEOUT_MS: 15000,
  MAX_RETRIES: 3,
  RETRY_DELAY_MS: 2000,
  MAX_REV_GAP: 10,
  DEVICE_ID_KEY: 'MW_DEVICE_ID_V3',
  REV_KEY: 'MW_REV_V3',
  CHECKSUM_KEY: 'MW_CHECKSUM_V3',
  PATCH_QUEUE_KEY: 'MW_PATCH_QUEUE_V3',
  PATIENT_COUNT_KEY: 'MW_PATIENT_COUNT_V3'
};

// SINGLE UNIFIED SYNC STATE (FIX #1)
const sync = {
  version: SYNC_VERSION,
  clientRev: 0,
  serverRev: null,
  clientChecksum: null,
  serverChecksum: null,
  phase: 'init',
  isHydrated: false,
  isReadOnly: true,
  cloudLoaded: false,
  isSyncing: false,
  pendingChanges: false,
  lastSyncTime: null,
  errorCount: 0,
  status: 'init',
  patchQueue: [],
  acknowledgedPatches: new Set(),
  deviceId: null,
  sessionId: null,
  activeSessions: [],
  lastServerPatientCount: 0,
  lastServerUnitCount: 0,           // Added for compatibility
  lastServerTimestamp: null,        // Added for compatibility
  hasEverSyncedThisSession: false,  // Added for compatibility
  pendingConflict: null,
  conflictResolver: null,
  syncTimer: null,
  heartbeatTimer: null,
  // FIX #3: Mutex for sequential cloud ops
  cloudMutex: { locked: false, queue: [] }
};

// ═══════════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ═══════════════════════════════════════════════════════════════════════════════

function initSyncEngine() {
  console.log('🚀 Sync Engine v' + SYNC_VERSION);
  
  sync.deviceId = getOrCreateDeviceId();
  sync.sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  sync.clientRev = parseInt(localStorage.getItem(SYNC_CONFIG.REV_KEY) || '0', 10);
  sync.clientChecksum = localStorage.getItem(SYNC_CONFIG.CHECKSUM_KEY) || null;
  sync.patchQueue = loadPatchQueue();
  
  document.addEventListener('visibilitychange', handleVisibilityChange);
  window.addEventListener('beforeunload', handleBeforeUnload);
  
  console.log('   Device:', sync.deviceId, 'Rev:', sync.clientRev);
  return sync;
}

function getOrCreateDeviceId() {
  let id = localStorage.getItem(SYNC_CONFIG.DEVICE_ID_KEY);
  if (!id) {
    id = 'dev_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 12);
    localStorage.setItem(SYNC_CONFIG.DEVICE_ID_KEY, id);
  }
  return id;
}

// ═══════════════════════════════════════════════════════════════════════════════
// CLOUD MUTEX (FIX #3: Prevents race conditions)
// ═══════════════════════════════════════════════════════════════════════════════

async function acquireCloudMutex() {
  return new Promise(resolve => {
    if (!sync.cloudMutex.locked) {
      sync.cloudMutex.locked = true;
      resolve();
    } else {
      sync.cloudMutex.queue.push(resolve);
    }
  });
}

function releaseCloudMutex() {
  if (sync.cloudMutex.queue.length > 0) {
    const next = sync.cloudMutex.queue.shift();
    next();
  } else {
    sync.cloudMutex.locked = false;
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// PATCH QUEUE (FIX #4: Reliable persistence)
// ═══════════════════════════════════════════════════════════════════════════════

function loadPatchQueue() {
  try {
    const stored = localStorage.getItem(SYNC_CONFIG.PATCH_QUEUE_KEY);
    if (stored) {
      const queue = JSON.parse(stored);
      const maxAge = 24 * 60 * 60 * 1000;
      return queue.filter(p => Date.now() - p.ts < maxAge);
    }
  } catch (e) {}
  return [];
}

function savePatchQueue() {
  try {
    localStorage.setItem(SYNC_CONFIG.PATCH_QUEUE_KEY, JSON.stringify(sync.patchQueue));
  } catch (e) {
    console.warn('Failed to save patch queue:', e);
  }
}

function generatePatchId() {
  return 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
}

function enqueuePatch(operation, payload) {
  // FIX #5: Block patches until hydrated
  if (sync.isReadOnly || !sync.isHydrated) {
    console.warn('⛔ Patch blocked:', sync.isReadOnly ? 'read-only' : 'not hydrated');
    toast && toast('Cannot save: System not ready', 'error');
    return false;
  }

  const patchId = generatePatchId();
  
  sync.patchQueue.push({
    id: patchId,
    operation,
    payload,
    ts: Date.now()
  });

  console.log('📝 Patch queued:', operation, payload?.id || '', 'ID:', patchId);
  compressPatchQueue();
  savePatchQueue();
  markDirty();
  return true;
}

function compressPatchQueue() {
  const queue = sync.patchQueue;
  if (queue.length <= 1) return;
  
  const entityPatches = new Map();
  const others = [];
  
  for (const patch of queue) {
    const id = patch.payload?.id;
    const op = patch.operation;
    
    if (id && (op.includes('Patient') || op.includes('Unit'))) {
      const key = op.replace(/add|update|delete/i, '') + ':' + id;
      const existing = entityPatches.get(key);
      
      if (existing) {
        if (op.startsWith('delete')) {
          entityPatches.set(key, patch);
        } else if (op.startsWith('update') && existing.operation.startsWith('update')) {
          existing.payload = { ...existing.payload, ...patch.payload };
          existing.ts = patch.ts;
        } else if (existing.operation.startsWith('add') && op.startsWith('update')) {
          existing.payload = { ...existing.payload, ...patch.payload };
        } else {
          entityPatches.set(key, patch);
        }
      } else {
        entityPatches.set(key, patch);
      }
    } else {
      others.push(patch);
    }
  }
  
  sync.patchQueue = [...entityPatches.values(), ...others];
}

// ═══════════════════════════════════════════════════════════════════════════════
// SYNC STATUS UI
// ═══════════════════════════════════════════════════════════════════════════════

function updateSyncStatus(status, message) {
  sync.status = status;
  
  const el = document.getElementById('syncStatusV2') || document.getElementById('syncStatus');
  const textEl = document.getElementById('syncStatusTextV2') || document.getElementById('syncStatusText');
  const iconEl = document.getElementById('syncIconV2');
  
  const icons = { init: '●', loading: '↻', synced: '✓', syncing: '↻', pending: '●', error: '⚠', offline: '○' };
  const messages = { init: 'Starting...', loading: 'Loading...', synced: 'Synced', syncing: 'Syncing...', pending: 'Saving...', error: 'Sync failed', offline: 'Offline' };
  
  if (el) el.className = 'sync-status-v2 ' + status;
  if (textEl) textEl.textContent = message || messages[status] || status;
  if (iconEl) {
    iconEl.textContent = icons[status] || '●';
    iconEl.className = 'sync-icon' + (status === 'syncing' || status === 'loading' ? ' spinning' : '');
  }
}

function updateSessionsUI() {
  const badge = document.getElementById('activeSessionsBadge');
  const countEl = document.getElementById('sessionsCount');
  
  const others = sync.activeSessions.filter(s => s.deviceId !== sync.deviceId);
  
  if (badge) badge.style.display = others.length > 0 ? 'flex' : 'none';
  if (countEl) countEl.textContent = others.length + ' other device' + (others.length !== 1 ? 's' : '');
}

// ═══════════════════════════════════════════════════════════════════════════════
// CLOUD OPERATIONS (Sync Engine - with timeout/abort support)
// ═══════════════════════════════════════════════════════════════════════════════

async function callCloudSync(action, extra = {}) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), SYNC_CONFIG.FETCH_TIMEOUT_MS);
  
  try {
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      cache: 'no-store',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action,
        username: AUTH.user,
        password: AUTH.pass,
        deviceId: sync.deviceId,
        sessionId: sync.sessionId,
        ...extra
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeout);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const text = await response.text();
    if (text.startsWith('<!DOCTYPE') || text.startsWith('<html')) throw new Error('Server returned HTML');
    
    return JSON.parse(text);
  } catch (error) {
    clearTimeout(timeout);
    if (error.name === 'AbortError') throw new Error('Request timed out');
    throw error;
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// LOAD FROM CLOUD (FIX #2 & #5: Checksum validation, cloud-first)
// ═══════════════════════════════════════════════════════════════════════════════

async function loadFromCloud(forceFullLoad = false) {
  await acquireCloudMutex();
  
  try {
    updateSyncStatus('loading');
    
    const response = await callCloudSync('loadData', {
      clientRev: forceFullLoad ? 0 : sync.clientRev,
      clientChecksum: forceFullLoad ? null : sync.clientChecksum,
      deviceInfo: { clientRev: sync.clientRev, platform: navigator.platform }
    });
    
    if (!response.success) throw new Error(response.error || 'Load failed');
    
    // Update sessions
    if (response.activeSessions) {
      sync.activeSessions = response.activeSessions;
      updateSessionsUI();
    }
    
    // FIX #2: Server says force full sync (corruption detected)
    if (response.forceFullSync && !forceFullLoad) {
      console.warn('⚠️ Server detected corruption, forcing full sync');
      releaseCloudMutex();
      return loadFromCloud(true);
    }
    
    // FIX #2: True up-to-date check with checksum
    if (response.upToDate && response.checksum === sync.clientChecksum) {
      console.log('✅ Truly up to date at rev', response.rev);
      unlockSync();
      updateSyncStatus('synced');
      releaseCloudMutex();
      return { upToDate: true, rev: response.rev };
    }
    
    // Got new data - apply it
    console.log('📥 Received data at rev', response.rev, 'checksum', response.checksum);
    
    sync.clientRev = response.rev;
    sync.serverRev = response.rev;
    sync.clientChecksum = response.checksum;
    sync.serverChecksum = response.checksum;
    localStorage.setItem(SYNC_CONFIG.REV_KEY, String(response.rev));
    localStorage.setItem(SYNC_CONFIG.CHECKSUM_KEY, response.checksum || '');
    
    // Apply to app state
    if (response.data) {
      state.patients = response.data.patients || [];
      state.units = response.data.units || [];
      state.settings = { ...state.settings, ...(response.data.settings || {}) };
      state.trash = response.data.trash || { patients: [], units: [] };
      state.unitRequests = response.data.unitRequests || [];
      
      sync.lastServerPatientCount = state.patients.length;
      localStorage.setItem(SYNC_CONFIG.PATIENT_COUNT_KEY, String(state.patients.length));
      
      // FIX #5: Save to localStorage AFTER cloud load (not before)
      saveLocalNow();
    }
    
    unlockSync();
    updateSyncStatus('synced');
    
    return { upToDate: false, rev: response.rev, data: response.data };
    
  } catch (error) {
    console.error('❌ Cloud load failed:', error);
    updateSyncStatus('error', error.message);
    throw error;
  } finally {
    releaseCloudMutex();
  }
}

function unlockSync() {
  sync.cloudLoaded = true;
  sync.isHydrated = true;
  sync.isReadOnly = false;
  sync.phase = 'ready';
  
  // Update legacy boot flags if they exist
  if (typeof boot !== 'undefined') {
    boot.cloudLoaded = true;
    boot.allowLocalReads = true;
    boot.allowLocalWrites = true;
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// FLUSH PATCHES (FIX #4: With acknowledgment)
// ═══════════════════════════════════════════════════════════════════════════════

async function flushPatches() {
  if (sync.patchQueue.length === 0) return { success: true, noop: true };
  if (!canWrite()) {
    console.warn('⛔ flushPatches blocked:', getWriteBlockReason());
    return { success: false, blocked: true };
  }
  if (sync.isSyncing) {
    scheduleSyncDebounced();
    return { success: false, busy: true };
  }
  
  await acquireCloudMutex();
  sync.isSyncing = true;
  updateSyncStatus('syncing');
  
  try {
    console.log('⚡ Flushing', sync.patchQueue.length, 'patches...');
    
    const patchIds = sync.patchQueue.map(p => p.id);
    
    const response = await callCloudSync('patches', {
      patches: sync.patchQueue.map(p => ({ operation: p.operation, payload: p.payload })),
      patchIds: patchIds,
      baseRev: sync.clientRev
    });
    
    // Handle conflict
    if (response.conflict) {
      console.warn('⚠️ Conflict during patch sync');
      return await handlePatchConflict(response);
    }
    
    if (!response.success && !response.partialSuccess) {
      throw new Error(response.error || 'Patch sync failed');
    }
    
    // Update rev and checksum
    sync.clientRev = response.rev;
    sync.serverRev = response.rev;
    sync.clientChecksum = response.checksum;
    localStorage.setItem(SYNC_CONFIG.REV_KEY, String(response.rev));
    localStorage.setItem(SYNC_CONFIG.CHECKSUM_KEY, response.checksum || '');
    
    // FIX #4: Track acknowledged patches
    if (response.acknowledgedPatches) {
      response.acknowledgedPatches.forEach(id => sync.acknowledgedPatches.add(id));
      localStorage.setItem('MW_ACKED_PATCHES_V3', JSON.stringify(Array.from(sync.acknowledgedPatches)));
    }
    
    // Clear applied patches
    if (response.success) {
      sync.patchQueue = [];
    } else if (response.partialSuccess && response.results) {
      const failedOps = response.results.filter(r => !r.success && !r.skipped).map((r, i) => patchIds[i]);
      sync.patchQueue = sync.patchQueue.filter(p => failedOps.includes(p.id));
    }
    
    savePatchQueue();
    
    if (response.activeSessions) {
      sync.activeSessions = response.activeSessions;
      updateSessionsUI();
    }
    
    sync.pendingChanges = sync.patchQueue.length > 0;
    sync.lastSyncTime = Date.now();
    sync.errorCount = 0;
    
    updateSyncStatus(sync.patchQueue.length > 0 ? 'pending' : 'synced');
    
    return { success: response.success, rev: response.rev, checksum: response.checksum };
    
  } catch (error) {
    sync.errorCount++;
    console.error('❌ Patch sync failed:', error);
    updateSyncStatus('error', error.message);
    
    if (sync.errorCount < SYNC_CONFIG.MAX_RETRIES) {
      const delay = SYNC_CONFIG.RETRY_DELAY_MS * Math.pow(2, sync.errorCount - 1);
      console.log(`⏳ Retrying in ${delay}ms...`);
      setTimeout(() => flushPatches(), delay);
    }
    
    throw error;
  } finally {
    sync.isSyncing = false;
    releaseCloudMutex();
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// SNAPSHOT SAVE (FIX #7: Safe even with force)
// ═══════════════════════════════════════════════════════════════════════════════

async function saveSnapshot(options = {}) {
  if (!canWrite() && !options.force) {
    const reason = getWriteBlockReason();
    console.warn('⛔ saveSnapshot blocked:', reason);
    toast && toast('Cannot save: ' + reason, 'error');
    return { success: false, blocked: true };
  }
  
  // FIX #7: Wipe protection even with force
  const currentCount = state.patients?.length || 0;
  const lastCount = parseInt(localStorage.getItem(SYNC_CONFIG.PATIENT_COUNT_KEY) || '0', 10);
  
  if (currentCount === 0 && lastCount > 0) {
    if (!options.confirmWipe) {
      console.warn('⛔ Wipe protection: refusing to save empty state');
      
      // Show confirmation dialog
      const confirmed = await showWipeConfirmation(lastCount);
      if (!confirmed) {
        return { success: false, wipeBlocked: true, lastCount };
      }
      options.confirmWipe = true;
    }
  }
  
  await acquireCloudMutex();
  updateSyncStatus('syncing');
  
  try {
    const payload = {
      units: state.units,
      patients: state.patients,
      settings: { ...state.settings },
      trash: state.trash,
      unitRequests: state.unitRequests,
      confirmWipe: options.confirmWipe
    };
    
    delete payload.settings.apiUrl;
    
    const response = await callCloudSync('saveData', {
      payload,
      baseRev: options.force ? null : sync.clientRev,
      force: options.force
    });
    
    if (response.conflict) {
      console.warn('⚠️ Conflict during snapshot save');
      return await handleConflict({
        type: 'snapshot',
        localData: payload,
        serverRev: response.serverRev,
        serverData: response.serverData,
        serverChecksum: response.serverChecksum,
        serverUpdatedBy: response.serverUpdatedBy
      });
    }
    
    // FIX #7: Handle wipe confirmation requirement from server
    if (response.requiresConfirmation) {
      const confirmed = await showWipeConfirmation(response.serverPatientCount);
      if (confirmed) {
        releaseCloudMutex();
        return saveSnapshot({ ...options, confirmWipe: true, force: true });
      }
      return { success: false, wipeBlocked: true };
    }
    
    if (!response.success) throw new Error(response.error || 'Save failed');
    
    sync.clientRev = response.rev;
    sync.serverRev = response.rev;
    sync.clientChecksum = response.checksum;
    localStorage.setItem(SYNC_CONFIG.REV_KEY, String(response.rev));
    localStorage.setItem(SYNC_CONFIG.CHECKSUM_KEY, response.checksum || '');
    localStorage.setItem(SYNC_CONFIG.PATIENT_COUNT_KEY, String(currentCount));
    
    sync.patchQueue = [];
    savePatchQueue();
    
    if (response.activeSessions) {
      sync.activeSessions = response.activeSessions;
      updateSessionsUI();
    }
    
    sync.pendingChanges = false;
    sync.lastSyncTime = Date.now();
    sync.errorCount = 0;
    
    updateSyncStatus('synced');
    
    return { success: true, rev: response.rev, checksum: response.checksum };
    
  } catch (error) {
    sync.errorCount++;
    console.error('❌ Snapshot save failed:', error);
    updateSyncStatus('error', error.message);
    throw error;
  } finally {
    releaseCloudMutex();
  }
}

async function showWipeConfirmation(patientCount) {
  return new Promise(resolve => {
    const confirmed = confirm(
      `⚠️ WARNING: This will delete ${patientCount} patients from the server.\n\n` +
      `Are you absolutely sure you want to proceed?\n\n` +
      `This action cannot be undone.`
    );
    resolve(confirmed);
  });
}

// ═══════════════════════════════════════════════════════════════════════════════
// CONFLICT RESOLUTION
// ═══════════════════════════════════════════════════════════════════════════════

async function handleConflict(conflict) {
  console.warn('⚠️ Handling conflict:', conflict);
  sync.pendingConflict = conflict;
  
  showConflictModal(conflict);
  
  return new Promise(resolve => {
    sync.conflictResolver = resolve;
  });
}

async function handlePatchConflict(response) {
  console.warn('⚠️ Patch conflict - attempting rebase...');
  
  try {
    const rebaseResponse = await callCloudSync('rebase', {
      clientPatches: sync.patchQueue,
      baseRev: sync.clientRev
    });
    
    if (rebaseResponse.success) {
      console.log('✅ Rebase successful');
      sync.patchQueue = [];
      savePatchQueue();
      sync.clientRev = rebaseResponse.rev;
      sync.clientChecksum = rebaseResponse.checksum;
      localStorage.setItem(SYNC_CONFIG.REV_KEY, String(rebaseResponse.rev));
      localStorage.setItem(SYNC_CONFIG.CHECKSUM_KEY, rebaseResponse.checksum || '');
      updateSyncStatus('synced');
      return { success: true, resolved: 'rebase', rev: rebaseResponse.rev };
    }
    
    if (rebaseResponse.hasConflicts) {
      return await handleConflict({
        type: 'patches',
        conflicts: rebaseResponse.conflicts,
        localPatches: sync.patchQueue,
        serverRev: response.serverRev,
        serverData: response.serverData,
        serverChecksum: response.serverChecksum
      });
    }
  } catch (e) {
    console.error('Rebase failed:', e);
  }
  
  return await handleConflict({
    type: 'patches',
    localPatches: sync.patchQueue,
    serverRev: response.serverRev,
    serverData: response.serverData,
    serverChecksum: response.serverChecksum,
    serverUpdatedBy: response.serverUpdatedBy
  });
}

function showConflictModal(conflict) {
  const modal = document.getElementById('conflictModal');
  const deviceName = document.getElementById('conflictDeviceName');
  const deviceTime = document.getElementById('conflictDeviceTime');
  
  if (deviceName && conflict.serverUpdatedBy) {
    deviceName.textContent = conflict.serverUpdatedBy.userName || conflict.serverUpdatedBy.deviceId || 'Another device';
  }
  
  if (deviceTime && conflict.serverUpdatedAt) {
    deviceTime.textContent = 'Modified ' + formatRelativeTime(conflict.serverUpdatedAt);
  }
  
  if (modal) modal.classList.add('active');
}

function resolveConflict(resolution) {
  const modal = document.getElementById('conflictModal');
  if (modal) modal.classList.remove('active');
  
  const conflict = sync.pendingConflict;
  const resolver = sync.conflictResolver;
  
  sync.pendingConflict = null;
  sync.conflictResolver = null;
  
  if (!conflict || !resolver) return;
  
  switch (resolution) {
    case 'server':
      if (conflict.serverData) {
        state.patients = conflict.serverData.patients || [];
        state.units = conflict.serverData.units || [];
        state.settings = { ...state.settings, ...(conflict.serverData.settings || {}) };
        state.trash = conflict.serverData.trash || { patients: [], units: [] };
        saveLocalNow();
        renderPatients && renderPatients();
        renderUnits && renderUnits();
      }
      
      sync.patchQueue = [];
      savePatchQueue();
      sync.clientRev = conflict.serverRev;
      sync.clientChecksum = conflict.serverChecksum;
      localStorage.setItem(SYNC_CONFIG.REV_KEY, String(conflict.serverRev));
      localStorage.setItem(SYNC_CONFIG.CHECKSUM_KEY, conflict.serverChecksum || '');
      
      updateSyncStatus('synced');
      toast && toast('Using server version');
      resolver({ success: true, resolved: 'server' });
      break;
      
    case 'client':
      saveSnapshot({ force: true, confirmWipe: true }).then(result => {
        toast && toast(result.success ? 'Your changes saved' : 'Failed to save', !result.success);
        resolver(result);
      });
      break;
      
    case 'merge':
      attemptAutoMerge(conflict).then(result => {
        toast && toast(result.success ? 'Changes merged' : 'Merge failed', !result.success);
        resolver(result);
      });
      break;
      
    default:
      resolver({ success: false, cancelled: true });
  }
}

async function attemptAutoMerge(conflict) {
  if (!conflict.serverData) return { success: false, message: 'No server data' };
  
  const serverPatients = new Map((conflict.serverData.patients || []).map(p => [p.id, p]));
  const localPatients = new Map((state.patients || []).map(p => [p.id, p]));
  
  const merged = [];
  const allIds = new Set([...serverPatients.keys(), ...localPatients.keys()]);
  
  for (const id of allIds) {
    const server = serverPatients.get(id);
    const local = localPatients.get(id);
    
    if (!server) {
      merged.push(local);
    } else if (!local) {
      merged.push(server);
    } else {
      const serverTime = new Date(server.updatedAt || server._updatedAt || 0).getTime();
      const localTime = new Date(local.updatedAt || local._updatedAt || 0).getTime();
      merged.push(localTime > serverTime ? local : server);
    }
  }
  
  state.patients = merged;
  
  return await saveSnapshot({ force: true, confirmWipe: true });
}

// ═══════════════════════════════════════════════════════════════════════════════
// SYNC SCHEDULING
// ═══════════════════════════════════════════════════════════════════════════════

function markDirty() {
  if (!canWrite()) {
    console.warn('⛔ markDirty blocked:', getWriteBlockReason());
    return;
  }

  sync.pendingChanges = true;
  updateSyncStatus('pending');
  scheduleSyncDebounced();
}

function scheduleSyncDebounced() {
  if (sync.syncTimer) clearTimeout(sync.syncTimer);
  
  sync.syncTimer = setTimeout(() => {
    flushPatches().catch(e => console.error('Scheduled sync failed:', e));
  }, SYNC_CONFIG.DEBOUNCE_MS);
}

function canWrite() {
  return !sync.isReadOnly && sync.isHydrated && sync.cloudLoaded;
}

function getWriteBlockReason() {
  if (sync.isReadOnly) return 'Read-only mode';
  if (!sync.isHydrated) return 'Not hydrated';
  if (!sync.cloudLoaded) return 'Cloud boot incomplete';
  return null;
}

// ═══════════════════════════════════════════════════════════════════════════════
// HEARTBEAT
// ═══════════════════════════════════════════════════════════════════════════════

function startHeartbeat() {
  if (sync.heartbeatTimer) clearInterval(sync.heartbeatTimer);
  
  sync.heartbeatTimer = setInterval(() => sendHeartbeat(), SYNC_CONFIG.HEARTBEAT_MS);
  sendHeartbeat();
}

async function sendHeartbeat() {
  try {
    const response = await callCloudSync('heartbeat', {
      deviceInfo: { clientRev: sync.clientRev, platform: navigator.platform }
    });
    
    if (response.success) {
      // FIX #2: Check for force full sync (revision gap or corruption)
      if (response.forceFullSync) {
        console.warn('⚠️ Server requests full sync (gap:', response.revGap, ')');
        loadFromCloud(true).catch(() => {});
        return;
      }
      
      // Check if server is ahead
      if (response.rev > sync.clientRev || response.checksum !== sync.clientChecksum) {
        console.log('📡 Server has newer data:', response.rev, 'vs', sync.clientRev);
        loadFromCloud().catch(() => {});
      }
      
      if (response.activeSessions) {
        sync.activeSessions = response.activeSessions;
        updateSessionsUI();
      }
    }
  } catch (error) {
    console.warn('Heartbeat failed:', error.message);
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// LIFECYCLE HANDLERS
// ═══════════════════════════════════════════════════════════════════════════════

function handleVisibilityChange() {
  if (document.visibilityState === 'hidden') {
    // Going to background - persist patch queue
    savePatchQueue();
    
    // Try beacon for pending patches
    if (sync.patchQueue.length > 0 && navigator.sendBeacon && canWrite()) {
      const payload = JSON.stringify({
        action: 'patches',
        username: AUTH.user,
        password: AUTH.pass,
        patches: sync.patchQueue.map(p => ({ operation: p.operation, payload: p.payload })),
        patchIds: sync.patchQueue.map(p => p.id),
        deviceId: sync.deviceId,
        sessionId: sync.sessionId,
        baseRev: sync.clientRev
      });
      navigator.sendBeacon(CONFIG.API_URL, payload);
      console.log('📤 Beacon sent');
    }
  } else {
    // Coming to foreground - check for updates
    loadFromCloud().catch(() => {});
  }
}

function handleBeforeUnload() {
  savePatchQueue();
}

function handleOnline() {
  console.log('🌐 Back online');
  loadFromCloud().catch(() => {});
}

function handleOffline() {
  console.log('📴 Offline');
  updateSyncStatus('offline');
}

// ═══════════════════════════════════════════════════════════════════════════════
// LOCAL STORAGE (FIX #5: Only after cloud load)
// ═══════════════════════════════════════════════════════════════════════════════

function saveLocalNow() {
  if (!sync.cloudLoaded) {
    console.log('⏳ saveLocalNow blocked: Cloud not loaded');
    return;
  }
  
  try {
    const payload = JSON.stringify({
      units: state.units,
      settings: state.settings,
      patients: state.patients,
      unitRequests: state.unitRequests,
      trash: state.trash,
      rev: sync.clientRev,
      checksum: sync.clientChecksum,
      lastUpdated: new Date().toISOString()
    });
    localStorage.setItem(CONFIG.STORAGE_KEY, payload);
    localStorage.setItem(CONFIG.CACHE_KEY, payload);
  } catch (e) {
    console.warn('⚠️ localStorage save failed:', e);
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// COMPATIBILITY LAYER
// ═══════════════════════════════════════════════════════════════════════════════

// Bridge old function names to new system
function saveCloud() { markDirty(); }
async function syncFromCloud() { return await loadFromCloud(); }
async function forceSync() {
  if (sync.patchQueue.length > 0) return await flushPatches();
  return await saveSnapshot();
}
async function retryCloudConnection() {
  toast && toast('Retrying connection...');
  try {
    await loadFromCloud(true);
    toast && toast('Connected!');
  } catch (e) {
    toast && toast('Connection failed', true);
  }
}

// Helper
function formatRelativeTime(isoString) {
  if (!isoString) return 'Unknown';
  const diff = Date.now() - new Date(isoString).getTime();
  const minutes = Math.floor(diff / 60000);
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return minutes + 'm ago';
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'h ago';
  return Math.floor(hours / 24) + 'd ago';
}

// ═══════════════════════════════════════════════════════════════════════════════
// EXPORTS
// ═══════════════════════════════════════════════════════════════════════════════

// Make globally available
window.sync = sync;
window.initSyncEngine = initSyncEngine;
window.loadFromCloud = loadFromCloud;
window.flushPatches = flushPatches;
window.saveSnapshot = saveSnapshot;
window.enqueuePatch = enqueuePatch;
window.markDirty = markDirty;
window.startHeartbeat = startHeartbeat;
window.resolveConflict = resolveConflict;
window.saveCloud = saveCloud;
window.syncFromCloud = syncFromCloud;
window.forceSync = forceSync;
window.retryCloudConnection = retryCloudConnection;
window.canWrite = canWrite;

console.log('✅ Sync Engine v' + SYNC_VERSION + ' loaded');



// ═══════════════════════════════════════════════════════════════════════════
// CLOUD-FIRST BOOT FLAGS - Controls local cache read/write during boot
// ═══════════════════════════════════════════════════════════════════════════
const boot = {
  cloudLoaded: false,        // True only after successful cloud load
  allowLocalReads: false,    // Block local snapshot reads until cloud fails
  allowLocalWrites: false,   // Block local writes until stability window passes
  bootPhase: 'init'          // Track: 'init' -> 'loading' -> 'ready'
};

const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = t => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };

// ═══════════════════════════════════════════════════════════════════
// SYNC STATUS BAR - Visual indicator for read-only/offline mode
// ═══════════════════════════════════════════════════════════════════
function showSyncStatusBar(msg, color) {
  const el = document.getElementById('syncStatusBar');
  if (!el) return;
  
  el.style.display = 'block';
  el.innerText = msg;
  
  if (color === 'orange') {
    // Read-only / cached mode
    el.style.background = '#ffedd5';
    el.style.color = '#9a3412';
  } else if (color === 'green') {
    // Connected
    el.style.background = '#dcfce7';
    el.style.color = '#166534';
    // Auto hide green after 3 seconds
    setTimeout(() => { el.style.display = 'none'; }, 3000);
  } else if (color === 'red') {
    // Error
    el.style.background = '#fee2e2';
    el.style.color = '#991b1b';
  } else {
    // Default/neutral
    el.style.background = '#f1f5f9';
    el.style.color = '#475569';
  }
}

// Fetch with timeout and retry for hospital Wi-Fi resilience
async function fetchWithRetry(url, options = {}, retries = CONFIG.MAX_RETRIES) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), CONFIG.FETCH_TIMEOUT_MS);
  
  try {
    const response = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(timeout);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response;
  } catch (error) {
    clearTimeout(timeout);
    
    // Determine error type for user feedback
    let userMessage = 'Network error';
    if (error.name === 'AbortError') {
      userMessage = 'Request timed out';
    } else if (!navigator.onLine) {
      userMessage = 'No internet connection';
    } else if (error.message.includes('HTTP')) {
      userMessage = 'Server error';
    }
    
    // Retry logic with exponential backoff
    if (retries > 0 && error.name !== 'AbortError') {
      console.log(`⏳ Retrying... (${CONFIG.MAX_RETRIES - retries + 1}/${CONFIG.MAX_RETRIES})`);
      await new Promise(r => setTimeout(r, 1000 * (CONFIG.MAX_RETRIES - retries + 1)));
      return fetchWithRetry(url, options, retries - 1);
    }
    
    error.userMessage = userMessage;
    throw error;
  }
}
const initials = n => { if (!n) return '?'; const p = n.trim().split(/\s+/); return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : n.substring(0, 2).toUpperCase(); };

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function showLoading(msg = 'Loading...') {
  if (!document.getElementById('loadingOverlay')) {
    const overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
    const spinner = document.createElement('div');
    spinner.innerHTML = '<div style="background:white;padding:30px;border-radius:12px;text-align:center"><div style="width:40px;height:40px;border:4px solid #e0e0e0;border-top-color:#005eb8;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px"></div><p style="margin:0;color:#111827">' + msg + '</p></div>';
    overlay.appendChild(spinner);
    document.body.appendChild(overlay);
  }
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.remove();
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }
window.closeModal = closeModal;

function showPage(pageId) {
  $$('.page').forEach(p => p.classList.remove('active'));
  $(pageId).classList.add('active');
  // Hide the app header completely - dashboard has its own header
  const header = $('appHeader');
  if (header) {
    header.style.display = 'none';
  }
}

function formatDate(d) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  d = d || new Date();
  return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

function formatDateTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatShortDate(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function compress(file, max, cb) {
  const r = new FileReader();
  r.onerror = () => {
    console.error('❌ FileReader error');
    cb(null);
  };
  r.onload = e => {
    const img = new Image();
    img.onerror = () => {
      console.error('❌ Image load error');
      cb(null);
    };
    img.onload = () => {
      const c = document.createElement('canvas'), ctx = c.getContext('2d');
      let w = img.width, h = img.height, q = CONFIG.IMAGE_QUALITY;
      if (w > CONFIG.MAX_DIM || h > CONFIG.MAX_DIM) {
        if (w > h) { h = Math.round(h * CONFIG.MAX_DIM / w); w = CONFIG.MAX_DIM; }
        else { w = Math.round(w * CONFIG.MAX_DIM / h); h = CONFIG.MAX_DIM; }
      }
      c.width = w; c.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      let url = c.toDataURL('image/jpeg', q);
      while (url.length > max && q > 0.3) { q -= 0.1; url = c.toDataURL('image/jpeg', q); }
      console.log('✅ Compressed image:', url.length, 'bytes');
      cb(url);
    };
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}

// ═══════════════════════════════════════════════════════════════════
// PROMISE-BASED COMPRESSOR FOR BATCH PROCESSING
// ═══════════════════════════════════════════════════════════════════
function compressForAI(file) {
  return new Promise((resolve, reject) => {
    if (!file) {
      console.error('❌ compressForAI: No file provided');
      const err = new Error('No file provided');
      err.userMessage = 'Please select an image file';
      reject(err);
      return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
      const err = new Error('Invalid file type');
      err.userMessage = 'Please select an image file (JPG, PNG, etc.)';
      reject(err);
      return;
    }
    
    // Check file size (max 20MB raw)
    if (file.size > 20 * 1024 * 1024) {
      const err = new Error('File too large');
      err.userMessage = 'Image too large. Please use an image under 20MB.';
      reject(err);
      return;
    }
    
    console.log('🗜️ Compressing file:', file.name, file.size, 'bytes');
    
    // Use createImageBitmap if available for better performance
    const processImage = (imgSrc) => {
      compress(imgSrc, CONFIG.MAX_IMAGE_SIZE, (compressedData) => {
        if (compressedData && compressedData.length > 100) {
          console.log('✅ compressForAI success:', compressedData.substring(0, 50));
          resolve(compressedData);
        } else {
          console.error('❌ compressForAI: Compression returned invalid data');
          const err = new Error('Compression failed - invalid data');
          err.userMessage = 'Image compression failed. Try a different image.';
          reject(err);
        }
      });
    };
    
    processImage(file);
  });
}

function smartWard(raw) {
  if (!raw) return 'Ward 14';
  const w = String(raw).toLowerCase();
  if (w.includes('14')) return 'Ward 14';
  if (w.includes('22')) return 'Ward 22';
  if (w.includes('27')) return 'Ward 27';
  if (w.includes('icu')) return 'ICU';
  if (w.includes('er') || w.includes('unassign')) return 'ER/Unassigned';
  return 'Ward 14';
}

// PERFORMANCE: Cache for lab category lookups
window._labCategoryCache = window._labCategoryCache || new Map();

function getLabCategory(name) {
  // Check cache first
  if (window._labCategoryCache.has(name)) {
    return window._labCategoryCache.get(name);
  }

  const n = (name || '').toLowerCase();
  let category = 'Other';

  for (const [cat, data] of Object.entries(CONFIG.LAB_CATEGORIES)) {
    if (data.terms.some(t => n.includes(t.toLowerCase()))) {
      category = cat;
      break;
    }
  }

  // Cache the result
  window._labCategoryCache.set(name, category);
  return category;
}

// ═══════════════════════════════════════════════════════════════════
// LAB TREND ANALYSIS ENGINE - Medical Grade Trend Detection
// ═══════════════════════════════════════════════════════════════════

function analyzeTrend(param) {
  // param has: name, values (array sorted newest first), unit, refMin, refMax
  if (!param?.values || param.values.length < 2) return null;
  
  const current = parseFloat(param.values[0]?.value);
  const previous = parseFloat(param.values[1]?.value);
  
  if (isNaN(current) || isNaN(previous)) return null;
  
  const diff = current - previous;
  const percentChange = previous !== 0 ? ((diff / previous) * 100) : 0;
  
  // Clinical Context Rules (The "Doctor's Brain")
  let status = 'stable';
  let color = 'var(--text-muted)';
  let arrow = '→';
  const name = (param.name || '').toLowerCase();
  
  // Rule 1: Creatinine (AKI Check) - rise of ≥0.3 mg/dL (≈26.5 µmol/L) is concerning
  if (name.includes('creat') || name.includes('cr')) {
    // Handle both mg/dL and µmol/L units
    const threshold = (param.unit || '').toLowerCase().includes('mol') ? 26.5 : 0.3;
    if (diff >= threshold) { 
      status = 'worsening'; 
      color = '#dc2626'; 
      arrow = '↗'; 
    } else if (diff <= -threshold * 0.7) { 
      status = 'improving'; 
      color = '#10b981'; 
      arrow = '↘'; 
    }
  }
  // Rule 2: Hemoglobin (Bleed Check) - drop of 1+ g/dL (10 g/L) is concerning
  else if (name.includes('hgb') || name.includes('hemoglobin') || name.includes('haemoglobin') || name.includes('hb')) {
    const threshold = (param.unit || '').toLowerCase().includes('g/l') ? 10 : 1;
    if (diff <= -threshold) { 
      status = 'worsening'; 
      color = '#dc2626'; 
      arrow = '↘'; 
    } else if (diff >= threshold) { 
      status = 'improving'; 
      color = '#10b981'; 
      arrow = '↗'; 
    }
  }
  // Rule 3: Potassium - any significant change is important
  else if (name.includes('potassium') || name === 'k' || name === 'k+') {
    if (diff >= 0.5) { 
      status = current > 5.0 ? 'worsening' : 'rising'; 
      color = current > 5.0 ? '#dc2626' : '#d97706'; 
      arrow = '↗'; 
    } else if (diff <= -0.5) { 
      status = current < 3.5 ? 'worsening' : 'falling'; 
      color = current < 3.5 ? '#dc2626' : '#d97706'; 
      arrow = '↘'; 
    }
  }
  // Rule 4: WBC - infection/sepsis monitoring
  else if (name.includes('wbc') || name.includes('white')) {
    if (diff >= 3) { 
      status = 'rising'; 
      color = '#d97706'; 
      arrow = '↗'; 
    } else if (diff <= -3) { 
      status = 'falling'; 
      color = '#d97706'; 
      arrow = '↘'; 
    }
  }
  // Rule 5: Platelets - bleeding risk
  else if (name.includes('platelet') || name.includes('plt')) {
    if (diff <= -30) { 
      status = current < 100 ? 'worsening' : 'falling'; 
      color = current < 100 ? '#dc2626' : '#d97706'; 
      arrow = '↘'; 
    } else if (diff >= 30) { 
      status = 'improving'; 
      color = '#10b981'; 
      arrow = '↗'; 
    }
  }
  // General Rule (Significant Change > 15%)
  else {
    if (percentChange > 15) { 
      arrow = '↗'; 
      color = 'var(--text-main)'; 
      status = 'rising';
    } else if (percentChange < -15) { 
      arrow = '↘'; 
      color = 'var(--text-main)'; 
      status = 'falling';
    }
  }
  
  return { 
    diff: diff, 
    percentChange: percentChange.toFixed(1), 
    previous: previous, 
    previousDate: param.values[1]?.date,
    arrow: arrow, 
    color: color, 
    status: status 
  };
}

function generateSparkline(param, maxPoints = 7, precomputedTrend = null) {
  // param.values is array sorted newest first
  if (!param?.values || param.values.length < 2) return '<div style="height:25px;width:60px;"></div>';

  // Extract the last N values, reversed so time goes Left → Right
  const dataPoints = param.values.slice(0, maxPoints).reverse()
    .map(v => parseFloat(v.value))
    .filter(v => !isNaN(v));

  if (dataPoints.length < 2) return '<div style="height:25px;width:60px;"></div>';

  // Dimensions - larger for better visibility
  const width = 60;
  const height = 25;
  const max = Math.max(...dataPoints);
  const min = Math.min(...dataPoints);
  const range = max - min || 1;

  // Build points array
  const points = dataPoints.map((val, i) => {
    const x = (i / (dataPoints.length - 1)) * width;
    const y = height - ((val - min) / range * height);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  });

  // PERFORMANCE FIX: Use precomputed trend to avoid duplicate analyzeTrend() call
  const trend = precomputedTrend || analyzeTrend(param);
  const lineColor = trend?.status === 'worsening' ? '#dc2626' :
                    trend?.status === 'improving' ? '#10b981' :
                    '#6366f1'; // Indigo for neutral

  // First and last point coordinates
  const lastX = (dataPoints.length - 1) / (dataPoints.length - 1) * width;
  const lastY = height - ((dataPoints[dataPoints.length - 1] - min) / range * height);
  const firstY = height - ((dataPoints[0] - min) / range * height);

  return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="overflow:visible">
    <polyline points="${points.join(' ')}"
      fill="none"
      stroke="${lineColor}"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      opacity="0.85"/>
    <circle cx="${lastX}" cy="${lastY.toFixed(1)}" r="3" fill="${lineColor}"/>
    <circle cx="0" cy="${firstY.toFixed(1)}" r="1.5" fill="#cbd5e1"/>
  </svg>`;
}

// ═══════════════════════════════════════════════════════════════════
// STORAGE
// ═══════════════════════════════════════════════════════════════════

let isSyncing = false;

function loadLocal() {
  // ═══════════════════════════════════════════════════════════════════
  // CLOUD-FIRST: Only read local if explicitly allowed (cloud failed/timed out)
  // ═══════════════════════════════════════════════════════════════════
  if (!boot.allowLocalReads) {
    console.log('⏳ loadLocal blocked: Cloud-first boot in progress');
    return;
  }
  
  try {
    const s = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (s) {
      const d = JSON.parse(s);
      if (d.units?.length) state.units = d.units;
      if (d.settings) state.settings = { ...state.settings, ...d.settings };
      if (d.patients) state.patients = d.patients;
      if (d.unitRequests) state.unitRequests = d.unitRequests;
      if (d.trash) state.trash = { ...state.trash, ...d.trash };
    }
  } catch (e) {}
  if (!state.units.length) state.units = [{ id: 'med-e', name: 'Medicine Unit E', icon: '🏥', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }];
  state.settings.adminPassword = state.settings.adminPassword || CONFIG.ADMIN_PASSWORD;
  // Always use hardcoded API URL - this ensures all users have the correct endpoint
  state.settings.apiUrl = CONFIG.API_URL;
}

// ═══════════════════════════════════════════════════════════════════
// 🚀 PROFESSIONAL-GRADE SYNC SYSTEM v2.0
// ═══════════════════════════════════════════════════════════════════
// Architecture:
// 1. Optimistic UI - state updates instantly, sync happens in background
// 2. Patch Queue - only send what changed, not full snapshots
// 3. Non-blocking saves - localStorage writes in idle time only
// 4. Conditional loads - skip download if revision unchanged
// 5. Debounced batch sync - 800ms debounce, patches batched
// ═══════════════════════════════════════════════════════════════════

// Timers for deferred saves
let localSaveTimer = null;
let fullSnapshotTimer = null;

// ───────────────────────────────────────────────────────────────────
// TIER 1: INSTANT - In-memory only (0ms)
// ───────────────────────────────────────────────────────────────────
function saveLocalLite() {
  // Only save tiny meta - NEVER blocks UI
  try {
    localStorage.setItem('MW_REV', String(sync.clientRev));
    localStorage.setItem('MW_DIRTY', sync.patchQueue.length > 0 ? '1' : '0');
  } catch (e) {}
}

// ───────────────────────────────────────────────────────────────────
// TIER 2: DEFERRED - Full state in idle time (non-blocking)
// ───────────────────────────────────────────────────────────────────
function saveLocalDeferred() {
  // Cancel any pending save
  if (localSaveTimer) cancelIdleCallback(localSaveTimer);
  
  // Schedule for when browser is idle
  if ('requestIdleCallback' in window) {
    localSaveTimer = requestIdleCallback(() => {
      saveLocalNow();
    }, { timeout: 2000 }); // Max 2s wait
  } else {
    setTimeout(saveLocalNow, 100);
  }
}

function saveLocalNow() {
  // ═══════════════════════════════════════════════════════════════════
  // CLOUD-FIRST: Block local writes during boot stability window
  // ═══════════════════════════════════════════════════════════════════
  if (!boot.allowLocalWrites) {
    console.log('⏳ saveLocalNow blocked: Boot stability window active');
    return;
  }
  
  try {
    const payload = JSON.stringify({
      units: state.units,
      settings: state.settings,
      patients: state.patients,
      unitRequests: state.unitRequests,
      trash: state.trash,
      rev: sync.clientRev,
      lastUpdated: new Date().toISOString()
    });
    localStorage.setItem(CONFIG.STORAGE_KEY, payload);
    localStorage.setItem(CONFIG.CACHE_KEY, payload); // Also update cache
  } catch (e) {
    console.warn('⚠️ localStorage save failed:', e);
  }
}

// Legacy compatibility
function saveLocal() {
  saveLocalDeferred();
}

// Lightweight session save (just essentials, synchronous for critical data)
function saveSessionLite() {
  saveLocalLite();
}

// ───────────────────────────────────────────────────────────────────
// TIER 3: PATCH QUEUE - Accumulate changes for batched sync
// ───────────────────────────────────────────────────────────────────

function enqueuePatch(operation, payload) {
  // ═══════════════════════════════════════════════════════════════════
  // CRITICAL GUARD: Block patches until cloud sync completes
  // ═══════════════════════════════════════════════════════════════════
  if (sync.isReadOnly) {
    console.warn('⛔ enqueuePatch blocked: App is in read-only mode');
    return; // Don't queue anything
  }
  
  // Add to queue with timestamp for ordering
  sync.patchQueue.push({ 
    operation, 
    payload,
    ts: Date.now()
  });
  
  // Mark dirty and trigger debounced sync
  markDirty();
}

// Compress patch queue - remove redundant patches
function compressPatchQueue() {
  const queue = sync.patchQueue;
  if (queue.length <= 1) return;
  
  const patientPatches = new Map(); // id -> latest patch
  const unitPatches = new Map();
  const otherPatches = [];
  
  for (const patch of queue) {
    const id = patch.payload?.id;
    
    if (patch.operation === 'updatePatient' && id) {
      // Keep only the latest update for each patient
      const existing = patientPatches.get(id);
      if (existing && existing.operation === 'updatePatient') {
        // Merge payloads
        existing.payload = { ...existing.payload, ...patch.payload };
      } else {
        patientPatches.set(id, patch);
      }
    } else if (patch.operation === 'deletePatient' && id) {
      // Delete supersedes any updates
      patientPatches.set(id, patch);
    } else if (patch.operation === 'addPatient' && id) {
      patientPatches.set(id, patch);
    } else if (patch.operation.includes('Unit') && id) {
      unitPatches.set(id, patch);
    } else {
      otherPatches.push(patch);
    }
  }
  
  // Rebuild queue with compressed patches
  sync.patchQueue = [
    ...patientPatches.values(),
    ...unitPatches.values(),
    ...otherPatches
  ];
}

// ───────────────────────────────────────────────────────────────────
// SYNC STATUS UI
// ───────────────────────────────────────────────────────────────────

function updateSyncStatus(status, message) {
  sync.status = status;
  const el = $('syncStatus');
  const textEl = $('syncStatusText');
  
  if (!el || !textEl) return;
  
  el.className = 'sync-status visible ' + status;
  textEl.textContent = message || {
    synced: 'Synced',
    pending: 'Saving...',
    syncing: 'Syncing...',
    error: 'Sync failed'
  }[status];
  
  if (status === 'synced') {
    setTimeout(() => {
      if (sync.status === 'synced') {
        el.classList.remove('visible');
      }
    }, 2000);
  }
}

// ───────────────────────────────────────────────────────────────────
// MARK DIRTY - Triggers debounced sync
// ───────────────────────────────────────────────────────────────────

function markDirty() {
  // ═══════════════════════════════════════════════════════════════════
  // CRITICAL GUARD: Block ALL changes until cloud sync completes
  // This prevents zombie cache from even queuing up for sync
  // ═══════════════════════════════════════════════════════════════════
  if (sync.isReadOnly) {
    console.warn('⛔ markDirty blocked: App is in read-only mode');
    return; // Don't even set pendingChanges
  }
  
  sync.pendingChanges = true;
  
  // Instant feedback
  updateSyncStatus('pending', 'Saving...');
  
  // Save lite meta immediately (non-blocking)
  saveLocalLite();
  
  // Debounce the actual sync (800ms)
  if (sync.syncTimer) {
    clearTimeout(sync.syncTimer);
  }
  
  sync.syncTimer = setTimeout(() => {
    performSync();
  }, 800); // 800ms debounce for batching
}

// ───────────────────────────────────────────────────────────────────
// PERFORM SYNC - Main sync orchestrator
// ───────────────────────────────────────────────────────────────────

async function performSync() {
  // ═══════════════════════════════════════════════════════════════════
  // CLOUD-FIRST BOOT GUARD - Never upload until cloud boot completes
  // This prevents zombie cache from wiping server data on boot
  // ═══════════════════════════════════════════════════════════════════
  if (!boot.cloudLoaded) {
    console.warn('⛔ Sync blocked: Cloud-first boot not yet complete');
    return;
  }
  
  if (!sync.pendingChanges) return;
  if (sync.isSyncing) {
    // Already syncing - reschedule
    sync.syncTimer = setTimeout(performSync, 500);
    return;
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // HYDRATION GATE - Block sync until we've loaded from cloud
  // ═══════════════════════════════════════════════════════════════════
  if (!sync.isHydrated) {
    console.warn('⛔ Sync blocked: App not yet hydrated from cloud');
    // Don't clear pendingChanges - will retry after hydration
    return;
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // READ-ONLY GATE - Block sync while viewing stale/cached data
  // ═══════════════════════════════════════════════════════════════════
  if (sync.isReadOnly) {
    console.warn('⛔ Sync blocked: App is in read-only mode');
    return;
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // CLIENT-SIDE WIPE GUARD - Extra safety layer
  // ═══════════════════════════════════════════════════════════════════
  const currentPatientCount = state.patients?.length || 0;
  const currentUnitCount = state.units?.length || 0;
  
  if (currentPatientCount === 0 && sync.lastServerPatientCount > 0) {
    console.warn('⛔ Sync blocked: Would wipe', sync.lastServerPatientCount, 'patients with empty state');
    sync.pendingChanges = false;
    updateSyncStatus('error', 'Wipe blocked');
    return;
  }
  
  sync.isSyncing = true;
  
  // Compress patch queue to minimize payload
  compressPatchQueue();
  
  // Schedule deferred local save (non-blocking)
  saveLocalDeferred();
  
  // Check if we have cloud configured
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    sync.pendingChanges = false;
    sync.isSyncing = false;
    updateSyncStatus('synced', 'Saved locally');
    return;
  }
  
  updateSyncStatus('syncing', 'Syncing...');
  
  try {
    let success = false;
    
    if (sync.patchQueue.length > 0) {
      // ═══════════════════════════════════════════════════════════════
      // DELTA SYNC: Send only patches (typically <1KB)
      // ═══════════════════════════════════════════════════════════════
      console.log('⚡ Delta sync:', sync.patchQueue.length, 'patches');
      
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        cache: 'no-store',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'patches',
          username: AUTH.user,
          password: AUTH.pass,
          patches: sync.patchQueue.map(p => ({
            operation: p.operation,
            payload: p.payload
          }))
        })
      });
      
      // Check for HTML response (wrong URL or deployment error)
      const text = await res.text();
      if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
        throw new Error('Server returned HTML - check API URL');
      }
      
      const data = JSON.parse(text);
      
      if (data.success) {
        sync.patchQueue = []; // Clear queue
        sync.clientRev = data.rev || sync.clientRev;
        localStorage.setItem('MW_REV', String(sync.clientRev));
        // Update server counts
        sync.lastServerPatientCount = currentPatientCount;
        sync.lastServerUnitCount = currentUnitCount;
        console.log('✅ Delta sync complete, rev:', sync.clientRev, 'applied:', data.applied);
        success = true;
      } else if (data.retryable) {
        // Server busy - retry
        console.warn('⚠️ Server busy, will retry');
        setTimeout(() => performSync(), 2000);
      } else {
        console.warn('⚠️ Patch sync failed:', data.error);
        // Fall back to snapshot on next sync
      }
    } else {
      // No patches - we're already in sync
      success = true;
    }
    
    if (success) {
      sync.pendingChanges = false;
      sync.lastSyncTime = Date.now();
      sync.errorCount = 0;
      updateSyncStatus('synced', 'Synced');
    } else {
      throw new Error('Sync failed');
    }
    
  } catch (e) {
    console.error('Sync error:', e);
    sync.errorCount++;
    
    if (sync.errorCount >= 3) {
      updateSyncStatus('error', 'Sync failed');
      // After 3 failures, fall back to snapshot on next attempt
      if (sync.patchQueue.length > 0) {
        console.log('📦 Will attempt snapshot sync on retry');
      }
    } else {
      // Retry with exponential backoff
      const delay = Math.min(5000 * sync.errorCount, 15000);
      setTimeout(() => performSync(), delay);
      updateSyncStatus('pending', 'Retrying...');
    }
  } finally {
    sync.isSyncing = false;
  }
}

// ───────────────────────────────────────────────────────────────────
// SNAPSHOT SYNC - Full state upload (fallback / initial sync)
// ───────────────────────────────────────────────────────────────────

async function performSnapshotSync() {
  // ═══════════════════════════════════════════════════════════════════
  // SAFEGUARD: Never overwrite cloud with empty state
  // ═══════════════════════════════════════════════════════════════════
  if (!state.patients || state.patients.length === 0) {
    console.warn('⚠️ SAFEGUARD: Refusing snapshot sync with empty patients');
    return false;
  }
  
  console.log('📦 Snapshot sync:', state.patients.length, 'patients');
  
  const payload = { 
    units: state.units, 
    settings: { 
      adminPassword: state.settings.adminPassword,
      apiUrl: state.settings.apiUrl
    }, 
    patients: state.patients,
    unitRequests: state.unitRequests,
    trash: state.trash
  };
  
  const res = await fetch(state.settings.apiUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({
      action: 'saveData',
      username: AUTH.user,
      password: AUTH.pass,
      payload: payload
    })
  });
  
  if (!res.ok) throw new Error('HTTP ' + res.status);
  
  const data = await res.json();
  if (data.success) {
    if (data.rev) {
      sync.clientRev = data.rev;
      localStorage.setItem('MW_REV', String(sync.clientRev));
    }
    sync.patchQueue = []; // Clear queue since snapshot includes everything
    return true;
  }
  return false;
}

// ───────────────────────────────────────────────────────────────────
// LEGACY COMPATIBILITY
// ───────────────────────────────────────────────────────────────────

async function syncCloud() {
  await syncFromCloud();
}

// NOTE: saveCloud() is now defined in Sync Engine v2.0 (line ~7100)
// Removed duplicate legacy definition to prevent override
// async function saveCloud() {
//   markDirty();
// }

// NOTE: forceSync() is now defined in Sync Engine v2.0 (line ~7108)
// Removed duplicate legacy definition to prevent override
/* LEGACY forceSync - COMMENTED OUT
// Force immediate sync - bypasses debounce for critical operations like lab saves
async function forceSync_LEGACY() {
  // ═══════════════════════════════════════════════════════════════════
  // CLOUD-FIRST BOOT GUARD - Never upload until cloud boot completes
  // ═══════════════════════════════════════════════════════════════════
  if (!boot.cloudLoaded) {
    console.warn('⛔ forceSync blocked: Cloud-first boot not yet complete');
    return false;
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // FIRST-LOGIN GUARD - Never upload until we've downloaded from cloud
  // This prevents new devices from wiping existing cloud data
  // ═══════════════════════════════════════════════════════════════════
  if (!sync.hasEverSyncedThisSession) {
    console.warn('⛔ forceSync blocked: Must download from cloud first (first-login protection)');
    toast('Syncing with cloud first...', false);
    await syncFromCloud();
    if (!sync.hasEverSyncedThisSession) {
      console.error('⛔ Cannot save: Cloud sync failed');
      return false;
    }
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // HYDRATION GATE - Block sync until we've loaded from cloud
  // ═══════════════════════════════════════════════════════════════════
  if (!sync.isHydrated) {
    console.warn('⛔ forceSync blocked: App not yet hydrated from cloud');
    return false;
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // READ-ONLY MODE - Block saves while viewing cached/stale data
  // ═══════════════════════════════════════════════════════════════════
  if (sync.isReadOnly) {
    console.warn('⛔ forceSync blocked: App is in read-only mode (viewing cache)');
    toast('Cannot save while offline/syncing', true);
    return false;
  }
  
  // ═══════════════════════════════════════════════════════════════════
  // SAFEGUARD: Never overwrite cloud with empty state
  // ═══════════════════════════════════════════════════════════════════
  if (!state.patients || state.patients.length === 0) {
    console.warn('⚠️ SAFEGUARD: Refusing to sync empty patients array to cloud');
    console.warn('   This prevents accidental data loss on code updates');
    
    // Try to load from cloud instead
    try {
      await syncFromCloud();
      toast('Data restored from cloud', false);
    } catch (e) {
      console.error('Could not restore from cloud:', e);
    }
    return false;
  }
  
  // Clear any pending debounced sync
  if (sync.syncTimer) {
    clearTimeout(sync.syncTimer);
    sync.syncTimer = null;
  }
  
  // Save locally first (non-blocking)
  saveLocal();
  saveLocalLite();
  
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    console.log('⚠️ No API URL configured - saved locally only');
    updateSyncStatus('synced', 'Saved locally');
    return true;
  }
  
  updateSyncStatus('syncing', 'Saving to cloud...');
  console.log('☁️ Force syncing to cloud...');
  console.log('📦 Patients to save:', state.patients.length);
  
  // Log lab data for debugging
  state.patients.forEach(p => {
    if (p.labData?.parameters?.length) {
      console.log(`   Patient ${p.name}: ${p.labData.parameters.length} lab parameters`);
    }
  });
  
  try {
    // ═══════════════════════════════════════════════════════════════════
    // STRIP apiUrl - Never send to cloud (device-local only)
    // ═══════════════════════════════════════════════════════════════════
    const settingsToSave = { ...state.settings };
    delete settingsToSave.apiUrl;  // CRITICAL: apiUrl stays local only
    
    const payload = { 
      units: state.units, 
      settings: settingsToSave, 
      patients: state.patients,
      unitRequests: state.unitRequests,
      trash: state.trash,
      // ═══════════════════════════════════════════════════════════════════
      // TIMESTAMP for server-side conflict detection (zombie cache protection)
      // ═══════════════════════════════════════════════════════════════════
      updatedAt: sync.lastServerTimestamp || new Date().toISOString()
    };
    
    console.log('📤 Sending payload size:', JSON.stringify(payload).length, 'bytes');
    
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      cache: 'no-store',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'saveData',
        username: AUTH.user,
        password: AUTH.pass,
        payload: payload
      })
    });
    
    const responseText = await res.text();
    console.log('📥 Response:', responseText);
    
    // Check for HTML response
    if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
      throw new Error('Server returned HTML - check API URL');
    }
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (e) {
      throw new Error('Invalid response: ' + responseText.substring(0, 100));
    }
    
    if (!res.ok || !result.success) {
      // ═══════════════════════════════════════════════════════════════════
      // CONFLICT HANDLING - Server rejected stale/zombie cache data
      // ═══════════════════════════════════════════════════════════════════
      if (result.conflict) {
        console.warn('⚠️ CONFLICT: Server has newer data. Reloading...');
        console.warn('   Client timestamp:', result.clientTimestamp);
        console.warn('   Server timestamp:', result.serverTimestamp);
        toast('Data conflict detected. Reloading latest...', true);
        
        // Force reload from cloud (server wins)
        await syncFromCloud();
        return false;
      }
      
      // Check for retryable error
      if (result.retryable) {
        console.log('⏳ Server busy, retrying in 2s...');
        setTimeout(() => forceSync(), 2000);
        return false;
      }
      throw new Error(result.error || 'Save failed');
    }
    
    // Update revision tracking
    if (result.rev) {
      sync.clientRev = result.rev;
      localStorage.setItem('MW_REV', String(sync.clientRev));
      // Clear patch queue since snapshot includes everything
      sync.patchQueue = [];
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // Update server timestamp for conflict detection
    // ═══════════════════════════════════════════════════════════════════
    if (result.timestamp) {
      sync.lastServerTimestamp = result.timestamp;
    }
    
    // Update server counts
    sync.lastServerPatientCount = state.patients.length;
    sync.lastServerUnitCount = state.units.length;
    
    sync.pendingChanges = false;
    sync.lastSyncTime = Date.now();
    sync.errorCount = 0;
    updateSyncStatus('synced', 'Synced');
    console.log('✅ Sync successful at', result.timestamp);
    return true;
    
  } catch (e) {
    console.error('❌ Sync error:', e);
    sync.errorCount++;
    updateSyncStatus('error', 'Sync failed: ' + e.message);
    toast('Failed to save to cloud: ' + e.message, true);
    return false;
  }
}
END OF LEGACY forceSync */

async function manualSync() {
  const syncFab = $('syncFab');
  syncFab.classList.add('syncing');
  updateSyncStatus('syncing', 'Syncing...');
  
  try {
    await syncFromCloud();
    sync.pendingChanges = true;
    await performSync();
    toast('Synced successfully!');
  } catch (e) {
    toast('Sync failed', true);
  }
  
  syncFab.classList.remove('syncing');
}

// NOTE: syncFromCloud() is now defined in Sync Engine v2.0 (line ~7104)
// Removed duplicate legacy definition to prevent override
/* LEGACY syncFromCloud - COMMENTED OUT
async function syncFromCloud_LEGACY() {
  // Show loading status
  showSyncStatusBar('🔄 Connecting to cloud...', 'orange');
  
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    // No cloud configured - hydrate from local only
    sync.isHydrated = true;
    sync.isReadOnly = false;  // ★ UNLOCK for local-only mode
    sync.lastServerPatientCount = state.patients?.length || 0;
    sync.lastServerUnitCount = state.units?.length || 0;
    showSyncStatusBar('📱 Local mode (no cloud)', 'green');
    return;
  }
  
  console.log('🔄 Loading data from cloud (rev:', sync.clientRev, ')...');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      cache: 'no-store',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ 
        action: 'loadData',
        username: AUTH.user,
        password: AUTH.pass,
        clientRev: sync.clientRev  // Send our revision for conditional load
      })
    });
    
    // Check for HTML response (wrong URL)
    const text = await res.text();
    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
      console.error('❌ Server returned HTML - check API URL');
      // Stay read-only but allow viewing cached data
      sync.isHydrated = true;
      // isReadOnly stays TRUE - can view but not save
      console.warn('⚠️ Offline mode: View only, saves disabled');
      return;
    }
    
    const data = JSON.parse(text);
    
    // ═══════════════════════════════════════════════════════════════════
    // CONDITIONAL LOAD: Server returns "unchanged" if we have latest rev
    // ═══════════════════════════════════════════════════════════════════
    if (data.success && data.unchanged) {
      console.log('⚡ Already in sync (rev:', data.rev, ') - no download needed');
      // ✅ OPEN THE GATES - we're in sync
      sync.isHydrated = true;
      sync.isReadOnly = false;  // ★ UNLOCK - can now save
      sync.hasEverSyncedThisSession = true;  // ★ FIRST-LOGIN GUARD passed
      sync.lastServerPatientCount = state.patients?.length || 0;
      sync.lastServerUnitCount = state.units?.length || 0;
      showSyncStatusBar('☁️ Cloud connected', 'green');
      return state; // Return current state, nothing changed
    }
    
    console.log('📥 Cloud data received:', data.success ? 'success' : 'failed');
    
    if (data.success && data.data) {
      // Update revision tracking
      if (data.rev) {
        sync.clientRev = data.rev;
        localStorage.setItem('MW_REV', String(sync.clientRev));
      }
      // Update units - MERGE instead of overwrite to preserve local units
      if (data.data.units?.length) {
        const cloudIds = new Set(data.data.units.map(u => u.id));
        const localOnly = state.units.filter(u => !cloudIds.has(u.id));
        state.units = [...data.data.units, ...localOnly];
        console.log('   Units loaded:', state.units.length);
      }
      
      // Update settings - IMPORTANT: apiUrl stays LOCAL ONLY (never from cloud)
      if (data.data.settings) {
        const localApiUrl = state.settings.apiUrl; // Preserve local
        state.settings = { ...state.settings, ...data.data.settings };
        // ALWAYS keep local apiUrl - never trust cloud for this
        state.settings.apiUrl = localApiUrl;
        console.log('   Settings loaded (apiUrl preserved locally)');
      }
      
      // Update patients - THIS IS KEY FOR MULTI-USER SYNC
      if (data.data.patients) {
        state.patients = data.data.patients;
        console.log('   Patients loaded:', state.patients.length);
        
        // Log lab data for debugging
        state.patients.forEach(p => {
          if (p.labData?.parameters?.length) {
            console.log(`   → ${p.name}: ${p.labData.parameters.length} lab parameters`);
          }
        });
        
        // If we have a current patient open, refresh their reference
        if (state.currentPatient) {
          const refreshedPatient = state.patients.find(p => p.id === state.currentPatient.id);
          if (refreshedPatient) {
            state.currentPatient = refreshedPatient;
            console.log('   Current patient refreshed:', state.currentPatient.name);
          }
        }
      }
      
      // Update unit requests - MERGE instead of overwrite to prevent data loss
      if (data.data.unitRequests && data.data.unitRequests.length > 0) {
        // Merge: keep local requests that aren't in cloud, add/update cloud requests
        const cloudIds = new Set(data.data.unitRequests.map(r => r.id));
        const localOnly = (state.unitRequests || []).filter(r => !cloudIds.has(r.id));
        state.unitRequests = [...data.data.unitRequests, ...localOnly];
      }
      
      // ═══════════════════════════════════════════════════════════════════
      // ✅ OPEN THE GATES - Successfully hydrated from cloud
      // ═══════════════════════════════════════════════════════════════════
      sync.isHydrated = true;
      sync.isReadOnly = false;  // ★ UNLOCK - can now save
      sync.hasEverSyncedThisSession = true;  // ★ FIRST-LOGIN GUARD passed
      sync.lastServerPatientCount = state.patients?.length || 0;
      sync.lastServerUnitCount = state.units?.length || 0;
      sync.lastServerTimestamp = data.data.updatedAt || new Date().toISOString();
      console.log('✅ Hydration complete: isHydrated=true, isReadOnly=false, hasEverSynced=true');
      console.log('   Server counts:', sync.lastServerPatientCount, 'patients,', sync.lastServerUnitCount, 'units');
      console.log('   Server timestamp:', sync.lastServerTimestamp);
      
      // ★ VISUAL: Show connected status
      showSyncStatusBar('☁️ Cloud connected', 'green');
      
      // Save to local storage
      saveLocal();
      
      // Re-render appropriate view
      if (state.currentPatient) {
        renderPatientProfile();
      } else if (state.currentUnit) {
        renderPatients();
      } else {
        renderUnits();
      }
      
      console.log('✅ Cloud sync complete, last updated:', data.data.lastUpdated || 'unknown');
    } else {
      // Load failed but we have local data - allow offline viewing
      console.warn('⚠️ Cloud load returned no data, using local (read-only)');
      sync.isHydrated = true;
      // isReadOnly stays TRUE - prevents zombie cache attack
      sync.lastServerPatientCount = state.patients?.length || 0;
      sync.lastServerUnitCount = state.units?.length || 0;
      showSyncStatusBar('⚠️ Offline - View Only', 'orange');
    }
  } catch (e) {
    console.error('❌ Load from cloud failed:', e);
    // Stay read-only to prevent zombie cache attack
    sync.isHydrated = true;
    // isReadOnly stays TRUE - can view but not save
    console.warn('⚠️ Offline mode: View only, saves disabled');
    sync.lastServerPatientCount = state.patients?.length || 0;
    sync.lastServerUnitCount = state.units?.length || 0;
    showSyncStatusBar('⚠️ Offline - View Only', 'orange');
  }
}
END OF LEGACY syncFromCloud */

function getUnit(id) { return state.units.find(u => u.id == id); }
function getPatient(id) { return state.patients.find(p => p.id == id); }

// ═══════════════════════════════════════════════════════════════════
// FEEDBACK SYSTEM (RLHF)
// ═══════════════════════════════════════════════════════════════════

async function sendFeedback(rating, interpretationType = 'lab') {
  if (!state.currentInteractionId || !state.currentPatient) return;
  
  const p = state.currentPatient;
  
  try {
    await fetch(state.settings.apiUrl, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'recordFeedback',
        interactionId: state.currentInteractionId,
        patientId: p.id,
        interpretationType,
        rating,
        interpretation: p.labData?.interpretation?.summary || '',
        labValues: p.labData?.parameters?.map(param => ({
          name: param.name,
          value: param.values?.[0]?.value,
          status: param.values?.[0]?.status
        })) || [],
        sessionId: state.sessionId
      })
    });
    
    // Update UI
    $$('.feedback-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.feedback-btn.${rating > 0 ? 'positive' : 'negative'}`)?.classList.add('active');
    document.querySelector('.feedback-sent')?.classList.add('show');
    
    toast(rating > 0 ? 'Thanks! This helps improve accuracy.' : 'Feedback noted. We\'ll improve.');
  } catch (e) {
    console.error('Feedback error:', e);
  }
}

window.sendFeedback = sendFeedback;

// ═══════════════════════════════════════════════════════════════════
// RENDER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════

function renderUnits() {
  $('unitsGrid').innerHTML = state.units.map(u => `
    <div class="unit-card" style="--unit-color:${u.color || '#f59e0b'}" data-id="${u.id}">
      <div class="unit-card-icon">${u.icon || '🏥'}</div>
      <div class="unit-card-name">${esc(u.name)}</div>
      <div class="unit-card-desc">${esc(u.desc || '')}</div>
    </div>
  `).join('');
  $$('.unit-card').forEach(c => c.onclick = () => openUnitAccess(c.dataset.id));
}

function renderUnitsTable() {
  const container = $('unitsTable');
  if (!state.units || state.units.length === 0) {
    container.innerHTML = `
      <div class="admin-empty-state">
        <div class="admin-empty-icon">🏥</div>
        <div class="admin-empty-text">No units created yet</div>
        <div class="admin-empty-hint">Click "+ Add Unit" to create your first unit</div>
      </div>
    `;
    return;
  }
  container.innerHTML = state.units.map(u => `
    <div class="admin-unit-card">
      <div class="admin-unit-main">
        <div class="admin-unit-icon">${u.icon || '🏥'}</div>
        <div class="admin-unit-info">
          <div class="admin-unit-name">${esc(u.name || 'Unnamed Unit')}</div>
          <div class="admin-unit-code">Code: <code>${u.code || '----'}</code></div>
        </div>
      </div>
      <div class="admin-unit-actions">
        <button class="admin-action-btn edit" onclick="editUnit('${u.id}')" title="Edit">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="admin-action-btn delete" onclick="deleteUnit('${u.id}')" title="Delete">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
    </div>
  `).join('');
}

// ═══════════════════════════════════════════════════════════════════
// 🏥 ENSURE VALID CURRENT UNIT (auto-select after import)
// ═══════════════════════════════════════════════════════════════════
function ensureValidCurrentUnit() {
  if (!state.units || state.units.length === 0) {
    state.currentUnit = null;
    console.log('ensureValidCurrentUnit: No units available');
    return;
  }

  // If current unit is missing or invalid, select first unit
  const stillExists = state.currentUnit &&
    state.units.some(u => u.id === state.currentUnit.id);

  if (!stillExists) {
    state.currentUnit = state.units[0];
    state.selectedUnitId = state.currentUnit.id;
    console.log('ensureValidCurrentUnit: Auto-selected unit:', state.currentUnit.name);
    
    // Update UI
    const badge = $('unitBadge');
    if (badge) badge.textContent = state.currentUnit.name;
  }
}

function renderPatients() {
  const container = $('patientsList');
  if (!container) return;

  const f = state.currentFilter;
  const allPatients = state.patients || [];

  // ═══════════════════════════════════════════════════════════════════
  // DEBUG LOGGING: Enhanced patient rendering diagnostics
  // ═══════════════════════════════════════════════════════════════════
  console.log('🏥 renderPatients DEBUG:', {
    totalPatients: allPatients.length,
    currentUnit: state.currentUnit?.name,
    currentUnitId: state.currentUnit?.id,
    currentFilter: f,
    storageUnit: sessionStorage.getItem('MW_UNIT'),
    storageUnitName: sessionStorage.getItem('MW_UNIT_NAME'),
    localStorageUnit: localStorage.getItem('MW_SELECTED_UNIT'),
    availableUnits: state.units?.map(u => ({ id: u.id, name: u.name }))
  });
  
  // Filter patients by current unit
  let unitPatients;
  if (state.currentUnit) {
    unitPatients = allPatients.filter(p => p.unitId === state.currentUnit.id);
    console.log('renderPatients: filtered by unit, count:', unitPatients.length);
  } else {
    // No unit selected - show all (fallback)
    unitPatients = allPatients;
    console.log('renderPatients: no unit selected, showing all');
  }
  
  let filtered = f === 'all' ? [...unitPatients] : unitPatients.filter(p => p.status === f);

  // Empty state
  if (!filtered.length) {
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:var(--text-muted);">
        <div style="font-size:2rem; margin-bottom:10px;">📭</div>
        <div>No patients in this unit</div>
      </div>`;
    updateStats();
    return;
  }

  // Group by wards (wards are locations, not units)
  const wards = {};
  filtered.forEach(p => {
    const w = p.ward || 'Unassigned';
    if (!wards[w]) wards[w] = [];
    wards[w].push(p);
  });

  // Render with Clinical Clarity design
  const order = ['Ward 10', 'Ward 19', 'Ward 20', 'Ward 21', 'Ward 22', 'Ward 27', 'Ward 5', 'ICU', 'ER', 'ER/Unassigned', 'Unassigned'];
  let html = '';

  Object.keys(wards).sort((a, b) => {
    const aIdx = order.indexOf(a) === -1 ? 99 : order.indexOf(a);
    const bIdx = order.indexOf(b) === -1 ? 99 : order.indexOf(b);
    if (aIdx !== bIdx) return aIdx - bIdx;
    return a.localeCompare(b);
  }).forEach(ward => {
    const ps = wards[ward];
    html += `<div class="ward-section">
      <div class="ward-header">
        <div class="ward-title">📍 ${esc(ward)}</div>
        <div class="ward-count">${ps.length}</div>
      </div>`;

    ps.forEach(p => {
      const medCount = (p.meds && p.meds.length) || 0;

      // Determine Status Color
      let statusColor = 'var(--primary)';
      if (p.status === 'critical') statusColor = 'var(--danger)';
      else if (p.status === 'new') statusColor = 'var(--success)';
      else if (p.status === 'chronic') statusColor = 'var(--purple)';
      else if (p.ward && p.ward.includes('ICU')) statusColor = 'var(--danger)';

      // Create the row using both patient-card (for compatibility) and patient-row classes
      html += `<div class="patient-card ${p.status}" style="border-left-color:${statusColor}" onclick="openPatientProfile('${p.id}')">
        <div class="p-info">
          <div class="p-name">${esc(p.name)}</div>
          <div class="p-demographics p-details">
            <span style="font-family:'JetBrains Mono'">${esc(p.room || p.bed || 'No Bed')}</span> •
            ${p.age || '—'}y ${p.gender || '—'}
          </div>
        </div>
        <div class="p-meta">
          <div class="p-badge" style="background:var(--primary-light); color:var(--primary-dark);">
            ${medCount} Med${medCount !== 1 ? 's' : ''}
          </div>
          <div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">
            ${esc(ward)}
          </div>
        </div>
      </div>`;
    });
    html += '</div>';
  });

  container.innerHTML = html;
  updateStats();
}

function updateStats() {
  // Filter patients by current unit
  const allPatients = state.patients || [];

  // ═══════════════════════════════════════════════════════════════════
  // DEBUG LOGGING: Diagnose why stats might show zero
  // ═══════════════════════════════════════════════════════════════════
  console.log('📊 updateStats DEBUG:', {
    totalPatients: allPatients.length,
    currentUnitId: state.currentUnit?.id,
    currentUnitName: state.currentUnit?.name,
    patientUnitIds: [...new Set(allPatients.map(p => p.unitId))],
    samplePatients: allPatients.slice(0, 3).map(p => ({ id: p.id, name: p.name, unitId: p.unitId }))
  });

  const a = state.currentUnit
    ? allPatients.filter(p => p.unitId === state.currentUnit.id)
    : allPatients;

  // Log if there's a mismatch
  if (allPatients.length > 0 && a.length === 0 && state.currentUnit) {
    console.warn('⚠️ UNIT MISMATCH DETECTED!', {
      currentUnitId: state.currentUnit.id,
      availableUnitIds: [...new Set(allPatients.map(p => p.unitId))],
      hint: 'Patients exist but none match the current unit ID'
    });
  }

  $('statTotal').textContent = a.length;
  $('statNew').textContent = a.filter(p => p.status === 'new').length;
  $('statActive').textContent = a.filter(p => p.status === 'active').length;
  $('statCritical').textContent = a.filter(p => p.status === 'critical').length;
  $('statChronic').textContent = a.filter(p => p.status === 'chronic').length;
  $$('.stat-card').forEach(s => s.classList.toggle('active', s.dataset.filter === state.currentFilter));
}

function renderRef() {
  $('refGrid').innerHTML = REFS.map(r => `<div class="ref-card"><h4>${r.title}</h4><p>${r.content}</p></div>`).join('');
}

// ═══════════════════════════════════════════════════════════════════
// CLINICAL SCORING SYSTEM
// ═══════════════════════════════════════════════════════════════════

let currentScoreId = null;
let currentScoreValues = {};

const SCORE_CATEGORY_ICONS = {
  'Cardiac': '❤️',
  'Respiratory': '🫁',
  'Neurological': '🧠',
  'GI': '🫃',
  'Critical Care': '🏥',
  'Renal': '🫘',
  'Vascular': '🩸',
  'Surgical': '🔪'
};

function renderScoresGrid() {
  const categories = {};
  Object.entries(SCORING_CALCULATORS).forEach(([id, score]) => {
    const cat = score.category || 'Other';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push({ id, ...score });
  });
  
  let html = '';
  Object.entries(categories).forEach(([category, scores]) => {
    const icon = SCORE_CATEGORY_ICONS[category] || '📊';
    html += `
      <div class="emergency-score-group">
        <div class="emergency-score-group-header">
          <span class="emergency-score-group-icon">${icon}</span>
          <span class="emergency-score-group-title">${category}</span>
        </div>
        <div class="emergency-score-group-body">
          ${scores.map(s => `
            <div class="emergency-score-item" onclick="openScoreCalculator('${s.id}')">
              <div class="emergency-score-item-info">
                <div class="emergency-score-item-name">${s.name}</div>
                <div class="emergency-score-item-purpose">${s.purpose}</div>
              </div>
              <button class="emergency-score-item-btn">Calculate</button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });
  
  $('scoresGrid').innerHTML = html;
}

window.filterScores = function(query) {
  const q = query.toLowerCase().trim();
  const groups = $$('.emergency-score-group');
  
  groups.forEach(group => {
    const items = group.querySelectorAll('.emergency-score-item');
    let visibleCount = 0;
    
    items.forEach(item => {
      const name = item.querySelector('.emergency-score-item-name').textContent.toLowerCase();
      const purpose = item.querySelector('.emergency-score-item-purpose').textContent.toLowerCase();
      const match = !q || name.includes(q) || purpose.includes(q);
      item.style.display = match ? 'flex' : 'none';
      if (match) visibleCount++;
    });
    
    group.style.display = visibleCount > 0 ? 'block' : 'none';
  });
};

window.openScoreCalculator = function(scoreId) {
  const score = SCORING_CALCULATORS[scoreId];
  if (!score) return;
  
  currentScoreId = scoreId;
  currentScoreValues = {};
  
  const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
  $('scoreCalcTitle').textContent = score.name;
  $('scoreCalcPurpose').textContent = score.purpose;
  $('scoreCalcCategory').innerHTML = `${icon} ${score.category}`;
  
  // Show save button only if patient is open
  $('saveScoreBtn').style.display = state.currentPatient ? 'block' : 'none';
  
  // Get patient lab data for auto-calculation
  const patientLabs = getPatientLabValues();
  const autoCalcData = getAutoCalcForScore(scoreId, patientLabs);
  
  // Render fields with improved design
  let fieldsHtml = '';
  
  // If we have auto-calculated result, show it first
  if (autoCalcData.hasAuto) {
    fieldsHtml += `
      <div class="score-auto-calc">
        <div class="score-auto-calc-header">
          <div class="score-auto-calc-title">
            <span>🤖 Auto-calculated from Labs</span>
            <span class="score-auto-calc-badge">SMART</span>
          </div>
          <button class="score-manual-toggle" onclick="toggleManualMode()">Enter manually</button>
        </div>
        <div class="score-auto-calc-value">${autoCalcData.display}</div>
        <div class="score-auto-calc-source">${autoCalcData.source}</div>
      </div>
      <div id="manualScoreFields" style="display:none">
    `;
    
    // Set the auto-calculated values
    Object.assign(currentScoreValues, autoCalcData.values);
  }
  
  let fieldIndex = 0;
  score.fields.forEach(field => {
    fieldIndex++;
    
    if (field.type === 'checkbox') {
      const pointsDisplay = field.points > 0 ? `+${field.points}` : field.points;
      fieldsHtml += `
        <div class="score-field" onclick="toggleScoreCheckbox('${field.id}', ${field.points || 1})">
          <div class="score-field-checkbox" id="check_${field.id}"></div>
          <div class="score-field-label">${field.label}</div>
          <div class="score-field-points">${pointsDisplay}</div>
        </div>
      `;
      currentScoreValues[field.id] = currentScoreValues[field.id] || 0;
    } else if (field.type === 'select') {
      const preselectedValue = currentScoreValues[field.id] || '';
      fieldsHtml += `
        <div class="score-field" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="score-field-select">
            <label>${fieldIndex}. ${field.label}</label>
            <select id="select_${field.id}" onchange="updateScoreSelect('${field.id}', this.value)">
              <option value="">Select an option...</option>
              ${field.options.map(o => `<option value="${o.value}" ${o.value == preselectedValue ? 'selected' : ''}>${o.label}</option>`).join('')}
            </select>
          </div>
        </div>
      `;
      currentScoreValues[field.id] = currentScoreValues[field.id] || 0;
    } else if (field.type === 'number') {
      const prefilledValue = currentScoreValues[field.id] || '';
      fieldsHtml += `
        <div class="score-field" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="score-field-number">
            <label>${field.label}</label>
            <input type="number" id="num_${field.id}" min="${field.min || 0}" max="${field.max || 100}" step="${field.step || 1}" value="${prefilledValue}" placeholder="0" onchange="updateScoreNumber('${field.id}', this.value)" oninput="updateScoreNumber('${field.id}', this.value)">
          </div>
        </div>
      `;
      if (currentScoreValues[field.id] === undefined) currentScoreValues[field.id] = null;
    }
  });
  
  if (autoCalcData.hasAuto) {
    fieldsHtml += '</div>';
  }
  
  $('scoreCalcFields').innerHTML = fieldsHtml;
  updateScoreResult();
  openModal('scoreCalcModal');
};

// Get patient's lab values in a normalized format
function getPatientLabValues() {
  if (!state.currentPatient?.labData?.parameters) return {};
  
  const labs = {};
  const params = state.currentPatient.labData.parameters;
  
  params.forEach(p => {
    const name = p.name.toLowerCase();
    const value = parseFloat(p.value);
    if (isNaN(value)) return;
    
    // Normalize common lab names
    if (name.includes('creatinine') || name.includes('creat')) labs.creatinine = value;
    if (name.includes('urea') || name === 'bun') labs.urea = value;
    if (name.includes('egfr')) labs.egfr = value;
    if (name.includes('bilirubin') && !name.includes('direct')) labs.bilirubin = value;
    if (name.includes('inr')) labs.inr = value;
    if (name.includes('albumin')) labs.albumin = value;
    if (name.includes('sodium') || name === 'na') labs.sodium = value;
    if (name.includes('potassium') || name === 'k') labs.potassium = value;
    if (name.includes('hemoglobin') || name === 'hgb' || name === 'hb') labs.hemoglobin = value;
    if (name.includes('platelet')) labs.platelets = value;
    if (name.includes('wbc') || name.includes('white')) labs.wbc = value;
    if (name.includes('lactate')) labs.lactate = value;
    if (name.includes('glucose') || name === 'gluc') labs.glucose = value;
  });
  
  return labs;
}

// Get auto-calculation data for specific scores
function getAutoCalcForScore(scoreId, labs) {
  const result = { hasAuto: false, display: '', source: '', values: {} };
  
  if (!state.currentPatient) return result;
  
  // KDIGO AKI - Auto-calculate from creatinine
  if (scoreId === 'KDIGO-AKI' && labs.creatinine) {
    const cr = labs.creatinine;
    const baseline = state.currentPatient.baselineCreatinine || 1.0; // Default baseline
    const ratio = cr / baseline;
    
    let stage = 1;
    if (cr >= 4.0 || ratio >= 3) stage = 3;
    else if (ratio >= 2) stage = 2;
    else if (cr >= baseline + 0.3 || ratio >= 1.5) stage = 1;
    else stage = 0;
    
    if (stage > 0) {
      result.hasAuto = true;
      result.display = `Stage ${stage}`;
      result.source = `Based on Cr: ${cr} mg/dL (baseline: ${baseline})`;
      result.values = { stage: stage };
    }
  }
  
  // MELD Score - Auto-calculate from labs
  if (scoreId === 'MELD' && labs.creatinine && labs.bilirubin && labs.inr) {
    result.hasAuto = true;
    result.values = {
      creatinine: labs.creatinine,
      bilirubin: labs.bilirubin,
      inr: labs.inr
    };
    
    const cr = Math.min(Math.max(labs.creatinine, 1), 4);
    const bili = Math.max(labs.bilirubin, 1);
    const inr = Math.max(labs.inr, 1);
    const meld = Math.round(10 * (0.957 * Math.log(cr) + 0.378 * Math.log(bili) + 1.12 * Math.log(inr) + 0.643));
    
    result.display = Math.min(Math.max(meld, 6), 40).toString();
    result.source = `Cr: ${labs.creatinine} | Bili: ${labs.bilirubin} | INR: ${labs.inr}`;
  }
  
  // Child-Pugh - Partial auto-fill
  if (scoreId === 'Child-Pugh') {
    if (labs.bilirubin || labs.albumin || labs.inr) {
      result.hasAuto = true;
      result.source = 'Partial data from labs';
      
      const parts = [];
      if (labs.bilirubin) {
        result.values.bilirubin = labs.bilirubin < 2 ? 1 : labs.bilirubin <= 3 ? 2 : 3;
        parts.push(`Bili: ${labs.bilirubin}`);
      }
      if (labs.albumin) {
        result.values.albumin = labs.albumin > 3.5 ? 1 : labs.albumin >= 2.8 ? 2 : 3;
        parts.push(`Alb: ${labs.albumin}`);
      }
      if (labs.inr) {
        result.values.inr = labs.inr < 1.7 ? 1 : labs.inr <= 2.3 ? 2 : 3;
        parts.push(`INR: ${labs.inr}`);
      }
      
      const total = (result.values.bilirubin || 0) + (result.values.albumin || 0) + (result.values.inr || 0);
      result.display = `${total}+ pts`;
      result.source = parts.join(' | ') + ' (complete manually)';
    }
  }
  
  // Glasgow-Blatchford - Auto-fill from labs
  if (scoreId === 'Glasgow-Blatchford') {
    if (labs.urea || labs.hemoglobin) {
      result.hasAuto = true;
      const parts = [];
      
      if (labs.urea) {
        // BUN scoring
        let bunScore = 0;
        if (labs.urea >= 25) bunScore = 6;
        else if (labs.urea >= 10) bunScore = 4;
        else if (labs.urea >= 8) bunScore = 3;
        else if (labs.urea >= 6.5) bunScore = 2;
        result.values.bun = bunScore;
        parts.push(`Urea: ${labs.urea}`);
      }
      
      if (labs.hemoglobin) {
        // Simplified - assuming male for now
        let hgbScore = 0;
        if (labs.hemoglobin < 10) hgbScore = 6;
        else if (labs.hemoglobin < 12) hgbScore = 3;
        else if (labs.hemoglobin < 13) hgbScore = 1;
        result.values.hgb_male = hgbScore;
        parts.push(`Hgb: ${labs.hemoglobin}`);
      }
      
      result.display = 'Partial';
      result.source = parts.join(' | ') + ' (add vitals)';
    }
  }
  
  return result;
}

window.toggleManualMode = function() {
  const manualFields = $('manualScoreFields');
  const autoCalc = document.querySelector('.score-auto-calc');
  
  if (manualFields.style.display === 'none') {
    manualFields.style.display = 'block';
    autoCalc.style.opacity = '0.5';
  } else {
    manualFields.style.display = 'none';
    autoCalc.style.opacity = '1';
  }
};

window.toggleScoreCheckbox = function(fieldId, points) {
  const checkbox = $('check_' + fieldId);
  const field = checkbox.closest('.score-field');
  
  if (checkbox.classList.contains('checked')) {
    checkbox.classList.remove('checked');
    field.classList.remove('checked');
    currentScoreValues[fieldId] = 0;
  } else {
    checkbox.classList.add('checked');
    field.classList.add('checked');
    currentScoreValues[fieldId] = points;
  }
  
  updateScoreResult();
};

window.updateScoreSelect = function(fieldId, value) {
  currentScoreValues[fieldId] = parseFloat(value) || 0;
  updateScoreResult();
};

window.updateScoreNumber = function(fieldId, value) {
  currentScoreValues[fieldId] = parseFloat(value) || null;
  updateScoreResult();
};

function updateScoreResult() {
  const score = SCORING_CALCULATORS[currentScoreId];
  if (!score) return;
  
  // Calculate total
  let total = 0;
  let maxScore = 0;
  
  score.fields.forEach(field => {
    const val = currentScoreValues[field.id];
    if (field.type === 'checkbox') {
      total += val || 0;
      maxScore += Math.abs(field.points) || 1;
    } else if (field.type === 'select' && field.options) {
      total += val || 0;
      maxScore += Math.max(...field.options.map(o => Math.abs(o.value)));
    }
  });
  
  // Special handling for MELD score calculation
  if (currentScoreId === 'MELD') {
    const cr = currentScoreValues.creatinine || 1;
    const bili = currentScoreValues.bilirubin || 1;
    const inr = currentScoreValues.inr || 1;
    const dialysis = currentScoreValues.dialysis || 0;
    
    const crVal = Math.min(Math.max(dialysis ? 4 : cr, 1), 4);
    const biliVal = Math.max(bili, 1);
    const inrVal = Math.max(inr, 1);
    
    total = Math.round(10 * (0.957 * Math.log(crVal) + 0.378 * Math.log(biliVal) + 1.12 * Math.log(inrVal) + 0.643));
    total = Math.min(Math.max(total, 6), 40);
    maxScore = 40;
  }
  
  $('scoreResultValue').textContent = total;
  $('scoreResultMax').textContent = maxScore > 0 ? `of ${maxScore}` : '';
  
  // Find interpretation
  const interp = score.interpretation.find(i => total >= i.min && total <= i.max) || score.interpretation[score.interpretation.length - 1];
  
  if (interp) {
    const interpEl = $('scoreResultInterpretation');
    
    // Create gradient based on risk color
    const baseColor = interp.color;
    interpEl.style.background = `linear-gradient(135deg, ${baseColor}22 0%, ${baseColor}11 100%)`;
    interpEl.style.border = `1px solid ${baseColor}40`;
    interpEl.style.color = '#f1f5f9';
    
    let statsHtml = '';
    Object.entries(interp).forEach(([key, val]) => {
      if (!['min', 'max', 'risk', 'action', 'color'].includes(key)) {
        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        statsHtml += `
          <div class="score-result-stat">
            <div class="score-result-stat-value" style="color:${baseColor}">${val}</div>
            <div class="score-result-stat-label">${label}</div>
          </div>
        `;
      }
    });
    
    interpEl.innerHTML = `
      <div class="score-result-risk" style="color:${baseColor}">${interp.risk}</div>
      <div class="score-result-action">${interp.action}</div>
      ${statsHtml ? `<div class="score-result-stats">${statsHtml}</div>` : ''}
    `;
  }
}

window.savePatientScore = function() {
  if (!state.currentPatient || !currentScoreId) return;
  
  const score = SCORING_CALCULATORS[currentScoreId];
  if (!score) return;
  
  // Calculate total
  let total = 0;
  score.fields.forEach(field => {
    const val = currentScoreValues[field.id];
    if (field.type === 'checkbox' || field.type === 'select') {
      total += val || 0;
    }
  });
  
  // Handle MELD special calculation
  if (currentScoreId === 'MELD') {
    const cr = currentScoreValues.creatinine || 1;
    const bili = currentScoreValues.bilirubin || 1;
    const inr = currentScoreValues.inr || 1;
    const dialysis = currentScoreValues.dialysis || 0;
    const crVal = Math.min(Math.max(dialysis ? 4 : cr, 1), 4);
    total = Math.round(10 * (0.957 * Math.log(crVal) + 0.378 * Math.log(Math.max(bili, 1)) + 1.12 * Math.log(Math.max(inr, 1)) + 0.643));
    total = Math.min(Math.max(total, 6), 40);
  }
  
  const interp = score.interpretation.find(i => total >= i.min && total <= i.max) || score.interpretation[score.interpretation.length - 1];
  
  // Initialize scores array if needed
  if (!state.currentPatient.scores) state.currentPatient.scores = [];
  
  // Add or update score
  const existingIdx = state.currentPatient.scores.findIndex(s => s.id === currentScoreId);
  const scoreEntry = {
    id: currentScoreId,
    name: score.name,
    value: total,
    risk: interp?.risk || 'Unknown',
    color: interp?.color || '#6b7280',
    date: new Date().toISOString(),
    values: { ...currentScoreValues }
  };
  
  if (existingIdx >= 0) {
    state.currentPatient.scores[existingIdx] = scoreEntry;
  } else {
    state.currentPatient.scores.push(scoreEntry);
  }
  
  saveCloud();
  closeModal('scoreCalcModal');
  toast(`${score.name}: ${total} saved!`);
  
  if ($('profileScores')) renderProfileScores();
};

function getRelevantScoresForPatient(patient) {
  if (!patient?.diagnosis) return [];
  
  const dx = patient.diagnosis.toLowerCase();
  const relevantScores = new Set();
  
  // Check each diagnosis keyword
  Object.entries(PATIENT_SCORES).forEach(([keyword, scores]) => {
    if (dx.includes(keyword.toLowerCase())) {
      scores.forEach(s => relevantScores.add(s));
    }
  });
  
  // Always include some universal scores
  if (patient.status === 'critical') {
    ['qSOFA', 'SOFA', 'NEWS2', 'Glasgow-Coma'].forEach(s => relevantScores.add(s));
  }
  
  return Array.from(relevantScores).filter(s => SCORING_CALCULATORS[s]);
}

function renderProfileScores() {
  const p = state.currentPatient;
  if (!p) return;
  
  const relevantScores = getRelevantScoresForPatient(p);
  const savedScores = p.scores || [];
  
  let html = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">📊 Clinical Scores</div>
      </div>
      <div class="section-body">
  `;
  
  // Relevant scores based on diagnosis
  if (relevantScores.length > 0) {
    html += `
      <div class="patient-scores-section">
        <div class="patient-scores-header">
          <div class="patient-scores-title">Recommended for this patient</div>
        </div>
        <div class="patient-scores-grid">
    `;
    
    relevantScores.forEach(scoreId => {
      const score = SCORING_CALCULATORS[scoreId];
      const saved = savedScores.find(s => s.id === scoreId);
      const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
      
      let valueClass = '';
      if (saved) {
        const interp = score.interpretation.find(i => saved.value >= i.min && saved.value <= i.max);
        if (interp) {
          if (interp.color === '#10b981' || interp.color === '#22c55e') valueClass = 'low';
          else if (interp.color === '#f59e0b') valueClass = 'moderate';
          else valueClass = 'high';
        }
      }
      
      html += `
        <div class="patient-score-chip ${saved ? 'has-value' : ''}" onclick="openScoreCalculator('${scoreId}')">
          <span class="score-chip-icon">${icon}</span>
          <span class="score-chip-name">${score.name.replace(' Score', '').replace(' Classification', '')}</span>
          ${saved ? `<span class="score-chip-value ${valueClass}">${saved.value}</span>` : ''}
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  // Saved scores history
  if (savedScores.length > 0) {
    html += `
      <div class="patient-scores-section" style="margin-top:24px">
        <div class="patient-scores-header">
          <div class="patient-scores-title">Calculated Scores</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
    `;
    
    savedScores.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(saved => {
      html += `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg);border-radius:var(--radius-sm);border-left:3px solid ${saved.color}">
          <div>
            <div style="font-weight:600;font-size:0.9rem">${saved.name}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">${formatDateTime(saved.date)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700;color:${saved.color}">${saved.value}</div>
            <div style="font-size:0.7rem;color:${saved.color}">${saved.risk}</div>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  // Quick access to all scores
  html += `
    <div class="patient-scores-section" style="margin-top:24px">
      <div class="patient-scores-header">
        <div class="patient-scores-title">All Available Scores</div>
      </div>
      <div class="patient-scores-grid">
  `;
  
  Object.entries(SCORING_CALCULATORS).slice(0, 12).forEach(([id, score]) => {
    const icon = SCORE_CATEGORY_ICONS[score.category] || '📊';
    const saved = savedScores.find(s => s.id === id);
    
    html += `
      <div class="patient-score-chip ${saved ? 'has-value' : ''}" onclick="openScoreCalculator('${id}')">
        <span class="score-chip-icon">${icon}</span>
        <span class="score-chip-name">${score.name.replace(' Score', '').replace(' Classification', '').substring(0, 15)}</span>
      </div>
    `;
  });
  
  html += `
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%" onclick="showTab('scores')">View All Scores →</button>
      </div>
    </div>
  </div>`;
  
  $('profileScores').innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════════
// PATIENT PROFILE
// ═══════════════════════════════════════════════════════════════════

window.openPatientProfile = function(id) {
  const p = getPatient(id);
  if (!p) return;
  state.currentPatient = p;
  state.currentInteractionId = null;
  if (!p.labData) p.labData = { dates: [], parameters: [], interpretation: null };
  if (!p.imaging) p.imaging = [];
  if (!p.fluids) p.fluids = [];
  if (!p.plans) p.plans = [];
  if (!p.vitals) p.vitals = {};
  if (!p.history) p.history = '';
  if (!p.scores) p.scores = [];
  renderPatientProfile();
  showPage('patientProfile');
};

window.closePatientProfile = function() {
  state.currentPatient = null;
  state.currentInteractionId = null;
  if (state.trendChart) { state.trendChart.destroy(); state.trendChart = null; }
  if (state.fluidChart) { state.fluidChart.destroy(); state.fluidChart = null; }
  showPage('dashboard');
  renderPatients();
};

function renderPatientProfile() {
  const p = state.currentPatient;
  if (!p) return;
  
  const avatarBg = p.status === 'critical' ? 'var(--rose),var(--orange)' : 
                   p.status === 'chronic' ? 'var(--purple),#a855f7' :
                   p.status === 'discharged' ? 'var(--text-muted),#4b5563' :
                   p.status === 'new' ? 'var(--emerald),var(--teal)' : 'var(--gold),var(--orange)';
  
  // Update discharge button visibility
  const dischargeBtn = $('profileDischargeBtn');
  if (dischargeBtn) dischargeBtn.style.display = p.status === 'discharged' ? 'none' : '';
  
  $('profilePatientInfo').innerHTML = `
    <div class="profile-avatar" style="background:linear-gradient(135deg,${avatarBg})">${initials(p.name)}</div>
    <div class="profile-details">
      <h2>${esc(p.name)}</h2>
      <div class="meta">
        <span>🛏️ ${esc(p.ward)} • ${esc(p.room || '—')}</span>
        <span>👨‍⚕️ ${esc(p.doctor || 'Unassigned')}</span>
        <span class="badge badge-${p.status === 'critical' ? 'rose' : p.status === 'chronic' ? 'purple' : p.status === 'discharged' ? 'secondary' : p.status === 'new' ? 'emerald' : 'teal'}">${p.status}</span>
        ${p.dischargeDate ? `<span style="font-size:0.75rem;color:var(--text-muted)">📅 Discharged ${formatShortDate(p.dischargeDate)}</span>` : ''}
      </div>
    </div>
  `;
  
  renderProfileOverview();
  renderProfileMeds();
  renderProfileHistory();
  renderProfileScores();
  renderProfileLabs();
  renderProfileImaging();
  renderProfileFluids();
  renderProfilePlans();
  updateProfileBadges();
}

// ═══════════════════════════════════════════════════════════════════
// MEDICATIONS MODULE - Pristine Pharmaceutical Design
// ═══════════════════════════════════════════════════════════════════

function renderProfileMeds() {
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];
  
  const activeMeds = p.medications.filter(m => m.status !== 'discontinued');
  const discontinuedMeds = p.medications.filter(m => m.status === 'discontinued');
  
  // SVG Icons for Prestige UI
  const medIcons = {
    upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
    scan: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>',
    plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
    reconcile: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M16 3h5v5"/><path d="M8 21H3v-5"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>',
    pill: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 117-7l7 7a4.95 4.95 0 11-7 7z"/><path d="M8.5 8.5l7 7"/></svg>',
    search: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>',
    loader: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" class="spin"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/></svg>'
  };
  
  let html = `
    <div class="meds-container">
      <!-- Prestige Upload Zone -->
      <div class="pharmacy-upload ${state.isAnalyzingMeds ? 'analyzing' : ''}" onclick="${state.isAnalyzingMeds ? '' : 'triggerMedsUpload()'}">
        <div class="pharmacy-upload-icon">
          ${state.isAnalyzingMeds ? medIcons.loader : medIcons.upload}
        </div>
        <div class="pharmacy-upload-content">
          <div class="pharmacy-upload-title">${state.isAnalyzingMeds ? 'Analyzing...' : 'Upload Medication List'}</div>
          <div class="pharmacy-upload-hint">Photo of med list, MAR sheet, or EMR screen</div>
        </div>
      </div>
      
      <!-- Prestige Quick Actions -->
      <div class="pharmacy-actions">
        <button class="pharmacy-action-btn primary" onclick="triggerMedScan()">
          ${medIcons.scan}
          <span>Scan Drug</span>
        </button>
        <button class="pharmacy-action-btn" onclick="showAddMedForm()">
          ${medIcons.plus}
          <span>Add Manually</span>
        </button>
        <button class="pharmacy-action-btn" onclick="reconcileMeds()">
          ${medIcons.reconcile}
          <span>Reconcile</span>
        </button>
      </div>
  `;
  
  // Active Medications
  if (activeMeds.length > 0) {
    html += `
      <div class="pharmacy-section-header">
        <span class="pharmacy-section-title">Active Medications</span>
        <span class="pharmacy-count">${activeMeds.length} active</span>
      </div>
    `;
    
    activeMeds.forEach((med, idx) => {
      const realIdx = p.medications.indexOf(med);
      html += renderMedCard(med, realIdx);
    });
  }
  
  // Discontinued
  if (discontinuedMeds.length > 0) {
    html += `
      <div class="pharmacy-section-header" style="margin-top:20px">
        <span class="pharmacy-section-title">Discontinued</span>
        <span class="pharmacy-count discontinued">${discontinuedMeds.length}</span>
      </div>
    `;
    
    discontinuedMeds.forEach((med, idx) => {
      const realIdx = p.medications.indexOf(med);
      html += renderMedCard(med, realIdx);
    });
  }
  
  // Empty State
  if (p.medications.length === 0) {
    html += `
      <div class="pharmacy-empty">
        <div class="pharmacy-empty-icon">${medIcons.pill}</div>
        <div class="pharmacy-empty-title">No medications recorded</div>
        <div class="pharmacy-empty-hint">Upload a photo or add manually</div>
      </div>
    `;
  }
  
  html += `
      <!-- Prestige Add Med Form (hidden by default) -->
      <div class="pharmacy-form-overlay" id="medAddForm" style="display:none">
        <div class="pharmacy-form">
          <div class="pharmacy-form-header">
            <div class="pharmacy-form-title">
              ${medIcons.pill}
              <span>Add Medication</span>
            </div>
            <button class="icon-btn" onclick="hideAddMedForm()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          
          <!-- Drug Search -->
          <div class="pharmacy-search-section">
            <div class="pharmacy-search-box">
              ${medIcons.search}
              <input type="text" class="pharmacy-search-input" id="medName" placeholder="Search drug name (e.g., Lasix, Metformin)..." oninput="filterMedSuggestions(this.value)" autocomplete="off">
            </div>
            <div class="pharmacy-suggestions" id="medSuggestionChips"></div>
          </div>
          
          <!-- Dose & Frequency Row -->
          <div class="pharmacy-dose-row">
            <div class="pharmacy-field">
              <label class="pharmacy-label">Dose</label>
              <input type="text" class="pharmacy-input" id="medDose" placeholder="e.g., 40mg">
            </div>
            <div class="pharmacy-field">
              <label class="pharmacy-label">Generic</label>
              <input type="text" class="pharmacy-input" id="medGeneric" placeholder="Optional">
            </div>
          </div>
          
          <!-- Route Selection -->
          <div class="pharmacy-field">
            <label class="pharmacy-label">Route</label>
            <div class="pharmacy-chips" id="medRouteChips">
              <button type="button" class="pharmacy-chip selected" data-value="PO">PO</button>
              <button type="button" class="pharmacy-chip" data-value="IV">IV</button>
              <button type="button" class="pharmacy-chip" data-value="IM">IM</button>
              <button type="button" class="pharmacy-chip" data-value="SC">SC</button>
              <button type="button" class="pharmacy-chip" data-value="INH">INH</button>
              <button type="button" class="pharmacy-chip" data-value="TOP">TOP</button>
              <button type="button" class="pharmacy-chip" data-value="SL">SL</button>
            </div>
            <input type="hidden" id="medRoute" value="PO">
          </div>
          
          <!-- Frequency Selection -->
          <div class="pharmacy-field">
            <label class="pharmacy-label">Frequency</label>
            <div class="pharmacy-chips" id="medFreqChips">
              <button type="button" class="pharmacy-chip selected" data-value="OD">OD</button>
              <button type="button" class="pharmacy-chip" data-value="BD">BD</button>
              <button type="button" class="pharmacy-chip" data-value="TDS">TDS</button>
              <button type="button" class="pharmacy-chip" data-value="QID">QID</button>
              <button type="button" class="pharmacy-chip" data-value="Q6H">Q6H</button>
              <button type="button" class="pharmacy-chip" data-value="Q8H">Q8H</button>
              <button type="button" class="pharmacy-chip" data-value="PRN">PRN</button>
            </div>
            <input type="hidden" id="medFreq" value="OD">
          </div>
          
          <!-- Indication -->
          <div class="pharmacy-field">
            <label class="pharmacy-label">Indication</label>
            <input type="text" class="pharmacy-input" id="medIndication" placeholder="e.g., Hypertension, Heart Failure">
          </div>
          
          <!-- Status -->
          <div class="pharmacy-field">
            <label class="pharmacy-label">Status</label>
            <div class="pharmacy-status-chips" id="medStatusOptions">
              <button type="button" class="pharmacy-status active selected" data-value="active">Active</button>
              <button type="button" class="pharmacy-status new" data-value="new">New</button>
              <button type="button" class="pharmacy-status prn" data-value="prn">PRN</button>
            </div>
            <input type="hidden" id="medStatus" value="active">
          </div>
          
          <!-- Actions -->
          <div class="pharmacy-form-actions">
            <button class="btn btn-secondary" onclick="hideAddMedForm()">Cancel</button>
            <button class="btn btn-primary" onclick="saveMedication()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  $('profileMeds').innerHTML = html;
}

function renderMedCard(med, idx) {
  const statusClass = med.status || 'active';
  const statusLabels = { active: 'Active', new: 'New', prn: 'PRN', discontinued: 'Stopped' };
  const drugNameEsc = esc(med.name).replace(/'/g, "\\'");
  
  return `
    <div class="med-card">
      <div class="med-card-header">
        <div class="med-card-main">
          <div class="med-card-name">
            ${esc(med.name)}
            <span class="med-status ${statusClass}">${statusLabels[statusClass] || statusClass}</span>
          </div>
          ${med.generic ? `<div class="med-card-generic">${esc(med.generic)}</div>` : ''}
        </div>
        <div class="med-card-actions">
          <button class="med-card-action" onclick="editMedication(${idx})" title="Edit">✏️</button>
          <button class="med-card-action delete" onclick="deleteMedication(${idx})" title="Delete">🗑️</button>
        </div>
      </div>
      <div class="med-card-dose">
        <div class="med-dose-item"><span class="value">${esc(med.dose || '—')}</span></div>
        <div class="med-dose-item"><span class="label">Route</span><span class="value">${esc(med.route || 'PO')}</span></div>
        <div class="med-dose-item"><span class="label">Freq</span><span class="value">${esc(med.frequency || 'OD')}</span></div>
      </div>
      ${med.indication ? `
        <div class="med-card-indication">
          <div class="med-indication-label">Indication</div>
          <div class="med-indication-text">${esc(med.indication)}</div>
        </div>
      ` : ''}
      <button class="med-learn-more" onclick="openDrugLearn('${drugNameEsc}')">
        <span class="sparkle">✨</span>
        View Drug Info
      </button>
    </div>
  `;
}

window.triggerMedsUpload = function() {
  if (state.isAnalyzingMeds) return;
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => handleMedsUpload(e.target.files[0]);
  input.click();
};

// ═══════════════════════════════════════════════════════════════════
// MEDICATION SCANNER - Camera-based drug identification
// Supports: pill bottles, medication lists, prescriptions, lab reports
// ═══════════════════════════════════════════════════════════════════

state.scannedMeds = []; // Store scanned medications for selection

window.triggerMedScan = function() {
  $('medScanInput').click();
};

$('medScanInput').onchange = async function() {
  if (!this.files || !this.files[0]) return;
  
  const file = this.files[0];
  this.value = ''; // Reset for next use
  
  // Show modal with loading state
  openModal('medScanModal');
  $('medScanBody').innerHTML = `
    <div class="med-scan-loading">
      <div class="spinner"></div>
      <p style="color:var(--text-muted);margin-top:12px">Analyzing image...</p>
      <p style="color:var(--text-muted);font-size:0.8rem">Detecting medications, doses & schedules</p>
    </div>
  `;
  
  try {
    // Compress image for upload
    const base64Image = await new Promise((resolve, reject) => {
      compressForAI(file).then(resolve).catch(reject);
    });
    state.medScanImage = base64Image;
    
    // Strip data URL prefix if present
    const rawBase64 = base64Image.startsWith('data:') 
      ? base64Image.split(',')[1] 
      : base64Image;
    
    // Call the API
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'identifyMedication',
        image: rawBase64
      })
    });
    
    const data = await res.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to identify medications');
    }
    
    // Store scanned meds and render
    state.scannedMeds = (data.medications || []).map((m, i) => ({ ...m, selected: true, index: i }));
    renderMedScanResult(data, base64Image);
    
  } catch (error) {
    console.error('Med scan error:', error);
    $('medScanBody').innerHTML = `
      <div class="med-scan-error">
        <p style="font-weight:600;margin-bottom:8px">❌ Analysis Failed</p>
        <p style="font-size:0.85rem">${esc(error.message || 'Could not analyze image')}</p>
        <button class="btn btn-secondary" style="margin-top:16px" onclick="triggerMedScan()">Try Again</button>
      </div>
    `;
  }
};

function renderMedScanResult(data, imageUrl) {
  const meds = data.medications || [];
  const confidence = Math.round((data.confidence || 0) * 100);
  const confidenceClass = confidence >= 80 ? 'high' : confidence >= 50 ? 'medium' : 'low';
  const imageType = data.imageType || 'unknown';
  
  // Type badge labels
  const typeLabels = {
    'single_drug': '💊 Single Medication',
    'medication_list': '📋 Medication List',
    'prescription': '📝 Prescription',
    'lab_report': '🔬 Lab Report',
    'unknown': '📷 Scanned Image'
  };
  
  let html = `
    <img src="${imageUrl}" class="med-scan-preview" alt="Scanned image">
    <div class="med-scan-type-badge">${typeLabels[imageType] || typeLabels.unknown} • ${meds.length} found</div>
  `;
  
  // Confidence bar
  html += `
    <div class="med-scan-confidence" style="margin-bottom:16px;padding:0;border:none">
      <span style="font-size:0.75rem;color:var(--text-muted)">Confidence:</span>
      <div class="confidence-bar">
        <div class="confidence-fill ${confidenceClass}" style="width:${confidence}%"></div>
      </div>
      <span style="font-size:0.8rem;font-weight:600">${confidence}%</span>
    </div>
  `;
  
  // Low confidence warning
  if (confidence < 70) {
    html += `
      <div style="background:var(--warning-bg);color:var(--warning-text);padding:10px 12px;border-radius:10px;margin-bottom:16px;font-size:0.8rem">
        ⚠️ Low confidence - please verify medications before adding
      </div>
    `;
  }
  
  if (meds.length === 0) {
    html += `
      <div style="text-align:center;padding:30px;color:var(--text-muted)">
        <p style="font-size:1.5rem;margin-bottom:8px">🤷</p>
        <p>No medications detected in this image</p>
        <button class="btn btn-secondary" style="margin-top:16px" onclick="triggerMedScan()">Try Another Image</button>
      </div>
    `;
  } else if (meds.length === 1) {
    // Single medication - show detailed view
    const med = meds[0];
    html += renderSingleMedResult(med, data.drugInfo);
  } else {
    // Multiple medications - show list with checkboxes
    html += `
      <div class="med-scan-select-all" onclick="toggleAllScannedMeds()">
        <div class="med-scan-item-check ${state.scannedMeds.every(m => m.selected) ? 'checked' : ''}" id="selectAllCheck"></div>
        <span>Select All (${meds.length} medications)</span>
      </div>
      <div class="med-scan-list">
    `;
    
    meds.forEach((med, idx) => {
      const details = [med.strength, med.frequency, med.route].filter(Boolean).join(' • ');
      const drugNameEsc = (med.drugName || '').replace(/'/g, "\\'");
      
      html += `
        <div class="med-scan-item">
          <div class="med-scan-item-check ${state.scannedMeds[idx]?.selected ? 'checked' : ''}" 
               onclick="toggleScannedMed(${idx})"></div>
          <div class="med-scan-item-info">
            <div class="med-scan-item-name">${esc(med.drugName || 'Unknown')}</div>
            ${details ? `<div class="med-scan-item-details">${esc(details)}</div>` : ''}
            ${med.brandName ? `<div class="med-scan-item-details" style="font-style:italic">${esc(med.brandName)}</div>` : ''}
          </div>
          <button class="med-scan-item-btn" onclick="openDrugInfo('${drugNameEsc}')">Info</button>
        </div>
      `;
    });
    
    html += `</div>`;
    
    // Action buttons for multiple meds
    html += `
      <div class="med-scan-actions">
        <button class="btn btn-primary" onclick="addSelectedScannedMeds()">
          ✓ Add Selected (${state.scannedMeds.filter(m => m.selected).length})
        </button>
        <button class="btn btn-secondary" onclick="triggerMedScan()">📷 Rescan</button>
      </div>
    `;
  }
  
  // Notes from AI
  if (data.notes) {
    html += `
      <div style="margin-top:16px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;font-size:0.8rem;color:var(--text-muted)">
        💡 ${esc(data.notes)}
      </div>
    `;
  }
  
  $('medScanBody').innerHTML = html;
}

function renderSingleMedResult(med, drugInfo) {
  const drugNameEsc = (med.drugName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
  const strengthEsc = (med.strength || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
  
  let html = `
    <div class="med-scan-result">
      <div class="med-scan-drug-name">${esc(med.drugName || 'Unknown')}</div>
      ${med.brandName ? `<div class="med-scan-brand">${esc(med.brandName)}</div>` : ''}
      
      <div class="med-scan-details">
        ${med.strength ? `
          <div class="med-scan-detail">
            <div class="med-scan-detail-label">Strength</div>
            <div class="med-scan-detail-value">${esc(med.strength)}</div>
          </div>
        ` : ''}
        ${med.form ? `
          <div class="med-scan-detail">
            <div class="med-scan-detail-label">Form</div>
            <div class="med-scan-detail-value">${esc(med.form)}</div>
          </div>
        ` : ''}
        ${med.frequency ? `
          <div class="med-scan-detail">
            <div class="med-scan-detail-label">Frequency</div>
            <div class="med-scan-detail-value">${esc(med.frequency)}</div>
          </div>
        ` : ''}
        ${med.route ? `
          <div class="med-scan-detail">
            <div class="med-scan-detail-label">Route</div>
            <div class="med-scan-detail-value">${esc(med.route)}</div>
          </div>
        ` : ''}
      </div>
    </div>
    
    <div class="med-scan-actions">
      <button class="btn btn-primary" onclick="useMedScanResult('${drugNameEsc}', '${strengthEsc}', '${esc(med.frequency || '')}', '${esc(med.route || '')}')">
        ✓ Add to Patient
      </button>
      <button class="btn btn-info" onclick="openDrugInfo('${drugNameEsc}')">
        📚 Drug Info
      </button>
    </div>
  `;
  
  // Show drug info preview if available
  if (drugInfo) {
    html += `
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
        <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px">Quick Info</div>
        <div style="font-size:0.85rem;color:var(--text);font-weight:600">${esc(drugInfo.drugClass || '')}</div>
        <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">${esc((drugInfo.mechanism || '').substring(0, 150))}${(drugInfo.mechanism || '').length > 150 ? '...' : ''}</div>
      </div>
    `;
  }
  
  return html;
}

window.toggleScannedMed = function(idx) {
  if (state.scannedMeds[idx]) {
    state.scannedMeds[idx].selected = !state.scannedMeds[idx].selected;
    // Re-render just the checkboxes
    const items = document.querySelectorAll('.med-scan-item-check');
    if (items[idx + 1]) { // +1 because first is select-all
      items[idx + 1].classList.toggle('checked', state.scannedMeds[idx].selected);
    }
    // Update select-all state
    const allSelected = state.scannedMeds.every(m => m.selected);
    const selectAll = $('selectAllCheck');
    if (selectAll) selectAll.classList.toggle('checked', allSelected);
    // Update button count
    const btn = document.querySelector('.med-scan-actions .btn-primary');
    if (btn) btn.textContent = `✓ Add Selected (${state.scannedMeds.filter(m => m.selected).length})`;
  }
};

window.toggleAllScannedMeds = function() {
  const allSelected = state.scannedMeds.every(m => m.selected);
  state.scannedMeds.forEach(m => m.selected = !allSelected);
  // Re-render checkboxes
  document.querySelectorAll('.med-scan-item-check').forEach((el, idx) => {
    el.classList.toggle('checked', !allSelected);
  });
  // Update button count
  const btn = document.querySelector('.med-scan-actions .btn-primary');
  if (btn) btn.textContent = `✓ Add Selected (${state.scannedMeds.filter(m => m.selected).length})`;
};

window.addSelectedScannedMeds = function() {
  const selected = state.scannedMeds.filter(m => m.selected);
  if (selected.length === 0) {
    toast('No medications selected', true);
    return;
  }
  
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];
  
  selected.forEach(med => {
    p.medications.push({
      name: med.drugName || 'Unknown',
      dose: med.strength || '',
      route: med.route || 'PO',
      frequency: med.frequency || 'OD',
      indication: med.indication || '',
      generic: med.brandName ? med.drugName : '',
      status: 'new',
      addedDate: new Date().toISOString(),
      source: 'scan'
    });
  });

  // DELTA SYNC: Queue update patch for patient with scanned medications
  enqueuePatch('updatePatient', { id: p.id, medications: p.medications });
  saveCloud();
  renderProfileMeds();
  closeModal('medScanModal');
  toast(`✓ ${selected.length} medication(s) added`);
};

window.useMedScanResult = function(drugName, strength, frequency, route) {
  closeModal('medScanModal');
  
  // Pre-fill the add medication form
  showAddMedForm();
  
  setTimeout(() => {
    const nameInput = $('medNameNew');
    const doseInput = $('medDoseNew');
    const freqInput = $('medFreqNew');
    const routeInput = $('medRouteNew');
    
    if (nameInput) nameInput.value = drugName;
    if (doseInput && strength) doseInput.value = strength;
    if (freqInput && frequency) freqInput.value = frequency;
    if (routeInput && route) routeInput.value = route;
    
    toast('📷 Medication scanned - complete the details');
  }, 100);
};

// ═══════════════════════════════════════════════════════════════════

async function handleMedsUpload(file) {
  if (!file) return;
  
  state.isAnalyzingMeds = true;
  renderProfileMeds();
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      // Strip data URL prefix
      const rawBase64 = imageData.startsWith('data:') ? imageData.split(',')[1] : imageData;
      
      // Use the document analyzer - it extracts medications from any document type
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ 
          action: 'analyzeDocument',
          image: rawBase64
        })
      });
      const data = await res.json();
      
      state.isAnalyzingMeds = false;
      
      if (!data.success) {
        throw new Error(data.error || 'Analysis failed');
      }
      
      const meds = data.medications || [];
      
      if (meds.length > 0) {
        const p = state.currentPatient;
        if (!p.medications) p.medications = [];
        
        let added = 0;
        meds.forEach(med => {
          // Check for duplicates
          const exists = p.medications.some(m => 
            m.name?.toLowerCase() === (med.name || med.drugName)?.toLowerCase()
          );
          if (!exists) {
            p.medications.push({
              name: med.name || med.drugName || 'Unknown',
              dose: med.dose || med.strength || '',
              route: med.route || 'PO',
              frequency: med.frequency || 'OD',
              indication: med.indication || med.notes || '',
              status: med.status || 'active',
              addedDate: new Date().toISOString(),
              source: 'scan'
            });
            added++;
          }
        });
        
        // Also update diagnosis if found and empty
        if (data.diagnoses?.length && !p.diagnosis) {
          p.diagnosis = data.diagnoses.join(', ');
        }

        // DELTA SYNC: Queue update patch for patient with imported medications
        enqueuePatch('updatePatient', { id: p.id, medications: p.medications });
        saveCloud();
        renderProfileMeds();
        toast(`✅ ${added} medication(s) imported` + (meds.length - added > 0 ? ` (${meds.length - added} duplicates skipped)` : ''));
      } else {
        toast('No medications found in image', true);
        renderProfileMeds();
      }
    } catch (e) {
      state.isAnalyzingMeds = false;
      console.error('Meds upload error:', e);
      toast('Failed to analyze: ' + e.message, true);
      renderProfileMeds();
    }
  });
}

window.showAddMedForm = function() {
  state.editingMedIdx = null;
  
  // Show overlay form
  const form = $('medAddForm');
  if (form) {
    form.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scroll
    
    // Reset values
    $('medName').value = '';
    $('medDose').value = '';
    $('medGeneric').value = '';
    $('medIndication').value = '';
    $('medRoute').value = 'PO';
    $('medFreq').value = 'OD';
    $('medStatus').value = 'active';
    
    // Reset chip selections - support both old and new class names
    document.querySelectorAll('#medRouteChips .pharmacy-chip, #medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector('#medRouteChips .pharmacy-chip[data-value="PO"], #medRouteChips .med-route-chip[data-value="PO"]')?.classList.add('selected');
    
    document.querySelectorAll('#medFreqChips .pharmacy-chip, #medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector('#medFreqChips .pharmacy-chip[data-value="OD"], #medFreqChips .med-freq-chip[data-value="OD"]')?.classList.add('selected');
    
    document.querySelectorAll('#medStatusOptions .pharmacy-status, #medStatusOptions .med-status-option').forEach(c => c.classList.remove('selected'));
    document.querySelector('#medStatusOptions .pharmacy-status[data-value="active"], #medStatusOptions .med-status-option[data-value="active"]')?.classList.add('selected');
    
    // Initialize chip handlers
    initMedFormChipHandlers();
    
    // Render AI suggestions
    renderMedSuggestions();
    
    // Focus on search input
    setTimeout(() => $('medName')?.focus(), 100);
  }
};

function initMedFormChipHandlers() {
  // Route chips - support both class names
  document.querySelectorAll('#medRouteChips .pharmacy-chip, #medRouteChips .med-route-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#medRouteChips .pharmacy-chip, #medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      $('medRoute').value = this.dataset.value;
    };
  });
  
  // Frequency chips
  document.querySelectorAll('#medFreqChips .pharmacy-chip, #medFreqChips .med-freq-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#medFreqChips .pharmacy-chip, #medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      $('medFreq').value = this.dataset.value;
    };
  });
  
  // Status options - support both old and new class names
  document.querySelectorAll('#medStatusOptions .pharmacy-status, #medStatusOptions .med-status-option').forEach(option => {
    option.onclick = function() {
      document.querySelectorAll('#medStatusOptions .pharmacy-status, #medStatusOptions .med-status-option').forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      $('medStatus').value = this.dataset.value;
    };
  });
}

// Keep old modal handler for backward compatibility
function initMedPillHandlers() {
  // Route pills
  document.querySelectorAll('#routePills .med-pill').forEach(pill => {
    pill.onclick = function() {
      document.querySelectorAll('#routePills .med-pill').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
    };
  });
  
  // Frequency pills  
  document.querySelectorAll('#freqPills .med-freq-pill').forEach(pill => {
    pill.onclick = function() {
      document.querySelectorAll('#freqPills .med-freq-pill').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
    };
  });
  
  // Status pills
  document.querySelectorAll('#statusPills .med-status-pill').forEach(pill => {
    pill.onclick = function() {
      document.querySelectorAll('#statusPills .med-status-pill').forEach(p => p.classList.remove('selected'));
      this.classList.add('selected');
    };
  });
}

window.hideAddMedForm = function() {
  const form = $('medAddForm');
  if (form) {
    form.style.display = 'none';
    document.body.style.overflow = ''; // Restore scroll
  }
};

window.saveMedication = function() {
  const name = $('medName')?.value?.trim();
  const dose = $('medDose')?.value?.trim();
  
  if (!name || !dose) {
    toast('Please enter drug name and dose', 'error');
    return;
  }
  
  const route = $('medRoute')?.value || 'PO';
  const frequency = $('medFreq')?.value || 'OD';
  const status = $('medStatus')?.value || 'active';
  
  const med = {
    name: name,
    dose: dose,
    route: route,
    frequency: frequency,
    indication: $('medIndication')?.value?.trim() || '',
    generic: $('medGeneric')?.value?.trim() || '',
    status: status,
    addedDate: new Date().toISOString()
  };
  
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];

  if (state.editingMedIdx !== null) {
    // Edit existing
    p.medications[state.editingMedIdx] = { ...p.medications[state.editingMedIdx], ...med };
    toast('Medication updated');
  } else {
    // Add new
    p.medications.push(med);
    toast('Medication added');
  }

  // DELTA SYNC: Queue update patch for patient with modified medications
  enqueuePatch('updatePatient', { id: p.id, medications: p.medications });
  saveCloud();
  hideAddMedForm();
  renderProfileMeds();
};

window.saveMedicationNew = function() {
  const name = $('medNameNew').value.trim();
  const dose = $('medDoseNew').value.trim();
  
  if (!name || !dose) {
    toast('Please enter drug name and dose', 'error');
    return;
  }
  
  const route = document.querySelector('#routePills .med-pill.selected')?.dataset.route || 'PO';
  const frequency = document.querySelector('#freqPills .med-freq-pill.selected')?.dataset.freq || 'OD';
  const status = document.querySelector('#statusPills .med-status-pill.selected')?.dataset.status || 'active';
  
  const med = {
    name: name,
    dose: dose,
    route: route,
    frequency: frequency,
    indication: $('medIndicationNew').value.trim(),
    generic: $('medGenericNew').value.trim(),
    status: status,
    addedDate: new Date().toISOString()
  };
  
  const p = state.currentPatient;
  if (!p.medications) p.medications = [];

  if (state.editingMedIdx !== null && state.editingMedIdx !== undefined) {
    p.medications[state.editingMedIdx] = { ...p.medications[state.editingMedIdx], ...med };
    toast('Medication updated');
  } else {
    p.medications.push(med);
    toast('Medication added');
  }

  state.editingMedIdx = null;
  // DELTA SYNC: Queue update patch for patient with modified medications
  enqueuePatch('updatePatient', { id: p.id, medications: p.medications });
  saveCloud();
  closeModal('addMedModal');
  renderProfileMeds();
};

window.editMedication = function(idx) {
  const med = state.currentPatient.medications[idx];
  if (!med) return;
  
  state.editingMedIdx = idx;
  
  // Show inline form
  const form = $('medAddForm');
  if (form) {
    form.style.display = 'block';
    
    // Set values
    $('medName').value = med.name || '';
    $('medDose').value = med.dose || '';
    $('medGeneric').value = med.generic || '';
    $('medIndication').value = med.indication || '';
    $('medRoute').value = med.route || 'PO';
    $('medFreq').value = med.frequency || 'OD';
    $('medStatus').value = med.status || 'active';
    
    // Set route chip
    document.querySelectorAll('#medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector(`#medRouteChips .med-route-chip[data-value="${med.route || 'PO'}"]`)?.classList.add('selected');
    
    // Set frequency chip
    document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
    document.querySelector(`#medFreqChips .med-freq-chip[data-value="${med.frequency || 'OD'}"]`)?.classList.add('selected');
    
    // Set status option
    document.querySelectorAll('#medStatusOptions .med-status-option').forEach(c => c.classList.remove('selected'));
    document.querySelector(`#medStatusOptions .med-status-option[data-value="${med.status || 'active'}"]`)?.classList.add('selected');
    
    // Initialize chip handlers
    initMedFormChipHandlers();
    
    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

window.deleteMedication = function(idx) {
  if (!confirm('Delete this medication? It can be restored from Trash.')) return;
  const med = state.currentPatient.medications[idx];
  if (med) {
    // Move to trash
    med.deletedAt = new Date().toISOString();
    med.deletedBy = state.currentUser?.name || 'Unknown';
    med.patientId = state.currentPatient.id;
    med.patientName = state.currentPatient.name;
    if (!state.trash.medications) state.trash.medications = [];
    state.trash.medications.push(med);
  }
  state.currentPatient.medications.splice(idx, 1);
  // DELTA SYNC: Queue update patch for patient with modified medications
  enqueuePatch('updatePatient', { id: state.currentPatient.id, medications: state.currentPatient.medications });
  saveCloud();
  renderProfileMeds();
  toast('Medication moved to trash');
};

window.reconcileMeds = function() {
  toast('Medication reconciliation - Coming soon');
};

// ═══════════════════════════════════════════════════════════════════
// NEURAL MEDICATION LEARNING SYSTEM
// ═══════════════════════════════════════════════════════════════════

const MedLearning = {
  // Knowledge base of condition-medication associations
  knowledgeBase: {
    // Diabetes
    'diabetes': [
      { name: 'Metformin', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Type 2 Diabetes', weight: 10 },
      { name: 'Gliclazide', dose: '80mg', route: 'PO', frequency: 'OD', indication: 'Type 2 Diabetes', weight: 8 },
      { name: 'Insulin Glargine', dose: '10 units', route: 'SC', frequency: 'OD', indication: 'Diabetes', weight: 7 },
      { name: 'Sitagliptin', dose: '100mg', route: 'PO', frequency: 'OD', indication: 'Type 2 Diabetes', weight: 6 },
      { name: 'Empagliflozin', dose: '10mg', route: 'PO', frequency: 'OD', indication: 'Type 2 Diabetes', weight: 6 }
    ],
    'dm': [
      { name: 'Metformin', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Type 2 Diabetes', weight: 10 }
    ],
    // Hypertension
    'hypertension': [
      { name: 'Amlodipine', dose: '5mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 10 },
      { name: 'Lisinopril', dose: '10mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 9 },
      { name: 'Losartan', dose: '50mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 8 },
      { name: 'Hydrochlorothiazide', dose: '25mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 7 },
      { name: 'Atenolol', dose: '50mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 6 }
    ],
    'htn': [
      { name: 'Amlodipine', dose: '5mg', route: 'PO', frequency: 'OD', indication: 'Hypertension', weight: 10 }
    ],
    // Heart Failure
    'heart failure': [
      { name: 'Furosemide', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 10 },
      { name: 'Spironolactone', dose: '25mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 9 },
      { name: 'Carvedilol', dose: '6.25mg', route: 'PO', frequency: 'BD', indication: 'Heart Failure', weight: 8 },
      { name: 'Ramipril', dose: '2.5mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 8 },
      { name: 'Sacubitril/Valsartan', dose: '49/51mg', route: 'PO', frequency: 'BD', indication: 'Heart Failure', weight: 7 }
    ],
    'chf': [
      { name: 'Furosemide', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'Heart Failure', weight: 10 }
    ],
    // Infection/Pneumonia
    'pneumonia': [
      { name: 'Amoxicillin/Clavulanate', dose: '625mg', route: 'PO', frequency: 'TDS', indication: 'Pneumonia', weight: 10 },
      { name: 'Azithromycin', dose: '500mg', route: 'PO', frequency: 'OD', indication: 'Pneumonia', weight: 9 },
      { name: 'Ceftriaxone', dose: '1g', route: 'IV', frequency: 'OD', indication: 'Pneumonia', weight: 8 },
      { name: 'Levofloxacin', dose: '750mg', route: 'PO', frequency: 'OD', indication: 'Pneumonia', weight: 7 }
    ],
    'infection': [
      { name: 'Amoxicillin/Clavulanate', dose: '625mg', route: 'PO', frequency: 'TDS', indication: 'Infection', weight: 9 },
      { name: 'Ciprofloxacin', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Infection', weight: 8 }
    ],
    'sepsis': [
      { name: 'Piperacillin/Tazobactam', dose: '4.5g', route: 'IV', frequency: 'Q6H', indication: 'Sepsis', weight: 10 },
      { name: 'Vancomycin', dose: '1g', route: 'IV', frequency: 'Q12H', indication: 'Sepsis', weight: 9 },
      { name: 'Meropenem', dose: '1g', route: 'IV', frequency: 'Q8H', indication: 'Sepsis', weight: 8 }
    ],
    // ACS/MI
    'acs': [
      { name: 'Aspirin', dose: '81mg', route: 'PO', frequency: 'OD', indication: 'ACS', weight: 10 },
      { name: 'Clopidogrel', dose: '75mg', route: 'PO', frequency: 'OD', indication: 'ACS', weight: 10 },
      { name: 'Atorvastatin', dose: '80mg', route: 'PO', frequency: 'OD', indication: 'ACS', weight: 9 },
      { name: 'Enoxaparin', dose: '1mg/kg', route: 'SC', frequency: 'BD', indication: 'ACS', weight: 8 },
      { name: 'Metoprolol', dose: '25mg', route: 'PO', frequency: 'BD', indication: 'ACS', weight: 7 }
    ],
    'mi': [
      { name: 'Aspirin', dose: '81mg', route: 'PO', frequency: 'OD', indication: 'MI', weight: 10 },
      { name: 'Clopidogrel', dose: '75mg', route: 'PO', frequency: 'OD', indication: 'MI', weight: 10 }
    ],
    // COPD/Asthma
    'copd': [
      { name: 'Salbutamol', dose: '100mcg', route: 'INH', frequency: 'PRN', indication: 'COPD', weight: 10 },
      { name: 'Tiotropium', dose: '18mcg', route: 'INH', frequency: 'OD', indication: 'COPD', weight: 9 },
      { name: 'Budesonide/Formoterol', dose: '160/4.5mcg', route: 'INH', frequency: 'BD', indication: 'COPD', weight: 8 },
      { name: 'Prednisolone', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'COPD Exacerbation', weight: 7 }
    ],
    'asthma': [
      { name: 'Salbutamol', dose: '100mcg', route: 'INH', frequency: 'PRN', indication: 'Asthma', weight: 10 },
      { name: 'Fluticasone/Salmeterol', dose: '250/50mcg', route: 'INH', frequency: 'BD', indication: 'Asthma', weight: 9 }
    ],
    // CKD
    'ckd': [
      { name: 'Calcium Carbonate', dose: '500mg', route: 'PO', frequency: 'TDS', indication: 'CKD', weight: 8 },
      { name: 'Sodium Bicarbonate', dose: '500mg', route: 'PO', frequency: 'TDS', indication: 'CKD', weight: 7 },
      { name: 'Erythropoietin', dose: '4000 units', route: 'SC', frequency: 'Weekly', indication: 'CKD Anemia', weight: 6 }
    ],
    'renal': [
      { name: 'Furosemide', dose: '40mg', route: 'IV', frequency: 'BD', indication: 'Renal', weight: 8 }
    ],
    // Pain
    'pain': [
      { name: 'Paracetamol', dose: '1g', route: 'PO', frequency: 'QID', indication: 'Pain', weight: 10 },
      { name: 'Ibuprofen', dose: '400mg', route: 'PO', frequency: 'TDS', indication: 'Pain', weight: 8 },
      { name: 'Tramadol', dose: '50mg', route: 'PO', frequency: 'Q6H', indication: 'Pain', weight: 7 },
      { name: 'Morphine', dose: '5mg', route: 'IV', frequency: 'Q4H', indication: 'Severe Pain', weight: 6 }
    ],
    // GI
    'gerd': [
      { name: 'Omeprazole', dose: '20mg', route: 'PO', frequency: 'OD', indication: 'GERD', weight: 10 },
      { name: 'Pantoprazole', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'GERD', weight: 9 }
    ],
    'nausea': [
      { name: 'Ondansetron', dose: '4mg', route: 'IV', frequency: 'Q8H', indication: 'Nausea', weight: 10 },
      { name: 'Metoclopramide', dose: '10mg', route: 'PO', frequency: 'TDS', indication: 'Nausea', weight: 8 }
    ],
    // DVT/PE
    'dvt': [
      { name: 'Enoxaparin', dose: '1mg/kg', route: 'SC', frequency: 'BD', indication: 'DVT', weight: 10 },
      { name: 'Rivaroxaban', dose: '15mg', route: 'PO', frequency: 'BD', indication: 'DVT', weight: 9 },
      { name: 'Warfarin', dose: '5mg', route: 'PO', frequency: 'OD', indication: 'DVT', weight: 8 }
    ],
    'pe': [
      { name: 'Enoxaparin', dose: '1mg/kg', route: 'SC', frequency: 'BD', indication: 'PE', weight: 10 },
      { name: 'Heparin', dose: '5000 units', route: 'IV', frequency: 'Infusion', indication: 'PE', weight: 9 }
    ],
    // Stroke
    'stroke': [
      { name: 'Aspirin', dose: '300mg', route: 'PO', frequency: 'OD', indication: 'Stroke', weight: 10 },
      { name: 'Atorvastatin', dose: '40mg', route: 'PO', frequency: 'OD', indication: 'Stroke', weight: 9 },
      { name: 'Clopidogrel', dose: '75mg', route: 'PO', frequency: 'OD', indication: 'Stroke', weight: 8 }
    ],
    // Seizure
    'seizure': [
      { name: 'Levetiracetam', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Seizure', weight: 10 },
      { name: 'Phenytoin', dose: '100mg', route: 'PO', frequency: 'TDS', indication: 'Seizure', weight: 8 },
      { name: 'Valproate', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Seizure', weight: 7 }
    ],
    'epilepsy': [
      { name: 'Levetiracetam', dose: '500mg', route: 'PO', frequency: 'BD', indication: 'Epilepsy', weight: 10 }
    ]
  },
  
  // Lab-based suggestions
  labTriggers: {
    'potassium': {
      low: [{ name: 'Potassium Chloride', dose: '20mEq', route: 'PO', frequency: 'BD', indication: 'Hypokalemia', weight: 10 }],
      high: [{ name: 'Calcium Gluconate', dose: '1g', route: 'IV', frequency: 'STAT', indication: 'Hyperkalemia', weight: 10 },
             { name: 'Insulin Regular', dose: '10 units', route: 'IV', frequency: 'STAT', indication: 'Hyperkalemia', weight: 9 }]
    },
    'hemoglobin': {
      low: [{ name: 'Ferrous Sulfate', dose: '325mg', route: 'PO', frequency: 'TDS', indication: 'Anemia', weight: 9 },
            { name: 'Packed RBCs', dose: '1 unit', route: 'IV', frequency: 'STAT', indication: 'Severe Anemia', weight: 8 }]
    },
    'glucose': {
      high: [{ name: 'Insulin Regular', dose: 'Sliding Scale', route: 'SC', frequency: 'Q6H', indication: 'Hyperglycemia', weight: 10 }]
    },
    'creatinine': {
      high: [{ name: 'IV Normal Saline', dose: '1L', route: 'IV', frequency: 'Over 4hr', indication: 'AKI', weight: 9 }]
    },
    'inr': {
      high: [{ name: 'Vitamin K', dose: '10mg', route: 'IV', frequency: 'STAT', indication: 'Elevated INR', weight: 10 }]
    }
  },
  
  // Learn from existing patients in the system
  learnFromPatients: function() {
    const learned = {};
    const patients = state.patients || [];
    
    patients.forEach(p => {
      if (!p.diagnosis || !p.medications?.length) return;
      
      const dxLower = p.diagnosis.toLowerCase();
      p.medications.forEach(med => {
        if (!med.name) return;
        
        // Create a key from diagnosis keywords
        const keywords = dxLower.split(/[\s,\/]+/).filter(w => w.length > 2);
        keywords.forEach(keyword => {
          if (!learned[keyword]) learned[keyword] = [];
          
          // Check if already exists
          const existing = learned[keyword].find(m => m.name.toLowerCase() === med.name.toLowerCase());
          if (existing) {
            existing.weight += 2; // Increase weight for repeated use
            existing.count = (existing.count || 1) + 1;
          } else {
            learned[keyword].push({
              name: med.name,
              dose: med.dose,
              route: med.route,
              frequency: med.frequency,
              indication: med.indication || p.diagnosis,
              weight: 5,
              count: 1,
              learned: true
            });
          }
        });
      });
    });
    
    return learned;
  },
  
  // Get suggestions for current patient
  getSuggestions: function(patient) {
    if (!patient) return [];
    
    const suggestions = [];
    const addedMeds = new Set((patient.medications || []).map(m => m.name?.toLowerCase()));
    const diagnosis = (patient.diagnosis || '').toLowerCase();
    
    // 1. Match from knowledge base
    Object.entries(this.knowledgeBase).forEach(([condition, meds]) => {
      if (diagnosis.includes(condition)) {
        meds.forEach(med => {
          if (!addedMeds.has(med.name.toLowerCase())) {
            suggestions.push({
              ...med,
              source: 'knowledge',
              matchType: 'diagnosis',
              matchTerm: condition
            });
          }
        });
      }
    });
    
    // 2. Learn from similar patients
    const learned = this.learnFromPatients();
    const dxKeywords = diagnosis.split(/[\s,\/]+/).filter(w => w.length > 2);
    
    dxKeywords.forEach(keyword => {
      if (learned[keyword]) {
        learned[keyword].forEach(med => {
          if (!addedMeds.has(med.name.toLowerCase())) {
            const existing = suggestions.find(s => s.name.toLowerCase() === med.name.toLowerCase());
            if (existing) {
              existing.weight += med.weight;
              existing.patientCount = med.count;
            } else {
              suggestions.push({
                ...med,
                source: 'learned',
                matchType: 'similar_patients',
                patientCount: med.count
              });
            }
          }
        });
      }
    });
    
    // 3. Check lab values for triggers
    if (patient.labData?.parameters) {
      patient.labData.parameters.forEach(param => {
        const paramName = param.name?.toLowerCase();
        const latestValue = param.values?.[0];
        
        if (latestValue && this.labTriggers[paramName]) {
          const status = latestValue.status;
          let triggerMeds = [];
          
          if (status === 'critical' || status === 'high') {
            triggerMeds = this.labTriggers[paramName].high || [];
          } else if (status === 'low') {
            triggerMeds = this.labTriggers[paramName].low || [];
          }
          
          triggerMeds.forEach(med => {
            if (!addedMeds.has(med.name.toLowerCase())) {
              suggestions.push({
                ...med,
                source: 'lab',
                matchType: 'lab_value',
                labParam: param.name,
                labValue: latestValue.value,
                labStatus: status,
                weight: med.weight + (status === 'critical' ? 5 : 0)
              });
            }
          });
        }
      });
    }
    
    // Sort by weight and deduplicate
    const unique = [];
    const seen = new Set();
    
    suggestions
      .sort((a, b) => b.weight - a.weight)
      .forEach(s => {
        const key = s.name.toLowerCase();
        if (!seen.has(key)) {
          seen.add(key);
          unique.push(s);
        }
      });
    
    return unique.slice(0, 8); // Top 8 suggestions
  }
};

// Render suggestions in the form
function renderMedSuggestions() {
  const container = $('medSuggestionChips');
  if (!container) return;
  
  const patient = state.currentPatient;
  if (!patient) {
    container.innerHTML = '<div class="med-ai-empty"><div class="med-ai-empty-icon">🤖</div>No patient selected</div>';
    return;
  }
  
  const suggestions = MedLearning.getSuggestions(patient);
  
  if (suggestions.length === 0) {
    container.innerHTML = `
      <div class="med-ai-empty">
        <div class="med-ai-empty-icon">💊</div>
        No suggestions available for this diagnosis
      </div>
    `;
    return;
  }
  
  container.innerHTML = suggestions.map(s => {
    const isHighMatch = s.weight >= 9;
    const matchIcon = s.source === 'lab' ? '🔬' : s.source === 'learned' ? '📊' : '📋';
    const matchText = s.source === 'lab' 
      ? `${s.labParam}: ${s.labValue} (${s.labStatus})`
      : s.source === 'learned'
      ? `Used in ${s.patientCount || 1} similar patient${s.patientCount > 1 ? 's' : ''}`
      : s.matchTerm;
    
    return `
      <button type="button" class="med-ai-chip ${isHighMatch ? 'high-match' : ''}" 
              onclick="applyMedSuggestion(${JSON.stringify(s).replace(/"/g, '&quot;')})">
        <span class="med-ai-chip-icon">${matchIcon}</span>
        <div class="med-ai-chip-info">
          <span class="med-ai-chip-name">${esc(s.name)}</span>
          <span class="med-ai-chip-detail">${esc(s.dose)} ${esc(s.route)} ${esc(s.frequency)}</span>
        </div>
        ${isHighMatch ? '<span class="med-ai-chip-match">Best</span>' : ''}
      </button>
    `;
  }).join('');
}

// Apply suggestion to form
window.applyMedSuggestion = function(suggestion) {
  $('medName').value = suggestion.name;
  $('medDose').value = suggestion.dose;
  $('medIndication').value = suggestion.indication || '';
  $('medRoute').value = suggestion.route;
  $('medFreq').value = suggestion.frequency;
  
  // Update route chips
  document.querySelectorAll('#medRouteChips .med-route-chip').forEach(c => c.classList.remove('selected'));
  document.querySelector(`#medRouteChips .med-route-chip[data-value="${suggestion.route}"]`)?.classList.add('selected');
  
  // Update frequency chips
  document.querySelectorAll('#medFreqChips .med-freq-chip').forEach(c => c.classList.remove('selected'));
  document.querySelector(`#medFreqChips .med-freq-chip[data-value="${suggestion.frequency}"]`)?.classList.add('selected');
  
  toast(`${suggestion.name} applied`);
};

// Filter suggestions as user types
window.filterMedSuggestions = function(query) {
  if (!query || query.length < 2) {
    renderMedSuggestions();
    return;
  }
  
  const container = $('medSuggestionChips');
  if (!container) return;
  
  const patient = state.currentPatient;
  const allSuggestions = MedLearning.getSuggestions(patient);
  const filtered = allSuggestions.filter(s => 
    s.name.toLowerCase().includes(query.toLowerCase())
  );
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="med-ai-empty">No matches for "${esc(query)}"</div>`;
    return;
  }
  
  container.innerHTML = filtered.map(s => {
    const isHighMatch = s.weight >= 9;
    return `
      <button type="button" class="med-ai-chip ${isHighMatch ? 'high-match' : ''}" 
              onclick="applyMedSuggestion(${JSON.stringify(s).replace(/"/g, '&quot;')})">
        <span class="med-ai-chip-icon">💊</span>
        <div class="med-ai-chip-info">
          <span class="med-ai-chip-name">${esc(s.name)}</span>
          <span class="med-ai-chip-detail">${esc(s.dose)} ${esc(s.route)} ${esc(s.frequency)}</span>
        </div>
      </button>
    `;
  }).join('');
};

// ═══════════════════════════════════════════════════════════════════
// AI-POWERED DRUG INFO - Neural Learning Module
// ═══════════════════════════════════════════════════════════════════

const DrugKnowledgeBase = {
  // Comprehensive drug database with clinical info
  drugs: {
    'metformin': {
      generic: 'Metformin Hydrochloride',
      class: 'Biguanide',
      mechanism: 'Decreases hepatic glucose production, decreases intestinal absorption of glucose, and improves insulin sensitivity by increasing peripheral glucose uptake and utilization.',
      sideEffects: ['GI upset, nausea, diarrhea (30%)', 'Metallic taste (5%)', 'Vitamin B12 deficiency (long-term)', 'Lactic acidosis (rare but serious)'],
      contraindications: ['eGFR <30 mL/min (contraindicated)', 'eGFR 30-45 mL/min (use with caution)', 'Acute/decompensated heart failure', 'Hepatic impairment', 'Before IV contrast (hold 48h)'],
      monitoring: ['Renal function (Cr, eGFR) at baseline then annually', 'Vitamin B12 levels periodically', 'HbA1c every 3-6 months', 'Signs of lactic acidosis'],
      interactions: {
        'contrast': 'Hold 48h before and after IV contrast - risk of contrast-induced nephropathy and lactic acidosis',
        'alcohol': 'Increased risk of lactic acidosis',
        'furosemide': 'May increase metformin levels'
      },
      renalDosing: { mild: 'No adjustment', moderate: 'Max 1000mg/day if eGFR 30-45', severe: 'Contraindicated if eGFR <30' },
      labAlerts: { creatinine: 'high', egfr: 'low' }
    },
    'amlodipine': {
      generic: 'Amlodipine Besylate',
      class: 'Calcium Channel Blocker (Dihydropyridine)',
      mechanism: 'Inhibits calcium ion influx across cell membranes of vascular smooth muscle and cardiac muscle, causing vasodilation and reduced peripheral vascular resistance.',
      sideEffects: ['Peripheral edema (10-15%)', 'Headache (7%)', 'Dizziness (3%)', 'Flushing (2%)', 'Palpitations'],
      contraindications: ['Severe aortic stenosis', 'Cardiogenic shock', 'Unstable angina', 'Hypersensitivity'],
      monitoring: ['Blood pressure regularly', 'Heart rate', 'Peripheral edema', 'Liver function if symptomatic'],
      interactions: {
        'simvastatin': 'Limit simvastatin to 20mg/day - increased myopathy risk',
        'cyclosporine': 'Increased cyclosporine levels',
        'diltiazem': 'Additive cardiac effects'
      },
      renalDosing: { mild: 'No adjustment', moderate: 'No adjustment', severe: 'No adjustment (not dialyzed)' }
    },
    'lisinopril': {
      generic: 'Lisinopril',
      class: 'ACE Inhibitor',
      mechanism: 'Competitively inhibits angiotensin-converting enzyme (ACE), preventing conversion of angiotensin I to angiotensin II, leading to decreased aldosterone secretion and vasodilation.',
      sideEffects: ['Dry cough (10-15%)', 'Hyperkalemia (2-6%)', 'Dizziness (5%)', 'Hypotension', 'Angioedema (rare but serious)', 'Acute kidney injury'],
      contraindications: ['History of angioedema', 'Pregnancy (2nd/3rd trimester)', 'Bilateral renal artery stenosis', 'Concurrent use with aliskiren in diabetes'],
      monitoring: ['Blood pressure', 'Potassium levels (within 1-2 weeks of initiation)', 'Renal function (Cr, BUN)', 'Signs of angioedema'],
      interactions: {
        'potassium': 'Increased hyperkalemia risk with K+ supplements or K+-sparing diuretics',
        'spironolactone': 'Significant hyperkalemia risk - monitor K+ closely',
        'nsaids': 'Reduced antihypertensive effect, increased renal risk',
        'lithium': 'Increased lithium levels'
      },
      labAlerts: { potassium: 'high', creatinine: 'high' },
      renalDosing: { mild: 'No adjustment', moderate: 'Reduce dose 50%', severe: 'Start 2.5mg/day' }
    },
    'furosemide': {
      generic: 'Furosemide',
      class: 'Loop Diuretic',
      mechanism: 'Inhibits sodium and chloride reabsorption in the ascending loop of Henle and distal renal tubule, interfering with the chloride-binding cotransport system, causing increased excretion of water, sodium, chloride, magnesium, and calcium.',
      sideEffects: ['Hypokalemia (frequent)', 'Hyponatremia', 'Hypotension', 'Ototoxicity (high doses)', 'Hyperuricemia/gout', 'Hypomagnesemia'],
      contraindications: ['Anuria', 'Hepatic coma', 'Severe electrolyte depletion', 'Hypersensitivity to sulfonamides'],
      monitoring: ['Electrolytes (K+, Na+, Mg2+) frequently', 'Renal function', 'Blood pressure', 'Fluid status/weight', 'Hearing (high doses)'],
      interactions: {
        'aminoglycosides': 'Increased ototoxicity risk',
        'digoxin': 'Hypokalemia increases digoxin toxicity risk',
        'lithium': 'Increased lithium toxicity',
        'nsaids': 'Reduced diuretic effect'
      },
      labAlerts: { potassium: 'low', sodium: 'low' }
    },
    'aspirin': {
      generic: 'Acetylsalicylic Acid',
      class: 'Antiplatelet / NSAID',
      mechanism: 'Irreversibly inhibits cyclooxygenase-1 (COX-1) in platelets, preventing thromboxane A2 synthesis and platelet aggregation for the lifetime of the platelet (7-10 days).',
      sideEffects: ['GI bleeding (dose-dependent)', 'Dyspepsia', 'Tinnitus (high doses)', 'Bruising', 'Allergic reactions'],
      contraindications: ['Active GI bleeding', 'Bleeding disorders', 'Aspirin-exacerbated respiratory disease', 'Children with viral illness (Reye syndrome)'],
      monitoring: ['Signs of bleeding', 'Hemoglobin if prolonged use', 'Renal function', 'GI symptoms'],
      interactions: {
        'warfarin': 'Significantly increased bleeding risk',
        'ibuprofen': 'May reduce cardioprotective effect if taken before aspirin',
        'methotrexate': 'Increased methotrexate toxicity',
        'ssris': 'Increased bleeding risk'
      }
    },
    'clopidogrel': {
      generic: 'Clopidogrel Bisulfate',
      class: 'P2Y12 Inhibitor / Antiplatelet',
      mechanism: 'Irreversibly inhibits the P2Y12 component of ADP receptors on platelet surface, preventing ADP-mediated activation and subsequent platelet aggregation.',
      sideEffects: ['Bleeding (major 1-2%)', 'Bruising', 'Dyspepsia', 'Diarrhea', 'Rash', 'TTP (rare)'],
      contraindications: ['Active pathological bleeding', 'Severe hepatic impairment'],
      monitoring: ['Signs of bleeding', 'CBC if symptomatic', 'Consider platelet function testing in non-responders'],
      interactions: {
        'omeprazole': 'Reduced clopidogrel efficacy - use pantoprazole instead',
        'aspirin': 'Increased bleeding but often used together (DAPT)',
        'warfarin': 'Significantly increased bleeding risk',
        'nsaids': 'Increased GI bleeding risk'
      }
    },
    'atorvastatin': {
      generic: 'Atorvastatin Calcium',
      class: 'HMG-CoA Reductase Inhibitor (Statin)',
      mechanism: 'Competitively inhibits HMG-CoA reductase, the rate-limiting enzyme in cholesterol biosynthesis, leading to upregulation of LDL receptors and increased clearance of LDL-C from blood.',
      sideEffects: ['Myalgia (5-10%)', 'Elevated transaminases (1-3%)', 'Myopathy/rhabdomyolysis (rare)', 'New-onset diabetes (slight risk)', 'GI upset'],
      contraindications: ['Active liver disease', 'Unexplained persistent transaminase elevation', 'Pregnancy/breastfeeding'],
      monitoring: ['Lipid panel (4-12 weeks after initiation)', 'LFTs at baseline and if symptomatic', 'CK if muscle symptoms', 'HbA1c periodically'],
      interactions: {
        'gemfibrozil': 'Increased myopathy risk - avoid combination',
        'clarithromycin': 'Increased statin levels and myopathy risk',
        'amlodipine': 'Limit atorvastatin to 20mg/day',
        'grapefruit': 'Large amounts increase statin levels'
      }
    },
    'omeprazole': {
      generic: 'Omeprazole',
      class: 'Proton Pump Inhibitor (PPI)',
      mechanism: 'Irreversibly inhibits the H+/K+-ATPase (proton pump) in gastric parietal cells, blocking the final step of acid production and reducing gastric acid secretion by up to 99%.',
      sideEffects: ['Headache (7%)', 'Diarrhea (3%)', 'Abdominal pain', 'C. diff infection (long-term)', 'B12/Mg deficiency (long-term)', 'Bone fracture risk (long-term)'],
      contraindications: ['Hypersensitivity to PPIs', 'Concurrent rilpivirine'],
      monitoring: ['Magnesium (if long-term)', 'B12 (if long-term)', 'Bone density (if high-risk)', 'C. diff if diarrhea develops'],
      interactions: {
        'clopidogrel': 'Reduces clopidogrel efficacy - use pantoprazole instead',
        'methotrexate': 'Increased methotrexate levels',
        'tacrolimus': 'Increased tacrolimus levels'
      }
    },
    'pantoprazole': {
      generic: 'Pantoprazole Sodium',
      class: 'Proton Pump Inhibitor (PPI)',
      mechanism: 'Irreversibly inhibits the H+/K+-ATPase (proton pump) in gastric parietal cells, blocking the final step of acid production. Less CYP2C19 interaction than omeprazole.',
      sideEffects: ['Headache (5%)', 'Diarrhea (4%)', 'Nausea', 'C. diff infection (long-term)', 'B12/Mg deficiency (long-term)'],
      contraindications: ['Hypersensitivity to PPIs'],
      monitoring: ['Magnesium (if long-term)', 'B12 (if long-term)', 'C. diff if diarrhea'],
      interactions: {
        'methotrexate': 'Increased methotrexate levels',
        'warfarin': 'Monitor INR'
      }
    },
    'insulin glargine': {
      generic: 'Insulin Glargine',
      class: 'Long-Acting Insulin Analog',
      mechanism: 'Binds to insulin receptors, facilitating cellular glucose uptake in muscle and adipose tissue while inhibiting hepatic glucose output. Glargine forms microprecipitates providing slow, peakless release over 24 hours.',
      sideEffects: ['Hypoglycemia', 'Weight gain', 'Injection site reactions', 'Lipodystrophy', 'Hypokalemia'],
      contraindications: ['Hypoglycemia', 'Hypersensitivity'],
      monitoring: ['Blood glucose (fasting and random)', 'HbA1c every 3 months', 'Hypoglycemia episodes', 'Injection sites', 'Potassium if at risk'],
      interactions: {
        'beta-blockers': 'May mask hypoglycemia symptoms',
        'thiazolidinediones': 'Increased fluid retention and heart failure risk',
        'alcohol': 'Increased hypoglycemia risk'
      },
      labAlerts: { glucose: 'low', potassium: 'low' }
    },
    'enoxaparin': {
      generic: 'Enoxaparin Sodium',
      class: 'Low Molecular Weight Heparin (LMWH)',
      mechanism: 'Binds to antithrombin III, potentiating its inhibition of Factor Xa (and to lesser extent Factor IIa/thrombin), preventing thrombin generation and fibrin clot formation.',
      sideEffects: ['Bleeding (major 1-2%)', 'Injection site hematoma', 'Thrombocytopenia (HIT)', 'Elevated transaminases', 'Hyperkalemia'],
      contraindications: ['Active major bleeding', 'HIT history', 'Severe thrombocytopenia'],
      monitoring: ['Anti-Xa levels (renal impairment, obesity, pregnancy)', 'Platelets (baseline and if prolonged use)', 'Signs of bleeding', 'Renal function'],
      interactions: {
        'aspirin': 'Increased bleeding risk',
        'nsaids': 'Increased bleeding risk',
        'warfarin': 'Significant bleeding risk during overlap'
      },
      labAlerts: { platelets: 'low', inr: 'high' },
      renalDosing: { mild: 'No adjustment', moderate: 'Consider dose reduction', severe: 'CrCl <30: 1mg/kg once daily (treatment dose)' }
    },
    'warfarin': {
      generic: 'Warfarin Sodium',
      class: 'Vitamin K Antagonist',
      mechanism: 'Inhibits vitamin K epoxide reductase, preventing regeneration of reduced vitamin K needed for gamma-carboxylation of clotting factors II, VII, IX, and X.',
      sideEffects: ['Bleeding (major 1-3%/year)', 'Bruising', 'Skin necrosis (rare, protein C deficiency)', 'Purple toe syndrome'],
      contraindications: ['Active bleeding', 'Pregnancy', 'Severe liver disease', 'Recent CNS surgery', 'Uncontrolled hypertension'],
      monitoring: ['INR (daily initially, then weekly, then monthly when stable)', 'Signs of bleeding', 'Hemoglobin if bleeding suspected'],
      interactions: {
        'many drugs': 'Numerous interactions - always check!',
        'vitamin k': 'Reverses anticoagulation',
        'antibiotics': 'Many increase INR (metronidazole, fluconazole, TMP-SMX)',
        'amiodarone': 'Significantly increases INR - reduce warfarin dose 30-50%',
        'nsaids': 'Increased bleeding risk'
      },
      labAlerts: { inr: 'high' }
    },
    'amoxicillin/clavulanate': {
      generic: 'Amoxicillin/Clavulanic Acid (Augmentin)',
      class: 'Penicillin + Beta-lactamase Inhibitor',
      mechanism: 'Amoxicillin inhibits bacterial cell wall synthesis by binding to penicillin-binding proteins. Clavulanate irreversibly inhibits beta-lactamases, extending spectrum to beta-lactamase producing organisms.',
      sideEffects: ['Diarrhea (9%)', 'Nausea/vomiting', 'Rash', 'Candidiasis', 'Hepatotoxicity (rare)', 'C. diff colitis'],
      contraindications: ['Penicillin allergy', 'History of cholestatic jaundice with this drug', 'Severe renal impairment (use adjusted formulation)'],
      monitoring: ['Signs of allergic reaction', 'LFTs if prolonged use', 'Renal function', 'C. diff if diarrhea'],
      interactions: {
        'methotrexate': 'Reduced methotrexate clearance',
        'warfarin': 'May increase INR',
        'allopurinol': 'Increased rash risk'
      },
      renalDosing: { mild: 'No adjustment', moderate: 'Reduce frequency', severe: 'CrCl <30: 250-500mg q12h' }
    },
    'ceftriaxone': {
      generic: 'Ceftriaxone Sodium',
      class: 'Third-Generation Cephalosporin',
      mechanism: 'Inhibits bacterial cell wall synthesis by binding to penicillin-binding proteins (PBPs), disrupting peptidoglycan synthesis. Broad gram-negative coverage with some gram-positive activity.',
      sideEffects: ['Diarrhea (3%)', 'Rash (2%)', 'Eosinophilia', 'Biliary sludge/pseudolithiasis', 'Injection site pain', 'C. diff colitis'],
      contraindications: ['Cephalosporin allergy', 'Neonates with hyperbilirubinemia', 'Neonates receiving calcium-containing IV solutions'],
      monitoring: ['Signs of allergic reaction', 'C. diff if diarrhea', 'CBC if prolonged use', 'LFTs'],
      interactions: {
        'calcium': 'Do not mix or co-administer with calcium-containing solutions (precipitation)',
        'warfarin': 'May increase INR'
      }
    },
    'azithromycin': {
      generic: 'Azithromycin',
      class: 'Macrolide Antibiotic',
      mechanism: 'Binds to 50S ribosomal subunit, inhibiting bacterial protein synthesis. Concentrates in tissues and has long half-life allowing short courses.',
      sideEffects: ['Diarrhea (5%)', 'Nausea (3%)', 'Abdominal pain', 'QT prolongation', 'Hearing loss (rare)'],
      contraindications: ['History of cholestatic jaundice with azithromycin', 'Hypersensitivity to macrolides', 'Caution with QT prolongation'],
      monitoring: ['QTc if risk factors', 'Signs of arrhythmia', 'LFTs if symptomatic', 'Hearing'],
      interactions: {
        'qt-prolonging drugs': 'Additive QT prolongation (antipsychotics, fluoroquinolones)',
        'warfarin': 'May increase INR',
        'digoxin': 'Increased digoxin levels'
      }
    },
    'ciprofloxacin': {
      generic: 'Ciprofloxacin',
      class: 'Fluoroquinolone Antibiotic',
      mechanism: 'Inhibits bacterial DNA gyrase and topoisomerase IV, preventing DNA replication, transcription, repair, and recombination.',
      sideEffects: ['Nausea (5%)', 'Diarrhea (2%)', 'Tendinopathy/rupture (black box)', 'QT prolongation', 'CNS effects', 'C. diff colitis', 'Photosensitivity'],
      contraindications: ['Concurrent tizanidine', 'History of tendon disorders with fluoroquinolones', 'Myasthenia gravis (may worsen)'],
      monitoring: ['Signs of tendinitis', 'QTc if risk factors', 'CNS symptoms', 'C. diff if diarrhea'],
      interactions: {
        'tizanidine': 'Contraindicated - significant interaction',
        'theophylline': 'Increased theophylline levels',
        'warfarin': 'Increased INR',
        'antacids': 'Reduced absorption - separate by 2 hours',
        'nsaids': 'Increased seizure risk'
      },
      renalDosing: { mild: 'No adjustment', moderate: '250-500mg q12h', severe: '250-500mg q18h' }
    },
    'vancomycin': {
      generic: 'Vancomycin Hydrochloride',
      class: 'Glycopeptide Antibiotic',
      mechanism: 'Inhibits bacterial cell wall synthesis by binding to D-Ala-D-Ala terminus of peptidoglycan precursors, preventing cross-linking. Active against gram-positive organisms including MRSA.',
      sideEffects: ['Nephrotoxicity (5-25%)', 'Red man syndrome (rapid infusion)', 'Ototoxicity', 'Thrombocytopenia', 'Neutropenia'],
      contraindications: ['Hypersensitivity (true allergy rare)'],
      monitoring: ['Trough levels (target 10-20 mcg/mL, or AUC-based dosing)', 'Renal function (Cr)', 'CBC weekly if prolonged', 'Signs of red man syndrome'],
      interactions: {
        'aminoglycosides': 'Additive nephrotoxicity and ototoxicity',
        'piperacillin-tazobactam': 'Increased AKI risk - controversial',
        'loop diuretics': 'Increased ototoxicity risk'
      },
      labAlerts: { creatinine: 'high' },
      renalDosing: { mild: 'Adjust per levels', moderate: 'Extend interval', severe: 'Dose after dialysis or per levels' }
    },
    'piperacillin/tazobactam': {
      generic: 'Piperacillin/Tazobactam (Zosyn)',
      class: 'Extended-Spectrum Penicillin + Beta-lactamase Inhibitor',
      mechanism: 'Piperacillin inhibits cell wall synthesis via PBP binding. Tazobactam inhibits many beta-lactamases. Broad spectrum including Pseudomonas.',
      sideEffects: ['Diarrhea (11%)', 'Rash', 'Thrombocytopenia', 'Leukopenia', 'Elevated LFTs', 'C. diff colitis', 'Hypokalemia'],
      contraindications: ['Penicillin allergy', 'Hypersensitivity'],
      monitoring: ['CBC (prolonged use)', 'Renal function', 'LFTs', 'Potassium', 'C. diff if diarrhea'],
      interactions: {
        'vancomycin': 'Possibly increased AKI risk',
        'methotrexate': 'Reduced clearance',
        'probenecid': 'Increased piperacillin levels'
      },
      renalDosing: { mild: 'No adjustment', moderate: '2.25g q6h', severe: 'CrCl <20: 2.25g q8h' }
    },
    'ondansetron': {
      generic: 'Ondansetron',
      class: '5-HT3 Receptor Antagonist',
      mechanism: 'Selectively blocks serotonin 5-HT3 receptors in the chemoreceptor trigger zone and vagal afferents, preventing nausea and vomiting signals.',
      sideEffects: ['Headache (9-27%)', 'Constipation (9%)', 'QT prolongation', 'Dizziness', 'Fatigue'],
      contraindications: ['Congenital long QT syndrome', 'Concurrent apomorphine'],
      monitoring: ['QTc if risk factors or high doses', 'Bowel function (constipation)', 'Electrolytes'],
      interactions: {
        'apomorphine': 'Contraindicated - profound hypotension',
        'qt-prolonging drugs': 'Additive QT prolongation',
        'tramadol': 'Reduced analgesic effect (serotonin pathway)'
      }
    },
    'morphine': {
      generic: 'Morphine Sulfate',
      class: 'Opioid Agonist',
      mechanism: 'Binds to mu-opioid receptors in the CNS, altering perception and emotional response to pain. Also causes euphoria, respiratory depression, and decreased GI motility.',
      sideEffects: ['Constipation (common)', 'Nausea/vomiting (28%)', 'Sedation', 'Respiratory depression', 'Pruritus', 'Urinary retention', 'Hypotension'],
      contraindications: ['Severe respiratory depression', 'Acute/severe bronchial asthma', 'GI obstruction', 'Concurrent MAOIs'],
      monitoring: ['Respiratory rate and depth', 'Pain scores', 'Sedation level', 'Bowel function', 'Signs of dependence'],
      interactions: {
        'benzodiazepines': 'Black box - increased risk of respiratory depression and death',
        'maois': 'Contraindicated - serotonin syndrome risk',
        'cns depressants': 'Additive sedation and respiratory depression'
      },
      labAlerts: { respiratory_rate: 'low' },
      renalDosing: { mild: 'Use with caution', moderate: 'Reduce dose 25-50%', severe: 'Avoid - active metabolites accumulate' }
    },
    'paracetamol': {
      generic: 'Acetaminophen/Paracetamol',
      class: 'Analgesic/Antipyretic',
      mechanism: 'Inhibits prostaglandin synthesis in the CNS and peripherally blocks pain impulse generation. Reduces fever through action on hypothalamic heat-regulating center.',
      sideEffects: ['Hepatotoxicity (overdose)', 'Rare: thrombocytopenia, skin reactions'],
      contraindications: ['Severe hepatic impairment', 'Severe active liver disease'],
      monitoring: ['LFTs if prolonged high-dose use', 'Total daily dose from all sources (max 4g/day, 2g in liver disease)', 'Signs of hepatotoxicity'],
      interactions: {
        'warfarin': 'May increase INR with regular use',
        'alcohol': 'Increased hepatotoxicity risk',
        'isoniazid': 'Increased hepatotoxicity risk'
      }
    },
    'salbutamol': {
      generic: 'Salbutamol/Albuterol',
      class: 'Short-Acting Beta-2 Agonist (SABA)',
      mechanism: 'Selectively stimulates beta-2 adrenergic receptors in bronchial smooth muscle, causing bronchodilation through increased cAMP and smooth muscle relaxation.',
      sideEffects: ['Tremor (20%)', 'Tachycardia', 'Palpitations', 'Hypokalemia (high doses)', 'Nervousness', 'Headache'],
      contraindications: ['Hypersensitivity', 'Use with caution in cardiovascular disease'],
      monitoring: ['Heart rate', 'Potassium (if frequent use)', 'Frequency of rescue use (indicates control)', 'Peak flow/FEV1'],
      interactions: {
        'beta-blockers': 'Reduced bronchodilator effect',
        'diuretics': 'Additive hypokalemia',
        'maois': 'Increased cardiovascular effects'
      },
      labAlerts: { potassium: 'low' }
    },
    'prednisolone': {
      generic: 'Prednisolone',
      class: 'Corticosteroid',
      mechanism: 'Binds to intracellular glucocorticoid receptors, modulating gene transcription to reduce inflammation, suppress immune responses, and affect carbohydrate/protein/fat metabolism.',
      sideEffects: ['Hyperglycemia', 'Insomnia', 'Mood changes', 'Increased appetite/weight gain', 'GI upset', 'Immunosuppression', 'Osteoporosis (long-term)', 'Adrenal suppression'],
      contraindications: ['Systemic fungal infections', 'Live vaccines during immunosuppressive doses'],
      monitoring: ['Blood glucose', 'Blood pressure', 'Signs of infection', 'Bone density (if prolonged)', 'HPA axis (if prolonged use)', 'Growth in children', 'Mood/behavior'],
      interactions: {
        'nsaids': 'Increased GI bleeding risk',
        'vaccines': 'Reduced efficacy of vaccines; avoid live vaccines',
        'diabetes medications': 'May need dose increase - steroids raise glucose',
        'cyp3a4 inducers': 'Reduced steroid effect (rifampin, phenytoin)'
      },
      labAlerts: { glucose: 'high' }
    },
    'levetiracetam': {
      generic: 'Levetiracetam (Keppra)',
      class: 'Anticonvulsant',
      mechanism: 'Binds to synaptic vesicle protein SV2A, modulating neurotransmitter release. Exact anticonvulsant mechanism not fully understood but different from other AEDs.',
      sideEffects: ['Somnolence (15%)', 'Behavioral changes/irritability (13%)', 'Dizziness (9%)', 'Fatigue', 'Headache'],
      contraindications: ['Hypersensitivity'],
      monitoring: ['Seizure frequency', 'Behavioral/mood changes', 'Renal function (renally cleared)', 'Suicidal ideation (FDA warning for all AEDs)'],
      interactions: {
        'few significant interactions': 'Major advantage - minimal CYP interactions',
        'cns depressants': 'Additive sedation'
      },
      renalDosing: { mild: 'No adjustment', moderate: '250-750mg q12h', severe: '250-500mg q12h' }
    },
    'carvedilol': {
      generic: 'Carvedilol',
      class: 'Non-selective Beta-Blocker with Alpha-1 Blocking Activity',
      mechanism: 'Blocks beta-1, beta-2, and alpha-1 adrenergic receptors. Reduces heart rate, contractility, and blood pressure. In heart failure, improves remodeling and reduces mortality.',
      sideEffects: ['Dizziness (32%)', 'Fatigue (24%)', 'Hypotension', 'Bradycardia', 'Weight gain', 'Hyperglycemia masking'],
      contraindications: ['Decompensated heart failure requiring inotropes', 'Severe bradycardia', '2nd/3rd degree AV block', 'Cardiogenic shock', 'Severe hepatic impairment', 'Bronchospastic conditions'],
      monitoring: ['Heart rate', 'Blood pressure', 'Signs of heart failure worsening (initiation)', 'Weight', 'Glucose in diabetics'],
      interactions: {
        'digoxin': 'Increased digoxin levels',
        'diltiazem/verapamil': 'Additive cardiac depression',
        'insulin': 'May mask hypoglycemia symptoms',
        'clonidine': 'Risk of rebound hypertension if clonidine stopped'
      }
    },
    'spironolactone': {
      generic: 'Spironolactone',
      class: 'Potassium-Sparing Diuretic / Aldosterone Antagonist',
      mechanism: 'Competitively binds to aldosterone receptors in distal tubule, blocking sodium reabsorption and potassium excretion. In heart failure, blocks harmful aldosterone effects on cardiac remodeling.',
      sideEffects: ['Hyperkalemia (dose-dependent)', 'Gynecomastia (9%)', 'GI upset', 'Menstrual irregularities', 'Erectile dysfunction'],
      contraindications: ['Hyperkalemia (K+ >5.5)', 'Severe renal impairment (CrCl <10)', 'Addison disease', 'Concurrent eplerenone'],
      monitoring: ['Potassium (within 1 week, then periodically)', 'Renal function', 'Blood pressure', 'Signs of hyperkalemia', 'Gynecomastia'],
      interactions: {
        'ace inhibitors/arbs': 'Significantly increased hyperkalemia risk',
        'potassium supplements': 'Contraindicated combination',
        'nsaids': 'Reduced diuretic effect, increased hyperkalemia',
        'digoxin': 'Increased digoxin levels'
      },
      labAlerts: { potassium: 'high', creatinine: 'high' },
      renalDosing: { mild: 'Use with caution', moderate: 'Reduce dose', severe: 'Generally avoid' }
    },
    'losartan': {
      generic: 'Losartan Potassium',
      class: 'Angiotensin II Receptor Blocker (ARB)',
      mechanism: 'Selectively blocks binding of angiotensin II to AT1 receptors, preventing vasoconstriction and aldosterone release. Does not affect bradykinin (less cough than ACEi).',
      sideEffects: ['Dizziness (3%)', 'Hyperkalemia', 'Hypotension', 'Fatigue', 'Diarrhea', 'Upper respiratory infection'],
      contraindications: ['Pregnancy', 'Concurrent aliskiren in diabetes', 'Bilateral renal artery stenosis'],
      monitoring: ['Blood pressure', 'Potassium', 'Renal function', 'Signs of angioedema (rare)'],
      interactions: {
        'potassium': 'Increased hyperkalemia risk',
        'lithium': 'Increased lithium levels',
        'nsaids': 'Reduced effect, increased renal risk'
      },
      labAlerts: { potassium: 'high' }
    },
    'ramipril': {
      generic: 'Ramipril',
      class: 'ACE Inhibitor',
      mechanism: 'Prodrug converted to ramiprilat, which inhibits ACE, preventing angiotensin I to II conversion. Reduces aldosterone, causes vasodilation, and provides cardio/renal protection.',
      sideEffects: ['Cough (12%)', 'Dizziness (4%)', 'Hyperkalemia', 'Hypotension', 'Angioedema (rare)', 'Acute kidney injury'],
      contraindications: ['History of angioedema', 'Pregnancy', 'Bilateral renal artery stenosis'],
      monitoring: ['Blood pressure', 'Potassium', 'Renal function (Cr, BUN)', 'Signs of angioedema'],
      interactions: {
        'potassium': 'Hyperkalemia risk',
        'nsaids': 'Reduced effect, renal risk',
        'lithium': 'Increased lithium levels',
        'aliskiren': 'Avoid in diabetes'
      },
      labAlerts: { potassium: 'high', creatinine: 'high' }
    },
    'digoxin': {
      generic: 'Digoxin',
      class: 'Cardiac Glycoside',
      mechanism: 'Inhibits Na+/K+-ATPase, increasing intracellular calcium, enhancing cardiac contractility (positive inotrope). Also slows AV conduction via vagal effects.',
      sideEffects: ['Nausea/vomiting', 'Visual disturbances (yellow-green halos)', 'Arrhythmias', 'Confusion', 'Fatigue'],
      contraindications: ['Ventricular fibrillation', 'Hypertrophic cardiomyopathy with outflow obstruction', 'WPW syndrome with AF'],
      monitoring: ['Digoxin levels (0.5-2.0 ng/mL, lower in HF)', 'Potassium (hypokalemia increases toxicity)', 'Renal function', 'Heart rate', 'Signs of toxicity'],
      interactions: {
        'amiodarone': 'Increases digoxin level 70-100%',
        'verapamil': 'Increases digoxin levels',
        'diuretics': 'Hypokalemia increases toxicity risk',
        'quinidine': 'Doubles digoxin levels'
      },
      labAlerts: { potassium: 'low' },
      renalDosing: { mild: 'Reduce dose', moderate: 'Reduce dose significantly', severe: 'Use with extreme caution, low doses' }
    },
    'heparin': {
      generic: 'Unfractionated Heparin',
      class: 'Anticoagulant',
      mechanism: 'Binds to antithrombin III, accelerating its inhibition of thrombin (Factor IIa) and Factor Xa by ~1000-fold. Short half-life, reversible with protamine.',
      sideEffects: ['Bleeding', 'HIT (heparin-induced thrombocytopenia)', 'Osteoporosis (long-term)', 'Hyperkalemia', 'Elevated LFTs'],
      contraindications: ['Active major bleeding', 'Severe thrombocytopenia', 'History of HIT'],
      monitoring: ['aPTT (target 1.5-2.5x control) or anti-Xa levels', 'Platelets (baseline, day 4, then periodically for HIT)', 'Signs of bleeding', 'Hemoglobin'],
      interactions: {
        'antiplatelet agents': 'Increased bleeding risk',
        'thrombolytics': 'Significantly increased bleeding'
      },
      labAlerts: { platelets: 'low', aptt: 'high' }
    },
    'rivaroxaban': {
      generic: 'Rivaroxaban (Xarelto)',
      class: 'Direct Factor Xa Inhibitor (DOAC)',
      mechanism: 'Directly and selectively inhibits Factor Xa (free and clot-bound), interrupting the coagulation cascade without requiring antithrombin as a cofactor.',
      sideEffects: ['Bleeding (major 1-4%)', 'Bruising', 'Nausea', 'Anemia', 'Wound secretion post-surgery'],
      contraindications: ['Active pathological bleeding', 'Severe hepatic disease with coagulopathy', 'Pregnancy/breastfeeding'],
      monitoring: ['Signs of bleeding', 'Hemoglobin if bleeding suspected', 'Renal function (affects clearance)', 'No routine coagulation monitoring needed'],
      interactions: {
        'strong cyp3a4/p-gp inhibitors': 'Increased rivaroxaban levels (ketoconazole, ritonavir)',
        'strong cyp3a4 inducers': 'Reduced efficacy (rifampin, phenytoin)',
        'antiplatelet agents': 'Increased bleeding risk'
      },
      renalDosing: { mild: 'No adjustment', moderate: 'Use with caution', severe: 'Avoid if CrCl <15' }
    },
    'tramadol': {
      generic: 'Tramadol Hydrochloride',
      class: 'Opioid Analgesic (Weak)',
      mechanism: 'Weak mu-opioid receptor agonist plus inhibition of norepinephrine and serotonin reuptake, providing dual analgesic mechanisms.',
      sideEffects: ['Nausea (24%)', 'Dizziness (26%)', 'Constipation (24%)', 'Headache', 'Seizures (dose-related)', 'Serotonin syndrome'],
      contraindications: ['Seizure disorder', 'Concurrent MAOIs', 'Acute intoxication with alcohol/opioids/psychotropics', 'Severe renal/hepatic impairment'],
      monitoring: ['Pain control', 'Signs of serotonin syndrome', 'Seizure activity', 'Signs of dependence', 'Respiratory status'],
      interactions: {
        'ssris/snris': 'Serotonin syndrome risk',
        'maois': 'Contraindicated',
        'carbamazepine': 'Reduced tramadol effect',
        'ondansetron': 'Reduced tramadol efficacy'
      },
      renalDosing: { mild: 'No adjustment', moderate: 'Extend interval to q12h', severe: 'Max 50mg q12h' }
    },
    'allopurinol': {
      generic: 'Allopurinol',
      brandNames: ['Zyloric', 'Zyloprim', 'Lopurin'],
      class: 'Xanthine Oxidase Inhibitor',
      mechanism: 'Inhibits xanthine oxidase, reducing conversion of hypoxanthine to xanthine and xanthine to uric acid, thereby lowering serum and urine uric acid concentrations.',
      commonDoses: 'Start 100mg daily, titrate by 100mg every 2-4 weeks to target uric acid <6mg/dL. Usual maintenance 300-600mg daily.',
      sideEffects: ['Rash (2%)', 'GI upset', 'Elevated LFTs', 'Hypersensitivity syndrome (rare but severe)', 'Gout flare on initiation', 'Stevens-Johnson syndrome (rare)'],
      contraindications: ['Hypersensitivity to allopurinol', 'Do NOT start during acute gout attack', 'HLA-B*5801 positive patients (high risk of severe cutaneous reactions)'],
      monitoring: ['Serum uric acid (target <6mg/dL)', 'Renal function', 'LFTs at baseline and periodically', 'Signs of hypersensitivity reaction', 'CBC'],
      interactions: {
        'azathioprine': 'MAJOR: Reduce azathioprine dose by 75% - increased toxicity',
        '6-mercaptopurine': 'MAJOR: Reduce dose by 75% - increased myelosuppression',
        'warfarin': 'May increase INR - monitor closely',
        'amoxicillin': 'Increased rash risk',
        'ampicillin': 'Increased rash risk',
        'thiazides': 'Increased risk of hypersensitivity reactions',
        'ace inhibitors': 'Increased hypersensitivity risk'
      },
      labAlerts: { uric_acid: 'high' },
      renalDosing: { mild: 'Max 200mg/day if CrCl 40-60', moderate: 'Max 100mg/day if CrCl 20-40', severe: '100mg every 2-3 days if CrCl <20' }
    }
  },
  
  // Brand name to generic mapping for common drugs
  brandToGeneric: {
    'zyloric': 'allopurinol',
    'zyloprim': 'allopurinol',
    'lopurin': 'allopurinol',
    'glucophage': 'metformin',
    'lipitor': 'atorvastatin',
    'norvasc': 'amlodipine',
    'zestril': 'lisinopril',
    'prinivil': 'lisinopril',
    'lasix': 'furosemide',
    'plavix': 'clopidogrel',
    'coumadin': 'warfarin',
    'zosyn': 'piperacillin/tazobactam',
    'augmentin': 'amoxicillin/clavulanate',
    'flagyl': 'metronidazole',
    'diflucan': 'fluconazole',
    'zithromax': 'azithromycin',
    'cipro': 'ciprofloxacin',
    'levaquin': 'levofloxacin',
    'ultram': 'tramadol',
    'nexium': 'esomeprazole',
    'prilosec': 'omeprazole',
    'protonix': 'pantoprazole',
    'lovenox': 'enoxaparin',
    'eliquis': 'apixaban',
    'xarelto': 'rivaroxaban',
    'lantus': 'insulin glargine',
    'novolog': 'insulin aspart',
    'humalog': 'insulin lispro'
  },
  
  // Get drug info (case-insensitive lookup with brand name support)
  getDrug: function(name) {
    if (!name) return null;
    const key = name.toLowerCase().trim();
    
    // Direct match
    if (this.drugs[key]) return this.drugs[key];
    
    // Check brand name mapping
    if (this.brandToGeneric[key]) {
      const genericKey = this.brandToGeneric[key];
      if (this.drugs[genericKey]) return this.drugs[genericKey];
    }
    
    // Partial match on drug keys
    for (const [drugKey, data] of Object.entries(this.drugs)) {
      if (key.includes(drugKey) || drugKey.includes(key)) {
        return data;
      }
      // Check generic name
      if (data.generic && data.generic.toLowerCase().includes(key)) {
        return data;
      }
      // Check brand names array
      if (data.brandNames && data.brandNames.some(b => b.toLowerCase() === key || b.toLowerCase().includes(key))) {
        return data;
      }
    }
    
    // Partial match on brand names in mapping
    for (const [brand, generic] of Object.entries(this.brandToGeneric)) {
      if (key.includes(brand) || brand.includes(key)) {
        if (this.drugs[generic]) return this.drugs[generic];
      }
    }
    
    return null;
  },
  
  // Get patient-specific warnings
  getPatientWarnings: function(drugName, patient) {
    const warnings = [];
    const drug = this.getDrug(drugName);
    if (!drug || !patient) return warnings;
    
    const diagnosis = (patient.diagnosis || '').toLowerCase();
    const meds = (patient.medications || []).map(m => m.name?.toLowerCase());
    const labData = patient.labData?.parameters || [];
    
    // Check drug interactions with current medications
    if (drug.interactions) {
      meds.forEach(med => {
        Object.entries(drug.interactions).forEach(([trigger, warning]) => {
          if (med && (med.includes(trigger) || trigger.includes(med))) {
            warnings.push({
              icon: '⚠️',
              type: 'interaction',
              severity: 'high',
              text: `Interaction with ${med}: ${warning}`
            });
          }
        });
      });
    }
    
    // Check lab-based warnings
    if (drug.labAlerts) {
      labData.forEach(param => {
        const paramKey = param.name?.toLowerCase();
        const status = param.values?.[0]?.status;
        const value = param.values?.[0]?.value;
        
        if (drug.labAlerts[paramKey]) {
          const alertType = drug.labAlerts[paramKey];
          if ((alertType === 'high' && (status === 'high' || status === 'critical')) ||
              (alertType === 'low' && status === 'low')) {
            warnings.push({
              icon: '🔬',
              type: 'lab',
              severity: status === 'critical' ? 'critical' : 'moderate',
              text: `Caution: ${param.name} is ${status} (${value}) - may affect ${drugName} safety/dosing`
            });
          }
        }
      });
    }
    
    // Check renal dosing
    if (drug.renalDosing) {
      const crParam = labData.find(p => p.name?.toLowerCase().includes('creatinine') || p.name?.toLowerCase().includes('egfr'));
      if (crParam?.values?.[0]?.status === 'high' || crParam?.values?.[0]?.status === 'critical') {
        warnings.push({
          icon: '🫘',
          type: 'renal',
          severity: 'high',
          text: `Renal impairment detected - ${drug.renalDosing.severe || drug.renalDosing.moderate || 'adjust dose'}`
        });
      }
    }
    
    // Check diagnosis-specific warnings
    if (diagnosis.includes('liver') || diagnosis.includes('hepatic') || diagnosis.includes('cirrhosis')) {
      if (drug.contraindications?.some(c => c.toLowerCase().includes('hepatic') || c.toLowerCase().includes('liver'))) {
        warnings.push({
          icon: '🫀',
          type: 'diagnosis',
          severity: 'high',
          text: 'Patient has liver disease - review hepatic contraindications'
        });
      }
    }
    
    if (diagnosis.includes('renal') || diagnosis.includes('kidney') || diagnosis.includes('ckd')) {
      if (drug.renalDosing) {
        warnings.push({
          icon: '🫘',
          type: 'diagnosis',
          severity: 'moderate',
          text: `Patient has renal disease - consider dose adjustment`
        });
      }
    }
    
    return warnings;
  },
  
  // Learn from patient data
  learnedInteractions: {},
  
  recordInteraction: function(drugName, patientContext, outcome) {
    // Store learned patterns (could be persisted to localStorage or cloud)
    const key = drugName.toLowerCase();
    if (!this.learnedInteractions[key]) {
      this.learnedInteractions[key] = [];
    }
    this.learnedInteractions[key].push({
      context: patientContext,
      outcome: outcome,
      timestamp: Date.now()
    });
  }
};

// Medical Sources API Integration Module
const MedicalSourcesAPI = {

  // Fetch drug information from RxNorm (NIH/NLM)
  async getRxNormInfo(drugName) {
    try {
      // Search for drug concept
      const searchUrl = `https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(drugName)}`;
      const searchRes = await fetch(searchUrl);
      const searchData = await searchRes.json();

      if (!searchData.drugGroup?.conceptGroup) {
        return null;
      }

      // Get first RxCUI (RxNorm Concept Unique Identifier)
      let rxcui = null;
      for (const group of searchData.drugGroup.conceptGroup) {
        if (group.conceptProperties?.[0]?.rxcui) {
          rxcui = group.conceptProperties[0].rxcui;
          break;
        }
      }

      if (!rxcui) return null;

      // Get drug properties
      const propsUrl = `https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/allProperties.json?prop=all`;
      const propsRes = await fetch(propsUrl);
      const propsData = await propsRes.json();

      return {
        rxcui: rxcui,
        properties: propsData.propConceptGroup?.propConcept || [],
        source: 'RxNorm (NIH/NLM)'
      };
    } catch (e) {
      console.error('RxNorm API error:', e);
      return null;
    }
  },

  // Fetch drug information from DailyMed (FDA)
  async getDailyMedInfo(drugName) {
    try {
      // Search for drug in DailyMed
      const searchUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/spls.json?drug_name=${encodeURIComponent(drugName)}`;
      const searchRes = await fetch(searchUrl);
      const searchData = await searchRes.json();

      if (!searchData.data || searchData.data.length === 0) {
        return null;
      }

      // Get the first matching drug's SPL (Structured Product Labeling) ID
      const setid = searchData.data[0].setid;

      // Fetch detailed information
      const detailUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/${setid}.json`;
      const detailRes = await fetch(detailUrl);
      const detailData = await detailRes.json();

      return {
        setid: setid,
        title: detailData.data?.title || drugName,
        dosage: this.extractDosageFromDailyMed(detailData),
        warnings: this.extractWarningsFromDailyMed(detailData),
        indications: this.extractIndicationsFromDailyMed(detailData),
        source: 'DailyMed (FDA)',
        url: `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${setid}`
      };
    } catch (e) {
      console.error('DailyMed API error:', e);
      return null;
    }
  },

  // Extract dosage information from DailyMed data
  extractDosageFromDailyMed(detailData) {
    const sections = detailData.data?.sections || [];
    for (const section of sections) {
      if (section.title?.toLowerCase().includes('dosage') ||
          section.title?.toLowerCase().includes('administration')) {
        // Remove HTML tags and extract text
        return section.text?.replace(/<[^>]*>/g, '').trim().substring(0, 500) || null;
      }
    }
    return null;
  },

  // Extract warnings from DailyMed data
  extractWarningsFromDailyMed(detailData) {
    const sections = detailData.data?.sections || [];
    const warnings = [];
    for (const section of sections) {
      if (section.title?.toLowerCase().includes('warning') ||
          section.title?.toLowerCase().includes('precaution') ||
          section.title?.toLowerCase().includes('contraindication')) {
        const text = section.text?.replace(/<[^>]*>/g, '').trim().substring(0, 300);
        if (text) warnings.push(text);
      }
    }
    return warnings;
  },

  // Extract indications from DailyMed data
  extractIndicationsFromDailyMed(detailData) {
    const sections = detailData.data?.sections || [];
    for (const section of sections) {
      if (section.title?.toLowerCase().includes('indication')) {
        return section.text?.replace(/<[^>]*>/g, '').trim().substring(0, 400) || null;
      }
    }
    return null;
  },

  // Fetch drug adverse events from OpenFDA
  async getOpenFDAInfo(drugName) {
    try {
      // Search for drug label information
      const searchUrl = `https://api.fda.gov/drug/label.json?search=openfda.brand_name:"${encodeURIComponent(drugName)}"&limit=1`;
      const searchRes = await fetch(searchUrl);
      const searchData = await searchRes.json();

      if (!searchData.results || searchData.results.length === 0) {
        // Try with generic name
        const genericUrl = `https://api.fda.gov/drug/label.json?search=openfda.generic_name:"${encodeURIComponent(drugName)}"&limit=1`;
        const genericRes = await fetch(genericUrl);
        const genericData = await genericRes.json();

        if (!genericData.results || genericData.results.length === 0) {
          return null;
        }

        return this.processOpenFDAResult(genericData.results[0]);
      }

      return this.processOpenFDAResult(searchData.results[0]);
    } catch (e) {
      console.error('OpenFDA API error:', e);
      return null;
    }
  },

  // Process OpenFDA result
  processOpenFDAResult(result) {
    return {
      warnings: result.warnings?.[0] || result.boxed_warning?.[0] || null,
      adverseReactions: result.adverse_reactions?.[0] || null,
      dosageAndAdministration: result.dosage_and_administration?.[0] || null,
      contraindications: result.contraindications?.[0] || null,
      brandName: result.openfda?.brand_name?.[0] || null,
      genericName: result.openfda?.generic_name?.[0] || null,
      source: 'OpenFDA',
      blackBoxWarning: result.boxed_warning?.[0] || null
    };
  },

  // Combined fetch from all sources
  async fetchFromAllSources(drugName) {
    const results = {
      drugName: drugName,
      sources: [],
      combinedData: {}
    };

    // Fetch from all sources in parallel
    const [rxnorm, dailymed, openfda] = await Promise.all([
      this.getRxNormInfo(drugName),
      this.getDailyMedInfo(drugName),
      this.getOpenFDAInfo(drugName)
    ]);

    // Combine results
    if (rxnorm) {
      results.sources.push('RxNorm (NIH/NLM)');
      results.combinedData.rxnorm = rxnorm;
    }

    if (dailymed) {
      results.sources.push('DailyMed (FDA)');
      results.combinedData.dailymed = dailymed;

      // Prefer DailyMed for dosage (FDA-approved)
      if (dailymed.dosage) {
        results.combinedData.dosage = dailymed.dosage;
        results.combinedData.dosageSource = 'DailyMed (FDA)';
        results.combinedData.dosageUrl = dailymed.url;
      }
    }

    if (openfda) {
      results.sources.push('OpenFDA');
      results.combinedData.openfda = openfda;

      // Use OpenFDA dosage if DailyMed didn't provide it
      if (!results.combinedData.dosage && openfda.dosageAndAdministration) {
        results.combinedData.dosage = openfda.dosageAndAdministration;
        results.combinedData.dosageSource = 'OpenFDA';
      }

      // Black box warnings are critical
      if (openfda.blackBoxWarning) {
        results.combinedData.blackBoxWarning = openfda.blackBoxWarning;
      }
    }

    return results;
  }
};

// Dosage Calculator - calculates patient-specific dosages
const DosageCalculator = {

  // Calculate dose based on weight (mg/kg)
  calculateWeightBasedDose(baselineDose, patientWeight, unit = 'mg') {
    if (!patientWeight || patientWeight <= 0) return null;
    const dose = baselineDose * patientWeight;
    return `${dose.toFixed(1)} ${unit}`;
  },

  // Adjust dose for renal function (CrCl-based)
  adjustForRenalFunction(baseDose, crCl) {
    if (!crCl) return baseDose;

    // Standard adjustment factors
    if (crCl >= 60) {
      return { dose: baseDose, adjustment: 'No adjustment needed (normal renal function)', category: 'normal' };
    } else if (crCl >= 30 && crCl < 60) {
      return { dose: baseDose * 0.75, adjustment: '25% dose reduction (moderate impairment)', category: 'moderate' };
    } else if (crCl >= 15 && crCl < 30) {
      return { dose: baseDose * 0.5, adjustment: '50% dose reduction (severe impairment)', category: 'severe' };
    } else {
      return { dose: baseDose * 0.25, adjustment: '75% dose reduction (ESRD - consult nephrologist)', category: 'esrd' };
    }
  },

  // Calculate creatinine clearance (Cockcroft-Gault)
  calculateCrCl(age, weight, creatinine, isMale = true) {
    if (!age || !weight || !creatinine) return null;

    const numerator = (140 - age) * weight;
    const denominator = 72 * creatinine;
    let crCl = numerator / denominator;

    if (!isMale) {
      crCl = crCl * 0.85; // Female adjustment
    }

    return Math.round(crCl);
  },

  // Get patient-specific dosing recommendations
  getPatientSpecificDosing(drugName, patient, standardDosage) {
    const recommendations = [];

    // Extract patient data
    const age = patient.age || null;
    const weight = patient.weight || null;
    const creatinine = this.getCreatinineFromLabs(patient);

    // Calculate CrCl if we have the data
    if (age && weight && creatinine) {
      const crCl = this.calculateCrCl(age, weight, creatinine, true); // Assume male for now

      if (crCl) {
        recommendations.push({
          type: 'renal',
          label: 'Estimated CrCl',
          value: `${crCl} mL/min`,
          note: this.getRenalFunctionCategory(crCl)
        });

        // Check if renal adjustment needed
        if (crCl < 60) {
          recommendations.push({
            type: 'warning',
            label: 'Renal Adjustment',
            value: 'Dose adjustment may be required',
            severity: crCl < 30 ? 'high' : 'medium'
          });
        }
      }
    }

    // Age-based warnings
    if (age && age >= 65) {
      recommendations.push({
        type: 'warning',
        label: 'Geriatric Patient',
        value: 'Consider lower initial dose and monitor closely',
        severity: 'medium'
      });
    }

    return recommendations;
  },

  // Extract creatinine from lab data
  getCreatinineFromLabs(patient) {
    const labs = patient.labData?.parameters || [];
    for (const lab of labs) {
      if (lab.name?.toLowerCase().includes('creatinine') ||
          lab.name?.toLowerCase().includes('cr')) {
        return parseFloat(lab.values?.[0]?.value);
      }
    }
    return null;
  },

  // Get renal function category
  getRenalFunctionCategory(crCl) {
    if (crCl >= 60) return 'Normal renal function';
    if (crCl >= 30) return 'Moderate renal impairment';
    if (crCl >= 15) return 'Severe renal impairment';
    return 'End-stage renal disease';
  }
};

window.openDrugInfo = async function(drugName, medIdx) {
  const p = state.currentPatient;
  const med = medIdx !== undefined ? p.medications?.[medIdx] : null;

  $('drugInfoTitle').textContent = drugName;
  openModal('drugInfoModal');

  // INSTANT: Check local knowledge base first
  const localDrug = DrugKnowledgeBase.getDrug(drugName);
  const patientWarnings = DrugKnowledgeBase.getPatientWarnings(drugName, p);

  if (localDrug) {
    // Render immediately from local knowledge, but also fetch from medical sources
    renderDrugInfoFromKnowledge(localDrug, drugName, patientWarnings, med);

    // Fetch medical sources in background to enhance data
    MedicalSourcesAPI.fetchFromAllSources(drugName).then(medicalData => {
      if (medicalData.sources.length > 0) {
        // Re-render with enhanced data
        renderDrugInfoFromKnowledgeEnhanced(localDrug, drugName, patientWarnings, med, medicalData, p);
      }
    }).catch(e => console.error('Background medical sources fetch failed:', e));

    return;
  }

  // If not in local KB, show loading and try medical sources first
  $('drugInfoBody').innerHTML = `
    <div style="text-align:center;padding:40px">
      <div class="spinner"></div>
      <p style="margin-top:16px;color:var(--text-muted)">Fetching ${esc(drugName)} from verified medical sources...</p>
      <p style="margin-top:8px;font-size:12px;color:var(--text-muted)">RxNorm • DailyMed • OpenFDA</p>
    </div>
  `;

  try {
    // Fetch from medical sources first
    const medicalData = await MedicalSourcesAPI.fetchFromAllSources(drugName);

    if (medicalData.sources.length > 0) {
      // We have data from medical sources, render it
      renderDrugInfoFromMedicalSources(drugName, medicalData, p, med);
      return;
    }

    // If medical sources didn't return data, try the configured API
    if (!state.settings.apiUrl) {
      renderBasicDrugInfo(drugName, med);
      return;
    }

    const patientContext = {
      diagnosis: p.diagnosis || '',
      medications: (p.medications || []).map(m => m.name).filter(n => n !== drugName),
      labData: p.labData?.parameters?.slice(0, 5).map(param => ({
        name: param.name,
        value: param.values?.[0]?.value,
        status: param.values?.[0]?.status
      })) || []
    };

    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'getDrugInfo',
        drugName: drugName,
        patientContext: patientContext,
        indication: med?.indication || ''
      })
    });

    const data = await res.json();

    if (data.error) throw new Error(data.error);

    renderDrugInfoContent(data, drugName, patientContext);

  } catch (e) {
    console.error('Drug info error:', e);
    renderBasicDrugInfo(drugName, med);
  }
};

function renderDrugInfoFromKnowledge(drug, drugName, warnings, med) {
  let html = '';

  // Header badge showing instant lookup
  html += `
    <div class="drug-instant-badge">
      <span class="instant-icon">⚡</span>
      <span>Instant Lookup</span>
      <span class="instant-source">Neural Knowledge Base</span>
    </div>
  `;

  // Patient-specific warnings (most important - show first, always expanded)
  if (warnings.length > 0) {
    const criticalWarnings = warnings.filter(w => w.severity === 'critical' || w.severity === 'high');
    const otherWarnings = warnings.filter(w => w.severity !== 'critical' && w.severity !== 'high');

    html += `
      <div class="patient-context-alert ${criticalWarnings.length > 0 ? 'critical' : ''}">
        <div class="context-alert-header">
          <div class="context-alert-icon">${criticalWarnings.length > 0 ? '🚨' : '⚠️'}</div>
          <div class="context-alert-title">${criticalWarnings.length > 0 ? 'Critical Alerts for This Patient' : 'Patient-Specific Warnings'}</div>
        </div>
        <ul class="context-alert-list">
          ${warnings.map(w => `
            <li class="${w.severity}">
              <span class="alert-icon">${w.icon}</span>
              <span>${esc(w.text)}</span>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
  }

  // Drug class & mechanism (always expanded)
  html += `
    <div class="drug-section">
      <div class="drug-section-title"><span>🧬</span> ${esc(drug.class || 'Drug Class')}</div>
      <p class="drug-info-text">${esc(drug.mechanism)}</p>
    </div>
  `;

  // Side Effects - collapsible
  if (drug.sideEffects?.length > 0) {
    html += `
      <div class="drug-collapsible-section active" data-section="side-effects-kb">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('side-effects-kb')">
          <div class="drug-collapsible-title">
            <span>⚡</span>
            <span>Side Effects</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list">
              ${drug.sideEffects.map(s => `<li>${esc(s)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Contraindications - collapsible
  if (drug.contraindications?.length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="contraindications-kb">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('contraindications-kb')">
          <div class="drug-collapsible-title">
            <span>🚫</span>
            <span>Contraindications</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list contraindications">
              ${drug.contraindications.map(c => `<li>${esc(c)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Monitoring - collapsible
  if (drug.monitoring?.length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="monitoring-kb">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('monitoring-kb')">
          <div class="drug-collapsible-title">
            <span>📊</span>
            <span>Monitoring Parameters</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list monitoring">
              ${drug.monitoring.map(m => `<li>${esc(m)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Key Interactions - collapsible
  if (drug.interactions && Object.keys(drug.interactions).length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="interactions-kb">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('interactions-kb')">
          <div class="drug-collapsible-title">
            <span>💊</span>
            <span>Key Drug Interactions</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list interactions">
              ${Object.entries(drug.interactions).map(([trigger, desc]) => `
                <li><strong>${esc(trigger)}:</strong> ${esc(desc)}</li>
              `).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Renal Dosing - collapsible
  if (drug.renalDosing) {
    html += `
      <div class="drug-collapsible-section" data-section="renal-kb">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('renal-kb')">
          <div class="drug-collapsible-title">
            <span>🫘</span>
            <span>Renal Dosing</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <div class="renal-dosing-grid">
              <div class="renal-dose-item">
                <span class="renal-label">Mild</span>
                <span class="renal-value">${esc(drug.renalDosing.mild)}</span>
              </div>
              <div class="renal-dose-item">
                <span class="renal-label">Moderate</span>
                <span class="renal-value">${esc(drug.renalDosing.moderate)}</span>
              </div>
              <div class="renal-dose-item">
                <span class="renal-label">Severe</span>
                <span class="renal-value">${esc(drug.renalDosing.severe)}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Data Sources Footer
  html += `
    <div class="drug-data-sources">
      <div class="drug-data-sources-title"><span>📚</span> References & Sources</div>
      <div class="drug-data-source-item">
        <span class="drug-data-source-badge">UpToDate</span>
        <a href="https://www.uptodate.com/contents/search?search=${encodeURIComponent(drugName)}" target="_blank" rel="noopener noreferrer" style="color:var(--primary);text-decoration:none;font-size:0.8rem">Search ${esc(drugName)} →</a>
      </div>
      <div class="drug-data-source-item">
        <span class="drug-data-source-badge">PubMed</span>
        <a href="https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(drugName)}" target="_blank" rel="noopener noreferrer" style="color:var(--primary);text-decoration:none;font-size:0.8rem">Research Articles →</a>
      </div>
      <div class="drug-data-source-item">
        <span class="drug-data-source-badge">DailyMed</span>
        <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(drugName)}" target="_blank" rel="noopener noreferrer" style="color:var(--primary);text-decoration:none;font-size:0.8rem">FDA Label →</a>
      </div>
    </div>
  `;

  $('drugInfoBody').innerHTML = html;
}

// Enhanced rendering with medical sources data
function renderDrugInfoFromKnowledgeEnhanced(drug, drugName, warnings, med, medicalData, patient) {
  let html = '';

  // Header badge showing instant lookup + medical sources
  html += `
    <div class="drug-instant-badge">
      <span class="instant-icon">⚡</span>
      <span>Enhanced with Medical Sources</span>
      <span class="instant-source">Neural KB + ${esc(medicalData.sources.join(' • '))}</span>
    </div>
  `;

  // Patient-specific warnings (most important - show first, always expanded)
  if (warnings.length > 0) {
    const criticalWarnings = warnings.filter(w => w.severity === 'critical' || w.severity === 'high');
    const otherWarnings = warnings.filter(w => w.severity !== 'critical' && w.severity !== 'high');

    html += `
      <div class="patient-context-alert ${criticalWarnings.length > 0 ? 'critical' : ''}">
        <div class="context-alert-header">
          <div class="context-alert-icon">${criticalWarnings.length > 0 ? '🚨' : '⚠️'}</div>
          <div class="context-alert-title">${criticalWarnings.length > 0 ? 'Critical Alerts for This Patient' : 'Patient-Specific Warnings'}</div>
        </div>
        <ul class="context-alert-list">
          ${warnings.map(w => `
            <li class="${w.severity}">
              <span class="alert-icon">${w.icon}</span>
              <span>${esc(w.text)}</span>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
  }

  // FDA Black Box Warning (if available from OpenFDA, always expanded)
  if (medicalData.combinedData.blackBoxWarning) {
    html += `
      <div class="drug-section-critical">
        <div class="context-alert-header">
          <div class="context-alert-icon">🚨</div>
          <div class="context-alert-title">FDA BLACK BOX WARNING</div>
        </div>
        <div style="padding: 12px; background: var(--bg-elevated); border-radius: 6px; margin-top: 8px;">
          <p style="color: #d32f2f; font-weight: 500; margin: 0; line-height: 1.6;">${esc(medicalData.combinedData.blackBoxWarning.substring(0, 500))}${medicalData.combinedData.blackBoxWarning.length > 500 ? '...' : ''}</p>
          <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Source: OpenFDA</p>
        </div>
      </div>
    `;
  }

  // DOSAGE INFORMATION (from verified medical sources, always expanded)
  if (medicalData.combinedData.dosage) {
    html += `
      <div class="drug-section-highlight">
        <div class="drug-section-title"><span>💊</span> DOSAGE & ADMINISTRATION</div>
        <p class="drug-info-text">${esc(medicalData.combinedData.dosage)}</p>
        <div style="margin-top: 12px; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
          <span style="font-size: 16px;">✓</span>
          <span style="font-size: 12px; color: var(--text-muted);">
            Verified source: <strong>${esc(medicalData.combinedData.dosageSource)}</strong>
          </span>
          ${medicalData.combinedData.dosageUrl ? `
            <a href="${esc(medicalData.combinedData.dosageUrl)}" target="_blank" style="margin-left: auto; font-size: 12px; color: var(--primary); text-decoration: none;">View Source →</a>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Patient-specific dosing recommendations (always expanded)
  const dosingRecs = DosageCalculator.getPatientSpecificDosing(drugName, patient, medicalData.combinedData.dosage);
  if (dosingRecs.length > 0) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>🎯</span> Patient-Specific Considerations</div>
        <div style="display: grid; gap: 8px;">
          ${dosingRecs.map(rec => `
            <div style="padding: 10px; background: var(--bg-elevated); border-radius: 6px; border-left: 3px solid ${rec.type === 'warning' ? '#ff9800' : '#2196f3'};">
              <div style="font-weight: 500; font-size: 13px; margin-bottom: 4px;">${esc(rec.label)}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${esc(rec.value)}</div>
              ${rec.note ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${esc(rec.note)}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Drug class & mechanism (always expanded)
  html += `
    <div class="drug-section">
      <div class="drug-section-title"><span>🧬</span> ${esc(drug.class || 'Drug Class')}</div>
      <p class="drug-info-text">${esc(drug.mechanism)}</p>
    </div>
  `;

  // Indications - collapsible
  if (medicalData.combinedData.dailymed?.indications) {
    html += `
      <div class="drug-collapsible-section active" data-section="indications-enh">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('indications-enh')">
          <div class="drug-collapsible-title">
            <span>📋</span>
            <span>Indications & Usage</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <p class="drug-info-text">${esc(medicalData.combinedData.dailymed.indications)}</p>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Source: DailyMed (FDA)</p>
          </div>
        </div>
      </div>
    `;
  }

  // Side Effects - collapsible
  if (drug.sideEffects?.length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="side-effects">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('side-effects')">
          <div class="drug-collapsible-title">
            <span>⚡</span>
            <span>Side Effects</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list">
              ${drug.sideEffects.map(s => `<li>${esc(s)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Contraindications - collapsible
  if (drug.contraindications?.length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="contraindications-enh">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('contraindications-enh')">
          <div class="drug-collapsible-title">
            <span>🚫</span>
            <span>Contraindications</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list contraindications">
              ${drug.contraindications.map(c => `<li>${esc(c)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Monitoring - collapsible
  if (drug.monitoring?.length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="monitoring">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('monitoring')">
          <div class="drug-collapsible-title">
            <span>📊</span>
            <span>Monitoring Parameters</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list monitoring">
              ${drug.monitoring.map(m => `<li>${esc(m)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Key Interactions - collapsible
  if (drug.interactions && Object.keys(drug.interactions).length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="interactions">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('interactions')">
          <div class="drug-collapsible-title">
            <span>💊</span>
            <span>Key Drug Interactions</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <ul class="drug-info-list interactions">
              ${Object.entries(drug.interactions).map(([trigger, desc]) => `
                <li><strong>${esc(trigger)}:</strong> ${esc(desc)}</li>
              `).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // Renal Dosing - collapsible
  if (drug.renalDosing) {
    html += `
      <div class="drug-collapsible-section" data-section="renal">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('renal')">
          <div class="drug-collapsible-title">
            <span>🫘</span>
            <span>Renal Dosing</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <div class="renal-dosing-grid">
              <div class="renal-dose-item">
                <span class="renal-label">Mild</span>
                <span class="renal-value">${esc(drug.renalDosing.mild)}</span>
              </div>
              <div class="renal-dose-item">
                <span class="renal-label">Moderate</span>
                <span class="renal-value">${esc(drug.renalDosing.moderate)}</span>
              </div>
              <div class="renal-dose-item">
                <span class="renal-label">Severe</span>
                <span class="renal-value">${esc(drug.renalDosing.severe)}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Medical sources footer
  html += `
    <div class="drug-data-sources">
      <div class="drug-data-sources-title">
        <span>📚</span>
        <span>Data Sources</span>
      </div>
      ${medicalData.sources.map(source => `
        <div class="drug-data-source-item">
          <span class="drug-data-source-badge">${esc(source)}</span>
          <span>${source.includes('RxNorm') ? 'NIH/NLM' : source.includes('DailyMed') ? 'FDA Official Labels' : 'FDA Database'}</span>
        </div>
      `).join('')}
      <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px; line-height: 1.4;">
        Information verified from official medical databases and FDA resources.
      </p>
    </div>
  `;

  $('drugInfoBody').innerHTML = html;
}

// Render drug info from medical sources only (when not in local KB)
function renderDrugInfoFromMedicalSources(drugName, medicalData, patient, med) {
  let html = '';

  // Header badge
  html += `
    <div class="drug-instant-badge">
      <span class="instant-icon">🏥</span>
      <span>Verified Medical Sources</span>
      <span class="instant-source">${esc(medicalData.sources.join(' • '))}</span>
    </div>
  `;

  // FDA Black Box Warning (critical - show first, always expanded)
  if (medicalData.combinedData.blackBoxWarning) {
    html += `
      <div class="drug-section-critical">
        <div class="context-alert-header">
          <div class="context-alert-icon">🚨</div>
          <div class="context-alert-title">FDA BLACK BOX WARNING</div>
        </div>
        <div style="padding: 12px; background: var(--bg-elevated); border-radius: 6px; margin-top: 8px;">
          <p style="color: #d32f2f; font-weight: 500; margin: 0; line-height: 1.6;">${esc(medicalData.combinedData.blackBoxWarning.substring(0, 500))}${medicalData.combinedData.blackBoxWarning.length > 500 ? '...' : ''}</p>
        </div>
      </div>
    `;
  }

  // DOSAGE INFORMATION (primary focus - always expanded)
  if (medicalData.combinedData.dosage) {
    html += `
      <div class="drug-section-highlight">
        <div class="drug-section-title"><span>💊</span> DOSAGE & ADMINISTRATION</div>
        <p class="drug-info-text">${esc(medicalData.combinedData.dosage)}</p>
        <div style="margin-top: 12px; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
          <span style="font-size: 16px;">✓</span>
          <span style="font-size: 12px; color: var(--text-muted);">
            Verified source: <strong>${esc(medicalData.combinedData.dosageSource)}</strong>
          </span>
          ${medicalData.combinedData.dosageUrl ? `
            <a href="${esc(medicalData.combinedData.dosageUrl)}" target="_blank" style="margin-left: auto; font-size: 12px; color: var(--primary); text-decoration: none;">View Full Label →</a>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Patient-specific dosing recommendations (always expanded)
  const dosingRecs = DosageCalculator.getPatientSpecificDosing(drugName, patient, medicalData.combinedData.dosage);
  if (dosingRecs.length > 0) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>🎯</span> Patient-Specific Considerations</div>
        <div style="display: grid; gap: 8px;">
          ${dosingRecs.map(rec => `
            <div style="padding: 10px; background: var(--bg-elevated); border-radius: 6px; border-left: 3px solid ${rec.type === 'warning' ? '#ff9800' : '#2196f3'};">
              <div style="font-weight: 500; font-size: 13px; margin-bottom: 4px;">${esc(rec.label)}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${esc(rec.value)}</div>
              ${rec.note ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${esc(rec.note)}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Indications (from DailyMed) - collapsible
  if (medicalData.combinedData.dailymed?.indications) {
    html += `
      <div class="drug-collapsible-section active" data-section="indications">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('indications')">
          <div class="drug-collapsible-title">
            <span>📋</span>
            <span>Indications & Usage</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <p class="drug-info-text">${esc(medicalData.combinedData.dailymed.indications)}</p>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Source: DailyMed (FDA)</p>
          </div>
        </div>
      </div>
    `;
  }

  // Generic/Brand Names (from OpenFDA)
  if (medicalData.combinedData.openfda) {
    const brandName = medicalData.combinedData.openfda.brandName;
    const genericName = medicalData.combinedData.openfda.genericName;

    if (brandName || genericName) {
      html += `
        <div class="drug-section">
          <div class="drug-section-title"><span>🏷️</span> Drug Names</div>
          ${brandName ? `<p class="drug-info-text"><strong>Brand Name:</strong> ${esc(brandName)}</p>` : ''}
          ${genericName ? `<p class="drug-info-text"><strong>Generic Name:</strong> ${esc(genericName)}</p>` : ''}
        </div>
      `;
    }
  }

  // Warnings (from DailyMed) - collapsible
  if (medicalData.combinedData.dailymed?.warnings?.length > 0) {
    html += `
      <div class="drug-collapsible-section" data-section="warnings">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('warnings')">
          <div class="drug-collapsible-title">
            <span>⚠️</span>
            <span>Warnings & Precautions</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            ${medicalData.combinedData.dailymed.warnings.map(w => `
              <p class="drug-info-text" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">${esc(w)}</p>
            `).join('')}
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Source: DailyMed (FDA)</p>
          </div>
        </div>
      </div>
    `;
  }

  // Contraindications (from OpenFDA) - collapsible
  if (medicalData.combinedData.openfda?.contraindications) {
    html += `
      <div class="drug-collapsible-section" data-section="contraindications">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('contraindications')">
          <div class="drug-collapsible-title">
            <span>🚫</span>
            <span>Contraindications</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <p class="drug-info-text">${esc(medicalData.combinedData.openfda.contraindications.substring(0, 600))}</p>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Source: OpenFDA</p>
          </div>
        </div>
      </div>
    `;
  }

  // Adverse Reactions (from OpenFDA) - collapsible
  if (medicalData.combinedData.openfda?.adverseReactions) {
    html += `
      <div class="drug-collapsible-section" data-section="adverse">
        <div class="drug-collapsible-header" onclick="toggleDrugSection('adverse')">
          <div class="drug-collapsible-title">
            <span>⚡</span>
            <span>Adverse Reactions</span>
          </div>
          <div class="drug-collapsible-toggle">▼</div>
        </div>
        <div class="drug-collapsible-content">
          <div class="drug-collapsible-body">
            <p class="drug-info-text">${esc(medicalData.combinedData.openfda.adverseReactions.substring(0, 600))}</p>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Source: OpenFDA</p>
          </div>
        </div>
      </div>
    `;
  }

  // Current medication context (if provided)
  if (med) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>📝</span> Current Order</div>
        <div style="display: grid; gap: 8px;">
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
            <span style="font-weight: 600; color: var(--text);">Dose:</span>
            <span style="color: var(--text-secondary);">${esc(med.dose || 'Not specified')}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
            <span style="font-weight: 600; color: var(--text);">Route:</span>
            <span style="color: var(--text-secondary);">${esc(med.route || 'Not specified')}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
            <span style="font-weight: 600; color: var(--text);">Frequency:</span>
            <span style="color: var(--text-secondary);">${esc(med.frequency || 'Not specified')}</span>
          </div>
          ${med.indication ? `
            <div style="display: flex; justify-content: space-between; padding: 6px 0;">
              <span style="font-weight: 600; color: var(--text);">Indication:</span>
              <span style="color: var(--text-secondary);">${esc(med.indication)}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Medical sources footer
  html += `
    <div class="drug-data-sources">
      <div class="drug-data-sources-title">
        <span>📚</span>
        <span>Data Sources</span>
      </div>
      ${medicalData.sources.map(source => `
        <div class="drug-data-source-item">
          <span class="drug-data-source-badge">${esc(source)}</span>
          <span>${source.includes('RxNorm') ? 'NIH/NLM' : source.includes('DailyMed') ? 'FDA Official Labels' : 'FDA Database'}</span>
        </div>
      `).join('')}
      <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px; line-height: 1.4;">
        All information retrieved from official FDA databases and NIH medical resources.
        <br><strong>Note:</strong> This is for informational purposes. Always consult current clinical guidelines and patient-specific factors.
      </p>
    </div>
  `;

  $('drugInfoBody').innerHTML = html;
}

function renderDrugInfoContent(data, drugName, context) {
  // Extract drugInfo from response - backend returns { success: true, drugInfo: {...} }
  const info = data.drugInfo || data;
  
  const warnings = info.warnings || [];
  const mechanism = info.mechanism || 'Information not available.';
  const drugClass = info.drugClass || '';
  const dosing = info.dosing || '';
  const indications = info.indications || [];
  const sideEffects = info.sideEffects || [];
  const contraindications = info.contraindications || [];
  const monitoring = info.monitoring || [];
  const interactions = info.interactions || [];
  
  let html = '';
  
  // AI Badge
  html += `
    <div class="drug-instant-badge">
      <span class="instant-icon">✨</span>
      <span>AI-Powered Analysis</span>
    </div>
  `;
  
  // Patient-specific warnings
  if (warnings.length > 0 || interactions.length > 0) {
    html += `
      <div class="patient-context-alert">
        <div class="context-alert-header">
          <div class="context-alert-icon">⚠️</div>
          <div class="context-alert-title">Patient-Specific Warnings</div>
        </div>
        <ul class="context-alert-list">
          ${warnings.map(w => `<li><span class="alert-icon">${w.icon || '⚡'}</span>${esc(w.text || w)}</li>`).join('')}
          ${interactions.map(i => `<li><span class="alert-icon">💊</span>Drug interaction: ${esc(i)}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  // Mechanism of Action
  html += `
    <div class="drug-section">
      <div class="drug-section-title"><span>🔬</span> MECHANISM OF ACTION${drugClass ? ` <span style="font-weight:normal;color:var(--text-muted)">• ${esc(drugClass)}</span>` : ''}</div>
      <p class="drug-info-text">${esc(mechanism)}</p>
    </div>
  `;
  
  // Indications
  if (indications.length > 0) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>💊</span> INDICATIONS</div>
        <ul class="drug-info-list">
          ${indications.map(i => `<li>${esc(i)}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  // Dosing
  if (dosing) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>📋</span> DOSING</div>
        <p class="drug-info-text">${esc(dosing)}</p>
      </div>
    `;
  }
  
  // Side Effects
  if (sideEffects.length > 0) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>⚡</span> SIDE EFFECTS</div>
        <ul class="drug-info-list">
          ${sideEffects.map(s => `<li>${esc(s)}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  // Contraindications
  if (contraindications.length > 0) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>🚫</span> CONTRAINDICATIONS</div>
        <ul class="drug-info-list">
          ${contraindications.map(c => `<li>${esc(c)}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  // Monitoring
  if (monitoring.length > 0) {
    html += `
      <div class="drug-section">
        <div class="drug-section-title"><span>📊</span> MONITORING</div>
        <ul class="drug-info-list">
          ${monitoring.map(m => `<li>${esc(m)}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  $('drugInfoBody').innerHTML = html;
}

function renderBasicDrugInfo(drugName, med) {
  $('drugInfoBody').innerHTML = `
    <div class="drug-section">
      <div class="drug-section-title"><span>💊</span> ${esc(drugName)}</div>
      <p class="drug-info-text">
        ${med?.indication ? `<strong>Indication:</strong> ${esc(med.indication)}<br><br>` : ''}
        <strong>Dose:</strong> ${esc(med?.dose || 'Not specified')}<br>
        <strong>Route:</strong> ${esc(med?.route || 'PO')}<br>
        <strong>Frequency:</strong> ${esc(med?.frequency || 'As prescribed')}
      </p>
      <p style="margin-top:16px;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;font-size:0.85rem;color:#fbbf24">
        ⚠️ For detailed AI-powered drug information, ensure your API is configured in Admin Settings.
      </p>
    </div>
    <div class="drug-data-sources">
      <div class="drug-data-sources-title"><span>📚</span> Look Up Information</div>
      <div class="drug-data-source-item">
        <span class="drug-data-source-badge">UpToDate</span>
        <a href="https://www.uptodate.com/contents/search?search=${encodeURIComponent(drugName)}" target="_blank" rel="noopener noreferrer" style="color:var(--primary);text-decoration:none;font-size:0.8rem">Search ${esc(drugName)} →</a>
      </div>
      <div class="drug-data-source-item">
        <span class="drug-data-source-badge">PubMed</span>
        <a href="https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(drugName)}" target="_blank" rel="noopener noreferrer" style="color:var(--primary);text-decoration:none;font-size:0.8rem">Research Articles →</a>
      </div>
      <div class="drug-data-source-item">
        <span class="drug-data-source-badge">DailyMed</span>
        <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(drugName)}" target="_blank" rel="noopener noreferrer" style="color:var(--primary);text-decoration:none;font-size:0.8rem">FDA Label →</a>
      </div>
    </div>
  `;
}

// Toggle collapsible drug information sections
function toggleDrugSection(sectionId) {
  const section = document.querySelector(`.drug-collapsible-section[data-section="${sectionId}"]`);
  if (!section) return;

  // Toggle active class
  section.classList.toggle('active');

  // Optional: Close other sections for accordion behavior (disabled by default)
  // Uncomment below to enable accordion mode (only one section open at a time)
  /*
  const allSections = document.querySelectorAll('.drug-collapsible-section');
  allSections.forEach(s => {
    if (s !== section) {
      s.classList.remove('active');
    }
  });
  */
}

// Add drug from info modal to patient's orders/medications
function addDrugToOrders() {
  const drugName = $('drugInfoTitle')?.textContent;
  if (!drugName || drugName === 'Drug Name') {
    toast('No drug selected', 'warning');
    return;
  }
  
  const p = state.currentPatient;
  if (!p) {
    toast('Select a patient first', 'warning');
    return;
  }
  
  // Close the drug info modal
  closeModal('drugInfoModal');
  
  // Pre-fill the add medication modal with the drug name
  $('medNameNew').value = drugName;
  
  // Open the add medication modal
  openModal('addMedModal');
  
  toast(`Ready to add ${drugName} - fill in dosage details`, 'success');
}

// ═══════════════════════════════════════════════════════════════════
// DYNAMIC DRUG MONOGRAPH - AI-Powered Patient-Specific Analysis
// ═══════════════════════════════════════════════════════════════════

// 1. OPEN FUNCTION - Works with backend API + local KB fallback
window.openDrugLearn = async function(drugName) {
  const p = state.currentPatient;
  if (!p) {
    toast('Select a patient first', 'warning');
    return;
  }

  // OPEN UI (Clean State)
  openModal('modal-drug-monograph');

  // Reset to "Skeleton" view
  $('mono-content').classList.add('hidden');
  $('mono-loading').classList.remove('hidden');
  $('mono-title').innerText = drugName;
  $('mono-badge').className = 'mono-badge hidden';

  // SILENT CALCULATION (The Safety Check)
  const cr = p.currentLabs?.Creatinine || p.currentLabs?.Cr;
  const age = p.age;
  const gender = p.gender;

  let crcl = null;
  let renalStatus = "Normal";

  if (age && cr) {
    crcl = calculateCrClForMonograph(age, gender, cr);
    if (crcl < 30) {
      renalStatus = "Severe Renal Impairment";
    } else if (crcl < 60) {
      renalStatus = "Moderate Renal Impairment";
    }
  }

  // Check local knowledge base first
  const localDrug = DrugKnowledgeBase.getDrug(drugName);
  const patientWarnings = DrugKnowledgeBase.getPatientWarnings(drugName, p);

  // Build patient context
  const context = {
    age: p.age,
    gender: p.gender,
    crcl: crcl,
    renalStatus: renalStatus,
    allergies: p.allergies || 'None',
    currentMeds: (p.medications || []).map(m => m.name)
  };

  // Try cloud API first, fallback to local KB
  try {
    if (state.settings?.apiUrl) {
      const res = await callCloud('getDrugInfo', {
        drugName: drugName,
        patientContext: context
      });

      if (res.success && res.drugInfo) {
        // Transform backend response to our display format
        renderProMonographFromAPI(drugName, res.drugInfo, context, crcl, renalStatus, patientWarnings);
        return;
      }
    }
    
    // Fallback to local knowledge base
    if (localDrug) {
      renderProMonographFromLocal(drugName, localDrug, context, crcl, renalStatus, patientWarnings);
    } else {
      renderProMonographBasic(drugName, context);
    }
    
  } catch (error) {
    console.error('Drug monograph error:', error);
    
    // Fallback to local knowledge base on error
    if (localDrug) {
      renderProMonographFromLocal(drugName, localDrug, context, crcl, renalStatus, patientWarnings);
    } else {
      renderProMonographBasic(drugName, context);
    }
  }
};

// Render from API response (backend returns drugInfo object)
function renderProMonographFromAPI(drugName, drugInfo, context, crcl, renalStatus, warnings) {
  $('mono-loading').classList.add('hidden');
  $('mono-content').classList.remove('hidden');

  // Safety badge based on warnings
  const badge = $('mono-badge');
  badge.classList.remove('hidden', 'safe', 'caution', 'warning');
  badge.style = '';
  
  const hasCritical = warnings.some(w => w.severity === 'critical');
  const hasCaution = warnings.some(w => w.severity === 'high' || w.severity === 'moderate');
  
  if (hasCritical) {
    badge.classList.add('warning');
    badge.innerText = '⛔ REVIEW REQUIRED';
  } else if (hasCaution || renalStatus !== 'Normal') {
    badge.classList.add('caution');
    badge.innerText = '⚠ USE CAUTION';
  } else {
    badge.classList.add('safe');
    badge.innerText = '✓ LIKELY SAFE';
  }

  // Dosing - from API
  let dosingText = drugInfo.dosing?.adult || drugInfo.dosing || 'Refer to prescribing information';
  if (typeof dosingText === 'object') {
    dosingText = Object.entries(dosingText).map(([k, v]) => `${k}: ${v}`).join('\n');
  }
  $('mono-text-dose').innerText = dosingText;

  // Renal alert
  if (crcl && crcl < 60 && drugInfo.dosing?.renal) {
    $('mono-alert-renal').classList.remove('hidden');
    $('mono-text-renal').innerText = drugInfo.dosing.renal;
  } else if (renalStatus !== 'Normal') {
    $('mono-alert-renal').classList.remove('hidden');
    $('mono-text-renal').innerText = `CrCl ~${Math.round(crcl || 0)} mL/min - check prescribing info for renal dosing`;
  } else {
    $('mono-alert-renal').classList.add('hidden');
  }

  // Interactions
  const interactions = drugInfo.interactions || [];
  const interactionsText = interactions.length > 0 
    ? interactions.slice(0, 5).join('\n• ')
    : 'No major interactions listed. Always verify with current medication list.';
  $('mono-text-ix').innerText = interactions.length > 0 ? '• ' + interactionsText : interactionsText;

  // Clinical pearls
  const pearls = drugInfo.clinicalPearls || [];
  const sideEffects = drugInfo.sideEffects?.common || drugInfo.sideEffects || [];
  const allPearls = [...pearls];
  
  if (sideEffects.length > 0) {
    allPearls.push(`Common side effects: ${(Array.isArray(sideEffects) ? sideEffects : [sideEffects]).slice(0, 3).join(', ')}`);
  }
  if (drugInfo.contraindications?.length > 0) {
    allPearls.push(`Contraindicated in: ${drugInfo.contraindications.slice(0, 2).join(', ')}`);
  }
  
  const pearlsHtml = allPearls.length > 0 
    ? allPearls.map(p => `<li>${esc(p)}</li>`).join('')
    : '<li>No specific clinical pearls available</li>';
  $('mono-list-pearls').innerHTML = pearlsHtml;
}

// Render from local DrugKnowledgeBase
function renderProMonographFromLocal(drugName, drug, context, crcl, renalStatus, warnings) {
  $('mono-loading').classList.add('hidden');
  $('mono-content').classList.remove('hidden');

  // Safety badge
  const badge = $('mono-badge');
  badge.classList.remove('hidden', 'safe', 'caution', 'warning');
  badge.style = '';
  
  const hasCritical = warnings.some(w => w.severity === 'critical');
  const hasCaution = warnings.some(w => w.severity === 'high' || w.severity === 'moderate');
  
  if (hasCritical) {
    badge.classList.add('warning');
    badge.innerText = '⛔ REVIEW REQUIRED';
  } else if (hasCaution || renalStatus !== 'Normal') {
    badge.classList.add('caution');
    badge.innerText = '⚠ USE CAUTION';
  } else {
    badge.classList.add('safe');
    badge.innerText = '✓ LIKELY SAFE';
  }

  // Dosing
  let dosingText = drug.commonDoses || 'Refer to prescribing information';
  if (drug.renalDosing && renalStatus !== 'Normal') {
    const adj = renalStatus.includes('Severe') ? drug.renalDosing.severe : drug.renalDosing.moderate;
    if (adj) dosingText += `\n\n⚠️ Renal: ${adj}`;
  }
  $('mono-text-dose').innerText = dosingText;

  // Renal alert
  if (crcl && crcl < 60 && drug.renalDosing) {
    $('mono-alert-renal').classList.remove('hidden');
    const adj = crcl < 30 ? drug.renalDosing.severe : drug.renalDosing.moderate;
    $('mono-text-renal').innerText = adj || `CrCl ${Math.round(crcl)} mL/min - verify dosing`;
  } else {
    $('mono-alert-renal').classList.add('hidden');
  }

  // Interactions
  let interactionsText = 'No major interactions in database.';
  if (drug.interactions && Object.keys(drug.interactions).length > 0) {
    const currentMeds = context.currentMeds.map(m => m.toLowerCase());
    const found = [];
    
    for (const [trigger, desc] of Object.entries(drug.interactions)) {
      if (currentMeds.some(med => med.includes(trigger.toLowerCase()))) {
        found.push(`⚠️ ${trigger}: ${desc}`);
      }
    }
    
    if (found.length > 0) {
      interactionsText = found.join('\n\n');
    } else {
      interactionsText = `No interactions with current meds.\n\nMonitor for: ${Object.keys(drug.interactions).slice(0, 3).join(', ')}`;
    }
  }
  $('mono-text-ix').innerText = interactionsText;

  // Clinical pearls
  const pearls = [];
  if (drug.monitoring?.length > 0) pearls.push(...drug.monitoring.slice(0, 2));
  if (drug.sideEffects?.length > 0) pearls.push(`Side effects: ${drug.sideEffects.slice(0, 3).join(', ')}`);
  if (drug.contraindications?.length > 0) pearls.push(`Avoid in: ${drug.contraindications.slice(0, 2).join(', ')}`);
  if (warnings.length > 0) pearls.push(`⚠️ ${warnings[0].text}`);
  
  const pearlsHtml = pearls.length > 0 
    ? pearls.map(p => `<li>${esc(p)}</li>`).join('')
    : '<li>No specific pearls available</li>';
  $('mono-list-pearls').innerHTML = pearlsHtml;
}

// Basic monograph when no data available
function renderProMonographBasic(drugName, context) {
  $('mono-loading').classList.add('hidden');
  $('mono-content').classList.remove('hidden');

  const badge = $('mono-badge');
  badge.classList.remove('hidden', 'safe', 'caution', 'warning');
  badge.style = '';
  badge.classList.add('caution');
  badge.innerText = 'ℹ️ LIMITED DATA';

  $('mono-text-dose').innerText = 'Dosing information not available in local database.\n\nRefer to prescribing information or clinical resources.';
  
  $('mono-alert-renal').classList.add('hidden');
  
  $('mono-text-ix').innerText = 'Interaction data not available.\n\nPlease verify with pharmacy or drug interaction checker.';
  
  $('mono-list-pearls').innerHTML = `
    <li>Limited information available for ${esc(drugName)}</li>
    <li>Consult UpToDate, Lexicomp, or Micromedex for complete information</li>
    <li>Verify with clinical pharmacist if needed</li>
  `;
}

// 3. HELPER: COCKCROFT-GAULT CALC
function calculateCrClForMonograph(age, gender, cr) {
  if (!age || !cr) return null;
  let creatinine = parseFloat(cr);
  // Convert mmol/L to mg/dL if needed (Standardize)
  if (creatinine > 20) creatinine = creatinine / 88.4;

  let crcl = ((140 - age) * 70) / (72 * creatinine); // Assuming 70kg standard for simplicity or fetch weight
  if (gender === 'F' || gender === 'Female') crcl = crcl * 0.85;

  return Math.round(crcl);
}

// 4. CONFIRM PRESCRIBE FROM MONOGRAPH
window.confirmPrescribeFromMonograph = function() {
  const drugName = $('mono-title')?.innerText;
  closeModal('modal-drug-monograph');
  
  if (drugName && drugName !== 'Loading...') {
    // Pre-fill medication modal
    $('medNameNew').value = drugName;
    openModal('addMedModal');
    toast(`Adding ${drugName} - fill in dosage details`, 'success');
  } else {
    toast('Medication added to orders', 'success');
  }
};

function renderProfileHistory() {
  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];
  
  // Collect ALL data from all notes for unified summary
  const allDiagnoses = [];
  const allMeds = [];
  const allFindings = [];
  
  p.clinicalNotes.forEach(note => {
    if (note.diagnoses) allDiagnoses.push(...note.diagnoses);
    if (note.medsExtracted) allMeds.push(...note.medsExtracted);
    if (note.aiSummary) allFindings.push(note.aiSummary);
    if (note.findings?.summary) allFindings.push(note.findings.summary);
  });
  
  // Remove duplicates
  const uniqueDiagnoses = [...new Set(allDiagnoses)];
  const uniqueMeds = allMeds.filter((m, i, arr) => arr.findIndex(x => x.name === m.name) === i);
  
  let html = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Clinical History</div>
        <button class="btn btn-primary btn-sm" onclick="triggerHistoryUpload()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Upload
        </button>
      </div>
      <div class="section-body">
  `;
  
  // Upload button (professional blue)
  html += `
    <button class="history-upload-btn" onclick="triggerHistoryUpload()" ${state.isAnalyzingHistory ? 'disabled' : ''}>
      ${state.isAnalyzingHistory ? `
        <div class="upload-spinner"></div>
        Analyzing${state.historyUploadQueue > 1 ? ` (${state.historyUploadComplete + 1}/${state.historyUploadQueue})` : ''}...
      ` : `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload Clinical Documents
      `}
    </button>
  `;
  
  if (!p.clinicalNotes.length) {
    html += `
      <div class="history-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" width="48" height="48" style="opacity:0.3;margin-bottom:12px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
        <div>No clinical documents uploaded yet</div>
        <div style="font-size:0.8rem;margin-top:4px">Upload photos of clinical notes, discharge summaries, or EMR screenshots</div>
      </div>
    `;
  } else {
    // ═══════════════════════════════════════════════════════════════════
    // UNIFIED AI SUMMARY - Combines all documents into one view
    // ═══════════════════════════════════════════════════════════════════
    
    // Get summary text and format it
    const summaryText = p.unifiedSummary || allFindings.join(' ') || '';
    const formattedSummary = formatClinicalSummary(summaryText);
    
    html += `
      <div class="unified-summary">
        <div class="unified-summary-header">
          <div class="unified-summary-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            AI Clinical Summary
          </div>
          <div class="unified-summary-meta">${p.clinicalNotes.length} document${p.clinicalNotes.length > 1 ? 's' : ''} analyzed</div>
        </div>
        
        ${summaryText ? `
          <div class="unified-summary-content">${formattedSummary}</div>
        ` : `
          <div class="unified-summary-text" style="color:var(--text-muted);font-style:italic">Summary will be generated from your documents...</div>
        `}
        
        ${uniqueDiagnoses.length ? `
          <div class="unified-section">
            <div class="unified-section-title">📋 Diagnoses</div>
            <div class="unified-section-content">${uniqueDiagnoses.map(d => `<span class="unified-tag diagnosis">${esc(d)}</span>`).join('')}</div>
          </div>
        ` : ''}
        
        ${uniqueMeds.length ? `
          <div class="unified-section">
            <div class="unified-section-title">💊 Medications (${uniqueMeds.length})</div>
            <div class="unified-section-content">${uniqueMeds.slice(0, 8).map(m => `<span class="unified-tag med">${esc(m.name)}${m.dose ? ' ' + m.dose : ''}</span>`).join('')}${uniqueMeds.length > 8 ? `<span class="unified-tag more">+${uniqueMeds.length - 8} more</span>` : ''}</div>
            <button class="btn btn-sm" style="margin-top:10px" onclick="importAllMedsFromHistory()">Import All to Medications</button>
          </div>
        ` : ''}
        
        <button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="regenerateUnifiedSummary()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          Regenerate Summary
        </button>
      </div>
    `;
    
    // ═══════════════════════════════════════════════════════════════════
    // DOCUMENT GALLERY - Show thumbnails of uploaded docs
    // ═══════════════════════════════════════════════════════════════════
    
    html += `
      <div class="documents-gallery">
        <div class="documents-gallery-header">
          <span>Source Documents</span>
          <span style="color:var(--text-muted);font-size:0.75rem">${p.clinicalNotes.length} files</span>
        </div>
        <div class="documents-grid">
    `;
    
    p.clinicalNotes.forEach((note, idx) => {
      const typeIcons = { 
        progress: '📝', consult: '👨‍⚕️', referral: '📤', discharge: '🏥', 
        imaging: '🩻', lab_report: '🔬', radiology: '📷', 
        emr_screenshot: '🖥️', medication_list: '💊', other: '📄' 
      };
      const icon = typeIcons[note.type] || '📄';
      
      html += `
        <div class="document-thumb" onclick="viewNoteImage(${idx})">
          ${note.image ? `<img src="${note.image}" alt="Document ${idx + 1}">` : `<div class="document-thumb-icon">${icon}</div>`}
          <div class="document-thumb-overlay">
            <button class="document-thumb-delete" onclick="event.stopPropagation(); deleteClinicalNote(${idx})" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
          <div class="document-thumb-date">${formatShortDate(note.date)}</div>
        </div>
      `;
    });
    
    html += `</div></div>`;
  }
  
  html += `</div></div>`;
  $('profileHistory').innerHTML = html;
}

// Toggle summary expand/collapse
window.toggleSummary = function(id, btn) {
  const el = document.getElementById(id);
  if (el) {
    el.classList.toggle('expanded');
    btn.textContent = el.classList.contains('expanded') ? 'Show less' : 'Show more';
  }
};

window.addClinicalNote = function() {
  const type = prompt('Note type:\\n• progress\\n• consult\\n• referral\\n• discharge\\n• other') || 'progress';
  const text = prompt('Enter note text:');
  if (!text) return;
  
  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];
  
  p.clinicalNotes.push({
    date: new Date().toISOString(),
    type: type,
    text: text,
    author: state.settings.userName || 'Unknown'
  });
  
  saveCloud();
  renderProfileHistory();
  toast('Note added');
};

window.triggerHistoryUpload = function() {
  if (state.isAnalyzingHistory) return;
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*,.pdf';
  input.multiple = true; // Allow multiple files
  input.onchange = e => handleHistoryUpload(e.target.files);
  input.click();
};

async function handleHistoryUpload(files) {
  if (!files || files.length === 0) return;
  
  const fileArray = Array.from(files);
  state.isAnalyzingHistory = true;
  state.historyUploadQueue = fileArray.length;
  state.historyUploadComplete = 0;
  renderProfileHistory();
  
  // Process each file
  for (const file of fileArray) {
    await processHistoryFile(file);
    state.historyUploadComplete++;
    renderProfileHistory();
  }
  
  state.isAnalyzingHistory = false;
  renderProfileHistory();
  toast(`✅ ${fileArray.length} document(s) processed`);
}

async function processHistoryFile(file) {
  return new Promise((resolve) => {
    const isPDF = file.type === 'application/pdf' || file.name?.toLowerCase().endsWith('.pdf');
    
    if (isPDF) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const base64Data = e.target.result;
          const rawBase64 = base64Data.split(',')[1];
          
          const res = await fetch(state.settings.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ 
              action: 'analyzeDocument', 
              image: rawBase64,
              mediaType: 'application/pdf'
            })
          });
          const data = await res.json();
          
          if (data.success) {
            processDocumentResult(data, base64Data);
          }
          resolve();
        } catch (e) {
          console.error('PDF analysis error:', e);
          resolve();
        }
      };
      reader.readAsDataURL(file);
    } else {
      compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
        try {
          const rawBase64 = imageData.startsWith('data:') ? imageData.split(',')[1] : imageData;
          
          const res = await fetch(state.settings.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ 
              action: 'analyzeDocument', 
              image: rawBase64
            })
          });
          const data = await res.json();
          
          if (data.success) {
            processDocumentResult(data, imageData);
          }
          resolve();
        } catch (e) {
          console.error('Image analysis error:', e);
          resolve();
        }
      });
    }
  });
}

function processDocumentResult(data, fileData) {
  const p = state.currentPatient;
  if (!p.clinicalNotes) p.clinicalNotes = [];
  
  // Build summary from findings
  let summary = data.findings?.summary || '';
  if (data.diagnoses?.length) {
    summary = (summary ? summary + ' | ' : '') + 'Dx: ' + data.diagnoses.join(', ');
  }
  if (data.medications?.length) {
    summary = (summary ? summary + ' | ' : '') + data.medications.length + ' medications found';
  }
  if (data.labValues?.length) {
    summary = (summary ? summary + ' | ' : '') + data.labValues.length + ' lab values';
  }
  
  // Create the note
  const note = {
    date: data.date || new Date().toISOString(),
    type: data.documentType || 'other',
    image: fileData,
    aiSummary: summary || 'Document analyzed',
    author: state.settings.userName || 'Unknown',
    diagnoses: data.diagnoses || [],
    medsExtracted: data.medications || [],
    labValues: data.labValues || [],
    planItems: data.planItems || [],
    vitals: data.vitals || null,
    patientInfo: data.patientInfo || null,
    findings: data.findings || {},
    confidence: data.confidence || 0
  };
  
  p.clinicalNotes.push(note);
  
  // Auto-update patient info if found and patient has none
  if (data.patientInfo?.name && !p.name) {
    p.name = data.patientInfo.name;
  }
  if (data.diagnoses?.length && !p.diagnosis) {
    p.diagnosis = data.diagnoses.join(', ');
  }
  
  saveCloud();
  state.isAnalyzingHistory = false;
  renderProfileHistory();
  
  // Auto-regenerate unified summary if multiple documents
  if (p.clinicalNotes.length > 1) {
    // Delay to let UI update first
    setTimeout(() => regenerateUnifiedSummary(), 500);
  }
  
  // Show what was extracted
  let msg = '✅ Document analyzed';
  if (data.documentType) msg += ` (${data.documentType.replace(/_/g, ' ')})`;
  if (data.medications?.length) msg += ` • ${data.medications.length} meds`;
  if (data.diagnoses?.length) msg += ` • ${data.diagnoses.length} diagnoses`;
  toast(msg);
}

// Import medications from a clinical note
window.importMedsFromNote = function(noteIdx) {
  const p = state.currentPatient;
  const note = p.clinicalNotes?.[noteIdx];
  if (!note?.medsExtracted?.length) {
    toast('No medications to import', true);
    return;
  }
  
  if (!p.medications) p.medications = [];
  
  let imported = 0;
  note.medsExtracted.forEach(med => {
    // Check for duplicates
    const exists = p.medications.some(m => 
      m.name?.toLowerCase() === med.name?.toLowerCase()
    );
    if (!exists && med.name) {
      p.medications.push({
        name: med.name,
        dose: med.dose || '',
        route: med.route || 'PO',
        frequency: med.frequency || 'OD',
        indication: med.notes || '',
        status: med.status || 'active',
        addedDate: new Date().toISOString(),
        source: 'document'
      });
      imported++;
    }
  });
  
  if (imported > 0) {
    saveCloud();
    renderProfileMeds();
    toast(`✅ ${imported} medication(s) imported`);
  } else {
    toast('All medications already exist', true);
  }
};

// Import ALL medications from ALL clinical notes
window.importAllMedsFromHistory = function() {
  const p = state.currentPatient;
  if (!p.clinicalNotes?.length) {
    toast('No documents to import from', true);
    return;
  }
  
  if (!p.medications) p.medications = [];
  
  let imported = 0;
  p.clinicalNotes.forEach(note => {
    if (note.medsExtracted?.length) {
      note.medsExtracted.forEach(med => {
        const exists = p.medications.some(m => 
          m.name?.toLowerCase() === med.name?.toLowerCase()
        );
        if (!exists && med.name) {
          p.medications.push({
            name: med.name,
            dose: med.dose || '',
            route: med.route || 'PO',
            frequency: med.frequency || 'OD',
            indication: med.notes || '',
            status: med.status || 'active',
            addedDate: new Date().toISOString(),
            source: 'document'
          });
          imported++;
        }
      });
    }
  });
  
  if (imported > 0) {
    saveCloud();
    renderProfileMeds();
    toast(`✅ ${imported} medication(s) imported`);
  } else {
    toast('All medications already exist', true);
  }
};

// Format clinical summary - convert markdown-style text to professional HTML
function formatClinicalSummary(text) {
  if (!text) return '';
  
  let html = text;
  
  // Remove emojis
  html = html.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
  
  // Extract sections based on ** headers ** or --- dividers
  const sections = [];
  
  // Check for section headers like **Clinical Summary:** or **CLINICAL PEARLS:**
  const sectionPattern = /\*\*([^*]+):\*\*\s*([\s\S]*?)(?=\*\*[^*]+:\*\*|---|$)/g;
  let match;
  let lastIndex = 0;
  let hasMatches = false;
  
  while ((match = sectionPattern.exec(html)) !== null) {
    hasMatches = true;
    // Add any content before this section as intro
    if (match.index > lastIndex && sections.length === 0) {
      const intro = html.substring(lastIndex, match.index).trim();
      if (intro) sections.push({ title: '', content: intro });
    }
    
    sections.push({
      title: match[1].trim(),
      content: match[2].trim()
    });
    lastIndex = match.index + match[0].length;
  }
  
  // If no sections found, treat entire text as one block
  if (!hasMatches) {
    // Clean up the text
    html = html
      .replace(/\*\*/g, '') // Remove bold markers
      .replace(/---/g, '') // Remove dividers
      .replace(/\n+/g, '<br>') // Convert newlines to breaks
      .trim();
    return `<div class="summary-section-body">${html}</div>`;
  }
  
  // Build HTML for sections
  let outputHtml = '';
  
  sections.forEach(section => {
    if (section.title) {
      // Get appropriate icon
      const titleLower = section.title.toLowerCase();
      let icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>';
      
      if (titleLower.includes('clinical') && titleLower.includes('summary')) {
        icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>';
      } else if (titleLower.includes('pearl') || titleLower.includes('flag') || titleLower.includes('alert')) {
        icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
      } else if (titleLower.includes('disclaimer')) {
        icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>';
      }
      
      outputHtml += `
        <div class="summary-section">
          <div class="summary-section-header">${icon} ${esc(section.title)}</div>
          <div class="summary-section-body">${formatSectionContent(section.content)}</div>
        </div>
      `;
    } else if (section.content) {
      outputHtml += `<div class="summary-section-body">${formatSectionContent(section.content)}</div>`;
    }
  });
  
  return outputHtml;
}

function formatSectionContent(content) {
  if (!content) return '';
  
  // Clean up markdown
  let html = content
    .replace(/\*\*/g, '') // Remove remaining bold markers
    .replace(/---/g, '') // Remove dividers
    .trim();
  
  // Convert list items (- item) to proper list
  if (html.includes(' - ') || html.startsWith('- ')) {
    const items = html.split(/\s*-\s+/).filter(Boolean);
    if (items.length > 1) {
      html = '<ul>' + items.map(item => `<li>${esc(item.trim())}</li>`).join('') + '</ul>';
    } else {
      html = esc(html).replace(/\n/g, '<br>');
    }
  } else {
    html = esc(html).replace(/\n/g, '<br>');
  }
  
  return html;
}

// Regenerate unified summary from all documents
window.regenerateUnifiedSummary = async function() {
  const p = state.currentPatient;
  if (!p.clinicalNotes?.length) {
    toast('No documents to summarize', true);
    return;
  }
  
  // Collect all findings, diagnoses, meds
  const allFindings = [];
  const allDiagnoses = [];
  const allMeds = [];
  
  p.clinicalNotes.forEach(note => {
    if (note.aiSummary) allFindings.push(note.aiSummary);
    if (note.findings?.summary) allFindings.push(note.findings.summary);
    if (note.diagnoses) allDiagnoses.push(...note.diagnoses);
    if (note.medsExtracted) allMeds.push(...note.medsExtracted.map(m => m.name));
  });
  
  const uniqueDx = [...new Set(allDiagnoses)];
  const uniqueMeds = [...new Set(allMeds)];
  
  // Build context for AI - improved prompt for synthesis
  const context = `You are synthesizing clinical information from ${p.clinicalNotes.length} uploaded documents into ONE concise summary.

PATIENT: ${p.name || 'Unknown'}${p.age ? ', ' + p.age + 'yo' : ''}${p.gender ? ' ' + p.gender : ''}

RAW EXTRACTED DATA (may contain duplicates):
${allFindings.join(' | ')}

DIAGNOSES FOUND: ${uniqueDx.join(', ') || 'None specified'}
MEDICATIONS FOUND: ${uniqueMeds.join(', ') || 'None specified'}

INSTRUCTIONS:
- Create ONE unified clinical summary (3-5 sentences max)
- DO NOT repeat the same information multiple times
- Synthesize and deduplicate - if same fact appears multiple times, mention it ONCE
- Focus on: presenting complaint, key history, current status, main diagnoses
- Be concise - this is for quick on-call reference
- Do not list medications (they're shown separately)
- Do not include disclaimers or headers`;
  
  toast('Synthesizing clinical summary...');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'askClinical',
        question: context,
        patientData: `${p.name}, ${p.age || ''} ${p.gender || ''}`
      })
    });
    
    const data = await res.json();
    
    if (data.success && data.answer) {
      p.unifiedSummary = data.answer;
      saveCloud();
      renderProfileHistory();
      toast('✅ Summary synthesized');
    } else {
      toast('Failed to generate summary', true);
    }
  } catch (e) {
    console.error('Summary generation error:', e);
    toast('Error generating summary', true);
  }
};

window.deleteClinicalNote = function(idx) {
  if (!confirm('Delete this note?')) return;
  state.currentPatient.clinicalNotes.splice(idx, 1);
  saveCloud();
  renderProfileHistory();
  toast('Note deleted');
};

window.viewNoteImage = function(idx) {
  const note = state.currentPatient.clinicalNotes[idx];
  if (!note?.image) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'padding:10px;z-index:9999';
  modal.innerHTML = `
    <div class="modal-box" style="max-width:90%;max-height:90vh;padding:0;background:#000">
      <img src="${note.image}" style="max-width:100%;max-height:85vh;object-fit:contain">
      <button onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer">✕ Close</button>
    </div>
  `;
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
};

function renderProfileOverview() {
  const p = state.currentPatient;
  
  // Get plan items
  const planItems = (p.planItems || []).sort((a, b) => {
    // Sort by: incomplete first, then by priority (high > medium > low), then by date
    if (a.completed !== b.completed) return a.completed ? 1 : -1;
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    }
    return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
  });
  
  const completedCount = planItems.filter(i => i.completed).length;
  const pendingCount = planItems.filter(i => !i.completed).length;
  
  // Build plan items HTML
  let planItemsHtml = '';
  if (planItems.length === 0) {
    planItemsHtml = `
      <div class="plan-empty">
        <div class="plan-empty-icon">📋</div>
        <div class="plan-empty-text">No plan items yet</div>
        <button class="btn btn-primary btn-sm" onclick="openAddPlanItem()">+ Add First Item</button>
      </div>
    `;
  } else {
    planItemsHtml = `
      <div class="plan-items">
        ${planItems.slice(0, 5).map((item, idx) => `
          <div class="plan-item ${item.completed ? 'completed' : ''}" data-id="${item.id}">
            <div class="plan-item-check ${item.completed ? 'completed' : ''}" onclick="togglePlanItem('${item.id}')">
              ${item.completed ? '✓' : ''}
            </div>
            <div class="plan-item-content">
              <div class="plan-item-text">${esc(item.text)}</div>
              <div class="plan-item-meta">
                ${item.priority ? `<span class="plan-item-priority ${item.priority}">${item.priority}</span>` : ''}
                ${item.assignee ? `<span>👤 ${esc(item.assignee)}</span>` : ''}
                ${item.dueDate ? `<span>📅 ${item.dueDate}</span>` : ''}
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      ${planItems.length > 5 ? `<div style="text-align:center;padding:8px"><button class="btn btn-ghost btn-sm" onclick="showProfileTab('history')">View all ${planItems.length} items →</button></div>` : ''}
    `;
  }
  
  $('profileOverview').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">📋 Diagnosis</div></div>
      <div class="section-body"><div style="font-size:0.95rem;color:var(--text-secondary)">${esc(p.diagnosis) || 'No diagnosis recorded'}</div></div>
    </div>
    
    <div class="section-card">
      <div class="section-header"><div class="section-title">🩺 Vitals</div><button class="btn btn-secondary btn-xs" onclick="openAddVitals()">Update</button></div>
      <div class="section-body">
        <div class="vitals-grid">
          <div class="vital-card"><div class="vital-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div><div class="vital-value${p.vitals?.hr ? '' : ' empty'}">${p.vitals?.hr || '—'}</div><div class="vital-label">HR</div></div>
          <div class="vital-card"><div class="vital-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div><div class="vital-value${p.vitals?.bp ? '' : ' empty'}">${p.vitals?.bp || '—'}</div><div class="vital-label">BP</div></div>
          <div class="vital-card"><div class="vital-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg></div><div class="vital-value${p.vitals?.temp ? '' : ' empty'}">${p.vitals?.temp || '—'}</div><div class="vital-label">Temp</div></div>
          <div class="vital-card"><div class="vital-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div><div class="vital-value${p.vitals?.rr ? '' : ' empty'}">${p.vitals?.rr || '—'}</div><div class="vital-label">RR</div></div>
          <div class="vital-card"><div class="vital-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.081 20C2.732 14.252 3.73 8.122 6.5 5"/><path d="M17.92 20c3.349-5.748 2.351-11.878-.42-15"/><path d="M12 12a4 4 0 0 0-4 4c0 1.5.5 3.5 4 6 3.5-2.5 4-4.5 4-6a4 4 0 0 0-4-4z"/><path d="M12 8V2"/></svg></div><div class="vital-value${p.vitals?.spo2 ? '' : ' empty'}">${p.vitals?.spo2 || '—'}</div><div class="vital-label">SpO₂</div></div>
        </div>
      </div>
    </div>
    
    <div class="plan-card">
      <div class="plan-header">
        <div class="plan-header-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          Management Plan
        </div>
        <div class="plan-header-actions">
          <button class="plan-btn plan-btn-add" onclick="openAddPlanItem()">+ Add</button>
        </div>
      </div>
      <div class="plan-content">
        ${planItemsHtml}
      </div>
      ${planItems.length > 0 ? `
        <div class="plan-summary">
          <div class="plan-summary-stat">
            <span>${pendingCount}</span> pending
          </div>
          <div class="plan-summary-stat">
            <span>${completedCount}</span> completed
          </div>
        </div>
      ` : ''}
    </div>
    
    <div class="section-card">
      <div class="section-header"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="vertical-align:-3px;margin-right:6px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>History & Examination</div><button class="btn btn-secondary btn-xs" onclick="openEditText('history', 'History')">Edit</button></div>
      <div class="section-body">
        <div style="font-size:0.9rem;color:var(--text-secondary);white-space:pre-wrap;min-height:60px">${esc(p.history) || 'Tap Edit to add...'}</div>
      </div>
    </div>
  `;
}

function renderProfileLabs() {
  const p = state.currentPatient;
  const labData = p.labData || { dates: [], parameters: [] };
  
  // SVG Icons for Labs section
  const labIcons = {
    flask: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><path d="M9 3h6v5l4 9a2 2 0 01-2 3H7a2 2 0 01-2-3l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>',
    trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
    upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
    loader: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24" class="spin"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/></svg>',
    alert: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    brain: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M12 2a4 4 0 014 4c0 1.1-.9 2-2 2h-4c-1.1 0-2-.9-2-2a4 4 0 014-4z"/><path d="M8 8v8a4 4 0 008 0V8"/><path d="M12 8v12"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="14" height="14"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
  };
  
  let html = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">${labIcons.flask} Laboratory Results</div>
        ${labData.parameters?.length ? `<button class="icon-btn btn-delete sm" onclick="clearPatientLabs()" title="Clear Labs">${labIcons.trash}</button>` : ''}
      </div>
      <div class="section-body">
        <div class="lab-upload-area ${state.isAnalyzingLab ? 'analyzing' : ''}" onclick="triggerLabUpload()">
          ${state.isAnalyzingLab ? `
            <div class="lab-upload-icon">${labIcons.loader}</div>
            <div class="lab-upload-content">
              <div class="lab-upload-title">Analyzing...</div>
            </div>
          ` : `
            <div class="lab-upload-icon">${labIcons.upload}</div>
            <div class="lab-upload-content">
              <div class="lab-upload-title">Upload Lab Report</div>
              <div class="lab-upload-subtitle">Photo of lab results, blood gas, chemistry panel...</div>
            </div>
          `}
        </div>
  `;
  
  if (!labData.parameters?.length) {
    html += `<div style="text-align:center;padding:20px;color:var(--text-muted)">No lab results yet</div></div></div>`;
    $('profileLabs').innerHTML = html;
    return;
  }
  
  // Critical Alert
  const criticals = [];
  labData.parameters.forEach(param => {
    const latest = param.values?.[0];
    if (latest?.status === 'critical' || latest?.status === 'high') {
      criticals.push(`<span class="val-item">${esc(param.name)}: ${latest.value} ${param.unit || ''}</span>`);
    }
  });
  
  if (criticals.length) {
    html += `
        <div class="critical-alert">
          <div class="critical-alert-icon">${labIcons.alert}</div>
          <div class="critical-alert-content">
            <div class="critical-alert-title">Abnormal Values Detected</div>
            <div class="critical-alert-values">${criticals.join('')}</div>
          </div>
        </div>
    `;
  }
  
  // AI Interpretation with Feedback
  if (labData.interpretation?.summary) {
    const interp = labData.interpretation;
    const interpTime = interp.timestamp ? new Date(interp.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Recently';
    html += `
        <div class="ai-interpretation">
          <div class="ai-interpretation-header">
            <div class="ai-interpretation-title">${labIcons.brain} AI Interpretation <span class="ai-badge">DECISION SUPPORT</span></div>
            <div style="font-size:0.7rem;color:var(--text-muted)">Generated ${interpTime}</div>
          </div>
          <div class="ai-disclaimer">${labIcons.info} Requires clinical correlation. Verify with local protocols.</div>
          <div class="ai-interpretation-text">${esc(interp.summary)}</div>
          
          ${interp.clinicalCorrelation ? `
          <div class="ai-details">
            <div class="ai-details-title">Clinical Correlation</div>
            <p style="font-size:0.85rem;color:var(--text-secondary);margin:0">${esc(interp.clinicalCorrelation)}</p>
          </div>
          ` : ''}
          
          ${interp.trends?.length ? `
          <div class="ai-details">
            <div class="ai-details-title">📈 Trends</div>
            <ul class="ai-details-list">
              ${interp.trends.map(t => `<li>${esc(t)}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
          
          ${interp.recommendations?.length ? `
          <div class="ai-details">
            <div class="ai-details-title">💡 Recommendations</div>
            <ul class="ai-details-list">
              ${interp.recommendations.map(r => `<li>${esc(r)}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
          
          <div class="feedback-section">
            <div>
              <div class="feedback-label">Was this interpretation helpful?</div>
              <div class="feedback-sent">✓ Feedback recorded</div>
            </div>
            <div class="feedback-buttons">
              <button class="feedback-btn positive" onclick="sendFeedback(1, 'lab')" title="Helpful">👍</button>
              <button class="feedback-btn negative" onclick="sendFeedback(-1, 'lab')" title="Not helpful">👎</button>
            </div>
          </div>
        </div>
    `;
  }
  
  // Lab Values by Category
  const sortedDates = [...(labData.dates || [])].sort((a, b) => new Date(b) - new Date(a));
  const latestDate = sortedDates[0];
  
  if (latestDate) {
    const categories = {};
    labData.parameters.forEach(param => {
      const latestVal = param.values?.find(v => v.date === latestDate);
      if (latestVal) {
        const cat = getLabCategory(param.name);
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ ...param, latestValue: latestVal });
      }
    });
    
    html += `<div style="margin-bottom:8px;font-size:0.75rem;color:var(--text-muted)">📅 Results from ${formatShortDate(latestDate)}</div>`;
    
    const catOrder = ['Renal Function', 'Electrolytes', 'Glucose & Metabolic', 'Liver Function', 'Complete Blood Count', 'Other'];
    catOrder.forEach(cat => {
      if (!categories[cat]?.length) return;
      const catData = CONFIG.LAB_CATEGORIES[cat];
      
      html += `
        <div class="lab-category">
          <div class="lab-category-header">${catData?.icon || '🔬'} ${cat}</div>
          <div class="lab-category-body" style="padding:0;">
      `;
      
      categories[cat].forEach((param, catIdx) => {
        const v = param.latestValue;
        const status = v.status || 'normal';
        const paramIdx = labData.parameters.findIndex(p => p.name === param.name);
        const valueIdx = param.values?.findIndex(val => val.date === latestDate) || 0;

        // PERFORMANCE FIX: Calculate trend once and pass to sparkline (eliminates duplicate calculation)
        const trend = analyzeTrend(param);
        const sparkline = generateSparkline(param, 7, trend);
        
        // Build Delta Badge HTML (professional pill style)
        let badgeHTML = '';
        if (trend && trend.arrow !== '→') {
          // Determine badge class based on clinical context
          let badgeClass = 'delta-neutral';
          if (trend.status === 'worsening') {
            badgeClass = 'delta-bad';
          } else if (trend.status === 'improving') {
            badgeClass = 'delta-good';
          } else if (Math.abs(parseFloat(trend.percentChange)) > 10) {
            badgeClass = trend.arrow === '↗' ? 'delta-bad' : 'delta-good';
          }
          
          badgeHTML = `<span class="delta-badge ${badgeClass}">${trend.arrow} ${trend.diff > 0 ? '+' : ''}${Math.abs(trend.diff).toFixed(1)}</span>`;
        }
        
        // Value class for abnormal highlighting
        const valClass = status === 'high' || status === 'critical' ? 'val-abnormal' : 
                         status === 'low' ? 'val-low' : '';
        
        // Professional Trend Row Layout
        html += `
          <div class="trend-row" onclick="openLabHistory(${paramIdx})" title="Tap to view history">
            <div class="test-meta">
              <span class="test-name">${esc(param.name)}${v.manualOverride ? ' ✏️' : ''}${status !== 'normal' ? ` <span class="lab-value-status ${status}" style="font-size:0.6rem;padding:1px 4px;border-radius:3px;vertical-align:middle;">${status === 'high' ? 'H' : status === 'low' ? 'L' : '!'}</span>` : ''}</span>
              <span class="test-unit">${esc(param.unit || '')}${param.refMin !== undefined && param.refMax !== undefined ? ` (${param.refMin}-${param.refMax})` : ''}</span>
            </div>
            <div class="lab-sparkline">${sparkline}</div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;">
              <span class="current-val ${valClass}">${esc(v.value)}</span>
              ${badgeHTML}
            </div>
          </div>
        `;
      });
      
      html += `</div></div>`;
    });
  }
  
  // Trend Chart
  if (labData.parameters.length > 0) {
    html += `
      <div class="lab-trend-section">
        <div class="lab-trend-header">
          <div class="section-title">📈 Trends</div>
          <select class="lab-trend-select" id="labTrendSelect" onchange="renderLabTrendChart()">
            ${labData.parameters.map((p, i) => `<option value="${i}">${esc(p.name)}</option>`).join('')}
          </select>
        </div>
        <div class="lab-trend-chart"><canvas id="labTrendChart"></canvas></div>
      </div>
    `;
  }
  
  html += '</div></div>';
  $('profileLabs').innerHTML = html;
  
  if (labData.parameters.length > 0) {
    setTimeout(() => renderLabTrendChart(), 100);
  }
}

window.renderLabTrendChart = function() {
  const p = state.currentPatient;
  const labData = p?.labData;
  if (!labData?.parameters?.length) return;
  
  const idx = parseInt($('labTrendSelect')?.value) || 0;
  const param = labData.parameters[idx];
  if (!param?.values?.length) return;
  
  const ctx = $('labTrendChart');
  if (!ctx) return;
  
  if (state.trendChart) state.trendChart.destroy();
  
  const values = [...param.values].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-10);
  const labels = values.map(v => formatShortDate(v.date));
  const data = values.map(v => parseFloat(v.value) || 0);
  const colors = values.map(v => v.status === 'high' || v.status === 'critical' ? '#f43f5e' : v.status === 'low' ? '#3b82f6' : '#10b981');
  
  state.trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: param.name,
        data,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245,158,11,0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: colors,
        pointBorderColor: colors,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', font: { size: 10 } } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
};

window.triggerLabUpload = function() {
  if (state.isAnalyzingLab) return;
  $('labFileInput').click();
};

// ═══════════════════════════════════════════════════════════════════
// ENHANCED LAB EXTRACTION (Kuwait MOH Format Support)
// ═══════════════════════════════════════════════════════════════════

const LAB_EXTRACTION_PROMPT = `You are a medical laboratory report extraction system. Analyze this lab report image with extreme precision.

CRITICAL INSTRUCTIONS:
1. Extract ALL visible lab values, dates, and reference ranges
2. Pay special attention to:
   - Date format: Look for DD/MM/YYYY or MM/DD/YYYY patterns
   - Cumulative/historical data tables showing multiple dates
   - Units (pg/ml, mmol/L, mg/dL, etc.)

3. For each parameter found, extract:
   - Parameter name (standardized)
   - Value (numeric only)
   - Unit
   - Reference range (min-max)
   - Date of test (convert to ISO format YYYY-MM-DD)
   - Status: "critical", "high", "low", or "normal" based on reference ranges

4. IMPORTANT FOR KUWAIT MOH FORMAT:
   - Look for "PATIENT CUMULATIVE REPORT" section with historical values
   - Parse the table showing multiple dates and sample numbers
   - Extract ALL historical values from the cumulative table
   - Handle formats like "16/01/2026 04:32:56" for dates

5. Status determination:
   - "critical": Values marked HH or LL, or far outside range
   - "high": Values marked H or above reference max
   - "low": Values marked L or below reference min
   - "normal": Within range or marked Norm

Return a JSON object with this exact structure:
{
  "confidence": 0.0-1.0,
  "labData": {
    "dates": ["YYYY-MM-DD", ...],
    "parameters": [
      {
        "name": "Parameter Name",
        "unit": "unit string",
        "refMin": number or null,
        "refMax": number or null,
        "values": [
          {
            "date": "YYYY-MM-DD",
            "value": number,
            "status": "critical|high|low|normal"
          }
        ]
      }
    ]
  }
}

RESPOND ONLY WITH VALID JSON. No markdown, no explanation.`;

// ═══════════════════════════════════════════════════════════════════
// MULTI-PAGE LAB ANALYSIS - Master Shifu's Batch Processing Logic
// ═══════════════════════════════════════════════════════════════════
async function handleLabUpload(files) {
  // Guard: Check API URL
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    console.error('API URL not configured:', state.settings.apiUrl);
    toast('API not configured. Go to Admin → Settings', true);
    return;
  }
  
  console.log('🔬 LAB UPLOAD STARTED');
  console.log('📡 Using API:', state.settings.apiUrl);

  // Convert FileList to Array
  const fileArray = Array.isArray(files) ? files : Array.from(files);
  if (fileArray.length === 0) {
    console.log('❌ No files selected');
    return;
  }
  
  console.log('📁 Files to process:', fileArray.length);

  // 1. Visual Feedback - Show multi-page analysis in progress
  state.isAnalyzingLab = true;
  renderProfileLabs();
  showLabLoader();

  // Update loader text for multi-page
  const loaderEl = document.querySelector('.lab-analysis-loader .loader-title');
  if (loaderEl) {
    loaderEl.textContent = fileArray.length > 1
      ? `Scanning ${fileArray.length} Pages...`
      : 'Analyzing Lab Report...';
  }
  const loaderSubtitle = document.querySelector('.lab-analysis-loader .loader-subtitle');
  if (loaderSubtitle && fileArray.length > 1) {
    loaderSubtitle.textContent = 'Stitching reports together';
  }

  // Store images for preview
  state.pendingLabImages = [];
  for (const file of fileArray) {
    state.pendingLabImages.push(URL.createObjectURL(file));
  }
  state.pendingLabImage = state.pendingLabImages[0]; // Keep backward compatibility

  try {
    console.log(`🔬 Starting enhanced lab extraction (${fileArray.length} pages)...`);
    console.log('📡 API:', state.settings.apiUrl);

    // 2. Compress ALL images in parallel (Master Shifu's Promise.all technique)
    console.log('🗜️ Compressing images in parallel...');
    const compressedBatch = await Promise.all(fileArray.map(file => compressForAI(file)));
    console.log('✅ All images compressed');
    
    // VALIDATE: Make sure we have valid image data
    const validImages = compressedBatch.filter(img => img && typeof img === 'string' && img.startsWith('data:'));
    console.log('🖼️ Valid images:', validImages.length, 'of', compressedBatch.length);
    
    if (validImages.length === 0) {
      throw new Error('No valid images after compression');
    }
    
    // Strip data URL prefix for API - Claude expects raw base64 only
    const rawBase64Images = validImages.map(img => {
      if (img.startsWith('data:')) {
        // Extract just the base64 part after the comma
        const base64Part = img.split(',')[1];
        console.log('🔧 Stripped prefix, raw base64 preview:', base64Part.substring(0, 30));
        return base64Part;
      }
      return img;
    });
    
    console.log('🖼️ Total payload size:', Math.round(rawBase64Images.reduce((sum, img) => sum + img.length, 0) / 1024), 'KB');

    // ═══════════════════════════════════════════════════════════════════
    // ADDITIVE AI: Send patient context so AI can "merge" not "overwrite"
    // ═══════════════════════════════════════════════════════════════════
    const p = state.currentPatient;
    let patientContext = "New patient - no prior history.";
    
    if (p) {
      patientContext = JSON.stringify({
        name: p.name || 'Unknown',
        age: p.age,
        gender: p.gender,
        diagnosis: p.diagnosis || 'Not specified',
        currentMeds: (p.medications || []).filter(m => m.status !== 'discontinued').map(m => m.name).slice(0, 10),
        existingLabs: (p.labData?.parameters || []).map(param => ({
          name: param.name,
          latestValue: param.values?.[0]?.value,
          latestDate: param.values?.[0]?.date,
          unit: param.unit
        })).slice(0, 20),
        recentHistory: (p.history || []).slice(0, 5).map(h => h.text)
      });
    }
    
    console.log('🧠 Patient context length:', patientContext.length, 'chars');

    // 3. Send the STACK to the cloud with context
    const requestBody = {
      action: 'analyzeLabsEnhanced',
      images: rawBase64Images,
      extractionPrompt: LAB_EXTRACTION_PROMPT,
      patientContext: patientContext  // Full context for Additive AI
    };

    console.log('📤 Sending request with', rawBase64Images.length, 'images + patient context');
    console.log('📤 Request body size:', JSON.stringify(requestBody).length, 'bytes');

    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(requestBody)
    });

    console.log('📥 Response status:', res.status);

    // Check if response is HTML (Google Apps Script error page)
    const contentType = res.headers.get('content-type') || '';
    console.log('📥 Content-Type:', contentType);

    if (!res.ok) {
      const errorText = await res.text();
      console.error('❌ HTTP Error:', res.status, errorText);
      throw new Error('HTTP ' + res.status + ': ' + errorText.substring(0, 100));
    }

    // Get response as text first
    const responseText = await res.text();
    console.log('📥 Response length:', responseText.length);
    console.log('📥 Response preview:', responseText.substring(0, 300));
    
    // Check if we got HTML instead of JSON (common GAS error)
    if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
      console.error('❌ Received HTML instead of JSON - likely a Google Apps Script error');
      throw new Error('Server returned HTML error page. Check Apps Script deployment.');
    }
    
    // Robust JSON parser for AI responses
    function robustJSONParse(text) {
      // First try direct parse
      try {
        return JSON.parse(text);
      } catch (e) {
        console.log('⚠️ Direct parse failed, attempting fixes...', e.message);
      }
      
      let cleaned = text;
      
      // Step 1: Extract JSON object/array
      const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        cleaned = jsonMatch[0];
      }
      
      // Step 2: Fix common issues
      cleaned = cleaned
        // Remove trailing commas before ] or }
        .replace(/,(\s*[\]}])/g, '$1')
        // Fix missing commas between objects
        .replace(/\}(\s*)\{/g, '},$1{')
        // Fix missing commas between array elements
        .replace(/\](\s*)\[/g, '],$1[')
        // Remove any BOM or zero-width chars
        .replace(/[\uFEFF\u200B-\u200D\u2060]/g, '')
        // Fix unescaped newlines inside strings
        .replace(/:\s*"([^"]*)\n([^"]*)"/g, ':"$1\\n$2"')
        // Remove control characters
        .replace(/[\x00-\x1F\x7F]/g, (match) => {
          if (match === '\n' || match === '\r' || match === '\t') return match;
          return '';
        });
      
      try {
        return JSON.parse(cleaned);
      } catch (e) {
        console.log('⚠️ Standard fixes failed, trying aggressive repair...', e.message);
      }
      
      // Step 3: Aggressive repair - rebuild the JSON structure
      try {
        // Use Function constructor as a lenient JSON parser (handles trailing commas)
        const result = (new Function('return ' + cleaned))();
        if (typeof result === 'object' && result !== null) {
          return result;
        }
      } catch (e) {
        console.log('⚠️ Function eval failed:', e.message);
      }
      
      // Step 4: Try to extract parameters array directly
      console.log('⚠️ Attempting regex extraction...');
      try {
        const paramsMatch = cleaned.match(/"parameters"\s*:\s*\[([\s\S]*?)\](?=\s*[,}]|\s*$)/);
        if (paramsMatch) {
          let paramsStr = '[' + paramsMatch[1] + ']';
          paramsStr = paramsStr
            .replace(/,(\s*[\]}])/g, '$1')
            .replace(/\}(\s*)\{/g, '},$1{');
          
          try {
            const params = JSON.parse(paramsStr);
            if (params.length > 0) {
              console.log('✅ Extracted ' + params.length + ' parameters via regex');
              let dates = [];
              const datesMatch = cleaned.match(/"dates"\s*:\s*\[([\s\S]*?)\]/);
              if (datesMatch) {
                try { dates = JSON.parse('[' + datesMatch[1].replace(/,(\s*\])/g, '$1') + ']'); } catch(e) {}
              }
              return { success: true, labData: { parameters: params, dates: dates }, confidence: 0.6 };
            }
          } catch (e) {
            console.log('⚠️ Parameter parse failed:', e.message);
          }
        }
        
        // Try labData object
        const labDataMatch = cleaned.match(/"labData"\s*:\s*(\{[\s\S]*?"parameters"\s*:\s*\[[\s\S]*?\]\s*\})/);
        if (labDataMatch) {
          const labDataStr = labDataMatch[1].replace(/,(\s*[\]}])/g, '$1');
          const labData = JSON.parse(labDataStr);
          console.log('✅ Extracted labData via regex');
          return { success: true, labData: labData, confidence: 0.7 };
        }
      } catch (e) {
        console.log('⚠️ Regex extraction failed:', e.message);
      }
      
      // Step 5: Extract individual parameter objects
      try {
        const paramObjects = [];
        const paramPattern = /\{\s*"name"\s*:\s*"[^"]+?"[\s\S]*?"values"\s*:\s*\[[\s\S]*?\]\s*\}/g;
        let match;
        while ((match = paramPattern.exec(cleaned)) !== null) {
          try {
            const obj = JSON.parse(match[0].replace(/,(\s*[\]}])/g, '$1'));
            if (obj.name && obj.values) paramObjects.push(obj);
          } catch (e) {}
        }
        if (paramObjects.length > 0) {
          console.log('✅ Recovered ' + paramObjects.length + ' parameters via object extraction');
          return { success: true, labData: { parameters: paramObjects, dates: [] }, confidence: 0.5 };
        }
      } catch (e) {
        console.log('⚠️ Object extraction failed:', e.message);
      }
      
      // Give up
      throw new Error('Could not parse server response');
    }
    
    let data;
    try {
      data = robustJSONParse(responseText);
      console.log('✅ JSON parsed successfully');
    } catch (jsonError) {
      console.error('❌ All JSON parse attempts failed:', jsonError.message);
      console.error('❌ Full response:', responseText);
      
      // Extract any error message we can find
      const errorMatch = responseText.match(/"error"\s*:\s*"([^"]+)"/);
      if (errorMatch) {
        data = { success: false, error: errorMatch[1] };
      } else {
        // Don't throw raw error - handle gracefully
        state.isAnalyzingLab = false;
        hideLabLoader();
        toast('Analysis incomplete - try a clearer image', true);
        renderProfileLabs();
        return;
      }
    }
    console.log('📦 Extraction result:', data);

    state.isAnalyzingLab = false;
    hideLabLoader();

    if (data.error || !data.labData) {
      console.error('❌ Extraction error:', data.error);
      let errorMsg = data.error || 'Extraction failed';
      if (data.debug) {
        const d = data.debug;
        alert('DEBUG INFO:\n\nLength: ' + d.rawResponseLength + '\nFirst { at: ' + d.firstBraceAt + '\nLast } at: ' + d.lastBraceAt + '\n\nExtracted:\n' + d.extractedPreview + '\n\nRaw:\n' + d.rawResponsePreview);
      }
      toast(errorMsg.substring(0, 100), true);
      renderProfileLabs();
      return;
    }

    // 4. Store for preview before confirmation
    state.pendingLabData = data.labData;
    state.labExtractionConfidence = data.confidence || 0.8;
    state.currentInteractionId = data.meta?.interactionId;

    console.log('✅ Multi-page extraction successful!');
    console.log('📊 Parameters found:', data.labData.parameters?.length || 0);
    console.log('📅 Dates found:', data.labData.dates?.length || 0);

    // Show enhanced preview modal with all images
    showLabExtractionPreview(data);

    if (fileArray.length > 1) {
      toast(`✅ ${fileArray.length} pages analyzed and merged`, false);
    }

  } catch (e) {
    console.error('❌ Lab extraction error:', e);
    console.error('❌ Error name:', e.name);
    console.error('❌ Error message:', e.message);
    state.isAnalyzingLab = false;
    hideLabLoader();
    
    // User-friendly error messages - never show raw error
    let userMsg = 'Analysis failed - please try again';
    if (e.message?.includes('network') || e.message?.includes('fetch') || e.message?.includes('Failed to fetch')) {
      userMsg = 'Connection error - check your internet';
    } else if (e.message?.includes('timeout')) {
      userMsg = 'Request timed out - try again';
    }
    
    toast(userMsg, true);
    renderProfileLabs();
  }
}

function showLabExtractionPreview(data) {
  console.log('📊 showLabExtractionPreview called with:', data);
  
  const ld = data.labData || {};
  console.log('📊 labData:', ld);
  console.log('📊 parameters:', ld.parameters);
  
  const confidence = data.confidence || 0.8;
  const confPercent = Math.round(confidence * 100);
  const confClass = confidence >= 0.8 ? 'high' : confidence >= 0.5 ? 'medium' : 'low';
  const confLabel = confidence >= 0.8 ? 'High Confidence' : confidence >= 0.5 ? 'Medium Confidence' : 'Low Confidence';
  
  // Group parameters by status for organized display
  const criticalParams = [];
  const abnormalParams = [];
  const normalParams = [];
  
  // More resilient parameter processing
  const params = ld.parameters || [];
  console.log('📊 Processing', params.length, 'parameters');
  
  params.forEach((param, idx) => {
    console.log(`📊 Param ${idx}:`, param);
    
    // Handle different response formats
    let latestVal = null;
    
    // Format 1: param.values is an array
    if (Array.isArray(param.values) && param.values.length > 0) {
      latestVal = param.values[0];
    }
    // Format 2: param.value is directly on the object
    else if (param.value !== undefined) {
      latestVal = { value: param.value, status: param.status || 'normal', date: param.date };
    }
    // Format 3: Try to find any value-like property
    else if (param.result !== undefined) {
      latestVal = { value: param.result, status: param.status || 'normal' };
    }
    
    if (!latestVal) {
      console.log(`⚠️ Param ${idx} has no extractable value`);
      return;
    }
    
    const status = latestVal.status || param.status || 'normal';
    console.log(`📊 Param ${idx} status:`, status);
    
    // Ensure values array exists for later use
    if (!param.values) {
      param.values = [latestVal];
    }
    
    if (status === 'critical') {
      criticalParams.push({ ...param, latestStatus: status });
    } else if (status === 'high' || status === 'low') {
      abnormalParams.push({ ...param, latestStatus: status });
    } else {
      normalParams.push({ ...param, latestStatus: status });
    }
  });
  
  console.log('📊 Categorized:', { critical: criticalParams.length, abnormal: abnormalParams.length, normal: normalParams.length });
  
  let html = '';
  
  // Image thumbnail section - supports multiple pages
  if (state.pendingLabImages && state.pendingLabImages.length > 0) {
    html += '<div class="preview-images">';
    state.pendingLabImages.forEach((imgUrl, idx) => {
      html += `
        <div class="preview-thumb-wrapper">
          <img src="${imgUrl}" class="preview-thumb" alt="Lab Image ${idx + 1}">
          <div class="preview-thumb-badge">${idx + 1}</div>
        </div>
      `;
    });
    html += '</div>';
  } else if (state.pendingLabImage) {
    // Fallback for single image (backward compatibility)
    html += `
      <div class="preview-images">
        <div class="preview-thumb-wrapper">
          <img src="${state.pendingLabImage}" class="preview-thumb" alt="Lab Image">
          <div class="preview-thumb-badge">1</div>
        </div>
      </div>
    `;
  }
  
  // Confidence section
  html += `
    <div class="preview-confidence">
      <div class="confidence-header">
        <span class="confidence-title">Extraction Confidence</span>
        <span class="confidence-badge ${confClass}">${confLabel}</span>
      </div>
      <div class="confidence-bar-lg">
        <div class="fill ${confClass}" style="width:${confPercent}%"></div>
      </div>
      ${confidence < 0.7 ? `
        <div class="confidence-warning">
          ⚠️ Low confidence extraction - please verify values carefully before saving
        </div>
      ` : ''}
    </div>
  `;
  
  // Extracted values section
  html += '<div class="preview-values">';
  
  // Check if we have any parameters
  const totalParams = criticalParams.length + abnormalParams.length + normalParams.length;
  
  if (totalParams === 0) {
    html += `
      <div class="preview-empty">
        <div class="preview-empty-icon">🔬</div>
        <div class="preview-empty-text">No lab values could be extracted from this image.<br>Try uploading a clearer image.</div>
      </div>
    `;
  } else {
    // Critical Values Section
    if (criticalParams.length > 0) {
      html += buildLabPreviewSection('Critical Values', 'critical', '🚨', criticalParams);
    }
    
    // Abnormal Values Section  
    if (abnormalParams.length > 0) {
      html += buildLabPreviewSection('Abnormal Values', 'abnormal', '⚠️', abnormalParams);
    }
    
    // Normal Values Section
    if (normalParams.length > 0) {
      html += buildLabPreviewSection('Normal Values', 'normal', '✓', normalParams);
    }
  }
  
  html += '</div>';
  
  // Interpretation Section
  if (ld.interpretation?.summary || ld.interpretation?.criticalFindings?.length) {
    html += `
      <div class="preview-interpretation">
        <div class="interpretation-header">
          <span>🤖</span> AI Clinical Interpretation
        </div>
        ${ld.interpretation.summary ? `<div class="interpretation-text">${esc(ld.interpretation.summary)}</div>` : ''}
        ${ld.interpretation.criticalFindings?.length ? `
          <div class="interpretation-findings">
            ${ld.interpretation.criticalFindings.map(f => `
              <div class="interpretation-finding">${esc(f)}</div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
  }
  
  $('labPreviewBody').innerHTML = html;
  openModal('labPreviewModal');
}

// Helper function to build preview sections
function buildLabPreviewSection(title, type, icon, params) {
  let html = `
    <div class="preview-section">
      <div class="preview-section-header">
        <div class="preview-section-icon ${type}">${icon}</div>
        <span class="preview-section-title">${title}</span>
        <span class="preview-section-count">${params.length} value${params.length !== 1 ? 's' : ''}</span>
      </div>
  `;
  
  params.forEach(param => {
    const latestVal = param.values?.[0];
    if (!latestVal) return;
    
    const status = latestVal.status || 'normal';
    const historyCount = (param.values?.length || 1) - 1;
    
    // Calculate trend if we have history
    let trendHtml = '';
    if (param.values?.length >= 2) {
      const current = parseFloat(latestVal.value);
      const previous = parseFloat(param.values[1].value);
      if (!isNaN(current) && !isNaN(previous)) {
        const diff = current - previous;
        const pctChange = Math.abs((diff / previous) * 100).toFixed(0);
        if (diff > 0) {
          trendHtml = `<span class="trend-indicator up">↑${pctChange}%</span>`;
        } else if (diff < 0) {
          trendHtml = `<span class="trend-indicator down">↓${pctChange}%</span>`;
        } else {
          trendHtml = `<span class="trend-indicator stable">→</span>`;
        }
      }
    }
    
    // Build reference range text
    let refText = '';
    if (param.refMin !== undefined && param.refMax !== undefined && param.refMin !== null && param.refMax !== null) {
      refText = `Ref: ${param.refMin} - ${param.refMax}`;
    } else if (param.refDescription) {
      refText = `Ref: ${param.refDescription}`;
    }
    
    html += `
      <div class="preview-lab-card ${status}">
        <div class="preview-lab-info">
          <div class="preview-lab-name">
            ${esc(param.name)}
            ${param.abbrev ? `<span class="abbrev">(${esc(param.abbrev)})</span>` : ''}
          </div>
          ${refText ? `<div class="preview-lab-ref">${esc(refText)}</div>` : ''}
        </div>
        <div class="preview-lab-value">
          <div class="preview-lab-number ${status}">
            ${latestVal.value}${trendHtml}
          </div>
          ${param.unit ? `<div class="preview-lab-unit">${esc(param.unit)}</div>` : ''}
          ${historyCount > 0 ? `<div class="preview-lab-history">+${historyCount} historical</div>` : ''}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

window.confirmLabExtraction = async function() {
  if (!state.pendingLabData || !state.currentPatient) return;

  const p = state.currentPatient;
  const ld = state.pendingLabData;

  // Merge dates
  (ld.dates || []).forEach(d => {
    if (!p.labData.dates.includes(d)) p.labData.dates.push(d);
  });
  p.labData.dates.sort((a, b) => new Date(b) - new Date(a));

  // OPTIMIZED: Build hash map for faster lookups - O(n) instead of O(n²)
  const paramMap = new Map();
  p.labData.parameters.forEach(param => {
    const key = param.name.toLowerCase();
    paramMap.set(key, param);
    if (param.abbrev) {
      paramMap.set(param.abbrev.toLowerCase(), param);
    }
  });

  // Merge parameters intelligently with hash map
  (ld.parameters || []).forEach(newParam => {
    const nameKey = newParam.name.toLowerCase();
    const abbrevKey = newParam.abbrev?.toLowerCase();
    let existing = paramMap.get(nameKey) || (abbrevKey ? paramMap.get(abbrevKey) : null);

    if (existing) {
      // Build value map for faster lookups - O(n) instead of O(n*m)
      const valueMap = new Map(existing.values.map(v => [v.date, v]));

      // Merge values into existing parameter
      (newParam.values || []).forEach(nv => {
        const ev = valueMap.get(nv.date);
        if (ev) {
          ev.value = nv.value;
          ev.status = nv.status;
        } else {
          existing.values.push(nv);
        }
      });
      // Sort values by date descending
      existing.values.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Update metadata
      if (newParam.refMin !== undefined) existing.refMin = newParam.refMin;
      if (newParam.refMax !== undefined) existing.refMax = newParam.refMax;
      if (newParam.unit) existing.unit = newParam.unit;
      if (newParam.refDescription) existing.refDescription = newParam.refDescription;
    } else {
      // Add as new parameter
      if (newParam.values) {
        newParam.values.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      p.labData.parameters.push(newParam);
    }
  });

  // Update interpretation
  if (ld.interpretation) p.labData.interpretation = ld.interpretation;

  // PERFORMANCE FIX: Non-blocking sync - update UI immediately, sync in background
  forceSync().catch(err => console.error('Background sync failed:', err));

  // Clear caches to force recalculation with new data
  if (window._trendCache) window._trendCache.clear();
  if (window._labCategoryCache) window._labCategoryCache.clear();

  renderProfileLabs();
  closeModal('labPreviewModal');
  toast('Lab results saved!');

  // Clear pending data
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
};

window.resetLabExtraction = function() {
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
  state.isAnalyzingLab = false;
  if (state.pendingLabImage) {
    URL.revokeObjectURL(state.pendingLabImage);
    state.pendingLabImage = null;
  }
  renderProfileLabs();
};

// ═══════════════════════════════════════════════════════════════════════════
// LAB ANALYSIS LOADING ANIMATION FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════

function showLabLoader() {
  const loader = $('labAnalysisLoader');
  if (!loader) return;
  
  // Reset all steps
  ['step1', 'step2', 'step3', 'step4'].forEach(id => {
    const step = $(id);
    if (step) {
      step.classList.remove('active', 'complete');
      step.querySelector('.step-icon').textContent = id.replace('step', '');
    }
  });
  
  loader.classList.add('active');
  
  // Animate steps progressively
  setTimeout(() => setLoaderStep(1), 100);
  setTimeout(() => setLoaderStep(2), 1500);
  setTimeout(() => setLoaderStep(3), 3000);
  setTimeout(() => setLoaderStep(4), 4500);
}

function setLoaderStep(stepNum) {
  // Complete previous steps
  for (let i = 1; i < stepNum; i++) {
    const prev = $('step' + i);
    if (prev) {
      prev.classList.remove('active');
      prev.classList.add('complete');
      prev.querySelector('.step-icon').textContent = '✓';
    }
  }
  
  // Activate current step
  const current = $('step' + stepNum);
  if (current) {
    current.classList.add('active');
  }
}

function hideLabLoader() {
  const loader = $('labAnalysisLoader');
  if (loader) {
    // Complete all steps first
    ['step1', 'step2', 'step3', 'step4'].forEach(id => {
      const step = $(id);
      if (step) {
        step.classList.remove('active');
        step.classList.add('complete');
        step.querySelector('.step-icon').textContent = '✓';
      }
    });
    
    // Small delay then hide
    setTimeout(() => {
      loader.classList.remove('active');
    }, 500);
  }
}

function renderProfileImaging() {
  const p = state.currentPatient;
  const imaging = p.imaging || [];
  
  $('profileImaging').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">📷 Imaging & Studies</div></div>
      <div class="section-body">
        <div class="lab-upload-area ${state.isAnalyzingImaging ? 'analyzing' : ''}" onclick="triggerImagingUpload()">
          ${state.isAnalyzingImaging ? `
            <div class="lab-upload-icon">⏳</div>
            <div class="lab-upload-content">
              <div class="lab-upload-title">Analyzing...</div>
            </div>
          ` : `
            <div class="lab-upload-icon">🩻</div>
            <div class="lab-upload-content">
              <div class="lab-upload-title">Upload Study</div>
              <div class="lab-upload-subtitle">Echo, ECG, X-Ray, CT/MRI reports</div>
            </div>
          `}
        </div>
        
        ${imaging.length ? imaging.slice().reverse().map((img, idx) => `
          <div class="imaging-card">
            <div class="imaging-card-header">
              <div class="imaging-type">
                ${img.type === 'ecg' ? '📈' : img.type === 'echo' ? '💓' : img.type === 'xray' ? '🩻' : '🧠'}
                ${(img.type || 'Study').toUpperCase()}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span class="imaging-date">${formatDateTime(img.date)}</span>
                <button class="btn btn-ghost btn-xs" onclick="deleteImaging(${imaging.length - 1 - idx})">🗑️</button>
              </div>
            </div>
            <div class="imaging-summary">${esc(img.summary) || 'No findings recorded'}</div>
          </div>
        `).join('') : '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:0.85rem">No imaging studies</div>'}
      </div>
    </div>
  `;
}

window.triggerImagingUpload = function() {
  if (state.isAnalyzingImaging) return;
  $('imagingFileInput').click();
};

async function handleImagingUpload(file) {
  state.isAnalyzingImaging = true;
  renderProfileImaging();
  
  const type = prompt('Enter study type:\n• echo\n• ecg\n• xray\n• ct') || 'xray';
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'interpret', documentType: type, image: imageData })
      });
      const data = await res.json();
      
      state.isAnalyzingImaging = false;
      
      const p = state.currentPatient;
      if (!p.imaging) p.imaging = [];
      
      p.imaging.push({
        date: new Date().toISOString(),
        type: type,
        summary: data.interpretation?.summary || data.interpretation?.impression || data.interpretation?.conclusion || 'Analysis complete'
      });
      
      saveCloud();
      renderProfileImaging();
      toast('Imaging added!');
    } catch (e) {
      state.isAnalyzingImaging = false;
      toast('Analysis failed', true);
      renderProfileImaging();
    }
  });
}

window.deleteImaging = function(idx) {
  if (!confirm('Delete this imaging study?')) return;
  state.currentPatient.imaging.splice(idx, 1);
  saveCloud();
  renderProfileImaging();
  toast('Imaging deleted');
};

window.clearPatientLabs = function() {
  if (!confirm('Delete all lab results for this patient?')) return;
  state.currentPatient.labData = { dates: [], parameters: [] };
  saveCloud();
  renderProfileLabs();
  toast('Lab data cleared');
};

function renderProfileFluids() {
  const p = state.currentPatient;
  const fluids = p.fluids || [];
  const totalIntake = fluids.reduce((s, f) => s + (f.intake || 0), 0);
  const totalOutput = fluids.reduce((s, f) => s + (f.output || 0), 0);
  const balance = totalIntake - totalOutput;
  
  $('profileFluids').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">💧 Fluid Balance</div><button class="btn btn-primary btn-xs" onclick="openAddFluid()">+ Add</button></div>
      <div class="section-body">
        <div class="fluid-summary">
          <div class="fluid-stat"><div class="fluid-stat-value intake">${totalIntake}</div><div class="fluid-stat-label">Intake (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value output">${totalOutput}</div><div class="fluid-stat-label">Output (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value balance" style="color:${balance >= 0 ? 'var(--emerald)' : 'var(--rose)'}">${balance >= 0 ? '+' : ''}${balance}</div><div class="fluid-stat-label">Balance</div></div>
        </div>
        ${fluids.length ? `<div class="fluid-chart-container"><canvas id="fluidChart"></canvas></div>` : ''}
      </div>
    </div>
  `;
  
  if (fluids.length) setTimeout(() => renderFluidChart(fluids), 100);
}

function renderFluidChart(fluids) {
  const ctx = $('fluidChart');
  if (!ctx) return;
  if (state.fluidChart) state.fluidChart.destroy();
  
  state.fluidChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fluids.map(f => formatDateTime(f.date).split(',')[0]),
      datasets: [
        { label: 'Intake', data: fluids.map(f => f.intake || 0), backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 6 },
        { label: 'Output', data: fluids.map(f => f.output || 0), backgroundColor: 'rgba(249,115,22,0.7)', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#9ca3af' } } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
}

function renderProfilePlans() {
  const p = state.currentPatient;
  if (!p.plans) p.plans = [];
  if (!p.tasks) p.tasks = [];
  
  // Convert old plans to tasks if needed
  if (p.plans.length > 0 && p.tasks.length === 0) {
    p.plans.forEach(plan => {
      const lines = plan.content.split('\n').filter(l => l.trim());
      lines.forEach(line => {
        p.tasks.push({
          id: Date.now() + Math.random(),
          text: line.replace(/^[-•*]\s*/, ''),
          completed: false,
          priority: 'medium',
          category: 'general',
          createdAt: plan.date,
          createdBy: state.currentUser || 'Unknown'
        });
      });
    });
  }
  
  const tasks = p.tasks || [];
  const pendingTasks = tasks.filter(t => !t.completed);
  const completedTasks = tasks.filter(t => t.completed);
  const completionRate = tasks.length > 0 ? Math.round((completedTasks.length / tasks.length) * 100) : 0;
  const urgentCount = tasks.filter(t => t.priority === 'high' && !t.completed).length;
  
  // Check if all tasks just got completed
  if (tasks.length > 0 && pendingTasks.length === 0 && !p._celebrationShown) {
    p._celebrationShown = true;
    setTimeout(() => showPlanCompletionCelebration(p), 500);
  } else if (pendingTasks.length > 0) {
    p._celebrationShown = false;
  }
  
  // Get AI suggestions based on patient context
  const suggestions = ClinicalPlanAI.getSuggestions(p);
  
  $('profilePlans').innerHTML = `
    <div class="section-card plan-section-card">
      <div class="section-header plan-section-header">
        <div class="section-title">📋 Clinical Plan</div>
        <button class="btn btn-primary btn-xs" id="addTaskBtn">+ Add Task</button>
      </div>
      
      <!-- Progress Stats -->
      <div class="plan-stats-grid">
        <div class="plan-stat-box">
          <div class="plan-stat-ring">
            <svg viewBox="0 0 36 36">
              <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <path class="ring-fill" stroke-dasharray="${completionRate}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
            </svg>
            <span class="ring-text">${completionRate}%</span>
          </div>
        </div>
        <div class="plan-stat-box">
          <span class="plan-stat-num amber">${pendingTasks.length}</span>
          <span class="plan-stat-lbl">Pending</span>
        </div>
        <div class="plan-stat-box">
          <span class="plan-stat-num green">${completedTasks.length}</span>
          <span class="plan-stat-lbl">Done</span>
        </div>
        <div class="plan-stat-box ${urgentCount > 0 ? 'urgent-box' : ''}">
          <span class="plan-stat-num red">${urgentCount}</span>
          <span class="plan-stat-lbl">Urgent</span>
        </div>
      </div>
      
      <!-- Notifications -->
      <div class="plan-notify-bar">
        <span class="notify-label">🔔 Reminders</span>
        <label class="toggle-switch">
          <input type="checkbox" id="planNotifyToggle" ${p.notificationsEnabled ? 'checked' : ''}>
          <span class="toggle-track"></span>
        </label>
      </div>
      
      <!-- AI Suggestions -->
      ${suggestions.length > 0 ? `
        <div class="plan-ai-box">
          <div class="plan-ai-header">
            <span class="ai-badge">🧠 AI Suggestions</span>
          </div>
          <div class="plan-ai-list">
            ${suggestions.slice(0, 4).map((s, idx) => `
              <div class="plan-ai-item" data-suggestion-idx="${idx}">
                <span class="ai-item-icon">${s.icon}</span>
                <span class="ai-item-text">${esc(s.text)}</span>
                <span class="ai-item-add">+</span>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <!-- Task List -->
      <div class="plan-tasks-list">
        ${pendingTasks.length > 0 ? `
          <div class="tasks-group-header">
            <span>⏳ Pending</span>
            <span class="tasks-count">${pendingTasks.length}</span>
          </div>
          ${pendingTasks.sort((a, b) => {
            const order = { high: 0, medium: 1, low: 2 };
            return order[a.priority] - order[b.priority];
          }).map(task => `
            <div class="plan-task-item" data-task-id="${task.id}" data-priority="${task.priority}">
              <div class="task-check-box ${task.completed ? 'done' : ''}" data-action="toggle"></div>
              <div class="task-info">
                <div class="task-text">${esc(task.text)}</div>
                <div class="task-meta">
                  <span class="task-cat">${getCategoryIcon(task.category)} ${task.category || 'general'}</span>
                  <span class="task-pri ${task.priority}">${getPriorityDot(task.priority)}</span>
                </div>
              </div>
              <div class="task-btns">
                <button class="task-btn" data-action="edit">✏️</button>
                <button class="task-btn del" data-action="delete">🗑️</button>
              </div>
            </div>
          `).join('')}
        ` : `
          <div class="plan-empty">
            <div class="empty-icon">✅</div>
            <div class="empty-text">No pending tasks</div>
          </div>
        `}
        
        ${completedTasks.length > 0 ? `
          <div class="tasks-group-header completed-header" id="completedHeader">
            <span>✓ Completed</span>
            <span class="tasks-count done">${completedTasks.length}</span>
            <span class="expand-arrow">▼</span>
          </div>
          <div class="completed-tasks-list" id="completedTasksList" style="display:none">
            ${completedTasks.map(task => `
              <div class="plan-task-item completed" data-task-id="${task.id}">
                <div class="task-check-box done" data-action="toggle">✓</div>
                <div class="task-info">
                  <div class="task-text">${esc(task.text)}</div>
                </div>
                <div class="task-btns">
                  <button class="task-btn del" data-action="delete">🗑️</button>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Store suggestions for click handlers
  state._planSuggestions = suggestions;
  
  // Attach event handlers (mobile-friendly approach)
  initPlanEventHandlers();
  
  // Check notifications
  checkPendingTaskNotifications(p);
}

function getCategoryIcon(cat) {
  const icons = { labs: '🔬', imaging: '📷', medication: '💊', consult: '👨‍⚕️', procedure: '🏥', discharge: '🏠', monitoring: '📊', general: '📝' };
  return icons[cat] || '📝';
}

function getPriorityDot(pri) {
  const dots = { high: '🔴 High', medium: '🟡 Med', low: '🟢 Low' };
  return dots[pri] || '🟡 Med';
}

function initPlanEventHandlers() {
  // Add Task button
  const addBtn = document.getElementById('addTaskBtn');
  if (addBtn) {
    addBtn.onclick = function() { openTaskModal(); };
  }
  
  // Notification toggle
  const notifyToggle = document.getElementById('planNotifyToggle');
  if (notifyToggle) {
    notifyToggle.onchange = function() { togglePlanNotifications(this.checked); };
  }
  
  // Completed section toggle
  const completedHeader = document.getElementById('completedHeader');
  if (completedHeader) {
    completedHeader.setAttribute('role', 'button');
    completedHeader.setAttribute('aria-expanded', 'false');
    completedHeader.setAttribute('aria-controls', 'completedTasksList');
    completedHeader.onclick = function() {
      const list = document.getElementById('completedTasksList');
      const arrow = this.querySelector('.expand-arrow');
      const isExpanded = list.style.display !== 'none';
      if (isExpanded) {
        list.style.display = 'none';
        arrow.textContent = '▼';
        this.setAttribute('aria-expanded', 'false');
      } else {
        list.style.display = 'block';
        arrow.textContent = '▲';
        this.setAttribute('aria-expanded', 'true');
      }
    };
  }
  
  // AI Suggestion items
  document.querySelectorAll('.plan-ai-item').forEach(item => {
    item.onclick = function() {
      const idx = parseInt(this.dataset.suggestionIdx);
      const s = state._planSuggestions?.[idx];
      if (s) addSuggestedTask(s.text, s.priority, s.category);
    };
  });
  
  // Task items - use event delegation on parent
  document.querySelectorAll('.plan-task-item').forEach(item => {
    const taskId = item.dataset.taskId;
    
    // Checkbox
    const checkbox = item.querySelector('[data-action="toggle"]');
    if (checkbox) {
      checkbox.onclick = function(e) {
        e.stopPropagation();
        toggleTaskComplete(taskId);
      };
    }
    
    // Edit button
    const editBtn = item.querySelector('[data-action="edit"]');
    if (editBtn) {
      editBtn.onclick = function(e) {
        e.stopPropagation();
        editTask(taskId);
      };
    }
    
    // Delete button
    const deleteBtn = item.querySelector('[data-action="delete"]');
    if (deleteBtn) {
      deleteBtn.onclick = function(e) {
        e.stopPropagation();
        deleteTask(taskId);
      };
    }
  });
}

// Render individual task item
function renderTaskItem(task, isCompleted) {
  const priorityColors = {
    high: { bg: 'rgba(239,68,68,0.1)', border: 'rgba(239,68,68,0.3)', text: '#f87171', icon: '🔴' },
    medium: { bg: 'rgba(251,191,36,0.1)', border: 'rgba(251,191,36,0.3)', text: '#fbbf24', icon: '🟡' },
    low: { bg: 'rgba(52,211,153,0.1)', border: 'rgba(52,211,153,0.3)', text: '#34d399', icon: '🟢' }
  };
  const priority = priorityColors[task.priority] || priorityColors.medium;
  
  const categoryIcons = {
    labs: '🔬', imaging: '📷', medication: '💊', consult: '👨‍⚕️', 
    procedure: '🏥', discharge: '🏠', monitoring: '📊', general: '📝'
  };
  const catIcon = categoryIcons[task.category] || '📝';
  
  return `
    <div class="task-item ${isCompleted ? 'completed' : ''} priority-${task.priority}" data-task-id="${task.id}">
      <button class="task-checkbox ${isCompleted ? 'checked' : ''}" 
              onclick="toggleTaskComplete('${task.id}')">
        ${isCompleted ? '✓' : ''}
      </button>
      <div class="task-content">
        <div class="task-text">${esc(task.text)}</div>
        <div class="task-meta">
          <span class="task-category">${catIcon} ${task.category || 'General'}</span>
          <span class="task-priority" style="color:${priority.text}">${priority.icon} ${task.priority}</span>
          ${task.dueDate ? `<span class="task-due">📅 ${formatDate(task.dueDate)}</span>` : ''}
        </div>
      </div>
      <div class="task-actions">
        ${!isCompleted ? `
          <button class="task-action-btn edit" onclick="editTask('${task.id}')" title="Edit">✏️</button>
        ` : ''}
        <button class="task-action-btn delete" onclick="deleteTask('${task.id}')" title="Delete">🗑️</button>
      </div>
    </div>
  `;
}

// Clinical Plan AI Suggestions
const ClinicalPlanAI = {
  getSuggestions: function(patient) {
    const suggestions = [];
    const diagnosis = (patient.diagnosis || '').toLowerCase();
    const existingTasks = (patient.tasks || []).map(t => t.text.toLowerCase());
    const meds = (patient.medications || []).map(m => m.name?.toLowerCase());
    const labs = patient.labData?.parameters || [];
    
    // Diagnosis-based suggestions
    const diagnosisSuggestions = {
      'diabetes': [
        { text: 'Check HbA1c if not done in 3 months', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Review blood glucose log', priority: 'medium', category: 'monitoring', icon: '📊' },
        { text: 'Diabetic foot examination', priority: 'medium', category: 'procedure', icon: '🦶' },
        { text: 'Ophthalmology referral for retinopathy screening', priority: 'low', category: 'consult', icon: '👁️' }
      ],
      'hypertension': [
        { text: 'Ensure BP monitoring TDS', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Check renal function panel', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Review antihypertensive compliance', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'pneumonia': [
        { text: 'Repeat CXR in 48-72h if no improvement', priority: 'medium', category: 'imaging', icon: '📷' },
        { text: 'Check inflammatory markers (CRP, WBC)', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Assess oxygen requirements', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Review antibiotic de-escalation at 48h', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'heart failure': [
        { text: 'Daily weight monitoring', priority: 'high', category: 'monitoring', icon: '⚖️' },
        { text: 'Strict fluid restriction (1.5L/day)', priority: 'high', category: 'general', icon: '💧' },
        { text: 'Check BNP/NT-proBNP trend', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Optimize diuretic dosing', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Echocardiogram if not recent', priority: 'medium', category: 'imaging', icon: '📷' }
      ],
      'acs': [
        { text: 'Serial troponins q6h x3', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Continuous cardiac monitoring', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Cardiology consult', priority: 'high', category: 'consult', icon: '👨‍⚕️' },
        { text: 'Ensure DAPT initiated', priority: 'high', category: 'medication', icon: '💊' }
      ],
      'mi': [
        { text: 'Serial troponins q6h x3', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Cardiology consult for cath consideration', priority: 'high', category: 'consult', icon: '👨‍⚕️' }
      ],
      'sepsis': [
        { text: 'Repeat lactate in 2-4h', priority: 'high', category: 'labs', icon: '🔬' },
        { text: 'Ensure blood cultures before antibiotics', priority: 'high', category: 'labs', icon: '🧫' },
        { text: 'Fluid resuscitation 30mL/kg', priority: 'high', category: 'general', icon: '💧' },
        { text: 'Reassess antibiotic coverage at 48h', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'ckd': [
        { text: 'Avoid nephrotoxic medications', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Check electrolytes and renal panel', priority: 'medium', category: 'labs', icon: '🔬' },
        { text: 'Nephrology consult if new AKI on CKD', priority: 'medium', category: 'consult', icon: '👨‍⚕️' }
      ],
      'stroke': [
        { text: 'Neurology consult', priority: 'high', category: 'consult', icon: '🧠' },
        { text: 'Swallowing assessment before oral intake', priority: 'high', category: 'procedure', icon: '🏥' },
        { text: 'PT/OT evaluation', priority: 'medium', category: 'consult', icon: '🏃' },
        { text: 'Initiate secondary prevention', priority: 'medium', category: 'medication', icon: '💊' }
      ],
      'dvt': [
        { text: 'Ensure therapeutic anticoagulation', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Compression stockings', priority: 'medium', category: 'general', icon: '🧦' },
        { text: 'Repeat Doppler if symptoms worsen', priority: 'medium', category: 'imaging', icon: '📷' }
      ],
      'pe': [
        { text: 'Continuous O2 monitoring', priority: 'high', category: 'monitoring', icon: '📊' },
        { text: 'Therapeutic anticoagulation', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Echocardiogram for RV strain', priority: 'medium', category: 'imaging', icon: '📷' }
      ],
      'copd': [
        { text: 'Peak flow monitoring', priority: 'medium', category: 'monitoring', icon: '📊' },
        { text: 'Ensure bronchodilator availability', priority: 'high', category: 'medication', icon: '💊' },
        { text: 'Steroid taper plan', priority: 'medium', category: 'medication', icon: '💊' }
      ]
    };
    
    // Check diagnosis matches
    Object.entries(diagnosisSuggestions).forEach(([condition, items]) => {
      if (diagnosis.includes(condition)) {
        items.forEach(item => {
          if (!existingTasks.some(t => t.includes(item.text.toLowerCase().slice(0, 20)))) {
            suggestions.push(item);
          }
        });
      }
    });
    
    // Lab-triggered suggestions
    labs.forEach(param => {
      const status = param.values?.[0]?.status;
      const name = param.name?.toLowerCase();
      
      if (status === 'critical' || status === 'high' || status === 'low') {
        if (name?.includes('potassium') && (status === 'high' || status === 'critical')) {
          suggestions.push({ 
            text: 'Repeat potassium in 2-4h after treatment', 
            priority: 'high', category: 'labs', icon: '🔬' 
          });
          suggestions.push({ 
            text: 'ECG to assess for hyperkalemia changes', 
            priority: 'high', category: 'procedure', icon: '💓' 
          });
        }
        if (name?.includes('hemoglobin') && status === 'low') {
          suggestions.push({ 
            text: 'Type and screen if transfusion anticipated', 
            priority: 'medium', category: 'labs', icon: '🩸' 
          });
        }
        if (name?.includes('creatinine') && (status === 'high' || status === 'critical')) {
          suggestions.push({ 
            text: 'Review all medications for renal dosing', 
            priority: 'high', category: 'medication', icon: '💊' 
          });
        }
      }
    });
    
    // Medication-triggered suggestions
    if (meds.some(m => m?.includes('warfarin'))) {
      suggestions.push({ 
        text: 'Check INR daily until stable', 
        priority: 'high', category: 'labs', icon: '🔬' 
      });
    }
    if (meds.some(m => m?.includes('vancomycin'))) {
      suggestions.push({ 
        text: 'Vancomycin trough before 4th dose', 
        priority: 'high', category: 'labs', icon: '🔬' 
      });
    }
    if (meds.some(m => m?.includes('digoxin'))) {
      suggestions.push({ 
        text: 'Check digoxin level and potassium', 
        priority: 'medium', category: 'labs', icon: '🔬' 
      });
    }
    
    // General suggestions based on status
    if (patient.status === 'critical') {
      suggestions.push({ 
        text: 'ICU consultation for escalation of care', 
        priority: 'high', category: 'consult', icon: '🚨' 
      });
    }
    
    // Discharge planning if stable
    if (patient.status === 'stable' && !existingTasks.some(t => t.includes('discharge'))) {
      suggestions.push({ 
        text: 'Review discharge criteria and plan', 
        priority: 'low', category: 'discharge', icon: '🏠' 
      });
    }
    
    // Deduplicate and limit
    const unique = [];
    const seen = new Set();
    suggestions.forEach(s => {
      const key = s.text.toLowerCase().slice(0, 30);
      if (!seen.has(key)) {
        seen.add(key);
        unique.push(s);
      }
    });
    
    return unique.slice(0, 6);
  }
};

// Task Management Functions
window.openTaskModal = function(existingTask = null) {
  state.editingTaskId = existingTask?.id || null;
  
  const modalHtml = `
    <div class="modal active" id="taskModal" onclick="if(event.target===this)closeModal('taskModal')">
      <div class="modal-box task-modal-box">
        <div class="modal-header task-modal-header">
          <div class="task-modal-icon">📋</div>
          <div>
            <h3 class="modal-title">${existingTask ? 'Edit Task' : 'Add Clinical Task'}</h3>
            <p class="modal-subtitle">For ${esc(state.currentPatient.name)}</p>
          </div>
          <button class="modal-close" onclick="closeModal('taskModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Task Description <span class="required">*</span></label>
            <textarea id="taskText" class="form-textarea task-textarea" 
                      placeholder="e.g., Check morning labs, Discuss with cardiology...">${existingTask?.text || ''}</textarea>
          </div>
          
          <div class="task-form-row">
            <div class="form-group">
              <label class="form-label">Priority</label>
              <div class="priority-chips" id="priorityChips">
                <button type="button" class="priority-chip high ${existingTask?.priority === 'high' ? 'selected' : ''}" data-value="high">
                  🔴 High
                </button>
                <button type="button" class="priority-chip medium ${(!existingTask || existingTask?.priority === 'medium') ? 'selected' : ''}" data-value="medium">
                  🟡 Medium
                </button>
                <button type="button" class="priority-chip low ${existingTask?.priority === 'low' ? 'selected' : ''}" data-value="low">
                  🟢 Low
                </button>
              </div>
            </div>
          </div>
          
          <div class="task-form-row">
            <div class="form-group">
              <label class="form-label">Category</label>
              <div class="category-chips" id="categoryChips">
                <button type="button" class="category-chip ${(!existingTask || existingTask?.category === 'general') ? 'selected' : ''}" data-value="general">📝 General</button>
                <button type="button" class="category-chip ${existingTask?.category === 'labs' ? 'selected' : ''}" data-value="labs">🔬 Labs</button>
                <button type="button" class="category-chip ${existingTask?.category === 'imaging' ? 'selected' : ''}" data-value="imaging">📷 Imaging</button>
                <button type="button" class="category-chip ${existingTask?.category === 'medication' ? 'selected' : ''}" data-value="medication">💊 Meds</button>
                <button type="button" class="category-chip ${existingTask?.category === 'consult' ? 'selected' : ''}" data-value="consult">👨‍⚕️ Consult</button>
                <button type="button" class="category-chip ${existingTask?.category === 'procedure' ? 'selected' : ''}" data-value="procedure">🏥 Procedure</button>
                <button type="button" class="category-chip ${existingTask?.category === 'monitoring' ? 'selected' : ''}" data-value="monitoring">📊 Monitor</button>
                <button type="button" class="category-chip ${existingTask?.category === 'discharge' ? 'selected' : ''}" data-value="discharge">🏠 Discharge</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
          <button class="btn btn-primary" onclick="saveTask()">
            💾 ${existingTask ? 'Update' : 'Add'} Task
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Initialize chip handlers
  document.querySelectorAll('#priorityChips .priority-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#priorityChips .priority-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
    };
  });
  
  document.querySelectorAll('#categoryChips .category-chip').forEach(chip => {
    chip.onclick = function() {
      document.querySelectorAll('#categoryChips .category-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
    };
  });
  
  $('taskText').focus();
};

window.saveTask = function() {
  const text = $('taskText')?.value?.trim();
  if (!text) {
    toast('Please enter a task description', true);
    return;
  }
  
  const priority = document.querySelector('#priorityChips .priority-chip.selected')?.dataset.value || 'medium';
  const category = document.querySelector('#categoryChips .category-chip.selected')?.dataset.value || 'general';
  
  const p = state.currentPatient;
  if (!p.tasks) p.tasks = [];
  
  if (state.editingTaskId) {
    const task = p.tasks.find(t => t.id === state.editingTaskId);
    if (task) {
      task.text = text;
      task.priority = priority;
      task.category = category;
      task.updatedAt = new Date().toISOString();
    }
    toast('Task updated');
  } else {
    p.tasks.push({
      id: Date.now().toString(),
      text: text,
      completed: false,
      priority: priority,
      category: category,
      createdAt: new Date().toISOString(),
      createdBy: state.currentUser || 'Unknown'
    });
    toast('Task added');
    
    // Schedule notification for this task
    if (p.notificationsEnabled) {
      scheduleTaskNotification(p, p.tasks[p.tasks.length - 1]);
    }
  }
  
  saveCloud();
  closeModal('taskModal');
  renderProfilePlans();
};

window.addSuggestedTask = function(text, priority, category) {
  const p = state.currentPatient;
  if (!p.tasks) p.tasks = [];
  
  p.tasks.push({
    id: Date.now().toString(),
    text: text,
    completed: false,
    priority: priority,
    category: category,
    createdAt: new Date().toISOString(),
    createdBy: state.currentUser || 'Unknown',
    aiSuggested: true
  });
  
  saveCloud();
  renderProfilePlans();
  toast('Task added from AI suggestion');
};

window.toggleTaskComplete = function(taskId) {
  const p = state.currentPatient;
  const task = p.tasks?.find(t => t.id === taskId);
  if (!task) return;
  
  task.completed = !task.completed;
  task.completedAt = task.completed ? new Date().toISOString() : null;
  task.completedBy = task.completed ? (state.currentUser || 'Unknown') : null;
  
  saveCloud();
  renderProfilePlans();
  
  if (task.completed) {
    toast('✓ Task completed');
  }
};

window.editTask = function(taskId) {
  const task = state.currentPatient.tasks?.find(t => t.id === taskId);
  if (task) openTaskModal(task);
};

window.deleteTask = function(taskId) {
  if (!confirm('Delete this task?')) return;
  
  const p = state.currentPatient;
  p.tasks = p.tasks.filter(t => t.id !== taskId);
  saveCloud();
  renderProfilePlans();
  toast('Task deleted');
};

window.toggleCompletedTasks = function() {
  const list = $('completedTasksList');
  const icon = $('completedExpandIcon');
  if (!list) return;
  if (list.style.display === 'none') {
    list.style.display = 'block';
    if (icon) icon.textContent = '▲';
  } else {
    list.style.display = 'none';
    if (icon) icon.textContent = '▼';
  }
};

// Notification System
window.togglePlanNotifications = async function(enabled) {
  const p = state.currentPatient;
  p.notificationsEnabled = enabled;
  saveCloud();
  
  if (enabled) {
    const permission = await requestNotificationPermission();
    if (permission) {
      toast('🔔 Notifications enabled');
      checkPendingTaskNotifications(p);
    } else {
      toast('Please enable notifications in browser settings', true);
      p.notificationsEnabled = false;
      $('planNotifyToggle').checked = false;
      saveCloud();
    }
  } else {
    toast('Notifications disabled');
  }
};

async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    console.log('Notifications not supported');
    return false;
  }
  
  if (Notification.permission === 'granted') return true;
  
  const permission = await Notification.requestPermission();
  return permission === 'granted';
}

function checkPendingTaskNotifications(patient) {
  if (!patient.notificationsEnabled) return;
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  
  const pendingTasks = (patient.tasks || []).filter(t => !t.completed);
  const highPriorityTasks = pendingTasks.filter(t => t.priority === 'high');
  
  // Store last notification time to avoid spam
  const lastNotified = localStorage.getItem(`lastTaskNotify_${patient.id}`);
  const now = Date.now();
  
  // Only notify every 30 minutes minimum
  if (lastNotified && (now - parseInt(lastNotified)) < 30 * 60 * 1000) return;
  
  if (highPriorityTasks.length > 0) {
    sendTaskNotification(patient, highPriorityTasks);
    localStorage.setItem(`lastTaskNotify_${patient.id}`, now.toString());
  }
}

function scheduleTaskNotification(patient, task) {
  if (!patient.notificationsEnabled) return;
  
  // For high priority tasks, notify after 15 minutes if not done
  if (task.priority === 'high') {
    setTimeout(() => {
      const currentTask = state.currentPatient?.tasks?.find(t => t.id === task.id);
      if (currentTask && !currentTask.completed) {
        sendSingleTaskNotification(patient, task);
      }
    }, 15 * 60 * 1000);
  }
}

function sendTaskNotification(patient, tasks) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  
  const notification = new Notification(`MedWard: ${patient.name}`, {
    body: `${tasks.length} urgent task${tasks.length > 1 ? 's' : ''} pending:\n• ${tasks[0].text}${tasks.length > 1 ? `\n• +${tasks.length - 1} more` : ''}`,
    icon: '📋',
    tag: `tasks-${patient.id}`,
    requireInteraction: true,
    vibrate: [200, 100, 200]
  });
  
  notification.onclick = function() {
    window.focus();
    if (state.currentPatient?.id !== patient.id) {
      const p = state.patients.find(pt => pt.id === patient.id);
      if (p) {
        state.currentPatient = p;
        state.activeTab = 'plans';
        showPatientProfile();
      }
    }
    notification.close();
  };
}

function sendSingleTaskNotification(patient, task) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  
  new Notification(`MedWard: Reminder`, {
    body: `Urgent task for ${patient.name}:\n${task.text}`,
    icon: '🔴',
    tag: `task-${task.id}`,
    vibrate: [200, 100, 200]
  });
}

// Completion Celebration
function showPlanCompletionCelebration(patient) {
  const celebrationHtml = `
    <div class="celebration-overlay" id="celebrationOverlay" onclick="closeCelebration()">
      <div class="celebration-content" onclick="event.stopPropagation()">
        <div class="celebration-confetti">🎉</div>
        <div class="celebration-badge">
          <div class="badge-ring"></div>
          <div class="badge-icon">✓</div>
        </div>
        <h2 class="celebration-title">Outstanding Work!</h2>
        <p class="celebration-subtitle">All clinical tasks completed for</p>
        <div class="celebration-patient">${esc(patient.name)}</div>
        <div class="celebration-stats">
          <div class="celeb-stat">
            <span class="celeb-stat-value">${patient.tasks?.length || 0}</span>
            <span class="celeb-stat-label">Tasks Completed</span>
          </div>
          <div class="celeb-stat">
            <span class="celeb-stat-value">${patient.tasks?.filter(t => t.priority === 'high').length || 0}</span>
            <span class="celeb-stat-label">High Priority</span>
          </div>
        </div>
        <div class="celebration-message">
          <span class="msg-icon">🏆</span>
          <span>Clinical excellence achieved. Ready for review or discharge planning.</span>
        </div>
        <button class="celebration-btn" onclick="closeCelebration()">Continue</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', celebrationHtml);
  
  // Trigger confetti animation
  setTimeout(() => {
    const overlay = $('celebrationOverlay');
    if (overlay) overlay.classList.add('show');
  }, 50);
  
  // Send congratulations notification
  if (patient.notificationsEnabled && Notification.permission === 'granted') {
    new Notification('MedWard: Excellent Work! 🏆', {
      body: `All tasks completed for ${patient.name}. Clinical plan achieved!`,
      icon: '🎉'
    });
  }
}

window.closeCelebration = function() {
  const overlay = $('celebrationOverlay');
  if (overlay) {
    overlay.classList.remove('show');
    setTimeout(() => overlay.remove(), 300);
  }
};

window.deletePlan = function(idx) {
  if (!confirm('Delete?')) return;
  state.currentPatient.plans.splice(idx, 1);
  saveCloud();
  renderProfilePlans();
};

// ═══════════════════════════════════════════════════════════════════
// DATA MODALS
// ═══════════════════════════════════════════════════════════════════

window.openEditText = function(type, title) {
  $('editTextTitle').textContent = 'Edit ' + title;
  $('editTextType').value = type;
  $('editTextArea').value = state.currentPatient[type] || '';
  openModal('editTextModal');
};

window.openAddVitals = function() {
  state.addDataType = 'vitals';
  $('addDataTitle').textContent = 'Update Vitals';
  const v = state.currentPatient.vitals || {};
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group"><label class="form-label">Heart Rate</label><input type="text" id="addHR" class="form-input" value="${v.hr || ''}"></div>
      <div class="form-group"><label class="form-label">Blood Pressure</label><input type="text" id="addBP" class="form-input" value="${v.bp || ''}" placeholder="120/80"></div>
      <div class="form-group"><label class="form-label">Temperature</label><input type="text" id="addTemp" class="form-input" value="${v.temp || ''}"></div>
      <div class="form-group"><label class="form-label">Respiratory Rate</label><input type="text" id="addRR" class="form-input" value="${v.rr || ''}"></div>
      <div class="form-group"><label class="form-label">SpO₂</label><input type="text" id="addSpO2" class="form-input" value="${v.spo2 || ''}"></div>
    </div>
  `;
  openModal('addDataModal');
};

window.openAddFluid = function() {
  state.addDataType = 'fluid';
  $('addDataTitle').textContent = 'Add Fluid Entry';
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group"><label class="form-label">Intake (mL)</label><input type="number" id="addIntake" class="form-input" value="0"></div>
      <div class="form-group"><label class="form-label">Output (mL)</label><input type="number" id="addOutput" class="form-input" value="0"></div>
    </div>
  `;
  openModal('addDataModal');
};

window.openAddPlan = function() {
  openTaskModal();
};

window.openEditPlan = function() {
  const p = state.currentPatient;
  const latestPlan = (p.notes || []).filter(n => n.type === 'plan' || n.type === 'assessment').sort((a, b) => new Date(b.date || b.timestamp) - new Date(a.date || a.timestamp))[0];
  const planText = latestPlan?.text || p.plan || '';
  
  $('editTextTitle').textContent = 'Edit Plan';
  $('editTextType').value = 'plan';
  $('editTextArea').value = planText;
  openModal('editTextModal');
};

// ═══════════════════════════════════════════════════════════════════
// PLAN ITEM MANAGEMENT - Interactive Checklist
// ═══════════════════════════════════════════════════════════════════

window.openAddPlanItem = function() {
  state.addDataType = 'planItem';
  state.editingPlanItemId = null;
  state.selectedPriority = 'medium';
  
  $('addDataTitle').textContent = 'Add Plan Item';
  $('addDataBody').innerHTML = `
    <div class="plan-modal-body">
      <div class="form-group">
        <label class="form-label">What needs to be done?</label>
        <textarea id="planItemText" class="form-textarea" rows="3" placeholder="e.g., Order chest X-ray, Start IV antibiotics..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <div class="plan-priority-select">
          <div class="plan-priority-option high" onclick="selectPriority('high')">🔴 High</div>
          <div class="plan-priority-option medium selected" onclick="selectPriority('medium')">🟡 Medium</div>
          <div class="plan-priority-option low" onclick="selectPriority('low')">🟢 Low</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Assignee (optional)</label>
        <input type="text" id="planItemAssignee" class="form-input" placeholder="Who should do this?" value="${state.currentUser?.name || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Due Date (optional)</label>
        <input type="date" id="planItemDueDate" class="form-input">
      </div>
    </div>
  `;
  openModal('addDataModal');
  setTimeout(() => $('planItemText')?.focus(), 100);
};

window.selectPriority = function(priority) {
  state.selectedPriority = priority;
  $$('.plan-priority-option').forEach(el => el.classList.remove('selected'));
  document.querySelector(`.plan-priority-option.${priority}`)?.classList.add('selected');
};

window.togglePlanItem = function(itemId) {
  const p = state.currentPatient;
  if (!p.planItems) return;
  
  const item = p.planItems.find(i => i.id === itemId);
  if (item) {
    item.completed = !item.completed;
    item.completedAt = item.completed ? new Date().toISOString() : null;
    item.completedBy = item.completed ? state.currentUser?.name : null;
    
    saveCloud();
    renderProfileOverview();
    toast(item.completed ? '✓ Marked complete' : 'Marked incomplete');
  }
};

window.deletePlanItem = function(itemId) {
  const p = state.currentPatient;
  if (!p.planItems) return;
  
  p.planItems = p.planItems.filter(i => i.id !== itemId);
  saveCloud();
  renderProfileOverview();
  toast('Item removed');
};

window.saveEditText = function() {
  const type = $('editTextType').value;
  const text = $('editTextArea').value;
  
  if (type === 'plan') {
    // Save plan as a note entry for history tracking
    if (!state.currentPatient.notes) state.currentPatient.notes = [];
    state.currentPatient.notes.unshift({
      type: 'plan',
      text: text,
      date: new Date().toISOString().split('T')[0],
      timestamp: new Date().toISOString(),
      author: state.currentUser?.name || 'Unknown'
    });
    state.currentPatient.plan = text;
  } else {
    state.currentPatient[type] = text;
  }
  
  saveCloud();
  renderPatientProfile();
  closeModal('editTextModal');
  toast('Saved!');
};

window.saveAddData = function() {
  const p = state.currentPatient;
  const type = state.addDataType;
  const now = new Date().toISOString();
  
  if (type === 'vitals') {
    p.vitals = { hr: $('addHR').value, bp: $('addBP').value, temp: $('addTemp').value, rr: $('addRR').value, spo2: $('addSpO2').value };
  } else if (type === 'fluid') {
    if (!p.fluids) p.fluids = [];
    p.fluids.push({ date: now, intake: parseInt($('addIntake').value) || 0, output: parseInt($('addOutput').value) || 0 });
  } else if (type === 'planItem') {
    // New plan item
    const text = $('planItemText')?.value?.trim();
    if (!text) {
      toast('Please enter what needs to be done', true);
      return;
    }
    
    if (!p.planItems) p.planItems = [];
    
    const newItem = {
      id: 'plan_' + Date.now(),
      text: text,
      priority: state.selectedPriority || 'medium',
      assignee: $('planItemAssignee')?.value?.trim() || null,
      dueDate: $('planItemDueDate')?.value || null,
      completed: false,
      createdAt: now,
      createdBy: state.currentUser?.name || 'Unknown'
    };
    
    p.planItems.unshift(newItem);
  } else if (type === 'plan') {
    if (!p.plans) p.plans = [];
    const planContent = $('addPlanContent');
    p.plans.push({ date: now, content: planContent?.value || '' });
  }
  
  saveCloud();
  renderPatientProfile();
  closeModal('addDataModal');
  toast('Saved!');
};

window.editCurrentPatient = function() {
  const p = state.currentPatient;
  $('patientModalTitle').textContent = 'Edit Patient';
  $('ptId').value = p.id;
  $('ptName').value = p.name;
  $('ptWard').value = p.ward;
  $('ptRoom').value = p.room || '';
  $('ptDx').value = p.diagnosis || '';
  $('ptDoctor').value = p.doctor || '';
  $('ptStatus').value = p.status;
  openModal('patientModal');
};

window.deleteCurrentPatient = function() {
  if (!confirm('Delete patient? They can be restored from Trash.')) return;
  const patient = state.currentPatient;
  const patientId = patient?.id;
  if (patient) {
    // Move to trash instead of permanent delete
    patient.deletedAt = new Date().toISOString();
    patient.deletedBy = state.currentUser?.name || 'Unknown';
    if (!state.trash.patients) state.trash.patients = [];
    state.trash.patients.push({...patient});
  }
  state.patients = state.patients.filter(p => p.id !== state.currentPatient.id);
  // DELTA SYNC: Queue delete patch
  if (patientId) {
    enqueuePatch('deletePatient', { id: patientId });
  }
  saveCloud();
  closePatientProfile();
  toast('Patient moved to trash');
};

// ═══════════════════════════════════════════════════════════════════
// UNIT ACCESS & AUTH
// ═══════════════════════════════════════════════════════════════════

function openUnitAccess(id) {
  const u = getUnit(id);
  if (!u) return;
  state.selectedUnitId = id;
  $('accessIcon').textContent = u.icon;
  $('accessTitle').textContent = u.name;
  $('userName').value = '';
  
  openModal('accessModal');
  setTimeout(() => $('userName').focus(), 100);
}

window.enterUnit = function() {
  const n = $('userName').value.trim();
  if (!n) { toast('Enter name', true); return; }
  state.currentUnit = getUnit(state.selectedUnitId);
  state.currentUser = { name: n, role: $('userRole').value };

  // Save credentials if "Remember Me" is checked
  if ($('rememberMe')?.checked) {
    const savedLogin = {
      unitId: state.selectedUnitId,
      userName: n,
      userRole: $('userRole').value,
      timestamp: Date.now()
    };
    localStorage.setItem('MEDWARD_SAVED_LOGIN', JSON.stringify(savedLogin));
  }

  closeModal('accessModal');
  showPage('dashboard');
  $('unitBadge').textContent = state.currentUnit.name;
  $('dashAvatar').textContent = initials(state.currentUser.name);
  $('currentDate').textContent = formatDate();
  renderPatients();
  renderRef();
  toast(`Welcome, ${state.currentUser.name}!`);
};

window.logout = function() {
  if (!confirm('Log out of MedWard Pro?')) return;
  
  // Clear all credentials
  localStorage.removeItem('MW_USER');
  localStorage.removeItem('MW_PASS');
  localStorage.removeItem('MW_SELECTED_UNIT');
  localStorage.removeItem('MW_SELECTED_UNIT_NAME');
  sessionStorage.removeItem('MW_USER');
  sessionStorage.removeItem('MW_PASS');
  sessionStorage.removeItem('MW_UNIT');
  sessionStorage.removeItem('MW_UNIT_NAME');
  localStorage.removeItem('MEDWARD_SAVED_LOGIN');
  
  // Redirect to login
  window.location.href = 'login.html';
};

// Open User Settings Modal
window.openUserSettings = function() {
  // Update user display
  const userDisplay = $('settingsUserDisplay');
  if (userDisplay && state.currentUser) {
    userDisplay.textContent = state.currentUser.name || state.currentUser.username || '—';
  }
  
  // Load saved import config
  loadImportConfig();
  
  // Update export unit indicator
  updateExportUnitIndicator();
  
  // Show last import info if available
  const snapshot = localStorage.getItem(IMPORT_SNAPSHOT_KEY);
  if (snapshot) {
    try {
      const data = JSON.parse(snapshot);
      const info = $('lastImportInfo');
      const text = $('lastImportText');
      if (info && text && data.importedAt) {
        const date = new Date(data.importedAt);
        text.textContent = `Last import: ${date.toLocaleDateString()} (${data.patientCount || 0} patients)`;
        info.style.display = 'block';
      }
    } catch(e) {}
  }
  
  openModal('userSettingsModal');
};

window.goToLanding = function() {
  // Go back to landing page to switch units
  sessionStorage.removeItem('MW_UNIT');
  sessionStorage.removeItem('MW_UNIT_NAME');
  localStorage.removeItem('MW_SELECTED_UNIT');
  localStorage.removeItem('MW_SELECTED_UNIT_NAME');
  window.location.href = 'landing.html';
};

window.tryAutoLogin = function() {
  try {
    const saved = localStorage.getItem('MEDWARD_SAVED_LOGIN');
    if (!saved) return false;

    const login = JSON.parse(saved);

    // Expire after 30 days
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;
    if (Date.now() - login.timestamp > thirtyDays) {
      localStorage.removeItem('MEDWARD_SAVED_LOGIN');
      return false;
    }

    const unit = getUnit(login.unitId);
    if (!unit) return false;

    // Auto-login
    state.currentUnit = unit;
    state.currentUser = { name: login.userName, role: login.userRole };
    showPage('dashboard');
    $('unitBadge').textContent = state.currentUnit.name;
    $('dashAvatar').textContent = initials(state.currentUser.name);
    $('currentDate').textContent = formatDate();
    renderPatients();
    renderRef();
    toast(`Welcome back, ${state.currentUser.name}!`);
    return true;
  } catch (e) {
    console.error('Auto-login failed:', e);
    return false;
  }
};

function showTab(tabName) {
  $$('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add('active');
  $$('.panel').forEach(p => p.classList.remove('active'));
  $('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

function showProfileTab(tabName) {
  // Update mobile tabs
  $$('.profile-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-tab[data-ptab="${tabName}"]`)?.classList.add('active');
  // Update sidebar navigation
  $$('.profile-nav-item').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-nav-item[data-ptab="${tabName}"]`)?.classList.add('active');
  // Show panel
  $$('.profile-panel').forEach(p => p.classList.remove('active'));
  $('profile' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');

  // CRITICAL: Scroll to top IMMEDIATELY (not smooth)
  window.scrollTo({ top: 0, behavior: 'instant' });
  document.querySelector('.profile-content')?.scrollTo({ top: 0, behavior: 'instant' });

  // Update badges if needed
  updateProfileBadges();
}

function updateProfileBadges() {
  const p = state.currentPatient;
  if (!p) return;
  // Labs badge - show if critical values
  const labsBadge = $('labsAlertBadge');
  if (labsBadge) {
    const hasCritical = p.labData?.parameters?.some(param => 
      param.values?.[0]?.status === 'critical' || param.values?.[0]?.status === 'high'
    );
    labsBadge.style.display = hasCritical ? 'inline' : 'none';
  }
  // Plans badge - show pending task count
  const plansBadge = $('plansTaskBadge');
  if (plansBadge) {
    const pendingCount = (p.tasks || []).filter(t => !t.completed).length;
    plansBadge.textContent = pendingCount;
    plansBadge.style.display = pendingCount > 0 ? 'inline' : 'none';
  }
}

// Admin functions
window.openAdminLogin = function() { $('adminPwd').value = ''; $('adminError').classList.remove('show'); openModal('adminModal'); };
window.loginAdmin = function() { if ($('adminPwd').value === state.settings.adminPassword) { closeModal('adminModal'); showPage('adminPanel'); $('apiUrl').value = state.settings.apiUrl || ''; $('drugRefUrl').value = state.settings.drugRefUrl || ''; renderUnitsTable(); loadUnitRequests(); updateImportTargetUnit(); } else $('adminError').classList.add('show'); };
window.exitAdmin = function() { window.location.href = 'landing.html'; };
window.openAddUnitModal = function() { state.editingUnitId = null; $('unitModalTitle').textContent = 'Add Unit'; $('uName').value = ''; $('uIcon').value = '🏥'; $('uCode').value = ''; $('uDesc').value = ''; openModal('unitModal'); };
window.addUnit = window.openAddUnitModal;
window.openTrashModal = function() { openModal('trashModal'); fetchTrash(); };
window.editUnit = function(id) { const u = getUnit(id); if (!u) return; state.editingUnitId = id; $('unitModalTitle').textContent = 'Edit Unit'; $('uName').value = u.name; $('uIcon').value = u.icon; $('uCode').value = u.code; $('uDesc').value = u.desc || ''; openModal('unitModal'); };
window.saveUnit = async function() { 
  const name = $('uName').value.trim(), icon = $('uIcon').value.trim() || '🏥', code = $('uCode').value.trim(), desc = $('uDesc').value.trim(); 
  if (!name || !/^\d{4}$/.test(code)) { toast('Name and 4-digit code required', true); return; } 
  if (state.editingUnitId) { 
    const i = state.units.findIndex(u => u.id === state.editingUnitId); 
    if (i !== -1) state.units[i] = { ...state.units[i], name, icon, code, desc }; 
    console.log('📝 Updated unit:', name);
  } else { 
    const newUnit = { id: 'u' + Date.now(), name, icon, code, desc, color: ['#f59e0b', '#14b8a6', '#3b82f6', '#8b5cf6'][state.units.length % 4] };
    state.units.push(newUnit); 
    console.log('➕ Created new unit:', name, newUnit.id);
  } 
  renderUnitsTable(); 
  renderUnits(); 
  closeModal('unitModal'); 
  toast('Syncing...'); 
  // Force immediate sync for unit changes
  await forceSync();
  toast('Unit saved & synced!'); 
};
window.deleteUnit = async function(id) { 
  if (!confirm('Delete this unit? It can be restored from Trash.')) return; 
  const unit = getUnit(id);
  if (unit) {
    // Move to trash instead of permanent delete
    unit.deletedAt = new Date().toISOString();
    unit.deletedBy = state.currentUser?.name || 'Unknown';
    if (!state.trash.units) state.trash.units = [];
    state.trash.units.push(unit);
  }
  console.log('🗑️ Moving unit to trash:', unit?.name);
  state.units = state.units.filter(u => u.id !== id); 
  renderUnitsTable(); 
  renderUnits(); 
  toast('Syncing...');
  await forceSync();
  toast('Unit moved to trash'); 
};
window.saveSettings = async function() { 
  const p = $('newAdminPwd').value.trim(), u = $('apiUrl').value.trim(), d = $('drugRefUrl').value.trim(); 
  if (p) state.settings.adminPassword = p; 
  if (u) state.settings.apiUrl = u; 
  state.settings.drugRefUrl = d; 
  await forceSync(); 
  toast('Settings saved!'); 
  $('newAdminPwd').value = ''; 
};

// ═══════════════════════════════════════════════════════════════════
// WARD LIST IMPORT SYSTEM - Google Sheets Integration
// ═══════════════════════════════════════════════════════════════════

const IMPORT_CONFIG_KEY = 'medward_import_config_v1';
const IMPORT_SNAPSHOT_KEY = 'medward_import_snapshot_v1';

// ═══════════════════════════════════════════════════════════════════
// USER SETTINGS IMPORT FUNCTIONS (uses unique IDs)
// ═══════════════════════════════════════════════════════════════════

window.userImportWardList = async function() {
  const btn = $('btnUserImportList');
  const originalHTML = btn?.innerHTML;
  
  try {
    // CRITICAL: Validate that a unit is selected before importing
    if (!state.currentUnit || !state.currentUnit.id) {
      showUserImportStatus('⚠️ Please select a unit first. Patients will be imported into the current unit.', 'error');
      toast('Select a unit before importing', true);
      return;
    }
    
    if (btn) {
      btn.innerHTML = '<span class="spinner"></span> Starting...';
      btn.disabled = true;
    }
    
    const sheetUrl = $('user_import_sheetUrl')?.value || '';
    const tabName = $('user_import_tabName')?.value || '';
    const clearExisting = $('user_import_clearExisting')?.checked || false;
    
    const sheetId = extractSheetId(sheetUrl);
    
    if (!sheetId) {
      showUserImportStatus('⚠️ Please enter a valid Google Sheet URL or ID', 'error');
      return;
    }
    
    showUserImportStatus(`⚡ Importing to ${state.currentUnit.name}...`, 'info');
    
    // 🚀 FIRE-AND-FORGET: Don't wait for full import
    // CRITICAL: Pass targetUnitId so server knows where to assign patients
    fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'startWardImport',
        username: AUTH.user,
        password: AUTH.pass,
        sheetId: sheetId,
        sheetName: tabName || '',
        clearExisting: clearExisting,
        targetUnitId: state.currentUnit.id,      // CRITICAL: Target unit for patients
        targetUnitName: state.currentUnit.name   // For logging
      })
    }).then(res => res.json()).then(data => {
      console.log('Import response:', data);
      if (data.success) {
        if (data.status === 'completed') {
          showUserImportStatus(`✅ Imported ${data.result?.added || 0} patients to ${state.currentUnit.name}!`, 'success');
          toast('✅ Import complete!');
        }
      } else {
        showUserImportStatus(`❌ ${data.error || 'Import failed'}`, 'error');
      }
    }).catch(e => {
      console.error('Import error:', e);
    });
    
    // Immediate feedback
    showUserImportStatus(`⏳ Import started to ${state.currentUnit.name}. Patients will appear in ~10 seconds...`, 'success');
    toast(`⏳ Importing to ${state.currentUnit.name}...`);
    
    // Reset button immediately
    if (btn) {
      btn.innerHTML = originalHTML || 'Import';
      btn.disabled = false;
    }
    
    // ⏳ Delayed refresh (background import will be done)
    setTimeout(async () => {
      showUserImportStatus('🔄 Refreshing data...', 'info');
      await refreshDataFromServer();
      renderPatients();
      showUserImportStatus('✅ Data refreshed!', 'success');
      toast('🔄 Ward list updated');
    }, 8000);
    
    localStorage.setItem(IMPORT_SNAPSHOT_KEY, JSON.stringify({
      importedAt: new Date().toISOString(),
      sheetId: sheetId,
      status: 'started',
      unitId: state.currentUnit.id,
      unitName: state.currentUnit.name
    }));
    
  } catch (e) {
    console.error('User Import error:', e);
    showUserImportStatus(`❌ Error: ${e.message}`, 'error');
    if (btn) {
      btn.innerHTML = originalHTML || 'Import';
      btn.disabled = false;
    }
  }
};

// ═══════════════════════════════════════════════════════════════════
// CANONICAL DATA REFRESH (GLOBAL)
// ═══════════════════════════════════════════════════════════════════

// Helper to show patients from all units
async function refreshDataFromServer() {
  try {
    console.log('🔄 Refreshing data from server...');
    
    const res = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'loadData',
        username: AUTH.user,
        password: AUTH.pass,
        clientRev: 0  // Force full reload
      })
    });
    
    const text = await res.text();
    console.log('Server response length:', text.length);
    
    const data = JSON.parse(text);
    console.log('Parsed response:', data.success, 'hasData:', !!data.data);
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to load data');
    }
    
    // Update local state with server data
    if (data.data) {
      console.log('Server patients count:', data.data.patients?.length || 0);
      console.log('Server units count:', data.data.units?.length || 0);
      
      if (data.data.patients) {
        state.patients = data.data.patients;
        console.log('✅ Updated state.patients:', state.patients.length);
      }
      if (data.data.units) {
        state.units = data.data.units;
        console.log('✅ Updated state.units:', state.units.length);
      }
      state.lastSync = new Date().toISOString();
      
      // Save to localStorage as backup
      try {
        localStorage.setItem('medward_patients_backup', JSON.stringify(state.patients));
      } catch(e) {}
      
      // ★ CRITICAL: Ensure a valid unit is selected
      ensureValidCurrentUnit();
      
      // ★ CRITICAL: Re-render units selector
      if (typeof renderUnits === 'function') {
        renderUnits();
        console.log('✅ renderUnits() called');
      }
      
      // ★ CRITICAL: Re-render the patients list
      if (typeof renderPatients === 'function') {
        renderPatients();
        console.log('✅ renderPatients() called');
      }
      
      // Update stats
      if (typeof updateStats === 'function') {
        updateStats();
      }
    }
    
    console.log('✅ Data refresh complete, patients:', state.patients.length, 'units:', state.units?.length);
    return true;
    
  } catch (e) {
    console.error('❌ Failed to refresh data:', e);
    return false;
  }
}

// Alias for compatibility
window.loadData = refreshDataFromServer;

// 🧹 Cleanup ward units that were incorrectly created
window.cleanupWardUnits = async function() {
  if (!confirm('This will remove all Ward units (Ward 10, Ward 19, etc.) and keep only your main unit. Patients will be reassigned. Continue?')) {
    return;
  }
  
  const btn = $('btnCleanupUnits');
  const originalText = btn?.textContent;
  
  try {
    if (btn) {
      btn.textContent = '🧹 Cleaning up...';
      btn.disabled = true;
    }
    
    const res = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'cleanupWardUnits',
        username: AUTH.user,
        password: AUTH.pass
      })
    });
    
    const data = await res.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Cleanup failed');
    }
    
    toast(`✅ Removed ${data.removedUnits} ward units, reassigned ${data.reassignedPatients} patients to ${data.targetUnit}`);
    
    // Refresh data
    await refreshDataFromServer();
    
    showUserImportStatus(`✅ Cleanup complete! Removed ${data.removedUnits} units.`, 'success');
    
  } catch (e) {
    console.error('Cleanup error:', e);
    toast('❌ Cleanup failed: ' + e.message, true);
  } finally {
    if (btn) {
      btn.textContent = originalText || '🧹 Cleanup Ward Units';
      btn.disabled = false;
    }
  }
};

window.userPreviewImport = async function() {
  const btn = $('btnUserPreviewImport');
  const originalText = btn?.textContent;
  
  try {
    if (btn) btn.textContent = 'Loading...';
    
    const sheetUrl = $('user_import_sheetUrl')?.value || '';
    const tabName = $('user_import_tabName')?.value || '';
    const sheetId = extractSheetId(sheetUrl);
    
    if (!sheetId) {
      showUserImportStatus('⚠️ Enter a valid Google Sheet URL or ID', 'error');
      return;
    }
    
    showUserImportStatus('⚡ Loading preview...', 'info');
    
    const startTime = Date.now();
    const response = await fetchSheetData(sheetId, tabName, true); // preview mode (uses cache)
    const fetchTime = Date.now() - startTime;
    
    // Use server-side stats
    const stats = response.stats || {};
    const cached = response.cached ? ' ⚡cached' : '';
    const timing = response.timing ? `${response.timing.totalMs}ms` : '';
    
    if (stats.total !== undefined) {
      showUserImportStatus(`
        <strong>📋 Preview${cached}</strong><br>
        Total: <b>${stats.total}</b> | Active: ${stats.active} | ER: ${stats.er} | Chronic: ${stats.chronic}<br>
        Wards: ${stats.wards?.join(', ') || 'None'}<br>
        <small style="opacity:0.7">⚡ ${timing} server, ${fetchTime}ms total</small>
      `, 'success');
    } else {
      showUserImportStatus('⚠️ Could not parse preview data', 'error');
    }
    
  } catch (e) {
    console.error('Preview error:', e);
    showUserImportStatus(`❌ Error: ${e.message}`, 'error');
  } finally {
    if (btn) btn.textContent = originalText || 'Preview';
  }
};

function showUserImportStatus(message, type = 'info') {
  const el = $('userImportStatus');
  if (!el) return;
  
  el.style.display = 'block';
  el.style.background = type === 'error' ? 'rgba(239,68,68,0.1)' : 
                        type === 'success' ? 'rgba(16,185,129,0.1)' : 
                        'rgba(59,130,246,0.1)';
  el.style.color = type === 'error' ? '#dc2626' : 
                   type === 'success' ? '#059669' : 
                   '#3b82f6';
  el.style.border = `1px solid ${type === 'error' ? 'rgba(239,68,68,0.3)' : 
                                  type === 'success' ? 'rgba(16,185,129,0.3)' : 
                                  'rgba(59,130,246,0.3)'}`;
  el.innerHTML = message;
}

// ═══════════════════════════════════════════════════════════════════
// SHARED IMPORT FUNCTIONS  
// ═══════════════════════════════════════════════════════════════════

// Extract Sheet ID from URL or return as-is if already an ID
function extractSheetId(input) {
  if (!input) {
    console.log('extractSheetId: input is empty');
    return null;
  }
  
  input = String(input).trim();
  console.log('extractSheetId input:', input);
  console.log('extractSheetId input length:', input.length);
  console.log('extractSheetId input chars:', JSON.stringify(input));
  
  // Case 1: Full Google Sheets URL - extract ID from URL
  const urlMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  if (urlMatch) {
    console.log('extractSheetId: extracted from URL:', urlMatch[1]);
    return urlMatch[1];
  }
  
  // Case 2: Bare Sheet ID (alphanumeric, dashes, underscores - typically 44 chars but accept 10+)
  if (/^[a-zA-Z0-9_-]{10,}$/.test(input)) {
    console.log('extractSheetId: valid bare ID:', input);
    return input;
  }
  
  // Case 3: Try to extract any ID-like string from input
  const idMatch = input.match(/([a-zA-Z0-9_-]{15,})/);
  if (idMatch) {
    console.log('extractSheetId: found ID in input:', idMatch[1]);
    return idMatch[1];
  }
  
  console.log('extractSheetId: could not extract ID');
  return null;
}

// Save import config to localStorage
function saveImportConfig() {
  const config = {
    sheetUrl: $('import_sheetUrl')?.value || '',
    tabName: $('import_tabName')?.value || '',
    clearExisting: $('import_clearExisting')?.checked || false
  };
  localStorage.setItem(IMPORT_CONFIG_KEY, JSON.stringify(config));
}

// Load import config from localStorage
function loadImportConfig() {
  try {
    const config = JSON.parse(localStorage.getItem(IMPORT_CONFIG_KEY) || '{}');
    if ($('import_sheetUrl')) $('import_sheetUrl').value = config.sheetUrl || '';
    if ($('import_tabName')) $('import_tabName').value = config.tabName || '';
    if ($('import_clearExisting')) $('import_clearExisting').checked = config.clearExisting || false;
    
    // Show last import info
    const snapshot = JSON.parse(localStorage.getItem(IMPORT_SNAPSHOT_KEY) || '{}');
    if (snapshot.importedAt) {
      const info = $('lastImportInfo');
      const text = $('lastImportText');
      if (info && text) {
        const date = new Date(snapshot.importedAt);
        text.textContent = `Last import: ${date.toLocaleDateString()} ${date.toLocaleTimeString()} (${snapshot.patientCount} patients)`;
        info.style.display = 'block';
      }
    }
  } catch (e) {
    console.error('Failed to load import config:', e);
  }
}

// Show import status message
function showImportStatus(message, type = 'info') {
  // Update both possible status elements
  const elements = [$('importStatus'), $('userImportStatus')];
  
  elements.forEach(el => {
    if (!el) return;
    
    el.style.display = 'block';
    el.style.background = type === 'error' ? 'rgba(239,68,68,0.1)' : 
                          type === 'success' ? 'rgba(16,185,129,0.1)' : 
                          'rgba(59,130,246,0.1)';
    el.style.color = type === 'error' ? '#dc2626' : 
                     type === 'success' ? '#059669' : 
                     '#3b82f6';
    el.style.border = `1px solid ${type === 'error' ? 'rgba(239,68,68,0.3)' : 
                                    type === 'success' ? 'rgba(16,185,129,0.3)' : 
                                    'rgba(59,130,246,0.3)'}`;
    el.innerHTML = message;
  });
}

// Fetch sheet data via Apps Script backend
async function fetchSheetData(sheetId, tabName, preview = false) {
  // Use CONFIG.API_URL directly since it's hardcoded
  const apiUrl = CONFIG.API_URL;
  
  if (!apiUrl) {
    throw new Error('API endpoint not configured.');
  }
  
  console.log('fetchSheetData - sheetId:', sheetId, 'preview:', preview);
  
  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({
      action: 'importWardList',
      sheetId: sheetId,
      sheetName: tabName || '',
      preview: preview // Enable caching for preview
    })
  });
  
  const data = await response.json();
  console.log('fetchSheetData - response:', data.success, 'cached:', data.cached, 'timing:', data.timing);
  
  if (!data.ok && !data.success) {
    throw new Error(data.error || 'Failed to fetch sheet data');
  }
  
  return data; // Return full response with parsed data, stats, timing
}

// Normalize header text for matching
function normalizeHeader(h) {
  return String(h || '').trim().toLowerCase().replace(/\s+/g, ' ').replace(/[^\w\s/]/g, '');
}

// Parse ward header (e.g., "Ward 21", "ward 10")
function parseWardHeader(v) {
  const s = String(v || '').trim();
  if (!s) return '';
  const m = s.match(/^(ward)\s*(\d+)/i);
  if (m) return `Ward ${m[2]}`;
  if (/^ward\s+\d+/i.test(s)) return s.replace(/\s+/g, ' ').replace(/^ward/i, 'Ward');
  return '';
}

// Index columns from header row
function indexColumns(headerRow) {
  const headers = (headerRow || []).map(normalizeHeader);
  console.log('Headers found:', headers);
  
  const find = (...needles) => {
    const idx = headers.findIndex(h => needles.some(n => h.includes(n)));
    console.log('Looking for', needles, '-> found at index', idx);
    return idx;
  };
  
  return {
    roomWard: find('room', 'ward', 'bed'),
    name: find('patient', 'name'),
    diagnosis: find('diagnosis', 'dx'),
    doctor: find('doctor', 'assigned', 'physician'),
    status: find('status', 'type')
  };
}

// Get cell value safely
function getCell(row, idx) {
  if (idx == null || idx < 0) return '';
  return (row && row[idx]) ? String(row[idx]).trim() : '';
}

// Parse bed number for sorting
function parseBed(b) {
  const s = String(b || '').trim();
  if (!s) return null;
  // "18-1" format
  let m = s.match(/^(\d+)\s*-\s*(\d+)$/);
  if (m) return { major: Number(m[1]), minor: Number(m[2]) };
  // "16.2" format
  m = s.match(/^(\d+)\s*\.\s*(\d+)$/);
  if (m) return { major: Number(m[1]), minor: Number(m[2]) };
  // Single number "9"
  m = s.match(/^(\d+)$/);
  if (m) return { major: Number(m[1]), minor: 0 };
  return null;
}

// Smart bed comparison for sorting
function smartBedCompare(a, b) {
  const pa = parseBed(a), pb = parseBed(b);
  if (pa && pb) {
    if (pa.major !== pb.major) return pa.major - pb.major;
    if (pa.minor !== pb.minor) return pa.minor - pb.minor;
    return 0;
  }
  return String(a || '').localeCompare(String(b || ''), undefined, { numeric: true });
}

// ═══════════════════════════════════════════════════════════════════
// SANITIZE BED NUMBER - Reject dates and invalid formats
// Valid: "1", "15", "1-1", "2-2", "10.1", "A1", "ICU-3"
// Invalid: Dates like "Sun Jan 11 2026", timestamps, long text
// ═══════════════════════════════════════════════════════════════════
function sanitizeBedNumber(value) {
  if (!value) return '';
  
  const str = String(value).trim();
  
  // If empty or too long, reject
  if (!str || str.length > 15) return '';
  
  // REJECT: Date patterns
  // Matches: "Sun Jan 11 2026", "Jan 11, 2026", "2026-01-11", etc.
  if (/\b(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\b/i.test(str)) return '';
  if (/\b(sun|mon|tue|wed|thu|fri|sat)\b/i.test(str)) return '';
  if (/\d{4}-\d{2}-\d{2}/.test(str)) return ''; // ISO date
  if (/\d{2}\/\d{2}\/\d{4}/.test(str)) return ''; // MM/DD/YYYY
  if (/\d{2}-\d{2}-\d{4}/.test(str)) return ''; // DD-MM-YYYY
  if (/GMT|UTC|Arabian|Standard|Time/i.test(str)) return ''; // Timezone strings
  
  // REJECT: Timestamps or very long numbers
  if (/^\d{10,}$/.test(str)) return ''; // Unix timestamps
  if (/\d{2}:\d{2}/.test(str)) return ''; // Time patterns HH:MM
  
  // ACCEPT: Valid bed number patterns
  // Pattern 1: Simple number "1", "15", "99"
  if (/^\d{1,3}$/.test(str)) return str;
  
  // Pattern 2: Number with dash "1-1", "10-2", "1-15"
  if (/^\d{1,3}-\d{1,2}$/.test(str)) return str;
  
  // Pattern 3: Number with dot "1.1", "10.2"
  if (/^\d{1,3}\.\d{1,2}$/.test(str)) return str;
  
  // Pattern 4: Letter prefix "A1", "B-2", "ICU-3"
  if (/^[A-Z]{1,4}[-]?\d{1,3}$/i.test(str)) return str;
  
  // Pattern 5: ER designation
  if (/^ER$/i.test(str)) return 'ER';
  
  // If nothing matches, return empty (safer than showing garbage)
  console.log('Rejected invalid bed number:', str);
  return '';
}

// Parse sheet rows into normalized patient objects
function parseWardSheetToPatients(values) {
  if (!Array.isArray(values) || values.length < 2) {
    console.log('Invalid values array');
    return [];
  }
  
  console.log('Total rows:', values.length);
  console.log('First 5 rows:', values.slice(0, 5));
  
  // Find header row - look for row with "Patient" AND "Diagnosis" 
  let headerRowIndex = -1;
  for (let i = 0; i < Math.min(values.length, 30); i++) {
    const rowText = values[i].join(' ').toLowerCase();
    if (rowText.includes('patient') && rowText.includes('diagnosis')) {
      headerRowIndex = i;
      console.log('Found header at row', i, ':', values[i]);
      break;
    }
  }
  
  if (headerRowIndex === -1) {
    console.log('No header found, using row 0');
    headerRowIndex = 0;
  }
  
  const header = values[headerRowIndex];
  const colMap = indexColumns(header);
  console.log('Column map:', colMap);
  
  let currentWard = '';
  let currentListType = 'active';
  let inChronicSection = false;
  
  const patients = [];
  
  for (let r = headerRowIndex + 1; r < values.length; r++) {
    const row = values[r];
    if (!row || row.length === 0) continue;
    
    const joined = row.join(' ').trim().toLowerCase();
    
    // Skip empty rows
    if (!joined) continue;
    
    // Detect section markers
    if (joined.includes('chronic list') || joined.includes('(chronic')) {
      console.log('Row', r, ': Chronic section marker');
      inChronicSection = true;
      currentListType = 'chronic';
      currentWard = ''; // Reset ward for chronic section
      continue;
    }
    
    if (joined.includes('er/unassigned')) {
      console.log('Row', r, ': ER/Unassigned section');
      currentWard = 'ER';
      currentListType = 'er';
      continue;
    }
    
    // Check if this is a ward header row (e.g., "Ward 10", "ward 19")
    // Ward headers typically have the ward name in first non-empty cell and nothing else meaningful
    const firstCell = String(row[0] || '').trim().toLowerCase();
    const secondCell = String(row[1] || '').trim().toLowerCase();
    const wardMatch = (firstCell.match(/^ward\s*(\d+)/i) || secondCell.match(/^ward\s*(\d+)/i));
    
    // Count how many cells have content
    const filledCells = row.filter(c => String(c || '').trim()).length;
    
    if (wardMatch && filledCells <= 2) {
      currentWard = 'Ward ' + wardMatch[1];
      console.log('Row', r, ': Ward header ->', currentWard);
      continue;
    }
    
    // Get cell values
    const roomWardCell = getCell(row, colMap.roomWard);
    const name = getCell(row, colMap.name);
    const diagnosis = getCell(row, colMap.diagnosis);
    const doctor = getCell(row, colMap.doctor);
    const status = getCell(row, colMap.status);
    
    // Check for ER in room/ward column
    if (roomWardCell.toLowerCase() === 'er') {
      currentListType = 'er';
      currentWard = 'ER';
    }
    
    // Skip if no patient name and no diagnosis (likely a header/separator row)
    if (!name && !diagnosis) {
      console.log('Row', r, ': Skipping - no name/diagnosis');
      continue;
    }
    
    // Extract bed number (room/ward cell when it's not a ward name)
    // CRITICAL: Validate that bed is a valid room number, NOT a date
    let bed = '';
    if (roomWardCell && !roomWardCell.toLowerCase().startsWith('ward') && roomWardCell.toLowerCase() !== 'er') {
      bed = sanitizeBedNumber(roomWardCell);
    }
    
    // Determine final values
    const finalWard = currentWard || (currentListType === 'er' ? 'ER' : 'Unassigned');
    const finalListType = inChronicSection ? 'chronic' : (roomWardCell.toLowerCase() === 'er' ? 'er' : currentListType);
    
    let finalStatus = status;
    if (!finalStatus) {
      if (finalListType === 'chronic' || status?.toLowerCase() === 'chronic') {
        finalStatus = 'Chronic';
      } else {
        finalStatus = 'Non-Chronic';
      }
    }
    
    const patient = {
      listType: finalListType,
      ward: finalWard,
      bed: bed,
      name: name,
      diagnosis: diagnosis,
      doctor: doctor,
      status: finalStatus,
      sourceRow: r + 1
    };
    
    console.log('Row', r, ': Patient ->', patient.name, '| Ward:', patient.ward, '| Bed:', patient.bed);
    patients.push(patient);
  }
  
  console.log('Total patients parsed:', patients.length);
  
  // Remove duplicates
  const seen = new Set();
  return patients.filter(p => {
    const key = [p.name.toLowerCase(), p.ward.toLowerCase(), p.bed].join('|');
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

// Convert parsed data to MedWard patient format
// IMPORTANT: unitId links patients to organizational units, ward is their physical location
function convertToMedWardPatients(parsedPatients, targetUnitId = null) {
  // Use current unit if no target specified
  const unitId = targetUnitId || (state.currentUnit ? state.currentUnit.id : null);
  
  console.log('convertToMedWardPatients: Assigning unitId:', unitId, 'to', parsedPatients.length, 'patients');
  
  return parsedPatients.map((p, idx) => ({
    id: `imported_${Date.now()}_${idx}`,
    name: p.name,
    diagnosis: p.diagnosis,
    age: null,
    gender: null,
    ward: p.ward,      // Ward = physical location (Ward 20, Ward 21, etc.)
    bed: p.bed,
    room: p.bed,       // Also set room for compatibility
    doctor: p.doctor,
    status: p.listType === 'chronic' ? 'chronic' : 'active',
    listType: p.listType,
    unitId: unitId,    // CRITICAL: Links patient to organizational unit
    medications: [],
    labData: null,
    notes: '',
    createdAt: new Date().toISOString(),
    importedFrom: 'sheets',
    sourceRow: p.sourceRow
  }));
}

// Preview import without applying
window.previewImport = async function() {
  const btn = $('btnPreviewImport');
  const originalText = btn?.textContent;
  
  try {
    if (btn) btn.textContent = 'Loading...';
    saveImportConfig();
    
    const sheetUrl = $('import_sheetUrl')?.value || '';
    const tabName = $('import_tabName')?.value || '';
    const sheetId = extractSheetId(sheetUrl);
    
    if (!sheetId) {
      showImportStatus('⚠️ Please enter a valid Google Sheet URL or ID', 'error');
      return;
    }
    
    showImportStatus('🔄 Fetching sheet data...', 'info');
    
    const values = await fetchSheetData(sheetId, tabName);
    const parsed = parseWardSheetToPatients(values);
    
    // Group by type for summary
    const active = parsed.filter(p => p.listType === 'active');
    const er = parsed.filter(p => p.listType === 'er');
    const chronic = parsed.filter(p => p.listType === 'chronic');
    
    // Get unique wards
    const activeWards = [...new Set(active.map(p => p.ward))].sort((a, b) => {
      const numA = parseInt(a.match(/\d+/)?.[0] || '999');
      const numB = parseInt(b.match(/\d+/)?.[0] || '999');
      return numA - numB;
    });
    
    let summary = `<strong>📋 Preview: ${parsed.length} patients found</strong><br><br>`;
    summary += `<div style="font-size:0.8rem;line-height:1.6">`;
    summary += `<strong style="color:var(--success)">Active:</strong> ${active.length} patients`;
    if (activeWards.length > 0) {
      summary += ` (${activeWards.join(', ')})`;
    }
    summary += `<br>`;
    summary += `<strong style="color:var(--warning)">ER:</strong> ${er.length} patients<br>`;
    summary += `<strong style="color:var(--primary)">Chronic:</strong> ${chronic.length} patients`;
    summary += `</div>`;
    
    // Validation warnings
    const emptyNames = parsed.filter(p => !p.name).length;
    if (emptyNames > parsed.length * 0.3) {
      summary += `<br><br><span style="color:#f59e0b">⚠️ Warning: ${emptyNames} rows have empty names. Check sheet mapping.</span>`;
    }
    
    showImportStatus(summary, 'success');
    
  } catch (e) {
    console.error('Preview error:', e);
    showImportStatus(`❌ ${e.message}`, 'error');
  } finally {
    if (btn) btn.textContent = originalText;
  }
};

// Import ward list and add to state
window.importWardList = async function() {
  const btn = $('btnImportList');
  const originalHTML = btn?.innerHTML;
  
  try {
    // CRITICAL: Validate that a unit is selected before importing
    if (!state.currentUnit || !state.currentUnit.id) {
      showImportStatus('⚠️ Please select a unit first. Patients need to be assigned to an organizational unit.', 'error');
      toast('Select a unit before importing', true);
      return;
    }
    
    if (btn) {
      btn.innerHTML = '<span class="spinner"></span> Importing...';
      btn.disabled = true;
    }
    saveImportConfig();
    
    const sheetUrl = $('import_sheetUrl')?.value || '';
    const tabName = $('import_tabName')?.value || '';
    const clearExisting = $('import_clearExisting')?.checked || false;
    
    // DEBUG: Show what we're working with
    console.log('=== IMPORT DEBUG ===');
    console.log('Raw input value:', sheetUrl);
    console.log('Input length:', sheetUrl.length);
    console.log('Target unit:', state.currentUnit.name, '(', state.currentUnit.id, ')');
    
    const sheetId = extractSheetId(sheetUrl);
    
    console.log('Extracted sheetId:', sheetId);
    
    if (!sheetId) {
      alert('DEBUG: sheetId is null.\nInput was: ' + sheetUrl + '\nLength: ' + sheetUrl.length);
      showImportStatus('⚠️ Please enter a valid Google Sheet URL or ID', 'error');
      return;
    }
    
    // Use CONFIG.API_URL directly since it's hardcoded
    const apiUrl = CONFIG.API_URL;
    if (!apiUrl) {
      showImportStatus('⚠️ API not configured.', 'error');
      return;
    }
    
    showImportStatus('🔄 Fetching sheet data...', 'info');
    
    // Fetch and parse
    console.log('Calling fetchSheetData...');
    const values = await fetchSheetData(sheetId, tabName);
    console.log('Got values:', values?.length, 'rows');
    
    showImportStatus('🔄 Parsing patients...', 'info');
    const parsed = parseWardSheetToPatients(values);
    console.log('Parsed patients:', parsed?.length);
    
    if (parsed.length === 0) {
      showImportStatus('⚠️ No patients found in sheet. Check the format.', 'error');
      return;
    }
    
    // Convert to MedWard format - PASS THE CURRENT UNIT ID
    const newPatients = convertToMedWardPatients(parsed, state.currentUnit.id);
    
    console.log('Converted patients with unitId:', state.currentUnit.id);
    console.log('Sample patient:', newPatients[0]);
    
    // Apply to state
    if (clearExisting) {
      // Only clear patients from the current unit, not all patients
      state.patients = state.patients.filter(p => p.unitId !== state.currentUnit.id);
      state.patients = [...state.patients, ...newPatients];
      console.log('Cleared existing patients for unit:', state.currentUnit.name);
    } else {
      // Merge: add new, skip existing by name+ward within the same unit
      const existingKeys = new Set(state.patients
        .filter(p => p.unitId === state.currentUnit.id)
        .map(p => `${p.name?.toLowerCase()}|${p.ward?.toLowerCase()}`)
      );
      
      const toAdd = newPatients.filter(p => 
        !existingKeys.has(`${p.name?.toLowerCase()}|${p.ward?.toLowerCase()}`)
      );
      
      state.patients = [...state.patients, ...toAdd];
      console.log('Merged:', toAdd.length, 'new patients,', (newPatients.length - toAdd.length), 'duplicates skipped');
    }
    
    // Save snapshot for recovery
    localStorage.setItem(IMPORT_SNAPSHOT_KEY, JSON.stringify({
      importedAt: new Date().toISOString(),
      patientCount: newPatients.length,
      sheetId: sheetId,
      unitId: state.currentUnit.id,
      unitName: state.currentUnit.name
    }));
    
    // Sync to cloud
    await forceSync();
    
    // Refresh UI
    renderPatients();
    
    // Update last import info
    const info = $('lastImportInfo');
    const text = $('lastImportText');
    if (info && text) {
      text.textContent = `Last import: Just now (${newPatients.length} patients to ${state.currentUnit.name})`;
      info.style.display = 'block';
    }
    
    showImportStatus(`✅ Successfully imported ${newPatients.length} patients to ${state.currentUnit.name}!`, 'success');
    toast(`✅ Imported ${newPatients.length} patients to ${state.currentUnit.name}`);
    
  } catch (e) {
    console.error('Import error:', e);
    showImportStatus(`❌ Import failed: ${e.message}`, 'error');
    toast(`Import failed: ${e.message}`, true);
  } finally {
    if (btn) {
      btn.innerHTML = originalHTML;
      btn.disabled = false;
    }
  }
};

// Initialize import config when settings panel opens
document.addEventListener('DOMContentLoaded', () => {
  // Load config when inputs exist
  setTimeout(loadImportConfig, 500);
});

// Admin Tab Navigation
window.switchAdminTab = function(tabName) {
  $$('.admin-tab').forEach(t => t.classList.remove('active'));
  $$('.admin-tab-panel').forEach(p => p.classList.remove('active'));
  
  // Activate clicked tab
  const tab = document.querySelector(`.admin-tab[data-atab="${tabName}"]`);
  if (tab) tab.classList.add('active');
  
  // Activate corresponding panel
  const panelId = 'admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
  const panel = $(panelId);
  if (panel) panel.classList.add('active');
  
  // Render requests when switching to requests tab
  if (tabName === 'requests') {
    renderUnitRequests();
  }
  
  // Render trash when switching to trash tab
  if (tabName === 'trash') {
    renderTrash();
  }
  
  // Update import target unit indicator when switching to settings
  if (tabName === 'settings') {
    updateImportTargetUnit();
  }
};

// Update the import target unit indicator
function updateImportTargetUnit() {
  const indicator = $('importTargetUnitName');
  if (indicator) {
    if (state.currentUnit && state.currentUnit.name) {
      indicator.textContent = state.currentUnit.name;
      indicator.style.color = 'var(--primary)';
    } else {
      indicator.textContent = '⚠️ No unit selected - please select a unit first';
      indicator.style.color = 'var(--danger)';
    }
  }
}

$('adminTabs')?.addEventListener('click', e => {
  const tab = e.target.closest('.admin-tab');
  if (!tab) return;
  switchAdminTab(tab.dataset.atab);
});

// ═══════════════════════════════════════════════════════════════════
// TRASH MANAGEMENT SYSTEM
// ═══════════════════════════════════════════════════════════════════

function renderTrash() {
  const container = $('trashContent');
  if (!container) return;
  
  const patients = state.trash.patients || [];
  const units = state.trash.units || [];
  const medications = state.trash.medications || [];
  
  const totalItems = patients.length + units.length + medications.length;
  
  if (totalItems === 0) {
    container.innerHTML = `
      <div class="admin-empty-state">
        <div class="admin-empty-icon">🗑️</div>
        <div class="admin-empty-text">Trash is empty</div>
        <div class="admin-empty-hint">Deleted items will appear here for 30 days</div>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  // Deleted Patients
  if (patients.length > 0) {
    html += `<div class="trash-section"><h4 style="margin:0 0 12px;font-size:0.9rem;color:var(--text-secondary)">👥 Patients (${patients.length})</h4>`;
    patients.forEach((p, idx) => {
      const deletedDate = p.deletedAt ? new Date(p.deletedAt).toLocaleDateString() : 'Unknown';
      html += `
        <div class="trash-item" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
          <div>
            <div style="font-weight:600">${esc(p.name)}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">Deleted: ${deletedDate} by ${esc(p.deletedBy || 'Unknown')}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-success btn-xs" onclick="restorePatient(${idx})">↩️ Restore</button>
            <button class="btn btn-danger btn-xs" onclick="permanentDeletePatient(${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
        </div>
      `;
    });
    html += '</div>';
  }
  
  // Deleted Units
  if (units.length > 0) {
    html += `<div class="trash-section" style="margin-top:20px"><h4 style="margin:0 0 12px;font-size:0.9rem;color:var(--text-secondary)">🏥 Units (${units.length})</h4>`;
    units.forEach((u, idx) => {
      const deletedDate = u.deletedAt ? new Date(u.deletedAt).toLocaleDateString() : 'Unknown';
      html += `
        <div class="trash-item" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
          <div>
            <div style="font-weight:600">${u.icon || '🏥'} ${esc(u.name)}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">Deleted: ${deletedDate}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-success btn-xs" onclick="restoreUnit(${idx})">↩️ Restore</button>
            <button class="btn btn-danger btn-xs" onclick="permanentDeleteUnit(${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
        </div>
      `;
    });
    html += '</div>';
  }
  
  // Deleted Medications
  if (medications.length > 0) {
    html += `<div class="trash-section" style="margin-top:20px"><h4 style="margin:0 0 12px;font-size:0.9rem;color:var(--text-secondary)">💊 Medications (${medications.length})</h4>`;
    medications.forEach((m, idx) => {
      const deletedDate = m.deletedAt ? new Date(m.deletedAt).toLocaleDateString() : 'Unknown';
      html += `
        <div class="trash-item" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
          <div>
            <div style="font-weight:600">${esc(m.name)}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">From: ${esc(m.patientName || 'Unknown')} • Deleted: ${deletedDate}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-success btn-xs" onclick="restoreMedication(${idx})">↩️ Restore</button>
            <button class="btn btn-danger btn-xs" onclick="permanentDeleteMedication(${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
        </div>
      `;
    });
    html += '</div>';
  }
  
  container.innerHTML = html;
}

window.restorePatient = function(idx) {
  const patient = state.trash.patients[idx];
  if (!patient) return;
  
  // Remove trash metadata
  delete patient.deletedAt;
  delete patient.deletedBy;
  
  // Restore to patients list
  state.patients.push(patient);
  state.trash.patients.splice(idx, 1);
  
  // DELTA SYNC: Queue add patch for restored patient
  enqueuePatch('addPatient', patient);
  
  saveCloud();
  renderTrash();
  toast('Patient restored!');
};

window.restoreUnit = function(idx) {
  const unit = state.trash.units[idx];
  if (!unit) return;
  
  delete unit.deletedAt;
  delete unit.deletedBy;
  
  state.units.push(unit);
  state.trash.units.splice(idx, 1);
  
  saveCloud();
  renderTrash();
  renderUnits();
  toast('Unit restored!');
};

window.restoreMedication = function(idx) {
  const med = state.trash.medications[idx];
  if (!med) return;
  
  // Find the patient and restore medication
  const patient = state.patients.find(p => p.id == med.patientId);
  if (patient) {
    delete med.deletedAt;
    delete med.deletedBy;
    delete med.patientId;
    delete med.patientName;
    
    if (!patient.medications) patient.medications = [];
    patient.medications.push(med);
    
    state.trash.medications.splice(idx, 1);
    saveCloud();
    renderTrash();
    toast('Medication restored!');
  } else {
    toast('Patient not found - cannot restore', true);
  }
};

window.permanentDeletePatient = function(idx) {
  if (!confirm('Permanently delete? This cannot be undone.')) return;
  state.trash.patients.splice(idx, 1);
  saveCloud();
  renderTrash();
  toast('Permanently deleted');
};

window.permanentDeleteUnit = function(idx) {
  if (!confirm('Permanently delete? This cannot be undone.')) return;
  state.trash.units.splice(idx, 1);
  saveCloud();
  renderTrash();
  toast('Permanently deleted');
};

window.permanentDeleteMedication = function(idx) {
  if (!confirm('Permanently delete? This cannot be undone.')) return;
  state.trash.medications.splice(idx, 1);
  saveCloud();
  renderTrash();
  toast('Permanently deleted');
};

window.emptyTrash = function() {
  const total = (state.trash.patients?.length || 0) + (state.trash.units?.length || 0) + (state.trash.medications?.length || 0);
  if (total === 0) {
    toast('Trash is already empty');
    return;
  }
  if (!confirm(`Permanently delete all ${total} items? This cannot be undone.`)) return;
  
  state.trash = { patients: [], units: [], medications: [] };
  saveCloud();
  renderTrash();
  toast('Trash emptied');
};

// ═══════════════════════════════════════════════════════════════════
// UNIT REQUEST SYSTEM
// ═══════════════════════════════════════════════════════════════════

window.openRequestUnit = function() {
  // Reset form
  $('reqName').value = '';
  $('reqEmail').value = '';
  $('reqDepartment').value = '';
  $('reqRole').value = '';
  $('reqUnitName').value = '';
  $('reqMessage').value = '';
  state.selectedIcon = '🏥';
  
  // Reset icon selection
  $$('.request-icon-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelector('.request-icon-option[data-icon="🏥"]')?.classList.add('selected');
  
  // Show form, hide success
  $('requestFormSection').style.display = 'block';
  $('requestSuccessSection').style.display = 'none';
  $('requestFormFooter').style.display = 'flex';
  $('requestSuccessFooter').style.display = 'none';
  
  openModal('requestUnitModal');
};

// Icon selection
$('iconGrid')?.addEventListener('click', e => {
  const opt = e.target.closest('.request-icon-option');
  if (!opt) return;
  $$('.request-icon-option').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  state.selectedIcon = opt.dataset.icon;
});

window.submitUnitRequest = async function() {
  const name = $('reqName').value.trim();
  const email = $('reqEmail').value.trim();
  const department = $('reqDepartment').value.trim();
  const role = $('reqRole').value;
  const unitName = $('reqUnitName').value.trim();
  const message = $('reqMessage').value.trim();
  const icon = state.selectedIcon;
  
  // Validation
  if (!name || !email || !department || !role || !unitName) {
    toast('Please fill all required fields', true);
    return;
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    toast('Please enter a valid email', true);
    return;
  }
  
  const requestId = 'REQ-' + Date.now().toString(36).toUpperCase();
  const request = {
    id: requestId,
    timestamp: new Date().toISOString(),
    status: 'pending',
    requesterName: name,
    requesterEmail: email,
    department,
    role,
    unitName,
    icon,
    message
  };
  
  // Send email notification to admin via FormSubmit
  try {
    const formData = new FormData();
    formData.append('_subject', '🏥 New MedWard Unit Request: ' + unitName);
    formData.append('Request ID', requestId);
    formData.append('Unit Name', icon + ' ' + unitName);
    formData.append('Requester', name);
    formData.append('Email', email);
    formData.append('Department', department);
    formData.append('Role', role);
    formData.append('Message', message || 'No additional message');
    formData.append('Submitted', new Date().toLocaleString());
    formData.append('_template', 'table');
    formData.append('_captcha', 'false');
    
    fetch('https://formsubmit.co/ajax/b.alhaddad13@gmail.com', {
      method: 'POST',
      body: formData
    }).then(r => console.log('Email notification sent')).catch(e => console.log('Email skipped'));
  } catch (e) {
    console.log('Email notification skipped:', e);
  }
  
  // Try to save to cloud if API is configured
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'submitUnitRequest', request })
      });
    } catch (e) {
      console.error('Failed to save request to cloud:', e);
    }
  }
  
  // Also save locally
  if (!state.unitRequests) state.unitRequests = [];
  state.unitRequests.push(request);
  saveLocal();
  
  // Show success
  $('requestIdDisplay').textContent = 'Request ID: ' + requestId;
  $('requestFormSection').style.display = 'none';
  $('requestSuccessSection').style.display = 'block';
  $('requestFormFooter').style.display = 'none';
  $('requestSuccessFooter').style.display = 'flex';
  
  toast('Request submitted successfully!');
  updateRequestsBadge();
};

async function loadUnitRequests() {
  // Load from cloud if possible
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getUnitRequests' })
      });
      const data = await res.json();
      if (data.success && data.requests) {
        state.unitRequests = data.requests;
      }
    } catch (e) {
      console.error('Failed to load requests:', e);
    }
  }
  
  renderUnitRequests();
}

window.refreshRequests = loadUnitRequests;

function updateRequestsBadge() {
  const pending = (state.unitRequests || []).filter(r => r.status === 'pending');
  const badge = $('requestsCount');
  if (badge) {
    if (pending.length > 0) {
      badge.textContent = pending.length;
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }
  }
  // Also log for debugging
  console.log('Unit requests:', state.unitRequests?.length || 0, 'Pending:', pending.length);
}

function renderUnitRequests() {
  const pending = (state.unitRequests || []).filter(r => r.status === 'pending');
  const processed = (state.unitRequests || []).filter(r => r.status !== 'pending');
  
  // Update badge
  updateRequestsBadge();
  
  if (!state.unitRequests?.length) {
    $('requestsList').innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-muted)">
        <div style="font-size:2rem;margin-bottom:12px">📭</div>
        <div>No unit requests yet</div>
      </div>
    `;
    return;
  }
  
  const formatDate = iso => new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  
  let html = '';
  
  // Pending first
  pending.forEach(req => {
    html += `
      <div class="request-card" data-id="${req.id}">
        <div class="request-card-time">${formatDate(req.timestamp)}</div>
        <div class="request-card-header">
          <div class="request-card-title">${req.icon || '🏥'} ${esc(req.unitName)}</div>
          <span class="request-card-status pending">Pending</span>
        </div>
        <div class="request-card-details">
          <div class="request-card-detail">👤 ${esc(req.requesterName)}</div>
          <div class="request-card-detail">📧 ${esc(req.requesterEmail)}</div>
          <div class="request-card-detail">🏥 ${esc(req.department)}</div>
          <div class="request-card-detail">👔 ${roleLabels[req.role] || req.role}</div>
        </div>
        ${req.message ? `<div class="request-card-message">"${esc(req.message)}"</div>` : ''}
        <div class="request-card-actions">
          <button class="btn btn-primary btn-sm" onclick="openApproveRequest('${req.id}')">✅ Review & Approve</button>
          <button class="btn btn-danger btn-sm" onclick="quickRejectRequest('${req.id}')">❌ Reject</button>
        </div>
      </div>
    `;
  });
  
  // Processed (collapsed)
  if (processed.length > 0) {
    html += `<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><h4 style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">📋 Previous Requests (${processed.length})</h4>`;
    processed.slice(0, 10).forEach(req => {
      html += `
        <div class="request-card ${req.status}">
          <div class="request-card-time">${formatDate(req.timestamp)}</div>
          <div class="request-card-header">
            <div class="request-card-title">${req.icon || '🏥'} ${esc(req.unitName)}</div>
            <span class="request-card-status ${req.status}">${req.status === 'approved' ? 'Approved' : 'Rejected'}</span>
          </div>
          <div class="request-card-details">
            <div class="request-card-detail">👤 ${esc(req.requesterName)}</div>
            <div class="request-card-detail">📧 ${esc(req.requesterEmail)}</div>
          </div>
          ${req.assignedCode ? `<div style="margin-top:8px;font-size:0.85rem;color:var(--emerald)">Access Code: <code style="background:var(--bg-card);padding:4px 8px;border-radius:4px">${req.assignedCode}</code></div>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }
  
  $('requestsList').innerHTML = html;
}

window.openApproveRequest = function(requestId) {
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  state.selectedRequestId = requestId;
  
  // Pre-fill form
  $('approveUnitName').value = req.unitName;
  $('approveUnitIcon').value = req.icon || '🏥';
  $('approveUnitCode').value = '';
  $('approveUnitDesc').value = req.department;
  
  // Show request details
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  $('approveRequestDetails').innerHTML = `
    <div style="background:var(--bg);padding:20px;border-radius:var(--radius-sm);margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
        <div style="font-size:2.5rem">${req.icon || '🏥'}</div>
        <div>
          <div style="font-weight:700;font-size:1.1rem">${esc(req.unitName)}</div>
          <div style="color:var(--text-muted);font-size:0.85rem">Requested ${new Date(req.timestamp).toLocaleDateString()}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem">
        <div><span style="color:var(--text-muted)">Requester:</span> ${esc(req.requesterName)}</div>
        <div><span style="color:var(--text-muted)">Email:</span> ${esc(req.requesterEmail)}</div>
        <div><span style="color:var(--text-muted)">Department:</span> ${esc(req.department)}</div>
        <div><span style="color:var(--text-muted)">Role:</span> ${roleLabels[req.role] || req.role}</div>
      </div>
      ${req.message ? `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:0.9rem"><span style="color:var(--text-muted)">Message:</span><br>"${esc(req.message)}"</div>` : ''}
    </div>
  `;
  
  openModal('approveRequestModal');
};

window.approveRequest = async function() {
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  const unitName = $('approveUnitName').value.trim();
  const icon = $('approveUnitIcon').value.trim() || '🏥';
  const code = $('approveUnitCode').value.trim();
  const color = $('approveUnitColor').value;
  const desc = $('approveUnitDesc').value.trim();
  
  if (!unitName || !/^\d{4}$/.test(code)) {
    toast('Please enter a valid unit name and 4-digit code', true);
    return;
  }
  
  // Create the unit
  const newUnit = {
    id: 'u' + Date.now(),
    name: unitName,
    icon,
    code,
    desc,
    color
  };
  
  state.units.push(newUnit);
  
  // Update request status
  req.status = 'approved';
  req.assignedCode = code;
  req.approvedAt = new Date().toISOString();
  
  // Save everything
  await saveCloud();
  
  // Also save request update to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  saveLocal();
  renderUnitsTable();
  renderUnits();
  renderUnitRequests();
  closeModal('approveRequestModal');
  
  // Send approval email to requester
  sendApprovalEmail(req, unitName, code, icon);
  
  toast(`Unit "${unitName}" created with code ${code}!`);
};

// Send approval email via FormSubmit
async function sendApprovalEmail(req, unitName, code, icon) {
  try {
    const emailBody = `
Dear ${req.requesterName},

Great news! Your MedWard Pro unit request has been APPROVED! 🎉

═══════════════════════════════════════════
UNIT ACCESS DETAILS
═══════════════════════════════════════════

Unit Name: ${unitName} ${icon}
Access Code: ${code}

═══════════════════════════════════════════
HOW TO ACCESS
═══════════════════════════════════════════

1. Go to MedWard Pro: https://balhaddad-sys.github.io/Newesr/
2. Click "Switch Unit" from the landing page
3. Select "${unitName}" from the list
4. Enter access code: ${code}

═══════════════════════════════════════════
YOUR REQUEST DETAILS
═══════════════════════════════════════════

Requested Unit: ${req.unitName}
Department: ${req.department}
Role: ${req.role}
Request Date: ${new Date(req.timestamp).toLocaleDateString()}
Approved: ${new Date().toLocaleDateString()}

═══════════════════════════════════════════

Thank you for using MedWard Pro!

Best regards,
MedWard Pro Admin Team

---
This is an automated message. Please do not reply.
    `.trim();

    await fetch('https://formsubmit.co/ajax/' + req.requesterEmail, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        _subject: `✅ MedWard Pro Unit Approved: ${unitName}`,
        _template: 'box',
        unit_name: unitName,
        access_code: code,
        message: emailBody
      })
    });
    
    console.log('✅ Approval email sent to:', req.requesterEmail);
  } catch (e) {
    console.error('Failed to send approval email:', e);
  }
}

// Send rejection email via FormSubmit
async function sendRejectionEmail(req, reason = '') {
  try {
    const emailBody = `
Dear ${req.requesterName},

Thank you for your interest in MedWard Pro.

Unfortunately, your unit request has not been approved at this time.

═══════════════════════════════════════════
REQUEST DETAILS
═══════════════════════════════════════════

Requested Unit: ${req.unitName}
Department: ${req.department}
Request Date: ${new Date(req.timestamp).toLocaleDateString()}

${reason ? `Reason: ${reason}` : ''}

═══════════════════════════════════════════

If you believe this was in error or have questions, please contact your hospital administrator.

Best regards,
MedWard Pro Admin Team
    `.trim();

    await fetch('https://formsubmit.co/ajax/' + req.requesterEmail, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        _subject: `MedWard Pro Unit Request Update: ${req.unitName}`,
        _template: 'box',
        message: emailBody
      })
    });
    
    console.log('📧 Rejection email sent to:', req.requesterEmail);
  } catch (e) {
    console.error('Failed to send rejection email:', e);
  }
}

window.rejectRequest = async function() {
  if (!confirm('Are you sure you want to reject this request?')) return;
  
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  // Save to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  // Send rejection email
  sendRejectionEmail(req);
  
  saveLocal();
  renderUnitRequests();
  closeModal('approveRequestModal');
  toast('Request rejected');
};

window.quickRejectRequest = async function(requestId) {
  if (!confirm('Reject this request?')) return;
  
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {}
  }
  
  saveLocal();
  renderUnitRequests();
  toast('Request rejected');
};

// Patient CRUD
window.openAddPatient = function() { 
  // Ensure a unit is selected before adding patients
  if (!state.currentUnit && state.units.length > 0) {
    state.currentUnit = state.units[0];
    state.currentUser = { name: AUTH.user || 'Doctor', role: 'attending' };
    const unitBadge = $('unitBadge');
    if (unitBadge) unitBadge.textContent = state.currentUnit.name;
    sessionStorage.setItem('MW_UNIT', state.currentUnit.id);
    sessionStorage.setItem('MW_UNIT_NAME', state.currentUnit.name);
    console.log('⚠️ Auto-selected unit in openAddPatient:', state.currentUnit.name);
  }
  if (!state.currentUnit) { 
    toast('No unit available. Please create a unit first.', true); 
    return; 
  }
  $('patientModalTitle').textContent = 'Add Patient'; $('ptId').value = ''; $('ptName').value = ''; $('ptWard').value = 'Ward 14'; $('ptRoom').value = ''; $('ptDx').value = ''; $('ptDoctor').value = state.currentUser?.name || ''; $('ptStatus').value = 'new'; openModal('patientModal'); 
};
window.savePatient = function() { 
  const id = $('ptId').value, name = $('ptName').value.trim(); 
  if (!name) { toast('Name required', true); return; } 
  
  // Auto-select first unit if none selected
  if (!state.currentUnit && state.units.length > 0) {
    state.currentUnit = state.units[0];
    state.currentUser = { name: AUTH.user || 'Doctor', role: 'attending' };
    const unitBadge = $('unitBadge');
    if (unitBadge) unitBadge.textContent = state.currentUnit.name;
    sessionStorage.setItem('MW_UNIT', state.currentUnit.id);
    sessionStorage.setItem('MW_UNIT_NAME', state.currentUnit.name);
    console.log('⚠️ Auto-selected unit in savePatient:', state.currentUnit.name);
  }
  
  if (!state.currentUnit) { toast('No unit selected', true); return; }
  
  const data = { 
    name, 
    ward: $('ptWard').value, 
    room: $('ptRoom').value.trim() || '—', 
    diagnosis: $('ptDx').value.trim() || 'Pending', 
    doctor: $('ptDoctor').value.trim() || 'Unassigned', 
    status: $('ptStatus').value 
  }; 
  
  if (id) { 
    const i = state.patients.findIndex(p => p.id === parseInt(id)); 
    if (i !== -1) { 
      state.patients[i] = { ...state.patients[i], ...data }; 
      if (state.currentPatient?.id === parseInt(id)) { 
        state.currentPatient = state.patients[i]; 
        renderPatientProfile(); 
      }
      // DELTA SYNC: Queue update patch instead of full snapshot
      enqueuePatch('updatePatient', { id: parseInt(id), ...data });
    } 
  } else { 
    // NEW PATIENT - Include unitId
    const newPatient = { 
      id: Date.now(), 
      unitId: state.currentUnit.id,  // CRITICAL: Associate patient with current unit
      ...data, 
      labData: { dates: [], parameters: [] }, 
      imaging: [], 
      fluids: [], 
      plans: [], 
      planItems: [],
      history: '', 
      vitals: {} 
    };
    state.patients.push(newPatient); 
    console.log('➕ New patient added to unit:', state.currentUnit.name);
    // DELTA SYNC: Queue add patch instead of full snapshot
    enqueuePatch('addPatient', newPatient);
  } 
  saveCloud(); 
  renderPatients(); 
  closeModal('patientModal'); 
  toast('Saved!'); 
};

// Import
window.openImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; openModal('importModal'); };
window.resetImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; };
window.extractPatients = async function() {
  if (!state.importImage) { toast('No image selected', true); return; }
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') { toast('API URL not configured. Go to Admin settings.', true); return; }
  
  $('importPreview').style.display = 'none';
  $('importLoading').style.display = 'block';
  $('importError').style.display = 'none';
  
  console.log('🔄 Extracting patients from image...');
  console.log('📡 API:', state.settings.apiUrl.substring(0, 50) + '...');
  console.log('🖼️ Image size:', Math.round(state.importImage.length / 1024), 'KB');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'extractPatients', image: state.importImage })
    });
    
    console.log('📥 Response status:', res.status);
    
    if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);
    
    const d = await res.json();
    console.log('📦 Response:', d);
    
    $('importLoading').style.display = 'none';
    
    if (!d.success) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = d.error || 'API returned an error';
      console.error('❌ API Error:', d.error);
      return;
    }
    
    if (!d.patients?.length) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = 'No patients found in image. Try a clearer screenshot.';
      return;
    }
    
    state.importPatients = d.patients.map((p, i) => ({
      id: Date.now() + i, name: p.name, ward: smartWard(p.ward), room: p.room || '—',
      diagnosis: p.diagnosis || 'Pending', doctor: p.doctor || state.currentUser?.name || 'Unassigned',
      status: p.status === 'chronic' ? 'chronic' : 'active',
      labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {}
    }));
    
    $('importResults').style.display = 'block';
    $('importCount').textContent = state.importPatients.length;
    $('importList').innerHTML = state.importPatients.map(p => `<div class="import-item"><div style="flex:1"><b>${esc(p.name)}</b><div style="font-size:0.75rem;color:var(--text-muted)">${esc(p.room)}</div></div><select class="import-ward-select" onchange="state.importPatients.find(x=>x.id=='${p.id}').ward=this.value">${CONFIG.VALID_WARDS.map(w => `<option value="${w}" ${w === p.ward ? 'selected' : ''}>${w}</option>`).join('')}</select></div>`).join('');
    $('importConfirmBtn').disabled = false;
    
    console.log('✅ Found', state.importPatients.length, 'patients');
    toast('Found ' + state.importPatients.length + ' patients!');
    
  } catch (e) {
    console.error('❌ Extract error:', e);
    $('importLoading').style.display = 'none';
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = e.message || 'Connection failed';
  }
};
window.confirmImport = function() { 
  if (!state.importPatients.length) return; 
  if (!state.currentUnit) { toast('No unit selected', true); return; }
  
  let added = 0; 
  state.importPatients.forEach(p => { 
    // Check for duplicates within the same unit only
    const isDuplicate = state.patients.some(ep => 
      ep.unitId === state.currentUnit.id && 
      ep.name.toLowerCase() === p.name.toLowerCase()
    );
    
    if (!isDuplicate) { 
      // Add unitId to imported patient
      p.unitId = state.currentUnit.id;
      state.patients.push(p); 
      added++; 
    } 
  }); 
  saveCloud(); 
  renderPatients(); 
  closeModal('importModal'); 
  toast(`Imported ${added} patients to ${state.currentUnit.name}!`); 
};
window.exportPDF = function() { 
  const { jsPDF } = window.jspdf; 
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); 
  
  // Filter by current unit first
  const unitPatients = state.currentUnit ? state.patients.filter(p => p.unitId === state.currentUnit.id) : state.patients;
  const pts = state.currentFilter === 'all' ? [...unitPatients] : unitPatients.filter(p => p.status === state.currentFilter); 
  
  if (!pts.length) { toast('No patients in this unit', true); return; } 
  doc.setFillColor(245, 158, 11); doc.rect(0, 0, 297, 18, 'F'); doc.setFontSize(16); doc.setTextColor(0); doc.text(state.currentUnit.name + ' - Patient Report', 14, 12); doc.text(formatDate(), 283, 12, 'right'); let y = 28; const wards = {}; pts.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); }); Object.keys(wards).forEach(ward => { if (y > 185) { doc.addPage(); y = 15; } doc.setFillColor(20, 184, 166); doc.rect(14, y, 269, 7, 'F'); doc.setFontSize(9); doc.setTextColor(255); doc.text(ward + ' (' + wards[ward].length + ')', 16, y + 5); y += 10; wards[ward].forEach(p => { if (y > 190) { doc.addPage(); y = 15; } doc.setFillColor(248, 250, 252); doc.rect(14, y, 269, 10, 'F'); doc.setFontSize(8); doc.setTextColor(30); doc.text(p.room || '—', 16, y + 6); doc.text(p.name, 40, y + 6); doc.text((p.diagnosis || '').substring(0, 60), 100, y + 6); doc.text(p.doctor || '', 220, y + 6); y += 12; }); y += 5; }); doc.save(state.currentUnit.name.replace(/\s+/g, '_') + '_Report.pdf'); toast('PDF exported!'); 
};

// ═══════════════════════════════════════════════════════════════════
// 📄 EXPORT UNIT TO PDF - MATCHES GOOGLE SHEET EXACTLY
// Structure: Active List (top, grouped by ward) → Chronic List (bottom)
// Only NEW patients get orange highlight
// ═══════════════════════════════════════════════════════════════════

window.exportUnitToPDF = function() {
  // Validate unit selection
  if (!state.currentUnit || !state.currentUnit.id) {
    showExportStatus('⚠️ Please select a unit first', 'error');
    toast('Select a unit before exporting', true);
    return;
  }
  
  // Get patients for current unit
  const allPatients = state.patients.filter(p => p.unitId === state.currentUnit.id);
  
  if (!allPatients.length) {
    showExportStatus('⚠️ No patients in this unit to export', 'error');
    toast('No patients to export', true);
    return;
  }
  
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Portrait A4
    
    const unitName = state.currentUnit.name;
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-GB', { 
      weekday: 'short',
      day: 'numeric',
      month: 'short', 
      year: 'numeric' 
    });
    
    // ═══════════════════════════════════════════════════════════════════
    // SEPARATE ACTIVE vs CHRONIC (matching your sheet structure)
    // ═══════════════════════════════════════════════════════════════════
    
    // Active = new, active, critical (NOT chronic)
    const activePatients = allPatients.filter(p => 
      p.status !== 'chronic' && p.listType !== 'chronic'
    );
    
    // Chronic = chronic status or listType
    const chronicPatients = allPatients.filter(p => 
      p.status === 'chronic' || p.listType === 'chronic'
    );
    
    // Ward sort order (matching your sheet)
    const wardOrder = ['Ward 10', 'Ward 19', 'Ward 20', 'Ward 21', 'Ward 22', 'Ward 27', 'Ward 5', 'ER', 'ER/Unassigned', 'Unassigned'];
    
    const sortByWardThenBed = (a, b) => {
      const wardA = a.ward || 'Unassigned';
      const wardB = b.ward || 'Unassigned';
      const idxA = wardOrder.indexOf(wardA) === -1 ? 99 : wardOrder.indexOf(wardA);
      const idxB = wardOrder.indexOf(wardB) === -1 ? 99 : wardOrder.indexOf(wardB);
      if (idxA !== idxB) return idxA - idxB;
      return smartBedSort(a.bed || a.room || '', b.bed || b.room || '');
    };
    
    activePatients.sort(sortByWardThenBed);
    chronicPatients.sort(sortByWardThenBed);
    
    // ═══════════════════════════════════════════════════════════════════
    // PDF HEADER (green bar like your sheet)
    // ═══════════════════════════════════════════════════════════════════
    
    let y = 10;
    
    // Title bar - green like your active list header
    doc.setFillColor(198, 224, 180); // Light green
    doc.rect(10, y, 190, 8, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(unitName + ' - Active List', 14, y + 5.5);
    doc.setFontSize(9);
    doc.text(dateStr, 196, y + 5.5, { align: 'right' });
    
    y += 10;
    
    // ═══════════════════════════════════════════════════════════════════
    // ACTIVE LIST TABLE
    // ═══════════════════════════════════════════════════════════════════
    
    if (activePatients.length > 0) {
      // Build active rows grouped by ward
      const activeRows = [];
      let currentWard = null;
      
      activePatients.forEach(p => {
        const ward = p.ward || 'Unassigned';
        
        // Add ward header row when ward changes
        if (ward !== currentWard) {
          activeRows.push({
            _isWardHeader: true,
            _wardName: ward,
            bed: ward,
            name: '',
            diagnosis: '',
            doctor: '',
            status: ''
          });
          currentWard = ward;
        }
        
        // Add patient row
        activeRows.push({
          _isWardHeader: false,
          _status: p.status,
          bed: p.bed || p.room || '',
          name: p.name || '',
          diagnosis: (p.diagnosis || '').substring(0, 60),
          doctor: p.doctor || p.assignedDoctor || '',
          status: p.status === 'new' ? 'New' : (p.status === 'critical' ? 'Critical' : 'Non-Chronic')
        });
      });
      
      doc.autoTable({
        startY: y,
        head: [[
          { content: 'Room/Ward', styles: { fillColor: [198, 224, 180] } },
          { content: 'Patient Name', styles: { fillColor: [198, 224, 180] } },
          { content: 'Diagnosis', styles: { fillColor: [198, 224, 180] } },
          { content: 'Assigned Doctor', styles: { fillColor: [198, 224, 180] } },
          { content: 'Status', styles: { fillColor: [198, 224, 180] } }
        ]],
        body: activeRows.map(r => [r.bed, r.name, r.diagnosis, r.doctor, r.status]),
        
        theme: 'grid',
        
        styles: {
          font: 'helvetica',
          fontSize: 8,
          cellPadding: 2,
          valign: 'middle',
          lineColor: [180, 180, 180],
          lineWidth: 0.2
        },
        
        headStyles: {
          fillColor: [198, 224, 180], // Green header
          textColor: [0, 100, 0],
          fontStyle: 'bold',
          fontSize: 9
        },
        
        columnStyles: {
          0: { cellWidth: 22 },  // Room/Ward
          1: { cellWidth: 35 },  // Name
          2: { cellWidth: 65 },  // Diagnosis
          3: { cellWidth: 30 },  // Doctor
          4: { cellWidth: 25 }   // Status
        },
        
        // Row styling - ward headers and NEW patient highlighting
        didParseCell: function(data) {
          if (data.section === 'body') {
            const rowData = activeRows[data.row.index];
            
            // Ward header rows - blue background
            if (rowData._isWardHeader) {
              data.cell.styles.fillColor = [68, 114, 196]; // Blue
              data.cell.styles.textColor = [255, 255, 255];
              data.cell.styles.fontStyle = 'bold';
            }
            // NEW patients - ORANGE highlight (only NEW, not critical or others)
            else if (rowData._status === 'new') {
              data.cell.styles.fillColor = [255, 192, 0]; // Orange
              data.cell.styles.fontStyle = 'bold';
            }
          }
        },
        
        // Merge ward header cells
        didDrawCell: function(data) {
          if (data.section === 'body') {
            const rowData = activeRows[data.row.index];
            if (rowData._isWardHeader && data.column.index === 0) {
              // Ward headers span all columns visually
            }
          }
        },
        
        margin: { left: 10, right: 10 }
      });
      
      y = doc.lastAutoTable.finalY + 8;
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // CHRONIC LIST SECTION
    // ═══════════════════════════════════════════════════════════════════
    
    if (chronicPatients.length > 0) {
      // Check if we need a new page
      if (y > 240) {
        doc.addPage();
        y = 10;
      }
      
      // Chronic section header - orange like your sheet
      doc.setFillColor(255, 192, 0); // Orange
      doc.rect(10, y, 190, 8, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
      doc.text('Chronic List', 14, y + 5.5);
      doc.text(chronicPatients.length + ' patients', 196, y + 5.5, { align: 'right' });
      
      y += 10;
      
      // Build chronic rows
      const chronicRows = [];
      let currentWard = null;
      
      chronicPatients.forEach(p => {
        const ward = p.ward || 'Unassigned';
        
        // Add ward header when ward changes
        if (ward !== currentWard) {
          chronicRows.push({
            _isWardHeader: true,
            _wardName: ward,
            bed: ward,
            name: '',
            diagnosis: '',
            doctor: '',
            status: ''
          });
          currentWard = ward;
        }
        
        chronicRows.push({
          _isWardHeader: false,
          bed: p.bed || p.room || '',
          name: p.name || '',
          diagnosis: (p.diagnosis || '').substring(0, 60),
          doctor: p.doctor || p.assignedDoctor || '',
          status: 'Chronic'
        });
      });
      
      doc.autoTable({
        startY: y,
        head: [[
          { content: 'Room/Ward', styles: { fillColor: [255, 192, 0] } },
          { content: 'Patient Name', styles: { fillColor: [255, 192, 0] } },
          { content: 'Diagnosis', styles: { fillColor: [255, 192, 0] } },
          { content: 'Assigned Doctor', styles: { fillColor: [255, 192, 0] } },
          { content: 'Status', styles: { fillColor: [255, 192, 0] } }
        ]],
        body: chronicRows.map(r => [r.bed, r.name, r.diagnosis, r.doctor, r.status]),
        
        theme: 'grid',
        
        styles: {
          font: 'helvetica',
          fontSize: 8,
          cellPadding: 2,
          valign: 'middle',
          lineColor: [180, 180, 180],
          lineWidth: 0.2
        },
        
        headStyles: {
          fillColor: [255, 192, 0], // Orange header
          textColor: [0, 0, 0],
          fontStyle: 'bold',
          fontSize: 9
        },
        
        columnStyles: {
          0: { cellWidth: 22 },
          1: { cellWidth: 35 },
          2: { cellWidth: 65 },
          3: { cellWidth: 30 },
          4: { cellWidth: 25 }
        },
        
        // Ward header styling
        didParseCell: function(data) {
          if (data.section === 'body') {
            const rowData = chronicRows[data.row.index];
            if (rowData._isWardHeader) {
              data.cell.styles.fillColor = [255, 192, 0]; // Orange for chronic ward headers
              data.cell.styles.fontStyle = 'bold';
            }
          }
        },
        
        margin: { left: 10, right: 10 }
      });
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // FOOTER ON ALL PAGES
    // ═══════════════════════════════════════════════════════════════════
    
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(128, 128, 128);
      doc.text('Generated by MedWard Pro', 10, 290);
      doc.text('Page ' + i + ' of ' + pageCount, 105, 290, { align: 'center' });
      doc.text(dateStr, 200, 290, { align: 'right' });
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // SAVE
    // ═══════════════════════════════════════════════════════════════════
    
    const filename = unitName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + today.toISOString().slice(0, 10) + '.pdf';
    doc.save(filename);
    
    showExportStatus(`✅ Exported ${allPatients.length} patients (${activePatients.length} active, ${chronicPatients.length} chronic)`, 'success');
    toast(`📄 PDF exported: ${filename}`);
    
  } catch (e) {
    console.error('PDF Export error:', e);
    showExportStatus(`❌ Export failed: ${e.message}`, 'error');
    toast('Export failed', true);
  }
};

// Helper: Format status for display
function formatStatus(status) {
  const statusMap = {
    'new': '🆕 New',
    'active': '✅ Active',
    'critical': '🚨 Critical',
    'chronic': '💜 Chronic',
    'discharged': '🏠 Discharged'
  };
  return statusMap[status] || status || '—';
}

// Helper: Smart bed sorting (handles "10-1", "9", "22-3" format)
function smartBedSort(a, b) {
  const parseB = (s) => {
    const match = String(s || '').match(/^(\d+)(?:[-.](\d+))?/);
    if (!match) return { major: 999, minor: 0 };
    return { 
      major: parseInt(match[1]) || 999, 
      minor: parseInt(match[2]) || 0 
    };
  };
  
  const pa = parseB(a);
  const pb = parseB(b);
  
  if (pa.major !== pb.major) return pa.major - pb.major;
  return pa.minor - pb.minor;
}

// Helper: Show export status
function showExportStatus(message, type) {
  const el = $('exportStatus');
  if (!el) return;
  
  el.style.display = 'block';
  el.style.background = type === 'error' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
  el.style.color = type === 'error' ? '#dc2626' : '#059669';
  el.style.border = `1px solid ${type === 'error' ? 'rgba(239,68,68,0.3)' : 'rgba(16,185,129,0.3)'}`;
  el.innerHTML = message;
  
  // Auto-hide after 5 seconds
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// Update export unit indicator when settings modal opens
function updateExportUnitIndicator() {
  const indicator = $('exportUnitName');
  if (indicator) {
    if (state.currentUnit && state.currentUnit.name) {
      indicator.textContent = state.currentUnit.name;
      indicator.style.color = 'var(--text)';
    } else {
      indicator.textContent = '⚠️ No unit selected';
      indicator.style.color = 'var(--danger)';
    }
  }
}

// ═══════════════════════════════════════════════════════════════════
// WARD SUGGESTIONS (MANUAL INPUT)
// ═══════════════════════════════════════════════════════════════════

window.showWardSuggestions = function(value) {
  const container = $('wardSuggestions');
  if (!container) return;
  const query = (value || '').toLowerCase().trim();
  
  const commonWards = ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'CCU', 'ER/Unassigned', 'MICU', 'SICU', 'Neuro ICU', 'Cardiac Ward', 'Medical Ward', 'Surgical Ward'];
  
  if (!query) {
    container.innerHTML = commonWards.map(w => 
      `<div class="ward-suggestion" onclick="selectWard('${w}')">${w}</div>`
    ).join('');
    container.classList.add('show');
    return;
  }
  
  const filtered = commonWards.filter(w => 
    w.toLowerCase().includes(query) || 
    w.replace(/\D/g, '').includes(query.replace(/\D/g, ''))
  );
  
  if (filtered.length > 0) {
    container.innerHTML = filtered.map(w => 
      `<div class="ward-suggestion" onclick="selectWard('${w}')">${w}</div>`
    ).join('');
    if (value && !filtered.some(w => w.toLowerCase() === query)) {
      container.innerHTML += `<div class="ward-suggestion" onclick="selectWard('${esc(value)}')" style="color:var(--gold);border-top:1px solid var(--border)">Use: "${esc(value)}"</div>`;
    }
    container.classList.add('show');
  } else {
    container.innerHTML = `<div class="ward-suggestion" onclick="selectWard('${esc(value)}')" style="color:var(--gold)">Use: "${esc(value)}"</div>`;
    container.classList.add('show');
  }
};

window.selectWard = function(ward) {
  $('ptWard').value = ward;
  const container = $('wardSuggestions');
  if (container) container.classList.remove('show');
};

// Hide ward suggestions on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.ward-input-wrapper')) {
    const c = $('wardSuggestions');
    if (c) c.classList.remove('show');
  }
});

// ═══════════════════════════════════════════════════════════════════
// DISCHARGE FUNCTIONALITY
// ═══════════════════════════════════════════════════════════════════

window.openDischargeModal = function(patientId, event) {
  if (event) event.stopPropagation();

  // If no patientId provided, use current patient
  if (!patientId && state.currentPatient) {
    patientId = state.currentPatient.id;
  }

  const p = getPatient(patientId);
  if (!p) {
    toast('Patient not found', true);
    return;
  }
  if (p.status === 'discharged') {
    toast('Patient already discharged', true);
    return;
  }
  state.dischargePatientId = patientId;
  $('dischargePatientName').textContent = p.name;
  $('dischargeSummary').value = '';
  openModal('dischargeModal');
};

window.confirmDischarge = function() {
  const p = getPatient(state.dischargePatientId);
  if (!p) return;
  
  const summary = $('dischargeSummary').value.trim();
  p.status = 'discharged';
  p.dischargeDate = new Date().toISOString();
  
  if (summary) {
    if (!p.plans) p.plans = [];
    p.plans.push({ date: new Date().toISOString(), content: `🏠 DISCHARGE SUMMARY:\n${summary}` });
  }
  
  saveCloud();
  renderPatients();
  closeModal('dischargeModal');
  toast('Patient discharged');
  
  if (state.currentPatient && state.currentPatient.id === p.id) {
    renderPatientProfile();
  }
};

// ═══════════════════════════════════════════════════════════════════
// LAB HISTORY MODAL
// ═══════════════════════════════════════════════════════════════════

window.openLabHistory = function(paramIdx) {
  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]) return;
  
  const param = p.labData.parameters[paramIdx];
  state.labHistoryParamIdx = paramIdx; // Store for edit button
  
  // Build history list
  let html = '';
  
  // Header with current value highlighted
  const latest = param.values?.[0];
  if (latest) {
    const status = latest.status || 'normal';
    const statusColor = status === 'high' || status === 'critical' ? '#dc2626' : 
                        status === 'low' ? '#3b82f6' : '#059669';
    html += `
      <div style="padding:16px;background:linear-gradient(135deg,rgba(37,99,235,0.1),rgba(124,58,237,0.05));border-bottom:1px solid var(--border)">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:4px">CURRENT VALUE</div>
        <div style="display:flex;align-items:baseline;gap:8px">
          <span style="font-size:2rem;font-weight:800;font-family:'JetBrains Mono',monospace;color:${statusColor}">${latest.value}</span>
          <span style="font-size:0.9rem;color:var(--text-muted)">${param.unit || ''}</span>
        </div>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">${formatShortDate(latest.date)}${latest.manualOverride ? ' • ✏️ Edited' : ''}</div>
      </div>
    `;
  }
  
  // Reference range
  if (param.refMin !== undefined && param.refMax !== undefined) {
    html += `
      <div style="padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border);font-size:0.8rem;color:var(--text-secondary)">
        📏 Reference: <strong>${param.refMin} - ${param.refMax}</strong> ${param.unit || ''}
      </div>
    `;
  }
  
  // Previous values header
  if (param.values?.length > 1) {
    html += `<div style="padding:12px 16px;font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;background:var(--bg)">Previous Values</div>`;
    
    // List all previous values
    param.values.slice(1).forEach((val, idx) => {
      const prevStatus = val.status || 'normal';
      const prevColor = prevStatus === 'high' || prevStatus === 'critical' ? '#dc2626' : 
                        prevStatus === 'low' ? '#3b82f6' : 'var(--text-main)';
      const statusBadge = prevStatus !== 'normal' ? 
        `<span style="font-size:0.6rem;padding:2px 6px;border-radius:4px;background:${prevStatus === 'high' ? '#fee2e2' : '#dbeafe'};color:${prevColor};font-weight:600;margin-left:8px">${prevStatus.toUpperCase()}</span>` : '';
      
      // Calculate change from this value to the one before it (if exists)
      let changeHTML = '';
      if (idx === 0 && latest) {
        const diff = parseFloat(latest.value) - parseFloat(val.value);
        if (!isNaN(diff) && diff !== 0) {
          const arrow = diff > 0 ? '↗' : '↘';
          const changeColor = Math.abs(diff) > 0.5 ? (diff > 0 ? '#dc2626' : '#059669') : 'var(--text-muted)';
          changeHTML = `<span style="font-size:0.75rem;color:${changeColor};font-weight:600">${arrow} ${diff > 0 ? '+' : ''}${diff.toFixed(1)}</span>`;
        }
      }
      
      html += `
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="font-size:1.1rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:${prevColor}">${val.value}</span>
            ${statusBadge}
          </div>
          <div style="text-align:right">
            ${changeHTML}
            <div style="font-size:0.75rem;color:var(--text-muted)">${formatShortDate(val.date)}</div>
          </div>
        </div>
      `;
    });
  } else {
    html += `<div style="padding:24px 16px;text-align:center;color:var(--text-muted)">No previous values recorded</div>`;
  }
  
  $('labHistoryTitle').textContent = `📊 ${param.name}`;
  $('labHistoryContent').innerHTML = html;
  openModal('labHistoryModal');
};

window.openLabOverrideFromHistory = function() {
  const paramIdx = state.labHistoryParamIdx;
  if (paramIdx === undefined) return;
  closeModal('labHistoryModal');
  window.openLabOverride(paramIdx, 0); // Edit the latest value
};

// ═══════════════════════════════════════════════════════════════════
// LAB OVERRIDE FUNCTIONALITY
// ═══════════════════════════════════════════════════════════════════

window.openLabOverride = function(paramIdx, valueIdx) {
  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]) return;
  
  const param = p.labData.parameters[paramIdx];
  const value = param.values?.[valueIdx];
  
  $('labOverrideName').textContent = `${param.name} (${param.unit || ''})`;
  $('labOverrideValue').value = value?.value || '';
  $('labOverrideParamIdx').value = paramIdx;
  $('labOverrideValueIdx').value = valueIdx;
  
  openModal('labOverrideModal');
};

window.saveLabOverride = function() {
  const paramIdx = parseInt($('labOverrideParamIdx').value);
  const valueIdx = parseInt($('labOverrideValueIdx').value);
  const newValue = $('labOverrideValue').value.trim();
  
  if (!newValue) { toast('Please enter a value', true); return; }
  
  const p = state.currentPatient;
  if (!p?.labData?.parameters?.[paramIdx]?.values?.[valueIdx]) {
    toast('Lab value not found', true);
    return;
  }
  
  const param = p.labData.parameters[paramIdx];
  param.values[valueIdx].value = parseFloat(newValue) || newValue;
  param.values[valueIdx].manualOverride = true;
  param.values[valueIdx].overrideDate = new Date().toISOString();
  
  // Re-evaluate status
  const numVal = parseFloat(newValue);
  if (!isNaN(numVal) && param.refMin !== undefined && param.refMax !== undefined) {
    if (numVal < param.refMin) param.values[valueIdx].status = 'low';
    else if (numVal > param.refMax) param.values[valueIdx].status = 'high';
    else param.values[valueIdx].status = 'normal';
  }
  
  saveCloud();
  renderProfileLabs();
  closeModal('labOverrideModal');
  toast('Lab value updated');
};

// ═══════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════
// NIGHT SHIFT THEME SYSTEM
// ═══════════════════════════════════════════════════════════════════

function initTheme() {
  const savedTheme = localStorage.getItem('MEDWARD_THEME');
  const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
  
  if (isDark) {
    document.body.classList.add('dark-theme');
  } else {
    document.body.classList.remove('dark-theme');
  }
  
  // Update icons after DOM is ready
  setTimeout(() => updateThemeIcon(isDark), 0);
}

function toggleTheme() {
  const isDark = document.body.classList.toggle('dark-theme');
  updateThemeIcon(isDark);
  
  // Save preference
  localStorage.setItem('MEDWARD_THEME', isDark ? 'dark' : 'light');
  
  toast(isDark ? "Night Mode" : "Day Mode");
}

const THEME_ICONS = {
  sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
  moon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>'
};

function updateThemeIcon(isDark) {
  const icon = document.getElementById('theme-icon');
  const iconLanding = document.getElementById('theme-icon-landing');
  if (icon) icon.innerHTML = isDark ? THEME_ICONS.sun : THEME_ICONS.moon;
  if (iconLanding) iconLanding.innerHTML = isDark ? THEME_ICONS.sun : THEME_ICONS.moon;
}

// Initialize theme on DOMContentLoaded to update icons
document.addEventListener('DOMContentLoaded', function() {
  const isDark = document.body.classList.contains('dark-theme');
  updateThemeIcon(isDark);
});

// ═══════════════════════════════════════════════════════════════════════════
// BOOT DIAGNOSTICS & DEBUG SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

// Toggle search functionality (placeholder - can be expanded)
function toggleSearch() {
  // For now, focus on the patient search or show a search modal
  const searchInput = document.querySelector('.scores-search-input') || document.querySelector('input[type="search"]');
  if (searchInput) {
    searchInput.focus();
    searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else {
    toast('Search: Use the scores tab to search clinical calculators');
  }
}

// Initialize debug panel (placeholder for development features)
function initDebugPanel() {
  // Only show in development mode or with debug flag
  if (new URLSearchParams(window.location.search).has('debug')) {
    console.log('🔧 Debug mode enabled');
  }
}

// Old diagnostics functions removed - now using Diagnostics object in CONFIG section

// ═══════════════════════════════════════════════════════════════════════════
// CLOUD-FIRST BOOT SEQUENCE - Professional pattern for data consistency
// ═══════════════════════════════════════════════════════════════════════════
// 
// Boot order:
// 1. Show loading indicator
// 2. Try to load from cloud (with timeout)
// 3. If cloud succeeds → use cloud data as truth
// 4. If cloud fails/times out → fall back to local cache
// 5. After 10 seconds of stability → warm local cache once
// 
// This prevents "local snapshot overwrites good cloud data" bugs
// ═══════════════════════════════════════════════════════════════════════════

async function cloudFirstBoot() {
  boot.bootPhase = 'loading';
  
  console.log('🚀 Cache-first boot starting...');
  
  // ═══════════════════════════════════════════════════════════════════
  // CACHE-ONLY LOAD - loading.html already fetched from cloud
  // This page only reads from the warmed cache
  // ═══════════════════════════════════════════════════════════════════
  
  const cloudVerified = localStorage.getItem('MW_CLOUD_VERIFIED');
  
  // Allow reads from local cache
  boot.allowLocalReads = true;
  
  // Try to load from cache
  const cached = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');
  
  if (cached) {
    try {
      const data = JSON.parse(cached);
      
      // Apply cached data to state
      if (data.units?.length) {
        state.units = data.units;
      }
      if (data.patients) {
        state.patients = data.patients;
      }
      if (data.settings) {
        state.settings = { ...state.settings, ...data.settings };
      }
      // Always ensure API URL is set from CONFIG
      state.settings.apiUrl = CONFIG.API_URL;
      if (data.unitRequests) {
        state.unitRequests = data.unitRequests;
      }
      if (data.trash) {
        state.trash = data.trash;
      }
      if (data.rev) {
        sync.clientRev = data.rev;
      }
      
      // ═══════════════════════════════════════════════════════════════════
      // If MW_CLOUD_VERIFIED exists, loading.html verified it - FULL ACCESS
      // ═══════════════════════════════════════════════════════════════════
      if (cloudVerified) {
        boot.cloudLoaded = true;
        boot.allowLocalWrites = true;
        boot.bootPhase = 'ready';
        sync.isHydrated = true;
        sync.isReadOnly = false;
        sync.hasEverSyncedThisSession = true;
        sync.lastServerPatientCount = state.patients?.length || 0;
        sync.lastServerUnitCount = state.units?.length || 0;

        // ✅ UNLOCK sync (new sync engine)
        sync.isHydrated = true;
        sync.isReadOnly = false;
        sync.cloudLoaded = true;
        if (data.rev) {
          sync.clientRev = data.rev;
        }

        // Check if we're in offline mode
        const isOfflineMode = localStorage.getItem('MW_OFFLINE_MODE') === 'true';

        if (isOfflineMode) {
          showSyncStatusBar('📴 Offline mode - using cached data', 'orange');
          console.log('⚠️ Loaded from offline cache:', state.patients.length, 'patients');
        } else {
          showSyncStatusBar('☁️ Cloud connected', 'green');
          console.log('✅ Loaded from verified cache:', state.patients.length, 'patients');
        }

        return true;
      } else {
        // ═══════════════════════════════════════════════════════════════════
        // No MW_CLOUD_VERIFIED - user accessed dashboard directly without
        // going through loading.html. Redirect to loading.html to verify.
        // ═══════════════════════════════════════════════════════════════════
        console.log('⚠️ Cache not verified - redirecting to loading page');
        window.location.href = 'loading.html';
        return false;
      }
      
    } catch (e) {
      console.error('❌ Failed to parse cache:', e);
    }
  }
  
  // No cache found - redirect to loading page
  console.log('❌ No cache found - redirecting to loading page');
  window.location.href = 'loading.html';
  return false;
}

// Ensure default unit exists (called after boot)
function ensureDefaultUnit() {
  if (!state.units.length) {
    state.units = [{ id: 'med-e', name: 'Medicine Unit E', icon: '🏥', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }];
    console.log('📋 Created default unit');
  }
  state.settings.adminPassword = state.settings.adminPassword || CONFIG.ADMIN_PASSWORD;
}

async function init() {
  // Initialize Sync Engine v2.0
  if (typeof initSyncEngineV2 === 'function') {
    initSyncEngineV2();
  }

  console.log('🚀 MedWard Pro v17.4 - Build:', CONFIG.BUILD_ID);
  console.log('📦 CACHE-FIRST BOOT: Using cache warmed by loading.html');
  
  // Run boot diagnostics
  if (!Diagnostics.run()) {
    console.error('❌ Boot diagnostics failed');
    return;
  }
  
  // Show debug panel if ?debug=1 in URL
  Diagnostics.showDebugPanel();
  
  // ═══════════════════════════════════════════════════════════════════
  // CACHE-FIRST BOOT: Read from warmed cache (loading.html fetched cloud)
  // ═══════════════════════════════════════════════════════════════════
  await cloudFirstBoot();

  // ═══════════════════════════════════════════════════════════════════
  // SAFETY CHECK: Ensure sync is unlocked after boot
  // This prevents silent save failures if boot completed but unlock didn't happen
  // ═══════════════════════════════════════════════════════════════════
  if (!canWrite()) {
    console.warn('⚠️ sync not unlocked after boot - forcing unlock');
    const cached = localStorage.getItem('medward_pro_v12') || localStorage.getItem('MEDWARD_CACHE');
    if (cached) {
      try {
        const data = JSON.parse(cached);
        sync.isHydrated = true;
        sync.isReadOnly = false;
        sync.cloudLoaded = true;
        if (data.rev) {
          sync.clientRev = data.rev;
        }
        console.log('✅ sync force-unlocked with cached data');
      } catch (e) {
        console.error('❌ Failed to force-unlock sync:', e);
      }
    }
  }

  // Ensure default unit exists
  ensureDefaultUnit();
  
  // Clear any stale cache flags since we've now done proper boot
  localStorage.removeItem('MW_CACHE_STALE');
  
  // Load unit from session (try sessionStorage first, then localStorage as fallback)
  let unitId = sessionStorage.getItem('MW_UNIT');
  let unitName = sessionStorage.getItem('MW_UNIT_NAME');
  
  // Fallback to localStorage if sessionStorage is empty
  if (!unitId || !unitName) {
    console.log('⚠️ sessionStorage empty, trying localStorage fallback');
    unitId = localStorage.getItem('MW_SELECTED_UNIT');
    unitName = localStorage.getItem('MW_SELECTED_UNIT_NAME');
    
    // If found in localStorage, copy to sessionStorage
    if (unitId && unitName) {
      sessionStorage.setItem('MW_UNIT', unitId);
      sessionStorage.setItem('MW_UNIT_NAME', unitName);
      console.log('✅ Restored from localStorage:', unitName);
    }
  }
  
  console.log('🔍 Unit from storage:', { unitId, unitName });
  console.log('🔍 Available units:', state.units.map(u => ({ id: u.id, name: u.name })));
  
  if (unitId && unitName) {
    let unit = state.units.find(u => u.id === unitId);
    
    // If unit not found in state.units, create a proper unit object and add it
    if (!unit) {
      console.log('⚠️ Unit not in state.units, creating full unit object');
      unit = { 
        id: unitId, 
        name: unitName, 
        icon: '🏥', 
        desc: '', 
        color: '#005eb8',
        createdAt: new Date().toISOString()
      };
      // Add to state.units so it passes validation later
      state.units.push(unit);
    }
    
    state.currentUnit = unit;
    state.currentUser = { name: AUTH.user || 'Doctor', role: 'attending' };
    
    console.log('✅ Current unit set:', state.currentUnit);
    
    const unitBadge = $('unitBadge');
    const dashAvatar = $('dashAvatar');
    const currentDate = $('currentDate');
    
    if (unitBadge) unitBadge.textContent = unitName;
    if (dashAvatar) dashAvatar.textContent = initials(AUTH.user || 'Doctor');
    if (currentDate) currentDate.textContent = formatDate();
  } else {
    // No unit in session - fallback to first available unit
    console.log('⚠️ No unit in session, falling back to first unit');
    if (state.units.length > 0) {
      state.currentUnit = state.units[0];
      state.currentUser = { name: AUTH.user || 'Doctor', role: 'attending' };
      
      const unitBadge = $('unitBadge');
      const dashAvatar = $('dashAvatar');
      const currentDate = $('currentDate');
      
      if (unitBadge) unitBadge.textContent = state.currentUnit.name;
      if (dashAvatar) dashAvatar.textContent = initials(AUTH.user || 'Doctor');
      if (currentDate) currentDate.textContent = formatDate();
      
      // Update session storage so it persists
      sessionStorage.setItem('MW_UNIT', state.currentUnit.id);
      sessionStorage.setItem('MW_UNIT_NAME', state.currentUnit.name);
      
      console.log('✅ Fallback unit set:', state.currentUnit);
    } else {
      console.error('❌ No units available to select!');
    }
  }
  
  // SAFETY: Final check - if still no unit, force create one
  if (!state.currentUnit && state.units.length > 0) {
    console.warn('⚠️ SAFETY: state.currentUnit still null, forcing assignment');
    state.currentUnit = state.units[0];
    state.currentUser = { name: AUTH.user || 'Doctor', role: 'attending' };
    const unitBadge = $('unitBadge');
    if (unitBadge) unitBadge.textContent = state.currentUnit.name;
  }

  // Render UI with loaded data (cloud or local fallback)
  renderScoresGrid();
  renderRef();
  renderPatients();
  console.log('✨ UI rendered:', state.patients.length, 'patients');

  // ═══════════════════════════════════════════════════════════════════
  // AUTO-DETECT UNIT MISMATCH
  // If patients exist but none match current unit, log diagnostic info
  // ═══════════════════════════════════════════════════════════════════
  const allPatients = state.patients || [];
  if (allPatients.length > 0 && state.currentUnit) {
    const matchingCount = allPatients.filter(p => p.unitId === state.currentUnit.id).length;
    if (matchingCount === 0) {
      const patientUnitIds = [...new Set(allPatients.map(p => p.unitId))];
      console.warn('═══════════════════════════════════════════════════════════════════');
      console.warn('⚠️ UNIT MISMATCH DETECTED ON BOOT');
      console.warn('═══════════════════════════════════════════════════════════════════');
      console.warn('Current unit:', state.currentUnit.name, '(id:', state.currentUnit.id + ')');
      console.warn('Total patients in system:', allPatients.length);
      console.warn('Patients matching current unit: 0');
      console.warn('Patient unitIds found:', patientUnitIds);
      console.warn('');
      console.warn('💡 To fix this, run in console: fixUnitMismatch()');
      console.warn('💡 Or run: diagnoseSync() for full diagnostic');
      console.warn('═══════════════════════════════════════════════════════════════════');
    }
  }

  // Setup event handlers
  const mainTabs = $('mainTabs');
  if (mainTabs) mainTabs.onclick = e => { const t = e.target.closest('.tab'); if (t) showTab(t.dataset.tab); };
  
  const profileTabs = $('profileTabs');
  if (profileTabs) profileTabs.onclick = e => { const t = e.target.closest('.profile-tab'); if (t) showProfileTab(t.dataset.ptab); };
  
  const profileSidebar = $('profileSidebar');
  if (profileSidebar) profileSidebar.onclick = e => { const t = e.target.closest('.profile-nav-item'); if (t) showProfileTab(t.dataset.ptab); };
  
  const statsBar = $('statsBar');
  if (statsBar) statsBar.onclick = e => { const s = e.target.closest('.stat-card'); if (s) { state.currentFilter = s.dataset.filter; renderPatients(); } };
  
  // Logout button handler
  const logoutBtn = $('logoutBtn');
  if (logoutBtn) {
    logoutBtn.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      logout();
    };
  }

  // File input handlers
  const labFileInput = $('labFileInput');
  if (labFileInput) labFileInput.onchange = function() { if (this.files.length > 0) handleLabUpload(this.files); this.value = ''; };
  
  const imagingFileInput = $('imagingFileInput');
  if (imagingFileInput) imagingFileInput.onchange = function() { if (this.files[0]) handleImagingUpload(this.files[0]); this.value = ''; };
  
  const importFile = $('importFile');
  if (importFile) importFile.onchange = function() { if (this.files[0]) { compress(this.files[0], CONFIG.MAX_IMAGE_SIZE, url => { state.importImage = url; $('importImg').src = url; $('importUpload').style.display = 'none'; $('importPreview').style.display = 'block'; }); } };

  // Modal close on backdrop click
  $$('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.classList.remove('active'); });

  // Initialize debug panel if enabled
  initDebugPanel();

  // ═══════════════════════════════════════════════════════════════════
  // GLOBAL DIAGNOSTIC FUNCTION - Call from browser console: diagnoseSync()
  // ═══════════════════════════════════════════════════════════════════
  window.diagnoseSync = function() {
    const allPatients = state.patients || [];
    const patientUnitIds = [...new Set(allPatients.map(p => p.unitId))];

    console.log('═══════════════════════════════════════════════════════════════════');
    console.log('🔍 MEDWARD SYNC DIAGNOSTIC REPORT');
    console.log('═══════════════════════════════════════════════════════════════════');

    console.log('\n📦 STATE:');
    console.log('  Total patients in state:', allPatients.length);
    console.log('  Total units in state:', state.units?.length || 0);
    console.log('  Current unit:', state.currentUnit?.name || 'NOT SET');
    console.log('  Current unit ID:', state.currentUnit?.id || 'NOT SET');

    console.log('\n🏥 UNIT IDS IN PATIENTS:');
    patientUnitIds.forEach(uid => {
      const count = allPatients.filter(p => p.unitId === uid).length;
      const matchesCurrent = uid === state.currentUnit?.id ? ' ✅ MATCHES CURRENT' : '';
      console.log(`  ${uid}: ${count} patients${matchesCurrent}`);
    });

    console.log('\n💾 STORAGE:');
    console.log('  sessionStorage MW_UNIT:', sessionStorage.getItem('MW_UNIT'));
    console.log('  sessionStorage MW_UNIT_NAME:', sessionStorage.getItem('MW_UNIT_NAME'));
    console.log('  localStorage MW_SELECTED_UNIT:', localStorage.getItem('MW_SELECTED_UNIT'));
    console.log('  localStorage MW_SELECTED_UNIT_NAME:', localStorage.getItem('MW_SELECTED_UNIT_NAME'));
    console.log('  localStorage MW_CLOUD_VERIFIED:', localStorage.getItem('MW_CLOUD_VERIFIED'));

    console.log('\n🔄 SYNC STATE:');
    console.log('  sync.isHydrated:', sync.isHydrated);
    console.log('  sync.isReadOnly:', sync.isReadOnly);
    console.log('  sync.cloudLoaded:', sync.cloudLoaded);
    console.log('  boot.cloudLoaded:', boot.cloudLoaded);
    console.log('  boot.allowLocalWrites:', boot.allowLocalWrites);

    // Check for mismatch
    if (allPatients.length > 0 && state.currentUnit) {
      const matchingPatients = allPatients.filter(p => p.unitId === state.currentUnit.id);
      if (matchingPatients.length === 0) {
        console.log('\n⚠️ MISMATCH DETECTED:');
        console.log('  Current unit ID does not match any patient unitId!');
        console.log('  To fix: Switch to a unit that has patients, or add patients to current unit');
        console.log('  Available unitIds with patients:', patientUnitIds);
      }
    }

    console.log('\n═══════════════════════════════════════════════════════════════════');
    return { patients: allPatients.length, currentUnit: state.currentUnit, patientUnitIds };
  };

  // ═══════════════════════════════════════════════════════════════════
  // FIX UNIT MISMATCH - Call from console: fixUnitMismatch()
  // Automatically switches to a unit that has patients
  // ═══════════════════════════════════════════════════════════════════
  window.fixUnitMismatch = function() {
    const allPatients = state.patients || [];
    if (allPatients.length === 0) {
      console.log('ℹ️ No patients in system - nothing to fix');
      return false;
    }

    // Find the first patient's unitId
    const firstPatientUnitId = allPatients[0].unitId;
    if (!firstPatientUnitId) {
      console.log('⚠️ First patient has no unitId');
      return false;
    }

    // Check if we already match
    if (state.currentUnit?.id === firstPatientUnitId) {
      console.log('✅ Current unit already matches patients');
      return true;
    }

    // Find or create the matching unit
    let matchingUnit = state.units.find(u => u.id === firstPatientUnitId);
    if (!matchingUnit) {
      // Create a unit from the patient's unitId
      matchingUnit = {
        id: firstPatientUnitId,
        name: firstPatientUnitId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        icon: '🏥',
        desc: 'Auto-created unit',
        color: '#005eb8',
        createdAt: new Date().toISOString()
      };
      state.units.push(matchingUnit);
      console.log('📋 Created missing unit:', matchingUnit.name);
    }

    // Switch to the matching unit
    state.currentUnit = matchingUnit;
    sessionStorage.setItem('MW_UNIT', matchingUnit.id);
    sessionStorage.setItem('MW_UNIT_NAME', matchingUnit.name);
    localStorage.setItem('MW_SELECTED_UNIT', matchingUnit.id);
    localStorage.setItem('MW_SELECTED_UNIT_NAME', matchingUnit.name);

    // Update UI
    const unitBadge = $('unitBadge');
    if (unitBadge) unitBadge.textContent = matchingUnit.name;

    // Re-render
    renderPatients();

    console.log('✅ Switched to unit:', matchingUnit.name);
    console.log('📊 Patients now visible:', allPatients.filter(p => p.unitId === matchingUnit.id).length);
    return true;
  };

  // Periodic background sync (every 60 seconds)
  setInterval(() => {
    // Only pull from cloud if we're not in read-only mode and no pending changes
    if (boot.cloudLoaded && !sync.isReadOnly && !sync.pendingChanges) {
      syncFromCloud().catch(() => console.log('📴 Background sync skipped - offline'));
    }
  }, 60000);

  // Start Sync Engine v2.0 heartbeat for multi-device awareness
  if (typeof startHeartbeat === 'function') {
    startHeartbeat();
  }

  // ═══════════════════════════════════════════════════════════════════
  // SHOW DASHBOARD - Ensure the dashboard page is visible
  // ═══════════════════════════════════════════════════════════════════
  showPage('dashboard');
  console.log('✅ Dashboard initialized and displayed');
  
  // ═══════════════════════════════════════════════════════════════════
  // LIFECYCLE EVENTS - Ensure data is saved on app close/background
  // ═══════════════════════════════════════════════════════════════════
  
  // Save when leaving page
  window.addEventListener('beforeunload', () => {
    // Only save if boot allows writes and there are pending changes
    if (boot.allowLocalWrites && (sync.pendingChanges || sync.patchQueue.length > 0)) {
      saveLocalNow(); // Force immediate save
    }
  });
  
  // Save when app goes to background (mobile)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      // Going to background - save locally immediately (if allowed)
      if (boot.allowLocalWrites) {
        saveLocalNow();
      }
      
      // ═══════════════════════════════════════════════════════════════════
      // CRITICAL: Only send beacon if cloud boot completed successfully
      // This prevents zombie cache from wiping server data
      // ═══════════════════════════════════════════════════════════════════
      if (!boot.cloudLoaded) {
        console.warn('⛔ Beacon blocked: Cloud-first boot not complete');
        return;
      }
      
      if (sync.isReadOnly) {
        console.warn('⛔ Beacon blocked: App is in read-only mode');
        return;
      }
      
      // Try to flush patch queue to cloud
      if (sync.patchQueue.length > 0 && navigator.sendBeacon && state.settings.apiUrl) {
        // Use sendBeacon for reliable background send
        const payload = JSON.stringify({
          action: 'patches',
          username: AUTH.user,
          password: AUTH.pass,
          patches: sync.patchQueue.map(p => ({ operation: p.operation, payload: p.payload }))
        });
        navigator.sendBeacon(state.settings.apiUrl, payload);
        console.log('📤 Beacon sent with', sync.patchQueue.length, 'patches');
      }
    }
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// LOCAL-FIRST SAVE FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════

// Load local cache ONLY for instant display - cloud will overwrite this
// Returns the number of patients loaded (for logging)
function loadLocalCacheForDisplay() {
  // ═══════════════════════════════════════════════════════════════════
  // CLOUD-FIRST: Only read local if explicitly allowed (cloud failed/timed out)
  // ═══════════════════════════════════════════════════════════════════
  if (!boot.allowLocalReads) {
    console.log('⏳ loadLocalCacheForDisplay blocked: Cloud-first boot in progress');
    return 0;
  }
  
  const localCache = localStorage.getItem(CONFIG.CACHE_KEY);
  if (localCache) {
    try {
      const cached = JSON.parse(localCache);
      state.patients = cached.patients || [];
      state.units = cached.units || [];
      state.trash = cached.trash || { patients: [], units: [] };
      console.log('⚡ Loaded from local cache (fallback mode):', state.patients.length, 'patients');
      return state.patients.length;
    } catch (e) {
      console.warn('⚠️ Cache parse error, starting fresh');
      return 0;
    }
  }
  return 0;
}

// Save to local cache immediately (optimistic UI)
function saveLocalCache() {
  // Use the deferred save to prevent UI blocking
  saveLocalDeferred();
}

// Optimistic save: Local first, then cloud (non-blocking)
function saveOptimistic() {
  // 1. Save lite meta immediately (instant, non-blocking)
  saveLocalLite();
  
  // 2. Schedule full local save for idle time
  saveLocalDeferred();
  
  // 3. Mark dirty to trigger cloud sync
  markDirty();
}

// Check and apply saved login - returns true if login was restored
function checkSavedLogin() {
  try {
    const saved = localStorage.getItem('MEDWARD_SAVED_LOGIN');
    if (!saved) return false;

    const login = JSON.parse(saved);

    // Expire after 30 days
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;
    if (Date.now() - login.timestamp > thirtyDays) {
      localStorage.removeItem('MEDWARD_SAVED_LOGIN');
      return false;
    }

    const unit = getUnit(login.unitId);
    if (!unit) return false;

    // Set up state immediately
    state.currentUnit = unit;
    state.currentUser = { name: login.userName, role: login.userRole };
    
    // Show dashboard immediately
    showPage('dashboard');
    $('unitBadge').textContent = state.currentUnit.name;
    $('dashAvatar').textContent = initials(state.currentUser.name);
    $('currentDate').textContent = formatDate();
    
    // Show welcome toast after a brief delay
    setTimeout(() => toast(`Welcome back, ${state.currentUser.name}!`), 500);
    
    return true;
  } catch (e) {
    console.error('Saved login check failed:', e);
    return false;
  }
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();

})();
</script>

<!-- Conflict Resolution Modal (Sync Engine v2.0) -->
<div class="conflict-modal" id="conflictModal">
  <div class="conflict-content">
    <div class="conflict-header">
      <div class="conflict-icon">⚠️</div>
      <h3 class="conflict-title">Sync Conflict Detected</h3>
      <p class="conflict-subtitle">Another device modified this data</p>
    </div>
    
    <div class="conflict-body">
      <div class="conflict-device-info">
        <div class="device-name" id="conflictDeviceName">Unknown Device</div>
        <div class="device-time" id="conflictDeviceTime">Modified just now</div>
      </div>
      
      <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
        How would you like to resolve this conflict?
      </p>
      
      <div class="conflict-actions">
        <button class="conflict-btn primary" onclick="resolveConflict('server')">
          🔄 Use Server Version
          <br><small style="font-weight:400">Discard my local changes</small>
        </button>
        
        <button class="conflict-btn secondary" onclick="resolveConflict('merge')">
          🔀 Merge Changes
          <br><small style="font-weight:400">Try to combine both versions</small>
        </button>
        
        <button class="conflict-btn danger" onclick="resolveConflict('client')">
          ⬆️ Force My Version
          <br><small style="font-weight:400">Overwrite server data</small>
        </button>
      </div>
    </div>
  </div>
</div>

<script src="monitor.js"></script>
<script>
// ═══════════════════════════════════════════════════════════════════
// MONITORING INTEGRATION (System Monitor)
// ═══════════════════════════════════════════════════════════════════

// Expose MedWard functions for monitor.html testing
window.MedWard = window.MedWard || {};

// Sync wrapper with monitoring
window.MedWard.syncNow = async function ({ correlationId, source } = {}) {
  const id = correlationId || (crypto.randomUUID?.() || Math.random().toString(16).slice(2));
  window.monitor?.emit("SYNC", "INFO", "syncNow:start", { id, source });

  const t0 = performance.now();
  try {
    // Call the existing sync function
    await loadFromCloud(true);
    const ms = Math.round(performance.now() - t0);
    window.monitor?.emit("SYNC", "SUCCESS", "syncNow:done", { id, ms, source });
    return { success: true, ms };
  } catch (e) {
    const ms = Math.round(performance.now() - t0);
    window.monitor?.emit("SYNC", "ERROR", "syncNow:fail", {
      id, ms, source,
      message: e?.message || String(e),
      stack: e?.stack || null
    });
    throw e;
  }
};

// Save patient wrapper with monitoring
window.MedWard.savePatient = async function(patient, { correlationId, source } = {}) {
  const id = correlationId || (crypto.randomUUID?.() || Math.random().toString(16).slice(2));
  window.monitor?.emit("STORE", "INFO", "savePatient:start", {
    id, source,
    name: patient?.name,
    location: patient?.location,
    isMonitorTest: patient?._monitor
  });

  const t0 = performance.now();
  try {
    // Skip adding test patients from monitor to actual patient list
    if (!patient?._monitor) {
      // Add patient to state
      const newPatient = {
        id: uid(),
        unitId: state.currentUnit?.id || null,
        ...patient,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      state.patients.push(newPatient);
      markDirty();
      renderDashboard();
    }

    const ms = Math.round(performance.now() - t0);
    window.monitor?.emit("STORE", "SUCCESS", "savePatient:done", { id, ms, source });
    return { success: true, ms };
  } catch (e) {
    const ms = Math.round(performance.now() - t0);
    window.monitor?.emit("STORE", "ERROR", "savePatient:fail", {
      id, ms, source,
      message: e?.message || String(e)
    });
    throw e;
  }
};

// Delete test patient wrapper
window.MedWard.deleteTestPatient = async function({ correlationId, source } = {}) {
  const id = correlationId || (crypto.randomUUID?.() || Math.random().toString(16).slice(2));
  window.monitor?.emit("STORE", "INFO", "deleteTestPatient:start", { id, source });

  const t0 = performance.now();
  try {
    // Find and remove test patients
    const before = state.patients.length;
    state.patients = state.patients.filter(p => !p._monitor);
    const after = state.patients.length;
    const deleted = before - after;

    if (deleted > 0) {
      markDirty();
      renderDashboard();
    }

    const ms = Math.round(performance.now() - t0);
    window.monitor?.emit("STORE", "SUCCESS", "deleteTestPatient:done", { id, ms, deleted, source });
    return { success: true, deleted, ms };
  } catch (e) {
    const ms = Math.round(performance.now() - t0);
    window.monitor?.emit("STORE", "ERROR", "deleteTestPatient:fail", {
      id, ms, source,
      message: e?.message || String(e)
    });
    throw e;
  }
};

// Instrument critical operations
if (window.monitor) {
  // Wrap existing sync/save operations to emit events
  const originalMarkDirty = window.markDirty;
  if (originalMarkDirty) {
    window.markDirty = function() {
      window.monitor.emit("STORE", "INFO", "Data marked dirty (pending sync)");
      return originalMarkDirty.apply(this, arguments);
    };
  }

  // Log when app is ready
  window.monitor.emit("APP", "SUCCESS", "MedWard dashboard initialized", {
    unit: state.currentUnit?.name,
    user: state.currentUser?.name,
    patients: state.patients?.length || 0
  });
}

// Add "Open Monitor" button to settings or nav
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', addMonitorButton);
} else {
  addMonitorButton();
}

function addMonitorButton() {
  // Try to find a good place to add the button
  // This will add a floating action button in the bottom right
  const btn = document.createElement('button');
  btn.innerHTML = '📊';
  btn.title = 'Open System Monitor';
  btn.style.cssText = `
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: 2px solid rgba(255,255,255,0.2);
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 9999;
    transition: all 0.3s ease;
  `;

  btn.addEventListener('mouseenter', () => {
    btn.style.transform = 'scale(1.1)';
    btn.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';
  });

  btn.addEventListener('mouseleave', () => {
    btn.style.transform = 'scale(1)';
    btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
  });

  btn.addEventListener('click', () => {
    window.open('monitor.html', '_blank', 'width=1400,height=900');
  });

  document.body.appendChild(btn);
}
</script>

<script src="error-analyzer.js"></script>
<script src="medward-tour.js"></script>
</body>
</html>
