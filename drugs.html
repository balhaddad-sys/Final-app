<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#030712">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>MedWard Drug Reference</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #030712;
  --bg-card: #0d1320;
  --bg-elevated: #151d2e;
  --bg-hover: #1a2438;
  --text: #f9fafb;
  --text-secondary: #9ca3af;
  --text-muted: #6b7280;
  --gold: #f59e0b;
  --gold-dim: rgba(245,158,11,0.15);
  --purple: #8b5cf6;
  --purple-dim: rgba(139,92,246,0.15);
  --blue: #3b82f6;
  --rose: #f43f5e;
  --emerald: #10b981;
  --teal: #14b8a6;
  --border: rgba(255,255,255,0.06);
  --border-light: rgba(255,255,255,0.1);
  --radius: 20px;
  --radius-md: 14px;
  --radius-sm: 10px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }

/* Container */
.app {
  max-width: 600px;
  margin: 0 auto;
  padding: 16px;
  padding-bottom: 100px;
}

/* Header */
.header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0 20px;
}

.back-btn {
  width: 44px;
  height: 44px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 1.1rem;
  display: grid;
  place-items: center;
  text-decoration: none;
  transition: all 0.2s;
}
.back-btn:hover { border-color: var(--gold); }

.header-center {
  flex: 1;
  text-align: center;
}
.header-center h1 {
  font-size: 1.3rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--gold), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-center p {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 2px;
}

.config-btn {
  width: 44px;
  height: 44px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.2s;
}
.config-btn:hover { border-color: var(--purple); color: var(--purple); }
.config-btn.active { border-color: var(--emerald); color: var(--emerald); }

/* Search Box */
.search-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}

.search-row {
  display: flex;
  gap: 12px;
}

.search-input {
  flex: 1;
  padding: 16px 20px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text);
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.2s;
}
.search-input:focus {
  outline: none;
  border-color: var(--purple);
  box-shadow: 0 0 0 3px var(--purple-dim);
}
.search-input::placeholder { color: var(--text-muted); }

.search-btn {
  padding: 16px 28px;
  background: linear-gradient(135deg, var(--purple), var(--blue));
  border: none;
  border-radius: var(--radius-md);
  color: white;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.search-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(139,92,246,0.4); }
.search-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Section Headers */
.section-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 14px;
}
.section-header h2 {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--gold);
  letter-spacing: 0.02em;
}
.section-line {
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, var(--border-light), transparent);
}

/* Drug Chips */
.chips-container {
  margin-bottom: 24px;
}
.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.chip {
  padding: 12px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 25px;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}
.chip:hover {
  background: var(--purple-dim);
  border-color: var(--purple);
  color: var(--purple);
  transform: translateY(-2px);
}

/* Protocol Cards */
.protocols-container {
  margin-bottom: 24px;
}
.protocols-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.protocol-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 18px;
  cursor: pointer;
  transition: all 0.25s;
  position: relative;
  overflow: hidden;
}
.protocol-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--gold), var(--purple));
  opacity: 0;
  transition: opacity 0.2s;
}
.protocol-card:hover {
  border-color: var(--gold);
  transform: translateY(-3px);
  box-shadow: var(--shadow);
}
.protocol-card:hover::before { opacity: 1; }
.protocol-icon {
  font-size: 1.8rem;
  margin-bottom: 10px;
}
.protocol-title {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 4px;
}
.protocol-desc {
  font-size: 0.72rem;
  color: var(--text-muted);
  line-height: 1.4;
}

/* Results Area */
.results-container {
  min-height: 100px;
}

.result-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
}
.result-header {
  padding: 20px;
  background: linear-gradient(135deg, var(--purple-dim), rgba(59,130,246,0.08));
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 16px;
}
.result-icon {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, var(--purple), var(--blue));
  border-radius: 16px;
  display: grid;
  place-items: center;
  font-size: 1.8rem;
  flex-shrink: 0;
}
.result-info h3 {
  font-size: 1.2rem;
  font-weight: 800;
}
.result-info p {
  font-size: 0.75rem;
  color: var(--purple);
  margin-top: 2px;
}
.result-body {
  padding: 20px;
  font-size: 0.88rem;
  line-height: 1.8;
  color: var(--text-secondary);
}
.result-body h4 {
  color: var(--gold);
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  margin: 20px 0 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}
.result-body h4:first-child { margin-top: 0; }
.result-body ul {
  margin: 10px 0;
  padding-left: 20px;
}
.result-body li { margin-bottom: 8px; }
.result-body strong { color: var(--text); }
.result-body code {
  background: var(--bg);
  padding: 3px 8px;
  border-radius: 6px;
  font-family: 'SF Mono', monospace;
  font-size: 0.82rem;
  color: var(--teal);
}

.disclaimer {
  text-align: center;
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-top: 16px;
  padding: 12px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 50px 20px;
}
.empty-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.8;
}
.empty-state h3 {
  font-size: 1.1rem;
  margin-bottom: 8px;
}
.empty-state p {
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* Loading */
.loading {
  text-align: center;
  padding: 60px 20px;
}
.spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--purple);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading p {
  color: var(--text-muted);
  font-size: 0.9rem;
}

/* Error */
.error-card {
  background: rgba(244,63,94,0.08);
  border: 1px solid rgba(244,63,94,0.3);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
}
.error-card h3 {
  color: var(--rose);
  font-size: 1rem;
  margin-bottom: 8px;
}
.error-card p {
  color: var(--text-muted);
  font-size: 0.85rem;
}

/* AI FAB */
.ai-fab {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, var(--purple), var(--blue));
  border: none;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 4px 24px rgba(139,92,246,0.5);
  display: grid;
  place-items: center;
  font-size: 1.6rem;
  z-index: 50;
  transition: all 0.3s;
}
.ai-fab:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 32px rgba(139,92,246,0.6);
}

/* Modals */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(4px);
}
.modal.active { display: flex; }

.modal-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 100%;
  max-width: 420px;
  overflow: hidden;
  animation: modalIn 0.25s ease;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 14px;
}
.modal-header h3 {
  flex: 1;
  font-size: 1.1rem;
  font-weight: 700;
}
.modal-close {
  width: 36px;
  height: 36px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-muted);
  font-size: 1.1rem;
  cursor: pointer;
  display: grid;
  place-items: center;
  transition: all 0.2s;
}
.modal-close:hover { border-color: var(--rose); color: var(--rose); }

.modal-body { padding: 24px; }

.form-group { margin-bottom: 20px; }
.form-label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.form-input {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'SF Mono', monospace;
  font-size: 0.85rem;
}
.form-input:focus {
  outline: none;
  border-color: var(--purple);
}
.form-hint {
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-top: 8px;
  line-height: 1.5;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-bottom: 20px;
}
.status-badge.ok {
  background: rgba(16,185,129,0.1);
  color: var(--emerald);
}
.status-badge.no {
  background: rgba(244,63,94,0.1);
  color: var(--rose);
}

.btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: linear-gradient(135deg, var(--purple), var(--blue));
  color: white;
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(139,92,246,0.4); }

/* Chat Modal */
.chat-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.chat-modal.active { display: flex; }

.chat-box {
  width: 100%;
  max-width: 500px;
  max-height: 85vh;
  background: var(--bg-card);
  border-radius: var(--radius) var(--radius) 0 0;
  display: flex;
  flex-direction: column;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } }

.chat-header {
  padding: 18px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 14px;
}
.chat-avatar {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--purple), var(--blue));
  border-radius: 12px;
  display: grid;
  place-items: center;
  font-size: 1.3rem;
}
.chat-header-info { flex: 1; }
.chat-header-info h3 { font-size: 1rem; font-weight: 700; }
.chat-header-info p { font-size: 0.72rem; color: var(--text-muted); }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  min-height: 200px;
  max-height: 55vh;
}
.msg {
  margin-bottom: 16px;
  display: flex;
  gap: 12px;
}
.msg.user { flex-direction: row-reverse; }
.msg-avatar {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: grid;
  place-items: center;
  font-size: 0.9rem;
  flex-shrink: 0;
}
.msg.assistant .msg-avatar { background: linear-gradient(135deg, var(--purple), var(--blue)); }
.msg.user .msg-avatar { background: linear-gradient(135deg, var(--gold), #f97316); }
.msg-content {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 0.88rem;
  line-height: 1.6;
}
.msg.assistant .msg-content {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-top-left-radius: 4px;
}
.msg.user .msg-content {
  background: var(--gold-dim);
  border: 1px solid rgba(245,158,11,0.3);
  border-top-right-radius: 4px;
}
.msg-content h4 { color: var(--gold); font-size: 0.75rem; margin: 10px 0 6px; }
.msg-content ul { margin: 6px 0; padding-left: 18px; font-size: 0.82rem; }
.msg-content li { margin-bottom: 4px; }

.typing {
  display: flex;
  gap: 5px;
  padding: 8px 0;
}
.typing span {
  width: 8px;
  height: 8px;
  background: var(--purple);
  border-radius: 50%;
  animation: bounce 1.4s infinite;
}
.typing span:nth-child(2) { animation-delay: 0.2s; }
.typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-8px); }
}

.chat-input-area {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
}
.chat-input {
  flex: 1;
  padding: 14px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 0.9rem;
  font-family: inherit;
  resize: none;
}
.chat-input:focus { outline: none; border-color: var(--purple); }
.chat-send {
  padding: 14px 24px;
  background: linear-gradient(135deg, var(--purple), var(--blue));
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-weight: 700;
  cursor: pointer;
}
.chat-send:disabled { opacity: 0.5; }

/* Toast */
.toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(30px);
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 0.88rem;
  font-weight: 500;
  opacity: 0;
  transition: all 0.3s;
  z-index: 300;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.error { border-color: var(--rose); color: var(--rose); }

/* Responsive */
@media (max-width: 480px) {
  .protocols-grid { grid-template-columns: 1fr; }
  .search-row { flex-direction: column; }
  .search-btn { width: 100%; }
}
@media (min-width: 601px) {
  .chat-modal { align-items: center; padding: 20px; }
  .chat-box { border-radius: var(--radius); max-height: 75vh; }
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <div class="header">
    <a href="https://balhaddad-sys.github.io/Final-app/index.html" class="back-btn">â†</a>
    <div class="header-center">
      <h1>ğŸ’Š Drug Reference</h1>
      <p>AI-Powered Clinical Information</p>
    </div>
    <button class="config-btn" id="configBtn" onclick="openConfig()">âš™ï¸</button>
  </div>

  <!-- Search -->
  <div class="search-card">
    <div class="search-row">
      <input type="text" class="search-input" id="searchInput" placeholder="Search any medication..." onkeydown="if(event.key==='Enter')search()">
      <button class="search-btn" id="searchBtn" onclick="search()">Search</button>
    </div>
  </div>

  <!-- Common Medications -->
  <div class="chips-container">
    <div class="section-header">
      <h2>ğŸ’Š Common Medications</h2>
      <div class="section-line"></div>
    </div>
    <div class="chips">
      <div class="chip" onclick="quickSearch('Metformin')">Metformin</div>
      <div class="chip" onclick="quickSearch('Lisinopril')">Lisinopril</div>
      <div class="chip" onclick="quickSearch('Amlodipine')">Amlodipine</div>
      <div class="chip" onclick="quickSearch('Atorvastatin')">Atorvastatin</div>
      <div class="chip" onclick="quickSearch('Omeprazole')">Omeprazole</div>
      <div class="chip" onclick="quickSearch('Metoprolol')">Metoprolol</div>
      <div class="chip" onclick="quickSearch('Furosemide')">Furosemide</div>
      <div class="chip" onclick="quickSearch('Warfarin')">Warfarin</div>
      <div class="chip" onclick="quickSearch('Insulin')">Insulin</div>
      <div class="chip" onclick="quickSearch('Heparin')">Heparin</div>
      <div class="chip" onclick="quickSearch('Aspirin')">Aspirin</div>
      <div class="chip" onclick="quickSearch('Amoxicillin')">Amoxicillin</div>
    </div>
  </div>

  <!-- Quick Protocols -->
  <div class="protocols-container">
    <div class="section-header">
      <h2>âš¡ Quick Protocols</h2>
      <div class="section-line"></div>
    </div>
    <div class="protocols-grid">
      <div class="protocol-card" onclick="quickSearch('Hyperkalemia emergency treatment protocol')">
        <div class="protocol-icon">âš¡</div>
        <div class="protocol-title">Hyperkalemia</div>
        <div class="protocol-desc">Calcium gluconate, Insulin + D50, Kayexalate protocols</div>
      </div>
      <div class="protocol-card" onclick="quickSearch('Anticoagulation reversal warfarin heparin DOAC')">
        <div class="protocol-icon">ğŸ©¸</div>
        <div class="protocol-title">Anticoag Reversal</div>
        <div class="protocol-desc">Warfarin, Heparin, DOAC reversal agents</div>
      </div>
      <div class="protocol-card" onclick="quickSearch('Insulin sliding scale and DKA management protocol')">
        <div class="protocol-icon">ğŸ’‰</div>
        <div class="protocol-title">Insulin Protocols</div>
        <div class="protocol-desc">Sliding scale, DKA, correction factors</div>
      </div>
      <div class="protocol-card" onclick="quickSearch('Renal dose adjustments common medications CKD dialysis')">
        <div class="protocol-icon">ğŸ«˜</div>
        <div class="protocol-title">Renal Dosing</div>
        <div class="protocol-desc">CKD & dialysis dose adjustments</div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-container" id="results">
    <div class="empty-state">
      <div class="empty-icon">ğŸ”¬</div>
      <h3>Search for a Medication</h3>
      <p>Tap any drug above or type in the search box to get AI-powered clinical information</p>
    </div>
  </div>
</div>

<!-- AI FAB -->
<button class="ai-fab" onclick="openChat()">ğŸ¤–</button>

<!-- Config Modal -->
<div class="modal" id="configModal" onclick="if(event.target===this)closeConfig()">
  <div class="modal-box">
    <div class="modal-header">
      <h3>âš™ï¸ API Configuration</h3>
      <button class="modal-close" onclick="closeConfig()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="status-badge" id="apiStatus"></div>
      
      <div class="form-group">
        <label class="form-label">Google Apps Script URL</label>
        <input type="text" class="form-input" id="apiUrlInput" placeholder="https://script.google.com/macros/s/.../exec">
        <p class="form-hint">Deploy DrugCode.gs as a Web App and paste the URL here. The URL is stored locally on your device.</p>
      </div>
      
      <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div class="chat-modal" id="chatModal" onclick="if(event.target===this)closeChat()">
  <div class="chat-box">
    <div class="chat-header">
      <div class="chat-avatar">ğŸ¤–</div>
      <div class="chat-header-info">
        <h3>Ask Claude AI</h3>
        <p>Clinical pharmacology assistant</p>
      </div>
      <button class="modal-close" onclick="closeChat()">âœ•</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="msg assistant">
        <div class="msg-avatar">ğŸ¤–</div>
        <div class="msg-content">Hi! I can help with drug information, dosing, interactions, and clinical pharmacology questions. What would you like to know?</div>
      </div>
    </div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" placeholder="Ask a question..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button class="chat-send" id="chatSendBtn" onclick="sendChat()">Send</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const STORAGE_KEY = 'medward_drug_api_v2';
const MEDWARD_STORAGE_KEY = 'medward_pro_v12';
let apiUrl = '';
let chatHistory = [];
let isLoading = false;

const $ = id => document.getElementById(id);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function init() {
  // First try to get API from main MedWard app
  const medwardData = localStorage.getItem(MEDWARD_STORAGE_KEY);
  if (medwardData) {
    try {
      const data = JSON.parse(medwardData);
      if (data.settings && data.settings.apiUrl) {
        apiUrl = data.settings.apiUrl;
        console.log('Using MedWard API:', apiUrl);
      }
    } catch(e) {}
  }
  
  // Fallback to drug-specific storage
  if (!apiUrl) {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        const data = JSON.parse(saved);
        apiUrl = data.apiUrl || '';
      } catch(e) {}
    }
  }
  
  updateStatus();
}

function updateStatus() {
  const btn = $('configBtn');
  const status = $('apiStatus');
  
  if (apiUrl) {
    btn.classList.add('active');
    if (status) {
      status.className = 'status-badge ok';
      status.innerHTML = 'âœ“ API Connected';
    }
  } else {
    btn.classList.remove('active');
    if (status) {
      status.className = 'status-badge no';
      status.innerHTML = 'âš  Not Configured';
    }
  }
  
  if ($('apiUrlInput')) $('apiUrlInput').value = apiUrl;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openConfig() {
  $('configModal').classList.add('active');
  $('apiUrlInput').value = apiUrl;
  updateStatus();
}

function closeConfig() {
  $('configModal').classList.remove('active');
}

function saveConfig() {
  const url = $('apiUrlInput').value.trim();
  
  if (!url) {
    toast('Please enter API URL', true);
    return;
  }
  
  if (!url.startsWith('https://')) {
    toast('URL must start with https://', true);
    return;
  }
  
  apiUrl = url;
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ apiUrl }));
  updateStatus();
  closeConfig();
  toast('Configuration saved!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function quickSearch(query) {
  $('searchInput').value = query;
  search();
}

async function search() {
  const query = $('searchInput').value.trim();
  if (!query) return;
  
  if (!apiUrl) {
    openConfig();
    toast('Please configure API first', true);
    return;
  }
  
  const results = $('results');
  results.innerHTML = `<div class="loading"><div class="spinner"></div><p>Searching for "${esc(query)}"...</p></div>`;
  $('searchBtn').disabled = true;
  
  try {
    console.log('Sending drugQuery to:', apiUrl);
    console.log('Query:', query);
    
    const response = await fetch(apiUrl, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'drugQuery', query: query })
    });
    
    const data = await response.json();
    
    if (data.error) throw new Error(data.error);
    
    results.innerHTML = `
      <div class="result-card">
        <div class="result-header">
          <div class="result-icon">ğŸ’Š</div>
          <div class="result-info">
            <h3>${esc(query)}</h3>
            <p>AI-Generated Clinical Information</p>
          </div>
        </div>
        <div class="result-body">${data.content}</div>
      </div>
      <p class="disclaimer">âš ï¸ Always verify with official references. This is AI-generated content for educational purposes.</p>
    `;
    
  } catch(e) {
    results.innerHTML = `
      <div class="error-card">
        <h3>âš ï¸ Error</h3>
        <p>${esc(e.message)}</p>
      </div>
    `;
  } finally {
    $('searchBtn').disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openChat() {
  if (!apiUrl) {
    openConfig();
    toast('Please configure API first', true);
    return;
  }
  $('chatModal').classList.add('active');
}

function closeChat() {
  $('chatModal').classList.remove('active');
}

async function sendChat() {
  const input = $('chatInput');
  const msg = input.value.trim();
  
  if (!msg || isLoading) return;
  
  isLoading = true;
  $('chatSendBtn').disabled = true;
  input.value = '';
  
  addMsg('user', msg);
  const loadingId = addLoading();
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action: 'drugChat', 
        message: msg,
        history: chatHistory.slice(-10)
      })
    });
    
    const data = await response.json();
    removeMsg(loadingId);
    
    if (data.error) {
      addMsg('assistant', `<span style="color:var(--rose)">Error: ${esc(data.error)}</span>`);
    } else {
      addMsg('assistant', data.content);
      chatHistory.push({ role: 'user', content: msg });
      chatHistory.push({ role: 'assistant', content: data.content });
    }
    
  } catch(e) {
    removeMsg(loadingId);
    addMsg('assistant', `<span style="color:var(--rose)">Error: ${esc(e.message)}</span>`);
  } finally {
    isLoading = false;
    $('chatSendBtn').disabled = false;
  }
}

function addMsg(role, content) {
  const container = $('chatMessages');
  const id = 'msg_' + Date.now();
  const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
  const html = role === 'assistant' ? content : esc(content);
  
  container.insertAdjacentHTML('beforeend', `
    <div class="msg ${role}" id="${id}">
      <div class="msg-avatar">${avatar}</div>
      <div class="msg-content">${html}</div>
    </div>
  `);
  container.scrollTop = container.scrollHeight;
  return id;
}

function addLoading() {
  const container = $('chatMessages');
  const id = 'loading_' + Date.now();
  container.insertAdjacentHTML('beforeend', `
    <div class="msg assistant" id="${id}">
      <div class="msg-avatar">ğŸ¤–</div>
      <div class="msg-content"><div class="typing"><span></span><span></span><span></span></div></div>
    </div>
  `);
  container.scrollTop = container.scrollHeight;
  return id;
}

function removeMsg(id) {
  const el = $(id);
  if (el) el.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function esc(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function toast(msg, isError) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

// Init
init();
</script>

</body>
</html>
