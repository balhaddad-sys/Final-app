<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#0a0a0f">
<title>MedWard Drug Reference</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--bg-card:#12121a;--bg-elevated:#1a1a24;--bg-input:#0e0e14;--text:#fff;--text-secondary:#a0a0b0;--text-muted:#606070;--accent:#6366f1;--accent-glow:rgba(99,102,241,0.25);--gold:#f59e0b;--emerald:#10b981;--rose:#f43f5e;--cyan:#06b6d4;--border:rgba(255,255,255,0.06);--gradient-1:linear-gradient(135deg,#6366f1,#8b5cf6);--gradient-2:linear-gradient(135deg,#f59e0b,#f97316);--radius:16px;--radius-lg:24px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.app{max-width:800px;margin:0 auto;padding:12px;padding-bottom:100px}
.header{display:flex;align-items:center;padding:12px 0;gap:12px}
.back-btn{width:40px;height:40px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:1.1rem;display:grid;place-items:center;text-decoration:none}
.logo{flex:1;display:flex;align-items:center;gap:10px}
.logo-icon{width:40px;height:40px;background:var(--gradient-1);border-radius:12px;display:grid;place-items:center;font-size:1.2rem}
.logo h1{font-size:1rem;font-weight:800}.logo p{font-size:0.6rem;color:var(--text-muted)}
.settings-btn{width:40px;height:40px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;color:var(--text-muted);font-size:1rem;cursor:pointer}
.settings-btn.active{border-color:var(--emerald);color:var(--emerald)}
.hero{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-50%;right:-30%;width:250px;height:250px;background:radial-gradient(circle,var(--accent-glow) 0%,transparent 70%);pointer-events:none}
.search-row{display:flex;gap:10px;margin-bottom:14px;position:relative;z-index:1}
.search-wrap{flex:1;position:relative}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);opacity:0.4}
.search-input{width:100%;padding:14px 14px 14px 42px;background:var(--bg-input);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.95rem;font-family:inherit}
.search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.search-input::placeholder{color:var(--text-muted)}
.search-btn{padding:14px 24px;background:var(--gradient-1);border:none;border-radius:12px;color:white;font-weight:700;cursor:pointer}
.search-btn:disabled{opacity:0.5}
.quick-pills{display:flex;gap:8px;flex-wrap:wrap;position:relative;z-index:1}
.pill{padding:8px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:20px;font-size:0.72rem;font-weight:600;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:6px;transition:all 0.15s}
.pill:hover{border-color:var(--accent);color:var(--accent)}
.tabs{display:flex;gap:8px;overflow-x:auto;padding:8px 0;margin-bottom:12px}
.tab{padding:10px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-size:0.75rem;font-weight:600;color:var(--text-secondary);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:6px}
.tab.active{background:var(--gradient-1);border-color:transparent;color:white}
.section{margin-bottom:20px}
.section-title{font-size:0.8rem;font-weight:700;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.section-title span{color:var(--gold)}
.drug-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.drug-chip{padding:14px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:14px;text-align:center;cursor:pointer;transition:all 0.15s}
.drug-chip:hover{border-color:var(--accent);transform:translateY(-2px)}
.drug-chip .icon{font-size:1.4rem;margin-bottom:6px;display:block}
.drug-chip .name{font-size:0.7rem;font-weight:600}
.drug-chip .class{font-size:0.55rem;color:var(--text-muted);margin-top:2px}
.protocol-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.protocol-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;cursor:pointer;transition:all 0.15s;position:relative}
.protocol-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.protocol-card .badge{position:absolute;top:10px;right:10px;padding:3px 8px;background:rgba(244,63,94,0.2);border-radius:6px;font-size:0.55rem;font-weight:700;color:var(--rose)}
.protocol-card .icon{font-size:1.8rem;margin-bottom:8px}
.protocol-card h3{font-size:0.85rem;font-weight:700;margin-bottom:4px}
.protocol-card p{font-size:0.65rem;color:var(--text-muted);line-height:1.4}
.calc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.calc-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all 0.15s}
.calc-card:hover{border-color:var(--cyan)}
.calc-card .icon{font-size:1.3rem;margin-bottom:6px}
.calc-card .name{font-size:0.7rem;font-weight:600}
.results{min-height:100px}
.result-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:16px;animation:fadeIn 0.25s}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}}
.result-header{padding:18px;background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.05));border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px}
.result-icon{width:50px;height:50px;background:var(--gradient-1);border-radius:14px;display:grid;place-items:center;font-size:1.6rem}
.result-info{flex:1}.result-info h2{font-size:1.1rem;font-weight:800}.result-info p{font-size:0.7rem;color:var(--accent)}
.result-actions{display:flex;gap:8px}
.result-action{width:36px;height:36px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;display:grid;place-items:center;cursor:pointer;font-size:0.9rem}
.result-body{padding:18px}
.result-content{font-size:0.85rem;line-height:1.8;color:var(--text-secondary)}
.result-content h4{color:var(--gold);font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.04em;margin:18px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.result-content h4:first-child{margin-top:0}
.result-content ul{margin:8px 0;padding-left:18px}
.result-content li{margin-bottom:5px}
.result-content strong{color:var(--text)}
.result-content code{background:var(--bg-input);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:0.8rem;color:var(--cyan)}
.disclaimer{text-align:center;font-size:0.65rem;color:var(--text-muted);padding:14px;background:var(--bg-card);border-radius:10px;margin-top:12px}
.loading{text-align:center;padding:50px 20px}
.spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:var(--text-muted);font-size:0.85rem}
.error-card{background:rgba(244,63,94,0.08);border:1px solid rgba(244,63,94,0.3);border-radius:var(--radius);padding:24px;text-align:center}
.error-card h3{color:var(--rose);margin:8px 0}.error-card p{color:var(--text-muted);font-size:0.85rem}
.retry-btn{margin-top:14px;padding:10px 20px;background:var(--rose);border:none;border-radius:8px;color:white;font-weight:600;cursor:pointer}
.fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;background:var(--gradient-1);border:none;border-radius:50%;cursor:pointer;box-shadow:0 4px 20px var(--accent-glow);display:grid;place-items:center;font-size:1.4rem;z-index:50}
.fab:hover{transform:scale(1.08)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(6px)}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);width:100%;max-width:420px;overflow:hidden;animation:modalIn 0.2s}
@keyframes modalIn{from{opacity:0;transform:scale(0.95)}}
.modal-header{padding:18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.modal-header h3{flex:1;font-size:1rem}
.modal-close{width:34px;height:34px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;display:grid;place-items:center}
.modal-body{padding:18px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
.form-input{width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:monospace;font-size:0.8rem}
.form-input:focus{outline:none;border-color:var(--accent)}
.form-hint{font-size:0.65rem;color:var(--text-muted);margin-top:6px}
.status-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;font-size:0.75rem;font-weight:600;margin-bottom:14px}
.status-badge.ok{background:rgba(16,185,129,0.15);color:var(--emerald)}
.status-badge.no{background:rgba(244,63,94,0.15);color:var(--rose)}
.btn{width:100%;padding:14px;border:none;border-radius:10px;font-weight:700;cursor:pointer;background:var(--gradient-1);color:white}
.chat-modal{align-items:flex-end}
.chat-modal .modal-box{max-width:480px;max-height:80vh;border-radius:var(--radius-lg) var(--radius-lg) 0 0;display:flex;flex-direction:column}
.chat-messages{flex:1;overflow-y:auto;padding:14px;min-height:200px;max-height:50vh}
.msg{margin-bottom:12px;display:flex;gap:10px}
.msg.user{flex-direction:row-reverse}
.msg-avatar{width:30px;height:30px;border-radius:8px;display:grid;place-items:center;font-size:0.85rem}
.msg.assistant .msg-avatar{background:var(--gradient-1)}
.msg.user .msg-avatar{background:var(--gradient-2)}
.msg-bubble{max-width:80%;padding:10px 14px;border-radius:14px;font-size:0.85rem;line-height:1.6}
.msg.assistant .msg-bubble{background:var(--bg-elevated);border:1px solid var(--border)}
.msg.user .msg-bubble{background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.3)}
.typing{display:flex;gap:4px;padding:6px 0}
.typing span{width:7px;height:7px;background:var(--accent);border-radius:50%;animation:bounce 1.4s infinite}
.typing span:nth-child(2){animation-delay:0.2s}
.typing span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.chat-input-area{padding:14px;border-top:1px solid var(--border);display:flex;gap:10px}
.chat-input{flex:1;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.85rem;font-family:inherit;resize:none}
.chat-input:focus{outline:none;border-color:var(--accent)}
.chat-send{padding:12px 18px;background:var(--gradient-1);border:none;border-radius:10px;color:white;font-weight:700;cursor:pointer}
.chat-send:disabled{opacity:0.5}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg-elevated);border:1px solid var(--border);padding:12px 20px;border-radius:10px;font-size:0.85rem;opacity:0;transition:all 0.25s;z-index:300}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose);color:var(--rose)}
.toast.success{border-color:var(--emerald);color:var(--emerald)}
@media(max-width:500px){.drug-grid{grid-template-columns:repeat(3,1fr)}.protocol-grid,.calc-grid{grid-template-columns:1fr 1fr}.search-row{flex-direction:column}.search-btn{width:100%}}
@media(min-width:600px){.chat-modal{align-items:center}.chat-modal .modal-box{border-radius:var(--radius-lg)}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <a href="index.html" class="back-btn">‚Üê</a>
    <div class="logo"><div class="logo-icon">üíä</div><div><h1>Drug Reference</h1><p>AI Clinical Pharmacology</p></div></div>
    <button class="settings-btn" id="settingsBtn" onclick="openSettings()">‚öôÔ∏è</button>
  </div>
  <div class="hero">
    <div class="search-row">
      <div class="search-wrap"><span class="search-icon">üîç</span><input type="text" class="search-input" id="searchInput" placeholder="Search medications, protocols, interactions..." onkeydown="if(event.key==='Enter')search()"></div>
      <button class="search-btn" id="searchBtn" onclick="search()">Search</button>
    </div>
    <div class="quick-pills">
      <div class="pill" onclick="quickSearch('drug interactions')">‚ö° Interactions</div>
      <div class="pill" onclick="quickSearch('IV compatibility')">üíâ IV Compat</div>
      <div class="pill" onclick="quickSearch('pregnancy safe medications')">ü§∞ Pregnancy</div>
      <div class="pill" onclick="quickSearch('pediatric dosing')">üë∂ Pediatric</div>
      <div class="pill" onclick="quickSearch('geriatric dosing')">üë¥ Geriatric</div>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="showCat('all',this)">üìã All</div>
    <div class="tab" onclick="showCat('cardiac',this)">‚ù§Ô∏è Cardiac</div>
    <div class="tab" onclick="showCat('abx',this)">ü¶† Antibiotics</div>
    <div class="tab" onclick="showCat('dm',this)">üíâ Diabetes</div>
    <div class="tab" onclick="showCat('neuro',this)">üß† Neuro</div>
    <div class="tab" onclick="showCat('pain',this)">üíä Pain</div>
    <div class="tab" onclick="showCat('gi',this)">ü´Å GI</div>
  </div>
  <div class="section"><div class="section-title"><span>‚≠ê</span> Common Medications</div><div class="drug-grid" id="drugGrid"></div></div>
  <div class="section">
    <div class="section-title"><span>‚ö°</span> Emergency Protocols</div>
    <div class="protocol-grid">
      <div class="protocol-card" onclick="quickSearch('Hyperkalemia emergency treatment calcium gluconate insulin dextrose')"><div class="badge">CRITICAL</div><div class="icon">‚ö°</div><h3>Hyperkalemia</h3><p>Ca gluconate, Insulin+D50, Kayexalate</p></div>
      <div class="protocol-card" onclick="quickSearch('Anticoagulation reversal warfarin heparin DOAC')"><div class="icon">ü©∏</div><h3>Anticoag Reversal</h3><p>Warfarin, Heparin, DOAC reversal</p></div>
      <div class="protocol-card" onclick="quickSearch('DKA diabetic ketoacidosis protocol insulin fluids')"><div class="badge">CRITICAL</div><div class="icon">üíâ</div><h3>DKA Protocol</h3><p>Insulin, fluids, K+ replacement</p></div>
      <div class="protocol-card" onclick="quickSearch('Renal dose adjustments CKD GFR dialysis')"><div class="icon">ü´ò</div><h3>Renal Dosing</h3><p>CKD & dialysis adjustments</p></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title"><span>üßÆ</span> Quick Calculators</div>
    <div class="calc-grid">
      <div class="calc-card" onclick="quickSearch('Creatinine clearance CrCl Cockcroft-Gault')"><div class="icon">üß™</div><div class="name">CrCl</div></div>
      <div class="calc-card" onclick="quickSearch('Corrected calcium albumin formula')"><div class="icon">ü¶¥</div><div class="name">Corr Ca¬≤‚Å∫</div></div>
      <div class="calc-card" onclick="quickSearch('Anion gap calculation')"><div class="icon">‚öñÔ∏è</div><div class="name">Anion Gap</div></div>
      <div class="calc-card" onclick="quickSearch('Ideal body weight IBW')"><div class="icon">üìè</div><div class="name">IBW</div></div>
      <div class="calc-card" onclick="quickSearch('INR warfarin dose adjustment')"><div class="icon">ü©∏</div><div class="name">INR Adj</div></div>
      <div class="calc-card" onclick="quickSearch('Sodium correction hyponatremia')"><div class="icon">üíß</div><div class="name">Na‚Å∫ Corr</div></div>
    </div>
  </div>
  <div class="results" id="results"></div>
</div>
<button class="fab" onclick="openChat()">ü§ñ</button>
<div class="modal" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="modal-box">
    <div class="modal-header"><h3>‚öôÔ∏è Settings</h3><button class="modal-close" onclick="closeSettings()">‚úï</button></div>
    <div class="modal-body">
      <div class="status-badge" id="apiStatus"></div>
      <div class="form-group"><label class="form-label">API URL</label><input type="text" class="form-input" id="apiUrlInput" placeholder="https://script.google.com/..."><p class="form-hint">Your MedWard Google Apps Script URL</p></div>
      <button class="btn" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>
<div class="modal chat-modal" id="chatModal" onclick="if(event.target===this)closeChat()">
  <div class="modal-box">
    <div class="modal-header">
      <div style="width:36px;height:36px;background:var(--gradient-1);border-radius:10px;display:grid;place-items:center">ü§ñ</div>
      <div style="flex:1"><h3>PharmAssist AI</h3><p style="font-size:0.65rem;color:var(--text-muted)">Ask anything about medications</p></div>
      <button class="modal-close" onclick="closeChat()">‚úï</button>
    </div>
    <div class="chat-messages" id="chatMessages"><div class="msg assistant"><div class="msg-avatar">ü§ñ</div><div class="msg-bubble">Hi! Ask me about drug dosing, interactions, mechanisms, or protocols.</div></div></div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" placeholder="Ask about medications..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button class="chat-send" id="chatSendBtn" onclick="sendChat()">Send</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
const STORAGE_KEY='medward_drug_v3',MEDWARD_KEY='medward_pro_v12';
let apiUrl='',chatHistory=[],isLoading=false,lastQuery='';
const $=id=>document.getElementById(id);
const DRUGS={
  all:[{n:'Metformin',c:'Antidiabetic',i:'üíä'},{n:'Lisinopril',c:'ACE-I',i:'‚ù§Ô∏è'},{n:'Amlodipine',c:'CCB',i:'üíì'},{n:'Atorvastatin',c:'Statin',i:'ü©∏'},{n:'Omeprazole',c:'PPI',i:'ü´Å'},{n:'Metoprolol',c:'Œ≤-blocker',i:'üíó'},{n:'Furosemide',c:'Diuretic',i:'üíß'},{n:'Warfarin',c:'Anticoag',i:'ü©∏'},{n:'Aspirin',c:'Antiplatelet',i:'üíä'},{n:'Amoxicillin',c:'Antibiotic',i:'ü¶†'},{n:'Insulin',c:'Antidiabetic',i:'üíâ'},{n:'Heparin',c:'Anticoag',i:'ü©∏'}],
  cardiac:[{n:'Lisinopril',c:'ACE-I',i:'‚ù§Ô∏è'},{n:'Amlodipine',c:'CCB',i:'‚ù§Ô∏è'},{n:'Metoprolol',c:'Œ≤-blocker',i:'‚ù§Ô∏è'},{n:'Carvedilol',c:'Œ±/Œ≤-blocker',i:'‚ù§Ô∏è'},{n:'Digoxin',c:'Glycoside',i:'‚ù§Ô∏è'},{n:'Amiodarone',c:'Antiarrhythmic',i:'‚ù§Ô∏è'},{n:'Diltiazem',c:'CCB',i:'‚ù§Ô∏è'},{n:'Losartan',c:'ARB',i:'‚ù§Ô∏è'},{n:'Spironolactone',c:'MRA',i:'‚ù§Ô∏è'},{n:'Hydralazine',c:'Vasodilator',i:'‚ù§Ô∏è'},{n:'Isosorbide',c:'Nitrate',i:'‚ù§Ô∏è'},{n:'Nitroglycerin',c:'Nitrate',i:'‚ù§Ô∏è'}],
  abx:[{n:'Amoxicillin',c:'Penicillin',i:'ü¶†'},{n:'Azithromycin',c:'Macrolide',i:'ü¶†'},{n:'Ciprofloxacin',c:'Quinolone',i:'ü¶†'},{n:'Levofloxacin',c:'Quinolone',i:'ü¶†'},{n:'Ceftriaxone',c:'Cephalosporin',i:'ü¶†'},{n:'Vancomycin',c:'Glycopeptide',i:'ü¶†'},{n:'Piperacillin',c:'Penicillin',i:'ü¶†'},{n:'Meropenem',c:'Carbapenem',i:'ü¶†'},{n:'Doxycycline',c:'Tetracycline',i:'ü¶†'},{n:'Metronidazole',c:'Nitroimidazole',i:'ü¶†'},{n:'Clindamycin',c:'Lincosamide',i:'ü¶†'},{n:'TMP-SMX',c:'Sulfonamide',i:'ü¶†'}],
  dm:[{n:'Metformin',c:'Biguanide',i:'üíâ'},{n:'Glipizide',c:'Sulfonylurea',i:'üíâ'},{n:'Glyburide',c:'Sulfonylurea',i:'üíâ'},{n:'Sitagliptin',c:'DPP-4i',i:'üíâ'},{n:'Empagliflozin',c:'SGLT2i',i:'üíâ'},{n:'Liraglutide',c:'GLP-1',i:'üíâ'},{n:'Insulin Glargine',c:'Basal',i:'üíâ'},{n:'Insulin Lispro',c:'Rapid',i:'üíâ'},{n:'NPH Insulin',c:'Intermediate',i:'üíâ'},{n:'Pioglitazone',c:'TZD',i:'üíâ'},{n:'Canagliflozin',c:'SGLT2i',i:'üíâ'},{n:'Dulaglutide',c:'GLP-1',i:'üíâ'}],
  neuro:[{n:'Levetiracetam',c:'Antiepileptic',i:'üß†'},{n:'Phenytoin',c:'Antiepileptic',i:'üß†'},{n:'Valproate',c:'Antiepileptic',i:'üß†'},{n:'Carbamazepine',c:'Antiepileptic',i:'üß†'},{n:'Gabapentin',c:'Anticonvulsant',i:'üß†'},{n:'Pregabalin',c:'Anticonvulsant',i:'üß†'},{n:'Lamotrigine',c:'Antiepileptic',i:'üß†'},{n:'Topiramate',c:'Antiepileptic',i:'üß†'},{n:'Levodopa',c:'Antiparkinsonian',i:'üß†'},{n:'Donepezil',c:'AChE Inhibitor',i:'üß†'},{n:'Memantine',c:'NMDA Antagonist',i:'üß†'},{n:'Baclofen',c:'Muscle Relaxant',i:'üß†'}],
  pain:[{n:'Morphine',c:'Opioid',i:'üíä'},{n:'Hydromorphone',c:'Opioid',i:'üíä'},{n:'Fentanyl',c:'Opioid',i:'üíä'},{n:'Oxycodone',c:'Opioid',i:'üíä'},{n:'Tramadol',c:'Opioid',i:'üíä'},{n:'Acetaminophen',c:'Analgesic',i:'üíä'},{n:'Ibuprofen',c:'NSAID',i:'üíä'},{n:'Ketorolac',c:'NSAID',i:'üíä'},{n:'Naproxen',c:'NSAID',i:'üíä'},{n:'Celecoxib',c:'COX-2',i:'üíä'},{n:'Lidocaine',c:'Local',i:'üíä'},{n:'Ketamine',c:'Dissociative',i:'üíä'}],
  gi:[{n:'Omeprazole',c:'PPI',i:'ü´Å'},{n:'Pantoprazole',c:'PPI',i:'ü´Å'},{n:'Famotidine',c:'H2 Blocker',i:'ü´Å'},{n:'Ondansetron',c:'Antiemetic',i:'ü´Å'},{n:'Metoclopramide',c:'Prokinetic',i:'ü´Å'},{n:'Lactulose',c:'Laxative',i:'ü´Å'},{n:'PEG 3350',c:'Laxative',i:'ü´Å'},{n:'Sucralfate',c:'Mucosal',i:'ü´Å'},{n:'Dicyclomine',c:'Antispasmodic',i:'ü´Å'},{n:'Loperamide',c:'Antidiarrheal',i:'ü´Å'},{n:'Mesalamine',c:'Anti-inflam',i:'ü´Å'},{n:'Prochlorperazine',c:'Antiemetic',i:'ü´Å'}]
};
function init(){
  try{const m=localStorage.getItem(MEDWARD_KEY);if(m){const d=JSON.parse(m);if(d.settings?.apiUrl)apiUrl=d.settings.apiUrl}}catch(e){}
  if(!apiUrl)try{const d=localStorage.getItem(STORAGE_KEY);if(d)apiUrl=JSON.parse(d).apiUrl||''}catch(e){}
  updateStatus();showCat('all',document.querySelector('.tab.active'));
}
function updateStatus(){
  const btn=$('settingsBtn'),status=$('apiStatus');
  if(apiUrl){btn.classList.add('active');if(status){status.className='status-badge ok';status.innerHTML='‚úì Connected'}}
  else{btn.classList.remove('active');if(status){status.className='status-badge no';status.innerHTML='‚ö† Not Configured'}}
  if($('apiUrlInput'))$('apiUrlInput').value=apiUrl;
}
function openSettings(){$('settingsModal').classList.add('active');$('apiUrlInput').value=apiUrl;updateStatus()}
function closeSettings(){$('settingsModal').classList.remove('active')}
function saveSettings(){
  const url=$('apiUrlInput').value.trim();
  if(!url)return toast('Enter API URL','error');
  if(!url.startsWith('https://'))return toast('URL must start with https://','error');
  apiUrl=url;localStorage.setItem(STORAGE_KEY,JSON.stringify({apiUrl}));
  updateStatus();closeSettings();toast('Saved!','success');
}
function showCat(cat,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  const list=DRUGS[cat]||DRUGS.all;
  $('drugGrid').innerHTML=list.map(d=>`<div class="drug-chip" onclick="quickSearch('${d.n}')"><span class="icon">${d.i}</span><div class="name">${d.n}</div><div class="class">${d.c}</div></div>`).join('');
}
function quickSearch(q){$('searchInput').value=q;search()}
async function search(){
  const query=$('searchInput').value.trim();
  if(!query)return;
  if(!apiUrl){openSettings();return toast('Configure API first','error')}
  lastQuery=query;
  $('results').innerHTML=`<div class="loading"><div class="spinner"></div><p>Searching "${esc(query)}"...</p></div>`;
  $('searchBtn').disabled=true;
  try{
    const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'drugQuery',query})});
    const data=await res.json();
    if(data.error)throw new Error(data.error);
    if(!data.content)throw new Error('No content');
    $('results').innerHTML=`<div class="result-card"><div class="result-header"><div class="result-icon">üíä</div><div class="result-info"><h2>${esc(query)}</h2><p>AI Clinical Reference</p></div><div class="result-actions"><div class="result-action" onclick="copyResult()" title="Copy">üìã</div><div class="result-action" onclick="shareResult()" title="Share">üì§</div></div></div><div class="result-body"><div class="result-content">${data.content}</div></div></div><div class="disclaimer">‚ö†Ô∏è AI-generated. Verify with official references.</div>`;
  }catch(e){$('results').innerHTML=`<div class="error-card"><h3>‚ö†Ô∏è Error</h3><p>${esc(e.message)}</p><button class="retry-btn" onclick="search()">Retry</button></div>`}
  finally{$('searchBtn').disabled=false}
}
function copyResult(){const c=document.querySelector('.result-content');if(c){navigator.clipboard.writeText(c.innerText);toast('Copied!','success')}}
function shareResult(){if(navigator.share)navigator.share({title:'Drug: '+lastQuery,text:document.querySelector('.result-content')?.innerText||''});else copyResult()}
function openChat(){if(!apiUrl){openSettings();return toast('Configure API first','error')}$('chatModal').classList.add('active')}
function closeChat(){$('chatModal').classList.remove('active')}
async function sendChat(){
  const input=$('chatInput'),msg=input.value.trim();
  if(!msg||isLoading)return;
  isLoading=true;$('chatSendBtn').disabled=true;input.value='';
  addMsg('user',msg);const lid=addLoading();
  try{
    const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'drugChat',message:msg,history:chatHistory.slice(-10)})});
    const data=await res.json();
    removeMsg(lid);
    if(data.error)addMsg('assistant',`<span style="color:var(--rose)">Error: ${esc(data.error)}</span>`);
    else{addMsg('assistant',data.content);chatHistory.push({role:'user',content:msg},{role:'assistant',content:data.content})}
  }catch(e){removeMsg(lid);addMsg('assistant',`<span style="color:var(--rose)">Error: ${esc(e.message)}</span>`)}
  finally{isLoading=false;$('chatSendBtn').disabled=false}
}
function addMsg(role,content){
  const c=$('chatMessages'),id='msg_'+Date.now();
  c.insertAdjacentHTML('beforeend',`<div class="msg ${role}" id="${id}"><div class="msg-avatar">${role==='user'?'üë§':'ü§ñ'}</div><div class="msg-bubble">${role==='assistant'?content:esc(content)}</div></div>`);
  c.scrollTop=c.scrollHeight;return id;
}
function addLoading(){
  const c=$('chatMessages'),id='ld_'+Date.now();
  c.insertAdjacentHTML('beforeend',`<div class="msg assistant" id="${id}"><div class="msg-avatar">ü§ñ</div><div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>`);
  c.scrollTop=c.scrollHeight;return id;
}
function removeMsg(id){const e=$(id);if(e)e.remove()}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function toast(m,type){const t=$('toast');t.textContent=m;t.className='toast show'+(type?' '+type:'');setTimeout(()=>t.className='toast',3000)}
init();
</script>
</body>
</html>
