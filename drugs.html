<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#030712">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>MedWard Drug Reference</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#030712;--bg-card:#0a0f1a;--bg-elevated:#111827;--bg-hover:#1f2937;--text:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--gold:#f59e0b;--teal:#14b8a6;--purple:#8b5cf6;--rose:#f43f5e;--emerald:#10b981;--blue:#3b82f6;--orange:#f97316;--border:rgba(255,255,255,0.08);--border-light:rgba(255,255,255,0.12);--radius:16px;--radius-sm:10px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
.mono{font-family:'JetBrains Mono',monospace}

.container{max-width:800px;margin:0 auto;padding:16px;min-height:100vh}

/* Header */
.header{display:flex;align-items:center;gap:12px;padding:16px 0;margin-bottom:20px}
.back-btn{padding:10px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.85rem;text-decoration:none;display:flex;align-items:center;gap:6px;transition:all 0.2s}
.back-btn:hover{border-color:var(--gold);background:var(--bg-hover)}
.header-title{flex:1;text-align:center}
.header-title h1{font-size:1.25rem;font-weight:800;display:flex;align-items:center;justify-content:center;gap:8px}
.header-title p{font-size:0.75rem;color:var(--text-muted)}
.settings-btn{width:40px;height:40px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;display:grid;place-items:center;cursor:pointer;font-size:1.1rem;transition:all 0.2s}
.settings-btn:hover{border-color:var(--purple);background:var(--bg-hover)}

/* Search */
.search-section{margin-bottom:24px}
.search-box{position:relative;display:flex;gap:10px}
.search-input{flex:1;padding:14px 16px 14px 44px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:0.95rem;font-family:inherit}
.search-input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(139,92,246,0.15)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:1.1rem;pointer-events:none}
.search-btn{padding:14px 24px;background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:var(--radius);color:white;font-weight:600;font-size:0.9rem;cursor:pointer}
.search-btn:disabled{opacity:0.5}

/* Common Drugs */
.section-title{font-size:0.85rem;font-weight:700;color:var(--gold);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.drugs-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:28px}
.drug-chip{padding:10px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-size:0.8rem;cursor:pointer;transition:all 0.2s}
.drug-chip:hover{background:var(--bg-hover);border-color:var(--purple);color:var(--purple)}

/* Quick Reference */
.quick-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:28px}
.quick-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;cursor:pointer;transition:all 0.2s}
.quick-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.quick-card-icon{font-size:1.5rem;margin-bottom:8px}
.quick-card-title{font-weight:700;font-size:0.9rem;margin-bottom:4px}
.quick-card-desc{font-size:0.7rem;color:var(--text-muted);line-height:1.4}

/* Results Area */
.results-area{min-height:200px}
.result-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden}
.result-header{padding:16px;background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(59,130,246,0.05));border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.result-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--purple),var(--blue));border-radius:12px;display:grid;place-items:center;font-size:1.5rem}
.result-title{font-size:1.1rem;font-weight:700}
.result-subtitle{font-size:0.75rem;color:var(--purple)}
.result-body{padding:16px;font-size:0.85rem;line-height:1.7;color:var(--text-secondary)}
.result-body h4{color:var(--gold);font-size:0.8rem;margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em}
.result-body h4:first-child{margin-top:0}
.result-body ul{margin:8px 0;padding-left:20px}
.result-body li{margin-bottom:6px}
.result-body strong{color:var(--text)}
.result-body code{background:var(--bg);padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.8rem}
.result-body p{margin-bottom:12px}
.warning-box{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:8px;padding:12px;margin:12px 0}
.warning-box-title{color:var(--rose);font-weight:700;font-size:0.8rem;margin-bottom:6px}

/* Loading */
.loading{text-align:center;padding:40px}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Claude AI FAB */
.ai-fab{position:fixed;bottom:24px;right:24px;width:60px;height:60px;background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:50%;cursor:pointer;box-shadow:0 4px 20px rgba(139,92,246,0.4);display:grid;place-items:center;font-size:1.5rem;z-index:100;transition:all 0.3s}
.ai-fab:hover{transform:scale(1.1);box-shadow:0 6px 30px rgba(139,92,246,0.5)}
.ai-fab.has-key{background:linear-gradient(135deg,var(--emerald),var(--teal))}

/* AI Chat Modal */
.ai-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;display:none;align-items:flex-end;justify-content:center;padding:0}
.ai-modal.active{display:flex}
.ai-modal-content{width:100%;max-width:500px;max-height:85vh;background:var(--bg-card);border-radius:var(--radius) var(--radius) 0 0;display:flex;flex-direction:column;animation:slideUp 0.3s ease}
@keyframes slideUp{from{transform:translateY(100%)}}
.ai-modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.ai-modal-header-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--purple),var(--blue));border-radius:10px;display:grid;place-items:center;font-size:1.2rem}
.ai-modal-header h3{flex:1;font-size:1rem}
.ai-modal-header p{font-size:0.7rem;color:var(--text-muted)}
.ai-modal-close{width:36px;height:36px;background:var(--bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:1rem;display:grid;place-items:center}
.ai-modal-messages{flex:1;overflow-y:auto;padding:16px;min-height:200px;max-height:50vh}
.ai-msg{margin-bottom:12px;display:flex;gap:10px}
.ai-msg.user{flex-direction:row-reverse}
.ai-msg-avatar{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;font-size:0.85rem;flex-shrink:0}
.ai-msg.assistant .ai-msg-avatar{background:linear-gradient(135deg,var(--purple),var(--blue))}
.ai-msg.user .ai-msg-avatar{background:linear-gradient(135deg,var(--gold),var(--orange))}
.ai-msg-content{max-width:85%;padding:10px 14px;border-radius:12px;font-size:0.85rem;line-height:1.5}
.ai-msg.assistant .ai-msg-content{background:var(--bg-elevated);border:1px solid var(--border)}
.ai-msg.user .ai-msg-content{background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3)}
.ai-msg-content h4{color:var(--gold);font-size:0.75rem;margin:10px 0 6px}
.ai-msg-content ul{margin:6px 0;padding-left:16px;font-size:0.8rem}
.ai-msg-content li{margin-bottom:4px}
.typing-dots{display:flex;gap:4px;padding:8px 0}
.typing-dot{width:6px;height:6px;background:var(--purple);border-radius:50%;animation:typing 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:0.2s}
.typing-dot:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.ai-modal-input{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px}
.ai-modal-input textarea{flex:1;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.85rem;font-family:inherit;resize:none;max-height:80px}
.ai-modal-input textarea:focus{outline:none;border-color:var(--purple)}
.ai-modal-input button{padding:10px 20px;background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:10px;color:white;font-weight:600;font-size:0.85rem;cursor:pointer}
.ai-modal-input button:disabled{opacity:0.5}

/* API Setup (in modal) */
.api-setup{padding:16px;background:var(--bg);border-radius:10px;margin:12px 16px}
.api-setup p{font-size:0.75rem;color:var(--text-muted);margin-bottom:10px}
.api-setup-row{display:flex;gap:8px}
.api-setup input{flex:1;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem}
.api-setup input:focus{outline:none;border-color:var(--emerald)}
.api-setup button{padding:10px 16px;background:var(--emerald);border:none;border-radius:8px;color:white;font-weight:600;font-size:0.8rem;cursor:pointer}
.api-status{font-size:0.7rem;margin-top:8px;display:flex;align-items:center;gap:6px}
.api-status.ok{color:var(--emerald)}
.api-status.no{color:var(--rose)}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(50px);background:var(--bg-elevated);border:1px solid var(--border);padding:10px 20px;border-radius:10px;font-size:0.85rem;z-index:300;opacity:0;transition:all 0.3s}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose);color:var(--rose)}

/* Empty State */
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty-state-icon{font-size:3rem;margin-bottom:16px}
.empty-state h3{color:var(--text);margin-bottom:8px}

@media(max-width:640px){
  .quick-grid{grid-template-columns:1fr}
  .ai-modal-content{max-width:100%;border-radius:var(--radius) var(--radius) 0 0}
  .header-title h1{font-size:1.1rem}
}
@media(min-width:641px){
  .ai-modal{align-items:center;padding:20px}
  .ai-modal-content{max-height:80vh;border-radius:var(--radius)}
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a href="https://balhaddad-sys.github.io/Final-app/index.html" class="back-btn">‚Üê Back</a>
    <div class="header-title">
      <h1>üíä Drug Reference</h1>
      <p>AI-Powered Clinical Information</p>
    </div>
    <button class="settings-btn" onclick="toggleSettings()" title="API Settings">‚öôÔ∏è</button>
  </div>

  <div class="search-section">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="searchInput" placeholder="Search any drug..." onkeydown="if(event.key==='Enter')searchDrug()">
      <button class="search-btn" onclick="searchDrug()" id="searchBtn">Search</button>
    </div>
  </div>

  <div class="section-title">üíä Common Medications</div>
  <div class="drugs-grid">
    <div class="drug-chip" onclick="quickSearch('Metformin')">Metformin</div>
    <div class="drug-chip" onclick="quickSearch('Lisinopril')">Lisinopril</div>
    <div class="drug-chip" onclick="quickSearch('Amlodipine')">Amlodipine</div>
    <div class="drug-chip" onclick="quickSearch('Atorvastatin')">Atorvastatin</div>
    <div class="drug-chip" onclick="quickSearch('Omeprazole')">Omeprazole</div>
    <div class="drug-chip" onclick="quickSearch('Metoprolol')">Metoprolol</div>
    <div class="drug-chip" onclick="quickSearch('Furosemide')">Furosemide</div>
    <div class="drug-chip" onclick="quickSearch('Warfarin')">Warfarin</div>
    <div class="drug-chip" onclick="quickSearch('Insulin')">Insulin</div>
    <div class="drug-chip" onclick="quickSearch('Heparin')">Heparin</div>
    <div class="drug-chip" onclick="quickSearch('Enoxaparin')">Enoxaparin</div>
    <div class="drug-chip" onclick="quickSearch('Prednisone')">Prednisone</div>
    <div class="drug-chip" onclick="quickSearch('Aspirin')">Aspirin</div>
    <div class="drug-chip" onclick="quickSearch('Clopidogrel')">Clopidogrel</div>
    <div class="drug-chip" onclick="quickSearch('Amoxicillin')">Amoxicillin</div>
    <div class="drug-chip" onclick="quickSearch('Ciprofloxacin')">Ciprofloxacin</div>
  </div>

  <div class="section-title">‚ö° Quick Protocols</div>
  <div class="quick-grid">
    <div class="quick-card" onclick="quickSearch('Hyperkalemia treatment protocol')">
      <div class="quick-card-icon">‚ö°</div>
      <div class="quick-card-title">Hyperkalemia</div>
      <div class="quick-card-desc">Calcium gluconate, Insulin+D50, Kayexalate</div>
    </div>
    <div class="quick-card" onclick="quickSearch('Anticoagulation reversal agents')">
      <div class="quick-card-icon">ü©∏</div>
      <div class="quick-card-title">Anticoag Reversal</div>
      <div class="quick-card-desc">Warfarin, Heparin, DOAC agents</div>
    </div>
    <div class="quick-card" onclick="quickSearch('Insulin sliding scale and DKA protocol')">
      <div class="quick-card-icon">üíâ</div>
      <div class="quick-card-title">Insulin Protocols</div>
      <div class="quick-card-desc">Sliding scale, DKA, correction</div>
    </div>
    <div class="quick-card" onclick="quickSearch('Renal dose adjustments common drugs')">
      <div class="quick-card-icon">ü´ò</div>
      <div class="quick-card-title">Renal Dosing</div>
      <div class="quick-card-desc">CKD dose adjustments</div>
    </div>
  </div>

  <div class="results-area" id="resultsArea">
    <div class="empty-state">
      <div class="empty-state-icon">üî¨</div>
      <h3>Search for a Drug</h3>
      <p>Click a medication above or search to get AI-powered drug information</p>
    </div>
  </div>
</div>

<!-- Claude AI FAB -->
<button class="ai-fab" id="aiFab" onclick="openAiChat()" title="Ask Claude AI">ü§ñ</button>

<!-- AI Chat Modal -->
<div class="modal ai-modal" id="aiModal" onclick="if(event.target===this)closeAiChat()">
  <div class="ai-modal-content">
    <div class="ai-modal-header">
      <div class="ai-modal-header-icon">ü§ñ</div>
      <div style="flex:1">
        <h3>Ask Claude AI</h3>
        <p>Clinical pharmacology assistant</p>
      </div>
      <button class="ai-modal-close" onclick="closeAiChat()">‚úï</button>
    </div>
    
    <div id="apiSetupArea"></div>
    
    <div class="ai-modal-messages" id="chatMessages">
      <div class="ai-msg assistant">
        <div class="ai-msg-avatar">ü§ñ</div>
        <div class="ai-msg-content">
          <p>Hi! I can help with drug info, dosing, interactions, and clinical questions. What would you like to know?</p>
        </div>
      </div>
    </div>
    
    <div class="ai-modal-input">
      <textarea id="chatInput" placeholder="Ask anything..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button onclick="sendChat()" id="chatSendBtn">Send</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const STORAGE_KEY = 'medward_drug_v2';
const API_URL = 'https://api.anthropic.com/v1/messages';

let state = {
  apiKey: null,
  chatHistory: [],
  isLoading: false,
  showApiSetup: false
};

const $ = id => document.getElementById(id);

function toast(msg, isError) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      state.apiKey = data.apiKey || null;
    }
    updateFabStatus();
  } catch(e) {}
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ apiKey: state.apiKey }));
}

function updateFabStatus() {
  const fab = $('aiFab');
  if (state.apiKey) {
    fab.classList.add('has-key');
    fab.title = 'Ask Claude AI (API configured)';
  } else {
    fab.classList.remove('has-key');
    fab.title = 'Ask Claude AI (needs API key)';
  }
  renderApiSetup();
}

function toggleSettings() {
  state.showApiSetup = !state.showApiSetup;
  renderApiSetup();
  if (state.showApiSetup) openAiChat();
}

function renderApiSetup() {
  const area = $('apiSetupArea');
  if (!state.showApiSetup && state.apiKey) {
    area.innerHTML = '';
    return;
  }
  
  area.innerHTML = `
    <div class="api-setup">
      <p>üîë Enter your Anthropic API key to enable AI queries</p>
      <div class="api-setup-row">
        <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." value="${state.apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}">
        <button onclick="saveApiKey()">Save</button>
      </div>
      <div class="api-status ${state.apiKey ? 'ok' : 'no'}">
        ${state.apiKey ? '‚úì API key saved' : '‚ö† No API key'}
      </div>
    </div>
  `;
}

function saveApiKey() {
  const key = $('apiKeyInput').value.trim();
  if (!key || key === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
    if (!state.apiKey) toast('Enter API key', true);
    return;
  }
  if (!key.startsWith('sk-ant-')) {
    toast('Invalid key format', true);
    return;
  }
  state.apiKey = key;
  saveState();
  updateFabStatus();
  state.showApiSetup = false;
  renderApiSetup();
  toast('API key saved!');
}

function openAiChat() {
  $('aiModal').classList.add('active');
  if (!state.apiKey) {
    state.showApiSetup = true;
    renderApiSetup();
  }
}

function closeAiChat() {
  $('aiModal').classList.remove('active');
}

function quickSearch(query) {
  $('searchInput').value = query;
  searchDrug();
}

async function searchDrug() {
  const query = $('searchInput').value.trim();
  if (!query) return;
  
  if (!state.apiKey) {
    openAiChat();
    toast('Please configure API key first', true);
    return;
  }
  
  const results = $('resultsArea');
  results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';
  
  $('searchBtn').disabled = true;
  
  try {
    const prompt = `Provide comprehensive clinical information about "${query}". Include:

1. **Overview**: Drug class, mechanism of action
2. **Indications**: FDA-approved and common off-label uses
3. **Dosing**: Standard doses, routes, frequency
4. **Renal/Hepatic Adjustments**: Dose modifications
5. **Contraindications**: Absolute and relative
6. **Side Effects**: Common and serious (with frequencies if known)
7. **Drug Interactions**: Major ones to watch
8. **Monitoring**: What to check and when
9. **Clinical Pearls**: Practical tips

Format with HTML: use <h4> for headers, <ul><li> for lists, <strong> for emphasis, <code> for doses. Be concise but thorough.`;

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2500,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API error');
    }
    
    const data = await response.json();
    const content = data.content[0].text;
    
    results.innerHTML = `
      <div class="result-card">
        <div class="result-header">
          <div class="result-icon">üíä</div>
          <div>
            <div class="result-title">${escHtml(query)}</div>
            <div class="result-subtitle">AI-Generated Drug Information</div>
          </div>
        </div>
        <div class="result-body">${content}</div>
      </div>
      <p style="text-align:center;font-size:0.7rem;color:var(--text-muted);margin-top:16px">‚ö†Ô∏è Always verify with official references. This is AI-generated content.</p>
    `;
    
  } catch(e) {
    results.innerHTML = `
      <div class="result-card">
        <div class="result-header">
          <div class="result-icon" style="background:linear-gradient(135deg,var(--rose),var(--orange))">‚ö†Ô∏è</div>
          <div>
            <div class="result-title">Error</div>
            <div class="result-subtitle">${escHtml(e.message)}</div>
          </div>
        </div>
        <div class="result-body">
          <p>Failed to fetch drug information. Please check your API key and try again.</p>
        </div>
      </div>
    `;
  } finally {
    $('searchBtn').disabled = false;
  }
}

async function sendChat() {
  const input = $('chatInput');
  const msg = input.value.trim();
  if (!msg || state.isLoading) return;
  
  if (!state.apiKey) {
    state.showApiSetup = true;
    renderApiSetup();
    toast('Please add API key', true);
    return;
  }
  
  state.isLoading = true;
  $('chatSendBtn').disabled = true;
  input.value = '';
  
  addChatMsg('user', msg);
  const loadingId = addLoadingMsg();
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        system: 'You are a clinical pharmacology expert. Give concise, accurate drug information. Use simple HTML formatting: <h4> for headers, <ul><li> for lists, <strong> for emphasis. Keep responses focused and practical.',
        messages: [
          ...state.chatHistory.slice(-8),
          { role: 'user', content: msg }
        ]
      })
    });
    
    if (!response.ok) throw new Error('API error');
    
    const data = await response.json();
    const reply = data.content[0].text;
    
    removeMsg(loadingId);
    addChatMsg('assistant', reply);
    
    state.chatHistory.push({ role: 'user', content: msg });
    state.chatHistory.push({ role: 'assistant', content: reply });
    
  } catch(e) {
    removeMsg(loadingId);
    addChatMsg('assistant', '<p style="color:var(--rose)">Error: ' + escHtml(e.message) + '</p>');
  } finally {
    state.isLoading = false;
    $('chatSendBtn').disabled = false;
  }
}

function addChatMsg(role, content) {
  const container = $('chatMessages');
  const id = 'msg_' + Date.now();
  const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
  const html = role === 'assistant' ? content : escHtml(content);
  
  container.insertAdjacentHTML('beforeend', `
    <div class="ai-msg ${role}" id="${id}">
      <div class="ai-msg-avatar">${avatar}</div>
      <div class="ai-msg-content">${html}</div>
    </div>
  `);
  container.scrollTop = container.scrollHeight;
  return id;
}

function addLoadingMsg() {
  const container = $('chatMessages');
  const id = 'loading_' + Date.now();
  container.insertAdjacentHTML('beforeend', `
    <div class="ai-msg assistant" id="${id}">
      <div class="ai-msg-avatar">ü§ñ</div>
      <div class="ai-msg-content">
        <div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
      </div>
    </div>
  `);
  container.scrollTop = container.scrollHeight;
  return id;
}

function removeMsg(id) {
  const el = $(id);
  if (el) el.remove();
}

function escHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Check URL params
function checkParams() {
  const params = new URLSearchParams(window.location.search);
  const drug = params.get('drug');
  if (drug) {
    $('searchInput').value = drug;
    setTimeout(() => searchDrug(), 300);
  }
}

loadState();
checkParams();
</script>

</body>
</html>
