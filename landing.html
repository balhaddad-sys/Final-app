/**
 * FIXED Landing Page Initialization Script
 * =========================================
 * Replace the auth section in landing.html with this
 * 
 * Key fixes:
 * 1. Handles getRedirectResult BEFORE requireAuth
 * 2. Respects MW_AUTH_PENDING flag
 * 3. Longer timeouts for mobile
 */

import { logout } from './firebase.auth.js';
import { getUnitsForUser, createUnit, updateUnit, deleteUnit as firebaseDeleteUnit, getAllUnits } from './firebase.store.js';
import { subscribeToUnits, onSyncStatusChange } from './firebase.sync.js';
import { requireAuth, setLegacyCredentials, safeRedirect } from './auth.guard.js';
import { auth } from './firebase.config.js';
import { getRedirectResult } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';

const BUILD_ID = '2026-01-26.4';  // Fixed Auth Guard Edition

// ═══════════════════════════════════════════════════════════════════════════
// APP STATE
// ═══════════════════════════════════════════════════════════════════════════

let state = {
  units: [],
  currentUser: null
};

let editingUnitId = null;
let unsubscribeUnits = null;

// ═══════════════════════════════════════════════════════════════════════════
// FIXED: Handle possible Google redirect BEFORE checking auth
// ═══════════════════════════════════════════════════════════════════════════

(async function handlePossibleRedirect() {
  console.log('[Landing] Checking for redirect result...');
  
  try {
    const result = await getRedirectResult(auth);
    
    if (result && result.user) {
      console.log('[Landing] Got redirect result for:', result.user.email);
      // Clear pending flag since we got the result
      sessionStorage.removeItem('MW_AUTH_PENDING');
      // Set legacy credentials
      setLegacyCredentials(result.user);
      // Don't redirect - we're already on landing, just initialize
      state.currentUser = {
        uid: result.user.uid,
        email: result.user.email,
        displayName: result.user.displayName || result.user.email?.split('@')[0]
      };
      initApp();
      return;  // Skip requireAuth since we already have the user
    }
    
    console.log('[Landing] No redirect result, proceeding to requireAuth');
  } catch (error) {
    console.error('[Landing] Redirect result error:', error);
    // Continue to requireAuth
  }
  
  // Normal auth guard check
  runAuthGuard();
})();

function runAuthGuard() {
  requireAuth({
    onAuthed: (user) => {
      // User is authenticated - initialize app
      console.log('[Landing] User authenticated:', user.email);
      state.currentUser = user;
      setLegacyCredentials(user);
      initApp();
    },
    onUnauthed: () => {
      // Check if we have a pending auth flag
      const authPending = sessionStorage.getItem('MW_AUTH_PENDING');
      
      if (authPending) {
        console.log('[Landing] Auth pending flag found, waiting extra time...');
        
        // Give Firebase more time to hydrate
        setTimeout(() => {
          const currentUser = auth.currentUser;
          
          if (currentUser) {
            console.log('[Landing] User appeared after extra wait:', currentUser.email);
            sessionStorage.removeItem('MW_AUTH_PENDING');
            state.currentUser = {
              uid: currentUser.uid,
              email: currentUser.email,
              displayName: currentUser.displayName || currentUser.email?.split('@')[0]
            };
            setLegacyCredentials(currentUser);
            initApp();
          } else {
            console.log('[Landing] Still no user after extra wait, redirecting to login');
            sessionStorage.removeItem('MW_AUTH_PENDING');
            safeRedirect('login.html');
          }
        }, 2000);  // Extra 2 second wait if pending flag exists
        return;
      }
      
      // User is not authenticated - redirect to login
      console.log('[Landing] Not authenticated, redirecting to login');
      safeRedirect('login.html');
    },
    // FIXED: Use longer null debounce for mobile compatibility
    nullDebounce: 1500,
    timeout: 6000
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// INITIALIZE APP
// ═══════════════════════════════════════════════════════════════════════════

async function initApp() {
  console.log('[Landing] Initializing app for user:', state.currentUser?.email);

  updateThemeIcon();
  updateUserDisplay();
  showLoading('Loading your units...');

  // Setup color picker handlers
  document.querySelectorAll('.color-option').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    });
  });

  // Subscribe to realtime unit updates
  unsubscribeUnits = subscribeToUnits(
    (units) => {
      console.log('[Landing] Units updated:', units.length);
      state.units = units;
      renderUnits();
      hideLoading();

      // Mark cloud as verified
      localStorage.setItem('MW_CLOUD_VERIFIED', Date.now().toString());
      localStorage.removeItem('MW_OFFLINE_MODE');
      console.log('[Landing] Cloud verified via Firebase');
    },
    (error) => {
      console.error('[Landing] Units subscription error:', error);
      hideLoading();
      toast('Failed to load units');
    }
  );

  // Subscribe to sync status
  onSyncStatusChange(status => {
    updateSyncStatus(status);
  });
}

// ... rest of your existing functions ...
