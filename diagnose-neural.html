<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neural System Diagnostic</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: #1a1a1a;
      color: #00ff00;
    }
    .test {
      margin: 1rem 0;
      padding: 1rem;
      border: 1px solid #333;
      background: #000;
    }
    .pass { border-left: 4px solid #00ff00; }
    .fail { border-left: 4px solid #ff0000; color: #ff0000; }
    .warn { border-left: 4px solid #ffaa00; color: #ffaa00; }
    .info { color: #00aaff; }
    pre {
      background: #111;
      padding: 0.5rem;
      overflow-x: auto;
      border: 1px solid #333;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
      margin: 0.5rem 0.5rem 0 0;
    }
    button:hover { background: #00cc00; }
  </style>
</head>
<body>
  <h1>MedWard Neural System Diagnostic</h1>
  <p class="info">This tool checks for common initialization issues</p>

  <div id="results"></div>
  <button onclick="runDiagnostics()">Run Diagnostics</button>
  <button onclick="testInitialization()">Test Full Initialization</button>

  <!-- Load TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="js/medward-neural.js"></script>

  <script>
    const results = document.getElementById('results');

    function addResult(title, status, message, details = '') {
      const div = document.createElement('div');
      div.className = `test ${status}`;
      div.innerHTML = `
        <strong>${status.toUpperCase()}: ${title}</strong><br>
        ${message}
        ${details ? `<pre>${details}</pre>` : ''}
      `;
      results.appendChild(div);
    }

    async function runDiagnostics() {
      results.innerHTML = '<h2>Running Diagnostics...</h2>';

      // Test 1: TensorFlow.js
      addResult(
        'TensorFlow.js Loading',
        typeof tf !== 'undefined' ? 'pass' : 'fail',
        typeof tf !== 'undefined'
          ? `TensorFlow.js version ${tf.version.tfjs} loaded successfully`
          : 'TensorFlow.js not loaded! Check CDN connection.',
        typeof tf !== 'undefined' ? `tf object: ${Object.keys(tf).slice(0, 10).join(', ')}...` : ''
      );

      // Test 2: Backend availability
      if (typeof tf !== 'undefined') {
        try {
          const backend = tf.getBackend();
          addResult(
            'TensorFlow.js Backend',
            'pass',
            `Backend: ${backend}`,
            `Available backends: ${tf.engine().registryFactory ? 'Multiple' : 'Unknown'}`
          );
        } catch (e) {
          addResult('TensorFlow.js Backend', 'fail', 'Error getting backend', e.toString());
        }
      }

      // Test 3: Neural classes
      addResult(
        'MedicalDocumentParser Class',
        typeof MedicalDocumentParser !== 'undefined' ? 'pass' : 'fail',
        typeof MedicalDocumentParser !== 'undefined'
          ? 'Class loaded successfully'
          : 'Class not found! Check medward-neural.js loading'
      );

      addResult(
        'PatternStore Class',
        typeof PatternStore !== 'undefined' ? 'pass' : 'fail',
        typeof PatternStore !== 'undefined'
          ? 'Class loaded successfully'
          : 'Class not found! Check medward-neural.js loading'
      );

      addResult(
        'MedWardNeural Class',
        typeof MedWardNeural !== 'undefined' ? 'pass' : 'fail',
        typeof MedWardNeural !== 'undefined'
          ? 'Class loaded successfully'
          : 'Class not found! Check medward-neural.js loading'
      );

      // Test 4: IndexedDB
      try {
        const testDB = indexedDB.open('DiagnosticTest', 1);
        testDB.onsuccess = () => {
          addResult('IndexedDB', 'pass', 'IndexedDB available and working');
          testDB.result.close();
          indexedDB.deleteDatabase('DiagnosticTest');
        };
        testDB.onerror = (e) => {
          addResult('IndexedDB', 'fail', 'IndexedDB error', e.toString());
        };
        testDB.onupgradeneeded = (e) => {
          e.target.result.createObjectStore('test', { keyPath: 'id' });
        };
      } catch (e) {
        addResult('IndexedDB', 'fail', 'IndexedDB not available', e.toString());
      }

      // Test 5: Create simple TF model
      if (typeof tf !== 'undefined') {
        try {
          const testModel = tf.sequential();
          testModel.add(tf.layers.dense({ units: 10, inputShape: [5] }));
          testModel.compile({ optimizer: 'adam', loss: 'meanSquaredError' });

          // Test tensor creation
          const testTensor = tf.tensor2d([[1, 2, 3, 4, 5]]);
          const prediction = testModel.predict(testTensor);
          const shape = prediction.shape;

          testTensor.dispose();
          prediction.dispose();
          testModel.dispose();

          addResult(
            'TensorFlow.js Model Creation',
            'pass',
            'Successfully created and ran test model',
            `Output shape: [${shape.join(', ')}]\nMemory: ${tf.memory().numTensors} tensors`
          );
        } catch (e) {
          addResult('TensorFlow.js Model Creation', 'fail', 'Error creating model', e.toString() + '\n' + e.stack);
        }
      }

      // Test 6: Parser instantiation
      if (typeof MedicalDocumentParser !== 'undefined') {
        try {
          const parser = new MedicalDocumentParser({ debug: true });
          addResult('Parser Instantiation', 'pass', 'MedicalDocumentParser created successfully');
        } catch (e) {
          addResult('Parser Instantiation', 'fail', 'Error creating parser', e.toString() + '\n' + e.stack);
        }
      }
    }

    async function testInitialization() {
      results.innerHTML = '<h2>Testing Full Initialization...</h2>';

      if (typeof MedWardNeural === 'undefined') {
        addResult('Initialization', 'fail', 'MedWardNeural class not loaded');
        return;
      }

      try {
        addResult('Step 1', 'info', 'Creating MedWardNeural instance...');
        const neural = new MedWardNeural({ debug: true });

        addResult('Step 2', 'pass', 'Instance created successfully');

        addResult('Step 3', 'info', 'Calling initialize()...');
        await neural.initialize();

        addResult('Step 4', 'pass', 'Initialize completed!');

        const metrics = neural.getMetrics();
        addResult(
          'Final Status',
          'pass',
          'Neural system fully initialized!',
          `Patterns loaded: ${metrics.patterns}\nTotal analyses: ${metrics.total}\nCache hit rate: ${metrics.cacheHitRate}`
        );
      } catch (e) {
        addResult(
          'Initialization Error',
          'fail',
          'Failed to initialize neural system',
          `${e.toString()}\n\nStack trace:\n${e.stack}`
        );
      }
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(runDiagnostics, 500);
    });
  </script>
</body>
</html>
