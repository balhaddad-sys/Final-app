<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sign-In Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
    .card { background: white; padding: 24px; border-radius: 12px; max-width: 400px; margin: 0 auto; }
    h1 { font-size: 1.3rem; margin-bottom: 16px; }
    button { width: 100%; padding: 14px; font-size: 1rem; border-radius: 8px; border: none; cursor: pointer; margin-bottom: 12px; }
    .btn-google { background: #4285f4; color: white; }
    .btn-green { background: #22c55e; color: white; }
    .btn-gray { background: #e5e7eb; color: #374151; }
    .log { background: #111; color: #0f0; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px; height: 300px; overflow-y: auto; margin-top: 16px; white-space: pre-wrap; }
    .status { padding: 12px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; }
    .status.pending { background: #fef3c7; color: #92400e; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>

<div class="card">
  <h1>üß™ Google Sign-In Test</h1>
  
  <div class="status pending" id="status">Ready to test</div>
  
  <button class="btn-google" onclick="doGoogleSignIn()">üîê Sign in with Google</button>
  <button class="btn-green" onclick="goToLanding()" id="goBtn" style="display:none">‚úÖ Go to Landing Page</button>
  <button class="btn-gray" onclick="checkAuthState()">üîç Check Auth State</button>
  <button class="btn-gray" onclick="doSignOut()">üö™ Sign Out</button>
  
  <div class="log" id="log"></div>
</div>

<script type="module">
import { auth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from './firebase.config.js';

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const goBtn = document.getElementById('goBtn');

function log(msg) {
  const time = new Date().toLocaleTimeString();
  logEl.textContent += `[${time}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

function setStatus(text, type) {
  statusEl.textContent = text;
  statusEl.className = 'status ' + type;
}

// Listen for auth changes
log('Setting up auth listener...');
onAuthStateChanged(auth, (user) => {
  if (user) {
    log('‚úÖ AUTH STATE: Signed in as ' + user.email);
    setStatus('‚úÖ Signed in: ' + user.email, 'success');
    goBtn.style.display = 'block';
    
    // Set session storage
    sessionStorage.setItem('MW_USER', user.email);
    sessionStorage.setItem('MW_PASS', 'FIREBASE_AUTH');
    localStorage.setItem('MW_USER', user.email);
    localStorage.setItem('MW_PASS', 'FIREBASE_AUTH');
    log('‚úÖ Session storage set');
  } else {
    log('‚ùå AUTH STATE: Not signed in');
    setStatus('Not signed in', 'pending');
    goBtn.style.display = 'none';
  }
});

// Google Sign In
window.doGoogleSignIn = async function() {
  log('Starting Google sign-in (popup)...');
  setStatus('Opening Google popup...', 'pending');
  
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    
    log('Calling signInWithPopup...');
    const result = await signInWithPopup(auth, provider);
    
    log('‚úÖ signInWithPopup returned!');
    log('User: ' + result.user.email);
    log('UID: ' + result.user.uid);
    
    setStatus('‚úÖ Sign-in successful: ' + result.user.email, 'success');
    goBtn.style.display = 'block';
    
  } catch (error) {
    log('‚ùå ERROR: ' + error.code);
    log('Message: ' + error.message);
    setStatus('‚ùå Error: ' + error.code, 'error');
  }
};

// Check current auth state
window.checkAuthState = function() {
  log('--- Checking Auth State ---');
  log('auth.currentUser: ' + (auth.currentUser ? auth.currentUser.email : 'null'));
  log('MW_USER (session): ' + sessionStorage.getItem('MW_USER'));
  log('MW_USER (local): ' + localStorage.getItem('MW_USER'));
};

// Sign out
window.doSignOut = async function() {
  log('Signing out...');
  try {
    await signOut(auth);
    sessionStorage.clear();
    localStorage.removeItem('MW_USER');
    localStorage.removeItem('MW_PASS');
    log('‚úÖ Signed out');
    setStatus('Signed out', 'pending');
    goBtn.style.display = 'none';
  } catch (e) {
    log('‚ùå Sign out error: ' + e.message);
  }
};

// Go to landing
window.goToLanding = function() {
  log('Navigating to landing.html...');
  window.location.href = 'landing.html';
};

log('Test page ready');
checkAuthState();
</script>

</body>
</html>
