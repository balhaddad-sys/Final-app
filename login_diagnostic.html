<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Diagnostic | MedWard Pro</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f0f0f0;
  padding: 20px;
  min-height: 100vh;
}
.diagnostic {
  background: white;
  border-radius: 12px;
  padding: 20px;
  max-width: 600px;
  margin: 0 auto;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
h1 { color: #333; margin-bottom: 20px; font-size: 1.5rem; }
.log { 
  background: #1e1e1e; 
  color: #0f0; 
  padding: 15px; 
  border-radius: 8px; 
  font-family: monospace; 
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 20px;
}
.log .error { color: #f55; }
.log .success { color: #5f5; }
.log .warn { color: #ff5; }
.log .info { color: #5af; }
.status {
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-weight: 600;
}
.status.error { background: #fee; color: #c00; border: 1px solid #fcc; }
.status.success { background: #efe; color: #060; border: 1px solid #cfc; }
.status.pending { background: #ffe; color: #660; border: 1px solid #ffc; }
button {
  background: #005eb8;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  margin-right: 10px;
  margin-bottom: 10px;
}
button:hover { background: #004a90; }
button.secondary { background: #666; }
button.danger { background: #c00; }
.section {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}
.section h3 { margin-bottom: 10px; color: #333; }
</style>
</head>
<body>

<div class="diagnostic">
  <h1>üîç MedWard Pro - Login Diagnostic</h1>
  
  <div id="mainStatus" class="status pending">‚è≥ Running diagnostics...</div>
  
  <div class="log" id="log"></div>
  
  <div class="section">
    <h3>Actions</h3>
    <button onclick="runFullDiagnostic()">üîÑ Re-run Diagnostic</button>
    <button onclick="clearAllStorage()" class="danger">üóëÔ∏è Clear All Storage</button>
    <button onclick="goToLogin()" class="secondary">‚û°Ô∏è Go to login.html</button>
  </div>
  
  <div class="section">
    <h3>Storage Status</h3>
    <div id="storageStatus"></div>
  </div>
</div>

<script>
// Diagnostic logger
const logEl = document.getElementById('log');
function log(msg, type = 'info') {
  const time = new Date().toLocaleTimeString();
  logEl.innerHTML += `<span class="${type}">[${time}] ${msg}</span>\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(`[${type}]`, msg);
}

function setMainStatus(msg, type) {
  const el = document.getElementById('mainStatus');
  el.className = 'status ' + type;
  el.innerHTML = msg;
}

// Check storage
function checkStorage() {
  const storage = {
    'MW_USER (session)': sessionStorage.getItem('MW_USER'),
    'MW_PASS (session)': sessionStorage.getItem('MW_PASS'),
    'MW_UNIT (session)': sessionStorage.getItem('MW_UNIT'),
    'MW_AUTH_PENDING (session)': sessionStorage.getItem('MW_AUTH_PENDING'),
    'MW_USER (local)': localStorage.getItem('MW_USER'),
    'MW_PASS (local)': localStorage.getItem('MW_PASS'),
    'MW_SELECTED_UNIT (local)': localStorage.getItem('MW_SELECTED_UNIT'),
    'MEDWARD_THEME (local)': localStorage.getItem('MEDWARD_THEME'),
  };
  
  let html = '<table style="width:100%;font-size:12px;">';
  for (const [key, val] of Object.entries(storage)) {
    const display = val ? (val.length > 30 ? val.substring(0,30) + '...' : val) : '<em style="color:#999">null</em>';
    html += `<tr><td><strong>${key}</strong></td><td>${display}</td></tr>`;
  }
  html += '</table>';
  document.getElementById('storageStatus').innerHTML = html;
  
  return storage;
}

function clearAllStorage() {
  if (!confirm('Clear ALL MedWard storage? You will need to log in again.')) return;
  
  // Session storage
  sessionStorage.removeItem('MW_USER');
  sessionStorage.removeItem('MW_PASS');
  sessionStorage.removeItem('MW_UNIT');
  sessionStorage.removeItem('MW_UNIT_NAME');
  sessionStorage.removeItem('MW_AUTH_PENDING');
  
  // Local storage
  localStorage.removeItem('MW_USER');
  localStorage.removeItem('MW_PASS');
  localStorage.removeItem('MW_SELECTED_UNIT');
  localStorage.removeItem('MW_SELECTED_UNIT_NAME');
  localStorage.removeItem('MW_CLOUD_VERIFIED');
  localStorage.removeItem('MW_OFFLINE_MODE');
  
  log('‚úÖ All storage cleared!', 'success');
  checkStorage();
}

function goToLogin() {
  window.location.href = 'login.html';
}

// Main diagnostic
async function runFullDiagnostic() {
  logEl.innerHTML = '';
  log('Starting diagnostic...', 'info');
  
  // 1. Check protocol
  log('1. Checking protocol...', 'info');
  if (location.protocol === 'file:') {
    log('‚ùå CRITICAL: Running from file:// protocol!', 'error');
    log('   ES Modules do NOT work with file:// URLs.', 'error');
    log('   You MUST use a web server (http:// or https://)', 'error');
    setMainStatus('‚ùå CRITICAL: You must use a web server, not open the file directly!', 'error');
    checkStorage();
    return;
  }
  log(`‚úÖ Protocol OK: ${location.protocol}`, 'success');
  
  // 2. Check storage
  log('2. Checking storage...', 'info');
  const storage = checkStorage();
  if (storage['MW_USER (session)'] || storage['MW_USER (local)']) {
    log(`‚ö†Ô∏è Found existing user credentials - may auto-redirect`, 'warn');
  }
  if (storage['MW_AUTH_PENDING (session)']) {
    log(`‚ö†Ô∏è Found MW_AUTH_PENDING flag - Google redirect in progress?`, 'warn');
  }
  log('‚úÖ Storage check complete', 'success');
  
  // 3. Try to load Firebase config
  log('3. Loading firebase.config.js...', 'info');
  try {
    const firebaseModule = await import('./firebase.config.js');
    log('‚úÖ firebase.config.js loaded!', 'success');
    
    if (firebaseModule.auth) {
      log('‚úÖ Firebase auth object exists', 'success');
      
      // Check current user
      const currentUser = firebaseModule.auth.currentUser;
      if (currentUser) {
        log(`‚úÖ Firebase currentUser: ${currentUser.email}`, 'success');
      } else {
        log('‚ÑπÔ∏è Firebase currentUser is null (not logged in or not hydrated yet)', 'info');
      }
    }
  } catch (e) {
    log(`‚ùå Failed to load firebase.config.js: ${e.message}`, 'error');
    setMainStatus('‚ùå Firebase config failed to load - check file exists', 'error');
    return;
  }
  
  // 4. Try to load auth.guard.js
  log('4. Loading auth.guard.js...', 'info');
  try {
    const authGuard = await import('./auth.guard.js');
    log('‚úÖ auth.guard.js loaded!', 'success');
    
    if (typeof authGuard.requireAuth === 'function') {
      log('‚úÖ requireAuth function exists', 'success');
    } else {
      log('‚ùå requireAuth function not found!', 'error');
    }
  } catch (e) {
    log(`‚ùå Failed to load auth.guard.js: ${e.message}`, 'error');
    setMainStatus('‚ùå auth.guard.js failed to load - check file exists', 'error');
    return;
  }
  
  // 5. Try to load firebase.auth.js
  log('5. Loading firebase.auth.js...', 'info');
  try {
    const firebaseAuth = await import('./firebase.auth.js');
    log('‚úÖ firebase.auth.js loaded!', 'success');
    
    const funcs = ['login', 'register', 'signInWithGoogle', 'handleGoogleRedirect'];
    for (const fn of funcs) {
      if (typeof firebaseAuth[fn] === 'function') {
        log(`  ‚úÖ ${fn}() exists`, 'success');
      } else {
        log(`  ‚ùå ${fn}() NOT FOUND`, 'error');
      }
    }
  } catch (e) {
    log(`‚ùå Failed to load firebase.auth.js: ${e.message}`, 'error');
    setMainStatus('‚ùå firebase.auth.js failed to load - check file exists', 'error');
    return;
  }
  
  // 6. Test Firebase Auth state
  log('6. Testing Firebase Auth state listener...', 'info');
  try {
    const { auth, onAuthStateChanged } = await import('./firebase.config.js');
    
    await new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        log('‚ö†Ô∏è Auth state listener timed out after 5s', 'warn');
        resolve();
      }, 5000);
      
      const unsubscribe = onAuthStateChanged(auth, (user) => {
        clearTimeout(timeout);
        unsubscribe();
        if (user) {
          log(`‚úÖ Auth state: SIGNED IN as ${user.email}`, 'success');
        } else {
          log('‚ÑπÔ∏è Auth state: NOT SIGNED IN', 'info');
        }
        resolve();
      }, (error) => {
        clearTimeout(timeout);
        log(`‚ùå Auth state error: ${error.message}`, 'error');
        resolve();
      });
    });
  } catch (e) {
    log(`‚ùå Auth state test failed: ${e.message}`, 'error');
  }
  
  // 7. Check for redirect result
  log('7. Checking for Google redirect result...', 'info');
  try {
    const { auth, getRedirectResult } = await import('./firebase.config.js');
    
    const result = await getRedirectResult(auth);
    if (result && result.user) {
      log(`‚úÖ Redirect result found! User: ${result.user.email}`, 'success');
    } else {
      log('‚ÑπÔ∏è No redirect result (normal if not returning from Google)', 'info');
    }
  } catch (e) {
    log(`‚ö†Ô∏è Redirect result check: ${e.message}`, 'warn');
  }
  
  // Done
  log('', 'info');
  log('=== DIAGNOSTIC COMPLETE ===', 'success');
  setMainStatus('‚úÖ All modules loaded successfully! Click "Go to login.html" to test.', 'success');
}

// Run on load
runFullDiagnostic();
</script>

</body>
</html>
