<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>OnCall Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--primary:#0f766e;--primary-dark:#115e59;--primary-light:#ccfbf1;--danger:#dc2626;--danger-light:#fef2f2;--warning:#d97706;--warning-light:#fffbeb;--success:#059669;--success-light:#d1fae5;--bg:#f8fafc;--bg-card:#fff;--text:#0f172a;--text-secondary:#475569;--text-muted:#94a3b8;--border:#e2e8f0;--radius:16px}
[data-theme="dark"]{--primary:#2dd4bf;--primary-dark:#14b8a6;--primary-light:#134e4a;--danger:#f87171;--danger-light:#450a0a;--warning:#fbbf24;--warning-light:#451a03;--success:#4ade80;--success-light:#14532d;--bg:#0f172a;--bg-card:#1e293b;--text:#f1f5f9;--text-secondary:#cbd5e1;--text-muted:#64748b;--border:#334155}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
.app-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 20px;position:sticky;top:0;z-index:100}
.header-row{display:flex;align-items:center;justify-content:space-between;max-width:800px;margin:0 auto}
.header-brand{display:flex;align-items:center;gap:12px}
.header-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
.header-title{font-weight:700;font-size:1.1rem}
.header-subtitle{font-size:.75rem;color:var(--text-muted)}
.header-actions{display:flex;gap:8px}
.icon-btn{width:44px;height:44px;border-radius:10px;border:1px solid var(--border);background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem}
.main-content{max-width:800px;margin:0 auto;padding:20px;padding-bottom:100px}
.category-pills{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:20px}
.pill{flex-shrink:0;padding:10px 18px;border-radius:20px;font-size:.8rem;font-weight:600;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer}
.pill.active{background:var(--primary);border-color:var(--primary);color:#fff}
.tool-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;overflow:hidden}
.tool-card.emergency{border-left:4px solid var(--danger)}
.tool-header{padding:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.tool-header-left{display:flex;align-items:center;gap:12px}
.tool-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;background:var(--bg);border:1px solid var(--border)}
.tool-title{font-weight:700;font-size:.95rem}
.tool-subtitle{font-size:.8rem;color:var(--text-muted)}
.tool-badge{padding:3px 8px;border-radius:6px;font-size:.65rem;font-weight:700;text-transform:uppercase;margin-left:8px}
.tool-badge.urgent{background:var(--danger-light);color:var(--danger)}
.tool-chevron{width:28px;height:28px;border-radius:8px;background:var(--bg);display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:transform .3s}
.tool-card.expanded .tool-chevron{transform:rotate(180deg);color:var(--primary)}
.tool-content{display:none;padding:0 16px 16px}
.tool-card.expanded .tool-content{display:block}
.tool-divider{height:1px;background:var(--border);margin-bottom:16px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:.75rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase}
.form-input,.form-select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:var(--bg);color:var(--text);-webkit-appearance:none}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:400px){.form-row{grid-template-columns:1fr}}
.gender-buttons{display:flex;gap:10px}
.gender-btn{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;background:var(--bg);font-size:.9rem;font-weight:600;cursor:pointer;color:var(--text-secondary)}
.gender-btn.selected{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.calc-btn{width:100%;padding:14px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:.95rem;font-weight:600;cursor:pointer}
.calc-btn.danger{background:var(--danger)}
.result-box{margin-top:16px;padding:16px;border-radius:12px;background:var(--bg);border:1px solid var(--border)}
.result-box.danger{background:var(--danger-light);border-color:var(--danger)}
.result-box.warning{background:var(--warning-light);border-color:var(--warning)}
.result-box.success{background:var(--success-light);border-color:var(--success)}
.result-title{font-weight:700;font-size:1rem;margin-bottom:8px}
.result-box.danger .result-title{color:var(--danger)}
.result-box.warning .result-title{color:var(--warning)}
.result-box.success .result-title{color:var(--success)}
.result-content{font-size:.9rem;color:var(--text-secondary);line-height:1.7}
.protocol-step{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px;border-left:3px solid var(--primary)}
.protocol-step.danger{border-left-color:var(--danger);background:var(--danger-light)}
.protocol-step.warning{border-left-color:var(--warning);background:var(--warning-light)}
.protocol-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.protocol-number{width:24px;height:24px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem}
.protocol-step.danger .protocol-number{background:var(--danger)}
.protocol-step.warning .protocol-number{background:var(--warning)}
.protocol-title{font-weight:700;font-size:.9rem}
.protocol-content{font-size:.85rem;color:var(--text-secondary);margin-left:34px}
.prn-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:500px){.prn-grid{grid-template-columns:repeat(2,1fr)}}
.prn-card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 8px;cursor:pointer;text-align:center}
.prn-card.active{border-color:var(--primary);background:var(--primary-light)}
.prn-icon{font-size:1.5rem;margin-bottom:6px}
.prn-name{font-weight:700;font-size:.8rem}
.prn-indication{font-size:.65rem;color:var(--text-muted)}
.prn-details{display:none;margin-top:16px;padding:16px;background:var(--bg);border-radius:12px;border:1px solid var(--border)}
.prn-details.visible{display:block}
.prn-dose-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
.prn-dose-row:last-child{border-bottom:none}
.prn-dose-label{font-size:.85rem;color:var(--text-secondary)}
.prn-dose-value{font-weight:600;font-size:.9rem}
.prn-warning{margin-top:12px;padding:10px;background:var(--warning-light);border-radius:8px;font-size:.8rem;color:var(--warning)}
.prn-danger{margin-top:12px;padding:10px;background:var(--danger-light);border-radius:8px;font-size:.8rem;color:var(--danger)}
.ai-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:12px}
.ai-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.ai-icon{width:44px;height:44px;background:linear-gradient(135deg,#0f766e,#115e59);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
.ai-title{font-weight:700;font-size:1rem}
.ai-subtitle{font-size:.8rem;color:var(--text-muted)}
.ai-body{padding:16px}
.ai-prompts{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.ai-prompt-btn{padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:20px;font-size:.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer}
.ai-input-row{display:flex;gap:10px}
.ai-input{flex:1;min-width:0;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:var(--bg);color:var(--text)}
.ai-send-btn{width:50px;height:50px;border-radius:12px;background:var(--primary);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ai-response{display:none;margin-top:16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.ai-response.visible{display:block}
.ai-response-header{padding:12px 16px;background:var(--primary-light);border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.ai-response-label{font-size:.75rem;font-weight:600;color:var(--primary);text-transform:uppercase}
.ai-response-time{font-size:.75rem;color:var(--text-muted)}
.ai-response-body{padding:16px;font-size:.9rem;line-height:1.8;max-height:50vh;overflow-y:auto}
.ai-alert{padding:12px;border-radius:10px;margin:12px 0;display:flex;align-items:flex-start;gap:10px}
.ai-alert.danger{background:var(--danger-light);border:1px solid var(--danger)}
.ai-alert-icon{font-size:1.1rem}
.ai-alert-content{font-size:.85rem;line-height:1.5}
.ai-alert.danger .ai-alert-content{color:var(--danger)}
.ai-loading{display:flex;align-items:center;justify-content:center;gap:12px;padding:30px;color:var(--text-muted)}
.ai-loading-spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.quick-ref-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:20px}
@media(max-width:500px){.quick-ref-grid{grid-template-columns:repeat(2,1fr)}}
.quick-ref-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer}
.quick-ref-icon{font-size:1.3rem;margin-bottom:6px}
.quick-ref-title{font-weight:600;font-size:.8rem;margin-bottom:2px}
.quick-ref-value{font-size:.7rem;color:var(--text-muted)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:8px 16px;padding-bottom:calc(8px + env(safe-area-inset-bottom));display:flex;justify-content:space-around;z-index:1000}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 20px;border-radius:12px;cursor:pointer;color:var(--text-muted);font-size:.7rem;font-weight:600}
.nav-item.active{color:var(--primary);background:var(--primary-light)}
.nav-icon{font-size:1.3rem}
.hidden{display:none!important}
.section-label{font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;margin-top:24px}
</style>
</head>
<body>
<header class="app-header">
<div class="header-row">
<div class="header-brand">
<div class="header-logo">ü©∫</div>
<div><div class="header-title">OnCall Assistant</div><div class="header-subtitle">Evidence-Based Decision Support</div></div>
</div>
<div class="header-actions">
<button class="icon-btn" id="themeBtn" onclick="toggleTheme()">üåô</button>
<button class="icon-btn" id="backBtn" onclick="goBack()">‚úï</button>
</div>
</div>
</header>
<div class="main-content">
<div class="category-pills">
<button class="pill active" onclick="filterCategory('all',this)">All Tools</button>
<button class="pill" onclick="filterCategory('emergency',this)">üö® Emergency</button>
<button class="pill" onclick="filterCategory('prn',this)">üíä PRN</button>
<button class="pill" onclick="filterCategory('lytes',this)">üß™ Lytes</button>
<button class="pill" onclick="filterCategory('renal',this)">ü´ò Renal</button>
<button class="pill" onclick="filterCategory('cardiac',this)">‚ù§Ô∏è Cardiac</button>
</div>

<!-- HYPOGLYCEMIA -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">üç¨</div>
<div><div class="tool-title">Hypoglycemia<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Glucose &lt; 3.9 mmol/L</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-group"><label class="form-label">Blood Glucose (mmol/L)</label><input type="number" class="form-input" id="inputHypoGlucose" placeholder="e.g., 2.8" step="0.1"></div>
<div class="form-group"><label class="form-label">Patient Status</label>
<select class="form-select" id="inputHypoStatus">
<option value="conscious">Conscious</option>
<option value="confused">Confused/Drowsy</option>
<option value="unconscious">Unconscious/Seizing</option>
</select></div>
<button class="calc-btn danger" onclick="calcHypo(event)">Get Protocol</button>
<div id="resultHypo" class="result-box hidden"></div>
</div>
</div>

<!-- HYPERKALEMIA -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">‚ö°</div>
<div><div class="tool-title">Hyperkalemia<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">K+ &gt; 6.0 mmol/L</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">K+ (mmol/L)</label><input type="number" class="form-input" id="inputHyperK" placeholder="e.g., 6.5" step="0.1"></div>
<div class="form-group"><label class="form-label">ECG Changes?</label>
<select class="form-select" id="inputHyperKECG">
<option value="none">None</option>
<option value="peaked">Peaked T</option>
<option value="wide">Wide QRS</option>
</select></div>
</div>
<button class="calc-btn danger" onclick="calcHyperK(event)">Get Protocol</button>
<div id="resultHyperK" class="result-box hidden"></div>
</div>
</div>

<!-- ANAPHYLAXIS -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">üíâ</div>
<div><div class="tool-title">Anaphylaxis<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Severe allergic reaction</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-group"><label class="form-label">Age Group</label>
<select class="form-select" id="inputAnapAge">
<option value="adult">Adult (&gt;12y)</option>
<option value="child">Child 6-12y</option>
<option value="infant">Child &lt;6y</option>
</select></div>
<button class="calc-btn danger" onclick="calcAnap(event)">Get Protocol</button>
<div id="resultAnap" class="result-box hidden"></div>
</div>
</div>

<!-- SEPSIS -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ü¶†</div>
<div><div class="tool-title">Sepsis<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Hour-1 Bundle</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Lactate</label><input type="number" class="form-input" id="inputSepsisLactate" placeholder="mmol/L" step="0.1"></div>
<div class="form-group"><label class="form-label">MAP</label><input type="number" class="form-input" id="inputSepsisMAP" placeholder="mmHg"></div>
</div>
<button class="calc-btn danger" onclick="calcSepsis(event)">Get Bundle</button>
<div id="resultSepsis" class="result-box hidden"></div>
</div>
</div>

<!-- DKA -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">üíß</div>
<div><div class="tool-title">DKA<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Diabetic ketoacidosis</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">pH</label><input type="number" class="form-input" id="inputDKApH" placeholder="e.g., 7.15" step="0.01"></div>
<div class="form-group"><label class="form-label">K+ (mmol/L)</label><input type="number" class="form-input" id="inputDKAK" placeholder="e.g., 5.2" step="0.1"></div>
</div>
<button class="calc-btn danger" onclick="calcDKA(event)">Get Protocol</button>
<div id="resultDKA" class="result-box hidden"></div>
</div>
</div>

<!-- PRN MEDICATIONS -->
<div class="tool-card" data-category="prn">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">üíä</div>
<div><div class="tool-title">PRN Medications</div><div class="tool-subtitle">As-needed prescriptions</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="prn-grid">
<div class="prn-card" onclick="showPRN('pain',this)"><div class="prn-icon">üò£</div><div class="prn-name">Pain</div></div>
<div class="prn-card" onclick="showPRN('nausea',this)"><div class="prn-icon">ü§¢</div><div class="prn-name">Nausea</div></div>
<div class="prn-card" onclick="showPRN('fever',this)"><div class="prn-icon">üå°Ô∏è</div><div class="prn-name">Fever</div></div>
<div class="prn-card" onclick="showPRN('sleep',this)"><div class="prn-icon">üò¥</div><div class="prn-name">Sleep</div></div>
<div class="prn-card" onclick="showPRN('anxiety',this)"><div class="prn-icon">üò∞</div><div class="prn-name">Anxiety</div></div>
<div class="prn-card" onclick="showPRN('constipation',this)"><div class="prn-icon">üí©</div><div class="prn-name">Constipation</div></div>
<div class="prn-card" onclick="showPRN('itch',this)"><div class="prn-icon">üñêÔ∏è</div><div class="prn-name">Itch</div></div>
<div class="prn-card" onclick="showPRN('heartburn',this)"><div class="prn-icon">üî•</div><div class="prn-name">Heartburn</div></div>
<div class="prn-card" onclick="showPRN('agitation',this)"><div class="prn-icon">üò§</div><div class="prn-name">Agitation</div></div>
<div class="prn-card" onclick="showPRN('htn',this)"><div class="prn-icon">üìà</div><div class="prn-name">HTN</div></div>
<div class="prn-card" onclick="showPRN('wheeze',this)"><div class="prn-icon">üå¨Ô∏è</div><div class="prn-name">Wheeze</div></div>
<div class="prn-card" onclick="showPRN('diarrhea',this)"><div class="prn-icon">üöΩ</div><div class="prn-name">Diarrhea</div></div>
</div>
<div id="prnDetails" class="prn-details"></div>
</div>
</div>

<!-- POTASSIUM -->
<div class="tool-card" data-category="lytes">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">üß™</div>
<div><div class="tool-title">K+ Correction</div><div class="tool-subtitle">Replacement dosing</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-group"><label class="form-label">K+ (mmol/L)</label><input type="number" class="form-input" id="inputK" placeholder="e.g., 3.2" step="0.1"></div>
<button class="calc-btn" onclick="calcK(event)">Calculate</button>
<div id="resultK" class="result-box hidden"></div>
</div>
</div>

<!-- CALCIUM -->
<div class="tool-card" data-category="lytes">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ü¶¥</div>
<div><div class="tool-title">Corrected Ca</div><div class="tool-subtitle">Albumin adjustment</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Ca (mmol/L)</label><input type="number" class="form-input" id="inputCa" placeholder="e.g., 2.0" step="0.01"></div>
<div class="form-group"><label class="form-label">Albumin (g/L)</label><input type="number" class="form-input" id="inputAlb" placeholder="e.g., 28"></div>
</div>
<button class="calc-btn" onclick="calcCa(event)">Calculate</button>
<div id="resultCa" class="result-box hidden"></div>
</div>
</div>

<!-- eGFR -->
<div class="tool-card" data-category="renal">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ü´ò</div>
<div><div class="tool-title">eGFR</div><div class="tool-subtitle">CKD-EPI 2021</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Cr (¬µmol/L)</label><input type="number" class="form-input" id="inputCr" placeholder="e.g., 120"></div>
<div class="form-group"><label class="form-label">Age</label><input type="number" class="form-input" id="inputAge" placeholder="years"></div>
</div>
<div class="form-group"><label class="form-label">Sex</label>
<div class="gender-buttons">
<button class="gender-btn" onclick="setGFRSex('m',this,event)">‚ôÇÔ∏è Male</button>
<button class="gender-btn" onclick="setGFRSex('f',this,event)">‚ôÄÔ∏è Female</button>
</div></div>
<button class="calc-btn" onclick="calcEGFR(event)">Calculate</button>
<div id="resultEGFR" class="result-box hidden"></div>
</div>
</div>

<!-- QTc -->
<div class="tool-card" data-category="cardiac">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">‚ù§Ô∏è</div>
<div><div class="tool-title">QTc</div><div class="tool-subtitle">Bazett formula</div></div>
</div>
<div class="tool-chevron">‚ñº</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">QT (ms)</label><input type="number" class="form-input" id="inputQT" placeholder="e.g., 400"></div>
<div class="form-group"><label class="form-label">HR (bpm)</label><input type="number" class="form-input" id="inputHR" placeholder="e.g., 80"></div>
</div>
<button class="calc-btn" onclick="calcQTc(event)">Calculate</button>
<div id="resultQTc" class="result-box hidden"></div>
</div>
</div>

<!-- AI ASSISTANT -->
<div class="ai-section" data-category="ai">
<div class="ai-header">
<div class="ai-icon">ü§ñ</div>
<div><div class="ai-title">AI Assistant</div><div class="ai-subtitle">Kuwait SI Units</div></div>
</div>
<div class="ai-body">
<div class="ai-prompts">
<button class="ai-prompt-btn" onclick="setPrompt('Hyperkalemia ECG changes')">Hyperkalemia</button>
<button class="ai-prompt-btn" onclick="setPrompt('DKA protocol')">DKA</button>
<button class="ai-prompt-btn" onclick="setPrompt('Neutropenic fever')">Neutropenic Fever</button>
<button class="ai-prompt-btn" onclick="setPrompt('GI bleed workup')">GI Bleed</button>
</div>
<div class="ai-input-row">
<input type="text" class="ai-input" id="aiInput" placeholder="Ask a clinical question...">
<button class="ai-send-btn" onclick="askAI()">‚û§</button>
</div>
<div class="ai-response" id="aiResponse"></div>
</div>
</div>

<!-- QUICK REFERENCE -->
<div class="section-label">Quick Reference</div>
<div class="quick-ref-grid">
<div class="quick-ref-card" onclick="showRef('K+: 3.5-5.0 mmol/L')"><div class="quick-ref-icon">üß™</div><div class="quick-ref-title">K+</div><div class="quick-ref-value">3.5-5.0</div></div>
<div class="quick-ref-card" onclick="showRef('Na+: 136-145 mmol/L')"><div class="quick-ref-icon">üßÇ</div><div class="quick-ref-title">Na+</div><div class="quick-ref-value">136-145</div></div>
<div class="quick-ref-card" onclick="showRef('Ca: 2.1-2.6 mmol/L')"><div class="quick-ref-icon">ü¶¥</div><div class="quick-ref-title">Ca</div><div class="quick-ref-value">2.1-2.6</div></div>
<div class="quick-ref-card" onclick="showRef('Glucose: 3.9-5.6 mmol/L')"><div class="quick-ref-icon">üç¨</div><div class="quick-ref-title">Glc</div><div class="quick-ref-value">3.9-5.6</div></div>
</div>
</div>

<nav class="bottom-nav">
<div class="nav-item" onclick="goBack()"><div class="nav-icon">üè†</div><span>Home</span></div>
<div class="nav-item active"><div class="nav-icon">‚ö°</div><span>OnCall</span></div>
<div class="nav-item" onclick="filterCategory('emergency',this)"><div class="nav-icon">üö®</div><span>Emergency</span></div>
<div class="nav-item" onclick="scrollToAI()"><div class="nav-icon">ü§ñ</div><span>AI</span></div>
</nav>

<script>
var apiUrl='https://script.google.com/macros/s/AKfycbznXa9YNna26Srt1eZVEnSV-dIiubFLTwg3ryLdE-maGNCQhydP_8E6AK4QPXkeQrw7lA/exec';
var gfrSex='';

// Initialize theme
var savedTheme=localStorage.getItem('oncall-theme')||'light';
document.documentElement.setAttribute('data-theme',savedTheme);
document.getElementById('themeBtn').textContent=savedTheme==='dark'?'‚òÄÔ∏è':'üåô';

function toggleTheme(){
  var t=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem('oncall-theme',t);
  document.getElementById('themeBtn').textContent=t==='dark'?'‚òÄÔ∏è':'üåô';
}

function goBack(){
  if(window.opener||window.history.length<=1){
    window.location.href='/';
  }else{
    window.history.back();
  }
}

function scrollToAI(){
  document.querySelector('.ai-section').scrollIntoView({behavior:'smooth'});
}

function filterCategory(cat,btn){
  var pills=document.querySelectorAll('.pill');
  for(var i=0;i<pills.length;i++){pills[i].classList.remove('active');}
  if(btn)btn.classList.add('active');
  var cards=document.querySelectorAll('.tool-card,.ai-section');
  for(var i=0;i<cards.length;i++){
    var c=cards[i];
    var cats=c.getAttribute('data-category');
    if(cat==='all'||(cats&&cats.indexOf(cat)>=0)){
      c.style.display='block';
    }else{
      c.style.display='none';
    }
  }
}

function toggleTool(header){
  var card=header.parentElement;
  if(card){card.classList.toggle('expanded');}
}

function setGFRSex(s,btn,e){
  if(e)e.stopPropagation();
  gfrSex=s;
  var btns=btn.parentElement.querySelectorAll('.gender-btn');
  for(var i=0;i<btns.length;i++){btns[i].classList.remove('selected');}
  btn.classList.add('selected');
}

function showRef(text){alert(text);}
function setPrompt(t){document.getElementById('aiInput').value=t;}

var prnData={
  pain:'üò£ PAIN\n\nMild: Paracetamol 1g PO q6h (max 4g/day)\nModerate: Tramadol 50-100mg PO q6h\nSevere: Morphine 2.5-5mg IV q4h\n\n‚ö†Ô∏è Reduce opioids in elderly/renal',
  nausea:'ü§¢ NAUSEA\n\n1st: Ondansetron 4-8mg IV/PO q8h\nAlt: Metoclopramide 10mg q8h\n\n‚ö†Ô∏è Avoid metoclopramide >5 days',
  fever:'üå°Ô∏è FEVER\n\nParacetamol 1g PO/IV q6h\nIbuprofen 400mg PO q6-8h\n\n‚ö†Ô∏è Avoid NSAIDs in renal/GI',
  sleep:'üò¥ SLEEP\n\nMelatonin 3-5mg PO hs\nZopiclone 3.75-7.5mg hs\n\n‚ö†Ô∏è Avoid benzos in elderly',
  anxiety:'üò∞ ANXIETY\n\nHydroxyzine 25-50mg PO q6h\nLorazepam 0.5-1mg PO/SL q6h\n\n‚ö†Ô∏è Benzos worsen delirium',
  constipation:'üí© CONSTIPATION\n\nLactulose 15-30mL PO BD\nSenna 15mg PO hs\nBisacodyl 10mg PR\n\n‚ö†Ô∏è Rule out obstruction',
  itch:'üñêÔ∏è ITCH\n\nCetirizine 10mg PO daily\nChlorpheniramine 4mg q6h\n\n‚ö†Ô∏è Sedating in elderly',
  heartburn:'üî• HEARTBURN\n\nGaviscon 10-20mL PRN\nOmeprazole 20-40mg daily\n\n‚ö†Ô∏è Long-term PPI risks',
  agitation:'üò§ AGITATION\n\n‚ö†Ô∏è Verbal de-escalation first!\n\nPO: Olanzapine 5-10mg OR Lorazepam 1-2mg\nIM: Haloperidol 5mg + Lorazepam 2mg\n\nüö® NEVER IM olanzapine with benzos',
  htn:'üìà HYPERTENSION\n\nMild: Amlodipine 5mg PO\nModerate: Labetalol 100-200mg PO\nSevere: Labetalol 20mg IV\n\n‚ö†Ô∏è Rule out emergency first',
  wheeze:'üå¨Ô∏è WHEEZE\n\nSalbutamol 2.5-5mg neb q20min x3\nIpratropium 500mcg neb\nHydrocortisone 100mg IV\n\n‚ö†Ô∏è Continuous nebs if severe',
  diarrhea:'üöΩ DIARRHEA\n\nRehydrate first!\nLoperamide 4mg then 2mg PRN\n\nüö® AVOID if bloody/fever/C.diff'
};

function showPRN(type,card){
  var cards=document.querySelectorAll('.prn-card');
  for(var i=0;i<cards.length;i++){cards[i].classList.remove('active');}
  card.classList.add('active');
  var det=document.getElementById('prnDetails');
  det.innerHTML='<pre style="white-space:pre-wrap;font-family:inherit;">'+prnData[type]+'</pre>';
  det.classList.add('visible');
}

function calcHypo(e){
  if(e)e.stopPropagation();
  var g=parseFloat(document.getElementById('inputHypoGlucose').value);
  var s=document.getElementById('inputHypoStatus').value;
  var box=document.getElementById('resultHypo');
  if(!g){alert('Enter glucose');return;}
  box.className='result-box';
  if(g>=3.9){
    box.className+=' success';
    box.innerHTML='<div class="result-title">‚úì Normal</div><div class="result-content">'+g+' mmol/L is normal</div>';
  }else if(s==='unconscious'){
    box.className+=' danger';
    box.innerHTML='<div class="result-title">üö® SEVERE</div><div class="result-content"><strong>D50 25-50mL IV</strong> or Glucagon 1mg IM<br><br>Recheck 15min, repeat if &lt;3.9</div>';
  }else if(s==='confused'){
    box.className+=' warning';
    box.innerHTML='<div class="result-title">‚ö†Ô∏è Moderate</div><div class="result-content"><strong>Glucose gel 15-20g</strong> buccal<br><br>If no response: D50 25mL IV</div>';
  }else{
    box.innerHTML='<div class="result-title">üìã Mild</div><div class="result-content"><strong>15-20g fast carbs</strong><br>Juice, glucose tabs, honey<br><br>Recheck 15min</div>';
  }
}

function calcHyperK(e){
  if(e)e.stopPropagation();
  var k=parseFloat(document.getElementById('inputHyperK').value);
  var ecg=document.getElementById('inputHyperKECG').value;
  var box=document.getElementById('resultHyperK');
  if(!k){alert('Enter K+');return;}
  box.className='result-box';
  if(k<5.5&&ecg==='none'){
    box.className+=' success';
    box.innerHTML='<div class="result-title">‚úì Normal</div><div class="result-content">Review meds</div>';
  }else{
    var severe=k>=6.5||ecg!=='none';
    box.className+=' '+(severe?'danger':'warning');
    box.innerHTML='<div class="result-title">'+(severe?'üö® EMERGENCY':'‚ö†Ô∏è Moderate')+' K+ '+k+'</div><div class="result-content">'+(ecg!=='none'?'<strong>‚ö° ECG CHANGES - Treat NOW</strong><br><br>':'')+'<strong>1. Ca Gluconate 10% 10mL IV</strong> (2-3min)<br><br><strong>2. Insulin 10U + D50 25g IV</strong><br>Salbutamol 10-20mg neb<br><br><strong>3. Furosemide 40-80mg IV</strong></div>';
  }
}

function calcAnap(e){
  if(e)e.stopPropagation();
  var age=document.getElementById('inputAnapAge').value;
  var box=document.getElementById('resultAnap');
  box.className='result-box danger';
  var dose=age==='adult'?'0.5mg (0.5mL 1:1000)':age==='child'?'0.3mg (0.3mL 1:1000)':'0.15mg (0.15mL 1:1000)';
  box.innerHTML='<div class="result-title">üö® ANAPHYLAXIS</div><div class="result-content"><strong>üíâ ADRENALINE FIRST!</strong><br><br><strong>'+dose+' IM thigh</strong><br>Repeat q5min PRN<br><br>Lie flat, elevate legs<br>High-flow O2<br>NS 20mL/kg if hypotensive</div>';
}

function calcSepsis(e){
  if(e)e.stopPropagation();
  var lac=parseFloat(document.getElementById('inputSepsisLactate').value);
  var map=parseFloat(document.getElementById('inputSepsisMAP').value);
  var box=document.getElementById('resultSepsis');
  var shock=(map&&map<65)||(lac&&lac>2);
  box.className='result-box '+(shock?'danger':'warning');
  box.innerHTML='<div class="result-title">'+(shock?'üö® SEPTIC SHOCK':'‚ö†Ô∏è SEPSIS')+' Hour-1</div><div class="result-content"><strong>1. Lactate</strong> '+(lac?lac+' mmol/L':'Draw NOW')+'<br><br><strong>2. Blood Cx x2</strong> before abx<br><br><strong>3. Pip-Tazo 4.5g IV</strong> within 1hr<br><br><strong>4. NS 30mL/kg</strong> if hypotensive</div>';
}

function calcDKA(e){
  if(e)e.stopPropagation();
  var pH=parseFloat(document.getElementById('inputDKApH').value);
  var k=parseFloat(document.getElementById('inputDKAK').value);
  var box=document.getElementById('resultDKA');
  var severe=pH&&pH<7.0;
  box.className='result-box '+(severe?'danger':'warning');
  var kMsg=k?((k<3.3)?'üö® HOLD insulin until K+>3.3!':(k<5.3)?'Add 20-30 mEq KCl/L':'No K+ initially'):'Check K+ first';
  box.innerHTML='<div class="result-title">'+(severe?'üö® SEVERE DKA':'‚ö†Ô∏è DKA')+(pH?' pH '+pH:'')+'</div><div class="result-content"><strong>1. NS 1-1.5L/hr</strong> x1h<br><br><strong>2. Insulin 0.1 U/kg/hr</strong><br><br><strong>3. K+:</strong> '+kMsg+'<br><br>BG q1h, lytes q2-4h</div>';
}

function calcK(e){
  if(e)e.stopPropagation();
  var k=parseFloat(document.getElementById('inputK').value);
  var box=document.getElementById('resultK');
  if(!k){alert('Enter K+');return;}
  box.className='result-box';
  if(k<2.5){box.className+=' danger';box.innerHTML='<div class="result-title">üö® Critical</div><div class="result-content"><strong>40 mEq/hr IV central</strong><br>Cardiac monitor</div>';}
  else if(k<3.0){box.className+=' warning';box.innerHTML='<div class="result-title">‚ö†Ô∏è Moderate</div><div class="result-content"><strong>40 mEq KCl PO/IV</strong><br>Recheck 4h</div>';}
  else if(k<3.5){box.innerHTML='<div class="result-title">üìã Mild</div><div class="result-content"><strong>40 mEq KCl PO</strong><br>Recheck AM</div>';}
  else if(k>5.5){box.className+=' danger';box.innerHTML='<div class="result-title">üö® High</div><div class="result-content">Use Hyperkalemia tool!</div>';}
  else{box.className+=' success';box.innerHTML='<div class="result-title">‚úì Normal</div><div class="result-content">'+k+' mmol/L</div>';}
}

function calcCa(e){
  if(e)e.stopPropagation();
  var ca=parseFloat(document.getElementById('inputCa').value);
  var alb=parseFloat(document.getElementById('inputAlb').value);
  var box=document.getElementById('resultCa');
  if(!ca||!alb){alert('Enter values');return;}
  var corr=(ca+0.02*(40-alb)).toFixed(2);
  box.className='result-box';
  if(corr<1.9){box.className+=' danger';box.innerHTML='<div class="result-title">üö® Severe Hypocalcemia</div><div class="result-content">Corrected: <strong>'+corr+'</strong><br>Ca Gluconate 1-2g IV</div>';}
  else if(corr<2.1){box.className+=' warning';box.innerHTML='<div class="result-title">‚ö†Ô∏è Low</div><div class="result-content">Corrected: <strong>'+corr+'</strong></div>';}
  else if(corr>3.0){box.className+=' danger';box.innerHTML='<div class="result-title">üö® Severe Hypercalcemia</div><div class="result-content">Corrected: <strong>'+corr+'</strong><br>IV NS aggressively</div>';}
  else if(corr>2.6){box.className+=' warning';box.innerHTML='<div class="result-title">‚ö†Ô∏è High</div><div class="result-content">Corrected: <strong>'+corr+'</strong></div>';}
  else{box.className+=' success';box.innerHTML='<div class="result-title">‚úì Normal</div><div class="result-content">Corrected: '+corr+'</div>';}
}

function calcEGFR(e){
  if(e)e.stopPropagation();
  var cr=parseFloat(document.getElementById('inputCr').value);
  var age=parseFloat(document.getElementById('inputAge').value);
  var box=document.getElementById('resultEGFR');
  if(!cr||!age||!gfrSex){alert('Enter all values');return;}
  var crMg=cr/88.4;
  var egfr;
  if(gfrSex==='f'){egfr=142*Math.pow(Math.min(crMg/0.7,1),-0.241)*Math.pow(Math.max(crMg/0.7,1),-1.2)*Math.pow(0.9938,age)*1.012;}
  else{egfr=142*Math.pow(Math.min(crMg/0.9,1),-0.302)*Math.pow(Math.max(crMg/0.9,1),-1.2)*Math.pow(0.9938,age);}
  egfr=Math.round(egfr);
  box.className='result-box';
  var stage;
  if(egfr>=90){stage='G1';box.className+=' success';}
  else if(egfr>=60){stage='G2';box.className+=' success';}
  else if(egfr>=45){stage='G3a';box.className+=' warning';}
  else if(egfr>=30){stage='G3b';box.className+=' warning';}
  else if(egfr>=15){stage='G4';box.className+=' danger';}
  else{stage='G5';box.className+=' danger';}
  box.innerHTML='<div class="result-title">eGFR: '+egfr+'</div><div class="result-content">CKD Stage: '+stage+'</div>';
}

function calcQTc(e){
  if(e)e.stopPropagation();
  var qt=parseFloat(document.getElementById('inputQT').value);
  var hr=parseFloat(document.getElementById('inputHR').value);
  var box=document.getElementById('resultQTc');
  if(!qt||!hr){alert('Enter values');return;}
  var qtc=Math.round(qt/Math.sqrt(60/hr));
  box.className='result-box';
  if(qtc>500){box.className+=' danger';box.innerHTML='<div class="result-title">üö® '+qtc+'ms</div><div class="result-content">HIGH TdP risk<br>STOP QT drugs</div>';}
  else if(qtc>470){box.className+=' warning';box.innerHTML='<div class="result-title">‚ö†Ô∏è '+qtc+'ms</div><div class="result-content">Prolonged</div>';}
  else if(qtc>440){box.innerHTML='<div class="result-title">üìã '+qtc+'ms</div><div class="result-content">Borderline</div>';}
  else{box.className+=' success';box.innerHTML='<div class="result-title">‚úì '+qtc+'ms</div><div class="result-content">Normal</div>';}
}

function parseMarkdown(text){
  // Convert markdown tables to HTML
  text = text.replace(/\n\|(.+)\|\n\|[-:| ]+\|\n([\s\S]*?)(?=\n\n|\n[^|]|$)/g, function(match, header, body) {
    var headers = header.split('|').map(function(h){return h.trim();}).filter(Boolean);
    var headerHtml = '<tr>' + headers.map(function(h){return '<th style="padding:8px 12px;text-align:left;border-bottom:2px solid var(--border);font-weight:600;">'+h+'</th>';}).join('') + '</tr>';
    var rows = body.trim().split('\n').map(function(row){
      var cells = row.split('|').map(function(c){return c.trim();}).filter(Boolean);
      return '<tr>' + cells.map(function(c){return '<td style="padding:8px 12px;border-bottom:1px solid var(--border);">'+c+'</td>';}).join('') + '</tr>';
    }).join('');
    return '<table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:0.85rem;">'+headerHtml+rows+'</table>';
  });
  // Headers
  text = text.replace(/^### (.+)$/gm, '<h4 style="font-size:0.95rem;font-weight:700;margin:16px 0 8px;color:var(--primary);">$1</h4>');
  text = text.replace(/^## (.+)$/gm, '<h3 style="font-size:1.05rem;font-weight:700;margin:20px 0 10px;color:var(--text);">$1</h3>');
  text = text.replace(/^# (.+)$/gm, '<h2 style="font-size:1.15rem;font-weight:700;margin:0 0 12px;color:var(--primary-dark);">$1</h2>');
  // Bold and italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Horizontal rule
  text = text.replace(/^---$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">');
  // Lists
  text = text.replace(/^\* (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;">$1</li>');
  text = text.replace(/^- (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;">$1</li>');
  text = text.replace(/^(\d+)\. (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;list-style-type:decimal;">$2</li>');
  // Line breaks
  text = text.replace(/\n\n/g, '</p><p style="margin:12px 0;">');
  text = text.replace(/\n/g, '<br>');
  return '<p style="margin:0;">'+text+'</p>';
}

function askAI(){
  var input=document.getElementById('aiInput');
  var resp=document.getElementById('aiResponse');
  var q=input.value;
  if(!q){alert('Enter question');return;}
  resp.className='ai-response visible';
  resp.innerHTML='<div class="ai-response-header"><span class="ai-response-label">Loading...</span></div><div class="ai-response-body"><div class="ai-loading"><div class="ai-loading-spinner"></div></div></div>';
  fetch(apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'oncallAskClinical',question:q})})
  .then(function(r){return r.json();})
  .then(function(d){
    var ans=d.answer||d.response||'No response';
    ans=parseMarkdown(ans);
    resp.innerHTML='<div class="ai-response-header"><span class="ai-response-label">Response</span></div><div class="ai-response-body">'+ans+'</div>';
    input.value='';
  })
  .catch(function(err){
    resp.innerHTML='<div class="ai-response-header"><span class="ai-response-label" style="color:var(--danger)">Error</span></div><div class="ai-response-body">'+err.message+'</div>';
  });
}

document.getElementById('aiInput').onkeydown=function(e){if(e.keyCode===13)askAI();};
</script>
</body>
</html>
