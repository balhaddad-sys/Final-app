<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>OnCall Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--primary:#0f766e;--primary-dark:#115e59;--primary-light:#ccfbf1;--danger:#dc2626;--danger-light:#fef2f2;--warning:#d97706;--warning-light:#fffbeb;--success:#059669;--success-light:#d1fae5;--bg:#f8fafc;--bg-card:#fff;--text:#0f172a;--text-secondary:#475569;--text-muted:#94a3b8;--border:#e2e8f0;--radius:16px}
[data-theme="dark"]{--primary:#2dd4bf;--primary-dark:#14b8a6;--primary-light:#134e4a;--danger:#f87171;--danger-light:#450a0a;--warning:#fbbf24;--warning-light:#451a03;--success:#4ade80;--success-light:#14532d;--bg:#0f172a;--bg-card:#1e293b;--text:#f1f5f9;--text-secondary:#cbd5e1;--text-muted:#64748b;--border:#334155}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
.app-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 20px;position:sticky;top:0;z-index:100}
.header-row{display:flex;align-items:center;justify-content:space-between;max-width:800px;margin:0 auto}
.header-brand{display:flex;align-items:center;gap:12px}
.header-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
.header-title{font-weight:700;font-size:1.1rem}
.header-subtitle{font-size:.75rem;color:var(--text-muted)}
.header-actions{display:flex;gap:8px}
.icon-btn{width:44px;height:44px;border-radius:10px;border:1px solid var(--border);background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem}
.main-content{max-width:800px;margin:0 auto;padding:20px;padding-bottom:100px}
.category-pills{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:20px}
.pill{flex-shrink:0;padding:10px 18px;border-radius:20px;font-size:.8rem;font-weight:600;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer}
.pill.active{background:var(--primary);border-color:var(--primary);color:#fff}
.tool-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;overflow:hidden}
.tool-card.emergency{border-left:4px solid var(--danger)}
.tool-header{padding:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.tool-header-left{display:flex;align-items:center;gap:12px}
.tool-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;background:var(--bg);border:1px solid var(--border)}
.tool-title{font-weight:700;font-size:.95rem}
.tool-subtitle{font-size:.8rem;color:var(--text-muted)}
.tool-badge{padding:3px 8px;border-radius:6px;font-size:.65rem;font-weight:700;text-transform:uppercase;margin-left:8px}
.tool-badge.urgent{background:var(--danger-light);color:var(--danger)}
.tool-chevron{width:28px;height:28px;border-radius:8px;background:var(--bg);display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:transform .3s}
.tool-card.expanded .tool-chevron{transform:rotate(180deg);color:var(--primary)}
.tool-content{display:none;padding:0 16px 16px}
.tool-card.expanded .tool-content{display:block}
.tool-divider{height:1px;background:var(--border);margin-bottom:16px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:.75rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase}
.form-input,.form-select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:var(--bg);color:var(--text);-webkit-appearance:none}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:400px){.form-row{grid-template-columns:1fr}}
.gender-buttons{display:flex;gap:10px}
.gender-btn{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;background:var(--bg);font-size:.9rem;font-weight:600;cursor:pointer;color:var(--text-secondary)}
.gender-btn.selected{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.calc-btn{width:100%;padding:14px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:.95rem;font-weight:600;cursor:pointer}
.calc-btn.danger{background:var(--danger)}
.result-box{margin-top:16px;padding:16px;border-radius:12px;background:var(--bg);border:1px solid var(--border)}
.result-box.danger{background:var(--danger-light);border-color:var(--danger)}
.result-box.warning{background:var(--warning-light);border-color:var(--warning)}
.result-box.success{background:var(--success-light);border-color:var(--success)}
.result-title{font-weight:700;font-size:1rem;margin-bottom:8px}
.result-box.danger .result-title{color:var(--danger)}
.result-box.warning .result-title{color:var(--warning)}
.result-box.success .result-title{color:var(--success)}
.result-content{font-size:.9rem;color:var(--text-secondary);line-height:1.7}
.protocol-step{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px;border-left:3px solid var(--primary)}
.protocol-step.danger{border-left-color:var(--danger);background:var(--danger-light)}
.protocol-step.warning{border-left-color:var(--warning);background:var(--warning-light)}
.protocol-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.protocol-number{width:24px;height:24px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem}
.protocol-step.danger .protocol-number{background:var(--danger)}
.protocol-step.warning .protocol-number{background:var(--warning)}
.protocol-title{font-weight:700;font-size:.9rem}
.protocol-content{font-size:.85rem;color:var(--text-secondary);margin-left:34px}
.prn-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:500px){.prn-grid{grid-template-columns:repeat(2,1fr)}}
.prn-card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 8px;cursor:pointer;text-align:center}
.prn-card.active{border-color:var(--primary);background:var(--primary-light)}
.prn-icon{font-size:1.5rem;margin-bottom:6px}
.prn-name{font-weight:700;font-size:.8rem}
.prn-indication{font-size:.65rem;color:var(--text-muted)}
.prn-details{display:none;margin-top:16px;padding:16px;background:var(--bg);border-radius:12px;border:1px solid var(--border)}
.prn-details.visible{display:block}
.prn-dose-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
.prn-dose-row:last-child{border-bottom:none}
.prn-dose-label{font-size:.85rem;color:var(--text-secondary)}
.prn-dose-value{font-weight:600;font-size:.9rem}
.prn-warning{margin-top:12px;padding:10px;background:var(--warning-light);border-radius:8px;font-size:.8rem;color:var(--warning)}
.prn-danger{margin-top:12px;padding:10px;background:var(--danger-light);border-radius:8px;font-size:.8rem;color:var(--danger)}
.ai-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:12px}
.ai-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.ai-icon{width:44px;height:44px;background:linear-gradient(135deg,#0f766e,#115e59);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
.ai-title{font-weight:700;font-size:1rem}
.ai-subtitle{font-size:.8rem;color:var(--text-muted)}
.ai-body{padding:16px}
.ai-prompts{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.ai-prompt-btn{padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:20px;font-size:.75rem;font-weight:500;color:var(--text-secondary);cursor:pointer}
.ai-input-row{display:flex;gap:10px}
.ai-input{flex:1;min-width:0;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:var(--bg);color:var(--text)}
.ai-send-btn{width:50px;height:50px;border-radius:12px;background:var(--primary);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ai-response{display:none;margin-top:16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.ai-response.visible{display:block}
.ai-response-header{padding:12px 16px;background:var(--primary-light);border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.ai-response-label{font-size:.75rem;font-weight:600;color:var(--primary);text-transform:uppercase}
.ai-response-time{font-size:.75rem;color:var(--text-muted)}
.ai-response-body{padding:16px;font-size:.9rem;line-height:1.8;max-height:50vh;overflow-y:auto}
.ai-alert{padding:12px;border-radius:10px;margin:12px 0;display:flex;align-items:flex-start;gap:10px}
.ai-alert.danger{background:var(--danger-light);border:1px solid var(--danger)}
.ai-alert-icon{font-size:1.1rem}
.ai-alert-content{font-size:.85rem;line-height:1.5}
.ai-alert.danger .ai-alert-content{color:var(--danger)}
.ai-loading{display:flex;align-items:center;justify-content:center;gap:12px;padding:30px;color:var(--text-muted)}
.ai-loading-spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.quick-ref-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px;margin-bottom:20px}
@media(max-width:500px){.quick-ref-grid{grid-template-columns:repeat(2,1fr)}}
.quick-ref-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
.quick-ref-card:hover{border-color:var(--primary);transform:translateY(-2px)}
.quick-ref-icon{font-size:1.3rem;margin-bottom:6px}
.quick-ref-title{font-weight:600;font-size:.8rem;margin-bottom:2px}
.quick-ref-value{font-size:.7rem;color:var(--text-muted)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:8px 16px;padding-bottom:calc(8px + env(safe-area-inset-bottom));display:flex;justify-content:space-around;z-index:1000}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 20px;border-radius:12px;cursor:pointer;color:var(--text-muted);font-size:.7rem;font-weight:600;text-decoration:none;transition:all 0.2s}
a.nav-item{color:var(--text-muted)}
.nav-item:hover{color:var(--primary)}
.nav-item.active{color:var(--primary);background:var(--primary-light)}
.nav-icon{font-size:1.3rem}
.hidden{display:none!important}
.section-label{font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;margin-top:24px}
/* Handover & Consultation Styles */
.handover-framework{padding:0}
.checklist-section{margin-bottom:16px;padding:14px;background:var(--bg);border-radius:10px}
.checklist-title{font-weight:700;font-size:.85rem;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.checklist-item{display:flex;align-items:flex-start;gap:10px;padding:8px 0;font-size:.85rem;border-bottom:1px solid var(--border)}
.checklist-item:last-child{border-bottom:none}
.checklist-box{font-size:1rem;color:var(--primary)}
.consult-box{background:var(--bg);border-radius:10px;padding:14px;margin-bottom:12px;border-left:3px solid var(--primary)}
.consult-box.critical{border-left-color:var(--danger);background:var(--danger-light)}
.consult-box.warning{border-left-color:var(--warning);background:var(--warning-light)}
.consult-title{font-weight:700;font-size:.9rem;margin-bottom:10px;color:var(--text)}
.consult-box.critical .consult-title{color:var(--danger)}
.consult-box.warning .consult-title{color:var(--warning)}
.consult-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:400px){.consult-grid{grid-template-columns:1fr}}
.consult-item{font-size:.8rem;padding:8px;background:var(--bg-card);border-radius:6px;border:1px solid var(--border)}
/* Handover Cards - Blue theme */
.handover-card{border-left:4px solid #3b82f6;background:linear-gradient(to right,rgba(59,130,246,0.05),var(--bg-card))}
.handover-card .tool-header{background:transparent}
/* Consultation Section Intro */
.consult-intro{font-size:.8rem;color:var(--text-muted);margin:-8px 0 16px;padding:10px 14px;background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(236,72,153,0.1));border-radius:10px;border-left:3px solid #8b5cf6}
/* Consultation Cards - Distinct colored left borders */
.consult-card{border-left:4px solid #8b5cf6}
.consult-critical{border-left-color:#dc2626;background:linear-gradient(to right,rgba(220,38,38,0.03),var(--bg-card))}
.consult-surgery{border-left-color:#059669;background:linear-gradient(to right,rgba(5,150,105,0.03),var(--bg-card))}
.consult-cardio{border-left-color:#dc2626;background:linear-gradient(to right,rgba(220,38,38,0.03),var(--bg-card))}
.consult-neuro{border-left-color:#ec4899;background:linear-gradient(to right,rgba(236,72,153,0.03),var(--bg-card))}
.consult-gi{border-left-color:#f59e0b;background:linear-gradient(to right,rgba(245,158,11,0.03),var(--bg-card))}
.consult-renal{border-left-color:#8b5cf6;background:linear-gradient(to right,rgba(139,92,246,0.03),var(--bg-card))}
.consult-pulm{border-left-color:#06b6d4;background:linear-gradient(to right,rgba(6,182,212,0.03),var(--bg-card))}
.consult-id{border-left-color:#84cc16;background:linear-gradient(to right,rgba(132,204,22,0.03),var(--bg-card))}
/* Consult Icon Styles */
.consult-icon-critical{background:linear-gradient(135deg,#dc2626,#991b1b)!important;color:#fff!important;border:none!important}
.consult-icon-surgery{background:linear-gradient(135deg,#059669,#047857)!important;color:#fff!important;border:none!important}
.consult-icon-cardio{background:linear-gradient(135deg,#dc2626,#be123c)!important;color:#fff!important;border:none!important}
.consult-icon-neuro{background:linear-gradient(135deg,#ec4899,#db2777)!important;color:#fff!important;border:none!important}
.consult-icon-gi{background:linear-gradient(135deg,#f59e0b,#d97706)!important;color:#fff!important;border:none!important}
.consult-icon-renal{background:linear-gradient(135deg,#8b5cf6,#7c3aed)!important;color:#fff!important;border:none!important}
.consult-icon-pulm{background:linear-gradient(135deg,#06b6d4,#0891b2)!important;color:#fff!important;border:none!important}
.consult-icon-id{background:linear-gradient(135deg,#84cc16,#65a30d)!important;color:#fff!important;border:none!important}
</style>
</head>
<body>
<header class="app-header">
<div class="header-row">
<div class="header-brand">
<div class="header-logo">ğŸ©º</div>
<div><div class="header-title">OnCall Assistant</div><div class="header-subtitle">Evidence-Based Decision Support</div></div>
</div>
<div class="header-actions">
<button class="icon-btn" id="themeBtn" onclick="toggleTheme()">ğŸŒ™</button>
<button class="icon-btn" id="backBtn" onclick="goBack()">âœ•</button>
</div>
</div>
</header>
<div class="main-content">
<div class="category-pills">
<button class="pill active" onclick="filterCategory('all',this)">All Tools</button>
<button class="pill" onclick="filterCategory('emergency',this)">ğŸš¨ Emergency</button>
<button class="pill" onclick="filterCategory('handover',this)">ğŸ“‹ Handover</button>
<button class="pill" onclick="filterCategory('consult',this)">ğŸ“ Consults</button>
<button class="pill" onclick="filterCategory('prn',this)">ğŸ’Š PRN</button>
<button class="pill" onclick="filterCategory('lytes',this)">ğŸ§ª Lytes</button>
<button class="pill" onclick="filterCategory('cardiac',this)">â¤ï¸ Cardiac</button>
</div>

<!-- HYPOGLYCEMIA -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ¬</div>
<div><div class="tool-title">Hypoglycemia<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Glucose &lt; 3.9 mmol/L</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-group"><label class="form-label">Blood Glucose (mmol/L)</label><input type="number" class="form-input" id="inputHypoGlucose" placeholder="e.g., 2.8" step="0.1"></div>
<div class="form-group"><label class="form-label">Patient Status</label>
<select class="form-select" id="inputHypoStatus">
<option value="conscious">Conscious</option>
<option value="confused">Confused/Drowsy</option>
<option value="unconscious">Unconscious/Seizing</option>
</select></div>
<button class="calc-btn danger" onclick="calcHypo(event)">Get Protocol</button>
<div id="resultHypo" class="result-box hidden"></div>
</div>
</div>

<!-- HYPERKALEMIA -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">âš¡</div>
<div><div class="tool-title">Hyperkalemia<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">K+ &gt; 6.0 mmol/L</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">K+ (mmol/L)</label><input type="number" class="form-input" id="inputHyperK" placeholder="e.g., 6.5" step="0.1"></div>
<div class="form-group"><label class="form-label">ECG Changes?</label>
<select class="form-select" id="inputHyperKECG">
<option value="none">None</option>
<option value="peaked">Peaked T</option>
<option value="wide">Wide QRS</option>
</select></div>
</div>
<button class="calc-btn danger" onclick="calcHyperK(event)">Get Protocol</button>
<div id="resultHyperK" class="result-box hidden"></div>
</div>
</div>

<!-- ANAPHYLAXIS -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ’‰</div>
<div><div class="tool-title">Anaphylaxis<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Severe allergic reaction</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-group"><label class="form-label">Age Group</label>
<select class="form-select" id="inputAnapAge">
<option value="adult">Adult (&gt;12y)</option>
<option value="child">Child 6-12y</option>
<option value="infant">Child &lt;6y</option>
</select></div>
<button class="calc-btn danger" onclick="calcAnap(event)">Get Protocol</button>
<div id="resultAnap" class="result-box hidden"></div>
</div>
</div>

<!-- SEPSIS -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ¦ </div>
<div><div class="tool-title">Sepsis<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Hour-1 Bundle</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Lactate</label><input type="number" class="form-input" id="inputSepsisLactate" placeholder="mmol/L" step="0.1"></div>
<div class="form-group"><label class="form-label">MAP</label><input type="number" class="form-input" id="inputSepsisMAP" placeholder="mmHg"></div>
</div>
<button class="calc-btn danger" onclick="calcSepsis(event)">Get Bundle</button>
<div id="resultSepsis" class="result-box hidden"></div>
</div>
</div>

<!-- DKA -->
<div class="tool-card emergency" data-category="emergency">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ’§</div>
<div><div class="tool-title">DKA<span class="tool-badge urgent">Urgent</span></div><div class="tool-subtitle">Diabetic ketoacidosis</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">pH</label><input type="number" class="form-input" id="inputDKApH" placeholder="e.g., 7.15" step="0.01"></div>
<div class="form-group"><label class="form-label">K+ (mmol/L)</label><input type="number" class="form-input" id="inputDKAK" placeholder="e.g., 5.2" step="0.1"></div>
</div>
<button class="calc-btn danger" onclick="calcDKA(event)">Get Protocol</button>
<div id="resultDKA" class="result-box hidden"></div>
</div>
</div>

<!-- PRN MEDICATIONS -->
<div class="tool-card" data-category="prn">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ’Š</div>
<div><div class="tool-title">PRN Medications</div><div class="tool-subtitle">As-needed prescriptions</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="prn-grid">
<div class="prn-card" onclick="showPRN('pain',this)"><div class="prn-icon">ğŸ˜£</div><div class="prn-name">Pain</div></div>
<div class="prn-card" onclick="showPRN('nausea',this)"><div class="prn-icon">ğŸ¤¢</div><div class="prn-name">Nausea</div></div>
<div class="prn-card" onclick="showPRN('fever',this)"><div class="prn-icon">ğŸŒ¡ï¸</div><div class="prn-name">Fever</div></div>
<div class="prn-card" onclick="showPRN('sleep',this)"><div class="prn-icon">ğŸ˜´</div><div class="prn-name">Sleep</div></div>
<div class="prn-card" onclick="showPRN('anxiety',this)"><div class="prn-icon">ğŸ˜°</div><div class="prn-name">Anxiety</div></div>
<div class="prn-card" onclick="showPRN('constipation',this)"><div class="prn-icon">ğŸ’©</div><div class="prn-name">Constipation</div></div>
<div class="prn-card" onclick="showPRN('itch',this)"><div class="prn-icon">ğŸ–ï¸</div><div class="prn-name">Itch</div></div>
<div class="prn-card" onclick="showPRN('heartburn',this)"><div class="prn-icon">ğŸ”¥</div><div class="prn-name">Heartburn</div></div>
<div class="prn-card" onclick="showPRN('agitation',this)"><div class="prn-icon">ğŸ˜¤</div><div class="prn-name">Agitation</div></div>
<div class="prn-card" onclick="showPRN('htn',this)"><div class="prn-icon">ğŸ“ˆ</div><div class="prn-name">HTN</div></div>
<div class="prn-card" onclick="showPRN('wheeze',this)"><div class="prn-icon">ğŸŒ¬ï¸</div><div class="prn-name">Wheeze</div></div>
<div class="prn-card" onclick="showPRN('diarrhea',this)"><div class="prn-icon">ğŸš½</div><div class="prn-name">Diarrhea</div></div>
</div>
<div id="prnDetails" class="prn-details"></div>
</div>
</div>

<!-- POTASSIUM -->
<div class="tool-card" data-category="lytes">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ§ª</div>
<div><div class="tool-title">K+ Correction</div><div class="tool-subtitle">Replacement dosing</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-group"><label class="form-label">K+ (mmol/L)</label><input type="number" class="form-input" id="inputK" placeholder="e.g., 3.2" step="0.1"></div>
<button class="calc-btn" onclick="calcK(event)">Calculate</button>
<div id="resultK" class="result-box hidden"></div>
</div>
</div>

<!-- CALCIUM -->
<div class="tool-card" data-category="lytes">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ¦´</div>
<div><div class="tool-title">Corrected Ca</div><div class="tool-subtitle">Albumin adjustment</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Ca (mmol/L)</label><input type="number" class="form-input" id="inputCa" placeholder="e.g., 2.0" step="0.01"></div>
<div class="form-group"><label class="form-label">Albumin (g/L)</label><input type="number" class="form-input" id="inputAlb" placeholder="e.g., 28"></div>
</div>
<button class="calc-btn" onclick="calcCa(event)">Calculate</button>
<div id="resultCa" class="result-box hidden"></div>
</div>
</div>

<!-- eGFR -->
<div class="tool-card" data-category="renal">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">ğŸ«˜</div>
<div><div class="tool-title">eGFR</div><div class="tool-subtitle">CKD-EPI 2021</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Cr (Âµmol/L)</label><input type="number" class="form-input" id="inputCr" placeholder="e.g., 120"></div>
<div class="form-group"><label class="form-label">Age</label><input type="number" class="form-input" id="inputAge" placeholder="years"></div>
</div>
<div class="form-group"><label class="form-label">Sex</label>
<div class="gender-buttons">
<button class="gender-btn" onclick="setGFRSex('m',this,event)">â™‚ï¸ Male</button>
<button class="gender-btn" onclick="setGFRSex('f',this,event)">â™€ï¸ Female</button>
</div></div>
<button class="calc-btn" onclick="calcEGFR(event)">Calculate</button>
<div id="resultEGFR" class="result-box hidden"></div>
</div>
</div>

<!-- QTc -->
<div class="tool-card" data-category="cardiac">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon">â¤ï¸</div>
<div><div class="tool-title">QTc</div><div class="tool-subtitle">Bazett formula</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">QT (ms)</label><input type="number" class="form-input" id="inputQT" placeholder="e.g., 400"></div>
<div class="form-group"><label class="form-label">HR (bpm)</label><input type="number" class="form-input" id="inputHR" placeholder="e.g., 80"></div>
</div>
<button class="calc-btn" onclick="calcQTc(event)">Calculate</button>
<div id="resultQTc" class="result-box hidden"></div>
</div>
</div>

<!-- SBAR HANDOVER -->
<div class="section-label" style="margin-top:12px;">ğŸ“‹ HANDOVER TOOLS</div>
<div class="tool-card handover-card" data-category="handover">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;">ğŸ“‹</div>
<div><div class="tool-title">SBAR Handover</div><div class="tool-subtitle">Structured communication</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="handover-framework">
<div class="protocol-step" style="border-left-color:#3b82f6">
<div class="protocol-header"><div class="protocol-number" style="background:#3b82f6">S</div><div class="protocol-title">Situation</div></div>
<div class="protocol-content">"I am calling about [patient name], MRN [X], in [bed/ward]"<br>â€¢ State the problem concisely<br>â€¢ "The patient is [stable/deteriorating/critical]"</div>
</div>
<div class="protocol-step" style="border-left-color:#8b5cf6">
<div class="protocol-header"><div class="protocol-number" style="background:#8b5cf6">B</div><div class="protocol-title">Background</div></div>
<div class="protocol-content">â€¢ Admission diagnosis & date<br>â€¢ Relevant PMHx<br>â€¢ Recent procedures/interventions<br>â€¢ Current medications<br>â€¢ Allergies & code status</div>
</div>
<div class="protocol-step" style="border-left-color:#f59e0b">
<div class="protocol-header"><div class="protocol-number" style="background:#f59e0b">A</div><div class="protocol-title">Assessment</div></div>
<div class="protocol-content">â€¢ Current vitals: HR, BP, RR, SpO2, Temp<br>â€¢ Mental status change?<br>â€¢ Physical exam findings<br>â€¢ Recent labs/imaging<br>â€¢ Your clinical impression</div>
</div>
<div class="protocol-step" style="border-left-color:#10b981">
<div class="protocol-header"><div class="protocol-number" style="background:#10b981">R</div><div class="protocol-title">Recommendation</div></div>
<div class="protocol-content">â€¢ What do you need?<br>â€¢ Specific orders requested<br>â€¢ "I think we should..."<br>â€¢ Clarify response time needed</div>
</div>
</div>
</div>
</div>

<!-- SHIFT HANDOVER CHECKLIST -->
<div class="tool-card handover-card" data-category="handover">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;">âœ…</div>
<div><div class="tool-title">Shift Handover Checklist</div><div class="tool-subtitle">End-of-shift essentials</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="checklist-section">
<div class="checklist-title">ğŸ”´ Critical Items</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Unstable patients & active issues</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Pending critical results (labs, imaging, cultures)</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Time-sensitive medications due</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Pending consults & expected callbacks</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Code status & goals of care discussions</div>
</div>
<div class="checklist-section">
<div class="checklist-title">ğŸŸ¡ Important Updates</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> New admissions & their plans</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Procedures scheduled/completed</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Family meetings pending</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Anticipated discharges</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> PRN orders & parameters</div>
</div>
<div class="checklist-section">
<div class="checklist-title">ğŸŸ¢ Routine</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> IV fluids & drip rates</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Diet orders & restrictions</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> Activity level & fall risk</div>
<div class="checklist-item"><span class="checklist-box">â˜</span> VTE prophylaxis status</div>
</div>
</div>
</div>

<!-- CONSULTATION SECTION -->
<div class="section-label">ğŸ“ SPECIALTY CONSULTATIONS</div>
<div class="consult-intro">Tap any specialty for what you need BEFORE calling</div>

<!-- ICU CONSULTATION -->
<div class="tool-card consult-card consult-critical" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-critical">ğŸ¥</div>
<div><div class="tool-title">ICU<span class="tool-badge urgent">Critical</span></div><div class="tool-subtitle">Intensive Care Unit</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box critical">
<div class="consult-title">ğŸ“ Before Calling ICU</div>
<div class="consult-grid">
<div class="consult-item"><strong>Airway:</strong> Patent? Protecting? GCS?</div>
<div class="consult-item"><strong>Breathing:</strong> RR, SpO2, O2 requirement, ABG</div>
<div class="consult-item"><strong>Circulation:</strong> HR, BP, MAP, lactate, access</div>
<div class="consult-item"><strong>Interventions:</strong> What you've done so far</div>
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ ICU Admission Criteria</div>
<div class="protocol-content">
â€¢ Mechanical ventilation or imminent intubation<br>
â€¢ Vasopressor requirement<br>
â€¢ Severe sepsis/septic shock<br>
â€¢ Active MI with hemodynamic instability<br>
â€¢ Status epilepticus<br>
â€¢ Acute renal failure requiring CRRT<br>
â€¢ GCS â‰¤8 or rapidly declining<br>
â€¢ Post-cardiac arrest<br>
â€¢ DKA/HHS with pH &lt;7.1 or altered mental status
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“Š Must-Have Information</div>
<div class="protocol-content">
â€¢ <strong>Recent ABG</strong> with FiO2<br>
â€¢ <strong>Lactate</strong> (ideally serial)<br>
â€¢ <strong>Current vitals</strong> & trend over last 2-4 hours<br>
â€¢ <strong>Fluid balance</strong> & urine output<br>
â€¢ <strong>Recent labs:</strong> CBC, BMP, coags, LFTs<br>
â€¢ <strong>ECG</strong> within last hour if cardiac concern<br>
â€¢ <strong>Code status</strong> & goals of care<br>
â€¢ <strong>Family contact</strong> information
</div>
</div>
</div>
</div>

<!-- SURGERY CONSULTATION -->
<div class="tool-card consult-card consult-surgery" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-surgery">ğŸ”ª</div>
<div><div class="tool-title">Surgery</div><div class="tool-subtitle">General Surgery</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box">
<div class="consult-title">ğŸ“ Before Calling Surgery</div>
<div class="consult-grid">
<div class="consult-item"><strong>Localize:</strong> Where is the problem?</div>
<div class="consult-item"><strong>Imaging:</strong> CT/US done? Results?</div>
<div class="consult-item"><strong>NPO status:</strong> Last oral intake?</div>
<div class="consult-item"><strong>Anticoag:</strong> On blood thinners?</div>
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ Required Information</div>
<div class="protocol-content">
â€¢ <strong>Chief complaint</strong> with timeline<br>
â€¢ <strong>Physical exam:</strong> Peritonitis? Guarding? Rebound?<br>
â€¢ <strong>Labs:</strong> CBC, BMP, lipase, LFTs, lactate, coags<br>
â€¢ <strong>Imaging results</strong> (CT report or images available)<br>
â€¢ <strong>Hemodynamic status</strong><br>
â€¢ <strong>Surgical history</strong> & previous abdominal surgeries<br>
â€¢ <strong>Comorbidities</strong> affecting surgical risk
</div>
</div>
<div class="consult-box warning">
<div class="consult-title">ğŸš¨ Urgent Surgical Conditions</div>
<div class="protocol-content">
â€¢ Perforated viscus / free air<br>
â€¢ Acute appendicitis with peritonitis<br>
â€¢ Small bowel obstruction with strangulation<br>
â€¢ Acute mesenteric ischemia<br>
â€¢ Necrotizing fasciitis<br>
â€¢ Compartment syndrome<br>
â€¢ Hemorrhage requiring operative control<br>
â€¢ Acute cholecystitis (Tokyo Grade II-III)
</div>
</div>
</div>
</div>

<!-- CARDIOLOGY CONSULTATION -->
<div class="tool-card consult-card consult-cardio" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-cardio">â¤ï¸</div>
<div><div class="tool-title">Cardiology</div><div class="tool-subtitle">Cardiac referral</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box critical">
<div class="consult-title">ğŸš¨ STEMI - Activate Cath Lab</div>
<div class="protocol-content">
â€¢ <strong>Call cath lab FIRST</strong> - don't wait for consult<br>
â€¢ ECG with ST elevation or new LBBB<br>
â€¢ Symptom onset time (door-to-balloon &lt;90 min)<br>
â€¢ Aspirin 300mg + Ticagrelor 180mg given?<br>
â€¢ Anticoagulation given?<br>
â€¢ Contraindications to intervention?
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ Non-STEMI/Unstable Angina</div>
<div class="protocol-content">
â€¢ <strong>Serial ECGs</strong> (at least 2)<br>
â€¢ <strong>Troponin</strong> at 0, 3, 6 hours<br>
â€¢ <strong>GRACE/TIMI score</strong> if possible<br>
â€¢ Current anti-ischemic therapy<br>
â€¢ Bleeding risk assessment<br>
â€¢ Echo findings if available
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“Š Arrhythmia Consult</div>
<div class="protocol-content">
â€¢ <strong>12-lead ECG</strong> (during arrhythmia if possible)<br>
â€¢ <strong>Rhythm strip</strong> showing onset/termination<br>
â€¢ Hemodynamic stability during episodes<br>
â€¢ Electrolytes: K+, Mg2+, Ca2+<br>
â€¢ Current medications (esp. QT-prolonging)<br>
â€¢ Previous ablations or device history
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ«€ Heart Failure Consult</div>
<div class="protocol-content">
â€¢ <strong>BNP/NT-proBNP</strong> level<br>
â€¢ <strong>Echo</strong> with EF (recent or pending)<br>
â€¢ Volume status: JVP, edema, crackles<br>
â€¢ Daily weights & I/O balance<br>
â€¢ Current diuretic regimen & response<br>
â€¢ Renal function trend
</div>
</div>
</div>
</div>

<!-- NEUROLOGY CONSULTATION -->
<div class="tool-card consult-card consult-neuro" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-neuro">ğŸ§ </div>
<div><div class="tool-title">Neurology</div><div class="tool-subtitle">Neuro referral</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box critical">
<div class="consult-title">ğŸš¨ Stroke Alert</div>
<div class="protocol-content">
â€¢ <strong>Time last seen normal</strong> - CRITICAL<br>
â€¢ <strong>NIHSS score</strong> (or key deficits)<br>
â€¢ <strong>CT head</strong> done? Hemorrhage ruled out?<br>
â€¢ <strong>Glucose</strong> checked?<br>
â€¢ <strong>BP</strong> - do NOT lower unless &gt;220/120<br>
â€¢ <strong>Anticoagulant use?</strong> (INR if on warfarin)<br>
â€¢ Contraindications to tPA?
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ Seizure Consult</div>
<div class="protocol-content">
â€¢ <strong>Witnessed description</strong> of event<br>
â€¢ Duration & post-ictal state<br>
â€¢ First seizure vs known epilepsy<br>
â€¢ AED levels if applicable<br>
â€¢ Labs: glucose, Na+, Ca2+, Mg2+<br>
â€¢ CT/MRI done?<br>
â€¢ EEG ordered?
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“Š Altered Mental Status</div>
<div class="protocol-content">
â€¢ <strong>GCS</strong> and trend<br>
â€¢ <strong>Focal deficits?</strong> Pupils, motor exam<br>
â€¢ <strong>Metabolic workup:</strong> glucose, Na+, ammonia, TSH<br>
â€¢ <strong>Infectious workup:</strong> WBC, UA, CXR, blood Cx<br>
â€¢ <strong>Toxicology</strong> screen if indicated<br>
â€¢ CT head Â± LP if meningitis suspected
</div>
</div>
</div>
</div>

<!-- GI CONSULTATION -->
<div class="tool-card consult-card consult-gi" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-gi">ğŸ”¬</div>
<div><div class="tool-title">Gastroenterology</div><div class="tool-subtitle">GI referral</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box critical">
<div class="consult-title">ğŸš¨ GI Bleed</div>
<div class="protocol-content">
â€¢ <strong>Hematemesis vs melena vs hematochezia</strong><br>
â€¢ <strong>Hemodynamics:</strong> HR, BP, orthostatics<br>
â€¢ <strong>Hgb</strong> - current and baseline<br>
â€¢ <strong>Coags:</strong> INR, PTT, platelets<br>
â€¢ <strong>Type & screen</strong> sent?<br>
â€¢ <strong>IV access:</strong> 2 large bore IVs<br>
â€¢ <strong>NPO status</strong><br>
â€¢ <strong>PPI</strong> given? (80mg bolus + drip for UGIB)<br>
â€¢ Anticoagulant/antiplatelet use?<br>
â€¢ Cirrhosis? Varices?
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ Acute Pancreatitis</div>
<div class="protocol-content">
â€¢ <strong>Lipase</strong> level (â‰¥3x ULN diagnostic)<br>
â€¢ <strong>CT abdomen</strong> (if diagnosis unclear or severe)<br>
â€¢ <strong>Etiology:</strong> gallstones? alcohol? meds?<br>
â€¢ <strong>BISAP score</strong> for severity<br>
â€¢ <strong>Fluid resuscitation</strong> status<br>
â€¢ Trending BUN/Cr/Hct
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“Š Liver Failure</div>
<div class="protocol-content">
â€¢ <strong>LFTs:</strong> AST, ALT, ALP, bilirubin, albumin<br>
â€¢ <strong>Coags:</strong> INR, fibrinogen<br>
â€¢ <strong>Ammonia</strong> level<br>
â€¢ <strong>Encephalopathy grade</strong> (West Haven)<br>
â€¢ <strong>Etiology workup:</strong> viral, autoimmune, toxin<br>
â€¢ Acetaminophen level & time of ingestion<br>
â€¢ Consider transplant hepatology if ALF
</div>
</div>
</div>
</div>

<!-- NEPHROLOGY CONSULTATION -->
<div class="tool-card consult-card consult-renal" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-renal">ğŸ«˜</div>
<div><div class="tool-title">Nephrology</div><div class="tool-subtitle">Renal referral</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box critical">
<div class="consult-title">ğŸš¨ Urgent Dialysis Indications (AEIOU)</div>
<div class="protocol-content">
â€¢ <strong>A</strong>cidosis - severe metabolic (pH &lt;7.1)<br>
â€¢ <strong>E</strong>lectrolytes - refractory hyperkalemia<br>
â€¢ <strong>I</strong>ngestion - toxic alcohols, lithium, salicylates<br>
â€¢ <strong>O</strong>verload - pulmonary edema refractory to diuretics<br>
â€¢ <strong>U</strong>remia - encephalopathy, pericarditis, bleeding
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ AKI Workup</div>
<div class="protocol-content">
â€¢ <strong>Baseline Cr</strong> vs current<br>
â€¢ <strong>Urine output</strong> (last 6-12 hours)<br>
â€¢ <strong>Volume status</strong> assessment<br>
â€¢ <strong>Urinalysis</strong> with microscopy<br>
â€¢ <strong>FENa</strong> or FEUrea<br>
â€¢ <strong>Renal ultrasound</strong> (obstruction?)<br>
â€¢ Nephrotoxin exposure review<br>
â€¢ Contrast exposure?
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“Š Electrolyte Emergencies</div>
<div class="protocol-content">
â€¢ <strong>Hyperkalemia:</strong> K+, ECG, current treatment<br>
â€¢ <strong>Hyponatremia:</strong> Na+, serum osm, urine Na/osm<br>
â€¢ <strong>Hypercalcemia:</strong> Ca2+, PTH, volume status<br>
â€¢ Trend of values over past 24-48h<br>
â€¢ Symptoms attributable to electrolyte abnormality
</div>
</div>
</div>
</div>

<!-- PULMONOLOGY CONSULTATION -->
<div class="tool-card consult-card consult-pulm" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-pulm">ğŸ«</div>
<div><div class="tool-title">Pulmonology</div><div class="tool-subtitle">Pulm referral</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box critical">
<div class="consult-title">ğŸš¨ Respiratory Failure</div>
<div class="protocol-content">
â€¢ <strong>ABG</strong> on current O2 support<br>
â€¢ <strong>Current support:</strong> NC/HFNC/BiPAP/vent settings<br>
â€¢ <strong>Work of breathing</strong> assessment<br>
â€¢ <strong>CXR/CT</strong> findings<br>
â€¢ Intubation anticipated?<br>
â€¢ Code status
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ Bronchoscopy Request</div>
<div class="protocol-content">
â€¢ <strong>Indication:</strong> BAL, biopsy, therapeutic?<br>
â€¢ <strong>Imaging</strong> showing lesion/infiltrate<br>
â€¢ <strong>Coags:</strong> INR, PTT, platelets (&gt;50k)<br>
â€¢ <strong>NPO</strong> status<br>
â€¢ Antiplatelet/anticoagulant held?<br>
â€¢ Consent obtained?
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ“Š COPD/Asthma Exacerbation</div>
<div class="protocol-content">
â€¢ <strong>Baseline</strong> FEV1 or home O2 use<br>
â€¢ <strong>Current treatment</strong> given<br>
â€¢ <strong>ABG</strong> if severe<br>
â€¢ <strong>CXR</strong> for infiltrate/PTX<br>
â€¢ Previous intubations?<br>
â€¢ Steroid duration so far
</div>
</div>
</div>
</div>

<!-- INFECTIOUS DISEASE CONSULTATION -->
<div class="tool-card consult-card consult-id" data-category="consult">
<div class="tool-header" onclick="toggleTool(this)">
<div class="tool-header-left">
<div class="tool-icon consult-icon-id">ğŸ¦ </div>
<div><div class="tool-title">Infectious Disease</div><div class="tool-subtitle">ID referral</div></div>
</div>
<div class="tool-chevron">â–¼</div>
</div>
<div class="tool-content">
<div class="tool-divider"></div>
<div class="consult-box">
<div class="consult-title">ğŸ“‹ Before Calling ID</div>
<div class="protocol-content">
â€¢ <strong>Source:</strong> Where is the infection?<br>
â€¢ <strong>Cultures:</strong> Blood, urine, sputum, wound - BEFORE abx!<br>
â€¢ <strong>Current antibiotics</strong> with start dates<br>
â€¢ <strong>Prior cultures</strong> & sensitivities<br>
â€¢ <strong>Allergies</strong> - specify reaction type<br>
â€¢ <strong>Renal function</strong> for dosing<br>
â€¢ <strong>Imaging</strong> supporting diagnosis
</div>
</div>
<div class="consult-box">
<div class="consult-title">ğŸ”¬ Key Microbiology Data</div>
<div class="protocol-content">
â€¢ <strong>Gram stain</strong> results<br>
â€¢ <strong>Culture</strong> finalized or pending<br>
â€¢ <strong>Sensitivities</strong> if available<br>
â€¢ <strong>Procalcitonin</strong> level<br>
â€¢ HIV status if relevant<br>
â€¢ Recent hospitalization/healthcare exposure?
</div>
</div>
<div class="consult-box warning">
<div class="consult-title">ğŸš¨ Urgent ID Consults</div>
<div class="protocol-content">
â€¢ Bacterial meningitis<br>
â€¢ Necrotizing fasciitis<br>
â€¢ Endocarditis (new murmur + bacteremia)<br>
â€¢ Febrile neutropenia<br>
â€¢ Severe sepsis with unclear source<br>
â€¢ CNS infection (abscess, encephalitis)
</div>
</div>
</div>
</div>

<!-- AI ASSISTANT -->
<div class="ai-section" data-category="ai">
<div class="ai-header">
<div class="ai-icon">ğŸ¤–</div>
<div><div class="ai-title">AI Assistant</div><div class="ai-subtitle">Kuwait SI Units</div></div>
</div>
<div class="ai-body">
<div class="ai-prompts">
<button class="ai-prompt-btn" onclick="setPrompt('Hyperkalemia ECG changes')">Hyperkalemia</button>
<button class="ai-prompt-btn" onclick="setPrompt('DKA protocol')">DKA</button>
<button class="ai-prompt-btn" onclick="setPrompt('Neutropenic fever')">Neutropenic Fever</button>
<button class="ai-prompt-btn" onclick="setPrompt('GI bleed workup')">GI Bleed</button>
</div>
<div class="ai-input-row">
<input type="text" class="ai-input" id="aiInput" placeholder="Ask a clinical question...">
<button class="ai-send-btn" onclick="askAI()">â¤</button>
</div>
<div class="ai-response" id="aiResponse"></div>
</div>
</div>

<!-- QUICK REFERENCE -->
<div class="section-label">Quick Reference â€¢ Kuwait SI Units</div>
<div class="quick-ref-grid">
<div class="quick-ref-card" onclick="showRef('K+: 3.5-5.0 mmol/L\n\nCritical Low: <2.5\nCritical High: >6.0\n\nSymptoms:\nâ€¢ Low: weakness, cramps, arrhythmias\nâ€¢ High: peaked T, wide QRS, arrest')"><div class="quick-ref-icon">ğŸ§ª</div><div class="quick-ref-title">K+</div><div class="quick-ref-value">3.5-5.0</div></div>
<div class="quick-ref-card" onclick="showRef('Na+: 136-145 mmol/L\n\nCritical Low: <120\nCritical High: >160\n\nCorrection Rate:\nâ€¢ Chronic: max 8-10 mEq/24hr\nâ€¢ Acute: max 1-2 mEq/hr')"><div class="quick-ref-icon">ğŸ§‚</div><div class="quick-ref-title">Na+</div><div class="quick-ref-value">136-145</div></div>
<div class="quick-ref-card" onclick="showRef('Mg: 0.7-1.0 mmol/L\n\nCritical: <0.4\n\nReplacement:\nâ€¢ Mild: 500mg PO TID\nâ€¢ Severe: 2g IV over 1hr')"><div class="quick-ref-icon">ğŸ’</div><div class="quick-ref-title">Mg</div><div class="quick-ref-value">0.7-1.0</div></div>
<div class="quick-ref-card" onclick="showRef('Ca (total): 2.1-2.6 mmol/L\n\nCorrected Ca:\nCa + 0.02 Ã— (40 - Albumin)\n\nCritical Low: <1.9\nCritical High: >3.0')"><div class="quick-ref-icon">ğŸ¦´</div><div class="quick-ref-title">Ca</div><div class="quick-ref-value">2.1-2.6</div></div>
<div class="quick-ref-card" onclick="showRef('Glucose: 3.9-5.6 mmol/L\n\nHypoglycemia: <3.9\nDiabetes threshold: â‰¥7.0 fasting\n\nDKA: >13.9 + ketones + acidosis')"><div class="quick-ref-icon">ğŸ¬</div><div class="quick-ref-title">Glucose</div><div class="quick-ref-value">3.9-5.6</div></div>
<div class="quick-ref-card" onclick="showRef('Creatinine:\nâ€¢ Male: 62-106 Âµmol/L\nâ€¢ Female: 44-80 Âµmol/L\n\neGFR Stages:\nG1: â‰¥90 | G2: 60-89\nG3a: 45-59 | G3b: 30-44\nG4: 15-29 | G5: <15')"><div class="quick-ref-icon">ğŸ«˜</div><div class="quick-ref-title">Cr</div><div class="quick-ref-value">62-106</div></div>
<div class="quick-ref-card" onclick="showRef('Hemoglobin:\nâ€¢ Male: 130-175 g/L\nâ€¢ Female: 120-160 g/L\n\nTransfusion threshold:\nâ€¢ Stable: Hgb <70 g/L\nâ€¢ ACS/hypoxia: <80 g/L')"><div class="quick-ref-icon">ğŸ©¸</div><div class="quick-ref-title">Hgb</div><div class="quick-ref-value">130-175</div></div>
<div class="quick-ref-card" onclick="showRef('QTc (Bazett):\nâ€¢ Normal: <440 ms\nâ€¢ Borderline: 440-470 ms\nâ€¢ Prolonged: >470 ms\nâ€¢ Danger: >500 ms (TdP risk)\n\nFormula: QT Ã· âˆšRR')"><div class="quick-ref-icon">â¤ï¸</div><div class="quick-ref-title">QTc</div><div class="quick-ref-value"><440 ms</div></div>
</div>
</div>

<nav class="bottom-nav">
<div class="nav-item" onclick="goBack()"><div class="nav-icon">ğŸ </div><span>Home</span></div>
<div class="nav-item active"><div class="nav-icon">âš¡</div><span>OnCall</span></div>
<div class="nav-item" onclick="filterCategory('emergency',this)"><div class="nav-icon">ğŸš¨</div><span>Emergency</span></div>
<a class="nav-item" href="ai_assistant.html"><div class="nav-icon">ğŸ¤–</div><span>AI</span></a>
</nav>

<script>
var apiUrl='https://script.google.com/macros/s/AKfycbznXa9YNna26Srt1eZVEnSV-dIiubFLTwg3ryLdE-maGNCQhydP_8E6AK4QPXkeQrw7lA/exec';
var gfrSex='';

// Initialize theme immediately on html element
(function(){
  var savedTheme=localStorage.getItem('oncall-theme')||'light';
  document.documentElement.setAttribute('data-theme',savedTheme);
})();

// Update button text after DOM loads
document.addEventListener('DOMContentLoaded',function(){
  var savedTheme=localStorage.getItem('oncall-theme')||'light';
  var btn=document.getElementById('themeBtn');
  if(btn) btn.textContent=savedTheme==='dark'?'â˜€ï¸':'ğŸŒ™';
});

function toggleTheme(){
  var current=document.documentElement.getAttribute('data-theme');
  var newTheme=current==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',newTheme);
  localStorage.setItem('oncall-theme',newTheme);
  var btn=document.getElementById('themeBtn');
  if(btn) btn.textContent=newTheme==='dark'?'â˜€ï¸':'ğŸŒ™';
}

function goBack(){
  if(window.opener||window.history.length<=1){
    window.location.href='/';
  }else{
    window.history.back();
  }
}

function scrollToAI(){
  document.querySelector('.ai-section').scrollIntoView({behavior:'smooth'});
}

function filterCategory(cat,btn){
  var pills=document.querySelectorAll('.pill');
  for(var i=0;i<pills.length;i++){pills[i].classList.remove('active');}
  if(btn)btn.classList.add('active');
  var cards=document.querySelectorAll('.tool-card,.ai-section');
  for(var i=0;i<cards.length;i++){
    var c=cards[i];
    var cats=c.getAttribute('data-category');
    if(cat==='all'||(cats&&cats.indexOf(cat)>=0)){
      c.style.display='block';
    }else{
      c.style.display='none';
    }
  }
}

function toggleTool(header){
  var card=header.parentElement;
  if(card){card.classList.toggle('expanded');}
}

function setGFRSex(s,btn,e){
  if(e)e.stopPropagation();
  gfrSex=s;
  var btns=btn.parentElement.querySelectorAll('.gender-btn');
  for(var i=0;i<btns.length;i++){btns[i].classList.remove('selected');}
  btn.classList.add('selected');
}

function showRef(text){alert(text);}
function setPrompt(t){document.getElementById('aiInput').value=t;}

var prnData={
  pain:'ğŸ˜£ PAIN\n\nMild: Paracetamol 1g PO q6h (max 4g/day)\nModerate: Tramadol 50-100mg PO q6h\nSevere: Morphine 2.5-5mg IV q4h\n\nâš ï¸ Reduce opioids in elderly/renal',
  nausea:'ğŸ¤¢ NAUSEA\n\n1st: Ondansetron 4-8mg IV/PO q8h\nAlt: Metoclopramide 10mg q8h\n\nâš ï¸ Avoid metoclopramide >5 days',
  fever:'ğŸŒ¡ï¸ FEVER\n\nParacetamol 1g PO/IV q6h\nIbuprofen 400mg PO q6-8h\n\nâš ï¸ Avoid NSAIDs in renal/GI',
  sleep:'ğŸ˜´ SLEEP\n\nMelatonin 3-5mg PO hs\nZopiclone 3.75-7.5mg hs\n\nâš ï¸ Avoid benzos in elderly',
  anxiety:'ğŸ˜° ANXIETY\n\nHydroxyzine 25-50mg PO q6h\nLorazepam 0.5-1mg PO/SL q6h\n\nâš ï¸ Benzos worsen delirium',
  constipation:'ğŸ’© CONSTIPATION\n\nLactulose 15-30mL PO BD\nSenna 15mg PO hs\nBisacodyl 10mg PR\n\nâš ï¸ Rule out obstruction',
  itch:'ğŸ–ï¸ ITCH\n\nCetirizine 10mg PO daily\nChlorpheniramine 4mg q6h\n\nâš ï¸ Sedating in elderly',
  heartburn:'ğŸ”¥ HEARTBURN\n\nGaviscon 10-20mL PRN\nOmeprazole 20-40mg daily\n\nâš ï¸ Long-term PPI risks',
  agitation:'ğŸ˜¤ AGITATION\n\nâš ï¸ Verbal de-escalation first!\n\nPO: Olanzapine 5-10mg OR Lorazepam 1-2mg\nIM: Haloperidol 5mg + Lorazepam 2mg\n\nğŸš¨ NEVER IM olanzapine with benzos',
  htn:'ğŸ“ˆ HYPERTENSION\n\nMild: Amlodipine 5mg PO\nModerate: Labetalol 100-200mg PO\nSevere: Labetalol 20mg IV\n\nâš ï¸ Rule out emergency first',
  wheeze:'ğŸŒ¬ï¸ WHEEZE\n\nSalbutamol 2.5-5mg neb q20min x3\nIpratropium 500mcg neb\nHydrocortisone 100mg IV\n\nâš ï¸ Continuous nebs if severe',
  diarrhea:'ğŸš½ DIARRHEA\n\nRehydrate first!\nLoperamide 4mg then 2mg PRN\n\nğŸš¨ AVOID if bloody/fever/C.diff'
};

function showPRN(type,card){
  var cards=document.querySelectorAll('.prn-card');
  for(var i=0;i<cards.length;i++){cards[i].classList.remove('active');}
  card.classList.add('active');
  var det=document.getElementById('prnDetails');
  det.innerHTML='<pre style="white-space:pre-wrap;font-family:inherit;">'+prnData[type]+'</pre>';
  det.classList.add('visible');
}

function calcHypo(e){
  if(e)e.stopPropagation();
  var g=parseFloat(document.getElementById('inputHypoGlucose').value);
  var s=document.getElementById('inputHypoStatus').value;
  var box=document.getElementById('resultHypo');
  if(!g){alert('Enter glucose');return;}
  box.className='result-box';
  if(g>=3.9){
    box.className+=' success';
    box.innerHTML='<div class="result-title">âœ“ Normal</div><div class="result-content">'+g+' mmol/L is normal</div>';
  }else if(s==='unconscious'){
    box.className+=' danger';
    box.innerHTML='<div class="result-title">ğŸš¨ SEVERE</div><div class="result-content"><strong>D50 25-50mL IV</strong> or Glucagon 1mg IM<br><br>Recheck 15min, repeat if &lt;3.9</div>';
  }else if(s==='confused'){
    box.className+=' warning';
    box.innerHTML='<div class="result-title">âš ï¸ Moderate</div><div class="result-content"><strong>Glucose gel 15-20g</strong> buccal<br><br>If no response: D50 25mL IV</div>';
  }else{
    box.innerHTML='<div class="result-title">ğŸ“‹ Mild</div><div class="result-content"><strong>15-20g fast carbs</strong><br>Juice, glucose tabs, honey<br><br>Recheck 15min</div>';
  }
}

function calcHyperK(e){
  if(e)e.stopPropagation();
  var k=parseFloat(document.getElementById('inputHyperK').value);
  var ecg=document.getElementById('inputHyperKECG').value;
  var box=document.getElementById('resultHyperK');
  if(!k){alert('Enter K+');return;}
  box.className='result-box';
  if(k<5.5&&ecg==='none'){
    box.className+=' success';
    box.innerHTML='<div class="result-title">âœ“ Normal</div><div class="result-content">Review meds</div>';
  }else{
    var severe=k>=6.5||ecg!=='none';
    box.className+=' '+(severe?'danger':'warning');
    box.innerHTML='<div class="result-title">'+(severe?'ğŸš¨ EMERGENCY':'âš ï¸ Moderate')+' K+ '+k+'</div><div class="result-content">'+(ecg!=='none'?'<strong>âš¡ ECG CHANGES - Treat NOW</strong><br><br>':'')+'<strong>1. Ca Gluconate 10% 10mL IV</strong> (2-3min)<br><br><strong>2. Insulin 10U + D50 25g IV</strong><br>Salbutamol 10-20mg neb<br><br><strong>3. Furosemide 40-80mg IV</strong></div>';
  }
}

function calcAnap(e){
  if(e)e.stopPropagation();
  var age=document.getElementById('inputAnapAge').value;
  var box=document.getElementById('resultAnap');
  box.className='result-box danger';
  var dose=age==='adult'?'0.5mg (0.5mL 1:1000)':age==='child'?'0.3mg (0.3mL 1:1000)':'0.15mg (0.15mL 1:1000)';
  box.innerHTML='<div class="result-title">ğŸš¨ ANAPHYLAXIS</div><div class="result-content"><strong>ğŸ’‰ ADRENALINE FIRST!</strong><br><br><strong>'+dose+' IM thigh</strong><br>Repeat q5min PRN<br><br>Lie flat, elevate legs<br>High-flow O2<br>NS 20mL/kg if hypotensive</div>';
}

function calcSepsis(e){
  if(e)e.stopPropagation();
  var lac=parseFloat(document.getElementById('inputSepsisLactate').value);
  var map=parseFloat(document.getElementById('inputSepsisMAP').value);
  var box=document.getElementById('resultSepsis');
  var shock=(map&&map<65)||(lac&&lac>2);
  box.className='result-box '+(shock?'danger':'warning');
  box.innerHTML='<div class="result-title">'+(shock?'ğŸš¨ SEPTIC SHOCK':'âš ï¸ SEPSIS')+' Hour-1</div><div class="result-content"><strong>1. Lactate</strong> '+(lac?lac+' mmol/L':'Draw NOW')+'<br><br><strong>2. Blood Cx x2</strong> before abx<br><br><strong>3. Pip-Tazo 4.5g IV</strong> within 1hr<br><br><strong>4. NS 30mL/kg</strong> if hypotensive</div>';
}

function calcDKA(e){
  if(e)e.stopPropagation();
  var pH=parseFloat(document.getElementById('inputDKApH').value);
  var k=parseFloat(document.getElementById('inputDKAK').value);
  var box=document.getElementById('resultDKA');
  var severe=pH&&pH<7.0;
  box.className='result-box '+(severe?'danger':'warning');
  var kMsg=k?((k<3.3)?'ğŸš¨ HOLD insulin until K+>3.3!':(k<5.3)?'Add 20-30 mEq KCl/L':'No K+ initially'):'Check K+ first';
  box.innerHTML='<div class="result-title">'+(severe?'ğŸš¨ SEVERE DKA':'âš ï¸ DKA')+(pH?' pH '+pH:'')+'</div><div class="result-content"><strong>1. NS 1-1.5L/hr</strong> x1h<br><br><strong>2. Insulin 0.1 U/kg/hr</strong><br><br><strong>3. K+:</strong> '+kMsg+'<br><br>BG q1h, lytes q2-4h</div>';
}

function calcK(e){
  if(e)e.stopPropagation();
  var k=parseFloat(document.getElementById('inputK').value);
  var box=document.getElementById('resultK');
  if(!k){alert('Enter K+');return;}
  box.className='result-box';
  if(k<2.5){box.className+=' danger';box.innerHTML='<div class="result-title">ğŸš¨ Critical</div><div class="result-content"><strong>40 mEq/hr IV central</strong><br>Cardiac monitor</div>';}
  else if(k<3.0){box.className+=' warning';box.innerHTML='<div class="result-title">âš ï¸ Moderate</div><div class="result-content"><strong>40 mEq KCl PO/IV</strong><br>Recheck 4h</div>';}
  else if(k<3.5){box.innerHTML='<div class="result-title">ğŸ“‹ Mild</div><div class="result-content"><strong>40 mEq KCl PO</strong><br>Recheck AM</div>';}
  else if(k>5.5){box.className+=' danger';box.innerHTML='<div class="result-title">ğŸš¨ High</div><div class="result-content">Use Hyperkalemia tool!</div>';}
  else{box.className+=' success';box.innerHTML='<div class="result-title">âœ“ Normal</div><div class="result-content">'+k+' mmol/L</div>';}
}

function calcCa(e){
  if(e)e.stopPropagation();
  var ca=parseFloat(document.getElementById('inputCa').value);
  var alb=parseFloat(document.getElementById('inputAlb').value);
  var box=document.getElementById('resultCa');
  if(!ca||!alb){alert('Enter values');return;}
  var corr=(ca+0.02*(40-alb)).toFixed(2);
  box.className='result-box';
  if(corr<1.9){box.className+=' danger';box.innerHTML='<div class="result-title">ğŸš¨ Severe Hypocalcemia</div><div class="result-content">Corrected: <strong>'+corr+'</strong><br>Ca Gluconate 1-2g IV</div>';}
  else if(corr<2.1){box.className+=' warning';box.innerHTML='<div class="result-title">âš ï¸ Low</div><div class="result-content">Corrected: <strong>'+corr+'</strong></div>';}
  else if(corr>3.0){box.className+=' danger';box.innerHTML='<div class="result-title">ğŸš¨ Severe Hypercalcemia</div><div class="result-content">Corrected: <strong>'+corr+'</strong><br>IV NS aggressively</div>';}
  else if(corr>2.6){box.className+=' warning';box.innerHTML='<div class="result-title">âš ï¸ High</div><div class="result-content">Corrected: <strong>'+corr+'</strong></div>';}
  else{box.className+=' success';box.innerHTML='<div class="result-title">âœ“ Normal</div><div class="result-content">Corrected: '+corr+'</div>';}
}

function calcEGFR(e){
  if(e)e.stopPropagation();
  var cr=parseFloat(document.getElementById('inputCr').value);
  var age=parseFloat(document.getElementById('inputAge').value);
  var box=document.getElementById('resultEGFR');
  if(!cr||!age||!gfrSex){alert('Enter all values');return;}
  var crMg=cr/88.4;
  var egfr;
  if(gfrSex==='f'){egfr=142*Math.pow(Math.min(crMg/0.7,1),-0.241)*Math.pow(Math.max(crMg/0.7,1),-1.2)*Math.pow(0.9938,age)*1.012;}
  else{egfr=142*Math.pow(Math.min(crMg/0.9,1),-0.302)*Math.pow(Math.max(crMg/0.9,1),-1.2)*Math.pow(0.9938,age);}
  egfr=Math.round(egfr);
  box.className='result-box';
  var stage;
  if(egfr>=90){stage='G1';box.className+=' success';}
  else if(egfr>=60){stage='G2';box.className+=' success';}
  else if(egfr>=45){stage='G3a';box.className+=' warning';}
  else if(egfr>=30){stage='G3b';box.className+=' warning';}
  else if(egfr>=15){stage='G4';box.className+=' danger';}
  else{stage='G5';box.className+=' danger';}
  box.innerHTML='<div class="result-title">eGFR: '+egfr+'</div><div class="result-content">CKD Stage: '+stage+'</div>';
}

function calcQTc(e){
  if(e)e.stopPropagation();
  var qt=parseFloat(document.getElementById('inputQT').value);
  var hr=parseFloat(document.getElementById('inputHR').value);
  var box=document.getElementById('resultQTc');
  if(!qt||!hr){alert('Enter values');return;}
  var qtc=Math.round(qt/Math.sqrt(60/hr));
  box.className='result-box';
  if(qtc>500){box.className+=' danger';box.innerHTML='<div class="result-title">ğŸš¨ '+qtc+'ms</div><div class="result-content">HIGH TdP risk<br>STOP QT drugs</div>';}
  else if(qtc>470){box.className+=' warning';box.innerHTML='<div class="result-title">âš ï¸ '+qtc+'ms</div><div class="result-content">Prolonged</div>';}
  else if(qtc>440){box.innerHTML='<div class="result-title">ğŸ“‹ '+qtc+'ms</div><div class="result-content">Borderline</div>';}
  else{box.className+=' success';box.innerHTML='<div class="result-title">âœ“ '+qtc+'ms</div><div class="result-content">Normal</div>';}
}

function parseMarkdown(text){
  // Convert markdown tables to HTML
  text = text.replace(/\n\|(.+)\|\n\|[-:| ]+\|\n([\s\S]*?)(?=\n\n|\n[^|]|$)/g, function(match, header, body) {
    var headers = header.split('|').map(function(h){return h.trim();}).filter(Boolean);
    var headerHtml = '<tr>' + headers.map(function(h){return '<th style="padding:8px 12px;text-align:left;border-bottom:2px solid var(--border);font-weight:600;">'+h+'</th>';}).join('') + '</tr>';
    var rows = body.trim().split('\n').map(function(row){
      var cells = row.split('|').map(function(c){return c.trim();}).filter(Boolean);
      return '<tr>' + cells.map(function(c){return '<td style="padding:8px 12px;border-bottom:1px solid var(--border);">'+c+'</td>';}).join('') + '</tr>';
    }).join('');
    return '<table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:0.85rem;">'+headerHtml+rows+'</table>';
  });
  // Headers
  text = text.replace(/^### (.+)$/gm, '<h4 style="font-size:0.95rem;font-weight:700;margin:16px 0 8px;color:var(--primary);">$1</h4>');
  text = text.replace(/^## (.+)$/gm, '<h3 style="font-size:1.05rem;font-weight:700;margin:20px 0 10px;color:var(--text);">$1</h3>');
  text = text.replace(/^# (.+)$/gm, '<h2 style="font-size:1.15rem;font-weight:700;margin:0 0 12px;color:var(--primary-dark);">$1</h2>');
  // Bold and italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Horizontal rule
  text = text.replace(/^---$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">');
  // Lists
  text = text.replace(/^\* (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;">$1</li>');
  text = text.replace(/^- (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;">$1</li>');
  text = text.replace(/^(\d+)\. (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;list-style-type:decimal;">$2</li>');
  // Line breaks
  text = text.replace(/\n\n/g, '</p><p style="margin:12px 0;">');
  text = text.replace(/\n/g, '<br>');
  return '<p style="margin:0;">'+text+'</p>';
}

function askAI(){
  var input=document.getElementById('aiInput');
  var resp=document.getElementById('aiResponse');
  var q=input.value;
  if(!q){alert('Enter question');return;}
  resp.className='ai-response visible';
  resp.innerHTML='<div class="ai-response-header"><span class="ai-response-label">Loading...</span></div><div class="ai-response-body"><div class="ai-loading"><div class="ai-loading-spinner"></div></div></div>';
  fetch(apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'oncallAskClinical',question:q})})
  .then(function(r){return r.json();})
  .then(function(d){
    var ans=d.answer||d.response||'No response';
    ans=parseMarkdown(ans);
    resp.innerHTML='<div class="ai-response-header"><span class="ai-response-label">Response</span></div><div class="ai-response-body">'+ans+'</div>';
    input.value='';
  })
  .catch(function(err){
    resp.innerHTML='<div class="ai-response-header"><span class="ai-response-label" style="color:var(--danger)">Error</span></div><div class="ai-response-body">'+err.message+'</div>';
  });
}

document.getElementById('aiInput').onkeydown=function(e){if(e.keyCode===13)askAI();};
</script>
</body>
</html>
