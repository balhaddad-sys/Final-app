// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE AI ASSISTANT - FIXED VERSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Replace your existing askClaude() function with this one:

async function askClaude() {
  const input = document.getElementById('aiInput');
  const response = document.getElementById('aiResponse');
  const question = input.value.trim();
  
  if (!question) {
    alert('Please enter a clinical question');
    return;
  }
  
  // Show loading
  response.classList.add('visible');
  response.innerHTML = `
    <div class="ai-loading">
      <div class="ai-loading-dots">
        <div class="ai-loading-dot"></div>
        <div class="ai-loading-dot"></div>
        <div class="ai-loading-dot"></div>
      </div>
      <span>Claude is thinking...</span>
    </div>
  `;
  
  try {
    // FIXED: Use proper format for Google Apps Script
    const res = await fetch(apiUrl, {
      method: 'POST',
      mode: 'cors',
      cache: 'no-cache',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
      },
      redirect: 'follow',
      body: JSON.stringify({
        action: 'oncallAskClinical',
        question: question
      })
    });
    
    // Check if response is OK
    if (!res.ok) {
      throw new Error('Network response was not ok: ' + res.status);
    }
    
    const data = await res.json();
    
    // Log for debugging
    console.log('API Response:', data);
    
    if (!data.success) {
      throw new Error(data.error || 'Unknown error from server');
    }
    
    // Format the response with better styling
    const formattedResponse = formatAIResponse(data.answer || data.response || 'No response received');
    
    response.innerHTML = `
      <div class="ai-response-content">${formattedResponse}</div>
      <div class="ai-response-meta">
        <span>ğŸ“š Kuwait SI Units</span>
        <span>â±ï¸ ${new Date().toLocaleTimeString()}</span>
      </div>
    `;
    
    // Clear input after successful response
    input.value = '';
    
  } catch (e) {
    console.error('AI Error:', e);
    response.innerHTML = `
      <div style="color: #fca5a5;">
        âš ï¸ Error: ${e.message || 'Failed to get response'}.<br>
        <small>Check console for details. Make sure the backend is deployed correctly.</small>
      </div>
    `;
  }
}
